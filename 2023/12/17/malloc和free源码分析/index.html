

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Modifier">
  <meta name="keywords" content="">
  
    <meta name="description" content="libc2.23 çš„ malloc å’Œ free å‡½æ•°æºç åˆ†æ">
<meta property="og:type" content="article">
<meta property="og:title" content="mallocå’Œfreeæºç åˆ†æ">
<meta property="og:url" content="https://shmodifier.github.io/2023/12/17/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Modifier">
<meta property="og:description" content="libc2.23 çš„ malloc å’Œ free å‡½æ•°æºç åˆ†æ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://shmodifier.github.io/img/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E9%A1%B5%E9%A6%96%E5%9B%BE.jpg">
<meta property="article:published_time" content="2023-12-17T12:43:55.000Z">
<meta property="article:modified_time" content="2023-12-17T13:09:06.156Z">
<meta property="article:author" content="Modifier">
<meta property="article:tag" content="Knowledge">
<meta property="article:tag" content="libc">
<meta property="article:tag" content="heap">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://shmodifier.github.io/img/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E9%A1%B5%E9%A6%96%E5%9B%BE.jpg">
  
  
  
  <title>mallocå’Œfreeæºç åˆ†æ - Modifier</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"shmodifier.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":false,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Have a nice day!</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>å‹é“¾</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E9%A1%B5%E9%A6%96%E5%9B%BE.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="mallocå’Œfreeæºç åˆ†æ"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-12-17 20:43" pubdate>
          2023å¹´12æœˆ17æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          33k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          272 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">mallocå’Œfreeæºç åˆ†æ</h1>
            
            
              <div class="markdown-body">
                
                <p>libc2.23 çš„ malloc å’Œ free å‡½æ•°æºç åˆ†æ</p>
<span id="more"></span>

<p>æˆ‘ä»¬çŸ¥é“ç¨‹åºå®ƒæœ‰åŠ¨æ€åˆ†é…å†…å­˜çš„æ“ä½œï¼ŒLinux å°±æ˜¯é  malloc å’Œ free æ¥å®ç°åˆ†é…å’Œå›æ”¶çš„ã€‚</p>
<blockquote>
<p>ä¸åˆ»æ„å»è¯´æ˜éƒ½æ˜¯ç”¨ 64 ä½ç³»ç»Ÿä¸¾ä¾‹è§£é‡Šçš„</p>
</blockquote>
<h1 id="ptmalloc2-çš„åˆ†é…ç­–ç•¥"><a href="#ptmalloc2-çš„åˆ†é…ç­–ç•¥" class="headerlink" title="ptmalloc2 çš„åˆ†é…ç­–ç•¥"></a>ptmalloc2 çš„åˆ†é…ç­–ç•¥</h1><blockquote>
<p>ä¹‹å‰å†™å †æ¦‚è¿°çš„æ—¶å€™å†™è¿‡ä¸€æ¬¡äº†è¿™æ¬¡ç²—ç•¥æ¦‚æ‹¬ä¸€ä¸‹é¡ºä¾¿å¤ä¹ äº†</p>
</blockquote>
<h3 id="åˆ†é…"><a href="#åˆ†é…" class="headerlink" title="åˆ†é…"></a>åˆ†é…</h3><p>Linuxç³»ç»Ÿä¸­ä½¿ç”¨ ptmalloc2 ï¼Œåœ¨è¿™ä¸ªåˆ†é…è§„åˆ™ä¸‹ï¼Œ<strong>ä¸æ˜¯æ¯ä¸€æ¬¡ malloc ç¨‹åºéƒ½ä¼šå‘ç³»ç»Ÿç”³è¯·å†…å­˜ã€‚</strong></p>
<p>åœ¨ç¬¬ä¸€æ¬¡ <code>malloc()</code>çš„æ—¶å€™ï¼Œå®ƒä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯· <code>0x21000B(132KB)</code> çš„å†…å­˜ï¼ˆå›ºå®šå€¼ä¸ä¼šå˜ï¼‰ï¼Œåç»­åˆ†é…éƒ½ä»å·²ç»ç”³è¯·çš„è¿™ä¸€å¤§å—å†…å­˜ä¸­åˆ†å‰²ï¼Œç”¨å®Œäº†æ‰ä¼šå†æ¬¡å‘ç³»ç»Ÿç”³è¯·å†…å­˜ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•å»åˆ†å‰²å—å‘¢ï¼Ÿæˆ‘ä»¬å®è·µæ—¶ä¼šå‘ç°ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬å¸Œæœ›è·å¾—å¤šå°‘å†…å­˜ç¨‹åºå°±åˆ†å‰²ç»™æˆ‘ä»¬å¤šå°‘çš„ã€‚æ¯ä¸€ä¸ªè¢«åˆ†å‰²çš„å †å—éƒ½éœ€è¦æ ‡æ³¨å®ƒä»¬çš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ˜¯å¦è¢«ä½¿ç”¨ã€å †å—å¤§å°ç­‰æ•°æ®ç‰¹å¾ï¼Œè¿™å°±å¯¼è‡´åˆ†å‰²å†…å­˜å—çš„æ—¶å€™ä¸å¯é¿å…åœ°è¦åœ¨å†…å­˜å—ä¸­é¢å¤–å¼€å‡ºä¸€éƒ¨åˆ†åŒºåŸŸç”¨äºç®¡ç†ã€‚</p>
<p>åŒæ—¶ç”±äºéœ€è¦ä¿è¯æŒ‡é’ˆå¯¹é½ï¼Œç³»ç»Ÿè¦æ±‚æ¯ä¸€ä¸ªå †å—éƒ½æ˜¯ <code>SIZE_SZ*2</code> çš„æ•´å€æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ <strong>32 ä½æ“ä½œç³»ç»Ÿä¸‹çš„å †å—å¤§å°å¿…é¡»æ˜¯ 8 çš„æ•´æ•°å€ï¼Œ64 ä½å¿…é¡»æ˜¯ 16 çš„æ•´æ•°å€ã€‚</strong></p>
<p>ä»¥32ä½æ“ä½œç³»ç»Ÿä¸ºä¾‹ï¼Œsize çš„å€¼å¿…å®šä¸º 8 çš„æ•´æ•°å€ï¼ŒäºŒè¿›åˆ¶è§’åº¦ä¸‹çœ‹æ¥ï¼Œä½ä¸‰ä½æ°¸è¿œæ˜¯0ï¼Œå¦‚æœä¸åˆ©ç”¨èµ·æ¥çš„è¯å°±æœ‰ç‚¹æµªè´¹ã€‚</p>
<p>å¦‚ä¸‹å›¾ï¼Œåœ¨ malloc.c ä¸­å®šä¹‰äº†ä¸‹é¢çš„éƒ¨åˆ†ï¼š</p>
<p><img src="/img/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E6%A0%87%E5%BF%97%E4%BD%8D%E4%B8%8Esize.png" srcset="/img/loading.gif" lazyload></p>
<p>è§„å®š <code>size</code> çš„ä½ä¸‰ä½ä¸ä½œä¸ºå®é™…çš„ <code>chunk</code> å¤§å°ï¼Œè€Œæ˜¯æ ‡å¿—ä½ã€‚ä¸‰ä¸ªæ ‡å¿—ä½ä»é«˜ä½åˆ°ä½ä½åˆ†åˆ«æ˜¯ï¼š</p>
<ol>
<li><strong>NON_MAIN_ARENA</strong>ï¼šæ˜¯å¦ä¸ºä¸»åˆ†é…ï¼Œ0è¡¨ç¤ºæ˜¯ä¸»åˆ†é…ï¼Œæƒå€¼ä¸º4</li>
<li><strong>IS_MMAPPED</strong>ï¼šè¡¨ç¤ºå†…å­˜æ˜¯å¦ä¸º <code>mmap</code> è·å¾—ï¼Œ0è¡¨ç¤ºä¸æ˜¯ï¼Œæƒå€¼ä¸º2</li>
<li><strong>PREV_INUSE</strong>ï¼šè¡¨ç¤ºå‰é¢ä¸€ä¸ªå†…å­˜å—æ˜¯å¦è¢«ä½¿ç”¨ï¼Œ0è¡¨ç¤ºä¸è¢«ä½¿ç”¨ï¼Œæƒå€¼ä¸º1</li>
</ol>
<p>åœ¨ 64 ä½æ“ä½œç³»ç»Ÿä¸­å°±æ˜¯ä½ 4 ä½ï¼Œå¤šå‡ºä¸€ä¸ªæ ‡å¿—ä½ï¼Œä½†æ˜¯è¿™ä¸ªæ ‡å¿—ä½å½“å‰æ— ä»»ä½•æ„ä¹‰ï¼Œä½†æ˜¯å®ƒåŒæ ·ä¸ä½œä¸º <code>chunk</code>çš„å¤§å°ã€‚</p>
<p>å¦‚æœæ˜¯å•å•æ»¡è¶³ <code>SIZE_SZ*2</code> çš„æ•´å€æ•°ï¼Œé‚£ä¹ˆç†è®ºä¸Šæˆ‘ä»¬åº”è¯¥æ˜¯å¯ä»¥åˆ†é… 0x10 å¤§å°çš„å †å—çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å®é™…è¿è¡Œ<code>malloc (0x10)</code> å‘ç°å †å—å¤§å°æ˜¯ 0x20ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬äº†è§£ä¸€ä¸‹chunkç»“æ„å°±èƒ½çŸ¥é“ï¼Œchunk çš„ç»“æ„ä½“æœ‰ <code>0x10</code> ä¸ªé»˜è®¤è¢«åŒ…å«åœ¨å †å—é‡Œçš„å¿…é¡»åˆ†é…çš„å­—èŠ‚ã€‚</p>
<h3 id="å›æ”¶"><a href="#å›æ”¶" class="headerlink" title="å›æ”¶"></a>å›æ”¶</h3><p>ç›®å‰æ¥çœ‹ï¼Œåˆ†é…å †å—çš„æ—¶å€™å®é™…ä¸Šæ“ä½œå¾ˆç®€å•ï¼Œå°±æ˜¯ä»å¤§å †å—é‡Œé¢åˆ†å‰²ä¸€å—åˆé€‚çš„å¤§å°å°±å¥½äº†ã€‚ä½†æ˜¯é‡Šæ”¾ä»¥åä¸èƒ½åƒææ©¡çš®æ³¥ä¸€æ ·å†æŠŠå®ƒæ”¾å›å»ã€‚å¦‚æœæˆ‘ä»¬æ¯ä¸€æ¬¡ free éƒ½ä¸åšå¤„ç†çš„æ“ä½œç›´æ¥ä¸¢å¼ƒï¼Œä¾‹å¦‚æˆ‘ä»¬ä¸€æ¬¡æ€§ç”³è¯·äº†å¾ˆå¤šå°çš„å †å—å¹¶é‡Šæ”¾ï¼Œåªæœ‰å†ä¸‹æ¬¡ç”³è¯·åŒæ ·å †å—æ‰ä¼šè¢«åˆ©ç”¨ï¼Œå¦‚æœæˆ‘ä»¬ä¸å†åˆ†é…åŒæ ·çš„å°å †å—ï¼Œè¿™å—åŒºåŸŸå°±ä¼šè¢«æµªè´¹ã€‚</p>
<p>è¿™æ—¶æˆ‘ä»¬è¦äº†è§£ä¸€ä¸‹ ptmalloc çš„åˆä¸€ä¸ªç­–ç•¥ï¼š<strong>å°½é‡åˆå¹¶ç‰©ç†ç›¸é‚»çš„ç©ºé—²å †å—</strong>ã€‚å°±æ˜¯å›æ”¶æ—¶ï¼Œå¯ä»¥æŠŠç›¸é‚»çš„å°å †å—åˆå¹¶æˆå¤§å †å—ã€‚åœ¨åˆå¹¶çš„æ—¶å€™æˆ‘å¯èƒ½å‰é¢ä¼šæœ‰ <code>free</code> çš„å†…å­˜å—ï¼Œåé¢ä¹Ÿä¼šæœ‰ <code>free</code> çš„å†…å­˜å—ã€‚</p>
<p>é‚£ä¹ˆæˆ‘æ€ä¹ˆåœ¨åªçŸ¥é“æˆ‘è‡ªèº«ä¿¡æ¯çš„æƒ…å†µä¸‹å‡†ç¡®æ‰¾åˆ°å‰åçš„ <code>chunk</code> å…·ä½“åœ¨å“ªå‘¢ï¼Ÿ</p>
<p>è¿™æ—¶éœ€è¦æŠŠ malloc_chunk ç»“æ„ä½“æ‹ä¸Šæ¥ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> &#123;</span><br><br>  INTERNAL_SIZE_T      prev_size;  <span class="hljs-comment">/* Size of previous chunk (if free).  */</span><br>  INTERNAL_SIZE_T      size;       <span class="hljs-comment">/* Size in bytes, including overhead. */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd</span>;</span>         <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk</span>;</span><br><br>  <span class="hljs-comment">/* Only used for large blocks: pointer to next larger size.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd_nextsize</span>;</span> <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk_nextsize</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>é€šè¿‡ <code>prev_size</code> ä½æˆ‘ä»¬ä¸ä»…å¯ä»¥å¾—çŸ¥å‰ä¸€ä¸ª <code>chunk</code> æœ‰æ²¡æœ‰è¢« <code>free</code> ï¼Œè¿˜å¯ä»¥å¾—çŸ¥ <code>chunk</code> çš„å¤§å°ã€‚æ‰€ä»¥åœ¨ä¸€ä¸ª <code>chunk</code> çš„ç»“æ„ä½“å†…ï¼Œåœ¨ size ä¹‹å‰è¿˜ä¼šæœ‰ä¸€ä¸ª <code>prev_size</code> ã€‚</p>
<p>åœ¨ç¨‹åºä½¿ç”¨æ—¶ï¼Œ<code>fd</code>ã€<code>bk</code> ç­‰æŒ‡é’ˆå¯ä»¥ç»™ç”¨æˆ·å†™æ•°æ®ï¼Œåªæœ‰è¢«é‡Šæ”¾çš„æ—¶å€™æ‰ä¼šå­˜å‚¨æŒ‡é’ˆæ•°æ®ã€‚</p>
<p>æ‰€ä»¥ <code>prev_size</code> å’Œ <code>size</code> ä¸¤ä¸ªæ•°æ®å°±å äº† 0x10 çš„ç©ºé—´ï¼Œè¿™ä¹Ÿå°±æ˜¯æœ€å°å †å—æ˜¯ 0x20 çš„åŸå› ã€‚</p>
<h3 id="è¯¦ç»†çš„å›æ”¶å¤„ç†"><a href="#è¯¦ç»†çš„å›æ”¶å¤„ç†" class="headerlink" title="è¯¦ç»†çš„å›æ”¶å¤„ç†"></a>è¯¦ç»†çš„å›æ”¶å¤„ç†</h3><p>bin å°±æ˜¯ç©ºé—² chunk çš„åˆ«åï¼Œæˆ‘ä»¬ä½¿ç”¨é“¾è¡¨ç»“æ„æ¥ç®¡ç†ç©ºé—²å †å—ï¼Œæˆ‘ä»¬è¯´çš„ bin ä¹ŸæŒ‡ä»£ä¸åŒçš„é“¾è¡¨è¡¨å¤´ã€‚</p>
<h5 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h5><p>0x20~0x80 å¤§å°çš„ chunkï¼Œæˆ‘ä»¬ä¼šæŠŠå®ƒæ‰”è¿› <code>fast bin</code> ã€‚</p>
<p><code>fast bin</code> ç®¡ç† free_chunk é‡‡ç”¨<strong>å•é“¾è¡¨</strong>æ–¹å¼ï¼Œå¹¶ä¸”ç¬¦åˆ<strong>å…ˆè¿›åå‡ºï¼ˆFILOï¼‰</strong>çš„åŸåˆ™ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">p1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>p2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><span class="hljs-built_in">free</span>(p1);<br><span class="hljs-built_in">free</span>(p2);<br>p3=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>p4=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br></code></pre></td></tr></table></figure>

<p>æœ€å <code>p3</code> çš„æŒ‡é’ˆæ˜¯åŸæœ¬æŒ‡å‘ <code>p2</code> çš„æŒ‡é’ˆï¼Œ<code>p4</code> çš„æŒ‡é’ˆæ˜¯åŸæœ¬æŒ‡å‘ <code>p1</code>çš„æŒ‡é’ˆã€‚</p>
<p>å¹¶ä¸”æ‰€æœ‰ <code>fast bin</code> ä¹‹åçš„ chunk çš„ <code>prev_inuse</code> ä½æ°¸è¿œä¸º 1 ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ°¸è¿œè¢«è§†ä¸ºåœ¨ä½¿ç”¨ä¸­ã€‚ç”±äºè¿™ä¸ªä½ç”¨äºåˆå¹¶ç›¸é‚»å †å—ï¼Œæ‰€ä»¥ <code>fast bin</code> ä¸ä¼šè¢«åˆå¹¶ï¼Œfree æ‰çš„æ—¶å€™æ˜¯å¤šå¤§å°±æ˜¯å¤šå¤§ã€‚æ¯”å¦‚æˆ‘ä»¬å½“å‰ <code>fast bin</code> ä¸­åªæœ‰ 0x20 å’Œ 0x30 çš„å †å—ï¼Œæˆ‘ä»¬æ–°ç”³è¯·ä¸€ä¸ª 0x50 çš„å †å—ï¼Œæ£€æŸ¥ <code>fastbin</code> ä¸­æ²¡æœ‰å°±æ˜¯æ²¡æœ‰ï¼Œä¸ä¼šå»åˆå¹¶ 0x20 å’Œ 0x30 çš„ä¸¤ä¸ªå †å—æ¥æ‹¼ 0x50 ï¼Œä¹Ÿä¸ä¼šåˆ‡å‰²æŸä¸ªå †å—ã€‚</p>
<blockquote>
<p>å…¶ä»–çš„éƒ½ä¼šå‚ä¸åˆ‡å‰²ä¸åˆå¹¶</p>
</blockquote>
<h5 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h5><p>è¢«é‡Šæ”¾çš„ free_chunkï¼Œç»æ£€æŸ¥ä¸å±äº <code>fast bin</code> ä¹‹åä¼šè¢«ä¸¢è¿› <code>unsorted bin</code>ã€‚</p>
<p><code>unsorted bin</code> æ˜¯åŒå‘é“¾è¡¨ç»“æ„ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>unsorted bin</code> ä¸­æœ‰ä¸¤ä¸ª â€å¤´æŒ‡é’ˆâ€œ ï¼Œæˆ‘ä»¬ä¹ŸæŠŠå¤´éƒ¨çš„ä¸¤ä¸ª bin çœ‹ä½œ chunkã€‚åˆå§‹çŠ¶æ€æ—¶ï¼Œ<code>unsorted bin</code> ä¸­æ²¡æœ‰ç©ºé—² chunkï¼Œæ­¤æ—¶ä¸¤ä¸ª bins çš„çš„ <code>fd</code> å’Œ <code>bk</code> éƒ½æŒ‡å‘è‡ªèº«çš„ <code>prev_size</code> ã€‚</p>
<p><code>unsorted bin</code> ä¸­ chunk å¤§å°ä¸ä¸€å®šç›¸ç­‰ä¸”æ— åºæ’åˆ—ã€‚</p>
<p>å½“éœ€è¦æ£€æŸ¥ <code>unsorted bin</code> çš„æ—¶å€™ï¼Œä¼šéå†æ•´ä¸ªé“¾è¡¨ï¼Œå¯»æ‰¾ç¬¬ä¸€ä¸ªèƒ½æ»¡è¶³çš„ chunk å¤§å°åˆ‡å‰²ã€‚å½“ç„¶è¿™ä¸­æ¡ä»¶çš„åˆ†å‰²ä¹Ÿæ˜¯åŸºäºæœ€å° 0x20 å¤§å°çš„åŸºç¡€ä¸Šçš„ã€‚</p>
<h5 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h5><p><code>small bin</code> ä¸€å…±æœ‰ 62 ä¸ªï¼Œå®ƒè¡¨ç¤ºçš„èŒƒå›´å°±æ˜¯<code>4*SIZE_SZ~126*SIZE_SZ</code>ã€‚</p>
<p>æŒ‰ç…§ä¸åŒçš„å¤§å°èŒƒå›´åŒºåˆ†æˆä¸åŒçš„é“¾ã€‚å½“ä¸­æ¯ä¸ª chunk çš„å¤§å°ä¸å…¶æ‰€åœ¨çš„ bin çš„ index çš„å…³ç³»ä¸ºï¼š<code>chunk_size = 2 * SIZE_SZ *index</code>ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>ä¸‹æ ‡</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>x</th>
<th>63</th>
</tr>
</thead>
<tbody><tr>
<td>SIZE_SZ&#x3D;4ï¼ˆ32 ä½ï¼‰</td>
<td>16</td>
<td>24</td>
<td>32</td>
<td>40</td>
<td>2<em>4</em>x</td>
<td>504</td>
</tr>
<tr>
<td>SIZE_SZ&#x3D;8ï¼ˆ64 ä½ï¼‰</td>
<td>32</td>
<td>48</td>
<td>64</td>
<td>80</td>
<td>2<em>8</em>x</td>
<td>1008</td>
</tr>
</tbody></table>
<p><code>small bins</code> é‡‡ç”¨<strong>åŒå‘é“¾è¡¨</strong>å¯¹ bin è¿›è¡Œç®¡ç†ï¼Œæ¯ä¸ªé“¾è¡¨ä¸­å­˜å‚¨çš„ chunk å¤§å°éƒ½ä¸€è‡´ã€‚</p>
<p>é“¾è¡¨é‡‡ç”¨ FIFO çš„è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯<strong>å…ˆè¿›å…ˆå‡º</strong>ï¼Œæ‰€ä»¥åŒä¸€ä¸ªé“¾è¡¨ä¸­å…ˆè¢«é‡Šæ”¾çš„ chunk ä¼šå…ˆè¢«åˆ†é…å‡ºå»ã€‚</p>
<p><img src="/img/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/smallbin.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h5><p><code>large bin</code> ä¸€å…±æœ‰ 63 ä¸ªï¼Œä» <code>small bin</code> æœ€å°ä¸èƒ½è¡¨ç¤ºçš„ chunk å¼€å§‹ï¼Œå¤§åˆ°æ— ç©·ã€‚</p>
<p> <code>large bin</code> ä» <code>128*SIZE_SZ</code> å¼€å§‹ã€‚é‚£ä¹ˆä¸‹æ ‡ä¸º<code>0</code>çš„<code>large bin</code>è¡¨ç¤ºçš„èŒƒå›´å°±æ˜¯<code>128*SIZE_SZ~144*SIZE_SZ</code>(å·¦é—­å³å¼€)ï¼ŒåŒç†ä¸‹æ ‡ä¸º1çš„<code>large bin</code>è¡¨ç¤ºçš„èŒƒå›´å°±æ˜¯<code>144*SIZE_SZ~160*SIZE_SZ</code>ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç­‰åˆ°<code>32</code>çš„æ—¶å€™å°±åœ¨åŸæ¥çš„åŸºç¡€ä¸ŠåŠ <code>32*SIZE_SZ</code>ä½œä¸ºå³å¼€åŒºé—´</p>
<p>å®ƒåŒæ ·ä»¥äºŒç»´åŒå‘é“¾è¡¨è¿›è¡Œç®¡ç†ï¼Œç›¸åŒå¤§å°çš„ chunk ç”¨ <code>fd</code> å’Œ <code>bk</code> æŒ‡é’ˆç›¸è¿ï¼›ä¸åŒå¤§å°çš„ chunkï¼Œç”¨ <code>fd_nextsize</code> å’Œ <code>bk_nextsize</code> æŒ‡é’ˆè¿æ¥ã€‚æ²¿ç€ <code>fd_nextsize</code> æŒ‡é’ˆï¼Œchunk å¤§å°é€’å¢ã€‚</p>
<p>å¤§æ¦‚ç»“æ„å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/img/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/largebin.png" srcset="/img/loading.gif" lazyload></p>
<p>ï¼ˆçœç•¥äº†éƒ¨åˆ†æŒ‡é’ˆï¼‰</p>
<h3 id="å…·ä½“åˆ†é…ç»†èŠ‚"><a href="#å…·ä½“åˆ†é…ç»†èŠ‚" class="headerlink" title="å…·ä½“åˆ†é…ç»†èŠ‚"></a>å…·ä½“åˆ†é…ç»†èŠ‚</h3><p><code>malloc()</code> ä¼šå¯¹ç”¨æˆ·è¯·æ±‚çš„sizeè¿›è¡Œå¤„ç†ï¼Œæ¥ç”³è¯·åŒæ—¶æ»¡è¶³ <code>SIZE_SZ*2</code> çš„æ•´æ•°å€ï¼ŒåŒ…å« 0x10 çš„å›ºå®šæ•°æ®åŒºåŸŸä¸”å¤§å°æœ€å°çš„å †å—ã€‚</p>
<p><img src="/img/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E5%88%86%E9%85%8D%E7%BB%86%E8%8A%82size%E5%A4%84%E7%90%86.png" srcset="/img/loading.gif" lazyload></p>
<p>åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬ç”³è¯·å¤šå¤§çš„å †å—ï¼Œå°±æœ‰å¤šå°‘åŒºåŸŸæ¥ä¾›æˆ‘ä»¬å‘ä¸Šå†™æ•°æ®ã€‚</p>
<p>ä¸€ä¸ª <code>size=0x20</code> çš„ chunk ä¸­ï¼Œ0x20 å­—èŠ‚åˆ†åˆ«ä¸º <code>prev_size</code>ï¼Œ<code>size</code>ï¼Œ<code>fd</code> å’Œ <code>bk</code>ã€‚</p>
<p><code>prev_size</code> å’Œ <code>size</code> éƒ½ä¸å…è®¸å†™ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å†™ <code>fd</code> å’Œ <code>bk</code> ï¼Œä»¥åŠä¸‹ä¸€ä¸ªå—çš„ <code>prev_size</code> ã€‚æ‰€ä»¥<code>size=0x20</code>ï¼Œæˆ‘ä»¬å¯ä»¥å†™çš„æ•°æ®æ®µä¸º <code>0x18</code> ã€‚</p>
<p>æ‰€ä»¥å½“æˆ‘è¯·æ±‚çš„å†…å­˜å°äºç­‰äº 0x18 çš„æ—¶å€™ï¼Œç³»ç»Ÿå°±ä¼šç»™æˆ‘ä»¬ <code>size=0x20</code> çš„ chunk ã€‚ä¸€æ—¦å¤šäº†å°±ä¼šä»¥ <code>0x10( 2*SIZE_SZ)</code>  ä¸ºå•ä½å‘ä¸ŠåŠ ç›´åˆ°æ»¡è¶³æ¡ä»¶ã€‚</p>
<p>è®¡ç®—å¥½å¤§å°ä¹‹åå°±è¿›å…¥åˆ†é…ç¯èŠ‚ï¼Œç³»ç»Ÿæœå¯»å †å—çš„é¡ºåºæ˜¯ï¼š <code>fast bin -&gt; small bin -&gt; large bin -&gt; unsorted bin</code></p>
<p> <code>fast bin</code> ã€<code>small bin</code> å’Œ<code>large bin</code> åœ¨æœå¯»é˜¶æ®µéƒ½ä¸è¿›è¡Œåˆå¹¶å’Œåˆ†å‰²å¤„ç†ã€‚å¦‚æœåœ¨å‰ä¸‰ä¸ªbinsä¸­éƒ½æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„å †å—ï¼Œ<code>unsorted bin</code> ä¼šæ‰¾ç¬¬ä¸€ä¸ªèƒ½æ»¡è¶³çš„ chunk å¹¶è¿”å›æˆ–è€…åˆ‡å‰²ä¹‹åè¿”å›ã€‚å¦‚æœåˆ‡å‰²ä¹‹åå‰©ä½™çš„éƒ¨åˆ†å°äº <code>MINSIZE</code> ï¼Œé‚£ä¹ˆåˆ™ä¸ä¼šåˆ‡å‰²æ•´ä¸ªè¿”å›ã€‚</p>
<p><code>unsorted bin</code> ä¸­æ¯éå†ä¸€ä¸ªä¸æ»¡è¶³è¦æ±‚çš„ free_chunk å°±ä¼šæŠŠè¿™ä¸ªå †å—æ”¾è¿›å¯¹åº”çš„ <code>small bin</code> æˆ–è€…<code>large bin</code>å½“ä¸­ã€‚</p>
<h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><p>ä¸‹è½½æºç ï¼Œè¿˜æŒºæ…¢çš„å°±æ˜¯è¯´</p>
<p>æˆ‘çš„ç¯å¢ƒæ˜¯ ubuntu16.04</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install glibc-source <br>sudo apt-get install libc6-dbg <br>sudo tar xf /usr/src/glibc/glibc-2.23.tar.xz<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ä¹‹å‰æˆ‘è¿˜åœ¨æƒ³ä¸ºå•¥ç½‘ä¸Šåˆ†ææºç çš„éƒ½æ˜¯ä¸€æ®µä¸€æ®µçš„ï¼Œæ²¡æƒ³åˆ°è¿™ä¸ª malloc å®ƒè¿™ä¹ˆå¤§ä¸ªæ–‡ä»¶å¤¹ğŸ˜¶â€ğŸŒ«ï¸</p>
</blockquote>
<h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><p>åœ¨ glibc å†…éƒ¨ï¼Œ<code>malloc()</code> å‡½æ•°å°±æ˜¯ <code>__libc_malloc()</code> å‡½æ•°ï¼Œè€Œ <code>__libc_malloc()</code> å‡½æ•°çš„ä¸»è¦å·¥ä½œæ˜¯<code>_int_malloc()</code> å®Œæˆçš„ã€‚</p>
<h4 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h4><p>å¯¹åº”çš„åœ¨ä»£ç é‡ŒåŠ æ³¨é‡Šåˆ†æä¸€ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<br>__libc_malloc (<span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  mstate ar_ptr;<br>  <span class="hljs-type">void</span> *victim;<br>  <br>  <span class="hljs-comment">//è¯»å–malloc_hookï¼Œè‹¥ malloc_hook è¢«è®¾ç½®ï¼Œåˆ™ç›´æ¥è°ƒç”¨</span><br>  <span class="hljs-type">void</span> *(*hook) (<span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *) = atomic_forced_read (__malloc_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br><br>  <span class="hljs-comment">//è°ƒç”¨ arena_get å‡½æ•°ï¼Œå‡½æ•°è·å–ä¸€ä¸ªå¯ç”¨çš„åˆ†é…åŒº</span><br>  arena_get (ar_ptr, bytes);<br>    <br>  <span class="hljs-comment">//è¿™é‡Œï¼!è°ƒç”¨äº† _int_malloc()</span><br>  victim = _int_malloc (ar_ptr, bytes);<br>    <br>  <span class="hljs-comment">/* Retry with another arena only if we were able to find a usable arena</span><br><span class="hljs-comment">     before.  */</span><br>  <span class="hljs-comment">//å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé”™è¯¯æ£€éªŒï¼Ÿå¦‚æœ chunk ä¸ºç©ºï¼Œä½†åˆ†é…åŒºæŒ‡é’ˆä¸ä¸ºç©ºï¼Œå†æ¬¡è°ƒç”¨ _int_malloc è·å–</span><br>  <span class="hljs-keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      LIBC_PROBE (memory_malloc_retry, <span class="hljs-number">1</span>, bytes);<br>      ar_ptr = arena_get_retry (ar_ptr, bytes);<br>      victim = _int_malloc (ar_ptr, bytes);<br>    &#125;<br>    <br>  <span class="hljs-comment">//ç»™å†…å­˜åˆ†é…åŒº è§£é”</span><br>  <span class="hljs-keyword">if</span> (ar_ptr != <span class="hljs-literal">NULL</span>)<br>    (<span class="hljs-type">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);<br>  <span class="hljs-comment">//å¯¹åˆ†é…çš„chunk æŒ‡é’ˆè¿›è¡Œåœ°å€æ£€æŸ¥</span><br>  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||<br>          ar_ptr == arena_for_chunk (mem2chunk (victim)));<br>  <span class="hljs-keyword">return</span> victim;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>assert å‘½ä»¤å¦‚æœå¤±è´¥ï¼Œå³ä»£è¡¨å­˜åœ¨é”™è¯¯ï¼Œä¼šè§¦å‘å¯¹åº”çš„å¼‚å¸¸ï¼Œé€šå¸¸å¯¼è‡´ç¨‹åºç»ˆæ­¢å¹¶æ‰“å°å‡ºé”™è¯¯æ¶ˆæ¯ï¼Œä»¥å¸®åŠ©å®šä½å’Œä¿®å¤é—®é¢˜ã€‚</p>
</blockquote>
<p>æ ¹æ®å‡½æ•°å†…å®¹æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨ malloc æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥ <code>malloc_hook</code> æ‰€æŒ‡å‘çš„åŒºåŸŸã€‚</p>
<p>æˆ‘ä»¬å°±æœ‰ä¸€ä¸ªåˆ©ç”¨æ€è·¯æ˜¯ï¼Œ<strong>ä¿®æ”¹ <code>malloc_hook</code> ä¸ºæˆ‘ä»¬çš„ gadget ï¼Œä¿®æ”¹åå†æ¬¡è°ƒç”¨ malloc å°±ä¼šæ‰§è¡Œ gadget ä»è€Œ getshell ã€‚</strong></p>
<h4 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h4><p><code>__libc_malloc</code> æ˜¯é€šè¿‡è°ƒç”¨ <code>_int_malloc</code> æ¥æ‰§è¡Œåˆ†é…å †çš„æ“ä½œçš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br>_int_malloc (mstate av, <span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  INTERNAL_SIZE_T nb;               <span class="hljs-comment">/* normalized request size */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx;                 <span class="hljs-comment">/* associated bin index */</span><br>  mbinptr bin;                      <span class="hljs-comment">/* associated bin */</span><br><br>  mchunkptr victim;                 <span class="hljs-comment">/* inspected/selected chunk */</span><br>  INTERNAL_SIZE_T size;             <span class="hljs-comment">/* its size */</span><br>  <span class="hljs-type">int</span> victim_index;                 <span class="hljs-comment">/* its bin index */</span><br><br>  mchunkptr remainder;              <span class="hljs-comment">/* remainder from a split */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> remainder_size;     <span class="hljs-comment">/* its size */</span><br><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block;               <span class="hljs-comment">/* bit map traverser */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bit;                 <span class="hljs-comment">/* bit map traverser */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-built_in">map</span>;                 <span class="hljs-comment">/* current word of binmap */</span><br><br>  mchunkptr fwd;                    <span class="hljs-comment">/* misc temp for linking */</span><br>  mchunkptr bck;                    <span class="hljs-comment">/* misc temp for linking */</span><br><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errstr = <span class="hljs-literal">NULL</span>;<br><br>  checked_request2size (bytes, nb);<br><br>  <span class="hljs-comment">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from</span><br><span class="hljs-comment">     mmap.  */</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (av == <span class="hljs-literal">NULL</span>))<br>  &#123;<br>      <span class="hljs-type">void</span> *p = sysmalloc (nb, av);<br>      <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>) alloc_perturb (p, bytes);<br>      <span class="hljs-keyword">return</span> p;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>çœç•¥æ‰ä¸€å¼€å§‹å®šä¹‰çš„ä¸€å¤§å †å˜é‡ï¼Œmalloc çš„ç¬¬ä¸€æ­¥å°±æ˜¯è°ƒç”¨ <code>checked_request2size()</code> è®¾ç½® sizeã€‚</p>
<p> <code>checked_request2size()</code> å‡½æ•°å°±æ˜¯ç”¨æ¥æŸ¥æ‰¾æœ€å°çš„æ»¡è¶³æ¡ä»¶çš„ size æˆ‘å°±ä¸å¤åˆ¶äº†ğŸ¤ª</p>
<p>æ³¨æ„ä¸€ç³»åˆ—çš„å®å®šä¹‰ï¼š</p>
<ul>
<li><code>__glibc_unlikely(exp)</code> ï¼šè¡¨ç¤º exp å¾ˆå¯èƒ½ä¸ºå‡</li>
<li><code>__glibc_likely(exp)</code> ï¼šè¡¨ç¤º exp å¾ˆå¯èƒ½ä¸ºçœŸ</li>
<li><code>__builtin_expect(exp,value)</code> ï¼šè¡¨ç¤º exp&#x3D;&#x3D;value å¤§æ¦‚ç‡æˆç«‹</li>
</ul>
<p>æœ€åè¿™ä¸€å°èŠ‚çš„æ„æ€å°±æ˜¯å¦‚æœæ²¡æœ‰å¯ä»¥åˆ†é…çš„åŒºåŸŸï¼Œé‚£å°±è°ƒç”¨ <code>sys_malloc</code> ç³»ç»Ÿè°ƒç”¨å»ç”¨ mmap åˆ†é…æ–°çš„å †åŒºã€‚</p>
<h5 id="fastbin"><a href="#fastbin" class="headerlink" title="fastbin"></a>fastbin</h5><p>æ¥ä¸‹æ¥å‡½æ•°å°±è¿›å…¥ fastbin éƒ¨åˆ†å»æŸ¥æ‰¾å¯ä»¥åˆ©ç”¨çš„å †å—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//æ£€æŸ¥å †å—å¤§å°æ˜¯å¦å±äº fastbin</span><br><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (get_max_fast ()))<br>    &#123;<br>      <span class="hljs-comment">// æ ¹æ® nb ä¹Ÿå°±æ˜¯å‰é¢è¿”å›çš„ size è·å– fastbins æ•°ç»„çš„ä¸‹æ ‡</span><br>      idx = fastbin_index (nb);<br>      <span class="hljs-comment">// å¾—åˆ°é“¾è¡¨å¤´æŒ‡é’ˆ</span><br>      mfastbinptr *fb = &amp;fastbin (av, idx);<br>      mchunkptr pp = *fb;<br>      <span class="hljs-comment">// å¦‚æœå½“å‰é“¾è¡¨å­˜åœ¨ chunkï¼Œåˆ™åˆ†é…è¯¥é“¾è¡¨çš„ç¬¬ä¸€ä¸ª chunk</span><br>      <span class="hljs-keyword">do</span><br>        &#123;<br>          victim = pp;<br>          <span class="hljs-comment">//å¦‚æœ victim==NULL ä¹Ÿå°±æ˜¯ fastbin é“¾è¡¨ä¸­æ²¡æœ‰ chunkï¼Œç›´æ¥ break è·³å‡º fastbin çš„æŸ¥æ‰¾</span><br>          <span class="hljs-keyword">if</span> (victim == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>      <span class="hljs-keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim))<br>             != victim);<br>      <span class="hljs-comment">// å¦‚æœbinä¸­æœ‰ chunkï¼Œæ£€æŸ¥æ‰€åˆ†é…çš„ chunk çš„ size ä¸æ‰€åœ¨é“¾è¡¨çš„ size æ˜¯å¦åŒ¹é…</span><br>      <span class="hljs-keyword">if</span> (victim != <span class="hljs-number">0</span>)<br>        &#123;<br>          <span class="hljs-keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="hljs-number">0</span>))<br>            &#123;<br>              errstr = <span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>;<br>            errout:<br>              malloc_printerr (check_action, errstr, chunk2mem (victim), av);<br>              <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>          check_remalloced_chunk (av, victim, nb);<br>          <span class="hljs-comment">//æ ¹æ® chunk å¾—åˆ°ç”¨æˆ·æ•°æ®æŒ‡é’ˆ p,å¹¶è¿”å›</span><br>          <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>          alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>è¡¥å……ä¸€ä¸‹è¿™éƒ¨åˆ†ç”¨åˆ°çš„å®å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> get_max_fast() global_max_fast</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fastbin_index(sz) \</span><br><span class="hljs-meta">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span><br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­æœ«å°¾æœ‰è°ƒç”¨åˆ° <code>check_remalloced_chunk</code> å‡½æ•°ï¼Œå‡½æ•°å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">do_check_remalloced_chunk</span> <span class="hljs-params">(mstate av, mchunkptr p, INTERNAL_SIZE_T s)</span><br>&#123;<br>  INTERNAL_SIZE_T sz = p-&gt;size &amp; ~(PREV_INUSE | NON_MAIN_ARENA);<br><br>  <span class="hljs-comment">//æ£€æŸ¥åˆ†é…çš„å—æ˜¯å¦åœ¨å†…å­˜å † mmap åŒºåŸŸä¸­</span><br>  <span class="hljs-keyword">if</span> (!chunk_is_mmapped (p))<br>    &#123;<br>      assert (av == arena_for_chunk (p));<br>      <span class="hljs-keyword">if</span> (chunk_non_main_arena (p))<br>        assert (av != &amp;main_arena);<br>      <span class="hljs-keyword">else</span><br>        assert (av == &amp;main_arena);<br>    &#125;<br>  <span class="hljs-comment">//æ£€æŸ¥ prev_inuse é‚£ä¸‰ä¸ªæ ‡å¿—ä½</span><br>  do_check_inuse_chunk (av, p);<br><br>  <span class="hljs-comment">/* Legal size ... */</span><br>  <span class="hljs-comment">//æ£€æŸ¥åˆ†é…å—çš„å¤§å°æ˜¯å¦å¤§äºæœ€å°çš„æœ‰æ•ˆå¤§å°ï¼ˆMINSIZEï¼‰ </span><br>  assert ((sz &amp; MALLOC_ALIGN_MASK) == <span class="hljs-number">0</span>);<br>  assert ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (sz) &gt;= MINSIZE);<br>  <span class="hljs-comment">/* ... and alignment */</span><br>  assert (aligned_OK (chunk2mem (p)));<br>  <span class="hljs-comment">/* chunk is less than MINSIZE more than request */</span><br>  <span class="hljs-comment">//ç¡®ä¿åˆ†é…çš„å—å¤§å°æ˜¯å¦æ˜¯æ»¡è¶³ç”³è¯·çš„ size æ¡ä»¶çš„æœ€å° size </span><br>  assert ((<span class="hljs-type">long</span>) (sz) - (<span class="hljs-type">long</span>) (s) &gt;= <span class="hljs-number">0</span>);<br>  assert ((<span class="hljs-type">long</span>) (sz) - (<span class="hljs-type">long</span>) (s + MINSIZE) &lt; <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å°±æ˜¯åœ¨æ£€æŸ¥åˆ†é…çš„ chunk çš„å„ä¸ªæ ‡å¿—ä½åŒé‡ä¿é™©ç¡®ä¿åˆ†é…çš„ chunk æ˜¯æ­£ç¡®çš„ã€‚</p>
<h5 id="smallbin"><a href="#smallbin" class="headerlink" title="smallbin"></a>smallbin</h5><p>å¦‚æœåœ¨ fastbin ä¸­æ‰¾ä¸åˆ°å°±ä¼šè¿›å…¥åˆ° smallbin </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>    &#123;<br>      <span class="hljs-comment">//æŸ¥æ‰¾å¯¹åº”å¤§å°çš„ bin ä¸‹æ ‡</span><br>      idx = smallbin_index (nb);<br>      <span class="hljs-comment">// å¾—åˆ° small bin çš„é“¾è¡¨å¤´åœ°å€</span><br>      bin = bin_at (av, idx);<br>      <span class="hljs-comment">//// è¿™é‡Œä¼šè·å– small bin çš„æœ€åä¸€ä¸ª chunkï¼Œå¦‚æœ victim = binï¼Œè¯´æ˜ small bin æ˜¯ç©ºçš„</span><br>      <span class="hljs-keyword">if</span> ((victim = last (bin)) != bin)<br>        &#123;<br>          <span class="hljs-keyword">if</span> (victim == <span class="hljs-number">0</span>) <span class="hljs-comment">/* initialization check */</span><br>            malloc_consolidate (av);<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              <span class="hljs-comment">// è·å– small bin çš„å€’æ•°ç¬¬äºŒä¸ª chunkï¼Œå› ä¸ºåŒå‘é“¾è¡¨æ‰€ä»¥å…¶å®å°±æ˜¯å€’æ•°ç¬¬ä¸€ä¸ª chunk</span><br>              bck = victim-&gt;bk;<br>                <span class="hljs-comment">// æ£€æŸ¥å€’æ•°ç¬¬äºŒä¸ª chunk çš„ fd æŒ‡é’ˆæ˜¯å¦æŒ‡å‘æœ€åä¸€ä¸ª chunk</span><br>				<span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>                &#123;<br>                  errstr = <span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;<br>                  <span class="hljs-keyword">goto</span> errout;<br>                &#125;<br>              <span class="hljs-comment">// è®¾ç½® victim çš„ä¸‹ä¸€ä¸ª chunk çš„ inuse ä½</span><br>              set_inuse_bit_at_offset (victim, nb);<br>              <span class="hljs-comment">// å°†æœ€åä¸€ä¸ª chunk ä» smallbin ä¸­å–å‡ºï¼Œé‡æ–°è®¾ç½®é“¾ä¸­çš„æŒ‡é’ˆ</span><br>              bin-&gt;bk = bck;<br>              bck-&gt;fd = bin;<br><br>              <span class="hljs-comment">//å¦‚æœä¸æ˜¯ä¸»çº¿ç¨‹åˆ™è¦è®¾ç½® A æ ‡å¿—ä½</span><br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                victim-&gt;size |= NON_MAIN_ARENA;<br>              <span class="hljs-comment">//æ£€æŸ¥æ£€æŸ¥ï¼</span><br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-comment">//æ ¹æ® chunk å¾—åˆ°ç”¨æˆ·æ•°æ®æŒ‡é’ˆ p,å¹¶è¿”å›</span><br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>å®å®šä¹‰ä»¬ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NBINS             128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NSMALLBINS         64</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> in_smallbin_range(sz)  \</span><br><span class="hljs-meta">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> smallbin_index(sz) \</span><br><span class="hljs-meta">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\</span><br><span class="hljs-meta">   + SMALLBIN_CORRECTION)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> bin_at(m, i) \</span><br><span class="hljs-meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))                  \</span><br><span class="hljs-meta">             - offsetof (struct malloc_chunk, fd))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> first(b)     ((b)-&gt;fd)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> last(b)      ((b)-&gt;bk)</span><br></code></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œç¨‹åºä¼šé¦–å…ˆç”¨ <code>last (bin)) != bin</code> æ£€æŸ¥ç¬¦åˆç›®æ ‡å¤§å°çš„ smallbin é“¾æ˜¯å¦ä¸ºç©ºã€‚</p>
<p>ä½†æ˜¯è€ƒè™‘åˆ°ä¸€ç§æƒ…å†µæ˜¯æ²¡åˆå§‹åŒ–ã€‚å½“ small bin æ²¡æœ‰åˆå§‹åŒ–æ—¶ï¼Œæ‰€æœ‰æŒ‡é’ˆå‡ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯ç´§æ¥ç€æ£€æŸ¥çš„ <code>victim == 0</code> ã€‚é‚£å°±è¿›è¡Œåˆå§‹åŒ–æ“ä½œè°ƒç”¨ <code>malloc_consolidate()</code> å‡½æ•°ã€‚</p>
<p>è¿™ä¸ªå‡½æ•°è¶…çº§é•¿ï¼Œå¤§æ¦‚å®ç°çš„åŠŸèƒ½æ˜¯å…ˆåˆ¤æ–­å †æ˜¯å¦è¢«åˆå§‹åŒ–ã€‚</p>
<p>å¦‚æœå·²ç»è¢«åˆå§‹åŒ–äº†å°±æŠŠæ‰€æœ‰çš„ <code>fast bin</code>  å–å‡ºæ¥ï¼Œå…ˆæ¸…é™¤å®ƒä»¬çš„æ ‡å¿—ä½ï¼Œç„¶åæ‰”åˆ° unsorted bin ä¸­å°è¯•å‘å‰åˆå¹¶æˆ–è€…å‘ååˆå¹¶ï¼›å¦‚æœæ²¡æœ‰åˆå§‹åŒ–å°±è°ƒç”¨ <code>malloc_init_state</code> å’Œ <code>check_malloc_state</code> å‡½æ•°åˆå§‹åŒ–å †ã€‚</p>
<blockquote>
<p>å…¶å®å¦‚æœ victim &#x3D;&#x3D; 0 å®ƒä¸€å®šæ˜¯æ²¡æœ‰åˆå§‹åŒ–çš„ï¼Œæ‰€ä»¥åˆå¹¶ fastbin é‚£ä¸€éƒ¨åˆ†å¾ˆå°‘æ‰§è¡Œåˆ°ã€‚å¯ä»¥ç†è§£ä¸ºåœ¨è¿™é‡Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥åˆå§‹åŒ– arena çš„ã€‚</p>
</blockquote>
<h5 id="largebin"><a href="#largebin" class="headerlink" title="largebin"></a>largebin</h5><p>å¦‚æœä¸åœ¨ smallbin é‡Œå°±ä¼šå»æŸ¥æ‰¾ largebin è¾£</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span><br>    &#123;<br>      idx = largebin_index (nb);<br>      <span class="hljs-keyword">if</span> (have_fastchunks (av))<br>        malloc_consolidate (av);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>çŸ­çŸ­ä¸‰è¡Œï¼Œ<del>æç®€</del></p>
<p>å…ˆè·å– largebin å¯¹åº”çš„ indexï¼Œç„¶åå¦‚æœ fastbin ä¸ä¸ºç©ºï¼Œè°ƒç”¨ <code>malloc_consolidate</code> ã€‚</p>
<p>å› ä¸º largebin éƒ½å·²ç»å­˜åœ¨äº†è‚¯å®šå·²ç»åˆå§‹åŒ–ï¼Œå®<strong>é™…ä¸Šè¿™é‡Œçš„å‡½æ•°ä½œç”¨æ˜¯å°±åªæ˜¯åˆå¹¶ <code>fast bin</code>ï¼Œä½†å¹¶ä¸å† largebin ä¸­å¯»æ‰¾å †å—ã€‚</strong></p>
<p>ä¹‹å‰ä¸æ˜¯æåˆ°è¯´ <code>fast bin</code> é€šå¸¸ä¸ä¼šå‚ä¸åˆå¹¶ä¸åˆ†å‰²å˜›ï¼Œä½†è¿™å°±æ˜¯ä¸ªä¾‹å¤–ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p>æˆ‘ä»¬æƒ³è¦ç”³è¯·ä¸€å— 0x510 çš„å †å—ï¼ŒåŒæ—¶å†…å­˜åŒºåŸŸä¸­ï¼Œæœ‰ä¸€å— 0x20 çš„ <code>fast bin</code> ä¸ä¸€å— 0x500 çš„ <code>large bin</code> ç›¸é‚»ã€‚æˆ‘ä»¬åˆå¹¶è¿™ä¸¤ä¸ªå †å—å°±èƒ½æ­£å¥½æ»¡è¶³æŠŠä¸€ä¸ª 0x520 çš„ <code>large bin</code> è¿”å›ç»™ç”¨æˆ·ã€‚å¦‚æœä¸åˆå¹¶çš„è¯å°±å¾—é‡æ–°åˆ‡å‰² top_chunk äº†ï¼Œé€ æˆäº†ç©ºé—´æµªè´¹ã€‚</p>
<h5 id="unsortedbin-å’Œ-largebin"><a href="#unsortedbin-å’Œ-largebin" class="headerlink" title="unsortedbin å’Œ largebin"></a>unsortedbin å’Œ largebin</h5><p><del>unsortedbin éƒ¨åˆ†ï¼Œä¹Ÿå¯èƒ½æ˜¯ smallbinï¼Œä¹Ÿå¯èƒ½æ˜¯ largebins</del></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (;; )<br>    &#123;<br>      <span class="hljs-type">int</span> iters = <span class="hljs-number">0</span>;<br>      <span class="hljs-comment">// æ£€æŸ¥ unsortedbin æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºå°±ç»§ç»­</span><br>      <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>        &#123;<br>          bck = victim-&gt;bk;<br>          <span class="hljs-comment">// åˆ¤æ–­å½“å‰ç”³è¯·çš„ size æ˜¯å¦åˆæ³•</span><br>          <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>            malloc_printerr (check_action, <span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>,<br>                             chunk2mem (victim), av);<br>          <span class="hljs-comment">// åˆæ³•åˆ™è·å– size</span><br>          size = chunksize (victim);<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ while å¾ªç¯å°±æ˜¯å¼€å§‹éå† <code>unsorted chunk</code> äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-comment">//å¦‚æœç”³è¯·çš„å¤§å°åœ¨ smallbin çš„èŒƒå›´ä¸­ï¼Œä¸” unsortedbin é“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ª chunk å¹¶æŒ‡å‘ last_remainderï¼Œä¸”è¯¥ chunk çš„ size å¤§å°å¤§äºç”¨æˆ·ç”³è¯·çš„ size å¤§å°</span><br>    <span class="hljs-keyword">if</span> (in_smallbin_range (nb) &amp;&amp;<br>        bck == unsorted_chunks (av) &amp;&amp;<br>        victim == av-&gt;last_remainder &amp;&amp;<br>        (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>      &#123;<br>        <span class="hljs-comment">/* split and reattach remainder */</span><br>        <span class="hljs-comment">//æ‹†åˆ† chunkï¼Œæ›´æ–°last_remainder çš„å¤§å°å’Œå¼€å§‹åœ°å€</span><br>        remainder_size = size - nb;<br>        remainder = chunk_at_offset (victim, nb);<br>        unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;<br>        <span class="hljs-comment">//åˆ‡å‰²å‡ºå‰©ä¸‹çš„ chunk ä½œä¸ºæ–°çš„ av-&gt;last_remainder</span><br>        av-&gt;last_remainder = remainder;<br>        remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);<br>        <span class="hljs-comment">// å¦‚æœ remainder_size çš„å¤§å°ä¸å±äº smallbinï¼Œåˆ™éœ€è¦è®¾ç½® nextsize ä¸ºç©ºï¼Œåé¢ä¼šæŠŠå®ƒä¸¢åˆ° unsortedbin ä¸­</span><br>        <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>          &#123;<br>            remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>            remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>          &#125;<br><span class="hljs-comment">//ä¸‹é¢å°±æ˜¯è®¾ç½®å„ç§æ ‡å¿—ä½äº†</span><br>        set_head (victim, nb | PREV_INUSE |<br>                  (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>        set_head (remainder, remainder_size | PREV_INUSE);<br>        set_foot (remainder, remainder_size);<br><br>        check_malloced_chunk (av, victim, nb);<br>        <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>        alloc_perturb (p, bytes);<br>        <span class="hljs-keyword">return</span> p;<br>      &#125;<br></code></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç æœ€å¼€å§‹çš„åˆ¤æ–­è¯¦ç»†æ‹†åˆ†ä¸€ä¸‹å°±æ˜¯ï¼š</p>
<ul>
<li><code>in_smallbin_range (nb)</code> ï¼šç”³è¯·çš„å¤§å°åœ¨ small bin çš„èŒƒå›´ä¸­</li>
<li><code>bck == unsorted_chunks (av)</code> ï¼šunsorted bin ä¸­åªæœ‰ä¸€ä¸ª chunk ã€‚</li>
<li><code>victim == av-&gt;last_remainder</code>ï¼šè¿™ä¸ª chunk åˆšå¥½æ˜¯æœ€è¿‘è¢«åˆ†å‰²è¿‡çš„å‰©ä½™éƒ¨åˆ†ã€‚</li>
<li><code>(unsigned long) (size) &gt; (unsigned long) (nb + MINSIZE))</code>ï¼šæ‰¾åˆ°çš„è¿™ä¸ª chunkçš„ <code>size</code> å¤§äºéœ€è¦çš„æœ€å°å—å¤§å°+ <code>MINSIZE</code> ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* remove from unsorted list */</span><br><span class="hljs-comment">//å¦‚æœä¸Šä¸€ä¸ªæ¡ä»¶æ»¡è¶³å°±æ˜¯ chunk è¦è¢«åˆ†é…å‡ºå»äº†æ‰€ä»¥è¦æŠŠè¿™ä¸ª chunk ä» unsortedbin ä¸­è§£é™¤</span><br><span class="hljs-comment">//å› ä¸ºè¿™ä¸ªæŒ‡ä»¤åœ¨ if å¤–æ‰€ä»¥ä¸æ»¡è¶³ä¹Ÿä¼šæ‹¿å‡ºæœ€åä¸€ä¸ª chunk</span><br>unsorted_chunks (av)-&gt;bk = bck;<br>bck-&gt;fd = unsorted_chunks (av);<br></code></pre></td></tr></table></figure>

<p>å‰ä¸€ä¸ª if æ¡ä»¶ä¸æ»¡è¶³å°±åˆ°è¿™é‡Œäº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Take now instead of binning if exact fit */</span><br><span class="hljs-comment">//å¦‚æœå½“å‰ç”¨æˆ·ç”³è¯·çš„sizeåˆšå¥½ä¸è§£é“¾çš„chunkå¤§å°ç›¸åŒï¼Œåˆ™è¿”å›</span><br>      <span class="hljs-keyword">if</span> (size == nb)<br>        &#123;<br>          set_inuse_bit_at_offset (victim, size);<br>          <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>            victim-&gt;size |= NON_MAIN_ARENA;<br>          check_malloced_chunk (av, victim, nb);<br>          <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>          alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br></code></pre></td></tr></table></figure>

<p>å¦‚æœå–å‡ºçš„è¿™ä¸ª chunk çš„  <code>size</code> åˆšå¥½ç­‰äºè¿™ä¸ª <code>nb</code> ï¼Œé‚£å°±è¯´æ˜è¿™ä¸ªå—ä¸€å®šæ˜¯æœ€åˆé€‚çš„ï¼Œå°±ç›´æ¥è¿”å›ã€‚å¦‚æœä¸åˆé€‚è¿›å…¥ä¸‹é¢çš„éƒ¨åˆ†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//åˆ¤æ–­å–å‡ºçš„è¿™ä¸ª chunk çš„ size å±ä¸å±äº smallbin</span><br><span class="hljs-keyword">if</span> (in_smallbin_range (size))<br>        &#123;<br>          <span class="hljs-comment">//å°†è¯¥chunkæ’å…¥small binä¸­</span><br>          victim_index = smallbin_index (size);<br>          bck = bin_at (av, victim_index);<br>          fwd = bck-&gt;fd;<br>        &#125;<br> <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-comment">//ä¸æ˜¯çš„è¯æ’å…¥ largebin</span><br>          victim_index = largebin_index (size);<br>          bck = bin_at (av, victim_index);<br>          fwd = bck-&gt;fd;<br></code></pre></td></tr></table></figure>

<p>å±äº smallbin å°±ä¸¢è¿› smallbinï¼Œå¦‚æœä¸å±äºå°±ä¸¢è¿› largebin äº†ã€‚</p>
<p>è¿™éƒ¨åˆ†ä»£ç æœ€å¼€å§‹å¼€å§‹çš„åˆ¤æ–­å¤§å°ç„¶åä¸¢è¿› largebinã€smallbin çš„éƒ¨åˆ†ï¼Œå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´åˆ†é…è§„åˆ™çš„æ—¶å€™æåˆ°çš„æŠŠ unsortedbin ä¸­çš„å †å—åˆ†ç±»çš„å®ç°ã€‚</p>
<p>æˆ‘ä»¬ä¸¢è¿›large bin ä¹‹åè¦è®¾ç½®ç›¸åº”çš„æŒ‡é’ˆã€‚large bin ä¸­ä¸€ä¸ª <code>chunk </code> æœ‰å››ä¸ªæŒ‡é’ˆï¼Œæ¯å¯¹é“¾è¡¨å¤´ bin éƒ½ç®¡ç†ä¸€ä¸ªäºŒç»´åŒå‘é“¾è¡¨ï¼Œ<code>fd</code>ã€<code>bk</code> æŒ‡é’ˆä¸ç›¸åŒå¤§å°çš„ chunk è¿æ¥ï¼Œ<code>fd_nextsize</code> å’Œ <code>bk_nextsize</code> ä¸ä¸åŒå¤§å°çš„ <code>chunk</code> è¿æ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs C">   <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>         <span class="hljs-comment">//è¿™é‡Œçš„ bck æŒ‡çš„æ˜¯è¡¨å¤´ bin æ‰€åœ¨çš„ chunkï¼Œfwd æŒ‡çš„æ˜¯æœ€å¤§çš„ chunkã€‚</span><br><span class="hljs-comment">//æ£€æµ‹ largebin æ˜¯å¦éç©º</span><br>         <span class="hljs-keyword">if</span> (fwd != bck)<br>           &#123;<br>             <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>             <span class="hljs-comment">//å»é™¤ Pæ ‡å¿—ä½</span><br>             size |= PREV_INUSE;<br>             <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>             <span class="hljs-comment">//æ£€æŸ¥Aæ ‡å¿—ä½</span><br>             assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>             <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size))<br>               &#123;<br>                 fwd = bck;<br>                 bck = bck-&gt;bk;<br><br>                 victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                 victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                 fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>               &#125;<br>             <span class="hljs-keyword">else</span><br>               &#123;<br>                 assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                 <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size)<br>                   &#123;<br>                     fwd = fwd-&gt;fd_nextsize;<br>                     assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                   &#125;<br><br>                 <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br>                   <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                   fwd = fwd-&gt;fd;<br>                 <span class="hljs-keyword">else</span><br>                   &#123;<br>                     victim-&gt;fd_nextsize = fwd;<br>                     victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                     fwd-&gt;bk_nextsize = victim;<br>                     victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                   &#125;<br>                 bck = fwd-&gt;bk;<br>               &#125;<br>           &#125;<br>         <span class="hljs-comment">//å¦‚æœ largebin ä¸ºç©ºï¼Œé‚£ä¹ˆç›´æ¥åŠ å…¥é“¾è¡¨å°±è¡Œ</span><br>         <span class="hljs-keyword">else</span><br>           victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>       &#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ä¸€ä¸ªç©ºçš„ largebin ä¸­æ’å…¥ chunk çš„æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">fwd=bin-&gt;fd;<br>bck=bin-&gt;bk;<br>victim-&gt;bk_nextsize=bck;<br>victim-&gt;fd_nextsize=fwd;<br>fwd-&gt;bk_nextsize=bck-&gt;fd_nextsize=victim;<br></code></pre></td></tr></table></figure>

<p>éç©ºä¹Ÿä¸€æ ·ï¼Œå°±æ˜¯æŠŠ bin çš„æŒ‡é’ˆæ¢æˆå¯¹åº”çš„å‰å chunk çš„æŒ‡é’ˆã€‚</p>
<p>ä¸­é—´æ²¡æœ‰æ³¨é‡Šçš„é•¿é•¿çš„ä¸€éƒ¨åˆ†éƒ½æ˜¯åœ¨æŸ¥æ‰¾åˆé€‚çš„ä½ç½®æ’å…¥ï¼Œç„¶åä¿®æ”¹æŒ‡é’ˆã€‚å¦‚æœåœ¨å½“å‰çš„ largebin ä¸­æ‰¾åˆ°äº† <code>size</code> ç­‰äºæˆ‘ä»¬å–å‡ºçš„ chunk çš„å †å— <code>size</code> çš„å †å—ï¼Œå°±åªéœ€è¦ä¿®æ”¹ <code>fd</code> å’Œ <code>bk </code>æŒ‡é’ˆï¼›å…¶ä»–æƒ…å†µè¿˜éœ€è¦ä¿®æ”¹ <code>fd_nextsize</code> å’Œ <code>bk_nextsize</code> æŒ‡é’ˆã€‚</p>
<p>å‰é¢æ‰¾åˆ°äº†æ’å…¥çš„ä½ç½®ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ’å…¥æ“ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">		  mark_bin (av, victim_index);<br>          victim-&gt;bk = bck;<br>          victim-&gt;fd = fwd;<br>          fwd-&gt;bk = victim;<br>          bck-&gt;fd = victim;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_ITERS       10000</span><br>          <span class="hljs-keyword">if</span> (++iters &gt;= MAX_ITERS)<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šé¢å¯¹ unsortedbin çš„éå†æ¯”è¾ƒé•¿ï¼Œæ¯ä¸€æ¬¡ä¾¿åˆ©çš„æµç¨‹å¤§æ¦‚æµç¨‹å°±æ˜¯ï¼š</p>
<p>æŸ¥æ‰¾ unsortedbin æ˜¯å¦ä¸ºç©ºã€‚ä¸ä¸ºç©ºï¼Œä¸”åªæœ‰ä¸€ä¸ª chunk ä¸”ä¸º last_remainder æ—¶ï¼Œè¿›è¡Œ last_remainder åˆ‡åˆ†åç›´æ¥è¿”å›ï¼›å¦‚æœæœ‰å¤šä¸ª chunk ï¼Œåˆ™éœ€è¦å°† chunk ä» unsortedbin ä¸­è§£é“¾ï¼Œå¦‚æœå¤§å°æ»¡è¶³åˆ™è¿”å›ï¼Œ</p>
<p>å¦‚æœchunkå¤§å°ä¸æ»¡è¶³ï¼Œè¿›è¡Œåˆ¤æ–­å¯¹åº”ä¸¢è¿› smallbin æˆ– largebin ã€‚</p>
<p>æ³¨æ„ï¼Œ<strong>å½“å–å¾— unsorted bin chunk ä¸æˆ‘ä»¬ç”³è¯·çš„ chunk å¤§å°ç›¸åŒæ—¶</strong>ï¼Œç¨‹åºè¿›è¡Œäº†å¦‚ä¸‹æ“ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* remove from unsorted list */</span><br><span class="hljs-comment">//å°†å½“å‰çš„chunkä»unsortedbin é“¾è¡¨é‡Œè§£é™¤</span><br>unsorted_chunks(av)-&gt;bk = bck;<br>bck-&gt;fd = unsorted_chunks(av);<br></code></pre></td></tr></table></figure>

<p>æ®æ­¤æˆ‘ä»¬å¯ä»¥å‘ç°å¦å¤–ä¸€ç§åˆ©ç”¨æ–¹æ³•ï¼Œ<strong>æ§åˆ¶ av çš„ bk æŒ‡é’ˆï¼Œé‚£ä¹ˆå°±èƒ½å‘ bk çš„ fd æŒ‡é’ˆå†™å…¥ av çš„å€¼ï¼Œå‘ç”Ÿ unsortedbin attackã€‚</strong></p>
<p>æˆ‘ä»¬ä¹‹å‰ä¸æ˜¯éå† unsortedbin åˆæ•´ç†äº†ä¸€ä¸‹ largebin å’Œ smallbin å˜›ï¼Œå¦‚æœåœ¨ unsortebin é‡Œé¢æ²¡æ‰¾åˆ°åˆé€‚çš„å°±ä¼šå†å»æŸ¥æ‰¾ä¸€éè¯·æ±‚ size å¯¹åº”çš„ bin ä¸­çš„ chunk ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-comment">//ç¡®è®¤ç”¨æˆ·ç”³è¯·çš„ chunk å¤§å°ä¸å±äº smallbin</span><br><span class="hljs-keyword">if</span> (!in_smallbin_range (nb))<br>     &#123;<br>       bin = bin_at (av, idx);<br><br>       <span class="hljs-comment">/* skip scan if empty or largest chunk is too small */</span><br>       <span class="hljs-comment">//å¦‚æœ largebin ä¸ä¸ºç©ºï¼Œç”¨æˆ·è¯·æ±‚çš„ size å°äº large bin ä¸­æœ€å¤§çš„ chunk size</span><br>       <span class="hljs-keyword">if</span> ((victim = first (bin)) != bin &amp;&amp;<br>           (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (victim-&gt;size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>         &#123;<br>           <span class="hljs-comment">//while å¾ªç¯è·å–åˆšå¥½å°äºç”¨æˆ·è¯·æ±‚çš„ size çš„ large bin</span><br>           victim = victim-&gt;bk_nextsize;<br>           <span class="hljs-keyword">while</span> (((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size = chunksize (victim)) &lt;<br>                   (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb)))<br>             victim = victim-&gt;bk_nextsize;<br><br>           <span class="hljs-comment">/* Avoid removing the first entry for a size so that the skip</span><br><span class="hljs-comment">              list does not have to be rerouted.  */</span><br>           <span class="hljs-keyword">if</span> (victim != last (bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size)<br>             victim = victim-&gt;fd;<br><br>           <span class="hljs-comment">//æ‹†åˆ†ç¬¦åˆè¦æ±‚çš„ large chunk</span><br>           remainder_size = size - nb;<br>           <span class="hljs-comment">//å°†large chunkä» largebin ä¸­è§£é“¾</span><br>           unlink (av, victim, bck, fwd);<br><br>           <span class="hljs-comment">/* Exhaust */</span><br>           <span class="hljs-comment">//å¤„ç†åˆ‡åˆ†ä¸‹æ¥çš„å‰©ä½™éƒ¨åˆ†ï¼Œå¦‚æœåˆ‡å‰²ä¸‹æ¥çš„éƒ¨åˆ†å°äº MINSIZE é‚£å°±ä¸åˆ‡å‰²äº†</span><br>           <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>             &#123;<br>               <span class="hljs-comment">//æŠŠå®ƒç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ªå¿«prev_inuseä½è®¾1</span><br>               set_inuse_bit_at_offset (victim, size);<br>               <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                 victim-&gt;size |= NON_MAIN_ARENA;<br>             &#125;<br>           <span class="hljs-comment">/* Split */</span><br>           <span class="hljs-keyword">else</span><br>             &#123;<br>               <span class="hljs-comment">//å°†åˆ‡å‰²çš„å‰©ä½™éƒ¨åˆ†æ’å…¥ unsortedbin ä¸­</span><br>               remainder = chunk_at_offset (victim, nb);<br>               <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                  have to perform a complete insert here.  */</span><br>               bck = unsorted_chunks (av);<br>               fwd = bck-&gt;fd;<br><span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>                 &#123;<br>                   errstr = <span class="hljs-string">&quot;malloc(): corrupted unsorted chunks&quot;</span>;<br>                   <span class="hljs-keyword">goto</span> errout;<br>                 &#125;<br>               remainder-&gt;bk = bck;<br>               remainder-&gt;fd = fwd;<br>               bck-&gt;fd = remainder;<br>               fwd-&gt;bk = remainder;<br>               <span class="hljs-comment">// remainder ä¸æ»¡è¶³ small bin</span><br>               <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                 &#123;<br>                   <span class="hljs-comment">//æ¸…ç©ºå®ƒçš„fd_nextsizeå’Œbk_nextsize</span><br>                   remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                   remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                 &#125;<br>               <span class="hljs-comment">// è®¾ç½®åˆ†é…çš„ chunk å †å¤´</span><br>               set_head (victim, nb | PREV_INUSE |<br>                         (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>               set_head (remainder, remainder_size | PREV_INUSE);<br>               set_foot (remainder, remainder_size);<br>             &#125;<br>           check_malloced_chunk (av, victim, nb);<br>           <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>           alloc_perturb (p, bytes);<br>           <span class="hljs-keyword">return</span> p;<br>         &#125;<br>     &#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨å¯»æ‰¾æ—¶ä¸æ˜¯æœ‰è¯´è¦æ‰¾æœ€å°èƒ½æ»¡è¶³çš„å¤§å°çš„å—å˜›ï¼Œä»£ç ä¸­ <code>nb</code> æ˜¯æŒ‡ç”¨æˆ·éœ€è¦çš„æœ€å°èƒ½æ»¡è¶³çš„å—çš„ <code>size</code> ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯æ‰€æœ‰æƒ…å†µä¸‹éƒ½æ»¡è¶³ <code>size=nb</code> ã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬ç”³è¯· 0x1 å¤§å°çš„å †å—ï¼Œé‚£å°±åªèƒ½ç»™å®ƒä¸€ä¸ª 0x20 çš„ chunkã€‚æˆ–è€… æˆ‘ä»¬ç°åœ¨ç”šè‡³æ²¡æœ‰ 0x20 çš„å—ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ª 0x30 çš„ï¼Œé‚£ä¹ˆè¿™ä¸ª 0x30 çš„ chunk å°±æ˜¯æˆ‘ä»¬è¦å¯»æ‰¾çš„å †å—ã€‚</p>
<p>åœ¨å¤„ç†åˆ‡å‰²ä¸‹æ¥çš„å †å—æ—¶ï¼Œå®ƒåªæ£€æµ‹äº†äº† <code>unsorted bin-&gt;fd-&gt;bk</code> æ˜¯å¦ç­‰äºé‚£ä¸ª <code>unsorted bin</code> ï¼Œå¯¹äºå †å—æ¥è¯´å°±æ˜¯åªæ£€æµ‹äº† <code>bk</code> æŒ‡é’ˆã€‚è¿™æ˜¯ä¸€ä¸ªåˆ©ç”¨å°æŠ€å·§ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ—¶<strong>æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ <code>fd</code> æŒ‡é’ˆä¸ºæœŸæœ›çš„å€¼ï¼Œä¸ä¼šåœ¨è¿™é‡Œè¢«æ£€æµ‹åˆ°ï¼Œå°±æ˜¯ <code>unsorted bin attack</code> äº†ã€‚</strong></p>
<p>è¢«åˆ‡å‰²çš„å‰©ä¸‹ chunk ä¼šè¢«æ”¾åœ¨ <code>unsortedbin</code> ï¼Œä½†æ˜¯ç¨‹åºä»ç„¶ä¼šæ£€æµ‹å®ƒæ˜¯ä¸æ˜¯åœ¨ <code>small bin</code> çš„èŒƒå›´é‡Œã€‚å¦‚æœä¸åœ¨ <code>small bin</code> èŒƒå›´å†…ï¼Œå°±ä¼šæ¸…ç©ºå®ƒçš„ <code>fd_nextsize</code> å’Œ <code>bk_nextsize</code> ã€‚å› ä¸ºå®ƒè¦å›åˆ° <code>unsorted bin</code> ï¼Œè¿™ä¸¤ä¸ªå­—æ®µå°±æ²¡ä»€ä¹ˆç”¨äº†ï¼Œå°±ä¼šè¢«æ¸…ç©ºã€‚</p>
<p>å¦‚æœå½“å‰çš„ large bin ä¸­æ²¡æœ‰ç¬¦åˆè¦æ±‚çš„ chunkï¼Œåˆ™åœ¨å…¶å®ƒ size çš„ large bin ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚é¦–å…ˆéœ€è¦çœ‹ä¸€ä¸‹è¿™ä¸ª  <code>binmap</code> ç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">++idx;<br>   bin = bin_at (av, idx);<br>   block = idx2block (idx);<br>   <span class="hljs-built_in">map</span> = av-&gt;binmap[block];<br>   bit = idx2bit (idx);<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªç»“æ„ç”¨äºå¿«é€Ÿæ£€ç´¢ä¸€ä¸ª <code>bin</code> æ˜¯å¦ä¸ºç©ºï¼Œæ¯ä¸€ä¸ª <code>bit</code> è¡¨ç¤ºå¯¹åº”çš„ <code>bin</code> ä¸­æ˜¯å¦å­˜åœ¨ç©ºé—² chunk ã€‚è¿™ä¸€æ®µå°±æ˜¯è¯´ï¼Œå¦‚æœ <code>large bin</code> æœç´¢å®Œäº†éƒ½æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ <code>chunk</code> ï¼Œé‚£ä¹ˆå°±å»ä¸‹ä¸€ä¸ª <code>idx</code> é‡Œé¢å¯»æ‰¾ã€‚ç„¶åä¸€å…±æœ‰4ä¸ª <code>int</code> ï¼Œæ¯ä¸ª <code>int</code> 32ä½è¡¨ç¤ºä¸€å— <code>map</code> ï¼Œä¸€å…±è¡¨ç¤º <code>128</code> ä½ã€‚</p>
<p>è¿™æ®µä»£ç çš„æ‰§è¡Œæµç¨‹å°±æ˜¯ï¼šåˆ©ç”¨ idx ç´¢å¼•å€¼æ¥è·å–æŒ‡å‘å¯¹åº” bin çš„æŒ‡é’ˆã€‚ç„¶åæ ¹æ®è¿™ä¸ª bin æŒ‡é’ˆæ¥è·å– </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (;; )<br>     &#123;<br>       <span class="hljs-comment">/* Skip rest of block if there are no more set bits in this block.  */</span><br>       <span class="hljs-keyword">if</span> (bit &gt; <span class="hljs-built_in">map</span> || bit == <span class="hljs-number">0</span>)<br>         &#123;<br>           <span class="hljs-keyword">do</span><br>             &#123;<br>               <span class="hljs-keyword">if</span> (++block &gt;= BINMAPSIZE) <span class="hljs-comment">/* out of bins */</span><br>                 <span class="hljs-keyword">goto</span> use_top;<br>             &#125;<br>           <span class="hljs-keyword">while</span> ((<span class="hljs-built_in">map</span> = av-&gt;binmap[block]) == <span class="hljs-number">0</span>);<br><br>           bin = bin_at (av, (block &lt;&lt; BINMAPSHIFT));<br>           bit = <span class="hljs-number">1</span>;<br>         &#125;<br></code></pre></td></tr></table></figure>

<p>ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶ï¼š</p>
<ul>
<li><code>bit&gt;map</code>ï¼šå¦‚æœè¿™ä¸ªä½çš„æƒå€¼éƒ½æ¯”å®ƒæ•´ä¸ªçš„ <code>map</code> éƒ½å¤§äº†ï¼Œè¯´æ˜ <code>map</code> ä¸Šé‚£ä¸ª <code>bit</code> çš„æƒå€¼å¿…å®šä¸º0</li>
<li><code>bit==0</code>ï¼šå¦‚æœè¿™ä¸ª <code>bit</code> éƒ½æ˜¯ 0 è¯´æ˜è¿™ä¸ª <code>index</code> ä¹Ÿä¸å¯¹ã€‚</li>
</ul>
<p>ä¸¤ä¸ªæ¡ä»¶åªè¦æ»¡è¶³å…¶ä¸€å°±æ˜¯æ²¡æœ‰ç©ºé—²å †å—ï¼Œæ¥ç€å»æŸ¥çœ‹ä¸‹ä¸€ä¸ª indexã€‚</p>
<p>æ¥ä¸‹æ¥çš„åˆ¤æ–­å¦‚æœ <code>map==0</code> ï¼Œè¯´æ˜è¿™æ•´ä¸ª <code>block</code> éƒ½æ²¡æœ‰ç©ºé—²å—ï¼Œå°±ç›´æ¥è·³è¿‡ï¼Œä¸ä¸º 0 åˆ™é€€å‡ºå»æ‰§è¡Œä¸‹é¢çš„æ“ä½œï¼Œå¦‚æœè¶…è¿‡äº† <code>block</code> çš„æ€»æ•°ï¼Œé‚£å°±è¯´æ˜ <code>unsorted bin</code> å’Œ <code>large bin</code> ä¸­ä¹Ÿæ²¡æœ‰åˆé€‚çš„<code>chunk</code>ï¼Œé‚£æˆ‘ä»¬å°±åˆ‡å‰²<code>top_chunk</code>äº†ï¼Œè¿™é‡Œç”¨äº†ä¸€ä¸ª <code>goto use_top;</code> è·³è½¬ï¼Œåœ¨åé¢ä¼šåˆ†æåˆ°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">      <span class="hljs-comment">/* Advance to bin with set bit. There must be one. */</span><br>      <span class="hljs-comment">// åœ¨ block ä¸­æ‰¾åˆ°å­˜åœ¨ç¬¦åˆè¦æ±‚çš„ large bin é“¾è¡¨å¤´æŒ‡é’ˆ</span><br>      <span class="hljs-keyword">while</span> ((bit &amp; <span class="hljs-built_in">map</span>) == <span class="hljs-number">0</span>)<br>        &#123;<br>          bin = next_bin (bin);<br>          bit &lt;&lt;= <span class="hljs-number">1</span>;<br>          assert (bit != <span class="hljs-number">0</span>);<br>        &#125;<br><br>      <span class="hljs-comment">/* Inspect the bin. It is likely to be non-empty */</span><br>      victim = last (bin);<br><br>      <span class="hljs-comment">/*  If a false alarm (empty bin), clear the bit. */</span><br><span class="hljs-comment">// å¦‚æœé“¾è¡¨éç©º</span><br>      <span class="hljs-keyword">if</span> (victim == bin)<br>        &#123;<br>          av-&gt;binmap[block] = <span class="hljs-built_in">map</span> &amp;= ~bit; <span class="hljs-comment">/* Write through */</span><br>          bin = next_bin (bin);<br>          bit &lt;&lt;= <span class="hljs-number">1</span>;<br>        &#125;<br></code></pre></td></tr></table></figure>

<p>ç»è¿‡ä¸Šé¢çš„æµç¨‹ï¼Œæˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†åˆé€‚çš„ block ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯»æ‰¾ block çš„å„ä¸ªä½äº†ã€‚ä»ä½ä½å¼€å§‹ï¼Œå¦‚æœæ£€æŸ¥åˆ°<code>map</code>é‚£ä¸€ä½å¯¹åº”ä¸º0å°±æ‰¾ä¸‹ä¸€ä½ï¼Œæˆ‘ä»¬å‰é¢æåˆ° bk ä¸º <code>large bin</code> çš„æœ€å°å—ï¼Œæ‰€ä»¥å…ˆä»å®ƒå¼€å§‹ï¼Œä¹Ÿå°±æ˜¯å…ˆæ‰§è¡Œ <code>bin = next_bin (bin);</code> ã€‚</p>
<p>å½“ç„¶ä¸èƒ½è¯´ <code>map</code> é‡Œé¢è¯´è¿™é‡Œæœ‰å®ƒå°±æœ‰ï¼Œæˆ‘è¿˜å¾—è‡ªå·±åˆ¤æ–­ä¸€ä¸‹è¿™ä¸ª<code>bin</code>é‡Œé¢æ˜¯ä¸æ˜¯çœŸçš„æœ‰ï¼Œå¦‚æœæ²¡æœ‰å°±è¦åŠæ—¶æŠŠæ ‡å¿—ä½æ¸…é™¤ç„¶å <code>bit&lt;&lt;1</code> å»å¯»æ‰¾ä¸‹ä¸€ä¸ª <code>index</code> ã€‚</p>
<p>æ‰¾åˆ°åˆé€‚çš„ <code>large bin</code> çš„ç´¢å¼•ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»ä¸­æ‰¾åˆé€‚çš„å †å—ï¼Œæµç¨‹å’Œä¸Šé¢ä¸€æ ·ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-comment">// æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç”³è¯· size çš„ chunk è¿›è¡Œå †å—åˆ’åˆ†</span><br>       <span class="hljs-keyword">else</span><br>         &#123;<br>           size = chunksize (victim);<br><br>           <span class="hljs-comment">/*  We know the first chunk in this bin is big enough to use. */</span><br>           assert ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb));<br><br>           remainder_size = size - nb;<br><br>           <span class="hljs-comment">/* unlink */</span><br>           unlink (av, victim, bck, fwd);<br><br>           <span class="hljs-comment">/* Exhaust */</span><br>           <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>             &#123;<br>               set_inuse_bit_at_offset (victim, size);<br>               <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                 victim-&gt;size |= NON_MAIN_ARENA;<br>             &#125;<br><br>           <span class="hljs-comment">/* Split */</span><br>           <span class="hljs-keyword">else</span><br>             &#123;<br>               remainder = chunk_at_offset (victim, nb);<br><br>               <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                  have to perform a complete insert here.  */</span><br>               bck = unsorted_chunks (av);<br>               fwd = bck-&gt;fd;<br><span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>                 &#123;<br>                   errstr = <span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>;<br>                   <span class="hljs-keyword">goto</span> errout;<br>                 &#125;<br>               remainder-&gt;bk = bck;<br>               remainder-&gt;fd = fwd;<br>               bck-&gt;fd = remainder;<br>               fwd-&gt;bk = remainder;<br><br>               <span class="hljs-comment">/* advertise as last remainder */</span><br>               <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>                 av-&gt;last_remainder = remainder;<br>               <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                 &#123;<br>                   remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                   remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                 &#125;<br>               set_head (victim, nb | PREV_INUSE |<br>                         (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>               set_head (remainder, remainder_size | PREV_INUSE);<br>               set_foot (remainder, remainder_size);<br>             &#125;<br>           check_malloced_chunk (av, victim, nb);<br>           <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>           alloc_perturb (p, bytes);<br>           <span class="hljs-keyword">return</span> p;<br>         &#125;<br>     &#125;<br></code></pre></td></tr></table></figure>

<h5 id="Topchunk"><a href="#Topchunk" class="headerlink" title="Topchunk"></a>Topchunk</h5><p>å¦‚æœåœ¨ large bin ä¸­æ²¡æœ‰æ‰¾åˆ°å“åº”çš„ chunkï¼Œåˆ™éœ€è¦åœ¨ top chunk ä¸­æŸ¥æ‰¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c">use_top:<br><br>	  <span class="hljs-comment">//ä» av-&gt;top æ‹¿åˆ° top_chunk çš„åœ°å€</span><br>      victim = av-&gt;top;<br>	  <span class="hljs-comment">//åˆ¤æ–­å¤§å°</span><br>      size = chunksize (victim);<br>	  <span class="hljs-comment">//å¦‚æœå¤§å°ç¬¦åˆåˆ‡å‰²è¦æ±‚ï¼Œå°±æŒ‰ç…§ä¹‹å‰çš„æµç¨‹åˆ‡å‰²å¹¶æŠŠ chunk è¿”å›ç”¨æˆ·</span><br>      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>        &#123;<br>          remainder_size = size - nb;<br>          remainder = chunk_at_offset (victim, nb);<br>          av-&gt;top = remainder;<br>          set_head (victim, nb | PREV_INUSE |<br>                    (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>          set_head (remainder, remainder_size | PREV_INUSE);<br><br>          check_malloced_chunk (av, victim, nb);<br>          <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>          alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br><br>      <span class="hljs-comment">/* When we are using atomic ops to free fast chunks we can get</span><br><span class="hljs-comment">         here for all block sizes.  */</span><br>	  <span class="hljs-comment">//å¦‚æœå¤§å°ä¸æ»¡è¶³éœ€è¦ï¼Œå°±å…ˆåˆå¹¶æ‰€æœ‰çš„ fastbinï¼Œæ¥ç€æ‰§è¡Œä¹‹å‰çš„å¾ªç¯</span><br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (have_fastchunks (av))<br>        &#123;<br>          malloc_consolidate (av);<br>          <span class="hljs-comment">/* restore original bin index */</span><br>          <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>            idx = smallbin_index (nb);<br>          <span class="hljs-keyword">else</span><br>            idx = largebin_index (nb);<br>        &#125;<br><br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">         Otherwise, relay to handle system-dependent cases</span><br><span class="hljs-comment">       */</span><br>	  <span class="hljs-comment">//è°ƒç”¨ sysmalloc å»åˆ†é…æ–°ä¸€é¡µå†…å­˜</span><br>      <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-type">void</span> *p = sysmalloc (nb, av);<br>          <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>            alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„ç¨‹åºä¼šåå¤æŸ¥æ‰¾å½“å‰å†…å­˜åŒºåŸŸæ˜¯å¦æœ‰åˆé€‚çš„å†…å­˜ï¼Œå¦‚æœå®åœ¨æ²¡æœ‰æ‰ä¼šå»è°ƒç”¨ <code>sysmalloc</code>ã€‚ä¸€æ¬¡è¿˜æ˜¯åˆ†é…<code>0x21000</code> çš„ chunk ä½œä¸ºæ–°çš„ <code>top_chunk</code> ï¼ŒåŸæ¥çš„ <code>top_chunk</code> å°†ä¼šè¢« <code>free</code> ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æ²¡æœ‰æ”¹è¿‡ <code>top_chunk</code> çš„ <code>size </code>ï¼Œé‚£ä¹ˆæ–°çš„å’Œæ—§çš„ <code>top_chunk </code>å°†ä¼šæ˜¯ç‰©ç†ç›¸é‚»ï¼Œå¦‚æœ <code>free</code> çš„<code>top_chunk </code>ä¸åœ¨ <code>fast bin</code> èŒƒå›´å†…ï¼Œé‚£å°±ä¼šå’Œæ–°çš„ <code>top_chunk</code> å‘ç”Ÿåˆå¹¶ã€‚</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><code>malloc()</code>  å‡½æ•°è¢«è°ƒç”¨æ—¶ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ£€æŸ¥æ˜¯å¦è®¾ç½®äº† <code>malloc_hook</code> ï¼Œè‹¥è®¾ç½®äº†åˆ™è·³è½¬è¿›å…¥ <code>malloc_hook</code>ï¼Œè‹¥æœªè®¾ç½®åˆ™è·å–å½“å‰çš„åˆ†é…åŒºï¼Œè¿›å…¥<code>int_malloc()</code> ã€‚</li>
<li>å¦‚æœå½“å‰çš„åˆ†é…åŒºä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>sysmalloc</code> åˆ†é…ç©ºé—´ï¼Œè¿”å›æŒ‡å‘æ–° <code>chunk</code> çš„æŒ‡é’ˆï¼Œå¦åˆ™è¿›å…¥ä¸‹ä¸€æ­¥ã€‚</li>
<li>è‹¥ç”¨æˆ·ç”³è¯·çš„å¤§å°åœ¨ <code>fast bin</code> çš„èŒƒå›´å†…ï¼Œåˆ™è€ƒè™‘å¯»æ‰¾å¯¹åº” <code>size</code> çš„ fastbin chunk ï¼Œå¦‚æœè¿™ä¸ªå¯¹åº” <code>size</code> çš„ fastbin ä¸­æœ‰æ»¡è¶³çš„å †å—å°±è¿”å›ç»™ç”¨æˆ·ï¼Œå¦‚æœæ²¡æœ‰å°±è¿›å…¥ä¸‹ä¸€æ­¥ã€‚</li>
<li>å¦‚æœç”¨æˆ·ç”³è¯·çš„ <code>size</code> ç¬¦åˆ <code>small bin</code> çš„èŒƒå›´ï¼Œåˆ™åœ¨ç›¸åº”å¤§å°çš„é“¾è¡¨ä¸­å¯»æ‰¾ <code>chunk</code> ã€‚è‹¥ <code>small bin</code> æœªåˆå§‹åŒ–ï¼Œåˆ™è°ƒç”¨ <code>malloc_consolidate</code> åˆå§‹åŒ–åˆ†é…å™¨ï¼Œç„¶åç»§ç»­ä¸‹é¢çš„æ­¥éª¤ï¼›å¦‚æœå·²ç»åˆå§‹åŒ–äº†ï¼Œå°±å¯»æ‰¾å¯¹åº”çš„ <code>small bin</code> çš„é“¾è¡¨ï¼Œå¦‚æœè¯¥ <code>size</code>  çš„ <code>small bin</code> åˆæ»¡è¶³çš„å †å—å°±å–å‡ºè¿”å›ï¼Œå¦åˆ™ç»§ç»­ä¸‹é¢çš„æ­¥éª¤ã€‚å¦‚æœç”³è¯·çš„ä¸åœ¨ <code>small bin</code> çš„èŒƒå›´ï¼Œé‚£ä¹ˆè°ƒç”¨ <code>malloc_consolidate</code> å‡½æ•°å»åˆå¹¶æ‰€æœ‰ fastbin å¹¶è¿›å…¥ä¸‹ä¸€æ­¥ã€‚</li>
<li>å¦‚æœåœ¨ä¸Šé¢çš„æµç¨‹ä¸­éƒ½æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å—ï¼Œä¼šéå† fast bins ä¸­çš„ chunkï¼Œå°†ç›¸é‚»çš„ chunk è¿›è¡Œåˆå¹¶ï¼Œ å¹¶é“¾æ¥åˆ° unsorted bin ä¸­ã€‚</li>
<li>å¦‚æœç”¨æˆ·ç”³è¯·çš„å¤§å°ç¬¦åˆ <code>large bin</code> æˆ– <code>small bin</code> é“¾è¡¨ä¸ºç©ºï¼Œå®Œæˆäº†ä¸Šä¸€æ­¥ä¹‹åï¼Œå°±ä¼šå¼€å§‹éå†å¤„ç† <code>unsorted bin</code> é“¾è¡¨ä¸­çš„ chunk ã€‚å¦‚æœ <code>unsorted bin</code> åª æœ‰ä¸€ä¸ª chunkï¼Œè¿™ä¸ª chunk åœ¨ä¸Šæ¬¡åˆ†é…æ—¶è¢«ä½¿ç”¨è¿‡ï¼Œä¸”æ‰€éœ€åˆ†é…çš„ chunk å¤§ å°å±äº <code>small bin</code>ï¼ŒåŒæ—¶è¿™ä¸ª chunk çš„ <code>size</code> å¤§äºç­‰äºéœ€è¦åˆ†é…çš„å¤§å°ã€‚è¿™ç§æƒ…å†µä¸‹å°±ç›´æ¥å°†è¯¥ chunk è¿›è¡Œåˆ‡å‰²ï¼›å¦åˆ™å°†æ ¹æ® chunk çš„ç©ºé—´å¤§å°å°†å…¶æ”¾å…¥ small  bins æˆ–æ˜¯ large bins ä¸­ï¼Œéå†å®Œæˆåï¼Œè½¬å…¥ä¸‹ä¸€æ­¥ã€‚</li>
<li>ä¸Šé¢çš„æ­¥éª¤æ‰§è¡Œç»“æŸè¿˜æ²¡æœ‰æ‰¾åˆ°å †å—ï¼Œå°±è¯´æ˜éœ€è¦åˆ†é…çš„æ˜¯ä¸€å—å¤§çš„å†…å­˜ï¼Œæˆ–è€… <code>small bin</code> å’Œ <code>unsorted bin</code> ä¸­éƒ½æ‰¾ä¸åˆ°åˆé€‚çš„ chunkï¼Œå¹¶ä¸” <code>fast bin</code> å’Œ <code>unsorted bin</code> ä¸­æ‰€æœ‰çš„ chunk éƒ½æ¸…é™¤å¹²å‡€äº†ã€‚ç¨‹åºå°±æ¥æ—¶ä» <code>large bins</code> ä¸­æŒ‰ç…§ â€œsmallest-firstï¼Œbest-fitâ€ çš„åŸåˆ™ï¼Œæ‰¾ä¸€ä¸ªåˆé€‚çš„ chunkï¼Œä»ä¸­åˆ’åˆ†ä¸€å—æ‰€éœ€å¤§å°çš„ chunkï¼Œå¹¶å°†å‰©ä¸‹çš„éƒ¨åˆ†é“¾æ¥å›åˆ° bins ä¸­ã€‚è‹¥æ“ä½œæˆåŠŸï¼Œåˆ™åˆ†é…ç»“æŸï¼Œå¦åˆ™è½¬åˆ°ä¸‹ä¸€æ­¥ã€‚</li>
<li>æ ¹æ® <code>binmap</code> æ‰¾åˆ°è¡¨ç¤ºæ›´å¤§ <code>size</code> çš„ <code>large bin</code> é“¾è¡¨ï¼Œè‹¥å…¶ä¸­å­˜åœ¨ç©ºé—²çš„ chunk ï¼Œåˆ™å°† chunk æ‹†åˆ†ä¹‹åè¿”å›ç¬¦åˆè¦æ±‚çš„éƒ¨åˆ†ï¼Œå¹¶æ›´æ–° <code>last_remainder</code>ã€‚å¦‚æœæ²¡æœ‰åˆé€‚çš„å †å—å°±è¿›å…¥ä¸‹ä¸€æ­¥å» <code>top chunk</code> ä¸­å¯»æ‰¾ã€‚</li>
<li>è‹¥<code>top_chunk</code>çš„å¤§å°å¤§äºç”¨æˆ·ç”³è¯·çš„ç©ºé—´çš„å¤§å°ï¼Œåˆ™å°†<code>top_chunk</code>æ‹†åˆ†ï¼Œè¿”å›ç¬¦åˆç”¨æˆ·è¦æ±‚çš„<code>chunk</code>ï¼Œå¹¶æ›´æ–°<code>last_remainder</code> ã€‚å¦åˆ™å°†å†ä¸€æ¬¡æ£€æŸ¥ <code>fast bin</code>ï¼Œå¦‚æœ <code>fast bin</code> ä¸ä¸ºç©ºï¼Œå°±è°ƒç”¨ <code>malloc_consolidate()</code> åˆå¹¶å †å—åå†æ¬¡ä»ç¬¬ 4 æ­¥å¼€å§‹é‡æ–°æŸ¥æ‰¾ã€‚</li>
<li>å¦‚æœå‰é¢çš„æ­¥éª¤ä¸­éƒ½æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ chunk ï¼Œæ‰ä¼šè°ƒç”¨ <code>sysmalloc()</code> é‡æ–°åˆ†é…ç©ºé—´å¹¶å¤„ç†åŸæœ¬çš„ <code>top chunk</code> ã€‚</li>
</ol>
<h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><h4 id="libc-free"><a href="#libc-free" class="headerlink" title="__libc_free"></a>__libc_free</h4><p><del>ä¸€å¼€å§‹è¿˜ä»¥ä¸º free æ²¡æœ‰ mallocè¿™ä¹ˆé•¿äº†å‘¢</del></p>
<p><code>free </code>å‡½æ•°ä¹Ÿæ˜¯ç”± <code>__libc_free</code> å‡½æ•°å®Œæˆ chunk çš„é‡Šæ”¾çš„æ“ä½œçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c">__libc_free (<span class="hljs-type">void</span> *mem)<br>&#123;<br>  mstate ar_ptr;<br>  mchunkptr p;                          <span class="hljs-comment">/* chunk corresponding to mem */</span><br>  <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦è®¾ç½®äº† free_hook</span><br>  <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span> *, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__free_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    &#123;<br>      <span class="hljs-comment">// å¦‚æœè®¾ç½®äº†å°±è°ƒç”¨ free_hook</span><br>      (*hook)(mem, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>  <span class="hljs-comment">//free(NULL) æ— ä»»ä½•æ„ä¹‰ï¼Œç›´æ¥è¿”å›</span><br>  <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span>)                              <span class="hljs-comment">/* free(0) has no effect */</span><br>    <span class="hljs-keyword">return</span>;<br>    <br>  <span class="hljs-comment">// å°†ç”¨æˆ·æä¾›çš„ mem æŒ‡é’ˆè½¬æ¢ä¸ºå †å—å¤´æŒ‡é’ˆ</span><br>  p = mem2chunk (mem);<br><br>  <span class="hljs-comment">// åˆ¤æ–­ chunk æ˜¯å¦ç”± mmap åˆ†é…</span><br>  <span class="hljs-keyword">if</span> (chunk_is_mmapped (p))                       <span class="hljs-comment">/* release mmapped memory. */</span><br>    &#123;<br>      <span class="hljs-comment">/* see if the dynamic brk/mmap threshold needs adjusting */</span><br>      <span class="hljs-comment">// å¦‚æœæ˜¯ mmap åˆ†é…çš„ï¼Œåˆ™é¦–å…ˆæ›´æ–° mmap åˆ†é…å’Œæ”¶ç¼©é˜ˆå€¼</span><br>      <span class="hljs-keyword">if</span> (!mp_.no_dyn_threshold<br>          &amp;&amp; p-&gt;size &gt; mp_.mmap_threshold<br>          &amp;&amp; p-&gt;size &lt;= DEFAULT_MMAP_THRESHOLD_MAX)<br>        &#123;<br>          mp_.mmap_threshold = chunksize (p);<br>          mp_.trim_threshold = <span class="hljs-number">2</span> * mp_.mmap_threshold;<br>          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="hljs-number">2</span>,<br>                      mp_.mmap_threshold, mp_.trim_threshold);<br>        &#125;<br>      <span class="hljs-comment">// é‡Šæ”¾ç©ºé—´</span><br>      munmap_chunk (p);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>  <span class="hljs-comment">// å¦‚æœä¸æ˜¯ mmap åˆ›å»ºï¼Œåˆ™è°ƒç”¨ _int_free å‡½æ•°</span><br>  ar_ptr = arena_for_chunk (p);<br>  _int_free (ar_ptr, p, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è·Ÿ <code>malloc</code> ä¸€æ ·ï¼Œå‡½æ•°ä¼šå…ˆè¯»å– <code>__free_hook</code> çœ‹çœ‹æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™ç›´æ¥ç”± <code>free_hook</code> æŒ‡å‘çš„å‡½æ•°ä»£ä¸ºæ‰§è¡Œ <code>free</code> ï¼Œè¿™é‡Œä¹Ÿæ˜¯æˆ‘ä»¬ç»å¸¸åŠ«æŒçš„é’©å­å‡½æ•°ã€‚</p>
<p> <code>free_hook</code> åŠ«æŒèµ·æ¥æ¯” <code>malloc_hook</code> å›°éš¾ï¼Œä½†æ˜¯ä¸€æ—¦åŠ«æŒæˆåŠŸä¹Ÿä¼šå¾ˆæ–¹ä¾¿ã€‚ <code>malloc_hook</code> å‡½æ•°æˆ‘ä»¬åªèƒ½å†™ <code>one_gadget</code> ï¼Œè€Œä¸€æ—¦æ¡ä»¶è‹›åˆ»é‚£ä¹ˆå°±è¿˜å¾—è°ƒæ ˆå•Šä¹‹ç±»çš„ä¸€äº›æ“ä½œã€‚å¦‚æœåŠ«æŒåˆ°äº† <code>free_hook</code> æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å†™ <code>system()</code> å‡½æ•°ï¼Œç„¶å <code>free</code> ä¸€ä¸ªå†…å®¹ä¸º <code>&#39;/bin/sh&#39;</code> çš„å †å—å°±èƒ½ <code>get shell</code>ã€‚</p>
<h4 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a>_int_free</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br>_int_free (mstate av, mchunkptr p, <span class="hljs-type">int</span> have_lock)<br>&#123;<br>  INTERNAL_SIZE_T size;        <span class="hljs-comment">/* its size */</span><br>  mfastbinptr *fb;             <span class="hljs-comment">/* associated fastbin */</span><br>  mchunkptr nextchunk;         <span class="hljs-comment">/* next contiguous chunk */</span><br>  INTERNAL_SIZE_T nextsize;    <span class="hljs-comment">/* its size */</span><br>  <span class="hljs-type">int</span> nextinuse;               <span class="hljs-comment">/* true if nextchunk is used */</span><br>  INTERNAL_SIZE_T prevsize;    <span class="hljs-comment">/* size of previous contiguous chunk */</span><br>  mchunkptr bck;               <span class="hljs-comment">/* misc temp for linking */</span><br>  mchunkptr fwd;               <span class="hljs-comment">/* misc temp for linking */</span><br><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errstr = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-type">int</span> locked = <span class="hljs-number">0</span>;<br><br>  size = chunksize (p);<br><br>  <span class="hljs-keyword">if</span> (__builtin_expect ((<span class="hljs-type">uintptr_t</span>) p &gt; (<span class="hljs-type">uintptr_t</span>) -size, <span class="hljs-number">0</span>)<br>      || __builtin_expect (misaligned_chunk (p), <span class="hljs-number">0</span>))<br>    &#123;<br>      errstr = <span class="hljs-string">&quot;free(): invalid pointer&quot;</span>;<br>    errout:<br>      <span class="hljs-keyword">if</span> (!have_lock &amp;&amp; locked)<br>        (<span class="hljs-type">void</span>) mutex_unlock (&amp;av-&gt;mutex);<br>      malloc_printerr (check_action, errstr, chunk2mem (p), av);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆæ˜¯å„ç§å„æ ·çš„å‚æ•°å®šä¹‰å’Œé”™è¯¯æ£€æŸ¥ã€‚æˆ‘æŠŠæ³¨é‡Šåˆ æ‰äº†ï¼Œæ³¨é‡Šçš„æ„æ€å¤§æ¦‚å°±æ˜¯è¦æ£€æŸ¥ç”¨æˆ·æ˜¯ä¸æ˜¯è®¾ç½®äº†æ¶æ„å‚æ•°ã€‚</p>
<ul>
<li><code>__builtin_expect ((uintptr_t) p &gt; (uintptr_t) -size, 0)</code>ï¼šæŒ‡é’ˆå’Œsizeè¿›è¡Œæ¯”è¾ƒï¼Œ<del>ä¸ç†è§£ä½†å°Šé‡</del>ã€‚ä¹Ÿå°±æ˜¯å¤§æ¦‚ <code>p&gt;0xfff....</code> ï¼Œä¸»è¦æ˜¯åº”è¯¥è¦æ£€æµ‹è¢« <code>free</code> çš„ <code>chunk</code> çš„ <code>size</code> ä¸è¦è¿‡å¤§ã€‚<code>size</code> å–è´Ÿä¹‹åä¼šå˜å¾—å¾ˆå¤§ï¼Œæ¯”å¦‚ <code>0xfff...</code> è¿™æ ·çš„å¤§æ•°å€¼é€šå¸¸æŒ‡é’ˆä¸ä¼šæŒ‡å‘è¿™æ ·çš„åœ°å€ï¼Œ<code>f</code> å¼€å¤´çš„ä¸€èˆ¬éƒ½æ˜¯å†…æ ¸åœ°å€ã€‚</li>
<li><code>__builtin_expect (misaligned_chunk (p), 0)</code>ï¼šè®¡ç®— chunk çš„æŒ‡é’ˆä¸ä¸Šæ©ç ï¼ˆ <code>0x10-1</code>ä¹Ÿå°±æ˜¯ <code>0xf</code> ï¼‰ï¼Œå–å‡ºåå››ä½è§‚å¯Ÿæ˜¯å¦ä¸º 0 ã€‚å¦‚æœä¸ä¸º 0 åˆ™è¯´æ˜æŒ‡é’ˆé”™è¯¯äº†ï¼Œå°±ä¼šæŠ¥é”™ã€‚è¿™é‡Œä¸»è¦æ˜¯æ£€æŸ¥å¯¹é½ï¼ŒæŒ‡é’ˆéœ€è¦æŒ‡åˆ° <code>0x10</code> çš„æ•´å€æ•°æ‰èƒ½è¢«æ­£å¸¸ <code>free</code> ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))<br>  &#123;<br>    errstr = <span class="hljs-string">&quot;free(): invalid size&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>  &#125;<br><br>check_inuse_chunk(av, p);<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥åˆæ˜¯åœ¨æ£€æŸ¥ï¼š</p>
<ul>
<li><code>size &lt; MINSIZE</code>ï¼šå¦‚æœ <code>size</code> è¿˜æ¯” <code>MINSIZE</code> è¦å°ï¼Œé‚£è‚¯å®š <code>size</code> é”™äº†ã€‚</li>
<li><code>!aligned_OK (size)</code>ï¼š<code>chunk size</code> ä¹Ÿè¦å¯¹é½ï¼Œä½†æ˜¯è¿™ä¸ª <code>check</code> ä¸€èˆ¬ä¸ä¼šè¢«è§¦å‘ï¼Œå› ä¸ºå†å–å‡º <code>chunk size</code> çš„æ—¶å€™å°±ä¼šæŠŠæœ€ä½ä½ä¸æ‰ã€‚</li>
</ul>
<p> ç„¶åå°±æ˜¯å’Œ <code>malloc</code> é‡Œç›¸åŒçš„ check æ¥æ£€æŸ¥ <code>inuse</code> ä½ã€‚</p>
<h5 id="fast-bin-1"><a href="#fast-bin-1" class="headerlink" title="fast bin"></a>fast bin</h5><p>æ¥ä¸‹æ¥å°±æ˜¯åˆ¤æ–­è¿™ä¸ªè¢« free çš„ chunk æ˜¯ä¸æ˜¯åœ¨ fastbin èŒƒå›´å†…äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//åˆ¤æ–­è¿™ä¸ª chunk çš„å¤§å°æ˜¯ä¸æ˜¯å±äº fastbin ï¼Œä¸”å…¶åä¸€ä¸ª chunk ä¸æ˜¯ topchunk</span><br><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(size) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(get_max_fast ())<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> TRIM_FASTBINS</span><br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">	If TRIM_FASTBINS set, don&#x27;t place chunks</span><br><span class="hljs-comment">	bordering top into fastbins</span><br><span class="hljs-comment">      */</span><br>      &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      ) &#123;<br><br>    <span class="hljs-comment">//åˆ¤æ–­ size æ˜¯å¦å°äº MINSIZE æˆ–è€…æ˜¯ size&gt;=system_mem</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect (chunk_at_offset (p, size)-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>	|| __builtin_expect (chunksize (chunk_at_offset (p, size))<br>			     &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>      &#123;<br>	<span class="hljs-keyword">if</span> (have_lock<br>	    || (&#123; assert (locked == <span class="hljs-number">0</span>);<br>		  mutex_lock(&amp;av-&gt;mutex);<br>		  locked = <span class="hljs-number">1</span>;<br>		  chunk_at_offset (p, size)-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ<br>		    || chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem;<br>	      &#125;))<br>	  &#123;<br>	    errstr = <span class="hljs-string">&quot;free(): invalid next size (fast)&quot;</span>;<br>	    <span class="hljs-keyword">goto</span> errout;<br>	  &#125;<br>	<span class="hljs-keyword">if</span> (! have_lock)<br>	  &#123;<br>	    (<span class="hljs-type">void</span>)mutex_unlock(&amp;av-&gt;mutex);<br>	    locked = <span class="hljs-number">0</span>;<br>	  &#125;<br>      &#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç æ£€æŸ¥ <code>size</code> å¤§å°ï¼Œå¦‚æœå¤§å°æœ‰é—®é¢˜å°±ç”¨åˆ†é…å™¨çš„ lock å†æ¬¡åšä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœåˆ¤æ–­æ¡ä»¶è¿˜æ˜¯æˆç«‹çš„è¯é‚£å°±è¯´æ˜ <code>size</code> çœŸçš„è¢«æ”¹æˆäº†éæ³•æ•°å€¼ï¼Œé‚£å°±æŠ¥é”™é€€å‡ºã€‚å¦‚æœè¿›æ¥äº†ä½†æ˜¯æ²¡æœ‰æ‰§è¡ŒæŠ¥é”™ï¼Œè¯´æ˜å¯èƒ½å¤šçº¿ç¨‹æœ‰ç‚¹é—®é¢˜ï¼Œå°±é‡Šæ”¾è¿™ä¸ª <code>arena</code> çš„é”ã€‚</p>
<p>æ£€æŸ¥å®Œæ¯•å°±å¼€å§‹é‡Šæ”¾è¿™ä¸ª chunkï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-comment">//æ¸…ç† fastbin ä¸­çš„æ•°æ®</span><br>   free_perturb (chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br>   <br><span class="hljs-comment">//åˆå§‹åŒ– fastbin</span><br>   set_fastchunks(av);<br><span class="hljs-comment">// è·å– size å¯¹åº”çš„ fastbin ä¸‹æ ‡</span><br>   <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx = fastbin_index(size);<br>   fb = &amp;fastbin (av, idx);<br>   <br>   <span class="hljs-comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span><br>   mchunkptr old = *fb, old2;<br>   <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> old_idx = ~<span class="hljs-number">0u</span>;<br>   <span class="hljs-keyword">do</span><br>     &#123;<br>   <br>   <span class="hljs-comment">// åˆ¤æ–­å½“å‰ fastbin å¤´ chunk ä¸è¦è¢«é‡Šæ”¾çš„ chunk æ˜¯å¦ç›¸åŒï¼ˆé˜²æ­¢ double freeï¼‰</span><br>   <span class="hljs-keyword">if</span> (__builtin_expect (old == p, <span class="hljs-number">0</span>))<br>     &#123;<br>       errstr = <span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>;<br>       <span class="hljs-keyword">goto</span> errout;<br>     &#125;<br>       <br>   <span class="hljs-comment">// å°†è¦è¢«é‡Šæ”¾çš„ chunk æ”¾å…¥ fastbin å¤´éƒ¨ï¼Œä¿®æ”¹å…¶ fd æŒ‡é’ˆæŒ‡å‘ old</span><br>   <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span>)<br>     old_idx = fastbin_index(chunksize(old));<br>   p-&gt;fd = old2 = old;<br>     &#125;<br>   <span class="hljs-keyword">while</span> ((old = catomic_compare_and_exchange_val_rel (fb, p, old2)) != old2);<br>   <br>   <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span> &amp;&amp; __builtin_expect (old_idx != idx, <span class="hljs-number">0</span>))<br>     &#123;<br>   errstr = <span class="hljs-string">&quot;invalid fastbin entry (free)&quot;</span>;<br>   <span class="hljs-keyword">goto</span> errout;<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure>

<p>å®ƒé¦–å…ˆè°ƒç”¨äº† ä¸€ä¸ª <code>free_perturb()</code> å‡½æ•°ï¼Œå‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">free_perturb</span> <span class="hljs-params">(<span class="hljs-type">char</span> *p, <span class="hljs-type">size_t</span> n)</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (perturb_byte))<br>    <span class="hljs-built_in">memset</span> (p, perturb_byte, n);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å…¶å®è·Ÿå‰é¢ <code>malloc</code> é‚£ä¸ªå‡½æ•°å·®ä¸å¤šï¼Œå°±æ˜¯çœ‹ä½ æœ‰æ²¡æœ‰è®¾ç½®é‚£ä¸ªå€¼ï¼Œå¦‚æœè®¾ç½®äº†å°±åœ¨ <code>free</code> ä¹‹å‰æŠŠå †å—è¿›è¡Œ <code>memset</code> æ¸…ç©ºï¼Œä½†æ˜¯ä¸ä¸€æ ·çš„æ˜¯ï¼Œ<code>perturb</code> ä¸­ <code>memset</code> ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦æ ¹æ®ä½ è®¾ç½®çš„å€¼å†å¼‚æˆ–ä¸€ä¸ª <code>0xff</code> çš„ã€‚</p>
<p>å…¶ä¸­æœ‰ä¸€ä¸ªæ£€æŸ¥æ—¶é’ˆå¯¹ double free çš„ï¼Œé‚£ä¹ˆå¦‚æœçœŸçš„ double free äº†æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬ <code>free(A)</code> ï¼Œç¬¬ä¸€æ¬¡ <code>free</code>  Aï¼Œå¯¹åº”çš„ bin ä¸ºç©ºï¼Œè¿™ä¸ª chunk é“¾å…¥å…¶ä¸­ï¼Œç°åœ¨ <code>fast bin</code> ä¸­å¤šäº†ä¸€ä¸ª A ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç¬¬äºŒæ¬¡ <code>free(A)</code> ï¼ŒA ä¼šå†æ¬¡è¢«åŠ å…¥ <code>fast bin</code> ä¸­ï¼Œç„¶åä¼šå¯¼è‡´äº§ç”Ÿä¸€ä¸ªè‡ªå·±æŒ‡å‘è‡ªå·±çš„æŒ‡é’ˆã€‚è¿™æ—¶ <code>fast bin</code>ä¸­çš„æƒ…å†µå°±æ˜¯ä¸¤ä¸ªAï¼Œ<code>A-&gt;A</code>ã€‚æ­¤æ—¶æˆ‘ä»¬å†ç”³è¯·ä¸€ä¸ªå’Œ A ä¸€æ ·å¤§çš„ <code>chunk</code> ï¼ŒA è¢«ç”³è¯·èµ°ï¼Œä½†æ˜¯<code>fast bin</code> é“¾ä¸­è¿˜å‰©ä¸‹ä¸€ä¸ª Aï¼Œä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬æ‰‹é‡Œæœ‰ä¸€ä¸ª A ï¼Œ<code>fast bin</code> ä¸­ä¹Ÿæœ‰ä¸€ä¸ª A ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ç¼–è¾‘ A çš„æŒ‡é’ˆåŸŸäº†ã€‚æ¯”å¦‚æˆ‘è®©å®ƒæŒ‡å‘äº† got è¡¨ä¸­çš„ <code>free()</code> å‡½æ•°ã€‚é‚£ä¹ˆæ­¤æ—¶ <code>fast bin</code> ä¸­çš„æƒ…å†µå°±æ˜¯ <code>A-&gt;free@got</code> ã€‚ç„¶åæˆ‘å†æ¬¡ç”³è¯·å’Œ A ä¸€æ ·å¤§å°çš„ <code>chunk</code> ï¼ŒA è¢«å–å‡ºæ¥ï¼Œ <code>fast bin</code> ä¸­å‰©ä¸‹<code>free@got</code> ã€‚é‚£ä¹ˆæˆ‘ç¬¬ä¸‰æ¬¡ç”³è¯·å°±å¾—åˆ°äº†åœ¨ <code>free@got</code> é‚£è¾¹çš„ <code>chunk</code> ï¼Œç„¶åå‡å¦‚æˆ‘å·å·ä¿®æ”¹ä¸€ä¸‹ <code>free@got</code> ä¸º <code>system()</code> ï¼Œé‚£å°±èƒ½ get shell äº†ã€‚åŒæ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>free@got</code> è¿™ä¸ªæŒ‡é’ˆæ˜¯èƒ½ä»»æ„ç¼–è¾‘çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘æƒ³ç”³è¯·åˆ°å“ªéƒ½ä¸æ˜¯é—®é¢˜ï¼Œè¿™æ ·å°±èƒ½ä»»æ„åœ°å€å†™äº†ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿæœ‰æ–¹æ³•æ¥ç»•è¿‡ double free æ£€æŸ¥ã€‚å› ä¸ºå¯¹äº double free çš„æ£€æŸ¥åªæœ‰è¿™é‡Œä¸€å¤„ï¼Œæˆ‘ä»¬å°±å¯ä»¥å…ˆ <code>free(A)</code> å† <code>free(B)</code>ï¼Œå† <code>free(A)</code> ï¼Œè¿™æ ·å°±é€ æˆ double free å•¦ï¼</p>
<p>å¦‚æœè¿‡äº†æ£€æµ‹ï¼Œå°±å°†è¿™ä¸ª chunk é“¾åœ¨ <code>fast bin</code> çš„é¡¶éƒ¨ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å•é“¾è¡¨çš„æ’å…¥ã€‚å› ä¸ºåè¿›å…ˆå‡ºï¼Œæ‰€ä»¥åªåœ¨ <code>fast bin</code> çš„ä¸€ç«¯æ’å…¥åˆ é™¤ã€‚</p>
<h5 id="unsortedbin"><a href="#unsortedbin" class="headerlink" title="unsortedbin"></a>unsortedbin</h5><p>å®ƒä¸€å…±å°±ä¸‰ä¸ªå¤§çš„ <code>if-else</code> åˆ†æ”¯æ¡ä»¶ï¼Œæ˜¯ä¸æ˜¯å±äº <code>large bin</code> ã€æ˜¯ä¸æ˜¯å±äº <code>mmap</code> åˆ†é…ï¼Œå’Œå…¶ä»–æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ <code>unsorted bin</code> ã€‚</p>
<p>å¦‚æœchunkæ˜¯ <code>mmap</code> åˆ†é…çš„è¯é‚£å°±è°ƒç”¨ <code>munmap_chunk()</code> å‡½æ•°å» <code>free</code> è¿™ä¸ª chunkã€‚è¿™éƒ¨åˆ†ä»£ç å°±åœ¨ <code>_int_free</code> å‡½æ•°çš„æœ€åï¼Œæˆ‘ä»¬ä¸å»è®¨è®ºè¿™éƒ¨åˆ†å…·ä½“çš„ä»£ç å®ç°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span> &#123;<br>    munmap_chunk (p);<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥åˆ†æ <code>unsorted bin</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!chunk_is_mmapped(p)) &#123;<br>   <span class="hljs-keyword">if</span> (! have_lock) &#123;<br>     <span class="hljs-comment">//ç”¨ä¸€ä¸ªåˆ†é…å™¨çš„æ—¶å€™å…ˆåŠ é”ï¼Œç”¨å®Œäº†é‡Šæ”¾</span><br>     (<span class="hljs-type">void</span>)mutex_lock(&amp;av-&gt;mutex);<br>     locked = <span class="hljs-number">1</span>;<br>   &#125;<br><br>   <span class="hljs-comment">// è·å– next_chunk</span><br>   nextchunk = chunk_at_offset(p, size);<br><br>   <span class="hljs-comment">/* Lightweight tests: check whether the block is already the</span><br><span class="hljs-comment">      top block.  */</span><br>   <span class="hljs-comment">// æ£€æŸ¥å½“å‰ chunk æ˜¯å¦æ˜¯ top chunk å¤´ï¼ˆé˜²æ­¢ double freeï¼‰</span><br>   <span class="hljs-keyword">if</span> (__glibc_unlikely (p == av-&gt;top))<br>     &#123;<br>errstr = <span class="hljs-string">&quot;double free or corruption (top)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>     &#125;<br>   <span class="hljs-comment">/* Or whether the next chunk is beyond the boundaries of the arena.  */</span><br>   <span class="hljs-comment">// åˆ¤æ–­ next chunk æ˜¯å¦è¶…è¿‡åˆ†é…åŒº</span><br>   <span class="hljs-keyword">if</span> (__builtin_expect (contiguous (av)<br>		  &amp;&amp; (<span class="hljs-type">char</span> *) nextchunk<br>		  &gt;= ((<span class="hljs-type">char</span> *) av-&gt;top + chunksize(av-&gt;top)), <span class="hljs-number">0</span>))<br>     &#123;<br>errstr = <span class="hljs-string">&quot;double free or corruption (out)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>     &#125;<br>   <span class="hljs-comment">/* Or whether the block is actually not marked used.  */</span><br>   <span class="hljs-comment">// æ£€æŸ¥ next chunk çš„ inuse ä½ï¼Œåˆ¤æ–­è¢«é‡Šæ”¾çš„ chunk æ˜¯å¦åœ¨ä½¿ç”¨ </span><br>   <span class="hljs-keyword">if</span> (__glibc_unlikely (!prev_inuse(nextchunk)))<br>     &#123;<br>errstr = <span class="hljs-string">&quot;double free or corruption (!prev)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>     &#125;<br><br>   <span class="hljs-comment">// åˆ¤æ–­ next chunk çš„ size æ˜¯å¦åˆæ³•</span><br>   nextsize = chunksize(nextchunk);<br>   <span class="hljs-keyword">if</span> (__builtin_expect (nextchunk-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>|| __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>     &#123;<br>errstr = <span class="hljs-string">&quot;free(): invalid next size (normal)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>     &#125;<br><br>   <span class="hljs-comment">// æ¸…é™¤è¦è¢«é‡Šæ”¾çš„ chunk çš„å†…å®¹</span><br>   free_perturb (chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br></code></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„éƒ¨åˆ†å°±æ˜¯å¯¹å †å—çš„å„ç§æ£€æŸ¥ï¼Œä¿è¯ free è¿™ä¸ªå †å—ä¸ä¼šå‘ç”Ÿé”™è¯¯ã€‚å…¶ä¸­ <code>nextchunk-&gt;size &lt;= 2 * SIZE_SZ</code>çš„æ£€æŸ¥ï¼Œä¹Ÿå°±æ˜¯å¦‚æœä¸‹ä¸€ä¸ª chunk çš„ <code>size</code> å°äº <code>MINSIZE</code> ä¹Ÿä¼šæŠ¥é”™ï¼Œ å› ä¸ºä¼šæ¶‰åŠåˆ° chunk çš„å‘å‰åˆå¹¶æˆ–è€…å‘ååˆå¹¶ï¼Œå› æ­¤éœ€è¦å¯¹å‰åå †å—éƒ½è¿›è¡Œæ£€æŸ¥ã€‚</p>
<p>ä¸‹é¢å°±æ˜¯å‘å‰å’Œå‘ååˆå¹¶å †å—å¤§å°çš„æ“ä½œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-comment">/* consolidate backward */</span><br>   <span class="hljs-comment">// å¦‚æœå‰ä¸€ä¸ª prev chunk ä¹Ÿå¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œåˆ™ç”¨ unlink åˆå¹¶ä¸¤ä¸ª chunk</span><br>   <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>     prevsize = p-&gt;prev_size;<br>     size += prevsize;<br>     p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>     unlink(av, p, bck, fwd);<br>   &#125;<br><br>   <span class="hljs-comment">// å¦‚æœ next chunk ä¸æ˜¯ top chunk</span><br>   <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br>     <span class="hljs-comment">/* get and clear inuse bit */</span><br>     nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br><br>     <span class="hljs-comment">/* consolidate forward */</span><br>     <span class="hljs-comment">// å¦‚æœ next chunk ä¹Ÿå¤„äºé‡Šæ”¾ä¸­ï¼Œåˆ™ç»§ç»­å‘ä¸‹åˆå¹¶ next chunk</span><br>     <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br>unlink(av, nextchunk, bck, fwd);<br>size += nextsize;<br>     &#125; <span class="hljs-keyword">else</span><br>   <span class="hljs-comment">// æ¸…é™¤ inuse ä½</span><br>clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br><br>     <span class="hljs-comment">// è·å–å½“å‰ unsortedbin çš„æœ«å°¾ chunk å’Œé“¾è¡¨å¤´ chunk</span><br>     bck = unsorted_chunks(av);<br>     fwd = bck-&gt;fd;<br>     <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>&#123;<br>  errstr = <span class="hljs-string">&quot;free(): corrupted unsorted chunks&quot;</span>;<br>  <span class="hljs-keyword">goto</span> errout;<br>&#125;<br>     <span class="hljs-comment">// å°†å½“å‰ chunk æ’å…¥ unsortedbin ä¸­</span><br>     p-&gt;fd = fwd;<br>     p-&gt;bk = bck;<br>     <span class="hljs-comment">// å¦‚æœ size ä¸å±äº small binï¼Œéœ€è¦è®¾ç½® large bin</span><br>     <span class="hljs-keyword">if</span> (!in_smallbin_range(size))<br>&#123;<br>  p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>  p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>&#125;<br>     <span class="hljs-comment">// æ›´æ–°é“¾è¡¨å¤´å°¾æŒ‡é’ˆ</span><br>     bck-&gt;fd = p;<br>     fwd-&gt;bk = p;<br><br>     <span class="hljs-comment">// è®¾ç½® chunk çš„å¤´éƒ¨å’Œå°¾éƒ¨ prev_size</span><br>     set_head(p, size | PREV_INUSE);<br>     set_foot(p, size);<br><br>     check_free_chunk(av, p);<br>   &#125;<br><br>   <span class="hljs-comment">// å¦‚æœå½“å‰ chunk ä¸´è¿‘ top chunkï¼Œåˆ™ç›´æ¥åˆå¹¶åˆ° top chunk</span><br>   <span class="hljs-keyword">else</span> &#123;<br>     size += nextsize;<br>     set_head(p, size | PREV_INUSE);<br>     av-&gt;top = p;<br>     check_chunk(av, p);<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>ä¸‹é¢å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„æƒ…å†µï¼Œå°±æ˜¯æˆ‘ä»¬å¦‚æœä¸€ä¸‹å­å›æ”¶ä¸€ä¸ª <code>0x10000B</code> è¿™ä¹ˆå¤§çš„ç©ºé—´ï¼Œä¼šå›æ”¶ç»™ç³»ç»Ÿï¼Œè¿™æ ·å¯ä»¥å‡å°‘èµ„æºå ç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-comment">// å¦‚æœå‰é¢é‡Šæ”¾çš„ chunk å¤§å°è¾ƒå¤§ï¼Œå°† fast bin åˆå¹¶åˆ° unsortedbin ä¸­</span><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;<br>      <span class="hljs-keyword">if</span> (have_fastchunks(av))<br>	malloc_consolidate(av);<br><br>      <span class="hljs-comment">// å¦‚æœè¿›ç¨‹çš„åˆ†é…åŒºæ˜¯ä¸»åˆ†é…åŒºï¼Œè°ƒç”¨ systrim æ”¶ç¼©å†…å­˜ï¼Œå¦åˆ™è·å–éä¸»åˆ†é…åŒºçš„ heap_infoï¼Œç”¨ heap_trim æ”¶ç¼© heap</span><br>      <span class="hljs-keyword">if</span> (av == &amp;main_arena) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MORECORE_CANNOT_TRIM</span><br>	<span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(chunksize(av-&gt;top)) &gt;=<br>	    (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(mp_.trim_threshold))<br>	  systrim(mp_.top_pad, av);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>	<span class="hljs-comment">/* Always try heap_trim(), even if the top chunk is not</span><br><span class="hljs-comment">	   large, because the corresponding heap might go away.  */</span><br>	heap_info *heap = heap_for_ptr(top(av));<br><br>	assert(heap-&gt;ar_ptr == av);<br>	heap_trim(heap, mp_.top_pad);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (! have_lock) &#123;<br>      assert (locked);<br>      (<span class="hljs-type">void</span>)mutex_unlock(&amp;av-&gt;mutex);<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>å…ˆè°ƒç”¨ <code>malloc_consolidate</code> åˆå¹¶æ‰€æœ‰ <code>fast bin</code> ã€‚å¦‚æœè¿›ç¨‹æ‰€åœ¨çš„åˆ†é…åŒºæ˜¯ä¸»åˆ†é…åŒºå¹¶ä¸”å¯ä»¥æ”¶ç¼©å†…å­˜çš„è¯ï¼Œå°±è°ƒç”¨ <code>systrim</code> æ”¶ç¼©å†…å­˜ï¼Œå¦åˆ™å°±è·å¾—éä¸»åˆ†é…åŒºçš„ <code>heap_info</code> æŒ‡é’ˆï¼Œè°ƒç”¨ <code>heap_trim</code> æ”¶ç¼© <code>heap</code> ã€‚</p>
<h5 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p><code>free</code>ä¸åƒ <code>malloc</code> é‚£ä¹ˆå¤æ‚ï¼Œå¤§è‡´ä¸Šå°±æ˜¯å±äº <code>fast bin</code> çš„ç›´æ¥åŠ å…¥å¯¹åº”é“¾è¡¨ï¼Œä¸å±äº <code>fast bin</code> çš„å‘å‰åˆå¹¶æˆ–è€…å‘ååˆå¹¶ç„¶ååŠ å…¥ <code>unsorted bin </code> ã€‚å¦‚æœä¸€æ¬¡<code>free</code>å¤ªå¤šçš„ç©ºé—´æœ‰å¯èƒ½ä¼šè¢«æ“ä½œç³»ç»Ÿå›æ”¶ã€‚</p>
<hr>
<p>è¿™é‡Œæœ‰å¯¹ ptmalloc2 çš„ç›¸å…³ä»£ç çš„åˆ†æï¼š<a target="_blank" rel="noopener" href="https://paper.seebug.org/papers/Archive/refs/heap/glibc%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86ptmalloc%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.pdf">Glibcå†…å­˜ç®¡ç† (seebug.org)</a></p>
<p>è¿™ä¸ªå‰åŠéƒ¨åˆ†çš„ç†è®ºè®²çš„æ¯”è¾ƒç»†ï¼Œæºç åˆ†æéƒ¨åˆ†å°±æ¯”è¾ƒç²—ç•¥äº†</p>
<p>ç¢ç¢å¿µï¼š</p>
<p>è®¡ç®—æœºå‘æ˜è€…å’Œè®¡ç®—æœºå„ç§è¯­è¨€å„ç§åº“çš„å‘æ˜è€…å¥½ç‰›ï¼Œä»–ä»¬çš„è„‘å­å’Œæˆ‘çš„å¥½åƒæ˜¯ä¸å¤ªä¸€æ ·çš„ğŸ¥¹</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/pwn/" class="category-chain-item">pwn</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Knowledge/">#Knowledge</a>
      
        <a href="/tags/libc/">#libc</a>
      
        <a href="/tags/heap/">#heap</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>mallocå’Œfreeæºç åˆ†æ</div>
      <div>https://shmodifier.github.io/2023/12/17/mallocå’Œfreeæºç åˆ†æ/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Modifier</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2023å¹´12æœˆ17æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
                <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - ç›¸åŒæ–¹å¼å…±äº«">
                    <i class="iconfont icon-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/12/08/CSAPP-%E7%AC%AC%E5%8D%81%E7%AB%A0-%E7%B3%BB%E7%BB%9F%E7%BA%A7IO/" title="CSAPP ç¬¬åç«  ç³»ç»Ÿçº§IO">
                        <span class="hidden-mobile">CSAPP ç¬¬åç«  ç³»ç»Ÿçº§IO</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    
    <div class="footer-content">
       <p> Copyright &copy; 2022&nbsp;-&nbsp;2023 <a href="/">Modifier</a> </p> <p>Powered by <a href="https://hexo.io" target="_blank">Hexo</a> | Theme - <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></p> <!--  <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> -->

    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  

<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
